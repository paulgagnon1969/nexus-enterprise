---
title: "Token Authentication SOP (Multi-Tenant)"
module: mobile-sync
revision: "2.0"
tags: [sop, mobile-sync, authentication, security, api, multi-tenant]
status: draft
created: 2026-02-12
updated: 2026-02-12
author: Warp
---

# Token Authentication (Multi-Tenant)

## Purpose
This SOP defines the authentication mechanism for mobile device sync operations using permanent **Person Token (PT) + Company Token (CT)** signatures. This enables:
- **Multi-tenant access**: Users can authenticate to multiple companies using the same Person Token
- **Offline-first sync**: Reliable sync without re-authentication when JWT tokens expire
- **Flexible revocation**: Granular control at user, company, or membership level

## Who Uses This
- **Mobile app users**: Field crews and project managers who may work across multiple companies
- **Multi-tenant users**: Users with memberships in multiple organizations
- **API developers**: Implementing sync endpoints with multi-tenant support
- **System administrators**: Managing device access and token revocation

## Workflow

### Authentication Flow

#### Step-by-Step Process
1. User logs into mobile app with email/password
2. API validates credentials and returns:
   - JWT access token (15-minute TTL)
   - Refresh token (30-day TTL, stored in Redis)
   - Sync credentials (permanent Person token + Company token)
3. Mobile app stores all tokens in secure storage
4. For API requests, app uses JWT by default
5. If JWT expires, app attempts refresh token
6. If refresh fails, app falls back to DeviceSync authentication
7. If DeviceSync fails, user must re-login manually

#### Flowchart

```mermaid
flowchart TD
    A[API Request] --> B{JWT Valid?}
    B -->|Yes| C[Execute Request]
    B -->|No| D{Refresh Token Valid?}
    D -->|Yes| E[Get New JWT]
    E --> C
    D -->|No| F{DeviceSync Tokens Present?}
    F -->|Yes| G[Authenticate with DeviceSync]
    G --> H{Valid?}
    H -->|Yes| C
    H -->|No| I[Force Re-Login]
    F -->|No| I
```

### Token Structure

#### Person Token (syncToken)
- Stored on: `User.syncToken` field in database
- Format: UUID v4 (e.g., `a1b2c3d4-e5f6-7890-abcd-ef1234567890`)
- Generated: On first mobile login if not exists
- Scope: Identifies the user globally across all companies
- Lifespan: Permanent until explicitly revoked

#### Company Token (workerInviteToken)
- Stored on: `Company.workerInviteToken` field in database
- Format: UUID v4
- Generated: When company is created
- Scope: Identifies the tenant/organization
- Lifespan: Permanent, can be regenerated by admin

#### Combined Signature
```
Authorization: DeviceSync <personToken>:<companyToken>
```

Example:
```
Authorization: DeviceSync a1b2c3d4-e5f6-7890-abcd-ef1234567890:x9y8z7w6-v5u4-3210-fedc-ba0987654321
```

### API Implementation

#### Request Header
```http
GET /api/v1/projects HTTP/1.1
Host: nexus-api.example.com
Authorization: DeviceSync a1b2c3d4-...:x9y8z7w6-...
```

#### Validation Steps (API Side)
1. Parse Authorization header, extract tokens
2. Look up User by `syncToken`
3. Look up Company by `workerInviteToken`
4. Verify User has active `CompanyMembership` for that Company
5. Load user's role and profile permissions
6. Return authenticated context or 401 Unauthorized

### Mobile App Implementation

#### Token Storage
```typescript
// Storage keys
SYNC_USER_TOKEN = "nexus.sync.userToken"
SYNC_COMPANY_TOKEN = "nexus.sync.companyToken"

// On login response
await SecureStore.setItemAsync(SYNC_USER_TOKEN, response.syncCredentials.userToken);
await SecureStore.setItemAsync(SYNC_COMPANY_TOKEN, response.syncCredentials.companyToken);
```

#### Auth Fallback Chain
```typescript
async function authenticatedFetch(url, options) {
  // Try 1: JWT
  let response = await fetchWithJwt(url, options);
  if (response.status !== 401) return response;

  // Try 2: Refresh JWT
  const refreshed = await refreshJwtToken();
  if (refreshed) {
    response = await fetchWithJwt(url, options);
    if (response.status !== 401) return response;
  }

  // Try 3: DeviceSync
  response = await fetchWithDeviceSync(url, options);
  if (response.status !== 401) return response;

  // All failed - force re-login
  throw new AuthenticationError("Please log in again");
}
```

## Key Features
- **Multi-Tenant Support**: Same Person Token works across all companies user belongs to
- **Never Expires**: Combined PT+CT signature has no TTL
- **Offline-Resilient**: Works even after extended offline periods (31+ days)
- **Per-Tenant Scoped**: Company Token ensures data isolation between tenants
- **Flexible Revocation**: Revoke at user level (all companies) or company level (all users)
- **Membership Validation**: Checks active membership at every request

## Security Considerations

### Token Protection
- Store tokens in secure/encrypted storage (Keychain/Keystore)
- Never log tokens or include in error reports
- Transmit only over HTTPS

### Revocation
- User can revoke by regenerating their `syncToken` (logs out all devices)
- Admin can revoke company-wide by regenerating `workerInviteToken`
- Both actions require re-authentication on all affected devices

### Rate Limiting
- DeviceSync auth attempts should be rate-limited
- After 5 failed attempts, block for 15 minutes
- Log all DeviceSync failures for security audit

### Audit Trail
All DeviceSync authentications should log:
- Timestamp
- User ID
- Company ID
- Device identifier (if available)
- IP address
- Success/failure status

## Related Modules
- [Mobile App Sync](../architecture/mobile-sync.md)
- [API Authentication](../api-contracts/authentication.md)
- [User Management](./user-management-sop.md)

## Multi-Tenant Scenarios

### User Works for Multiple Companies
**Example**: John is a foreman who works for both "ABC Construction" (General Contractor) and "XYZ Electric" (Subcontractor).

1. John logs into mobile app and selects ABC Construction
2. API returns:
   - JWT scoped to ABC Construction
   - PT: John's permanent user token
   - CT: ABC Construction's company token
3. John completes a week of work for ABC Construction
4. Next week, John logs out and logs into XYZ Electric
5. API returns:
   - JWT scoped to XYZ Electric
   - **Same PT** (John's user token)
   - **Different CT** (XYZ Electric's company token)
6. John can now sync work for XYZ Electric using PT + CT signature

### Extended Offline Period
**Example**: Crew goes to remote site with no internet for 35 days.

1. Day 1-15: JWT expires after 15 minutes, refresh token keeps working
2. Day 16-30: Refresh token valid, crew can still sync when briefly online
3. Day 31+: Refresh token expired (30-day TTL)
4. **DeviceSync Activates**: PT + CT used for authentication
5. Sync continues to work without forcing crew to re-login

## Revision History
| Rev | Date | Changes |
|-----|------|--------|
| 1.0 | 2026-02-12 | Initial release |
| 2.0 | 2026-02-12 | Updated with multi-tenant architecture and PT+CT terminology |
