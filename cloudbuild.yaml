steps:
  # 1) Build API Docker image from apps/api/Dockerfile
  - name: gcr.io/cloud-builders/docker
    id: build-api-image
    args: [
      "build",
      "-f",
      "apps/api/Dockerfile",
      "-t",
      "gcr.io/$PROJECT_ID/nexus-api:$BUILD_ID",
      ".",
    ]

  # 2) Push API image
  - name: gcr.io/cloud-builders/docker
    id: push-api-image
    args: [
      "push",
      "gcr.io/$PROJECT_ID/nexus-api:$BUILD_ID",
    ]

  # 3) Deploy the new image to Cloud Run (service env vars are managed separately)
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: deploy-cloud-run
    entrypoint: gcloud
    args: [
      "run",
      "deploy",
      "nexus-api",                # Cloud Run service name
      "--image",
      "gcr.io/$PROJECT_ID/nexus-api:$BUILD_ID",
      "--region",
      "us-central1",              # adjust if needed
      "--platform",
      "managed",
    ]

images:
  - "gcr.io/$PROJECT_ID/nexus-api:$BUILD_ID"
