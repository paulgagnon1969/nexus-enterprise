generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MessageHeaderRole {
  TO
  CC
  BCC
}

model Company {
  id                        String      @id @default(cuid())
  name                      String
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  reputationOverallAvg      Float       @default(2)
  reputationOverallCount    Int         @default(0)
  reputationOverallOverride Int?
  kind                      CompanyKind @default(ORGANIZATION)

  /// When set, this organization has been deactivated / removed from the
  /// marketplace and should no longer appear in tenant lists or allow login.
  deletedAt                 DateTime?

  /// Optional default time zone for this organization (IANA name). Used as a
  /// sensible default for offices, projects, and payroll reporting.
  defaultTimeZone String?

  /// Optional JSON configuration for organization-wide payroll defaults
  /// (e.g. federal EIN, default state unemployment account, overtime rules).
  defaultPayrollConfig Json?

  // Trial / subscription metadata (optional; used for self-serve demos and billing).
  isTrial     Boolean             @default(false)
  trialEndsAt DateTime?
  trialStatus CompanyTrialStatus?

  templateId         String?
  templateVersionId  String?
  template           OrganizationTemplate?        @relation("CompanyTemplate", fields: [templateId], references: [id])
  templateVersion    OrganizationTemplateVersion? @relation("CompanyTemplateVersion", fields: [templateVersionId], references: [id])
  invites            CompanyInvite[]
  memberships        CompanyMembership[]
  goldenPriceUpdates GoldenPriceUpdateLog[]
  importJobs         ImportJob[]
  moduleOverrides    OrganizationModuleOverride[]
  parcels            Parcel[]
  projects           Project[]
  buildings          ProjectBuilding[]
  projectMemberships ProjectMembership[]
  particles          ProjectParticle[]
  units              ProjectUnit[]
  roleProfiles       RoleProfile[]
  tags               Tag[]
  tagAssignments     TagAssignment[]
  tasks              Task[]
  userPortfolios     UserPortfolio[]
  offices            CompanyOffice[]
  assets             Asset[]
  assetUsages        AssetUsage[]
  assetTransactions  AssetTransaction[]
  taxJurisdictions   TaxJurisdiction[]
  payrollWeekRecords PayrollWeekRecord[]
  projectGroups      ProjectGroup[]
  notifications      Notification[]
  messageThreads     MessageThread[]
  recipientGroups    MessageRecipientGroup[]
  projectFileFolders ProjectFileFolder[]
  projectFiles       ProjectFile[]
  companyPriceLists  CompanyPriceList[]
  dailyTimecards     DailyTimecard[]
  timecardEditLogs   TimecardEditLog[]
}

model OrganizationTemplate {
  id               String                        @id @default(cuid())
  code             String                        @unique
  label            String
  description      String?
  active           Boolean                       @default(true)
  createdAt        DateTime                      @default(now())
  updatedAt        DateTime                      @updatedAt
  currentVersionId String?                       @unique
  companies        Company[]                     @relation("CompanyTemplate")
  currentVersion   OrganizationTemplateVersion?  @relation("TemplateCurrentVersion", fields: [currentVersionId], references: [id])
  versions         OrganizationTemplateVersion[]
}

model OrganizationTemplateVersion {
  id                        String                            @id @default(cuid())
  templateId                String
  versionNo                 Int
  dayKey                    String
  label                     String?
  notes                     String?
  contentHash               String?
  createdAt                 DateTime                          @default(now())
  createdByUserId           String?
  companiesUsingThisVersion Company[]                         @relation("CompanyTemplateVersion")
  currentForTemplate        OrganizationTemplate?             @relation("TemplateCurrentVersion")
  articles                  OrganizationTemplateArticle[]
  modules                   OrganizationTemplateModule[]
  roleProfiles              OrganizationTemplateRoleProfile[]
  template                  OrganizationTemplate              @relation(fields: [templateId], references: [id])

  @@unique([templateId, dayKey], name: "OrgTemplateVersion_template_day_key")
  @@unique([templateId, versionNo], name: "OrgTemplateVersion_template_version_no")
  @@index([templateId], map: "OrgTemplateVersion_template_idx")
}

model OrganizationTemplateModule {
  id                String                      @id @default(cuid())
  templateVersionId String
  moduleCode        String
  enabled           Boolean                     @default(true)
  configJson        Json?
  templateVersion   OrganizationTemplateVersion @relation(fields: [templateVersionId], references: [id])

  @@unique([templateVersionId, moduleCode], name: "OrgTemplateModule_version_module_key")
  @@index([templateVersionId], map: "OrgTemplateModule_version_idx")
}

model OrganizationTemplateArticle {
  id                String                      @id @default(cuid())
  templateVersionId String
  slug              String
  title             String
  body              String
  sortOrder         Int                         @default(0)
  active            Boolean                     @default(true)
  templateVersion   OrganizationTemplateVersion @relation(fields: [templateVersionId], references: [id])

  @@unique([templateVersionId, slug], name: "OrgTemplateArticle_version_slug_key")
  @@index([templateVersionId], map: "OrgTemplateArticle_version_idx")
}

model OrganizationTemplateRoleProfile {
  id                String                               @id @default(cuid())
  templateVersionId String
  code              String
  label             String
  description       String?
  sortOrder         Int                                  @default(0)
  active            Boolean                              @default(true)
  permissions       OrganizationTemplateRolePermission[]
  templateVersion   OrganizationTemplateVersion          @relation(fields: [templateVersionId], references: [id])

  @@unique([templateVersionId, code], name: "OrgTemplateRoleProfile_version_code_key")
  @@index([templateVersionId], map: "OrgTemplateRoleProfile_version_idx")
}

model OrganizationTemplateRolePermission {
  id                    String                          @id @default(cuid())
  templateRoleProfileId String
  resourceCode          String
  canView               Boolean                         @default(false)
  canAdd                Boolean                         @default(false)
  canEdit               Boolean                         @default(false)
  canDelete             Boolean                         @default(false)
  canViewAll            Boolean                         @default(false)
  canApprove            Boolean                         @default(false)
  canManageSettings     Boolean                         @default(false)
  templateRoleProfile   OrganizationTemplateRoleProfile @relation(fields: [templateRoleProfileId], references: [id])

  @@unique([templateRoleProfileId, resourceCode], name: "OrgTemplateRolePermission_profile_resource_key")
  @@index([templateRoleProfileId], map: "OrgTemplateRolePermission_profile_idx")
}

model OrganizationModuleOverride {
  id         String  @id @default(cuid())
  companyId  String
  moduleCode String
  enabled    Boolean
  configJson Json?
  company    Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, moduleCode], name: "OrgModuleOverride_company_module_key")
  @@index([companyId], map: "OrgModuleOverride_company_idx")
}

model User {
  id                        String                 @id @default(cuid())
  email                     String                 @unique
  passwordHash              String
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  globalRole                GlobalRole             @default(NONE)
  userType                  UserType               @default(INTERNAL)
  reputationOverallAvg      Float                  @default(2)
  reputationOverallCount    Int                    @default(0)
  reputationOverallOverride Int?
  firstName                 String?
  lastName                  String?

  /// Percent of this user's profile that is complete (0â€“100). Starts at 10%
  /// once we have at least name + email, then increases as additional fields
  /// (contact info, onboarding profile, skills, etc.) are filled in.
  profileCompletionPercent   Int       @default(10)
  profileCompletionUpdatedAt DateTime? @updatedAt

  /// Anchor timestamp for sending early profile-completion nudges. For the
  /// first 7 days after this is set, we may send one reminder per day while
  /// profileCompletionPercent < 100.
  profileReminderStartAt   DateTime?
  profileReminderLastSentAt DateTime?

  acceptedInvites           CompanyInvite[]
  memberships               CompanyMembership[]
  createdDailyLogs          DailyLog[]
  goldenPriceUpdates        GoldenPriceUpdateLog[]
  createdImportJobs         ImportJob[]            @relation("ImportJobCreatedBy")
  onboardingSessions        OnboardingSession[]
  projectMemberships        ProjectMembership[]
  assignedTasks             Task[]                 @relation("TaskAssignee")
  portfolios                UserPortfolio[]
  assetUsages               AssetUsage[]
  assetTransactions         AssetTransaction[]
  // Nex-Net referrals and candidate pool
  referralsSent             Referral[]             @relation("ReferralsSent")
  referralsReceived         Referral[]             @relation("ReferralsReceived")
  nexNetCandidate           NexNetCandidate?

  // System-wide per-user notifications
  notifications       Notification[]
  messageThreads      MessageThread[]
  messageParticipants MessageParticipant[]
  messages            Message[]

  // Messaging recipient groups owned by this user
  ownedRecipientGroups  MessageRecipientGroup[]    @relation("UserOwnedRecipientGroups")
  recipientGroupMembers MessageRecipientGroupMember[]

  // Daily timecards created by this user
  createdTimecards DailyTimecard[]
}

/// Notification delivered to a single user, optionally scoped to a company
/// and/or project. Used for alerts like "Your referral confirmed you" or
/// "New daily log submitted".
model Notification {
  id        String              @id @default(cuid())
  userId    String
  companyId String?
  projectId String?
  kind      NotificationKind    @default(GENERIC)
  channel   NotificationChannel @default(IN_APP)
  title     String
  body      String
  metadata  Json?
  isRead    Boolean             @default(false)
  readAt    DateTime?
  createdAt DateTime            @default(now())

  user    User     @relation(fields: [userId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@index([userId, isRead, createdAt], map: "Notification_user_read_created_idx")
  @@index([companyId, createdAt], map: "Notification_company_created_idx")
  @@index([projectId, createdAt], map: "Notification_project_created_idx")
}

/// Threaded, tenant-scoped direct messaging between internal users and
/// optional external email participants. Each thread belongs to a company
/// and has one or more participants and messages.
model MessageThread {
  id            String            @id @default(cuid())
  companyId     String
  projectId     String?
  subject       String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now()) @updatedAt
  createdById   String
  type          MessageThreadType @default(DIRECT)
  /// Optional subject user for per-person journals / communication history.
  subjectUserId String?

  company      Company              @relation(fields: [companyId], references: [id])
  project      Project?             @relation(fields: [projectId], references: [id])
  createdBy    User                 @relation(fields: [createdById], references: [id])
  participants MessageParticipant[]
  messages     Message[]

  @@index([companyId, updatedAt], map: "MessageThread_company_updated_idx")
  @@index([companyId, type, updatedAt], map: "MessageThread_company_type_updated_idx")
  @@index([projectId, type, updatedAt], map: "MessageThread_project_type_updated_idx")
  @@index([companyId, subjectUserId, type], map: "MessageThread_company_subject_user_type_idx")
}

/// Participant in a message thread. Either internal (userId) or purely
/// external (email only).
model MessageParticipant {
  id          String            @id @default(cuid())
  threadId    String
  userId      String?
  email       String?
  displayName String?
  isExternal  Boolean           @default(false)
  headerRole  MessageHeaderRole @default(TO)
  lastReadAt  DateTime?
  createdAt   DateTime          @default(now())

  thread   MessageThread @relation(fields: [threadId], references: [id])
  user     User?         @relation(fields: [userId], references: [id])
  messages Message[]

  @@index([threadId], map: "MessageParticipant_thread_idx")
  @@index([userId], map: "MessageParticipant_user_idx")
}

/// Individual message in a thread.
model Message {
  id          String   @id @default(cuid())
  threadId    String
  senderId    String?
  senderEmail String?
  body        String
  createdAt   DateTime @default(now())
  /// Optional visibility flag for JOURNAL messages. When true, the subject
  /// user can see this entry on their own journal board; otherwise it is
  /// internal-only for HR/admins.
  sharedWithSubject Boolean @default(false)

  thread       MessageThread        @relation(fields: [threadId], references: [id])
  sender       User?                @relation(fields: [senderId], references: [id])
  recipients   MessageParticipant[]
  attachments  MessageAttachment[]

  @@index([threadId, createdAt], map: "Message_thread_created_idx")
}

/// User-defined recipient group ("Favorites") scoped to a company and owner.
model MessageRecipientGroup {
  id        String   @id @default(cuid())
  companyId String
  ownerId   String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])
  owner   User    @relation("UserOwnedRecipientGroups", fields: [ownerId], references: [id])
  members MessageRecipientGroupMember[]

  @@index([companyId, ownerId], map: "MessageRecipientGroup_company_owner_idx")
}

/// Member of a user-defined recipient group. Can be an internal user or
/// an external contact identified by email/phone.
model MessageRecipientGroupMember {
  id       String  @id @default(cuid())
  groupId  String
  userId   String?
  email    String?
  phone    String?
  name     String?
  isExternal Boolean @default(false)

  group MessageRecipientGroup @relation(fields: [groupId], references: [id])
  user  User?                 @relation(fields: [userId], references: [id])

  @@index([groupId], map: "MessageRecipientGroupMember_group_idx")
  @@index([userId], map: "MessageRecipientGroupMember_user_idx")
}

/// Attachment linked to a message (file or URL).
model MessageAttachment {
  id           String         @id @default(cuid())
  messageId    String
  kind         AttachmentKind
  url          String
  filename     String?
  mimeType     String?
  sizeBytes    Int?
  assetId      String?
  projectFileId String?
  createdAt    DateTime       @default(now())

  message     Message      @relation(fields: [messageId], references: [id])
  projectFile ProjectFile? @relation(fields: [projectFileId], references: [id])

  @@index([messageId], map: "MessageAttachment_message_idx")
}

/// BIA / LCP-imported field workers. These are human workers who may
/// or may not have a corresponding User account in the system. Over time
/// they can be linked to Users, skills, and communications.
model Worker {
  id                 String       @id @default(cuid())
  firstName          String
  lastName           String
  fullName           String       @unique
  ssnHash            String?
  email              String?
  phone              String?
  addressLine1       String?
  addressLine2       String?
  city               String?
  state              String?
  postalCode         String?
  gender             String?
  ethnicity          String?
  primaryClassCode   String?
  defaultProjectCode String? // "CBS" | "CCT" | "BOTH"
  dateHired          DateTime?
  status             String? // e.g. ACTIVE / INACTIVE
  isForeman          Boolean      @default(false)
  defaultPayRate     Float? // hourly pay rate
  unionLocal         String?
  firstSeenWeekEnd   DateTime?
  lastSeenWeekEnd    DateTime?
  totalHoursCbs      Float?       @default(0)
  totalHoursCct      Float?       @default(0)
  notes              String?
  weeks              WorkerWeek[]
  timeEntries        DailyTimeEntry[]
}

/// Per-worker, per-week work summary derived from LCPUpload templates.
model WorkerWeek {
  id           String   @id @default(cuid())
  workerId     String
  weekEndDate  DateTime
  projectCode  String // "CBS" | "CCT"
  totalHours   Float
  totalHoursSt Float?
  totalHoursOt Float?
  sourceFile   String?

  worker Worker @relation(fields: [workerId], references: [id])

  @@unique([workerId, weekEndDate, projectCode])
  @@index([weekEndDate, projectCode], map: "WorkerWeek_week_scope_idx")
}

/// Daily timecard header for a single company/project/date.
model DailyTimecard {
  id             String   @id @default(cuid())
  companyId      String
  projectId      String
  date           DateTime
  createdByUserId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])
  project Project @relation(fields: [projectId], references: [id])
  createdBy User? @relation(fields: [createdByUserId], references: [id])
  entries  DailyTimeEntry[]
  edits    TimecardEditLog[]

  @@unique([companyId, projectId, date], name: "DailyTimecard_company_project_date_key")
  @@index([companyId, date], map: "DailyTimecard_company_date_idx")
}

/// Audit log for manual edits to daily time entries (e.g. worker reassignments)
model TimecardEditLog {
  id            String   @id @default(cuid())
  companyId     String
  projectId     String
  timecardId    String
  date          DateTime
  oldWorkerId   String
  newWorkerId   String
  locationCode  String?
  oldStHours    Float
  oldOtHours    Float
  oldDtHours    Float
  newStHours    Float
  newOtHours    Float
  newDtHours    Float
  editedByUserId String?
  createdAt     DateTime @default(now())

  company  Company       @relation(fields: [companyId], references: [id])
  project  Project       @relation(fields: [projectId], references: [id])
  timecard DailyTimecard @relation(fields: [timecardId], references: [id])

  @@index([companyId, projectId, date], map: "TimecardEditLog_company_project_date_idx")
}

/// Individual worker entry on a daily timecard.
model DailyTimeEntry {
  id          String   @id @default(cuid())
  timecardId  String
  workerId    String

  locationCode String?

  stHours     Float   @default(0)
  otHours     Float   @default(0)
  dtHours     Float   @default(0)

  timeIn      DateTime?
  timeOut     DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  timecard DailyTimecard @relation(fields: [timecardId], references: [id])
  worker   Worker        @relation(fields: [workerId], references: [id])

  @@index([timecardId, workerId], map: "DailyTimeEntry_timecard_worker_idx")
  @@index([workerId], map: "DailyTimeEntry_worker_idx")
}

/// Normalized per-worker, per-project, per-week payroll summary used as the
/// canonical source for Certified Payroll exports. For legacy BIA/LCP data,
/// this is populated from LCPUpload Template WWxx.csv files.
model PayrollWeekRecord {
  id          String  @id @default(cuid())
  companyId   String
  projectId   String?
  projectCode String?
  workerId    String?
  employeeId  String?

  firstName String?
  lastName  String?
  ssn       String?
  classCode String?

  /// Week code derived from the original LCP template filename, e.g. "WW51".
  weekCode    String?
  weekEndDate DateTime

  employmentType   String // "W2" | "CONTRACTOR_1099" (stringly typed for now)
  baseHourlyRate   Float?
  dayRate          Float?
  dayRateBaseHours Float?

  totalPay     Float
  totalHoursSt Float?
  totalHoursOt Float?
  totalHoursDt Float?

  /// JSON-encoded DailySodHours[7] array ({ st, ot, dt } per day).
  dailyHoursJson Json?

  company Company  @relation(fields: [companyId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@unique([companyId, projectCode, weekEndDate, employeeId], name: "PayrollWeek_company_proj_week_emp_key")
  @@index([companyId, weekEndDate], map: "PayrollWeekRecord_company_week_idx")
  @@index([companyId, projectCode, weekEndDate], map: "PayrollWeekRecord_company_projcode_week_idx")
}

model UserPortfolio {
  id        String           @id @default(cuid())
  companyId String
  userId    String
  headline  String?
  bio       String?
  photoUrl  String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  company   Company          @relation(fields: [companyId], references: [id])
  user      User             @relation(fields: [userId], references: [id])
  hr        UserPortfolioHr?

  @@unique([companyId, userId], name: "UserPortfolio_company_user_key")
  @@index([companyId], map: "UserPortfolio_company_idx")
  @@index([userId], map: "UserPortfolio_user_idx")
}

model UserPortfolioHr {
  id               String        @id @default(cuid())
  portfolioId      String        @unique
  encryptedJson    Bytes
  ssnLast4         String?
  itinLast4        String?
  bankAccountLast4 String?
  bankRoutingLast4 String?
  updatedAt        DateTime      @updatedAt
  portfolio        UserPortfolio @relation(fields: [portfolioId], references: [id])
}

model CompanyMembership {
  userId    String
  companyId String
  createdAt DateTime     @default(now())
  role      Role
  profileId String?
  company   Company      @relation(fields: [companyId], references: [id])
  profile   RoleProfile? @relation(fields: [profileId], references: [id])
  user      User         @relation(fields: [userId], references: [id])

  @@id([userId, companyId])
}

model CompanyInvite {
  id             String    @id @default(cuid())
  companyId      String
  email          String
  role           Role
  token          String    @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  acceptedUserId String?
  createdAt      DateTime  @default(now())
  acceptedUser   User?     @relation(fields: [acceptedUserId], references: [id])
  company        Company   @relation(fields: [companyId], references: [id])
}

model CompanyOffice {
  id           String    @id @default(cuid())
  companyId    String
  label        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String    @default("US")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  /// Optional JSON configuration for this office's payroll defaults, including
  /// state/local tax jurisdictions and account identifiers used by Certified
  /// Payroll. Structure is owned by the payroll module.
  payrollConfig Json?

  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId, deletedAt], map: "CompanyOffice_company_deleted_idx")
}

/// Feature / capability that can be secured via roles (e.g. project_management.daily_logs).
model PermissionResource {
  id              String           @id @default(cuid())
  code            String           @unique
  label           String
  section         String
  sortOrder       Int              @default(0)
  active          Boolean          @default(true)
  rolePermissions RolePermission[]
}

/// NCC standard or custom per-company permission profile.
model RoleProfile {
  id              String              @id @default(cuid())
  companyId       String?
  code            String
  label           String
  description     String?
  isStandard      Boolean             @default(false)
  active          Boolean             @default(true)
  sourceProfileId String?
  createdAt       DateTime            @default(now())
  createdBy       String?
  updatedAt       DateTime            @updatedAt
  members         CompanyMembership[]
  permissions     RolePermission[]
  company         Company?            @relation(fields: [companyId], references: [id])

  @@index([companyId], map: "RoleProfile_company_idx")
}

/// Mapping between a RoleProfile and a PermissionResource with specific actions.
model RolePermission {
  id                String             @id @default(cuid())
  profileId         String
  resourceId        String
  canView           Boolean            @default(false)
  canAdd            Boolean            @default(false)
  canEdit           Boolean            @default(false)
  canDelete         Boolean            @default(false)
  canViewAll        Boolean            @default(false)
  canApprove        Boolean            @default(false)
  canManageSettings Boolean            @default(false)
  profile           RoleProfile        @relation(fields: [profileId], references: [id])
  resource          PermissionResource @relation(fields: [resourceId], references: [id])

  @@index([profileId], map: "RolePermission_profile_idx")
  @@index([resourceId], map: "RolePermission_resource_idx")
}

model Project {
  id                  String    @id @default(cuid())
  companyId           String
  name                String
  status              String    @default("active")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  addressLine1        String
  addressLine2        String?
  city                String
  country             String?   @default("US")
  createdByUserId     String?
  geocodedAt          DateTime?
  latitude            Float?
  longitude           Float?
  postalCode          String?
  primaryContactEmail String?
  primaryContactName  String?
  primaryContactPhone String?
  state               String
  /// Optional external claim / file ID used to link imports
  externalId          String?   @unique

  /// Optional tax jurisdiction used for Certified Payroll and related
  /// payroll reporting. When null, we will fall back to company-level
  /// defaults and the global Tapout baseline tax profile.
  taxJurisdictionId String?
  groupId           String?

  allocationRules      ComponentAllocationRule[]
  componentSummaries   ComponentSummary[]
  dailyLogs            DailyLog[]
  estimateVersions     EstimateVersion[]
  goldenPriceUpdates   GoldenPriceUpdateLog[]
  importJobs           ImportJob[]
  parcels              Parcel[]
  petlEditSessions     PetlEditSession[]
  company              Company                   @relation(fields: [companyId], references: [id])
  buildings            ProjectBuilding[]
  memberships          ProjectMembership[]
  particles            ProjectParticle[]
  units                ProjectUnit[]
  sows                 Sow[]
  componentAllocations SowComponentAllocation[]
  sowLogicalItems      SowLogicalItem[]
  tasks                Task[]
  assetUsages          AssetUsage[]
  assetTransactions    AssetTransaction[]
  taxJurisdiction      TaxJurisdiction?          @relation(fields: [taxJurisdictionId], references: [id])
  payrollWeekRecords   PayrollWeekRecord[]
  group                ProjectGroup?             @relation(fields: [groupId], references: [id])
  notifications        Notification[]
  messageThreads       MessageThread[]
  projectFileFolders   ProjectFileFolder[]
  projectFiles         ProjectFile[]
  dailyTimecards       DailyTimecard[]
  timecardEditLogs     TimecardEditLog[]

  @@index([companyId, groupId], map: "Project_company_group_idx")
}

model ProjectGroup {
  id         String   @id @default(cuid())
  companyId  String
  label      String
  clientName String?
  gcName     String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id])
  projects Project[]

  @@index([companyId, label], map: "ProjectGroup_company_label_idx")
}

model TaxJurisdiction {
  id String @id @default(cuid())

  /// Tenant that owns this jurisdiction configuration.
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  /// Basic location key for payroll/tax purposes.
  country      String  @default("US")
  state        String
  county       String?
  city         String?
  postalCode   String?
  postalPrefix String?

  /// Effective tax burden as a fraction of gross wages.
  fedRate      Float
  ficaRate     Float
  medicareRate Float
  stateRate    Float
  localRate    Float

  /// Option B semantics: show taxes in dts_* and offset via in-lieu so
  /// net == 1099 total.
  representational Boolean @default(true)

  /// Where these rates came from.
  source TaxRateSource @default(TAPOUT_BASELINE)

  /// If true, PMs should see a red light + "Tax rate review" on the
  /// project dashboard.
  needsReview Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// All projects for this company that are using this jurisdiction.
  projects Project[]

  @@index([companyId, state, postalCode])
  @@index([companyId, state, postalPrefix])
  @@index([companyId, state, county])
}

model Parcel {
  id                String           @id @default(cuid())
  name              String
  parcelCode        String?
  status            ParcelStatus     @default(PLANNED)
  areaSqFt          Float?
  zoning            String?
  companyId         String
  projectId         String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  projectParticleId String?
  company           Company          @relation(fields: [companyId], references: [id])
  project           Project          @relation(fields: [projectId], references: [id])
  projectParticle   ProjectParticle? @relation(fields: [projectParticleId], references: [id])
}

model ProjectFileFolder {
  id        String   @id @default(cuid())
  companyId String
  projectId String
  parentId  String?
  name      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])
  project Project @relation(fields: [projectId], references: [id])
  parent  ProjectFileFolder? @relation("ProjectFileFolderParent", fields: [parentId], references: [id])
  children ProjectFileFolder[] @relation("ProjectFileFolderParent")
  files    ProjectFile[]

  @@index([companyId, projectId], map: "ProjectFileFolder_company_project_idx")
}

model ProjectFile {
  id         String   @id @default(cuid())
  companyId  String
  projectId  String
  folderId   String?

  storageUrl String
  fileName   String
  mimeType   String?
  sizeBytes  Int?

  createdAt   DateTime @default(now())
  createdById String?

  company Company @relation(fields: [companyId], references: [id])
  project Project @relation(fields: [projectId], references: [id])
  folder  ProjectFileFolder? @relation(fields: [folderId], references: [id])
  attachments MessageAttachment[]
  dailyLogAttachments DailyLogAttachment[]

  @@index([companyId, projectId], map: "ProjectFile_company_project_idx")
}

/// Global list of job / project statuses (e.g. Open, Closed, Warranty).
model JobStatus {
  id        String  @id @default(cuid())
  code      String  @unique
  label     String
  sortOrder Int     @default(0)
  active    Boolean @default(true)
}

model ProjectMembership {
  userId     String
  projectId  String
  companyId  String
  role       ProjectRole
  createdAt  DateTime                @default(now())
  scope      ProjectParticipantScope @default(OWNER_MEMBER)
  visibility ProjectVisibilityLevel  @default(FULL)
  company    Company                 @relation(fields: [companyId], references: [id])
  project    Project                 @relation(fields: [projectId], references: [id])
  user       User                    @relation(fields: [userId], references: [id])

  @@id([userId, projectId])
}

model ProjectBuilding {
  id        String            @id @default(cuid())
  companyId String
  projectId String
  code      String?
  name      String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  company   Company           @relation(fields: [companyId], references: [id])
  project   Project           @relation(fields: [projectId], references: [id])
  particles ProjectParticle[]
  units     ProjectUnit[]
}

model ProjectUnit {
  id           String            @id @default(cuid())
  companyId    String
  projectId    String
  buildingId   String?
  externalCode String?
  label        String
  floor        Int?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  particles    ProjectParticle[]
  building     ProjectBuilding?  @relation(fields: [buildingId], references: [id])
  company      Company           @relation(fields: [companyId], references: [id])
  project      Project           @relation(fields: [projectId], references: [id])

  @@unique([projectId, label], name: "ProjectUnit_projectId_label_key")
}

model ProjectParticle {
  id                       String              @id @default(cuid())
  companyId                String
  projectId                String
  buildingId               String?
  unitId                   String?
  type                     ProjectParticleType @default(ROOM)
  name                     String
  fullLabel                String
  externalGroupCode        String?
  externalGroupDescription String?
  parentParticleId         String?
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  parcels                  Parcel[]
  building                 ProjectBuilding?    @relation(fields: [buildingId], references: [id])
  company                  Company             @relation(fields: [companyId], references: [id])
  parentParticle           ProjectParticle?    @relation("ProjectParticleParent", fields: [parentParticleId], references: [id])
  childParticles           ProjectParticle[]   @relation("ProjectParticleParent")
  project                  Project             @relation(fields: [projectId], references: [id])
  unit                     ProjectUnit?        @relation(fields: [unitId], references: [id])
  sowItems                 SowItem[]
  sowLogicalItems          SowLogicalItem[]
  tasks                    Task[]
}

model AdminAuditLog {
  id              String     @id @default(cuid())
  actorId         String
  actorEmail      String
  actorGlobalRole GlobalRole
  action          String
  targetCompanyId String?
  targetUserId    String?
  metadata        Json?
  createdAt       DateTime   @default(now())
}

model ProjectFinancialSnapshot {
  id                   String   @id @default(cuid())
  projectId            String
  estimateVersionId    String
  totalRcvClaim        Float
  totalAcvClaim        Float
  workCompleteRcv      Float
  acvReturn            Float
  opRate               Float
  acvOP                Float
  totalDueWorkBillable Float
  depositRate          Float
  depositBaseline      Float
  billedToDate         Float
  duePayable           Float
  dueAmount            Float
  snapshotDate         DateTime
  computedAt           DateTime @default(now())

  @@index([projectId, estimateVersionId, snapshotDate], map: "ProjectFinancialSnapshot_project_estimate_date_idx")
}

/// Log of Golden price list updates driven by Xact RAW imports.
/// Each row records how many items were updated and the average
/// price deltas, along with the project, estimate, and user.
model GoldenPriceUpdateLog {
  id                String                  @id @default(cuid())
  companyId         String
  projectId         String?
  estimateVersionId String?
  userId            String?
  updatedCount      Int
  avgDelta          Float
  avgPercentDelta   Float
  source            GoldenPriceUpdateSource @default(XACT_ESTIMATE)
  createdAt         DateTime                @default(now()) @db.Timestamptz(6)
  company           Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  estimateVersion   EstimateVersion?        @relation(fields: [estimateVersionId], references: [id], onDelete: Cascade)
  project           Project?                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user              User?                   @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt], map: "GoldenPriceUpdateLog_company_created_idx")
  @@index([projectId, createdAt], map: "GoldenPriceUpdateLog_project_created_idx")
}

model Task {
  id                String           @id @default(cuid())
  title             String
  description       String?
  status            TaskStatus       @default(TODO)
  dueDate           DateTime?
  companyId         String
  projectId         String
  assigneeId        String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  priority          TaskPriority     @default(MEDIUM)
  projectParticleId String?
  assignee          User?            @relation("TaskAssignee", fields: [assigneeId], references: [id])
  company           Company          @relation(fields: [companyId], references: [id])
  project           Project          @relation(fields: [projectId], references: [id])
  projectParticle   ProjectParticle? @relation(fields: [projectParticleId], references: [id])
}

model EstimateVersion {
  id                   String                    @id @default(cuid())
  projectId            String
  sourceType           String
  fileName             String
  storedPath           String
  estimateKind         String
  sequenceNo           Int
  defaultPayerType     String
  description          String?
  status               String
  errorMessage         String?
  importedByUserId     String?
  importedAt           DateTime?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  allocationRules      ComponentAllocationRule[]
  componentSummaries   ComponentSummary[]
  project              Project                   @relation(fields: [projectId], references: [id])
  goldenPriceUpdates   GoldenPriceUpdateLog[]
  rawComponentRows     RawComponentRow[]
  rawRows              RawXactRow[]
  sows                 Sow[]
  componentAllocations SowComponentAllocation[]
  sowItems             SowItem[]

  @@index([projectId, sequenceNo], map: "EstimateVersion_project_sequence_idx")
}

model RawXactRow {
  id                 String          @id @default(cuid())
  estimateVersionId  String
  lineNo             Int
  groupCode          String?
  groupDescription   String?
  desc               String?
  age                Float?
  condition          String?
  qty                Float?
  itemAmount         Float?
  reportedCost       Float?
  unitCost           Float?
  unit               String?
  coverage           String?
  activity           String?
  workersWage        Float?
  laborBurden        Float?
  laborOverhead      Float?
  material           Float?
  equipment          Float?
  marketConditions   Float?
  laborMinimum       Float?
  salesTax           Float?
  rcv                Float?
  life               Int?
  depreciationType   String?
  depreciationAmount Float?
  recoverable        Boolean?
  acv                Float?
  tax                Float?
  replaceFlag        Boolean?
  cat                String?
  sel                String?
  owner              String?
  originalVendor     String?
  sourceName         String?
  sourceDate         DateTime?
  note1              String?
  adjSource          String?
  rawRowJson         Json?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  estimateVersion    EstimateVersion @relation(fields: [estimateVersionId], references: [id])
  sowItems           SowItem[]

  @@index([estimateVersionId, lineNo], map: "RawXactRow_estimate_line_idx")
}

model RawComponentRow {
  id                          String          @id @default(cuid())
  estimateVersionId           String
  code                        String?
  description                 String?
  taxStatus                   String?
  contractorSuppliedRaw       String?
  quantityRaw                 String?
  unitRaw                     String?
  unitPriceRaw                String?
  totalRaw                    String?
  requestThirdPartyPricingRaw String?
  rawRowJson                  Json?
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime        @updatedAt
  estimateVersion             EstimateVersion @relation(fields: [estimateVersionId], references: [id])

  @@index([estimateVersionId], map: "RawComponentRow_estimate_idx")
}

model ComponentSummary {
  id                       String                   @id @default(cuid())
  projectId                String
  estimateVersionId        String
  code                     String
  description              String?
  taxStatus                String?
  contractorSupplied       Boolean?
  quantity                 Float?
  unit                     String?
  unitPrice                Float?
  total                    Float?
  requestThirdPartyPricing Boolean?
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  estimateVersion          EstimateVersion          @relation(fields: [estimateVersionId], references: [id])
  project                  Project                  @relation(fields: [projectId], references: [id])
  allocations              SowComponentAllocation[]

  @@index([projectId, estimateVersionId, code], map: "ComponentSummary_project_estimate_code_idx")
}

model SowComponentAllocation {
  id                 String            @id @default(cuid())
  projectId          String
  estimateVersionId  String
  sowItemId          String
  componentSummaryId String?
  code               String
  quantity           Float?
  total              Float?
  allocationBasis    String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  componentSummary   ComponentSummary? @relation(fields: [componentSummaryId], references: [id])
  estimateVersion    EstimateVersion   @relation(fields: [estimateVersionId], references: [id])
  project            Project           @relation(fields: [projectId], references: [id])
  sowItem            SowItem           @relation(fields: [sowItemId], references: [id])

  @@index([projectId, estimateVersionId, code], map: "SowComponentAllocation_project_estimate_code_idx")
  @@index([sowItemId], map: "SowComponentAllocation_sowItem_idx")
}

model ComponentAllocationRule {
  id                 String           @id @default(cuid())
  projectId          String
  estimateVersionId  String?
  componentCode      String
  targetCategoryCode String?
  targetActivity     String?
  active             Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  estimateVersion    EstimateVersion? @relation(fields: [estimateVersionId], references: [id])
  project            Project          @relation(fields: [projectId], references: [id])

  @@index([projectId, componentCode], map: "ComponentAllocationRule_project_code_idx")
  @@index([estimateVersionId], map: "ComponentAllocationRule_estimate_idx")
}

model Sow {
  id                String          @id @default(cuid())
  projectId         String
  estimateVersionId String
  sourceType        String
  totalAmount       Float?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  estimateVersion   EstimateVersion @relation(fields: [estimateVersionId], references: [id])
  project           Project         @relation(fields: [projectId], references: [id])
  items             SowItem[]
}

model SowLogicalItem {
  id                String          @id @default(cuid())
  projectId         String
  projectParticleId String
  signatureHash     String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  items             SowItem[]
  project           Project         @relation(fields: [projectId], references: [id])
  projectParticle   ProjectParticle @relation(fields: [projectParticleId], references: [id])
}

model SowItem {
  id                   String                   @id @default(cuid())
  sowId                String
  estimateVersionId    String
  rawRowId             String
  logicalItemId        String
  projectParticleId    String
  lineNo               Int
  description          String
  qty                  Float?
  unit                 String?
  unitCost             Float?
  itemAmount           Float?
  rcvAmount            Float?
  acvAmount            Float?
  depreciationAmount   Float?
  salesTaxAmount       Float?
  categoryCode         String?
  selectionCode        String?
  activity             String?
  materialAmount       Float?
  equipmentAmount      Float?
  payerType            String
  performed            Boolean                  @default(false)
  eligibleForAcvRefund Boolean                  @default(false)
  acvRefundAmount      Float?
  percentComplete      Float                    @default(0)
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  isAcvOnly            Boolean                  @default(false)
  petlEditChanges      PetlEditChange[]
  componentAllocations SowComponentAllocation[]
  estimateVersion      EstimateVersion          @relation(fields: [estimateVersionId], references: [id])
  logicalItem          SowLogicalItem           @relation(fields: [logicalItemId], references: [id])
  projectParticle      ProjectParticle          @relation(fields: [projectParticleId], references: [id])
  rawRow               RawXactRow               @relation(fields: [rawRowId], references: [id])
  sow                  Sow                      @relation(fields: [sowId], references: [id])
  assetUsages          AssetUsage[]

  @@index([estimateVersionId, projectParticleId], map: "SowItem_estimate_particle_idx")
  @@index([projectParticleId], map: "SowItem_particle_idx")
  @@index([categoryCode, selectionCode], map: "SowItem_cat_sel_idx")
}

/// Generic nickname / alias model for projects and particles.
model NameAlias {
  id           String   @id @default(cuid())
  /// 'project' | 'particle' (extendable later)
  entityType   String
  /// ID of the underlying entity (Project.id, ProjectParticle.id, ...)
  entityId     String
  /// The original name we are aliasing from (for audit / display of Xactimate source names).
  originalName String
  /// The human-friendly nickname.
  nickname     String
  /// Exactly one current alias per (entityType, entityId) should be true.
  isCurrent    Boolean  @default(true)
  createdBy    String?
  createdAt    DateTime @default(now())
}

/// Global tag dictionary per company (project groups, room tags, etc.).
model Tag {
  id              String          @id @default(cuid())
  companyId       String
  code            String
  label           String
  color           String?
  sortOrder       Int             @default(0)
  active          Boolean         @default(true)
  createdByUserId String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  company         Company         @relation(fields: [companyId], references: [id])
  assignments     TagAssignment[]

  @@unique([companyId, code], name: "Tag_company_code_key")
}

/// Attach tags to arbitrary entities (projects, particles, tasks, parcels, ...).
model TagAssignment {
  id              String   @id @default(cuid())
  tagId           String
  companyId       String
  /// 'project' | 'particle' | 'task' | 'parcel' | ...
  entityType      String
  entityId        String
  createdByUserId String?
  createdAt       DateTime @default(now())
  company         Company  @relation(fields: [companyId], references: [id])
  tag             Tag      @relation(fields: [tagId], references: [id])

  @@index([companyId, entityType, entityId], map: "TagAssignment_entity_idx")
  @@index([companyId, tagId], map: "TagAssignment_tag_idx")
}

model PetlEditSession {
  id        String           @id @default(cuid())
  userId    String?
  projectId String
  source    String           @default("ncc-petl-ui")
  meta      Json?
  startedAt DateTime
  endedAt   DateTime
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  changes   PetlEditChange[]
  project   Project          @relation(fields: [projectId], references: [id])
}

model PetlEditChange {
  id          String          @id @default(cuid())
  sessionId   String
  sowItemId   String
  field       String
  oldValue    Float?
  newValue    Float?
  effectiveAt DateTime
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  session     PetlEditSession @relation(fields: [sessionId], references: [id])
  sowItem     SowItem         @relation(fields: [sowItemId], references: [id])
}

model DailyLog {
  id                   String               @id @default(cuid())
  projectId            String
  createdById          String
  logDate              DateTime
  title                String?
  tagsJson             String?
  weatherSummary       String?
  crewOnSite           String?
  workPerformed        String?
  issues               String?
  safetyIncidents      String?
  manpowerOnsite       String?
  personOnsite         String?
  confidentialNotes    String?
  shareInternal        Boolean              @default(true)
  shareSubs            Boolean              @default(false)
  shareClient          Boolean              @default(false)
  sharePrivate         Boolean              @default(false)
  notifyUserIdsJson    String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  effectiveShareClient Boolean              @default(false)
  status               DailyLogStatus       @default(SUBMITTED)
  createdBy            User                 @relation(fields: [createdById], references: [id])
  project              Project              @relation(fields: [projectId], references: [id])
  attachments          DailyLogAttachment[]
  assetUsages          AssetUsage[]

  @@index([projectId], map: "DailyLog_project_idx")
}

model DailyLogAttachment {
  id           String   @id @default(cuid())
  dailyLogId   String
  projectFileId String?
  fileUrl      String
  fileName     String?
  mimeType     String?
  sizeBytes    Int?
  createdAt    DateTime @default(now())

  dailyLog    DailyLog     @relation(fields: [dailyLogId], references: [id])
  projectFile ProjectFile? @relation(fields: [projectFileId], references: [id])

  @@index([dailyLogId], map: "DailyLogAttachment_log_idx")
}

model OnboardingSession {
  id                      String                  @id @default(cuid())
  companyId               String
  email                   String
  token                   String                  @unique
  status                  OnboardingStatus        @default(NOT_STARTED)
  /// Optional, admin-defined candidate status code for finer-grained pipeline
  /// semantics (e.g. WAITING_FOR_DOCS). Stored as a free-form string and
  /// optionally linked to CandidateStatusDefinition.
  detailStatusCode        String?
  checklistJson           String?
  assignedHiringManagerId String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  userId                  String?
  bankInfo                OnboardingBankInfo?
  documents               OnboardingDocument[]
  profile                 OnboardingProfile?
  user                    User?                   @relation(fields: [userId], references: [id])
  skillRatings            OnboardingSkillRating[]

  @@index([companyId, createdAt], map: "OnboardingSession_company_created_idx")
  @@index([userId], map: "OnboardingSession_user_idx")
  @@index([companyId, detailStatusCode], map: "OnboardingSession_company_detail_status_idx")
}

/// Admin-defined candidate status codes for Prospective Candidates / Nex-Net
/// pipeline management. These are optional and sit alongside the core
/// OnboardingStatus enum.
model CandidateStatusDefinition {
  id        String   @id @default(cuid())
  companyId String?  // null = global status, otherwise tenant-specific
  code      String
  label     String
  color     String?  // optional hex or token for UI chips
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)

  @@unique([companyId, code], name: "CandidateStatusDefinition_company_code_key")
}

model OnboardingProfile {
  id           String            @id @default(cuid())
  sessionId    String            @unique
  firstName    String?
  lastName     String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  dob          DateTime?
  session      OnboardingSession @relation(fields: [sessionId], references: [id])
}

model OnboardingDocument {
  id        String                 @id @default(cuid())
  sessionId String
  type      OnboardingDocumentType
  fileUrl   String
  fileName  String?
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime               @default(now())
  session   OnboardingSession      @relation(fields: [sessionId], references: [id])

  @@index([sessionId], map: "OnboardingDocument_session_idx")
}

model OnboardingBankInfo {
  id                  String            @id @default(cuid())
  sessionId           String            @unique
  accountHolderName   String?
  routingNumberMasked String?
  accountNumberMasked String?
  bankName            String?
  createdAt           DateTime          @default(now())
  session             OnboardingSession @relation(fields: [sessionId], references: [id])
}

model OnboardingSkillRating {
  id        String            @id @default(cuid())
  sessionId String
  skillId   String
  level     Int
  updatedAt DateTime          @updatedAt
  session   OnboardingSession @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, skillId], name: "OnboardingSkillRating_session_skill_key")
}

model SkillCategory {
  id        String  @id @default(cuid())
  code      String  @unique
  label     String
  sortOrder Int     @default(0)
  active    Boolean @default(true)
}

model SkillDefinition {
  id          String  @id @default(cuid())
  categoryId  String
  code        String  @unique
  label       String
  description String?
  sortOrder   Int     @default(0)
  active      Boolean @default(true)
  tradeLabel  String?
}

model UserSkillRating {
  id                  String   @id @default(cuid())
  userId              String
  skillId             String
  selfLevel           Int
  selfLevelLabel      String?
  yearsExperience     Int?
  notes               String?
  employerAvgLevel    Float?
  employerRatingCount Int?
  adminOverrideLevel  Int?
  updatedAt           DateTime @updatedAt
  clientAvgLevel      Float?
  clientRatingCount   Int?

  @@unique([userId, skillId], name: "UserSkillRating_user_skill_key")
}

model EmployerSkillRating {
  id            String   @id @default(cuid())
  userId        String
  skillId       String
  companyId     String
  ratedByUserId String?
  level         Int
  levelLabel    String?
  comment       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId, skillId], map: "EmployerSkillRating_user_skill_idx")
  @@index([companyId], map: "EmployerSkillRating_company_idx")
}

model ClientSkillRating {
  id              String   @id @default(cuid())
  userId          String
  skillId         String
  clientCompanyId String?
  ratedByUserId   String?
  level           Int
  levelLabel      String?
  comment         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, skillId], map: "ClientSkillRating_user_skill_idx")
  @@index([clientCompanyId], map: "ClientSkillRating_company_idx")
}

model UserSkillSuggestion {
  id            String   @id @default(cuid())
  userId        String
  label         String
  categoryLabel String?
  description   String?
  status        String   @default("PENDING")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId], map: "UserSkillSuggestion_user_idx")
  @@index([status])
}

model ReputationRating {
  id                String                     @id @default(cuid())
  subjectType       ReputationSubjectType
  subjectUserId     String?
  subjectCompanyId  String?
  raterUserId       String?
  raterCompanyId    String?
  sourceType        ReputationSourceType
  dimension         ReputationDimension        @default(OVERALL)
  score             Int
  comment           String?
  moderationStatus  ReputationModerationStatus @default(PENDING)
  moderatedByUserId String?
  moderatedAt       DateTime?
  moderatorNote     String?
  isActive          Boolean                    @default(true)
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt

  @@index([subjectUserId], map: "ReputationRating_subject_user_idx")
  @@index([subjectCompanyId], map: "ReputationRating_subject_company_idx")
}

model ImportJob {
  id                String          @id @default(cuid())
  companyId         String
  projectId         String?
  createdByUserId   String
  type              ImportJobType
  status            ImportJobStatus @default(QUEUED)
  progress          Int             @default(0)
  message           String?
  csvPath           String?
  /// Canonical URI for uploaded file when using object storage (e.g. GCS)
  fileUri           String?
  /// Optional chunking metadata for large, parallelized imports
  totalChunks       Int?
  completedChunks   Int?
  metaJson          Json?
  estimateVersionId String?
  resultJson        Json?
  errorJson         Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  startedAt         DateTime?
  finishedAt        DateTime?
  company           Company         @relation(fields: [companyId], references: [id])
  createdBy         User            @relation("ImportJobCreatedBy", fields: [createdByUserId], references: [id])
  project           Project?        @relation(fields: [projectId], references: [id], onDelete: Restrict)

  @@index([companyId, createdAt], map: "ImportJob_company_created_idx")
  @@index([projectId, createdAt], map: "ImportJob_project_created_idx")
  @@index([status, createdAt], map: "ImportJob_status_created_idx")
}

/// Global price list metadata (e.g. canonical Xactimate price list revisions).
model PriceList {
  id            String            @id @default(cuid())
  kind          PriceListKind     @default(GOLDEN)
  code          String?
  label         String
  revision      Int
  effectiveDate DateTime?
  currency      String?           @default("USD")
  isActive      Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  items         PriceListItem[]
  companyLists  CompanyPriceList[]

  @@index([kind, isActive, revision], map: "PriceList_kind_active_revision_idx")
}

/// Individual price list items (e.g. CAT/SEL codes and unit prices).
model PriceListItem {
  id                 String               @id @default(cuid())
  priceListId        String
  lineNo             Int?
  groupCode          String?
  groupDescription   String?
  description        String?
  cat                String?
  sel                String?
  unit               String?
  unitPrice          Float?
  coverage           String?
  activity           String?
  owner              String?
  sourceVendor       String?
  sourceDate         DateTime?
  rawJson            Json?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  lastKnownUnitPrice Float?
  canonicalKeyHash   String?
  divisionCode       String?
  components         PriceListComponent[]
  division           Division?            @relation(fields: [divisionCode], references: [code])
  priceList          PriceList            @relation(fields: [priceListId], references: [id])
  assets             Asset[]
  companyItems       CompanyPriceListItem[]

  @@unique([priceListId, canonicalKeyHash], map: "PriceListItem_priceList_canonical_hash_key")
  @@index([priceListId, cat, sel], map: "PriceListItem_priceList_cat_sel_idx")
  @@index([divisionCode], map: "PriceListItem_division_code_idx")
}

model PriceListComponent {
  id              String        @id @default(cuid())
  priceListItemId String
  componentCode   String
  description     String?
  quantity        Float?
  material        Float?
  labor           Float?
  equipment       Float?
  createdAt       DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @db.Timestamptz(6)
  priceListItem   PriceListItem @relation(fields: [priceListItemId], references: [id], onDelete: Cascade)

  @@unique([priceListItemId, componentCode], name: "PLComponent_item_code_key", map: "PLComponent_item_code_key")
  @@index([priceListItemId], map: "PriceListComponent_item_idx")
  @@index([componentCode], map: "PriceListComponent_code_idx")
}

/// Standard CSI-style construction divisions (01â€“16) used for
/// organizing revenue, cost, and work by building system.
model Division {
  id             String          @id @default(cuid())
  code           String          @unique
  name           String
  sortOrder      Int             @default(0)
  catMappings    CatDivision[]
  priceListItems PriceListItem[]
}

/// Global mapping from Xactimate Cat codes (e.g. DRY, PLM) to
/// construction divisions. One row per Cat code.
model CatDivision {
  id           String   @id @default(cuid())
  cat          String   @unique
  divisionCode String
  division     Division @relation(fields: [divisionCode], references: [code])

  @@index([divisionCode], map: "CatDivision_division_code_idx")
}

/// Per-company cost book seeded from the system-wide Golden Price List.
model CompanyPriceList {
  id              String                 @id @default(cuid())
  companyId       String
  basePriceListId String?
  label           String
  revision        Int                    @default(1)
  effectiveDate   DateTime?
  currency        String?                @default("USD")
  isActive        Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  company         Company                @relation(fields: [companyId], references: [id])
  basePriceList   PriceList?             @relation(fields: [basePriceListId], references: [id])
  items           CompanyPriceListItem[]

  @@index([companyId, isActive, revision])
}

/// Individual tenant-level price list items that start from Golden but can
/// diverge per organization over time.
model CompanyPriceListItem {
  id                 String            @id @default(cuid())
  companyPriceListId String
  priceListItemId    String?
  canonicalKeyHash   String?
  lineNo             Int?
  groupCode          String?
  groupDescription   String?
  description        String?
  cat                String?
  sel                String?
  unit               String?
  unitPrice          Float?
  coverage           String?
  activity           String?
  owner              String?
  sourceVendor       String?
  sourceDate         DateTime?
  rawJson            Json?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  lastKnownUnitPrice Float?

  companyPriceList   CompanyPriceList  @relation(fields: [companyPriceListId], references: [id])
  priceListItem      PriceListItem?    @relation(fields: [priceListItemId], references: [id])

  @@index([companyPriceListId, canonicalKeyHash])
  @@index([companyPriceListId, cat, sel])
}

enum GlobalRole {
  NONE
  SUPER_ADMIN
  SUPPORT
}

enum TaxRateSource {
  TAPOUT_BASELINE
  COMPANY_OVERRIDE
}

/// High-level category for notifications so the UI can group them.
enum NotificationKind {
  GENERIC
  REFERRAL
  ONBOARDING
  PROJECT
  SYSTEM
  DIRECT_MESSAGE
}

/// Delivery channel used for a notification. IN_APP is always recorded; EMAIL
/// indicates that an email was also sent.
enum NotificationChannel {
  IN_APP
  EMAIL
}

enum MessageThreadType {
  DIRECT
  BOARD
  CUSTOMER
  JOURNAL
}

enum CompanyKind {
  SYSTEM
  ORGANIZATION
}

enum CompanyTrialStatus {
  ACTIVE
  EXPIRED
  CONVERTED
}

enum UserType {
  INTERNAL
  CLIENT
  APPLICANT
}

enum ImportJobType {
  XACT_RAW
  XACT_COMPONENTS
  XACT_COMPONENTS_ALLOCATE
  PRICE_LIST
  PRICE_LIST_COMPONENTS
  BIA_LCP
  COMPANY_PRICE_LIST
}

enum ImportJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum PriceListKind {
  GOLDEN
  ACTIVE
}

enum GoldenPriceUpdateSource {
  XACT_ESTIMATE
  GOLDEN_PETL
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  CLIENT
}

enum ParcelStatus {
  PLANNED
  ACTIVE
  ON_HOLD
  COMPLETE
}

enum ProjectRole {
  OWNER
  MANAGER
  COLLABORATOR
  VIEWER
}

enum ProjectParticipantScope {
  OWNER_MEMBER
  COLLABORATOR_MEMBER
  EXTERNAL_CONTACT
}

enum ProjectVisibilityLevel {
  FULL
  LIMITED
  READ_ONLY
}

enum ProjectParticleType {
  ROOM
  ZONE
  EXTERIOR
}

enum AttachmentKind {
  INTERNAL_FILE
  UPLOADED_FILE
  EXTERNAL_LINK
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DailyLogStatus {
  SUBMITTED
  APPROVED
  REJECTED
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  TEST
}

enum OnboardingDocumentType {
  PHOTO
  GOV_ID
  OTHER
}

enum ReputationSubjectType {
  USER
  COMPANY
}

enum ReputationSourceType {
  EMPLOYER_ON_WORKER
  WORKER_ON_EMPLOYER
  CLIENT_ON_COMPANY
  COMPANY_ON_CLIENT
  MODERATOR_ADJUSTMENT
}

enum ReputationDimension {
  OVERALL
  SAFETY
  PAYMENT
  COMMUNICATION
  QUALITY
}

enum ReputationModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

/// v1 Asset-centric models (coexist alongside legacy v0 schema)
model Asset {
  id              String             @id @default(cuid())
  companyId       String
  name            String
  code            String?
  description     String?
  assetType       AssetType
  baseUnit        String?
  baseRate        Decimal?           @db.Decimal(12, 4)
  costBreakdown   Json?
  attributes      Json?
  isTrackable     Boolean            @default(false)
  isConsumable    Boolean            @default(false)
  priceListItemId String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  company         Company            @relation(fields: [companyId], references: [id])
  priceListItem   PriceListItem?     @relation(fields: [priceListItemId], references: [id])
  usages          AssetUsage[]
  transactions    AssetTransaction[]

  @@index([companyId, assetType], map: "Asset_company_type_idx")
}

model AssetUsage {
  id                    String             @id @default(cuid())
  assetId               String
  companyId             String
  projectId             String
  sowItemId             String?
  dailyLogId            String?
  billingMode           BillingMode
  status                UsageStatus        @default(PLANNED)
  quantity              Decimal?           @db.Decimal(12, 4)
  unit                  String?
  overrideRate          Decimal?           @db.Decimal(12, 4)
  snapshotRate          Decimal?           @db.Decimal(12, 4)
  snapshotCostBreakdown Json?
  actualCost            Decimal?           @db.Decimal(14, 2)
  startDate             DateTime?
  endDate               DateTime?
  notes                 String?
  createdByUserId       String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  asset                 Asset              @relation(fields: [assetId], references: [id])
  company               Company            @relation(fields: [companyId], references: [id])
  project               Project            @relation(fields: [projectId], references: [id])
  sowItem               SowItem?           @relation(fields: [sowItemId], references: [id])
  dailyLog              DailyLog?          @relation(fields: [dailyLogId], references: [id])
  createdBy             User?              @relation(fields: [createdByUserId], references: [id])
  transactions          AssetTransaction[]

  @@index([companyId, projectId], map: "AssetUsage_company_project_idx")
  @@index([assetId, status], map: "AssetUsage_asset_status_idx")
}

model AssetTransaction {
  id          String          @id @default(cuid())
  assetId     String
  companyId   String
  projectId   String?
  usageId     String?
  kind        TransactionKind
  quantity    Decimal?        @db.Decimal(12, 4)
  unit        String?
  unitCost    Decimal?        @db.Decimal(12, 4)
  totalCost   Decimal?        @db.Decimal(14, 2)
  notes       String?
  createdById String?
  createdAt   DateTime        @default(now())
  asset       Asset           @relation(fields: [assetId], references: [id])
  company     Company         @relation(fields: [companyId], references: [id])
  project     Project?        @relation(fields: [projectId], references: [id])
  usage       AssetUsage?     @relation(fields: [usageId], references: [id])
  createdBy   User?           @relation(fields: [createdById], references: [id])

  @@index([companyId, createdAt], map: "AssetTransaction_company_created_idx")
  @@index([assetId, createdAt], map: "AssetTransaction_asset_created_idx")
}

enum AssetType {
  LABOR
  MATERIAL
  EQUIPMENT
  TOOL
  RENTAL
  OTHER
}

enum BillingMode {
  TIME_AND_MATERIAL
  FIXED_FEE
  INCLUDED_IN_SCOPE
  NO_CHARGE
}

enum UsageStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELED
}

enum TransactionKind {
  PURCHASE
  CONSUME
  TRANSFER
  RETURN
  WASTE
  TIME_PUNCH
  MAINTENANCE
  ADJUSTMENT
}

/// Simple test model used to validate migration pipelines.
/// Safe to keep or drop; not referenced by application code.
model DevMigrationTest {
  id        String   @id @default(cuid())
  note      String?
  createdAt DateTime @default(now())
}

model NexNetCandidate {
  id                 String                   @id @default(cuid())
  userId             String?                  @unique
  companyId          String?                  // owning company/tenant for this candidate profile
  firstName          String?
  lastName           String?
  email              String?
  phone              String?
  source             NexNetSource             @default(REFERRAL)
  status             NexNetStatus             @default(NOT_STARTED)
  visibilityScope    CandidateVisibilityScope @default(TENANT_ONLY)
  isHiddenFromDefaultViews Boolean            @default(false)
  isDeletedSoft      Boolean                  @default(false)
  deletedAt          DateTime?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt

  user               User?                    @relation(fields: [userId], references: [id])
  // companyId is a soft foreign key to Company.id; relation omitted for now.
  referralsAsReferee Referral[]               @relation("RefereeCandidate")
}

model Referral {
  id                         String           @id @default(cuid())
  referrerUserId             String
  prospectName               String?
  prospectEmail              String?
  prospectPhone              String?
  token                      String           @unique
  candidateId                String?
  refereeUserId              String?
  referralConfirmedByReferee Boolean          @default(false)
  referralConfirmedAt        DateTime?
  referralRejectedByReferee  Boolean          @default(false)
  status                     ReferralStatus   @default(INVITED)
  referralStartDate          DateTime?
  referralEndDate            DateTime?
  incentiveRate              Float?
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  referrer                   User             @relation("ReferralsSent", fields: [referrerUserId], references: [id])
  referee                    User?            @relation("ReferralsReceived", fields: [refereeUserId], references: [id])
  candidate                  NexNetCandidate? @relation("RefereeCandidate", fields: [candidateId], references: [id])
}

enum NexNetSource {
  REFERRAL
  PUBLIC_APPLY
  MIGRATED
  IMPORTED
}

enum NexNetStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  HIRED
  REJECTED
  TEST
}

enum ReferralStatus {
  INVITED
  CONFIRMED
  REJECTED
  APPLIED
  HIRED
  EXPIRED
}

/// Visibility scope for candidates in the Nex-Net / Prospective Candidates pool.
enum CandidateVisibilityScope {
  TENANT_ONLY
  GLOBAL_POOL
  PRIVATE_TEST
}

/// Status of a candidate training assignment.
enum CandidateTrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

/// Outcome of an individual training attempt.
enum CandidateTrainingAttemptStatus {
  PASSED
  FAILED
  ABANDONED
}

/// Status of a candidate certification / license.
enum CandidateCertificationStatus {
  PENDING_VERIFICATION
  VALID
  EXPIRED
  REVOKED
}

/// Status of cross-tenant interest in a candidate.
enum CandidateInterestStatus {
  REQUESTED
  APPROVED
  DECLINED
  HIRED
}

/// Catalog of training modules that can be assigned to Nex-Net candidates.
model TrainingModule {
  id                 String   @id @default(cuid())
  companyId          String?  // owning company/tenant, null = global module
  code               String
  title              String
  description        String?
  type               String   // e.g. "ONLINE_COURSE", "DOCUMENT", "IN_PERSON"
  durationMinutes    Int?
  isActive           Boolean  @default(true)
  isRequiredDefault  Boolean  @default(false)
  externalLmsId      String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Note: companyId is a soft foreign key to Company.id; we intentionally
  // omit a Prisma @relation here to keep the schema simple while iterating.

  @@unique([companyId, code], name: "TrainingModule_company_code_key")
}

/// Catalog of certification / license types that candidates can hold.
model CertificationType {
  id                     String   @id @default(cuid())
  companyId              String?  // owning company/tenant, null = global (e.g. state RN license)
  code                   String
  name                   String
  description            String?
  issuingAuthority       String?
  defaultValidityMonths  Int?
  isActive               Boolean  @default(true)
  isRequiredDefault      Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  /// Optional HTML template used when rendering certificates of this type.
  /// Managed by Nexus System Admins via the certifications UI.
  certificateTemplateHtml String?

  // Note: companyId is a soft foreign key to Company.id; no Prisma @relation
  // is declared here to avoid additional back-relations while iterating.

  @@unique([companyId, code], name: "CertificationType_company_code_key")
}

/// Assignment of a training module to a specific Nex-Net candidate.
model CandidateTrainingAssignment {
  id                String                  @id @default(cuid())
  candidateId       String
  trainingModuleId  String
  assignedByUserId  String?
  assignedAt        DateTime                @default(now())

  status            CandidateTrainingStatus @default(NOT_STARTED)
  startedAt         DateTime?
  completedAt       DateTime?
  expiresAt         DateTime?
  score             Float?
  attempts          Int                     @default(0)
  isRequired        Boolean                 @default(true)
  notes             String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  // Scalar foreign keys only; relations are enforced at the application layer.

  @@index([candidateId], map: "CandidateTrainingAssignment_candidate_idx")
  @@index([trainingModuleId], map: "CandidateTrainingAssignment_training_idx")
}

/// Individual attempt record for a candidate's training assignment.
model CandidateTrainingAttempt {
  id            String                         @id @default(cuid())
  assignmentId  String
  startedAt     DateTime                       @default(now())
  finishedAt    DateTime?
  status        CandidateTrainingAttemptStatus
  score         Float?
  metadata      Json?
  createdAt     DateTime                       @default(now())

  // assignmentId is a soft foreign key to CandidateTrainingAssignment.id

  @@index([assignmentId], map: "CandidateTrainingAttempt_assignment_idx")
}

/// Instance of a certification / license held by a Nex-Net candidate.
model CandidateCertification {
  id                    String                      @id @default(cuid())
  candidateId           String
  certificationTypeId   String
  licenseNumber         String?
  issuedBy              String?
  issuedAt              DateTime?
  effectiveAt           DateTime?
  expiresAt             DateTime?
  status                CandidateCertificationStatus @default(PENDING_VERIFICATION)
  verifiedByUserId      String?
  verifiedAt            DateTime?
  verificationNotes     String?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt

  // candidateId and certificationTypeId are soft foreign keys.

  @@index([candidateId], map: "CandidateCertification_candidate_idx")
  @@index([certificationTypeId], map: "CandidateCertification_type_idx")
}

/// Supporting documents for a candidate certification (e.g. PDF license).
model CandidateCertificationDocument {
  id                      String                 @id @default(cuid())
  candidateCertificationId String
  storageUrl              String
  fileName                String
  mimeType                String
  sizeBytes               Int?
  uploadedByUserId        String?
  uploadedAt              DateTime               @default(now())
  description             String?

  // candidateCertificationId is a soft foreign key to CandidateCertification.id

  @@index([candidateCertificationId], map: "CandidateCertDocument_cert_idx")
}

/// Anonymized, marketplace-facing profile for a Nex-Net candidate.
model CandidateMarketProfile {
  candidateId          String           @id
  publicId             String           @unique
  headline             String?
  skillsSummary        String?
  credentialsSummary   String?
  locationRegion       String?
  ratingNumeric        Float?
  ratingLabel          String?
  rateMin              Float?
  rateMax              Float?
  updatedAt            DateTime         @default(now()) @updatedAt
}

/// Controls which companies/tenants can see a given candidate in the pool.
model CandidatePoolVisibility {
  id                 String              @id @default(cuid())
  candidateId        String
  visibleToCompanyId String?             // null = visible to all subscribers in marketplace
  isAllowed          Boolean             @default(true)
  createdAt          DateTime            @default(now())
  createdByUserId    String

  // Scalar foreign keys only; relations to NexNetCandidate, User, Company
  // are enforced at the application layer.

  @@index([candidateId], map: "CandidatePoolVisibility_candidate_idx")
  @@index([visibleToCompanyId], map: "CandidatePoolVisibility_visible_company_idx")
}

/// Interest expressed by another company/tenant in a candidate.
model CandidateInterest {
  id                 String                  @id @default(cuid())
  candidateId        String
  requestingCompanyId String
  status             CandidateInterestStatus @default(REQUESTED)
  notes              String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  handledByUserId    String?

  // Scalar foreign keys only; relations to NexNetCandidate, Company, User
  // are enforced at the application layer.

  @@index([candidateId], map: "CandidateInterest_candidate_idx")
  @@index([requestingCompanyId], map: "CandidateInterest_requesting_company_idx")
}
