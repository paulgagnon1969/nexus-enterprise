generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MessageHeaderRole {
  TO
  CC
  BCC
}

enum DocumentTemplateType {
  INVOICE
  QUOTE
  SOP
  GENERIC
}

model Company {
  id                        String      @id @default(cuid())
  name                      String
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt
  reputationOverallAvg      Float       @default(2)
  reputationOverallCount    Int         @default(0)
  reputationOverallOverride Int?
  kind                      CompanyKind @default(ORGANIZATION)

  /// Optional worker invite / referral token that this company can share with
  /// prospective crew members. When a worker signs up using this token, they
  /// are automatically attached to this tenant and posted into the Nex-Net
  /// candidate pool. Multiple companies will never share the same token.
  workerInviteToken String? @unique

  /// When set, this organization has been deactivated / removed from the
  /// marketplace and should no longer appear in tenant lists or allow login.
  deletedAt DateTime?

  /// Optional default time zone for this organization (IANA name). Used as a
  /// sensible default for offices, projects, and payroll reporting.
  defaultTimeZone String?

  /// Optional JSON configuration for organization-wide payroll defaults
  /// (e.g. federal EIN, default state unemployment account, overtime rules).
  defaultPayrollConfig Json?

  /// Default O&P rate for cost book extrapolation (bootstrap mode)
  /// Used when no PETL data is available yet. Defaults to 20% (0.20).
  defaultOPRate Float? @default(0.20)

  // Trial / subscription metadata (optional; used for self-serve demos and billing).
  isTrial     Boolean             @default(false)
  trialEndsAt DateTime?
  trialStatus CompanyTrialStatus?

  templateId            String?
  templateVersionId     String?
  template              OrganizationTemplate?        @relation("CompanyTemplate", fields: [templateId], references: [id])
  templateVersion       OrganizationTemplateVersion? @relation("CompanyTemplateVersion", fields: [templateVersionId], references: [id])
  invites               CompanyInvite[]
  memberships           CompanyMembership[]
  goldenPriceUpdates    GoldenPriceUpdateLog[]
  tenantPriceUpdates    TenantPriceUpdateLog[]
  importJobs            ImportJob[]
  moduleOverrides       OrganizationModuleOverride[]
  parcels               Parcel[]
  projects              Project[]
  buildings             ProjectBuilding[]
  projectMemberships    ProjectMembership[]
  particles             ProjectParticle[]
  units                 ProjectUnit[]
  roleProfiles          RoleProfile[]
  tags                  Tag[]
  tagAssignments        TagAssignment[]
  tasks                 Task[]
  userPortfolios        UserPortfolio[]
  offices               CompanyOffice[]
  assets                Asset[]
  assetUsages           AssetUsage[]
  assetTransactions     AssetTransaction[]
  taxJurisdictions      TaxJurisdiction[]
  payrollWeekRecords    PayrollWeekRecord[]
  projectGroups         ProjectGroup[]
  notifications         Notification[]
  referralRelationships ReferralRelationship[]
  messageThreads        MessageThread[]
  recipientGroups       MessageRecipientGroup[]
  projectFileFolders    ProjectFileFolder[]
  projectFiles          ProjectFile[]
  petlArchives          ProjectPetlArchive[]
  companyPriceLists     CompanyPriceList[]
  dailyTimecards        DailyTimecard[]
  timecardEditLogs      TimecardEditLog[]
  nttTickets            NttTicket[]

  // Org-level invitations (Nexus System  new tenant owners)
  orgInvites OrgInvite[]

  // Locations & inventory
  locations          Location[]
  materialLots       MaterialLot[]
  inventoryParticles InventoryParticle[]
  inventoryMovements InventoryMovement[]
  inventoryPositions InventoryPosition[]
  personLocations    PersonLocation[]

  // Maintenance & asset monitoring
  maintenanceTemplates      AssetMaintenanceTemplate[]
  maintenanceTodos          MaintenanceTodo[]
  maintenanceReviewSettings MaintenanceReviewSettings?
  assetMeterReadings        AssetMeterReading[]

  // Project billing (invoices + payments)
  projectInvoices            ProjectInvoice[]
  projectPayments            ProjectPayment[]
  projectPaymentApplications ProjectPaymentApplication[]
  invoiceCounter             CompanyInvoiceCounter?

  // Document templates (internal docs)
  documentTemplates DocumentTemplate[]

  // Project expenses (bills)
  projectBills ProjectBill[]

  // Invoice-to-invoice credit applications
  projectInvoiceApplications ProjectInvoiceApplication[]

  // PnP (Policy & Procedure) library documents
  tenantPnpDocuments TenantPnpDocument[]

  // Document Import System
  documentScanJobs DocumentScanJob[]
  stagedDocuments  StagedDocument[]

  // Local price extrapolation (tax config per project)
  projectTaxConfigs ProjectTaxConfig[]

  // Claim Journal (carrier negotiation tracking)
  carrierContacts CarrierContact[]
}

model OrganizationTemplate {
  id               String                        @id @default(cuid())
  code             String                        @unique
  label            String
  description      String?
  active           Boolean                       @default(true)
  createdAt        DateTime                      @default(now())
  updatedAt        DateTime                      @updatedAt
  currentVersionId String?                       @unique
  companies        Company[]                     @relation("CompanyTemplate")
  currentVersion   OrganizationTemplateVersion?  @relation("TemplateCurrentVersion", fields: [currentVersionId], references: [id])
  versions         OrganizationTemplateVersion[]
}

model OrganizationTemplateVersion {
  id                        String                            @id @default(cuid())
  templateId                String
  versionNo                 Int
  dayKey                    String
  label                     String?
  notes                     String?
  contentHash               String?
  createdAt                 DateTime                          @default(now())
  createdByUserId           String?
  companiesUsingThisVersion Company[]                         @relation("CompanyTemplateVersion")
  currentForTemplate        OrganizationTemplate?             @relation("TemplateCurrentVersion")
  articles                  OrganizationTemplateArticle[]
  modules                   OrganizationTemplateModule[]
  roleProfiles              OrganizationTemplateRoleProfile[]
  template                  OrganizationTemplate              @relation(fields: [templateId], references: [id])

  @@unique([templateId, dayKey], name: "OrgTemplateVersion_template_day_key")
  @@unique([templateId, versionNo], name: "OrgTemplateVersion_template_version_no")
  @@index([templateId], map: "OrgTemplateVersion_template_idx")
}

model OrganizationTemplateModule {
  id                String                      @id @default(cuid())
  templateVersionId String
  moduleCode        String
  enabled           Boolean                     @default(true)
  configJson        Json?
  templateVersion   OrganizationTemplateVersion @relation(fields: [templateVersionId], references: [id])

  @@unique([templateVersionId, moduleCode], name: "OrgTemplateModule_version_module_key")
  @@index([templateVersionId], map: "OrgTemplateModule_version_idx")
}

model OrganizationTemplateArticle {
  id                String                      @id @default(cuid())
  templateVersionId String
  slug              String
  title             String
  body              String
  sortOrder         Int                         @default(0)
  active            Boolean                     @default(true)
  templateVersion   OrganizationTemplateVersion @relation(fields: [templateVersionId], references: [id])

  @@unique([templateVersionId, slug], name: "OrgTemplateArticle_version_slug_key")
  @@index([templateVersionId], map: "OrgTemplateArticle_version_idx")
}

model OrganizationTemplateRoleProfile {
  id                String                               @id @default(cuid())
  templateVersionId String
  code              String
  label             String
  description       String?
  sortOrder         Int                                  @default(0)
  active            Boolean                              @default(true)
  permissions       OrganizationTemplateRolePermission[]
  templateVersion   OrganizationTemplateVersion          @relation(fields: [templateVersionId], references: [id])

  @@unique([templateVersionId, code], name: "OrgTemplateRoleProfile_version_code_key")
  @@index([templateVersionId], map: "OrgTemplateRoleProfile_version_idx")
}

model OrganizationTemplateRolePermission {
  id                    String                          @id @default(cuid())
  templateRoleProfileId String
  resourceCode          String
  canView               Boolean                         @default(false)
  canAdd                Boolean                         @default(false)
  canEdit               Boolean                         @default(false)
  canDelete             Boolean                         @default(false)
  canViewAll            Boolean                         @default(false)
  canApprove            Boolean                         @default(false)
  canManageSettings     Boolean                         @default(false)
  templateRoleProfile   OrganizationTemplateRoleProfile @relation(fields: [templateRoleProfileId], references: [id])

  @@unique([templateRoleProfileId, resourceCode], name: "OrgTemplateRolePermission_profile_resource_key")
  @@index([templateRoleProfileId], map: "OrgTemplateRolePermission_profile_idx")
}

model OrganizationModuleOverride {
  id         String  @id @default(cuid())
  companyId  String
  moduleCode String
  enabled    Boolean
  configJson Json?
  company    Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, moduleCode], name: "OrgModuleOverride_company_module_key")
  @@index([companyId], map: "OrgModuleOverride_company_idx")
}

model DocumentTemplate {
  id               String               @id @default(cuid())
  companyId        String
  type             DocumentTemplateType @default(GENERIC)
  code             String
  label            String
  description      String?
  active           Boolean              @default(true)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  currentVersionId String?              @unique

  company        Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  currentVersion DocumentTemplateVersion?  @relation("DocTemplateCurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)
  versions       DocumentTemplateVersion[]

  @@unique([companyId, code], map: "DocumentTemplate_company_code_key")
  @@index([companyId], map: "DocumentTemplate_company_idx")
  @@index([companyId, type], map: "DocumentTemplate_company_type_idx")
}

model DocumentTemplateVersion {
  id              String   @id @default(cuid())
  templateId      String
  versionNo       Int
  label           String?
  notes           String?
  html            String
  contentHash     String?
  createdAt       DateTime @default(now())
  createdByUserId String?

  template           DocumentTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  currentForTemplate DocumentTemplate? @relation("DocTemplateCurrentVersion")

  @@unique([templateId, versionNo], map: "DocTemplateVersion_template_version_no")
  @@index([templateId], map: "DocTemplateVersion_template_idx")
}

model User {
  id                        String     @id @default(cuid())
  email                     String     @unique
  passwordHash              String
  createdAt                 DateTime   @default(now())
  updatedAt                 DateTime   @updatedAt
  globalRole                GlobalRole @default(NONE)
  userType                  UserType   @default(INTERNAL)
  reputationOverallAvg      Float      @default(2)
  reputationOverallCount    Int        @default(0)
  reputationOverallOverride Int?
  firstName                 String?
  lastName                  String?

  /// Percent of this user's profile that is complete (07100). Starts at 10%
  /// once we have at least name + email, then increases as additional fields
  /// (contact info, onboarding profile, skills, etc.) are filled in.
  profileCompletionPercent   Int       @default(10)
  profileCompletionUpdatedAt DateTime? @updatedAt

  /// Anchor timestamp for sending early profile-completion nudges. For the
  /// first 7 days after this is set, we may send one reminder per day while
  /// profileCompletionPercent < 100.
  profileReminderStartAt    DateTime?
  profileReminderLastSentAt DateTime?

  acceptedInvites    CompanyInvite[]
  memberships        CompanyMembership[]
  createdDailyLogs   DailyLog[]
  goldenPriceUpdates GoldenPriceUpdateLog[]
  createdImportJobs  ImportJob[]            @relation("ImportJobCreatedBy")

  // Project billing created-by audit
  projectInvoicesCreated            ProjectInvoice[]            @relation("ProjectInvoiceCreatedBy")
  projectPaymentsCreated            ProjectPayment[]            @relation("ProjectPaymentCreatedBy")
  projectPaymentApplicationsCreated ProjectPaymentApplication[] @relation("ProjectPaymentApplicationCreatedBy")

  // Project bills (expenses) created-by audit
  projectBillsCreated ProjectBill[] @relation("ProjectBillCreatedBy")

  // Invoice-to-invoice application audit
  projectInvoiceApplicationsCreated ProjectInvoiceApplication[] @relation("ProjectInvoiceApplicationCreatedBy")
  onboardingSessions                OnboardingSession[]
  projectMemberships                ProjectMembership[]
  assignedTasks                     Task[]                      @relation("TaskAssignee")
  portfolios                        UserPortfolio[]
  assetUsages                       AssetUsage[]
  assetTransactions                 AssetTransaction[]
  // Nex-Net referrals and candidate pool
  referralsSent                     Referral[]                  @relation("ReferralsSent")
  referralsReceived                 Referral[]                  @relation("ReferralsReceived")
  nexNetCandidate                   NexNetCandidate?
  referralRelationshipsAsReferrer   ReferralRelationship[]      @relation("ReferralRelationshipReferrer")
  referralRelationshipsAsReferee    ReferralRelationship[]      @relation("ReferralRelationshipReferee")

  // Org-level invitations (Nexus System  new tenant owners)
  orgInvitesCreated  OrgInvite[] @relation("OrgInviteCreatedBy")
  orgInvitesAccepted OrgInvite[] @relation("OrgInviteAcceptedBy")

  // Physical/virtual locations this person is associated with
  personLocations PersonLocation[]

  // System-wide per-user notifications
  notifications       Notification[]
  messageThreads      MessageThread[]
  messageParticipants MessageParticipant[]
  messages            Message[]

  // Messaging recipient groups owned by this user
  ownedRecipientGroups  MessageRecipientGroup[]       @relation("UserOwnedRecipientGroups")
  recipientGroupMembers MessageRecipientGroupMember[]

  // Daily timecards created by this user
  createdTimecards DailyTimecard[]

  // NTT tickets initiated by this user
  nttTicketsInitiated NttTicket[]

  // Inventory movements initiated by this user
  inventoryMovements InventoryMovement[]

  // Tasks created by this user (Todos, NTT workflows, etc.)
  createdTasks Task[] @relation("TaskCreatedBy")

  // PETL reconciliation audit trail
  petlReconciliationCasesCreated    PetlReconciliationCase[]  @relation("PetlReconCaseCreatedBy")
  petlReconciliationEntriesCreated  PetlReconciliationEntry[] @relation("PetlReconEntryCreatedBy")
  petlReconciliationEntriesApproved PetlReconciliationEntry[] @relation("PetlReconEntryApprovedBy")
  petlReconciliationEventsCreated   PetlReconciliationEvent[] @relation("PetlReconEventCreatedBy")

  // PETL archives
  petlArchivesCreated  ProjectPetlArchive[] @relation("PetlArchiveCreatedBy")
  petlArchivesRestored ProjectPetlArchive[] @relation("PetlArchiveRestoredBy")

  // Pending PETL percent updates (field-proposed, PM-approved)
  petlPercentUpdateSessionsCreated  PetlPercentUpdateSession[] @relation("PetlPercentUpdateSessionCreatedBy")
  petlPercentUpdateSessionsReviewed PetlPercentUpdateSession[] @relation("PetlPercentUpdateSessionReviewedBy")

  // Project scheduling change logs where this user is the actor.
  projectScheduleChangeLogs ProjectScheduleChangeLog[] @relation("ProjectScheduleChangeLogActor")

  // Global, confidential personal contacts for this user (per-profile, not per-tenant)
  personalContacts PersonalContact[]

  // Document Import System
  documentScanJobsCreated  DocumentScanJob[]
  stagedDocumentsScanned   StagedDocument[]  @relation("StagedDocumentScannedBy")
  stagedDocumentsArchived  StagedDocument[]  @relation("StagedDocumentArchivedBy")
  stagedDocumentsImported  StagedDocument[]  @relation("StagedDocumentImportedBy")
  stagedDocumentsPublished StagedDocument[]  @relation("StagedDocumentPublishedBy")

  // Claim Journal (carrier negotiation tracking)
  claimJournalEntriesCreated      ClaimJournalEntry[]      @relation("ClaimJournalEntryCreatedBy")
  claimJournalAttachmentsUploaded ClaimJournalAttachment[] @relation("ClaimJournalAttachmentUploadedBy")
}

/// Notification delivered to a single user, optionally scoped to a company
/// and/or project. Used for alerts like "Your referral confirmed you" or
/// "New daily log submitted".
model Notification {
  id        String              @id @default(cuid())
  userId    String
  companyId String?
  projectId String?
  kind      NotificationKind    @default(GENERIC)
  channel   NotificationChannel @default(IN_APP)
  title     String
  body      String
  metadata  Json?
  isRead    Boolean             @default(false)
  readAt    DateTime?
  createdAt DateTime            @default(now())

  user    User     @relation(fields: [userId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@index([userId, isRead, createdAt], map: "Notification_user_read_created_idx")
  @@index([companyId, createdAt], map: "Notification_company_created_idx")
  @@index([projectId, createdAt], map: "Notification_project_created_idx")
}

/// Threaded, tenant-scoped direct messaging between internal users and
/// optional external email participants. Each thread belongs to a company
/// and has one or more participants and messages.
model MessageThread {
  id            String            @id @default(cuid())
  companyId     String
  projectId     String?
  subject       String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now()) @updatedAt
  createdById   String
  type          MessageThreadType @default(DIRECT)
  /// Optional subject user for per-person journals / communication history.
  subjectUserId String?

  company      Company              @relation(fields: [companyId], references: [id])
  project      Project?             @relation(fields: [projectId], references: [id])
  createdBy    User                 @relation(fields: [createdById], references: [id])
  participants MessageParticipant[]
  messages     Message[]
  nttTickets   NttTicket[]

  petlReconciliationCases PetlReconciliationCase[] @relation("PetlReconCaseNoteThread")

  @@index([companyId, updatedAt], map: "MessageThread_company_updated_idx")
  @@index([companyId, type, updatedAt], map: "MessageThread_company_type_updated_idx")
  @@index([projectId, type, updatedAt], map: "MessageThread_project_type_updated_idx")
  @@index([companyId, subjectUserId, type], map: "MessageThread_company_subject_user_type_idx")
}

model NttTicket {
  id              String @id @default(cuid())
  companyId       String
  initiatorUserId String

  subjectType NttSubjectType
  summary     String
  description String

  status   NttStatus     @default(NEW)
  severity TaskPriority?

  pagePath    String?
  pageLabel   String?
  contextJson Json?

  noteThreadId String?
  primaryFaqId String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  company    Company        @relation(fields: [companyId], references: [id])
  initiator  User           @relation(fields: [initiatorUserId], references: [id])
  noteThread MessageThread? @relation(fields: [noteThreadId], references: [id])

  @@index([companyId, status, createdAt], map: "NttTicket_company_status_created_idx")
  @@index([initiatorUserId, createdAt], map: "NttTicket_initiator_created_idx")
}

/// Participant in a message thread. Either internal (userId) or purely
/// external (email only).
model MessageParticipant {
  id          String            @id @default(cuid())
  threadId    String
  userId      String?
  email       String?
  displayName String?
  isExternal  Boolean           @default(false)
  headerRole  MessageHeaderRole @default(TO)
  lastReadAt  DateTime?
  createdAt   DateTime          @default(now())

  thread   MessageThread @relation(fields: [threadId], references: [id])
  user     User?         @relation(fields: [userId], references: [id])
  messages Message[]

  @@index([threadId], map: "MessageParticipant_thread_idx")
  @@index([userId], map: "MessageParticipant_user_idx")
}

/// Individual message in a thread.
model Message {
  id                String   @id @default(cuid())
  threadId          String
  senderId          String?
  senderEmail       String?
  body              String
  createdAt         DateTime @default(now())
  /// Optional visibility flag for JOURNAL messages. When true, the subject
  /// user can see this entry on their own journal board; otherwise it is
  /// internal-only for HR/admins.
  sharedWithSubject Boolean  @default(false)

  thread      MessageThread        @relation(fields: [threadId], references: [id])
  sender      User?                @relation(fields: [senderId], references: [id])
  recipients  MessageParticipant[]
  attachments MessageAttachment[]

  @@index([threadId, createdAt], map: "Message_thread_created_idx")
}

/// User-defined recipient group ("Favorites") scoped to a company and owner.
model MessageRecipientGroup {
  id        String   @id @default(cuid())
  companyId String
  ownerId   String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company                       @relation(fields: [companyId], references: [id])
  owner   User                          @relation("UserOwnedRecipientGroups", fields: [ownerId], references: [id])
  members MessageRecipientGroupMember[]

  @@index([companyId, ownerId], map: "MessageRecipientGroup_company_owner_idx")
}

/// Member of a user-defined recipient group. Can be an internal user or
/// an external contact identified by email/phone.
model MessageRecipientGroupMember {
  id         String  @id @default(cuid())
  groupId    String
  userId     String?
  email      String?
  phone      String?
  name       String?
  isExternal Boolean @default(false)

  group MessageRecipientGroup @relation(fields: [groupId], references: [id])
  user  User?                 @relation(fields: [userId], references: [id])

  @@index([groupId], map: "MessageRecipientGroupMember_group_idx")
  @@index([userId], map: "MessageRecipientGroupMember_user_idx")
}

/// Attachment linked to a message (file or URL).
model MessageAttachment {
  id            String         @id @default(cuid())
  messageId     String
  kind          AttachmentKind
  url           String
  filename      String?
  mimeType      String?
  sizeBytes     Int?
  assetId       String?
  projectFileId String?
  createdAt     DateTime       @default(now())

  message     Message      @relation(fields: [messageId], references: [id])
  projectFile ProjectFile? @relation(fields: [projectFileId], references: [id])

  @@index([messageId], map: "MessageAttachment_message_idx")
}

/// BIA / LCP-imported field workers. These are human workers who may
/// or may not have a corresponding User account in the system. Over time
/// they can be linked to Users, skills, and communications.
model Worker {
  id                 String           @id @default(cuid())
  firstName          String
  lastName           String
  fullName           String           @unique
  ssnHash            String?
  email              String?
  phone              String?
  addressLine1       String?
  addressLine2       String?
  city               String?
  state              String?
  postalCode         String?
  gender             String?
  ethnicity          String?
  primaryClassCode   String?
  defaultProjectCode String? // "CBS" | "CCT" | "BOTH"
  dateHired          DateTime?
  status             String? // e.g. ACTIVE / INACTIVE
  isForeman          Boolean          @default(false)
  defaultPayRate     Float? // hourly pay rate
  defaultHoursPerDay Float?           @default(10) // hours per day used for day-rate conversions
  billRate           Float? // hourly bill rate
  cpRate             Float? // hourly CP rate
  cpRole             String? // CP role / designation (e.g. wage determination code)
  cpFringeRate       Float? // estimated fringe value for CP ($/hr)
  unionLocal         String?
  firstSeenWeekEnd   DateTime?
  lastSeenWeekEnd    DateTime?
  totalHoursCbs      Float?           @default(0)
  totalHoursCct      Float?           @default(0)
  notes              String?
  weeks              WorkerWeek[]
  timeEntries        DailyTimeEntry[]
}

/// Per-worker, per-week work summary derived from LCPUpload templates.
model WorkerWeek {
  id           String   @id @default(cuid())
  workerId     String
  weekEndDate  DateTime
  projectCode  String // "CBS" | "CCT"
  totalHours   Float
  totalHoursSt Float?
  totalHoursOt Float?
  sourceFile   String?

  worker Worker @relation(fields: [workerId], references: [id])

  @@unique([workerId, weekEndDate, projectCode])
  @@index([weekEndDate, projectCode], map: "WorkerWeek_week_scope_idx")
}

/// Daily timecard header for a single company/project/date.
model DailyTimecard {
  id              String   @id @default(cuid())
  companyId       String
  projectId       String
  date            DateTime
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company   Company           @relation(fields: [companyId], references: [id])
  project   Project           @relation(fields: [projectId], references: [id])
  createdBy User?             @relation(fields: [createdByUserId], references: [id])
  entries   DailyTimeEntry[]
  edits     TimecardEditLog[]

  @@unique([companyId, projectId, date], name: "DailyTimecard_company_project_date_key")
  @@index([companyId, date], map: "DailyTimecard_company_date_idx")
}

/// Audit log for manual edits to daily time entries (e.g. worker reassignments)
model TimecardEditLog {
  id             String   @id @default(cuid())
  companyId      String
  projectId      String
  timecardId     String
  date           DateTime
  oldWorkerId    String
  newWorkerId    String
  locationCode   String?
  oldStHours     Float
  oldOtHours     Float
  oldDtHours     Float
  newStHours     Float
  newOtHours     Float
  newDtHours     Float
  editedByUserId String?
  createdAt      DateTime @default(now())

  company  Company       @relation(fields: [companyId], references: [id])
  project  Project       @relation(fields: [projectId], references: [id])
  timecard DailyTimecard @relation(fields: [timecardId], references: [id])

  @@index([companyId, projectId, date], map: "TimecardEditLog_company_project_date_idx")
}

/// Individual worker entry on a daily timecard.
model DailyTimeEntry {
  id         String @id @default(cuid())
  timecardId String
  workerId   String

  locationCode String?

  stHours Float @default(0)
  otHours Float @default(0)
  dtHours Float @default(0)

  timeIn  DateTime?
  timeOut DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timecard DailyTimecard @relation(fields: [timecardId], references: [id])
  worker   Worker        @relation(fields: [workerId], references: [id])

  @@index([timecardId, workerId], map: "DailyTimeEntry_timecard_worker_idx")
  @@index([workerId], map: "DailyTimeEntry_worker_idx")
}

/// Normalized per-worker, per-project, per-week payroll summary used as the
/// canonical source for Certified Payroll exports. For legacy BIA/LCP data,
/// this is populated from LCPUpload Template WWxx.csv files.
model PayrollWeekRecord {
  id          String  @id @default(cuid())
  companyId   String
  projectId   String?
  projectCode String?
  workerId    String?
  employeeId  String?

  firstName String?
  lastName  String?
  ssn       String?
  classCode String?

  /// Week code derived from the original LCP template filename, e.g. "WW51".
  weekCode    String?
  weekEndDate DateTime

  employmentType   String // "W2" | "CONTRACTOR_1099" (stringly typed for now)
  baseHourlyRate   Float?
  dayRate          Float?
  dayRateBaseHours Float?

  totalPay     Float
  totalHoursSt Float?
  totalHoursOt Float?
  totalHoursDt Float?

  /// JSON-encoded DailySodHours[7] array ({ st, ot, dt } per day).
  dailyHoursJson Json?

  company Company  @relation(fields: [companyId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@unique([companyId, projectCode, weekEndDate, employeeId], name: "PayrollWeek_company_proj_week_emp_key")
  @@index([companyId, weekEndDate], map: "PayrollWeekRecord_company_week_idx")
  @@index([companyId, projectCode, weekEndDate], map: "PayrollWeekRecord_company_projcode_week_idx")
}

model UserPortfolio {
  id        String           @id @default(cuid())
  companyId String
  userId    String
  headline  String?
  bio       String?
  photoUrl  String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  company   Company          @relation(fields: [companyId], references: [id])
  user      User             @relation(fields: [userId], references: [id])
  hr        UserPortfolioHr?

  @@unique([companyId, userId], name: "UserPortfolio_company_user_key")
  @@index([companyId], map: "UserPortfolio_company_idx")
  @@index([userId], map: "UserPortfolio_user_idx")
}

model UserPortfolioHr {
  id               String        @id @default(cuid())
  portfolioId      String        @unique
  encryptedJson    Bytes
  ssnLast4         String?
  itinLast4        String?
  bankAccountLast4 String?
  bankRoutingLast4 String?
  updatedAt        DateTime      @updatedAt
  portfolio        UserPortfolio @relation(fields: [portfolioId], references: [id])
}

model CompanyMembership {
  userId    String
  companyId String
  createdAt DateTime     @default(now())
  role      Role
  /// When false, this membership has been deactivated for the tenant. The user
  /// may still exist in the Nexus System (e.g. as a candidate) but cannot
  /// access this specific company as a member.
  isActive  Boolean      @default(true)
  profileId String?
  company   Company      @relation(fields: [companyId], references: [id])
  profile   RoleProfile? @relation(fields: [profileId], references: [id])
  user      User         @relation(fields: [userId], references: [id])

  @@id([userId, companyId])
}

model CompanyInvite {
  id              String    @id @default(cuid())
  companyId       String
  email           String
  role            Role
  token           String    @unique
  expiresAt       DateTime
  acceptedAt      DateTime?
  acceptedUserId  String?
  createdAt       DateTime  @default(now())
  createdByUserId String?

  acceptedUser User?   @relation(fields: [acceptedUserId], references: [id])
  company      Company @relation(fields: [companyId], references: [id])
}

/// One-time organization invitation used by Nexus System / SUPER_ADMIN to
/// bootstrap new tenant organizations. When accepted, a new Company is created
/// and the accepting user becomes its OWNER.
model OrgInvite {
  id              String          @id @default(cuid())
  email           String
  token           String          @unique
  status          OrgInviteStatus @default(PENDING)
  createdAt       DateTime        @default(now())
  expiresAt       DateTime?
  acceptedAt      DateTime?
  createdByUserId String?
  acceptedUserId  String?
  companyId       String?

  createdBy    User?    @relation("OrgInviteCreatedBy", fields: [createdByUserId], references: [id])
  acceptedUser User?    @relation("OrgInviteAcceptedBy", fields: [acceptedUserId], references: [id])
  company      Company? @relation(fields: [companyId], references: [id])

  @@index([email, status], map: "OrgInvite_email_status_idx")
}

model CompanyOffice {
  id           String    @id @default(cuid())
  companyId    String
  label        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String    @default("US")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  /// Optional JSON configuration for this office's payroll defaults, including
  /// state/local tax jurisdictions and account identifiers used by Certified
  /// Payroll. Structure is owned by the payroll module.
  payrollConfig Json?

  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId, deletedAt], map: "CompanyOffice_company_deleted_idx")
}

/// Feature / capability that can be secured via roles (e.g. project_management.daily_logs).
enum OrgInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model PermissionResource {
  id              String           @id @default(cuid())
  code            String           @unique
  label           String
  section         String
  sortOrder       Int              @default(0)
  active          Boolean          @default(true)
  rolePermissions RolePermission[]
}

/// NCC standard or custom per-company permission profile.
model RoleProfile {
  id              String              @id @default(cuid())
  companyId       String?
  code            String
  label           String
  description     String?
  isStandard      Boolean             @default(false)
  active          Boolean             @default(true)
  sourceProfileId String?
  createdAt       DateTime            @default(now())
  createdBy       String?
  updatedAt       DateTime            @updatedAt
  members         CompanyMembership[]
  permissions     RolePermission[]
  company         Company?            @relation(fields: [companyId], references: [id])

  @@index([companyId], map: "RoleProfile_company_idx")
}

/// Mapping between a RoleProfile and a PermissionResource with specific actions.
model RolePermission {
  id                String             @id @default(cuid())
  profileId         String
  resourceId        String
  canView           Boolean            @default(false)
  canAdd            Boolean            @default(false)
  canEdit           Boolean            @default(false)
  canDelete         Boolean            @default(false)
  canViewAll        Boolean            @default(false)
  canApprove        Boolean            @default(false)
  canManageSettings Boolean            @default(false)
  profile           RoleProfile        @relation(fields: [profileId], references: [id])
  resource          PermissionResource @relation(fields: [resourceId], references: [id])

  @@index([profileId], map: "RolePermission_profile_idx")
  @@index([resourceId], map: "RolePermission_resource_idx")
}

model Project {
  id                  String    @id @default(cuid())
  companyId           String
  name                String
  status              String    @default("active")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  addressLine1        String
  addressLine2        String?
  city                String
  country             String?   @default("US")
  createdByUserId     String?
  geocodedAt          DateTime?
  latitude            Float?
  longitude           Float?
  postalCode          String?
  primaryContactEmail String?
  primaryContactName  String?
  primaryContactPhone String?
  state               String
  /// Optional external claim / file ID used to link imports
  externalId          String?   @unique

  /// Optional tax jurisdiction used for Certified Payroll and related
  /// payroll reporting. When null, we will fall back to company-level
  /// defaults and the global Tapout baseline tax profile.
  taxJurisdictionId String?
  groupId           String?

  allocationRules           ComponentAllocationRule[]
  componentSummaries        ComponentSummary[]
  dailyLogs                 DailyLog[]
  estimateVersions          EstimateVersion[]
  goldenPriceUpdates        GoldenPriceUpdateLog[]
  tenantPriceUpdates        TenantPriceUpdateLog[]
  importJobs                ImportJob[]
  parcels                   Parcel[]
  petlEditSessions          PetlEditSession[]
  petlReconciliationCases   PetlReconciliationCase[]
  petlReconciliationEntries PetlReconciliationEntry[]
  petlReconciliationEvents  PetlReconciliationEvent[]
  petlArchives              ProjectPetlArchive[]
  company                   Company                   @relation(fields: [companyId], references: [id])
  buildings                 ProjectBuilding[]
  memberships               ProjectMembership[]
  particles                 ProjectParticle[]
  units                     ProjectUnit[]
  sows                      Sow[]
  componentAllocations      SowComponentAllocation[]
  sowLogicalItems           SowLogicalItem[]
  tasks                     Task[]
  assetUsages               AssetUsage[]
  assetTransactions         AssetTransaction[]
  taxJurisdiction           TaxJurisdiction?          @relation(fields: [taxJurisdictionId], references: [id])
  payrollWeekRecords        PayrollWeekRecord[]
  group                     ProjectGroup?             @relation(fields: [groupId], references: [id])
  notifications             Notification[]
  messageThreads            MessageThread[]
  projectFileFolders        ProjectFileFolder[]
  projectFiles              ProjectFile[]
  dailyTimecards            DailyTimecard[]
  timecardEditLogs          TimecardEditLog[]

  // Project billing (invoices + payments)
  invoices            ProjectInvoice[]
  payments            ProjectPayment[]
  paymentApplications ProjectPaymentApplication[]
  invoiceApplications ProjectInvoiceApplication[]

  // Project expenses (bills)
  bills ProjectBill[]

  // Pending PETL percent updates
  petlPercentUpdateSessions PetlPercentUpdateSession[]

  // Project scheduling (canonical schedule + change history)
  scheduleTasks      ProjectScheduleTask[]
  scheduleChangeLogs ProjectScheduleChangeLog[]

  // Cost book items sourced from this project's PETL imports
  costBookItemsSourced CompanyPriceListItem[] @relation("CostBookSourceProject")

  // Local price extrapolation
  regionalFactors ProjectRegionalFactors?
  taxConfig       ProjectTaxConfig?

  // Claim Journal (carrier negotiation tracking)
  claimJournalEntries ClaimJournalEntry[]

  @@index([companyId, groupId], map: "Project_company_group_idx")
}

model ProjectGroup {
  id         String   @id @default(cuid())
  companyId  String
  label      String
  clientName String?
  gcName     String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id])
  projects Project[]

  @@index([companyId, label], map: "ProjectGroup_company_label_idx")
}

model TaxJurisdiction {
  id String @id @default(cuid())

  /// Tenant that owns this jurisdiction configuration.
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  /// Basic location key for payroll/tax purposes.
  country      String  @default("US")
  state        String
  county       String?
  city         String?
  postalCode   String?
  postalPrefix String?

  /// Effective tax burden as a fraction of gross wages.
  fedRate      Float
  ficaRate     Float
  medicareRate Float
  stateRate    Float
  localRate    Float

  /// Option B semantics: show taxes in dts_* and offset via in-lieu so
  /// net == 1099 total.
  representational Boolean @default(true)

  /// Where these rates came from.
  source TaxRateSource @default(TAPOUT_BASELINE)

  /// If true, PMs should see a red light + "Tax rate review" on the
  /// project dashboard.
  needsReview Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// All projects for this company that are using this jurisdiction.
  projects Project[]

  @@index([companyId, state, postalCode])
  @@index([companyId, state, postalPrefix])
  @@index([companyId, state, county])
}

model Parcel {
  id                String           @id @default(cuid())
  name              String
  parcelCode        String?
  status            ParcelStatus     @default(PLANNED)
  areaSqFt          Float?
  zoning            String?
  companyId         String
  projectId         String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  projectParticleId String?
  company           Company          @relation(fields: [companyId], references: [id])
  project           Project          @relation(fields: [projectId], references: [id])
  projectParticle   ProjectParticle? @relation(fields: [projectParticleId], references: [id])
}

model ProjectFileFolder {
  id        String  @id @default(cuid())
  companyId String
  projectId String
  parentId  String?
  name      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company             @relation(fields: [companyId], references: [id])
  project  Project             @relation(fields: [projectId], references: [id])
  parent   ProjectFileFolder?  @relation("ProjectFileFolderParent", fields: [parentId], references: [id])
  children ProjectFileFolder[] @relation("ProjectFileFolderParent")
  files    ProjectFile[]

  @@index([companyId, projectId], map: "ProjectFileFolder_company_project_idx")
}

model ProjectFile {
  id        String  @id @default(cuid())
  companyId String
  projectId String
  folderId  String?

  storageUrl String
  fileName   String
  mimeType   String?
  sizeBytes  Int?

  createdAt   DateTime @default(now())
  createdById String?

  company                       Company                        @relation(fields: [companyId], references: [id])
  project                       Project                        @relation(fields: [projectId], references: [id])
  folder                        ProjectFileFolder?             @relation(fields: [folderId], references: [id])
  attachments                   MessageAttachment[]
  dailyLogAttachments           DailyLogAttachment[]
  billAttachments               ProjectBillAttachment[]
  petlArchives                  ProjectPetlArchive[]
  petlReconciliationAttachments PetlReconciliationAttachment[]

  @@index([companyId, projectId], map: "ProjectFile_company_project_idx")
}

model ProjectPetlArchive {
  id                      String @id @default(cuid())
  companyId               String
  projectId               String
  projectFileId           String
  sourceEstimateVersionId String

  label String?
  note  String?

  restoredEstimateVersionId String?
  restoredByUserId          String?
  restoredAt                DateTime?

  createdByUserId String?
  createdAt       DateTime @default(now())

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectFile ProjectFile @relation(fields: [projectFileId], references: [id], onDelete: Cascade)

  sourceEstimateVersion   EstimateVersion  @relation("PetlArchiveSourceEstimateVersion", fields: [sourceEstimateVersionId], references: [id], onDelete: Restrict)
  restoredEstimateVersion EstimateVersion? @relation("PetlArchiveRestoredEstimateVersion", fields: [restoredEstimateVersionId], references: [id], onDelete: SetNull)

  createdBy  User? @relation("PetlArchiveCreatedBy", fields: [createdByUserId], references: [id])
  restoredBy User? @relation("PetlArchiveRestoredBy", fields: [restoredByUserId], references: [id])

  @@index([companyId, projectId, createdAt], map: "ProjectPetlArchive_company_project_created_idx")
  @@index([projectId, createdAt], map: "ProjectPetlArchive_project_created_idx")
}

/// Global list of job / project statuses (e.g. Open, Closed, Warranty).
model JobStatus {
  id        String  @id @default(cuid())
  code      String  @unique
  label     String
  sortOrder Int     @default(0)
  active    Boolean @default(true)
}

model ProjectMembership {
  userId     String
  projectId  String
  companyId  String
  role       ProjectRole
  createdAt  DateTime                @default(now())
  scope      ProjectParticipantScope @default(OWNER_MEMBER)
  visibility ProjectVisibilityLevel  @default(FULL)
  company    Company                 @relation(fields: [companyId], references: [id])
  project    Project                 @relation(fields: [projectId], references: [id])
  user       User                    @relation(fields: [userId], references: [id])

  @@id([userId, projectId])
}

model ProjectBuilding {
  id        String            @id @default(cuid())
  companyId String
  projectId String
  code      String?
  name      String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  company   Company           @relation(fields: [companyId], references: [id])
  project   Project           @relation(fields: [projectId], references: [id])
  particles ProjectParticle[]
  units     ProjectUnit[]
  dailyLogs DailyLog[]        @relation("ProjectBuildingDailyLogs")
}

model ProjectUnit {
  id           String            @id @default(cuid())
  companyId    String
  projectId    String
  buildingId   String?
  externalCode String?
  label        String
  floor        Int?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  particles    ProjectParticle[]
  building     ProjectBuilding?  @relation(fields: [buildingId], references: [id])
  company      Company           @relation(fields: [companyId], references: [id])
  project      Project           @relation(fields: [projectId], references: [id])
  dailyLogs    DailyLog[]        @relation("ProjectUnitDailyLogs")

  @@unique([projectId, label], name: "ProjectUnit_projectId_label_key")
}

model ProjectParticle {
  id                        String                    @id @default(cuid())
  companyId                 String
  projectId                 String
  buildingId                String?
  unitId                    String?
  type                      ProjectParticleType       @default(ROOM)
  name                      String
  fullLabel                 String
  externalGroupCode         String?
  externalGroupDescription  String?
  parentParticleId          String?
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime                  @updatedAt
  parcels                   Parcel[]
  building                  ProjectBuilding?          @relation(fields: [buildingId], references: [id])
  company                   Company                   @relation(fields: [companyId], references: [id])
  parentParticle            ProjectParticle?          @relation("ProjectParticleParent", fields: [parentParticleId], references: [id])
  childParticles            ProjectParticle[]         @relation("ProjectParticleParent")
  project                   Project                   @relation(fields: [projectId], references: [id])
  unit                      ProjectUnit?              @relation(fields: [unitId], references: [id])
  sowItems                  SowItem[]
  sowLogicalItems           SowLogicalItem[]
  tasks                     Task[]
  dailyLogs                 DailyLog[]                @relation("ProjectParticleDailyLogs")
  petlReconciliationEntries PetlReconciliationEntry[]
}

model AdminAuditLog {
  id              String     @id @default(cuid())
  actorId         String
  actorEmail      String
  actorGlobalRole GlobalRole
  action          String
  targetCompanyId String?
  targetUserId    String?
  metadata        Json?
  createdAt       DateTime   @default(now())
}

model ProjectFinancialSnapshot {
  id                   String   @id @default(cuid())
  projectId            String
  estimateVersionId    String
  totalRcvClaim        Float
  totalAcvClaim        Float
  workCompleteRcv      Float
  acvReturn            Float
  opRate               Float
  acvOP                Float
  totalDueWorkBillable Float
  depositRate          Float
  depositBaseline      Float
  billedToDate         Float
  duePayable           Float
  dueAmount            Float
  snapshotDate         DateTime
  computedAt           DateTime @default(now())

  @@index([projectId, estimateVersionId, snapshotDate], map: "ProjectFinancialSnapshot_project_estimate_date_idx")
}

enum ProjectInvoiceStatus {
  DRAFT
  ISSUED
  PARTIALLY_PAID
  PAID
  VOID
}

enum ProjectInvoiceLineItemKind {
  MANUAL
  BILLABLE_HOURS
  EQUIPMENT_RENTAL
  COST_BOOK
  OTHER
}

enum ProjectPaymentMethod {
  WIRE
  ACH
  CHECK
  OTHER
}

enum ProjectPaymentStatus {
  RECORDED
  VOID
}

enum ProjectBillStatus {
  DRAFT
  POSTED
  PAID
  VOID
}

enum ProjectBillLineItemKind {
  MATERIALS
  LABOR
  OTHER
}

enum ProjectBillLineItemAmountSource {
  MANUAL
  TIMECARDS_DERIVED
}

/// Simple per-company sequence counter for invoice numbering.
/// We keep this in the application layer (rather than a Postgres SEQUENCE) so we can
/// evolve numbering rules per tenant without DB-level complexity.
model CompanyInvoiceCounter {
  companyId     String   @id
  lastInvoiceNo Int      @default(0)
  updatedAt     DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

/// A project-level invoice. Draft invoices act as the "living" invoice and can be edited.
/// Once issued, an invoice is locked and receives an invoice number.
model ProjectInvoice {
  id        String @id @default(cuid())
  companyId String
  projectId String

  status ProjectInvoiceStatus @default(DRAFT)

  /// Assigned when the invoice is issued. Uniqueness is enforced by (companyId, invoiceSequenceNo).
  invoiceSequenceNo Int?
  invoiceNo         String?

  billToName  String?
  billToEmail String?

  memo String?

  issuedAt DateTime?
  dueAt    DateTime?
  lockedAt DateTime?

  totalAmount Float @default(0)

  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("ProjectInvoiceCreatedBy", fields: [createdByUserId], references: [id])

  lineItems                   ProjectInvoiceLineItem[]
  petlLines                   ProjectInvoicePetlLine[]
  payments                    ProjectPayment[]
  paymentApplications         ProjectPaymentApplication[]
  invoiceApplicationsAsSource ProjectInvoiceApplication[] @relation("InvoiceApplicationsSource")
  invoiceApplicationsAsTarget ProjectInvoiceApplication[] @relation("InvoiceApplicationsTarget")

  @@unique([companyId, invoiceSequenceNo], name: "ProjectInvoice_company_invoice_seq_key")
  @@index([companyId, projectId, status], map: "ProjectInvoice_company_project_status_idx")
}

model ProjectInvoiceLineItem {
  id        String @id @default(cuid())
  invoiceId String

  kind ProjectInvoiceLineItemKind @default(MANUAL)

  // Optional invoice-only classification for reporting / display.
  billingTag ProjectInvoicePetlLineBillingTag @default(NONE)

  // Optional pointer to the tenant cost book item used to generate this line.
  // (We also snapshot description/unitPrice directly on the invoice line so invoices
  // remain stable if the cost book changes later.)
  companyPriceListItemId String?

  description String
  qty         Float?
  unitPrice   Float?
  amount      Float
  sortOrder   Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice              ProjectInvoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  companyPriceListItem CompanyPriceListItem? @relation("InvoiceLineItemCostBookItem", fields: [companyPriceListItemId], references: [id], onDelete: SetNull)

  @@index([invoiceId, sortOrder], map: "ProjectInvoiceLineItem_invoice_sort_idx")
  @@index([invoiceId, kind], map: "ProjectInvoiceLineItem_invoice_kind_idx")
  @@index([invoiceId, billingTag], map: "ProjectInvoiceLineItem_invoice_billing_tag_idx")
  @@index([companyPriceListItemId], map: "ProjectInvoiceLineItem_company_price_item_idx")
}

enum ProjectInvoicePetlLineKind {
  BASE
  ACV_HOLDBACK_CREDIT
}

enum ProjectInvoicePetlLineBillingTag {
  NONE
  PETL_LINE_ITEM
  CHANGE_ORDER
  SUPPLEMENT
  WARRANTY
}

/// Snapshot of PETL (estimate) progress-billing values at the time an invoice draft is generated.
///
/// For ACV-only lines, we generate an indented credit sub-line (ACV_HOLDBACK_CREDIT) equal to
/// -0.8 of the BASE amounts so the net billed amount is reduced.
model ProjectInvoicePetlLine {
  id        String                     @id @default(cuid())
  invoiceId String
  kind      ProjectInvoicePetlLineKind @default(BASE)

  // Optional invoice-only classification for reporting / display.
  billingTag ProjectInvoicePetlLineBillingTag @default(NONE)

  // For indentation / sub-lines (e.g. ACV holdback credit under BASE)
  parentLineId String?

  // PETL identity (stable across imports)
  estimateVersionId String
  sowItemId         String
  logicalItemId     String

  // Grouping snapshots (mirrors PETL project grouping / tree)
  projectParticleId            String
  projectParticleLabelSnapshot String?
  projectUnitIdSnapshot        String?
  projectUnitLabelSnapshot     String?
  projectBuildingIdSnapshot    String?
  projectBuildingLabelSnapshot String?
  projectTreePathSnapshot      String?

  // Display snapshots
  /// Internal PETL line ordering (sequential, stable for sorting).
  lineNoSnapshot         Int
  /// Original line number from the source estimate export (e.g. Xactimate "#").
  sourceLineNoSnapshot   Int?
  /// Rich invoice display/ordering for PETL-derived lines (e.g. 3958, 3958.001, 3958.1).
  displayLineNo          String?
  anchorRootSourceLineNo Int?
  anchorKind             String?
  anchorSubIndex         Int?
  anchorGroupSubIndex    Int?

  categoryCodeSnapshot  String?
  selectionCodeSnapshot String?
  descriptionSnapshot   String
  unitSnapshot          String?

  // Progress snapshot
  percentCompleteSnapshot Float

  // Contract snapshot (full values)
  contractItemAmount Float
  contractTaxAmount  Float
  contractOpAmount   Float
  contractTotal      Float

  // Earned-to-date (as-of this invoice)
  earnedItemAmount Float
  earnedTaxAmount  Float
  earnedOpAmount   Float
  earnedTotal      Float

  // Previously billed (before this invoice)
  prevBilledItemAmount Float
  prevBilledTaxAmount  Float
  prevBilledOpAmount   Float
  prevBilledTotal      Float

  // Delta for this invoice (can be negative)
  thisInvItemAmount Float
  thisInvTaxAmount  Float
  thisInvOpAmount   Float
  thisInvTotal      Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice    ProjectInvoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  parentLine ProjectInvoicePetlLine?  @relation("ProjectInvoicePetlLineParent", fields: [parentLineId], references: [id], onDelete: Cascade)
  subLines   ProjectInvoicePetlLine[] @relation("ProjectInvoicePetlLineParent")

  @@unique([invoiceId, sowItemId, kind])
  @@index([invoiceId, projectParticleId])
  @@index([parentLineId])
}

/// A payment record applied to an invoice (or optionally recorded as unapplied cash).
model ProjectPayment {
  id        String  @id @default(cuid())
  companyId String
  projectId String
  invoiceId String?

  status    ProjectPaymentStatus @default(RECORDED)
  method    ProjectPaymentMethod
  paidAt    DateTime             @default(now())
  amount    Float
  reference String?
  note      String?

  createdByUserId String?
  createdAt       DateTime @default(now())

  company      Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project      Project                     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invoice      ProjectInvoice?             @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  createdBy    User?                       @relation("ProjectPaymentCreatedBy", fields: [createdByUserId], references: [id])
  applications ProjectPaymentApplication[]

  @@index([companyId, projectId, paidAt], map: "ProjectPayment_company_project_paid_idx")
  @@index([invoiceId], map: "ProjectPayment_invoice_idx")
}

/// Allocation of a (possibly partially) received payment to a specific invoice.
/// This allows recording payments before an invoice exists, and later applying
/// some or all of that cash receipt across one or more invoices.
model ProjectPaymentApplication {
  id        String @id @default(cuid())
  companyId String
  projectId String

  paymentId String
  invoiceId String

  amount    Float
  appliedAt DateTime @default(now())

  createdByUserId String?
  createdAt       DateTime @default(now())

  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  payment   ProjectPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice   ProjectInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  createdBy User?          @relation("ProjectPaymentApplicationCreatedBy", fields: [createdByUserId], references: [id])

  @@unique([paymentId, invoiceId])
  @@index([companyId, projectId, appliedAt], map: "ProjectPaymentApplication_company_project_applied_idx")
  @@index([paymentId], map: "ProjectPaymentApplication_payment_idx")
  @@index([invoiceId], map: "ProjectPaymentApplication_invoice_idx")
}

model ProjectInvoiceApplication {
  id        String @id @default(cuid())
  companyId String
  projectId String

  sourceInvoiceId String
  targetInvoiceId String

  amount    Float
  appliedAt DateTime @default(now())

  createdByUserId String?
  createdAt       DateTime @default(now())

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceInvoice ProjectInvoice @relation("InvoiceApplicationsSource", fields: [sourceInvoiceId], references: [id], onDelete: Cascade)
  targetInvoice ProjectInvoice @relation("InvoiceApplicationsTarget", fields: [targetInvoiceId], references: [id], onDelete: Cascade)
  createdBy     User?          @relation("ProjectInvoiceApplicationCreatedBy", fields: [createdByUserId], references: [id])

  @@index([companyId, projectId, appliedAt], map: "ProjectInvoiceApplication_company_project_applied_idx")
  @@index([sourceInvoiceId], map: "ProjectInvoiceApplication_source_invoice_idx")
  @@index([targetInvoiceId], map: "ProjectInvoiceApplication_target_invoice_idx")
}

model ProjectBill {
  id        String @id @default(cuid())
  companyId String
  projectId String

  vendorName String
  billNumber String?

  billDate DateTime
  dueAt    DateTime?

  status ProjectBillStatus @default(DRAFT)

  memo String?

  totalAmount Float

  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("ProjectBillCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  lineItems   ProjectBillLineItem[]
  attachments ProjectBillAttachment[]

  @@index([companyId, projectId, billDate], map: "ProjectBill_company_project_date_idx")
  @@index([projectId, billDate], map: "ProjectBill_project_date_idx")
}

model ProjectBillLineItem {
  id     String @id @default(cuid())
  billId String

  kind         ProjectBillLineItemKind
  description  String
  amountSource ProjectBillLineItemAmountSource @default(MANUAL)
  amount       Float

  // Optional labor derivation from timecards.
  timecardStartDate DateTime?
  timecardEndDate   DateTime?
  metaJson          Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bill ProjectBill @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@index([billId], map: "ProjectBillLineItem_bill_idx")
}

model ProjectBillAttachment {
  id            String @id @default(cuid())
  billId        String
  projectFileId String

  // Snapshot for display convenience.
  fileUrl   String
  fileName  String?
  mimeType  String?
  sizeBytes Int?

  createdAt DateTime @default(now())

  bill        ProjectBill @relation(fields: [billId], references: [id], onDelete: Cascade)
  projectFile ProjectFile @relation(fields: [projectFileId], references: [id], onDelete: Cascade)

  @@unique([billId, projectFileId], map: "ProjectBillAttachment_bill_file_key")
  @@index([billId], map: "ProjectBillAttachment_bill_idx")
  @@index([projectFileId], map: "ProjectBillAttachment_project_file_idx")
}

/// Log of Golden price list updates driven by Xact RAW imports.
/// Each row records how many items were updated and the average
/// price deltas, along with the project, estimate, and user.
model GoldenPriceUpdateLog {
  id                String                  @id @default(cuid())
  companyId         String
  projectId         String?
  estimateVersionId String?
  userId            String?
  updatedCount      Int
  avgDelta          Float
  avgPercentDelta   Float
  source            GoldenPriceUpdateSource @default(XACT_ESTIMATE)
  createdAt         DateTime                @default(now()) @db.Timestamptz(6)
  company           Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  estimateVersion   EstimateVersion?        @relation(fields: [estimateVersionId], references: [id], onDelete: Cascade)
  project           Project?                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user              User?                   @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt], map: "GoldenPriceUpdateLog_company_created_idx")
  @@index([projectId, createdAt], map: "GoldenPriceUpdateLog_project_created_idx")
}

/// Per-tenant log of price updates applied to CompanyPriceListItem rows.
/// Used for audit trails and for driving UI price history ("hot link" on Unit Price).
model TenantPriceUpdateLog {
  id                     String   @id @default(cuid())
  companyId              String
  companyPriceListId     String
  companyPriceListItemId String
  canonicalKeyHash       String?
  oldUnitPrice           Float?
  newUnitPrice           Float?
  source                 String // e.g. "PROJECT_PETL_IMPORT", "PROJECT_MPETL_MANUAL"
  sourceImportJobId      String?
  projectId              String?
  estimateVersionId      String?
  changedByUserId        String?
  changedAt              DateTime @default(now())

  company              Company              @relation(fields: [companyId], references: [id])
  companyPriceList     CompanyPriceList     @relation(fields: [companyPriceListId], references: [id])
  companyPriceListItem CompanyPriceListItem @relation(fields: [companyPriceListItemId], references: [id])
  estimateVersion      EstimateVersion?     @relation(fields: [estimateVersionId], references: [id])
  project              Project?             @relation(fields: [projectId], references: [id])

  @@index([companyId, changedAt], map: "TenantPriceUpdateLog_company_changed_idx")
  @@index([companyPriceListItemId, changedAt], map: "TenantPriceUpdateLog_item_changed_idx")
}

model Task {
  id                String       @id @default(cuid())
  title             String
  description       String?
  status            TaskStatus   @default(TODO)
  dueDate           DateTime?
  companyId         String
  projectId         String
  assigneeId        String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  priority          TaskPriority @default(MEDIUM)
  projectParticleId String?

  createdByUserId         String?
  relatedEntityType       String?
  relatedEntityId         String?
  reminderIntervalMinutes Int?
  lastReminderAt          DateTime?

  assignee        User?            @relation("TaskAssignee", fields: [assigneeId], references: [id])
  company         Company          @relation(fields: [companyId], references: [id])
  project         Project          @relation(fields: [projectId], references: [id])
  projectParticle ProjectParticle? @relation(fields: [projectParticleId], references: [id])
  createdBy       User?            @relation("TaskCreatedBy", fields: [createdByUserId], references: [id])

  @@index([companyId, relatedEntityType, relatedEntityId], map: "Task_related_entity_idx")
}

model EstimateVersion {
  id                        String                     @id @default(cuid())
  projectId                 String
  sourceType                String
  fileName                  String
  storedPath                String
  estimateKind              String
  sequenceNo                Int
  defaultPayerType          String
  description               String?
  status                    String
  errorMessage              String?
  importedByUserId          String?
  importedAt                DateTime?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  allocationRules           ComponentAllocationRule[]
  componentSummaries        ComponentSummary[]
  project                   Project                    @relation(fields: [projectId], references: [id])
  goldenPriceUpdates        GoldenPriceUpdateLog[]
  tenantPriceUpdates        TenantPriceUpdateLog[]
  rawComponentRows          RawComponentRow[]
  rawRows                   RawXactRow[]
  sows                      Sow[]
  componentAllocations      SowComponentAllocation[]
  sowItems                  SowItem[]
  petlReconciliationCases   PetlReconciliationCase[]
  petlReconciliationEntries PetlReconciliationEntry[]
  petlReconciliationEvents  PetlReconciliationEvent[]
  petlArchivesSource        ProjectPetlArchive[]       @relation("PetlArchiveSourceEstimateVersion")
  petlArchivesRestored      ProjectPetlArchive[]       @relation("PetlArchiveRestoredEstimateVersion")
  petlPercentUpdateSessions PetlPercentUpdateSession[]

  // Project scheduling (canonical schedule + change history)
  scheduleTasks      ProjectScheduleTask[]
  scheduleChangeLogs ProjectScheduleChangeLog[]

  // Cost book items sourced from this estimate version
  costBookItemsSourced CompanyPriceListItem[] @relation("CostBookSourceEstimate")

  // Regional factors learned from this estimate
  regionalFactorsLearned ProjectRegionalFactors[]

  @@index([projectId, sequenceNo], map: "EstimateVersion_project_sequence_idx")
}

model RawXactRow {
  id                 String          @id @default(cuid())
  estimateVersionId  String
  lineNo             Int
  groupCode          String?
  groupDescription   String?
  desc               String?
  age                Float?
  condition          String?
  qty                Float?
  itemAmount         Float?
  reportedCost       Float?
  unitCost           Float?
  unit               String?
  coverage           String?
  activity           String?
  workersWage        Float?
  laborBurden        Float?
  laborOverhead      Float?
  material           Float?
  equipment          Float?
  marketConditions   Float?
  laborMinimum       Float?
  salesTax           Float?
  rcv                Float?
  life               Int?
  depreciationType   String?
  depreciationAmount Float?
  recoverable        Boolean?
  acv                Float?
  tax                Float?
  replaceFlag        Boolean?
  cat                String?
  sel                String?
  owner              String?
  originalVendor     String?
  sourceName         String?
  sourceDate         DateTime?
  note1              String?
  adjSource          String?
  rawRowJson         Json?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  estimateVersion    EstimateVersion @relation(fields: [estimateVersionId], references: [id])
  sowItems           SowItem[]

  @@index([estimateVersionId, lineNo], map: "RawXactRow_estimate_line_idx")
  @@index([estimateVersionId, cat, sel], map: "RawXactRow_estimate_cat_sel_idx")
}

model RawComponentRow {
  id                          String          @id @default(cuid())
  estimateVersionId           String
  code                        String?
  description                 String?
  taxStatus                   String?
  contractorSuppliedRaw       String?
  quantityRaw                 String?
  unitRaw                     String?
  unitPriceRaw                String?
  totalRaw                    String?
  requestThirdPartyPricingRaw String?
  rawRowJson                  Json?
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime        @updatedAt
  estimateVersion             EstimateVersion @relation(fields: [estimateVersionId], references: [id])

  @@index([estimateVersionId], map: "RawComponentRow_estimate_idx")
}

model ProjectScheduleTask {
  id                String   @id @default(cuid())
  projectId         String
  estimateVersionId String
  syntheticId       String // matches ScheduledTaskPreview.id (e.g. "wp-3", "mitigation-<estimateId>")
  kind              String // "MITIGATION" | "WORK" for now
  room              String?
  trade             String
  phaseCode         Int
  phaseLabel        String
  startDate         DateTime
  endDate           DateTime
  durationDays      Float
  totalLaborHours   Float?
  crewSize          Int?
  predecessorIds    Json?

  /// Canonical project organization bindings (optional but preferred when available).
  /// These mirror ProjectUnit / ProjectParticle identity and the import-time org group
  /// code used for units like ELECTRI, RISK__E, WASH_UT, UNIT_01, etc.
  projectUnitId     String?
  projectParticleId String?
  orgGroupCode      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project         Project                    @relation(fields: [projectId], references: [id])
  estimateVersion EstimateVersion            @relation(fields: [estimateVersionId], references: [id])
  changeLogs      ProjectScheduleChangeLog[]

  @@unique([projectId, estimateVersionId, syntheticId], map: "ProjectScheduleTask_project_estimate_synth_idx")
  @@index([projectId, estimateVersionId], map: "ProjectScheduleTask_project_estimate_idx")
  @@index([projectId, projectUnitId], map: "ProjectScheduleTask_project_unit_idx")
  @@index([projectId, projectParticleId], map: "ProjectScheduleTask_project_particle_idx")
  @@index([projectId, orgGroupCode], map: "ProjectScheduleTask_project_orggroup_idx")
}

model ProjectScheduleChangeLog {
  id                   String    @id @default(cuid())
  projectId            String
  estimateVersionId    String
  scheduleTaskId       String
  taskSyntheticId      String
  changeType           String // e.g. "TASK_CREATED", "TASK_UPDATED"
  previousStartDate    DateTime?
  previousEndDate      DateTime?
  previousDurationDays Float?
  newStartDate         DateTime?
  newEndDate           DateTime?
  newDurationDays      Float?
  actorUserId          String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  project         Project             @relation(fields: [projectId], references: [id])
  estimateVersion EstimateVersion     @relation(fields: [estimateVersionId], references: [id])
  scheduleTask    ProjectScheduleTask @relation(fields: [scheduleTaskId], references: [id])
  actor           User                @relation("ProjectScheduleChangeLogActor", fields: [actorUserId], references: [id])

  @@index([projectId, estimateVersionId, createdAt], map: "ProjectScheduleChangeLog_project_estimate_created_idx")
  @@index([scheduleTaskId, createdAt], map: "ProjectScheduleChangeLog_task_created_idx")
}

model ComponentSummary {
  id                       String                   @id @default(cuid())
  projectId                String
  estimateVersionId        String
  code                     String
  description              String?
  taxStatus                String?
  contractorSupplied       Boolean?
  quantity                 Float?
  unit                     String?
  unitPrice                Float?
  total                    Float?
  requestThirdPartyPricing Boolean?
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  estimateVersion          EstimateVersion          @relation(fields: [estimateVersionId], references: [id])
  project                  Project                  @relation(fields: [projectId], references: [id])
  allocations              SowComponentAllocation[]

  @@index([projectId, estimateVersionId, code], map: "ComponentSummary_project_estimate_code_idx")
}

model SowComponentAllocation {
  id                 String            @id @default(cuid())
  projectId          String
  estimateVersionId  String
  sowItemId          String
  componentSummaryId String?
  code               String
  quantity           Float?
  total              Float?
  allocationBasis    String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  componentSummary   ComponentSummary? @relation(fields: [componentSummaryId], references: [id])
  estimateVersion    EstimateVersion   @relation(fields: [estimateVersionId], references: [id])
  project            Project           @relation(fields: [projectId], references: [id])
  sowItem            SowItem           @relation(fields: [sowItemId], references: [id])

  @@index([projectId, estimateVersionId, code], map: "SowComponentAllocation_project_estimate_code_idx")
  @@index([sowItemId], map: "SowComponentAllocation_sowItem_idx")
}

model ComponentAllocationRule {
  id                 String           @id @default(cuid())
  projectId          String
  estimateVersionId  String?
  componentCode      String
  targetCategoryCode String?
  targetActivity     String?
  active             Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  estimateVersion    EstimateVersion? @relation(fields: [estimateVersionId], references: [id])
  project            Project          @relation(fields: [projectId], references: [id])

  @@index([projectId, componentCode], map: "ComponentAllocationRule_project_code_idx")
  @@index([estimateVersionId], map: "ComponentAllocationRule_estimate_idx")
}

model Sow {
  id                String          @id @default(cuid())
  projectId         String
  estimateVersionId String
  sourceType        String
  totalAmount       Float?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  estimateVersion   EstimateVersion @relation(fields: [estimateVersionId], references: [id])
  project           Project         @relation(fields: [projectId], references: [id])
  items             SowItem[]
}

model SowLogicalItem {
  id                      String                   @id @default(cuid())
  projectId               String
  projectParticleId       String
  signatureHash           String
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  items                   SowItem[]
  petlReconciliationCases PetlReconciliationCase[]
  project                 Project                  @relation(fields: [projectId], references: [id])
  projectParticle         ProjectParticle          @relation(fields: [projectParticleId], references: [id])
}

model SowItem {
  id                String  @id @default(cuid())
  sowId             String
  estimateVersionId String
  rawRowId          String
  logicalItemId     String
  projectParticleId String
  /// Internal PETL line ordering (sequential, stable for sorting).
  lineNo            Int
  /// Original line number from the source estimate export (e.g. Xactimate "#").
  sourceLineNo      Int?
  description       String
  /// Item note from Xactimate (Note 1 column)
  itemNote          String?

  /// Quantities
  qty         Float?
  /// Original quantity from the initial PETL import (Xact or MPETL).
  originalQty Float?

  unit                 String?
  unitCost             Float?
  itemAmount           Float?
  rcvAmount            Float?
  acvAmount            Float?
  depreciationAmount   Float?
  salesTaxAmount       Float?
  categoryCode         String?
  selectionCode        String?
  activity             String?
  materialAmount       Float?
  equipmentAmount      Float?
  payerType            String
  performed            Boolean  @default(false)
  eligibleForAcvRefund Boolean  @default(false)
  acvRefundAmount      Float?
  percentComplete      Float    @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  isAcvOnly            Boolean  @default(false)

  /// Standalone Change Order (CO) identification - not part of original POL
  isStandaloneChangeOrder Boolean @default(false)
  coSequenceNo            Int? // 1, 2, 3... for CO items from same source line
  coSourceLineNo          Int? // Original parent line number (for "15-CO1" display)

  /// Field reconciliation (PUDL / Daily Log)  quantity audits
  qtyFlaggedIncorrect      Boolean   @default(false)
  qtyFieldReported         Float?
  qtyFieldReportedByUserId String?
  qtyFieldReportedAt       DateTime?
  qtyFieldNotes            String?
  qtyReviewStatus          String?

  petlEditChanges           PetlEditChange[]
  petlReconciliationCases   PetlReconciliationCase[]  @relation("PetlReconCaseSowItem")
  petlReconciliationEntries PetlReconciliationEntry[] @relation("PetlReconEntryParentSowItem")
  petlPercentUpdates        PetlPercentUpdate[]
  componentAllocations      SowComponentAllocation[]
  estimateVersion           EstimateVersion           @relation(fields: [estimateVersionId], references: [id])
  logicalItem               SowLogicalItem            @relation(fields: [logicalItemId], references: [id])
  projectParticle           ProjectParticle           @relation(fields: [projectParticleId], references: [id])
  rawRow                    RawXactRow                @relation(fields: [rawRowId], references: [id])
  sow                       Sow                       @relation(fields: [sowId], references: [id])
  assetUsages               AssetUsage[]
  dailyLogs                 DailyLog[]                @relation("SowItemDailyLogs")

  @@index([estimateVersionId, projectParticleId], map: "SowItem_estimate_particle_idx")
  @@index([projectParticleId], map: "SowItem_particle_idx")
  @@index([categoryCode, selectionCode], map: "SowItem_cat_sel_idx")
}

/// Generic nickname / alias model for projects and particles.
model NameAlias {
  id           String   @id @default(cuid())
  /// 'project' | 'particle' (extendable later)
  entityType   String
  /// ID of the underlying entity (Project.id, ProjectParticle.id, ...)
  entityId     String
  /// The original name we are aliasing from (for audit / display of Xactimate source names).
  originalName String
  /// The human-friendly nickname.
  nickname     String
  /// Exactly one current alias per (entityType, entityId) should be true.
  isCurrent    Boolean  @default(true)
  createdBy    String?
  createdAt    DateTime @default(now())
}

/// Global tag dictionary per company (project groups, room tags, etc.).
model Tag {
  id              String          @id @default(cuid())
  companyId       String
  code            String
  label           String
  color           String?
  sortOrder       Int             @default(0)
  active          Boolean         @default(true)
  createdByUserId String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  company         Company         @relation(fields: [companyId], references: [id])
  assignments     TagAssignment[]

  @@unique([companyId, code], name: "Tag_company_code_key")
}

/// Attach tags to arbitrary entities (projects, particles, tasks, parcels, ...).
model TagAssignment {
  id              String   @id @default(cuid())
  tagId           String
  companyId       String
  /// 'project' | 'particle' | 'task' | 'parcel' | ...
  entityType      String
  entityId        String
  createdByUserId String?
  createdAt       DateTime @default(now())
  company         Company  @relation(fields: [companyId], references: [id])
  tag             Tag      @relation(fields: [tagId], references: [id])

  @@index([companyId, entityType, entityId], map: "TagAssignment_entity_idx")
  @@index([companyId, tagId], map: "TagAssignment_tag_idx")
}

model PetlEditSession {
  id        String           @id @default(cuid())
  userId    String?
  projectId String
  source    String           @default("ncc-petl-ui")
  meta      Json?
  startedAt DateTime
  endedAt   DateTime
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  changes   PetlEditChange[]
  project   Project          @relation(fields: [projectId], references: [id])
}

model PetlEditChange {
  id          String          @id @default(cuid())
  sessionId   String
  sowItemId   String
  field       String
  oldValue    Float?
  newValue    Float?
  effectiveAt DateTime
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  session     PetlEditSession @relation(fields: [sessionId], references: [id])
  sowItem     SowItem         @relation(fields: [sowItemId], references: [id])
}

enum PetlPercentUpdateSessionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PetlPercentUpdateTargetType {
  SOW_ITEM
  RECON_ENTRY
}

/// Field/crew-submitted percent complete edits that must be approved before
/// they become part of the PETL process-of-record.
model PetlPercentUpdateSession {
  id                String  @id @default(cuid())
  projectId         String
  estimateVersionId String
  createdByUserId   String?
  source            String  @default("field")
  metaJson          Json?

  status    PetlPercentUpdateSessionStatus @default(PENDING)
  createdAt DateTime                       @default(now())
  updatedAt DateTime                       @updatedAt

  reviewedByUserId String?
  reviewedAt       DateTime?
  reviewNote       String?

  project         Project         @relation(fields: [projectId], references: [id])
  estimateVersion EstimateVersion @relation(fields: [estimateVersionId], references: [id])
  createdBy       User?           @relation("PetlPercentUpdateSessionCreatedBy", fields: [createdByUserId], references: [id])
  reviewedBy      User?           @relation("PetlPercentUpdateSessionReviewedBy", fields: [reviewedByUserId], references: [id])

  updates PetlPercentUpdate[]

  @@index([projectId, status, createdAt], map: "PetlPercentUpdateSession_project_status_created_idx")
}

model PetlPercentUpdate {
  id         String                      @id @default(cuid())
  sessionId  String
  targetType PetlPercentUpdateTargetType

  sowItemId    String?
  reconEntryId String?

  oldPercent Float
  newPercent Float

  createdAt DateTime @default(now())

  session    PetlPercentUpdateSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sowItem    SowItem?                 @relation(fields: [sowItemId], references: [id])
  reconEntry PetlReconciliationEntry? @relation(fields: [reconEntryId], references: [id])

  @@index([sessionId], map: "PetlPercentUpdate_session_idx")
  @@index([sowItemId], map: "PetlPercentUpdate_sowItem_idx")
  @@index([reconEntryId], map: "PetlPercentUpdate_reconEntry_idx")
}

enum PetlReconciliationCaseStatus {
  OPEN
  CLOSED
}

enum PetlReconciliationEntryKind {
  NOTE_ONLY
  CREDIT
  ADD
  CHANGE_ORDER_CLIENT_PAY
  REIMBURSE_OWNER
}

enum PetlReconciliationEntryTag {
  SUPPLEMENT
  CHANGE_ORDER
  OTHER
  WARRANTY
}

enum PetlReconciliationEntryStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PetlActivity {
  REMOVE_AND_REPLACE // R&R (&) - full labor + material + equipment
  REMOVE // Remove (-) - labor only
  REPLACE // Replace (+) - labor + equipment
  DETACH_AND_RESET // D&R (R) - labor only
  MATERIALS // Material Only (M) - material cost only
  REPAIR // Repair (F) - labor + material (reduced)
  INSTALL_ONLY // Install Only (I) - labor + equipment
}

model PetlReconciliationCase {
  id                String                       @id @default(cuid())
  projectId         String
  estimateVersionId String
  sowItemId         String?
  logicalItemId     String?
  noteThreadId      String?
  status            PetlReconciliationCaseStatus @default(OPEN)
  createdByUserId   String?
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt

  project         Project                   @relation(fields: [projectId], references: [id])
  estimateVersion EstimateVersion           @relation(fields: [estimateVersionId], references: [id])
  sowItem         SowItem?                  @relation("PetlReconCaseSowItem", fields: [sowItemId], references: [id])
  logicalItem     SowLogicalItem?           @relation(fields: [logicalItemId], references: [id])
  noteThread      MessageThread?            @relation("PetlReconCaseNoteThread", fields: [noteThreadId], references: [id])
  createdBy       User?                     @relation("PetlReconCaseCreatedBy", fields: [createdByUserId], references: [id])
  entries         PetlReconciliationEntry[]
  events          PetlReconciliationEvent[]

  @@unique([projectId, logicalItemId], map: "PetlReconCase_project_logical_key")
  @@unique([projectId, sowItemId], map: "PetlReconCase_project_sow_key")
  @@index([projectId, estimateVersionId], map: "PetlReconCase_project_estimate_idx")
}

model PetlReconciliationEntry {
  id                String                        @id @default(cuid())
  projectId         String
  estimateVersionId String
  caseId            String
  parentSowItemId   String?
  projectParticleId String
  kind              PetlReconciliationEntryKind   @default(NOTE_ONLY)
  tag               PetlReconciliationEntryTag?
  status            PetlReconciliationEntryStatus @default(PENDING)

  // Snapshot of the reconciled / added line item (RCV breakdown)
  description       String?
  categoryCode      String?
  selectionCode     String?
  unit              String?
  qty               Float?
  unitCost          Float?
  itemAmount        Float?
  salesTaxAmount    Float?
  opAmount          Float?
  rcvAmount         Float?
  rcvComponentsJson Json?

  // Work tracking
  percentComplete         Float   @default(0)
  isPercentCompleteLocked Boolean @default(false)

  // Optional provenance for "added" lines sourced from the tenant price list
  companyPriceListItemId String?
  sourceSnapshotJson     Json?

  // Cross-version origin / carry-forward metadata
  originEstimateVersionId   String?
  originSowItemId           String?
  originLineNo              Int?
  carriedForwardFromEntryId String?
  carryForwardCount         Int     @default(0)

  // Notes / placeholder semantics (rcvAmount null excludes from rollups)
  note String?

  // Cost component breakdown (for activity-based splits)
  workersWage    Float?
  laborBurden    Float?
  laborOverhead  Float?
  materialCost   Float?
  equipmentCost  Float?
  activity       PetlActivity?
  sourceActivity String? // Original activity before modification

  // Standalone Change Order (CO) identification - not part of original POL
  isStandaloneChangeOrder Boolean @default(false)
  coSequenceNo            Int? // 1, 2, 3... for CO items under same parent line

  createdByUserId  String?
  approvedByUserId String?
  approvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  project              Project                        @relation(fields: [projectId], references: [id])
  estimateVersion      EstimateVersion                @relation(fields: [estimateVersionId], references: [id])
  case                 PetlReconciliationCase         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  parentSowItem        SowItem?                       @relation("PetlReconEntryParentSowItem", fields: [parentSowItemId], references: [id])
  projectParticle      ProjectParticle                @relation(fields: [projectParticleId], references: [id])
  companyPriceListItem CompanyPriceListItem?          @relation(fields: [companyPriceListItemId], references: [id])
  createdBy            User?                          @relation("PetlReconEntryCreatedBy", fields: [createdByUserId], references: [id])
  approvedBy           User?                          @relation("PetlReconEntryApprovedBy", fields: [approvedByUserId], references: [id])
  petlPercentUpdates   PetlPercentUpdate[]
  attachments          PetlReconciliationAttachment[]
  events               PetlReconciliationEvent[]

  @@index([projectId, estimateVersionId], map: "PetlReconEntry_project_estimate_idx")
  @@index([caseId], map: "PetlReconEntry_case_idx")
  @@index([projectParticleId], map: "PetlReconEntry_particle_idx")
  @@index([originEstimateVersionId], map: "PetlReconEntry_origin_estimate_idx")
}

model PetlReconciliationAttachment {
  id            String  @id @default(cuid())
  entryId       String
  projectFileId String?

  fileUrl   String
  fileName  String?
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime @default(now())

  entry       PetlReconciliationEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  projectFile ProjectFile?            @relation(fields: [projectFileId], references: [id], onDelete: SetNull)

  @@index([entryId], map: "PetlReconAttachment_entry_idx")
  @@index([projectFileId], map: "PetlReconAttachment_project_file_idx")
}

model PetlReconciliationEvent {
  id                String   @id @default(cuid())
  projectId         String
  estimateVersionId String
  caseId            String
  entryId           String?
  eventType         String
  payloadJson       Json?
  createdByUserId   String?
  createdAt         DateTime @default(now())

  project         Project                  @relation(fields: [projectId], references: [id])
  estimateVersion EstimateVersion          @relation(fields: [estimateVersionId], references: [id])
  case            PetlReconciliationCase   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  entry           PetlReconciliationEntry? @relation(fields: [entryId], references: [id], onDelete: Cascade)
  createdBy       User?                    @relation("PetlReconEventCreatedBy", fields: [createdByUserId], references: [id])

  @@index([projectId, estimateVersionId, createdAt], map: "PetlReconEvent_project_estimate_created_idx")
  @@index([caseId, createdAt], map: "PetlReconEvent_case_created_idx")
  @@index([entryId], map: "PetlReconEvent_entry_idx")
}

model DailyLog {
  id                   String               @id @default(cuid())
  projectId            String
  createdById          String
  logDate              DateTime
  title                String?
  tagsJson             String?
  weatherSummary       String?
  crewOnSite           String?
  workPerformed        String?
  issues               String?
  safetyIncidents      String?
  manpowerOnsite       String?
  personOnsite         String?
  confidentialNotes    String?
  /// Optional PETL context
  buildingId           String?
  unitId               String?
  roomParticleId       String?
  sowItemId            String?
  shareInternal        Boolean              @default(true)
  shareSubs            Boolean              @default(false)
  shareClient          Boolean              @default(false)
  sharePrivate         Boolean              @default(false)
  notifyUserIdsJson    String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  effectiveShareClient Boolean              @default(false)
  status               DailyLogStatus       @default(SUBMITTED)
  createdBy            User                 @relation(fields: [createdById], references: [id])
  project              Project              @relation(fields: [projectId], references: [id])
  attachments          DailyLogAttachment[]
  assetUsages          AssetUsage[]
  building             ProjectBuilding?     @relation("ProjectBuildingDailyLogs", fields: [buildingId], references: [id])
  unit                 ProjectUnit?         @relation("ProjectUnitDailyLogs", fields: [unitId], references: [id])
  roomParticle         ProjectParticle?     @relation("ProjectParticleDailyLogs", fields: [roomParticleId], references: [id])
  sowItem              SowItem?             @relation("SowItemDailyLogs", fields: [sowItemId], references: [id])

  @@index([projectId], map: "DailyLog_project_idx")
  @@index([projectId, roomParticleId], map: "DailyLog_project_room_idx")
  @@index([projectId, sowItemId], map: "DailyLog_project_sow_idx")
}

model DailyLogAttachment {
  id            String   @id @default(cuid())
  dailyLogId    String
  projectFileId String?
  fileUrl       String
  fileName      String?
  mimeType      String?
  sizeBytes     Int?
  createdAt     DateTime @default(now())

  dailyLog    DailyLog     @relation(fields: [dailyLogId], references: [id])
  projectFile ProjectFile? @relation(fields: [projectFileId], references: [id])

  @@index([dailyLogId], map: "DailyLogAttachment_log_idx")
}

model OnboardingSession {
  id                      String                  @id @default(cuid())
  companyId               String
  email                   String
  token                   String                  @unique
  status                  OnboardingStatus        @default(NOT_STARTED)
  /// Optional, admin-defined candidate status code for finer-grained pipeline
  /// semantics (e.g. WAITING_FOR_DOCS). Stored as a free-form string and
  /// optionally linked to CandidateStatusDefinition.
  detailStatusCode        String?
  checklistJson           String?
  assignedHiringManagerId String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  userId                  String?
  bankInfo                OnboardingBankInfo?
  documents               OnboardingDocument[]
  profile                 OnboardingProfile?
  user                    User?                   @relation(fields: [userId], references: [id])
  skillRatings            OnboardingSkillRating[]

  @@index([companyId, createdAt], map: "OnboardingSession_company_created_idx")
  @@index([userId], map: "OnboardingSession_user_idx")
  @@index([companyId, detailStatusCode], map: "OnboardingSession_company_detail_status_idx")
}

/// Admin-defined candidate status codes for Prospective Candidates / Nex-Net
/// pipeline management. These are optional and sit alongside the core
/// OnboardingStatus enum.
model CandidateStatusDefinition {
  id        String  @id @default(cuid())
  companyId String? // null = global status, otherwise tenant-specific
  code      String
  label     String
  color     String? // optional hex or token for UI chips
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  @@unique([companyId, code], name: "CandidateStatusDefinition_company_code_key")
}

model OnboardingProfile {
  id           String            @id @default(cuid())
  sessionId    String            @unique
  firstName    String?
  lastName     String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  dob          DateTime?
  session      OnboardingSession @relation(fields: [sessionId], references: [id])
}

model OnboardingDocument {
  id        String                 @id @default(cuid())
  sessionId String
  type      OnboardingDocumentType
  fileUrl   String
  fileName  String?
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime               @default(now())
  session   OnboardingSession      @relation(fields: [sessionId], references: [id])

  @@index([sessionId], map: "OnboardingDocument_session_idx")
}

model OnboardingBankInfo {
  id                  String            @id @default(cuid())
  sessionId           String            @unique
  accountHolderName   String?
  routingNumberMasked String?
  accountNumberMasked String?
  bankName            String?
  createdAt           DateTime          @default(now())
  session             OnboardingSession @relation(fields: [sessionId], references: [id])
}

model OnboardingSkillRating {
  id        String            @id @default(cuid())
  sessionId String
  skillId   String
  level     Int
  updatedAt DateTime          @updatedAt
  session   OnboardingSession @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, skillId], name: "OnboardingSkillRating_session_skill_key")
}

model SkillCategory {
  id        String  @id @default(cuid())
  code      String  @unique
  label     String
  sortOrder Int     @default(0)
  active    Boolean @default(true)
}

model SkillDefinition {
  id          String  @id @default(cuid())
  categoryId  String
  code        String  @unique
  label       String
  description String?
  sortOrder   Int     @default(0)
  active      Boolean @default(true)
  tradeLabel  String?
}

model UserSkillRating {
  id                  String   @id @default(cuid())
  userId              String
  skillId             String
  selfLevel           Int
  selfLevelLabel      String?
  yearsExperience     Int?
  notes               String?
  employerAvgLevel    Float?
  employerRatingCount Int?
  adminOverrideLevel  Int?
  updatedAt           DateTime @updatedAt
  clientAvgLevel      Float?
  clientRatingCount   Int?

  @@unique([userId, skillId], name: "UserSkillRating_user_skill_key")
}

model EmployerSkillRating {
  id            String   @id @default(cuid())
  userId        String
  skillId       String
  companyId     String
  ratedByUserId String?
  level         Int
  levelLabel    String?
  comment       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId, skillId], map: "EmployerSkillRating_user_skill_idx")
  @@index([companyId], map: "EmployerSkillRating_company_idx")
}

model ClientSkillRating {
  id              String   @id @default(cuid())
  userId          String
  skillId         String
  clientCompanyId String?
  ratedByUserId   String?
  level           Int
  levelLabel      String?
  comment         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, skillId], map: "ClientSkillRating_user_skill_idx")
  @@index([clientCompanyId], map: "ClientSkillRating_company_idx")
}

model UserSkillSuggestion {
  id            String   @id @default(cuid())
  userId        String
  label         String
  categoryLabel String?
  description   String?
  status        String   @default("PENDING")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId], map: "UserSkillSuggestion_user_idx")
  @@index([status])
}

model ReputationRating {
  id                String                     @id @default(cuid())
  subjectType       ReputationSubjectType
  subjectUserId     String?
  subjectCompanyId  String?
  raterUserId       String?
  raterCompanyId    String?
  sourceType        ReputationSourceType
  dimension         ReputationDimension        @default(OVERALL)
  score             Int
  comment           String?
  moderationStatus  ReputationModerationStatus @default(PENDING)
  moderatedByUserId String?
  moderatedAt       DateTime?
  moderatorNote     String?
  isActive          Boolean                    @default(true)
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt

  @@index([subjectUserId], map: "ReputationRating_subject_user_idx")
  @@index([subjectCompanyId], map: "ReputationRating_subject_company_idx")
}

model ImportJob {
  id                String          @id @default(cuid())
  companyId         String
  projectId         String?
  createdByUserId   String
  type              ImportJobType
  status            ImportJobStatus @default(QUEUED)
  progress          Int             @default(0)
  message           String?
  csvPath           String?
  /// Canonical URI for uploaded file when using object storage (e.g. GCS)
  fileUri           String?
  /// Optional chunking metadata for large, parallelized imports
  totalChunks       Int?
  completedChunks   Int?
  metaJson          Json?
  estimateVersionId String?
  resultJson        Json?
  errorJson         Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  startedAt         DateTime?
  finishedAt        DateTime?
  company           Company         @relation(fields: [companyId], references: [id])
  createdBy         User            @relation("ImportJobCreatedBy", fields: [createdByUserId], references: [id])
  project           Project?        @relation(fields: [projectId], references: [id], onDelete: Restrict)

  @@index([companyId, createdAt], map: "ImportJob_company_created_idx")
  @@index([projectId, createdAt], map: "ImportJob_project_created_idx")
  @@index([status, createdAt], map: "ImportJob_status_created_idx")
}

/// Global price list metadata (e.g. canonical Xactimate price list revisions).
model PriceList {
  id            String             @id @default(cuid())
  kind          PriceListKind      @default(GOLDEN)
  code          String?
  label         String
  revision      Int
  effectiveDate DateTime?
  currency      String?            @default("USD")
  isActive      Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  items         PriceListItem[]
  companyLists  CompanyPriceList[]

  @@index([kind, isActive, revision], map: "PriceList_kind_active_revision_idx")
}

/// Individual price list items (e.g. CAT/SEL codes and unit prices).
model PriceListItem {
  id                 String                 @id @default(cuid())
  priceListId        String
  lineNo             Int?
  groupCode          String?
  groupDescription   String?
  description        String?
  cat                String?
  sel                String?
  unit               String?
  unitPrice          Float?
  coverage           String?
  activity           String?
  owner              String?
  sourceVendor       String?
  sourceDate         DateTime?
  rawJson            Json?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  lastKnownUnitPrice Float?
  canonicalKeyHash   String?
  divisionCode       String?
  components         PriceListComponent[]
  division           Division?              @relation(fields: [divisionCode], references: [code])
  priceList          PriceList              @relation(fields: [priceListId], references: [id])
  assets             Asset[]
  companyItems       CompanyPriceListItem[]

  @@unique([priceListId, canonicalKeyHash], map: "PriceListItem_priceList_canonical_hash_key")
  @@index([priceListId, cat, sel], map: "PriceListItem_priceList_cat_sel_idx")
  @@index([divisionCode], map: "PriceListItem_division_code_idx")
}

model PriceListComponent {
  id              String        @id @default(cuid())
  priceListItemId String
  componentCode   String
  description     String?
  quantity        Float?
  material        Float?
  labor           Float?
  equipment       Float?
  createdAt       DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @db.Timestamptz(6)
  priceListItem   PriceListItem @relation(fields: [priceListItemId], references: [id], onDelete: Cascade)

  @@unique([priceListItemId, componentCode], name: "PLComponent_item_code_key", map: "PLComponent_item_code_key")
  @@index([priceListItemId], map: "PriceListComponent_item_idx")
  @@index([componentCode], map: "PriceListComponent_code_idx")
}

/// Standard CSI-style construction divisions (0116) used for
/// organizing revenue, cost, and work by building system.
model Division {
  id                    String                 @id @default(cuid())
  code                  String                 @unique
  name                  String
  sortOrder             Int                    @default(0)
  catMappings           CatDivision[]
  priceListItems        PriceListItem[]
  companyPriceListItems CompanyPriceListItem[] @relation("CompanyPriceListItemDivision")
}

/// Global mapping from Xactimate Cat codes (e.g. DRY, PLM) to
/// construction divisions. One row per Cat code.
model CatDivision {
  id           String   @id @default(cuid())
  cat          String   @unique
  divisionCode String
  division     Division @relation(fields: [divisionCode], references: [code])

  @@index([divisionCode], map: "CatDivision_division_code_idx")
}

// BEGIN WIP: Trade capacity model temporarily disabled for production build
// model TradeCapacityConfig {
//   id           String   @id @default(cuid())
//   companyId    String
//   projectId    String?
//   trade        String
//   maxConcurrent Int
//   createdAt    DateTime @default(now())
//   updatedAt    DateTime @updatedAt
//
//   company Company @relation(fields: [companyId], references: [id])
//   project Project? @relation(fields: [projectId], references: [id])
//
//   @@index([companyId, trade], map: "TradeCapacity_company_trade_idx")
//   @@index([projectId, trade], map: "TradeCapacity_project_trade_idx")
// }
// END WIP: Trade capacity model

model CompanyPriceList {
  id              String    @id @default(cuid())
  companyId       String
  basePriceListId String?
  label           String
  revision        Int       @default(1)
  effectiveDate   DateTime?
  currency        String?   @default("USD")
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  company       Company                @relation(fields: [companyId], references: [id])
  basePriceList PriceList?             @relation(fields: [basePriceListId], references: [id])
  items         CompanyPriceListItem[]
  priceUpdates  TenantPriceUpdateLog[]

  @@index([companyId, isActive, revision])
}

/// Individual tenant-level price list items that start from Golden but can
/// diverge per organization over time. Enriched automatically from PETL imports.
model CompanyPriceListItem {
  id                 String    @id @default(cuid())
  companyPriceListId String
  priceListItemId    String?
  canonicalKeyHash   String?
  lineNo             Int?
  groupCode          String?
  groupDescription   String?
  description        String?
  cat                String?
  sel                String?
  unit               String?
  unitPrice          Float?
  coverage           String?
  activity           String?
  owner              String?
  sourceVendor       String?
  sourceDate         DateTime?
  rawJson            Json?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastKnownUnitPrice Float?

  /// Xactimate cost component breakdown (auto-populated from PETL imports)
  workersWage   Float?
  laborBurden   Float?
  laborOverhead Float?
  materialCost  Float?
  equipmentCost Float?

  /// Construction division code (derived from CAT during seeding)
  divisionCode String?

  /// Source tracking for PETL auto-import
  sourceProjectId         String?
  sourceEstimateVersionId String?
  sourceProject           Project?         @relation("CostBookSourceProject", fields: [sourceProjectId], references: [id])
  sourceEstimateVersion   EstimateVersion? @relation("CostBookSourceEstimate", fields: [sourceEstimateVersionId], references: [id])

  /// Metadata for UI freshness and price history
  lastPriceChangedAt                DateTime?
  lastPriceChangedByUserId          String?
  lastPriceChangedSourceImportJobId String?
  lastPriceChangedSource            String?

  companyPriceList          CompanyPriceList          @relation(fields: [companyPriceListId], references: [id])
  priceListItem             PriceListItem?            @relation(fields: [priceListItemId], references: [id])
  division                  Division?                 @relation("CompanyPriceListItemDivision", fields: [divisionCode], references: [code])
  priceUpdates              TenantPriceUpdateLog[]
  petlReconciliationEntries PetlReconciliationEntry[]
  invoiceLineItems          ProjectInvoiceLineItem[]  @relation("InvoiceLineItemCostBookItem")

  @@index([companyPriceListId, canonicalKeyHash])
  @@index([companyPriceListId, cat, sel])
  @@index([divisionCode])
  @@index([sourceProjectId])
}

/// Project-level regional pricing factors learned from PETL imports.
/// Used to extrapolate accurate local pricing when adding cost book items.
model ProjectRegionalFactors {
  id                String @id @default(cuid())
  projectId         String @unique
  estimateVersionId String // The estimate we learned from

  // Aggregate rates learned from PETL
  aggregateTaxRate Float // e.g., 0.0825 for 8.25% (learned from RawXactRow)
  aggregateOPRate  Float // e.g., 0.20 for 20% O&P

  // Optional: component breakdowns
  avgLaborRatio     Float?
  avgMaterialRatio  Float?
  avgEquipmentRatio Float?

  // Metadata
  totalItemAmount Float // Total $ analyzed
  totalLineItems  Int // Number of PETL lines analyzed
  confidence      Float // 0-1 score based on sample size

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project             Project                     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sourceEstimate      EstimateVersion             @relation(fields: [estimateVersionId], references: [id], onDelete: Cascade)
  categoryAdjustments ProjectCategoryAdjustment[]

  @@index([projectId])
  @@index([estimateVersionId])
}

/// Category-level price adjustment factors learned from matching PETL to cost book.
model ProjectCategoryAdjustment {
  id                String @id @default(cuid())
  regionalFactorsId String

  categoryCode String // e.g., "PLB", "FRM", "ELE"
  activity     String? // e.g., "R&R", "Remove", "Install"

  // Adjustment factors
  avgPriceVariance    Float // Mean variance
  medianPriceVariance Float // Median variance (more robust)
  sampleSize          Int // Number of matched items

  // Optional: granular factors
  laborAdjustment     Float?
  materialAdjustment  Float?
  equipmentAdjustment Float?

  createdAt DateTime @default(now())

  regionalFactors ProjectRegionalFactors @relation(fields: [regionalFactorsId], references: [id], onDelete: Cascade)

  @@unique([regionalFactorsId, categoryCode, activity])
  @@index([regionalFactorsId])
}

/// Project-level tax configuration learned from PETL imports.
/// Tax rates are extrapolated from actual estimate data (RawXactRow).
model ProjectTaxConfig {
  id        String @id @default(cuid())
  projectId String @unique
  companyId String

  // Location for tax lookup
  taxZipCode String? // Primary project ZIP
  taxCity    String?
  taxState   String?

  // Learned tax rate from PETL
  learnedTaxRate        Float? // Combined rate (e.g., 0.0825 for 8.25%)
  learnedFromEstimateId String? // Which estimate we learned from

  // Deprecated: API-based fields (kept for future use)
  cachedStateTaxRate  Float?
  cachedCountyTaxRate Float?
  cachedCityTaxRate   Float?

  // Source tracking
  taxRateSource      String? // "learned-from-petl", "manual-override", etc.
  taxRateLastUpdated DateTime?
  taxRateConfidence  Float? // 0-1 based on sample size

  // Manual override (if user wants to override API)
  manualTaxRateOverride Float?
  useManualTaxRate      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([companyId])
}

enum LocationType {
  SITE
  BUILDING
  WAREHOUSE
  ZONE
  AISLE
  SHELF
  BIN
  PERSON
  VIRTUAL
  SUPPLIER
  VENDOR
  TRANSIT
  LOGICAL
}

enum InventoryItemType {
  ASSET
  MATERIAL
  PARTICLE
}

enum GlobalRole {
  NONE
  SUPER_ADMIN
  SUPPORT
}

enum TaxRateSource {
  TAPOUT_BASELINE
  COMPANY_OVERRIDE
}

/// High-level category for notifications so the UI can group them.
enum NotificationKind {
  GENERIC
  REFERRAL
  ONBOARDING
  PROJECT
  SYSTEM
  DIRECT_MESSAGE
}

/// Delivery channel used for a notification. IN_APP is always recorded; EMAIL
/// indicates that an email was also sent.
enum NotificationChannel {
  IN_APP
  EMAIL
}

enum MessageThreadType {
  DIRECT
  BOARD
  CUSTOMER
  JOURNAL
}

enum CompanyKind {
  SYSTEM
  ORGANIZATION
}

enum CompanyTrialStatus {
  ACTIVE
  EXPIRED
  CONVERTED
}

enum UserType {
  INTERNAL
  CLIENT
  APPLICANT
}

enum ImportJobType {
  XACT_RAW
  XACT_COMPONENTS
  XACT_COMPONENTS_ALLOCATE
  PRICE_LIST
  PRICE_LIST_COMPONENTS
  BIA_LCP
  COMPANY_PRICE_LIST
  FORTIFIED_PAYROLL_ADMIN
  PROJECT_PETL_PERCENT
}

enum ImportJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum PriceListKind {
  GOLDEN
  ACTIVE
}

enum GoldenPriceUpdateSource {
  XACT_ESTIMATE
  GOLDEN_PETL
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  CLIENT
  EM // Equipment Maintenance
}

enum ParcelStatus {
  PLANNED
  ACTIVE
  ON_HOLD
  COMPLETE
}

enum ProjectRole {
  OWNER
  MANAGER
  COLLABORATOR
  VIEWER
}

enum ProjectParticipantScope {
  OWNER_MEMBER
  COLLABORATOR_MEMBER
  EXTERNAL_CONTACT
}

enum ProjectVisibilityLevel {
  FULL
  LIMITED
  READ_ONLY
}

enum ProjectParticleType {
  ROOM
  ZONE
  EXTERIOR
}

enum AttachmentKind {
  INTERNAL_FILE
  UPLOADED_FILE
  EXTERNAL_LINK
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum NttSubjectType {
  APPLICATION_QUESTION
  APPLICATION_FAILURE
  UI_IMPROVEMENT
  OTHER
}

enum NttStatus {
  NEW
  TRIAGED
  IN_PROGRESS
  WAITING_ON_USER
  RESOLVED
  CLOSED
  DEFERRED
}

enum DailyLogStatus {
  SUBMITTED
  APPROVED
  REJECTED
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  TEST
}

enum OnboardingDocumentType {
  PHOTO
  GOV_ID
  OTHER
}

enum ReputationSubjectType {
  USER
  COMPANY
}

enum ReputationSourceType {
  EMPLOYER_ON_WORKER
  WORKER_ON_EMPLOYER
  CLIENT_ON_COMPANY
  COMPANY_ON_CLIENT
  MODERATOR_ADJUSTMENT
}

enum ReputationDimension {
  OVERALL
  SAFETY
  PAYMENT
  COMMUNICATION
  QUALITY
}

enum ReputationModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

/// v1 Asset-centric models (coexist alongside legacy v0 schema)
model Asset {
  id              String    @id @default(cuid())
  companyId       String
  name            String
  code            String?
  description     String?
  assetType       AssetType
  baseUnit        String?
  baseRate        Decimal?  @db.Decimal(12, 4)
  costBreakdown   Json?
  attributes      Json?
  isTrackable     Boolean   @default(false)
  isConsumable    Boolean   @default(false)
  priceListItemId String?

  // Identity / OEM
  manufacturer      String?
  model             String?
  serialNumberOrVin String?
  year              Int?
  isActive          Boolean @default(true)

  // Maintenance configuration (per asset)
  maintenanceProfileCode   String?
  maintTriggerStrategy     MaintenanceTriggerStrategy?
  maintTimeIntervalValue   Int?
  maintTimeIntervalUnit    MaintenanceIntervalUnit?
  maintMeterType           MaintenanceMeterType?
  maintMeterIntervalAmount Int?
  maintLeadTimeDays        Int?
  maintNotes               String?
  maintOwnerEmail          String?
  maintOwnerExternalId     String?

  // Location-aware field (optional initially)
  currentLocationId String?
  currentLocation   Location? @relation("AssetCurrentLocation", fields: [currentLocationId], references: [id])

  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  company       Company            @relation(fields: [companyId], references: [id])
  priceListItem PriceListItem?     @relation(fields: [priceListItemId], references: [id])
  usages        AssetUsage[]
  transactions  AssetTransaction[]

  // Maintenance relations
  maintenanceSchedules AssetMaintenanceSchedule[]
  maintenanceTodos     MaintenanceTodo[]
  meterReadings        AssetMeterReading[]

  @@index([companyId, assetType], map: "Asset_company_type_idx")
  @@index([companyId, currentLocationId])
}

model AssetUsage {
  id                    String             @id @default(cuid())
  assetId               String
  companyId             String
  projectId             String
  sowItemId             String?
  dailyLogId            String?
  billingMode           BillingMode
  status                UsageStatus        @default(PLANNED)
  quantity              Decimal?           @db.Decimal(12, 4)
  unit                  String?
  overrideRate          Decimal?           @db.Decimal(12, 4)
  snapshotRate          Decimal?           @db.Decimal(12, 4)
  snapshotCostBreakdown Json?
  actualCost            Decimal?           @db.Decimal(14, 2)
  startDate             DateTime?
  endDate               DateTime?
  notes                 String?
  createdByUserId       String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  asset                 Asset              @relation(fields: [assetId], references: [id])
  company               Company            @relation(fields: [companyId], references: [id])
  project               Project            @relation(fields: [projectId], references: [id])
  sowItem               SowItem?           @relation(fields: [sowItemId], references: [id])
  dailyLog              DailyLog?          @relation(fields: [dailyLogId], references: [id])
  createdBy             User?              @relation(fields: [createdByUserId], references: [id])
  transactions          AssetTransaction[]

  @@index([companyId, projectId], map: "AssetUsage_company_project_idx")
  @@index([assetId, status], map: "AssetUsage_asset_status_idx")
}

model AssetTransaction {
  id          String          @id @default(cuid())
  assetId     String
  companyId   String
  projectId   String?
  usageId     String?
  kind        TransactionKind
  quantity    Decimal?        @db.Decimal(12, 4)
  unit        String?
  unitCost    Decimal?        @db.Decimal(12, 4)
  totalCost   Decimal?        @db.Decimal(14, 2)
  notes       String?
  createdById String?
  createdAt   DateTime        @default(now())
  asset       Asset           @relation(fields: [assetId], references: [id])
  company     Company         @relation(fields: [companyId], references: [id])
  project     Project?        @relation(fields: [projectId], references: [id])
  usage       AssetUsage?     @relation(fields: [usageId], references: [id])
  createdBy   User?           @relation(fields: [createdById], references: [id])

  @@index([companyId, createdAt], map: "AssetTransaction_company_created_idx")
  @@index([assetId, createdAt], map: "AssetTransaction_asset_created_idx")
}

enum AssetType {
  LABOR
  MATERIAL
  EQUIPMENT
  TOOL
  RENTAL
  OTHER
}

enum BillingMode {
  TIME_AND_MATERIAL
  FIXED_FEE
  INCLUDED_IN_SCOPE
  NO_CHARGE
}

enum UsageStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELED
}

enum TransactionKind {
  PURCHASE
  CONSUME
  TRANSFER
  RETURN
  WASTE
  TIME_PUNCH
  MAINTENANCE
  ADJUSTMENT
}

enum MaintenanceTriggerStrategy {
  TIME_ONLY
  METER_ONLY
  TIME_OR_METER
}

enum MaintenanceIntervalUnit {
  DAY
  WEEK
  MONTH
  YEAR
}

enum MaintenanceMeterType {
  HOURS
  MILES
  RUN_CYCLES
  GENERATOR_HOURS
}

enum MaintenanceTodoStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  CANCELLED
}

model Location {
  id        String       @id @default(cuid())
  companyId String
  type      LocationType
  name      String
  code      String?

  parentLocationId String?
  parent           Location?  @relation("LocationHierarchy", fields: [parentLocationId], references: [id])
  children         Location[] @relation("LocationHierarchy")

  isActive Boolean @default(true)
  metadata Json?

  company Company @relation(fields: [companyId], references: [id])

  currentAssets       Asset[]             @relation("AssetCurrentLocation")
  currentMaterialLots MaterialLot[]       @relation("MaterialLotCurrentLocation")
  currentParticles    InventoryParticle[] @relation("InventoryParticleCurrentLocation")
  virtualParticles    InventoryParticle[] @relation("InventoryParticleVirtualLocation")

  movementsFrom InventoryMovement[] @relation("InventoryMovementFromLocation")
  movementsTo   InventoryMovement[] @relation("InventoryMovementToLocation")

  inventoryPositions InventoryPosition[]

  // People assigned to this physical/virtual location.
  personLocations PersonLocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code], name: "Location_companyId_code_unique")
  @@index([companyId, type])
}

model PersonLocation {
  id         String @id @default(cuid())
  companyId  String
  userId     String
  locationId String

  company  Company  @relation(fields: [companyId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  location Location @relation(fields: [locationId], references: [id])

  @@unique([companyId, userId], name: "PersonLocation_companyId_userId_unique")
}

model MaterialLot {
  id        String @id @default(cuid())
  companyId String

  sku      String
  name     String
  quantity Decimal @db.Decimal(18, 4)
  uom      String

  currentLocationId String
  currentLocation   Location @relation("MaterialLotCurrentLocation", fields: [currentLocationId], references: [id])

  metadata Json?

  company Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, sku])
  @@index([companyId, currentLocationId])
}

model InventoryParticle {
  id        String @id @default(cuid())
  companyId String

  parentEntityType String
  parentEntityId   String

  quantity Decimal @db.Decimal(18, 4)
  uom      String

  locationId String
  location   Location @relation("InventoryParticleCurrentLocation", fields: [locationId], references: [id])

  virtualLocationId String?
  virtualLocation   Location? @relation("InventoryParticleVirtualLocation", fields: [virtualLocationId], references: [id])

  company Company @relation(fields: [companyId], references: [id])

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, locationId])
  @@index([companyId, parentEntityType, parentEntityId])
}

model InventoryMovement {
  id        String @id @default(cuid())
  companyId String

  itemType InventoryItemType
  itemId   String

  fromLocationId String?
  fromLocation   Location? @relation("InventoryMovementFromLocation", fields: [fromLocationId], references: [id])

  toLocationId String
  toLocation   Location @relation("InventoryMovementToLocation", fields: [toLocationId], references: [id])

  quantity Decimal? @db.Decimal(18, 4)

  // Optional costing information associated with this movement
  metadata Json?

  transportCost     Decimal? @db.Decimal(14, 2)
  internalLaborCost Decimal? @db.Decimal(14, 2)

  movedByUserId String
  movedAt       DateTime @default(now())

  reason String
  note   String?

  company Company @relation(fields: [companyId], references: [id])
  movedBy User    @relation(fields: [movedByUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId, itemType, itemId])
  @@index([companyId, toLocationId, movedAt])
}

model AssetMaintenanceTemplate {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  code        String
  name        String
  description String?
  assetType   AssetType?

  isActive Boolean @default(true)

  rules     AssetMaintenanceRule[]
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  @@unique([companyId, code])
}

model AssetMaintenanceRule {
  id         String                   @id @default(cuid())
  templateId String
  template   AssetMaintenanceTemplate @relation(fields: [templateId], references: [id])

  name        String
  description String?

  triggerStrategy     MaintenanceTriggerStrategy
  timeIntervalValue   Int?
  timeIntervalUnit    MaintenanceIntervalUnit?
  meterType           MaintenanceMeterType?
  meterIntervalAmount Int?
  leadTimeDays        Int?

  defaultAssigneeRole Role?
  priority            Int?

  isActive Boolean @default(true)

  schedules AssetMaintenanceSchedule[]
  todos     MaintenanceTodo[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssetMaintenanceSchedule {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id])

  ruleId String
  rule   AssetMaintenanceRule @relation(fields: [ruleId], references: [id])

  lastServiceDate  DateTime?
  lastServiceMeter Int?

  nextTimeDueAt  DateTime?
  nextMeterDueAt Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  todos MaintenanceTodo[]

  @@unique([assetId, ruleId])
}

model MaintenanceTodo {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id])

  scheduleId String?
  schedule   AssetMaintenanceSchedule? @relation(fields: [scheduleId], references: [id])

  ruleId String?
  rule   AssetMaintenanceRule? @relation(fields: [ruleId], references: [id])

  title       String
  description String?

  status            MaintenanceTodoStatus @default(PENDING)
  dueDate           DateTime?
  completedAt       DateTime?
  completedByUserId String?

  assignedToUserId String?
  assignedToRole   Role?
  priority         Int?
  kind             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MaintenanceReviewSettings {
  id        String  @id @default(cuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id])

  intervalValue Int
  intervalUnit  MaintenanceIntervalUnit

  nextReviewAt DateTime?
  lastReviewAt DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssetMeterReading {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id])

  meterType  MaintenanceMeterType
  value      Int
  recordedAt DateTime             @default(now())
  source     String?

  createdAt DateTime @default(now())

  @@index([assetId, meterType, recordedAt])
}

model InventoryPosition {
  id        String @id @default(cuid())
  companyId String

  itemType InventoryItemType
  itemId   String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  quantity  Decimal @db.Decimal(18, 4)
  totalCost Decimal @db.Decimal(14, 2)

  metadata Json?

  company Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, itemType, itemId, locationId], name: "InventoryPosition_company_item_location_key")
  @@index([companyId, locationId])
}

/// v1 material planning & procurement models

enum MaterialRequirementStatus {
  PLANNED
  DUE_SOON
  LATE
  ORDERED
  RECEIVED
  CANCELED
}

enum PurchaseOrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELED
}

// BEGIN WIP: Procurement models temporarily disabled for production build
// model SupplierItem {
//   id                String   @id @default(cuid())
//   companyId         String
//   supplierCompanyId String
//   assetId           String
//
//   /// Lead time assumptions in calendar or working days (interpreted by app logic).
//   avgLeadTimeDays Int?
//   p80LeadTimeDays Int?
//   p95LeadTimeDays Int?
//   shippingDays    Int?
//   internalBufferDays Int?
//
//   minOrderQty Decimal? @db.Decimal(18, 4)
//   notes       String?
//
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
//
//   company         Company @relation("SupplierItemTenantCompany", fields: [companyId], references: [id])
//   supplierCompany Company @relation("SupplierItemSupplierCompany", fields: [supplierCompanyId], references: [id])
//   asset           Asset   @relation(fields: [assetId], references: [id])
//
//   materialRequirements MaterialRequirement[]
//
//   @@unique([companyId, supplierCompanyId, assetId], name: "SupplierItem_company_supplier_asset_key")
//   @@index([companyId, supplierCompanyId], map: "SupplierItem_company_supplier_idx")
// }
//
// model MaterialRequirement {
//   id        String   @id @default(cuid())
//   companyId String
//   projectId String
//   sowItemId String?
//   assetId   String
//   supplierItemId String?
//
//   plannedQty     Decimal @db.Decimal(18, 4)
//   netQtyToOrder  Decimal @db.Decimal(18, 4)
//   requiredOnSiteDate DateTime?
//   dateToOrder        DateTime?
//
//   leadTimeDays  Int?
//   totalLeadDays Int?
//
//   status   MaterialRequirementStatus @default(PLANNED)
//   metadata Json?
//
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
//
//   company Company @relation(fields: [companyId], references: [id])
//   project Project @relation(fields: [projectId], references: [id])
//   sowItem SowItem? @relation(fields: [sowItemId], references: [id])
//   asset   Asset   @relation(fields: [assetId], references: [id])
//   supplierItem SupplierItem? @relation(fields: [supplierItemId], references: [id])
//
//   purchaseOrderLines PurchaseOrderLine[]
//
//   @@index([companyId, projectId], map: "MaterialRequirement_company_project_idx")
//   @@index([projectId, requiredOnSiteDate], map: "MaterialRequirement_project_required_date_idx")
//   @@index([projectId, dateToOrder], map: "MaterialRequirement_project_order_date_idx")
// }
//
// model PurchaseOrder {
//   id        String   @id @default(cuid())
//   companyId String
//   projectId String?
//
//   supplierCompanyId String
//
//   status PurchaseOrderStatus @default(DRAFT)
//
//   orderDate            DateTime?
//   expectedDeliveryDate DateTime?
//
//   notes          String?
//   createdByUserId String?
//
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
//
//   company         Company @relation(fields: [companyId], references: [id])
//   project         Project? @relation(fields: [projectId], references: [id])
//   supplierCompany Company  @relation("PurchaseOrderSupplierCompany", fields: [supplierCompanyId], references: [id])
//   createdBy       User?    @relation(fields: [createdByUserId], references: [id])
//
//   lines PurchaseOrderLine[]
//
//   @@index([companyId, projectId], map: "PurchaseOrder_company_project_idx")
//   @@index([companyId, supplierCompanyId], map: "PurchaseOrder_company_supplier_idx")
// }
//
// model PurchaseOrderLine {
//   id              String   @id @default(cuid())
//   purchaseOrderId String
//   materialRequirementId String?
//   assetId         String
//
//   quantity  Decimal @db.Decimal(18, 4)
//   unitPrice Decimal @db.Decimal(14, 2)
//
//   requiredOnSiteDate DateTime?
//   notes              String?
//
//   createdAt DateTime @default(now)
//   updatedAt DateTime @updatedAt
//
//   purchaseOrder      PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id])
//   materialRequirement MaterialRequirement? @relation(fields: [materialRequirementId], references: [id])
//   asset              Asset              @relation(fields: [assetId], references: [id])
//
//   @@index([purchaseOrderId], map: "PurchaseOrderLine_po_idx")
//   @@index([materialRequirementId], map: "PurchaseOrderLine_requirement_idx")
// }
// END WIP: Procurement models

/// Simple test model used to validate migration pipelines.
/// Safe to keep or drop; not referenced by application code.
model DevMigrationTest {
  id        String   @id @default(cuid())
  note      String?
  createdAt DateTime @default(now())
}

/// Snapshot of a state-level occupational wage table (e.g. BLS OES export)
/// for a given state, year, and source. Used as the Golden "comp by state"
/// reference for market wages.
model StateOccupationalWageSnapshot {
  id        String   @id @default(cuid())
  stateCode String // e.g. "AZ", "NM"
  year      Int // e.g. 2024
  source    String   @default("BLS_OES")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wages StateOccupationalWage[]

  @@unique([stateCode, year, source], name: "StateOccWageSnapshot_state_year_source_key")
}

/// Single occupational wage record within a state snapshot (SOC code row).
model StateOccupationalWage {
  id                    String @id @default(cuid())
  snapshotId            String
  socCode               String // e.g. "47-2031"
  occupationName        String // e.g. "Carpenters"
  employment            Int?
  hourlyMean            Float?
  annualMean            Float?
  hourlyP10             Float?
  hourlyP25             Float?
  hourlyMedian          Float?
  hourlyP75             Float?
  hourlyP90             Float?
  annualP10             Float?
  annualP25             Float?
  annualMedian          Float?
  annualP75             Float?
  annualP90             Float?
  employmentPerThousand Float?
  locationQuotient      Float?

  snapshot StateOccupationalWageSnapshot @relation(fields: [snapshotId], references: [id])

  @@index([snapshotId, socCode], map: "StateOccWage_snapshot_soc_idx")
}

/// Mapping from Nexus/CP classifications (cpRole, workerClassCode) to SOC
/// occupation codes, so we can compare internal & CP comp against state
/// occupational wage tables.
model CompensationClassificationMapping {
  id              String   @id @default(cuid())
  cpRole          String?
  workerClassCode String?
  socCode         String
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cpRole, workerClassCode, socCode], name: "CompClass_unique_triplet")
  @@index([cpRole], map: "CompClass_cpRole_idx")
  @@index([workerClassCode], map: "CompClass_workerClass_idx")
  @@index([socCode], map: "CompClass_socCode_idx")
}

model NexNetCandidate {
  id                       String                   @id @default(cuid())
  userId                   String?                  @unique
  companyId                String? // owning company/tenant for this candidate profile
  firstName                String?
  lastName                 String?
  email                    String?
  phone                    String?
  source                   NexNetSource             @default(REFERRAL)
  status                   NexNetStatus             @default(NOT_STARTED)
  visibilityScope          CandidateVisibilityScope @default(TENANT_ONLY)
  isHiddenFromDefaultViews Boolean                  @default(false)
  isDeletedSoft            Boolean                  @default(false)
  deletedAt                DateTime?
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt

  user               User?      @relation(fields: [userId], references: [id])
  // companyId is a soft foreign key to Company.id; relation omitted for now.
  referralsAsReferee Referral[] @relation("RefereeCandidate")
}

model Referral {
  id                         String         @id @default(cuid())
  referrerUserId             String
  prospectName               String?
  prospectEmail              String?
  prospectPhone              String?
  token                      String         @unique
  candidateId                String?
  refereeUserId              String?
  referralConfirmedByReferee Boolean        @default(false)
  referralConfirmedAt        DateTime?
  referralRejectedByReferee  Boolean        @default(false)
  status                     ReferralStatus @default(INVITED)
  referralStartDate          DateTime?
  referralEndDate            DateTime?
  incentiveRate              Float?
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt

  // Optional linkage back to a personal contact when the referral was
  // initiated from the user's confidential address book.
  personalContactId String?

  referrer        User             @relation("ReferralsSent", fields: [referrerUserId], references: [id])
  referee         User?            @relation("ReferralsReceived", fields: [refereeUserId], references: [id])
  candidate       NexNetCandidate? @relation("RefereeCandidate", fields: [candidateId], references: [id])
  personalContact PersonalContact? @relation(fields: [personalContactId], references: [id])
}

enum NexNetSource {
  REFERRAL
  PUBLIC_APPLY
  MIGRATED
  IMPORTED
}

enum NexNetStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  HIRED
  REJECTED
  TEST
}

enum ReferralStatus {
  INVITED
  CONFIRMED
  REJECTED
  APPLIED
  HIRED
  EXPIRED
}

enum ReferralRelationshipType {
  PERSONAL
  COMPANY
}

model ReferralRelationship {
  id              String                   @id @default(cuid())
  referrerUserId  String
  refereeUserId   String
  companyId       String?
  type            ReferralRelationshipType
  referralId      String?
  companyInviteId String?
  createdAt       DateTime                 @default(now())

  referrer User     @relation("ReferralRelationshipReferrer", fields: [referrerUserId], references: [id])
  referee  User     @relation("ReferralRelationshipReferee", fields: [refereeUserId], references: [id])
  company  Company? @relation(fields: [companyId], references: [id])

  @@index([referrerUserId], map: "ReferralRel_referrer_idx")
  @@index([refereeUserId], map: "ReferralRel_referee_idx")
  @@index([companyId], map: "ReferralRel_company_idx")
}

/// Visibility scope for candidates in the Nex-Net / Prospective Candidates pool.
enum CandidateVisibilityScope {
  TENANT_ONLY
  GLOBAL_POOL
  PRIVATE_TEST
}

/// Source system for a personal contact record.
enum PersonalContactSource {
  UPLOAD
  WINDOWS
  MACOS
  IOS
  ANDROID
}

/// Domain entity a personal contact is linked to (e.g. candidate/worker card).
enum PersonalContactSubjectType {
  CANDIDATE
  WORKER
}

/// Global, confidential contact belonging to a single user profile (not tenant-scoped).
model PersonalContact {
  id          String                @id @default(cuid())
  ownerUserId String
  displayName String?
  firstName   String?
  lastName    String?
  email       String? // Primary email (used for invites)
  phone       String? // Primary phone (used for invites)
  allEmails   Json? // Array of all email addresses from device
  allPhones   Json? // Array of all phone numbers from device
  source      PersonalContactSource @default(UPLOAD)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  owner     User                  @relation(fields: [ownerUserId], references: [id])
  links     PersonalContactLink[]
  referrals Referral[]

  @@index([ownerUserId, email], map: "PersonalContact_owner_email_idx")
  @@index([ownerUserId, phone], map: "PersonalContact_owner_phone_idx")
}

/// Link from a personal contact to a candidate/worker in the domain model so
/// the owner can see "you know this person" on those cards.
model PersonalContactLink {
  id                String                     @id @default(cuid())
  personalContactId String
  subjectType       PersonalContactSubjectType
  subjectId         String
  tenantId          String?
  note              String?
  createdAt         DateTime                   @default(now())

  personalContact PersonalContact @relation(fields: [personalContactId], references: [id])

  @@index([personalContactId], map: "PersonalContactLink_contact_idx")
  @@index([subjectType, subjectId], map: "PersonalContactLink_subject_idx")
}

/// Status of a candidate training assignment.
enum CandidateTrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

/// Outcome of an individual training attempt.
enum CandidateTrainingAttemptStatus {
  PASSED
  FAILED
  ABANDONED
}

/// Status of a candidate certification / license.
enum CandidateCertificationStatus {
  PENDING_VERIFICATION
  VALID
  EXPIRED
  REVOKED
}

/// Status of cross-tenant interest in a candidate.
enum CandidateInterestStatus {
  REQUESTED
  APPROVED
  DECLINED
  HIRED
}

/// Catalog of training modules that can be assigned to Nex-Net candidates.
model TrainingModule {
  id                String   @id @default(cuid())
  companyId         String? // owning company/tenant, null = global module
  code              String
  title             String
  description       String?
  type              String // e.g. "ONLINE_COURSE", "DOCUMENT", "IN_PERSON"
  durationMinutes   Int?
  isActive          Boolean  @default(true)
  isRequiredDefault Boolean  @default(false)
  externalLmsId     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Note: companyId is a soft foreign key to Company.id; we intentionally
  // omit a Prisma @relation here to keep the schema simple while iterating.

  @@unique([companyId, code], name: "TrainingModule_company_code_key")
}

/// Catalog of certification / license types that candidates can hold.
model CertificationType {
  id                    String   @id @default(cuid())
  companyId             String? // owning company/tenant, null = global (e.g. state RN license)
  code                  String
  name                  String
  description           String?
  issuingAuthority      String?
  defaultValidityMonths Int?
  isActive              Boolean  @default(true)
  isRequiredDefault     Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  /// Optional HTML template used when rendering certificates of this type.
  /// Managed by Nexus System Admins via the certifications UI.
  certificateTemplateHtml String?

  // Note: companyId is a soft foreign key to Company.id; no Prisma @relation
  // is declared here to avoid additional back-relations while iterating.

  @@unique([companyId, code], name: "CertificationType_company_code_key")
}

/// Assignment of a training module to a specific Nex-Net candidate.
model CandidateTrainingAssignment {
  id               String   @id @default(cuid())
  candidateId      String
  trainingModuleId String
  assignedByUserId String?
  assignedAt       DateTime @default(now())

  status      CandidateTrainingStatus @default(NOT_STARTED)
  startedAt   DateTime?
  completedAt DateTime?
  expiresAt   DateTime?
  score       Float?
  attempts    Int                     @default(0)
  isRequired  Boolean                 @default(true)
  notes       String?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  // Scalar foreign keys only; relations are enforced at the application layer.

  @@index([candidateId], map: "CandidateTrainingAssignment_candidate_idx")
  @@index([trainingModuleId], map: "CandidateTrainingAssignment_training_idx")
}

/// Individual attempt record for a candidate's training assignment.
model CandidateTrainingAttempt {
  id           String                         @id @default(cuid())
  assignmentId String
  startedAt    DateTime                       @default(now())
  finishedAt   DateTime?
  status       CandidateTrainingAttemptStatus
  score        Float?
  metadata     Json?
  createdAt    DateTime                       @default(now())

  // assignmentId is a soft foreign key to CandidateTrainingAssignment.id

  @@index([assignmentId], map: "CandidateTrainingAttempt_assignment_idx")
}

/// Instance of a certification / license held by a Nex-Net candidate.
model CandidateCertification {
  id                  String                       @id @default(cuid())
  candidateId         String
  certificationTypeId String
  licenseNumber       String?
  issuedBy            String?
  issuedAt            DateTime?
  effectiveAt         DateTime?
  expiresAt           DateTime?
  status              CandidateCertificationStatus @default(PENDING_VERIFICATION)
  verifiedByUserId    String?
  verifiedAt          DateTime?
  verificationNotes   String?
  createdAt           DateTime                     @default(now())
  updatedAt           DateTime                     @updatedAt

  // candidateId and certificationTypeId are soft foreign keys.

  @@index([candidateId], map: "CandidateCertification_candidate_idx")
  @@index([certificationTypeId], map: "CandidateCertification_type_idx")
}

/// Supporting documents for a candidate certification (e.g. PDF license).
model CandidateCertificationDocument {
  id                       String   @id @default(cuid())
  candidateCertificationId String
  storageUrl               String
  fileName                 String
  mimeType                 String
  sizeBytes                Int?
  uploadedByUserId         String?
  uploadedAt               DateTime @default(now())
  description              String?

  // candidateCertificationId is a soft foreign key to CandidateCertification.id

  @@index([candidateCertificationId], map: "CandidateCertDocument_cert_idx")
}

/// Anonymized, marketplace-facing profile for a Nex-Net candidate.
model CandidateMarketProfile {
  candidateId        String   @id
  publicId           String   @unique
  headline           String?
  skillsSummary      String?
  credentialsSummary String?
  locationRegion     String?
  ratingNumeric      Float?
  ratingLabel        String?
  rateMin            Float?
  rateMax            Float?
  updatedAt          DateTime @default(now()) @updatedAt
}

/// Controls which companies/tenants can see a given candidate in the pool.
model CandidatePoolVisibility {
  id                 String   @id @default(cuid())
  candidateId        String
  visibleToCompanyId String? // null = visible to all subscribers in marketplace
  isAllowed          Boolean  @default(true)
  createdAt          DateTime @default(now())
  createdByUserId    String

  // Scalar foreign keys only; relations to NexNetCandidate, User, Company
  // are enforced at the application layer.

  @@index([candidateId], map: "CandidatePoolVisibility_candidate_idx")
  @@index([visibleToCompanyId], map: "CandidatePoolVisibility_visible_company_idx")
}

/// Interest expressed by another company/tenant in a candidate.
model CandidateInterest {
  id                  String                  @id @default(cuid())
  candidateId         String
  requestingCompanyId String
  status              CandidateInterestStatus @default(REQUESTED)
  notes               String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  handledByUserId     String?

  /// Optional employment window for this (candidate, company) interest when it
  /// represents an actual assignment or hire.
  employmentStartDate DateTime?
  employmentEndDate   DateTime?

  /// Snapshot of pay information at the time this interest transitioned to a
  /// HIRED/active assignment. These are best-effort fields populated from HR
  /// portfolio and/or Worker compensation and are not intended to be a full
  /// payroll ledger.
  baseHourlyRate     Float?
  dayRate            Float?
  cpHourlyRate       Float?
  cpFringeHourlyRate Float?

  // Scalar foreign keys only; relations to NexNetCandidate, Company, User
  // are enforced at the application layer.

  @@index([candidateId], map: "CandidateInterest_candidate_idx")
  @@index([requestingCompanyId], map: "CandidateInterest_requesting_company_idx")
}

// =============================================================================
// PnP (Policy & Procedure) Library
// =============================================================================

/// Category for PnP documents
enum PnpCategory {
  SAFETY
  HR
  OPERATIONS
  COMPLIANCE
  QUALITY
  INSURANCE
  GENERAL
}

/// Review status for tenant PnP documents
enum PnpReviewStatus {
  PENDING_REVIEW // Seeded, not yet reviewed by tenant admin
  APPROVED // Tenant admin approved as-is
  MODIFIED_APPROVED // Tenant modified and approved their version
  REJECTED // Tenant rejected (won't use this policy)
}

/// System-level PnP library document (NEXUS-owned master copy)
model PnpDocument {
  id               String      @id @default(cuid())
  code             String      @unique // e.g. "SAFETY-001", "HR-ONBOARD-001"
  title            String
  category         PnpCategory
  description      String?
  active           Boolean     @default(true)
  sortOrder        Int         @default(0)
  currentVersionId String?     @unique
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  currentVersion PnpDocumentVersion?  @relation("PnpDocCurrentVersion", fields: [currentVersionId], references: [id])
  versions       PnpDocumentVersion[]
  tenantCopies   TenantPnpDocument[]
}

/// Version of a system-level PnP document
model PnpDocumentVersion {
  id              String    @id @default(cuid())
  documentId      String
  versionNo       Int
  versionLabel    String? // e.g. "2024-Q1 Update"
  releaseNotes    String?
  htmlContent     String
  contentHash     String?
  effectiveDate   DateTime?
  createdByUserId String?
  createdAt       DateTime  @default(now())

  document     PnpDocument         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  currentFor   PnpDocument?        @relation("PnpDocCurrentVersion")
  tenantCopies TenantPnpDocument[] @relation("TenantPnpSourceVersion")

  @@unique([documentId, versionNo], name: "PnpDocVersion_doc_version_key")
  @@index([documentId], map: "PnpDocVersion_doc_idx")
}

/// Tenant-level PnP document (seeded from system library or custom-created)
model TenantPnpDocument {
  id               String      @id @default(cuid())
  companyId        String
  code             String
  title            String
  category         PnpCategory
  description      String?
  active           Boolean     @default(true)
  currentVersionId String?     @unique

  // Source tracking (null if tenant-created from scratch)
  sourcePnpDocumentId String?
  sourceVersionId     String?

  // Fork status  becomes true when tenant modifies seeded content
  isFork         Boolean   @default(false)
  forkedAt       DateTime?
  forkedByUserId String?

  // Approval workflow
  reviewStatus     PnpReviewStatus @default(PENDING_REVIEW)
  reviewedByUserId String?
  reviewedAt       DateTime?
  reviewNotes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company           Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sourcePnpDocument PnpDocument?               @relation(fields: [sourcePnpDocumentId], references: [id], onDelete: SetNull)
  sourceVersion     PnpDocumentVersion?        @relation("TenantPnpSourceVersion", fields: [sourceVersionId], references: [id], onDelete: SetNull)
  currentVersion    TenantPnpDocumentVersion?  @relation("TenantPnpDocCurrentVersion", fields: [currentVersionId], references: [id])
  versions          TenantPnpDocumentVersion[]

  @@unique([companyId, code], name: "TenantPnpDocument_company_code_key")
  @@index([companyId, category], map: "TenantPnpDocument_company_category_idx")
  @@index([companyId, reviewStatus], map: "TenantPnpDocument_company_status_idx")
  @@index([sourcePnpDocumentId], map: "TenantPnpDocument_source_idx")
}

/// Version of a tenant-level PnP document
model TenantPnpDocumentVersion {
  id           String  @id @default(cuid())
  documentId   String
  versionNo    Int
  versionLabel String?
  notes        String?
  htmlContent  String
  contentHash  String?

  // Disclaimer is auto-generated based on reviewStatus when rendering
  disclaimerHtml String?

  createdByUserId String?
  createdAt       DateTime @default(now())

  document   TenantPnpDocument  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  currentFor TenantPnpDocument? @relation("TenantPnpDocCurrentVersion")

  @@unique([documentId, versionNo], name: "TenantPnpDocVersion_doc_version_key")
  @@index([documentId], map: "TenantPnpDocVersion_doc_idx")
}

// =============================================================================
// Document Import System (Staging & Archive)
// =============================================================================

/// Status of a document scan job
enum DocumentScanJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

/// Status of a staged document
enum StagedDocumentStatus {
  ACTIVE // Unpublished eDocs - available for editing/tagging
  ARCHIVED // Soft-deleted, not visible to regular users
  PUBLISHED // Published and available organization-wide
}

/// Status of HTML conversion for a staged document
enum HtmlConversionStatus {
  PENDING
  CONVERTING
  COMPLETED
  FAILED
  SKIPPED // For unsupported file types
}

/// AI-guessed document type based on filename and content analysis
enum DocumentTypeGuess {
  LIKELY_PROCEDURE // Steps, numbered lists, SOP indicators
  LIKELY_POLICY // Policy/compliance language
  LIKELY_FORM // Forms, templates, checklists
  REFERENCE_DOC // General reference material
  UNLIKELY_PROCEDURE // Plain paragraphs, no structure
  UNKNOWN // Unable to classify
}

/// Job record for scanning external file systems for documents
model DocumentScanJob {
  id                 String                @id @default(cuid())
  companyId          String
  scanPath           String // Root path being scanned
  status             DocumentScanJobStatus @default(PENDING)
  documentsFound     Int                   @default(0)
  documentsProcessed Int                   @default(0)
  errorMessage       String?
  startedAt          DateTime?
  completedAt        DateTime?
  createdByUserId    String
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy       User             @relation(fields: [createdByUserId], references: [id])
  stagedDocuments StagedDocument[]

  @@index([companyId, status], map: "DocumentScanJob_company_status_idx")
  @@index([createdByUserId], map: "DocumentScanJob_user_idx")
}

/// Staged document discovered during a scan, awaiting import decision
model StagedDocument {
  id                 String               @id @default(cuid())
  companyId          String
  scanJobId          String
  fileName           String
  filePath           String // Full path to the file
  breadcrumb         String[] // Path segments for display
  fileType           String // Extension (pdf, docx, etc.)
  fileSize           BigInt // Size in bytes
  mimeType           String?
  thumbnailUrl       String?
  status             StagedDocumentStatus @default(ACTIVE)
  scannedAt          DateTime             @default(now())
  scannedByUserId    String
  archivedAt         DateTime?
  archivedByUserId   String?
  importedAt         DateTime?
  importedByUserId   String?
  importedToType     String? // e.g. "safety", "bkm"
  importedToCategory String? // e.g. "ppe", "general-safety", "hazard-communication"
  displayTitle       String? // Override title for display (vs fileName)
  displayDescription String? // Description shown in document listings
  oshaReference      String? // OSHA CFR reference if applicable
  sortOrder          Int? // Custom sort order within category
  metadata           Json? // Additional file metadata

  // Tagging for filtering and categorization
  tags        String[] // User-defined tags for filtering
  category    String? // Primary category (e.g., "Safety", "HR", "Operations")
  subcategory String? // Subcategory for finer organization

  // Revision control
  revisionNumber  Int       @default(1) // Current revision number
  revisionDate    DateTime? // Date of current revision
  revisionNotes   String? // Notes about what changed in this revision
  revisionHistory Json? // JSON array of previous revision info

  // Document classification (AI-guessed)
  documentTypeGuess    DocumentTypeGuess? // Auto-classified document type
  classificationScore  Float? // Confidence score (0-1)
  classificationReason String? // Why it was classified this way

  // Publishing workflow
  publishedAt       DateTime? // When document was published
  publishedByUserId String? // Who published it

  // Text extraction (for search and classification)
  textContent  String? @db.Text // Extracted plain text for search/classification
  originalPath String? // Original path where file lives (source of truth)

  // HTML conversion fields
  htmlContent      String?               @db.Text // Converted HTML content
  conversionStatus HtmlConversionStatus? // Status of HTML conversion
  conversionError  String? // Error message if conversion failed
  convertedAt      DateTime? // When conversion completed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company     Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  scanJob     DocumentScanJob @relation(fields: [scanJobId], references: [id], onDelete: Cascade)
  scannedBy   User            @relation("StagedDocumentScannedBy", fields: [scannedByUserId], references: [id])
  archivedBy  User?           @relation("StagedDocumentArchivedBy", fields: [archivedByUserId], references: [id])
  importedBy  User?           @relation("StagedDocumentImportedBy", fields: [importedByUserId], references: [id])
  publishedBy User?           @relation("StagedDocumentPublishedBy", fields: [publishedByUserId], references: [id])

  @@index([companyId, status], map: "StagedDocument_company_status_idx")
  @@index([scanJobId], map: "StagedDocument_job_idx")
  @@index([companyId, fileType], map: "StagedDocument_company_type_idx")
  @@index([companyId, importedToType, importedToCategory], map: "StagedDocument_imported_idx")
  @@index([companyId, category], map: "StagedDocument_company_category_idx")
}

// =============================================================================
// Claim Journal System (Carrier Negotiation Tracking)
// =============================================================================

/// Entry type for claim journal entries
enum ClaimJournalEntryType {
  SUBMISSION // Submitted claim/supplement to carrier
  RESPONSE // Received response from carrier
  CALL // Phone call with carrier
  EMAIL // Email correspondence
  MEETING // In-person or video meeting
  NOTE // Internal note (not shared with carrier)
  APPROVAL // Carrier approved item(s)
  DENIAL // Carrier denied item(s)
  PARTIAL_APPROVAL // Carrier partially approved
}

/// Direction of communication for journal entries
enum ClaimJournalDirection {
  INBOUND // From carrier to us
  OUTBOUND // From us to carrier
  INTERNAL // Internal note, not external communication
}

/// Carrier contacts - company-wide registry of adjusters, supervisors, etc.
model CarrierContact {
  id        String @id @default(cuid())
  companyId String

  carrierName String // "State Farm", "Allstate", "Citizens"
  contactName String // "John Smith"
  role        String? // "Field Adjuster", "Desk Adjuster", "Supervisor"
  email       String?
  phone       String?
  notes       String? @db.Text

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company        Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalEntries ClaimJournalEntry[]

  @@index([companyId], map: "CarrierContact_company_idx")
  @@index([companyId, carrierName], map: "CarrierContact_company_carrier_idx")
  @@index([companyId, isActive], map: "CarrierContact_company_active_idx")
}

/// Claim journal entries - append-only audit trail for carrier negotiations
model ClaimJournalEntry {
  id        String @id @default(cuid())
  projectId String

  // Entry classification
  entryType ClaimJournalEntryType
  direction ClaimJournalDirection

  // Who was involved (linked contact OR freeform for one-offs)
  carrierContactId  String?
  actorNameOverride String? // Freeform name if contact not in system
  actorOrgOverride  String? // Freeform carrier name if not using contact

  // When the event actually happened (vs createdAt which is when logged)
  occurredAt DateTime

  // Content (immutable after creation - corrections via new entry)
  summary String // One-line headline
  details String? @db.Text // Full notes, supports markdown

  // Amounts involved (optional)
  amountDisputed Decimal? @db.Decimal(12, 2)
  amountApproved Decimal? @db.Decimal(12, 2)
  amountDenied   Decimal? @db.Decimal(12, 2)

  // Tags for filtering (stored as array)
  tags String[] // e.g., ["supplement-1", "roofing", "depreciation"]

  // Audit trail
  createdAt   DateTime @default(now())
  createdById String

  // Corrections: if entry needs fixing, create new entry that references original
  // Original entry stays visible with "corrected" indicator
  correctsEntryId String? @unique

  // Relations
  project        Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  carrierContact CarrierContact?          @relation(fields: [carrierContactId], references: [id])
  createdBy      User                     @relation("ClaimJournalEntryCreatedBy", fields: [createdById], references: [id])
  correctsEntry  ClaimJournalEntry?       @relation("ClaimJournalCorrections", fields: [correctsEntryId], references: [id])
  correctedBy    ClaimJournalEntry?       @relation("ClaimJournalCorrections")
  attachments    ClaimJournalAttachment[]

  @@index([projectId], map: "ClaimJournalEntry_project_idx")
  @@index([projectId, occurredAt], map: "ClaimJournalEntry_project_occurred_idx")
  @@index([projectId, entryType], map: "ClaimJournalEntry_project_type_idx")
  @@index([carrierContactId], map: "ClaimJournalEntry_contact_idx")
  @@index([createdById], map: "ClaimJournalEntry_creator_idx")
}

/// Attachments for claim journal entries (proof, documentation)
model ClaimJournalAttachment {
  id             String @id @default(cuid())
  journalEntryId String

  fileName   String
  fileType   String? // MIME type
  fileSize   Int? // Size in bytes
  storageKey String // S3/storage key
  storageUrl String? // Public/signed URL if applicable

  uploadedAt   DateTime @default(now())
  uploadedById String

  journalEntry ClaimJournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  uploadedBy   User              @relation("ClaimJournalAttachmentUploadedBy", fields: [uploadedById], references: [id])

  @@index([journalEntryId], map: "ClaimJournalAttachment_entry_idx")
  @@index([uploadedById], map: "ClaimJournalAttachment_uploader_idx")
}
