"use client";

import * as React from "react";
import {
  Fragment,
  useCallback,
  useEffect,
  useMemo,
  useRef,
  useState,
  useTransition,
} from "react";
import { createPortal } from "react-dom";
import { useRouter, useSearchParams } from "next/navigation";
import { useBusyOverlay } from "../../busy-overlay-context";
import { uploadImageFileToNexusUploads } from "../../lib/uploads";
import {
  CostBookPickerModal,
  type CostBookSelection,
} from "../../components/cost-book-picker-modal";
import ProjectFilePicker, { type ProjectFileSummary } from "../../messaging/project-file-picker";
import { AdminPetlTools } from "./admin-petl-tools";
import { PetlVirtualizedTable } from "./petl-virtualized-table";
import { InvoicePetlVirtualizedTable } from "./invoice-petl-virtualized-table";
import { InvoicePetlFlatVirtualizedTable } from "./invoice-petl-flat-virtualized";
import { useDraggable } from "../../hooks/use-draggable";
import { JournalTab } from "./journal";
import { RoleVisible } from "../../role-audit";
import { FileDropZone } from "../../components/file-drop-zone";
import { ScheduleSection, makeMermaidSafeId, scheduleExtractGroupCode, MermaidGantt } from "./schedule-section";
import { DescriptionPicker } from "../../components/DescriptionPicker";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

/**
 * Compute SHA-256 hash
 * Returns hex string.
 */
async function computeFileHash(file: File | Blob): Promise<string> {
  const buffer = await file.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
}

/**
 * Simple text summarizer - extracts first sentence or key phrase for title.
 * Used to auto-generate daily log titles from note content.
 */
function summarizeToTitle(text: string, maxLength = 60): string {
  if (!text || !text.trim()) return "";
  
  // Clean up the text
  let cleaned = text.trim();
  
  // Try to get first sentence
  const sentenceMatch = cleaned.match(/^[^.!?\n]+[.!?]?/);
  if (sentenceMatch) {
    cleaned = sentenceMatch[0].trim();
  }
  
  // Remove common filler words at start
  cleaned = cleaned.replace(/^(today |we |i |the team |crew |worked on |completed |finished |started )/i, "");
  
  // Capitalize first letter
  cleaned = cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
  
  // Truncate if too long
  if (cleaned.length > maxLength) {
    cleaned = cleaned.substring(0, maxLength - 3).trim() + "...";
  }
  
  // Remove trailing period if present
  cleaned = cleaned.replace(/\.$/, "");
  
  return cleaned;
}

type CheckboxMultiSelectOption = { value: string; label: string };

function CheckboxMultiSelect(props: {
  placeholder: string;
  options: CheckboxMultiSelectOption[];
  selectedValues: string[];
  onChangeSelectedValues: (next: string[]) => void;
  minWidth?: number;
  // Optional minimum height for the scroll area; actual height will expand to the
  // bottom of the viewport when opened.
  minListHeight?: number;
}) {
  const {
    placeholder,
    options,
    selectedValues,
    onChangeSelectedValues,
    minWidth = 140,
    minListHeight = 180,
  } = props;

  const [open, setOpen] = useState(false);
  const [panelMaxHeight, setPanelMaxHeight] = useState<number>(320);
  const rootRef = useRef<HTMLDivElement | null>(null);

  useEffect(() => {
    if (!open) return;

    const computeMaxHeight = () => {
      const el = rootRef.current;
      if (!el) return;
      const rect = el.getBoundingClientRect();
      // Leave a little breathing room so we don't touch the bottom edge.
      const available = Math.floor(window.innerHeight - rect.bottom - 12);
      setPanelMaxHeight(Math.max(180, available));
    };

    computeMaxHeight();

    const onPointerDown = (e: MouseEvent) => {
      const target = e.target as Node | null;
      if (!target) return;
      if (rootRef.current && !rootRef.current.contains(target)) {
        setOpen(false);
      }
    };

    window.addEventListener("pointerdown", onPointerDown);
    window.addEventListener("resize", computeMaxHeight);
    window.addEventListener("scroll", computeMaxHeight, true);

    return () => {
      window.removeEventListener("pointerdown", onPointerDown);
      window.removeEventListener("resize", computeMaxHeight);
      window.removeEventListener("scroll", computeMaxHeight, true);
    };
  }, [open]);

  const selectedSet = useMemo(() => new Set(selectedValues), [selectedValues]);

  const buttonLabel = useMemo(() => {
    if (selectedValues.length === 0) return placeholder;
    if (selectedValues.length === 1) {
      const only = selectedValues[0];
      const match = options.find((o) => o.value === only);
      return match?.label ?? only;
    }
    return `${selectedValues.length} selected`;
  }, [options, placeholder, selectedValues]);

  const toggleValue = (value: string) => {
    onChangeSelectedValues(
      selectedSet.has(value)
        ? selectedValues.filter((v) => v !== value)
        : [...selectedValues, value],
    );
  };

  return (
    <div ref={rootRef} style={{ position: "relative" }}>
      <button
        type="button"
        onClick={() => setOpen((v) => !v)}
        style={{
          width: minWidth,
          padding: "4px 6px",
          borderRadius: 4,
          border: "1px solid #d1d5db",
          fontSize: 12,
          background: "#ffffff",
          cursor: "pointer",
          textAlign: "left",
          overflow: "hidden",
          textOverflow: "ellipsis",
          whiteSpace: "nowrap",
        }}
      >
        {buttonLabel}
      </button>

      {open && (
        <div
          style={{
            position: "absolute",
            top: "calc(100% + 4px)",
            left: 0,
            minWidth,
            zIndex: 50,
            background: "#ffffff",
            border: "1px solid #d1d5db",
            borderRadius: 8,
            boxShadow: "0 10px 20px rgba(0,0,0,0.10)",
            padding: 8,
            maxHeight: panelMaxHeight,
            overflow: "hidden",
          }}
        >
          <div
            style={{
              display: "flex",
              alignItems: "center",
              justifyContent: "space-between",
              gap: 8,
              marginBottom: 6,
            }}
          >
            <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 12 }}>
              <input
                type="checkbox"
                checked={selectedValues.length === 0}
                onChange={() => onChangeSelectedValues([])}
              />
              <span style={{ fontWeight: 600 }}>All</span>
            </label>
            {selectedValues.length > 0 && (
              <button
                type="button"
                onClick={() => onChangeSelectedValues([])}
                style={{
                  border: "none",
                  background: "transparent",
                  fontSize: 12,
                  color: "#2563eb",
                  cursor: "pointer",
                  padding: 0,
                }}
              >
                Clear
              </button>
            )}
          </div>

          <div
            style={{
              // Expand to the bottom of the viewport, but keep a sensible minimum.
              maxHeight: Math.max(minListHeight, panelMaxHeight - 44),
              overflow: "auto",
            }}
          >
            {options.map((opt) => {
              const checked = selectedSet.has(opt.value);
              return (
                <label
                  key={opt.value}
                  style={{
                    display: "flex",
                    alignItems: "center",
                    gap: 8,
                    padding: "4px 2px",
                    fontSize: 12,
                    cursor: "pointer",
                  }}
                >
                  <input
                    type="checkbox"
                    checked={checked}
                    onChange={() => toggleValue(opt.value)}
                  />
                  <span style={{ whiteSpace: "nowrap" }}>{opt.label}</span>
                </label>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
}

// Client contact section with inline editing and auto-search
interface TenantClientResult {
  id: string;
  firstName: string | null;
  lastName: string | null;
  displayName: string | null;
  email: string | null;
  phone: string | null;
  company: string | null;
}

function ClientContactSection(props: {
  projectId: string;
  name: string | null;
  email: string | null;
  phone: string | null;
  canEdit: boolean;
  onUpdate: (fields: { name?: string | null; email?: string | null; phone?: string | null }) => Promise<void>;
}) {
  const { projectId, name, email, phone, canEdit, onUpdate } = props;
  const [editingField, setEditingField] = useState<"name" | "email" | "phone" | null>(null);
  const [draft, setDraft] = useState({ name: name || "", email: email || "", phone: phone || "" });
  const [saving, setSaving] = useState(false);
  const [searchResults, setSearchResults] = useState<TenantClientResult[]>([]);
  const [searching, setSearching] = useState(false);
  const [showResults, setShowResults] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const searchTimeoutRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    setDraft({ name: name || "", email: email || "", phone: phone || "" });
  }, [name, email, phone]);

  useEffect(() => {
    if (editingField && inputRef.current) {
      inputRef.current.focus();
      inputRef.current.select();
    }
  }, [editingField]);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setShowResults(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const searchClients = async (query: string) => {
    if (query.length < 2) {
      setSearchResults([]);
      setShowResults(false);
      return;
    }
    const token = localStorage.getItem("accessToken");
    if (!token) return;

    setSearching(true);
    try {
      const res = await fetch(`${API_BASE}/clients/search?q=${encodeURIComponent(query)}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (res.ok) {
        const data = await res.json();
        setSearchResults(Array.isArray(data) ? data : []);
        setShowResults(true);
      }
    } catch {
      // ignore
    } finally {
      setSearching(false);
    }
  };

  const handleInputChange = (field: "name" | "email" | "phone", value: string) => {
    setDraft(prev => ({ ...prev, [field]: value }));

    // Debounced search
    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);
    searchTimeoutRef.current = setTimeout(() => {
      searchClients(value);
    }, 300);
  };

  const handleSelectClient = async (client: TenantClientResult) => {
    const newName = client.displayName || [client.firstName, client.lastName].filter(Boolean).join(" ") || null;
    const newEmail = client.email || null;
    const newPhone = client.phone || null;

    setDraft({ name: newName || "", email: newEmail || "", phone: newPhone || "" });
    setShowResults(false);
    setEditingField(null);
    setSearchResults([]);

    // Save all fields
    setSaving(true);
    try {
      await onUpdate({
        name: newName,
        email: newEmail,
        phone: newPhone,
      });
    } finally {
      setSaving(false);
    }
  };

  const handleSave = async (field: "name" | "email" | "phone") => {
    const originalValue = field === "name" ? name : field === "email" ? email : phone;
    if (draft[field] !== (originalValue || "")) {
      setSaving(true);
      try {
        await onUpdate({ [field]: draft[field] || null });
      } finally {
        setSaving(false);
      }
    }
    setEditingField(null);
    setShowResults(false);
    setSearchResults([]);
  };

  const handleKeyDown = (e: React.KeyboardEvent, field: "name" | "email" | "phone") => {
    if (e.key === "Enter") {
      e.preventDefault();
      handleSave(field);
    } else if (e.key === "Escape") {
      setDraft({ name: name || "", email: email || "", phone: phone || "" });
      setEditingField(null);
      setShowResults(false);
      setSearchResults([]);
    }
  };

  const renderField = (field: "name" | "email" | "phone", label: string, linkPrefix?: string) => {
    const value = field === "name" ? name : field === "email" ? email : phone;
    const draftValue = draft[field];
    const isEmpty = !value;
    const isEditing = editingField === field;

    if (isEditing) {
      return (
        <div style={{ position: "relative" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 4, marginTop: 4 }}>
            <span style={{ fontSize: 12, color: "#6b7280", minWidth: 48 }}>{label}:</span>
            <input
              ref={inputRef}
              type="text"
              value={draftValue}
              onChange={(e) => handleInputChange(field, e.target.value)}
              onBlur={() => {
                // Delay to allow click on search result
                setTimeout(() => {
                  if (!showResults) handleSave(field);
                }, 150);
              }}
              onKeyDown={(e) => handleKeyDown(e, field)}
              disabled={saving}
              placeholder={`Search by ${label.toLowerCase()}...`}
              style={{
                flex: 1,
                padding: "2px 4px",
                fontSize: 13,
                border: "1px solid #2563eb",
                borderRadius: 3,
                outline: "none",
              }}
            />
            {searching && <span style={{ fontSize: 10, color: "#9ca3af" }}>...</span>}
          </div>
        </div>
      );
    }

    return (
      <div
        style={{
          display: "flex",
          alignItems: "center",
          gap: 4,
          marginTop: 4,
          cursor: canEdit ? "pointer" : "default",
        }}
        onClick={() => canEdit && setEditingField(field)}
        title={canEdit ? "Click to edit or search" : undefined}
      >
        <span style={{ fontSize: 12, color: "#6b7280", minWidth: 48 }}>{label}:</span>
        {linkPrefix && !isEmpty ? (
          <a
            href={`${linkPrefix}${value}`}
            onClick={(e) => e.stopPropagation()}
            style={{ fontSize: 13, color: "#2563eb", textDecoration: "none" }}
          >
            {value}
          </a>
        ) : (
          <span
            style={{
              fontSize: 13,
              color: isEmpty ? "#9ca3af" : "#111827",
              fontStyle: isEmpty ? "italic" : "normal",
            }}
          >
            {value || `No ${label.toLowerCase()}`}
          </span>
        )}
        {canEdit && <span style={{ fontSize: 11, color: "#9ca3af", marginLeft: 2 }}>✎</span>}
      </div>
    );
  };

  return (
    <div ref={containerRef} style={{ position: "relative" }}>
      {renderField("name", "Name")}
      {renderField("phone", "Phone", "tel:")}
      {renderField("email", "Email", "mailto:")}

      {/* Search results dropdown */}
      {showResults && searchResults.length > 0 && (
        <div
          style={{
            position: "absolute",
            top: "100%",
            left: 0,
            right: 0,
            marginTop: 4,
            background: "#ffffff",
            border: "1px solid #d1d5db",
            borderRadius: 6,
            boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
            zIndex: 100,
            maxHeight: 200,
            overflow: "auto",
          }}
        >
          <div style={{ padding: "4px 8px", fontSize: 10, color: "#6b7280", borderBottom: "1px solid #e5e7eb" }}>
            Select to auto-fill all fields
          </div>
          {searchResults.map((client) => (
            <div
              key={client.id}
              onClick={() => handleSelectClient(client)}
              style={{
                padding: "8px 10px",
                cursor: "pointer",
                borderBottom: "1px solid #f3f4f6",
              }}
              onMouseEnter={(e) => (e.currentTarget.style.backgroundColor = "#f3f4f6")}
              onMouseLeave={(e) => (e.currentTarget.style.backgroundColor = "transparent")}
            >
              <div style={{ fontSize: 13, fontWeight: 500, color: "#111827" }}>
                {client.displayName || [client.firstName, client.lastName].filter(Boolean).join(" ") || "(No name)"}
              </div>
              <div style={{ fontSize: 11, color: "#6b7280", marginTop: 2 }}>
                {[client.email, client.phone, client.company].filter(Boolean).join(" • ")}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

interface Project {
  id: string;
  name: string;
  status: string;
  city: string;
  state: string;
  addressLine1: string;
  addressLine2: string | null;
  createdAt: string;
  // Optional per-project role of the current user (OWNER, ADMIN, PM, VIEWER, etc.)
  userRole?: string;
  // Client contact for invoices & correspondence
  primaryContactName?: string | null;
  primaryContactEmail?: string | null;
  primaryContactPhone?: string | null;
}

interface PetlItem {
  id: string;
  /// Internal PETL line ordering (sequential)
  lineNo: number;
  /// Original line number from the source estimate export (e.g. Xactimate "#")
  sourceLineNo?: number | null;
  description: string | null;
  itemNote?: string | null;
  qty: number | null;
  unit: string | null;
  itemAmount: number | null;
  rcvAmount: number | null;
  percentComplete: number;
  isAcvOnly?: boolean;
  payerType: string;
  categoryCode: string | null;
  selectionCode: string | null;
  activity: string | null;
  projectParticle?: {
    id: string;
    name: string;
    fullLabel: string;
  } | null;
  /// Standalone Change Order fields
  isStandaloneChangeOrder?: boolean;
  coSequenceNo?: number | null;
  coSourceLineNo?: number | null;
}

interface Participant {
  id: string;
  userId: string;
  projectId: string;
  companyId: string;
  role: string;
  scope: "OWNER_MEMBER" | "COLLABORATOR_MEMBER" | "EXTERNAL_CONTACT";
  visibility: "FULL" | "LIMITED" | "READ_ONLY";
  user: {
    id: string;
    email: string;
  };
  company: {
    id: string;
    name: string;
  };
}

interface TagAssignmentDto {
  id: string;
  tagId: string;
  tag: {
    id: string;
    code: string;
    label: string;
    color: string | null;
  };
}

interface SimpleTag {
  id: string;
  code: string;
  label: string;
  color: string | null;
}

interface DailyLogAttachmentDto {
  id: string;
  fileUrl: string;
  fileName: string | null;
  mimeType?: string | null;
  sizeBytes?: number | null;
}

type CompanyRole = "OWNER" | "ADMIN" | "MEMBER" | "CLIENT";
type GlobalRole = "SUPER_ADMIN" | "NONE" | string;

type DailyLogType = "PUDL" | "RECEIPT_EXPENSE" | "JSA" | "INCIDENT" | "QUALITY" | "CUSTOM";

interface DailyLog {
  id: string;
  projectId: string;
  logDate: string;
  title: string | null;
  type?: DailyLogType;
  weatherSummary: string | null;
  crewOnSite: string | null;
  workPerformed: string | null;
  issues: string | null;
  safetyIncidents: string | null;
  manpowerOnsite: string | null;
  personOnsite: string | null;
  confidentialNotes: string | null;
  shareInternal: boolean;
  shareSubs: boolean;
  shareClient: boolean;
  sharePrivate: boolean;
  status?: "SUBMITTED" | "APPROVED" | "REJECTED";
  effectiveShareClient?: boolean;
  // Receipt/expense fields
  expenseVendor?: string | null;
  expenseAmount?: number | null;
  expenseDate?: string | null;
  sourceBillId?: string | null;
  createdAt: string;
  createdByUser?: {
    id: string;
    email: string;
  } | null;
  attachments?: DailyLogAttachmentDto[];
  // Optional PETL context for PUDL
  building?: { id: string; name: string; code: string | null } | null;
  unit?: { id: string; label: string; floor: number | null } | null;
  roomParticle?: { id: string; name: string; fullLabel: string } | null;
  sowItem?: { id: string; code: string | null; description: string | null } | null;
}

interface NewDailyLogState {
  logDate: string;
  title: string;
  tags: string;
  type: DailyLogType;
  weatherSummary: string;
  workPerformed: string;
  crewOnSite: string;
  issues: string;
  safetyIncidents: string;
  manpowerOnsite: string;
  personOnsite: string;
  confidentialNotes: string;
  shareInternal: boolean;
  shareSubs: boolean;
  shareClient: boolean;
  sharePrivate: boolean;
  // Receipt/expense fields (for RECEIPT_EXPENSE type)
  expenseVendor: string;
  expenseAmount: string; // stored as string for input, parsed on submit
  expenseDate: string;
  // Optional PETL context when composing from PETL
  buildingId?: string | null;
  unitId?: string | null;
  roomParticleId?: string | null;
  sowItemId?: string | null;
  // Attachment file IDs to include
  attachmentProjectFileIds?: string[];
  // Metadata for display (parallel array to attachmentProjectFileIds)
  attachmentFiles?: { id: string; fileName: string; mimeType: string | null; storageUrl: string }[];
}

interface RoomComponentAgg {
  code: string;
  description: string | null;
  unit: string | null;
  quantity: number;
  total: number;
  lines: number;
}

interface ImportRoomBucket {
  groupCode: string | null;
  groupDescription: string | null;
  lineCount: number;
  totalAmount: number;
  sampleUnitLocations: string[];
  assignedUnitLabel: string | null;
  assignedUnitId: string | null;
  assignedFullLabel: string | null;
}

interface ImportRoomLine {
  lineNo: number;
  desc: string | null;
  qty: number | null;
  unit: string | null;
  itemAmount: number | null;
  cat: string | null;
  sel: string | null;
  owner: string | null;
  originalVendor: string | null;
  sourceName: string | null;
}

// Scope-only PETL view for PUDL / Daily Logs.
interface FieldPetlItem {
  sowItemId: string;
  lineNo: number;
  roomParticleId: string | null;
  roomName: string | null;
  categoryCode: string | null;
  selectionCode: string | null;
  activity: string | null;
  description: string | null;
  unit: string | null;
  originalQty: number | null;
  qty: number | null;
  qtyFlaggedIncorrect: boolean;
  qtyFieldReported: number | null;
  qtyReviewStatus: string | null;
  orgGroupCode: string | null;
  // Percent comes from main PETL items; we merge it client-side when needed.
  percentComplete?: number;
}

interface FieldPetlEditState {
  item: FieldPetlItem;
  incorrect: boolean;
  fieldQty: string;
  newPercent: string;
  note: string;
  saving: boolean;
  error: string | null;
}

interface FinancialSummary {
  totalRcvClaim: number;
  totalAcvClaim: number;
  workCompleteRcv: number;
  acvReturn: number;
  opRate: number;
  acvOP: number;
  totalDueWorkBillable: number;
  depositRate: number;
  depositBaseline: number;
  billedToDate: number;
  duePayable: number;
  dueAmount: number;
  snapshotComputedAt: string | null;
  snapshotSource: "none" | "snapshot" | "recomputed";
}

interface ProjectEmployee {
  firstName: string | null;
  lastName: string | null;
  employeeId: string | null;
  ssnLast4: string | null;
  classCode: string | null;
  totalHours: number;
  firstWeekEnd: string | null;
  lastWeekEnd: string | null;
  weekCodes?: string[];
}

type TabKey =
  | "SUMMARY"
  | "SCHEDULE"
  | "PETL"
  | "BOM"
  | "STRUCTURE"
  | "DAILY_LOGS"
  | "FILES"
  | "FINANCIAL"
  | "JOURNAL";

type PetlDisplayMode = "PROJECT_GROUPING" | "LINE_SEQUENCE" | "RECONCILIATION_ONLY";

// Logical project state buckets backed by Project.status
// OPEN  -> status "open" (or "active")
// ARCHIVED -> status "archived"
// DELETED  -> status "deleted"
// WARRANTY -> status "warranty"
type ProjectStateChoice = "OPEN" | "ARCHIVED" | "DELETED" | "WARRANTY";

// Memoized component for a single invoice PETL group to prevent re-rendering all groups on expand/collapse
const InvoicePetlGroupRow = React.memo(function InvoicePetlGroupRow({
  group,
  groupIndex,
  isOpen,
  onToggle,
  formatMoney,
  formatBillingTag,
  getInvoiceLineBackground,
  getInvoicePetlEffectiveTag,
  invoicePetlTagEditingLineId,
  invoicePetlTagDraft,
  invoicePetlTagSaving,
  setInvoicePetlTagEditingLineId,
  setInvoicePetlTagDraft,
  saveInvoicePetlTag,
}: {
  group: any;
  groupIndex: number;
  isOpen: boolean;
  onToggle: (key: string) => void;
  formatMoney: (value: any) => string;
  formatBillingTag: (tag: string) => string;
  getInvoiceLineBackground: (li: any) => string;
  getInvoicePetlEffectiveTag: (line: any) => string;
  invoicePetlTagEditingLineId: string | null;
  invoicePetlTagDraft: string;
  invoicePetlTagSaving: boolean;
  setInvoicePetlTagEditingLineId: (id: string | null) => void;
  setInvoicePetlTagDraft: (draft: string) => void;
  saveInvoicePetlTag: () => void;
}) {
  const rawGroupKey = String(group.groupKey ?? group.groupLabel ?? "").trim();
  const groupKey = rawGroupKey || `__group_${groupIndex}`;
  const groupLabel = String(group.groupLabel ?? rawGroupKey).trim() || rawGroupKey || "(Unlabeled)";

  const out: React.ReactNode[] = [];

  out.push(
    <tr
      key={`g-${groupKey}`}
      style={{ background: "#eef2ff", cursor: "pointer" }}
      onClick={() => onToggle(groupKey)}
    >
      <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", fontWeight: 700 }}>
        {isOpen ? "▾ " : "▸ "}
        {groupLabel}
      </td>
      <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right", color: "#4b5563" }}>—</td>
      <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right", color: "#4b5563" }}>—</td>
      <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right", color: "#4b5563" }}>—</td>
      <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right", fontWeight: 700 }}>
        {formatMoney(group.subtotal)}
      </td>
    </tr>
  );

  if (!isOpen) return <>{out}</>;

  const lines = Array.isArray(group.lines) ? group.lines : [];
  for (const li of lines) {
    const isCredit = String(li.kind) === "ACV_HOLDBACK_CREDIT";
    const cat = String(li.categoryCodeSnapshot ?? "").trim();
    const sel = String(li.selectionCodeSnapshot ?? "").trim();
    const task = String(li.descriptionSnapshot ?? "").trim();
    const lineNoValue =
      li.displayLineNo != null && String(li.displayLineNo).trim()
        ? String(li.displayLineNo).trim()
        : li.lineNoSnapshot != null
          ? String(li.lineNoSnapshot)
          : "";

    const label = isCredit
      ? "↳ ACV rebate (80%)"
      : `${lineNoValue}${cat || sel ? ` · ${cat}${sel ? `/${sel}` : ""}` : ""}${task ? ` · ${task}` : ""}`;

    const effectiveTag = getInvoicePetlEffectiveTag(li);
    const tagLabel = formatBillingTag(effectiveTag);
    const canEditTag = !isCredit && !li?.parentLineId;
    const isEditingTag = canEditTag && invoicePetlTagEditingLineId === li.id;
    const rowBg = getInvoiceLineBackground(li);

    out.push(
      <tr key={li.id ?? `${groupKey}-${li.sowItemId}-${li.kind}-${label}`} style={{ background: rowBg }}>
        <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 10 }}>
            <span
              style={{
                paddingLeft: isCredit ? 44 : 36,
                color: isCredit ? "#b91c1c" : "#111827",
                whiteSpace: "nowrap",
                overflow: "hidden",
                textOverflow: "ellipsis",
              }}
              title={label}
            >
              {label}
            </span>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              {tagLabel && !isEditingTag && (
                <span
                  style={{
                    fontSize: 10,
                    fontWeight: 700,
                    padding: "2px 8px",
                    borderRadius: 999,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    color: "#374151",
                    whiteSpace: "nowrap",
                  }}
                >
                  {tagLabel}
                </span>
              )}
              {canEditTag && !isEditingTag && (
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    setInvoicePetlTagEditingLineId(String(li.id));
                    setInvoicePetlTagDraft(String(li?.billingTag ?? "NONE") || "NONE");
                  }}
                  style={{
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    cursor: "pointer",
                    padding: "2px 8px",
                    borderRadius: 999,
                    fontSize: 11,
                    whiteSpace: "nowrap",
                  }}
                >
                  Edit
                </button>
              )}
              {isEditingTag && (
                <>
                  <select
                    value={invoicePetlTagDraft}
                    onChange={(e) => setInvoicePetlTagDraft(e.target.value)}
                    disabled={invoicePetlTagSaving}
                    style={{ fontSize: 11, padding: "2px 4px", borderRadius: 4, border: "1px solid #d1d5db" }}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <option value="NONE">(none)</option>
                    <option value="PETL_LINE_ITEM">PETL Line Item</option>
                    <option value="SUPPLEMENT">Supplement</option>
                    <option value="CHANGE_ORDER">Change Order</option>
                    <option value="WARRANTY">Warranty</option>
                  </select>
                  <button
                    type="button"
                    disabled={invoicePetlTagSaving}
                    onClick={(e) => {
                      e.stopPropagation();
                      saveInvoicePetlTag();
                    }}
                    style={{
                      fontSize: 11,
                      padding: "2px 8px",
                      borderRadius: 4,
                      border: "1px solid #22c55e",
                      background: "#dcfce7",
                      color: "#166534",
                      cursor: "pointer",
                    }}
                  >
                    {invoicePetlTagSaving ? "…" : "Save"}
                  </button>
                  <button
                    type="button"
                    disabled={invoicePetlTagSaving}
                    onClick={(e) => {
                      e.stopPropagation();
                      setInvoicePetlTagEditingLineId(null);
                    }}
                    style={{
                      fontSize: 11,
                      padding: "2px 8px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      background: "#f9fafb",
                      color: "#374151",
                      cursor: "pointer",
                    }}
                  >
                    Cancel
                  </button>
                </>
              )}
            </div>
          </div>
        </td>
        <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
          {li.percentComplete != null ? `${li.percentComplete}%` : "—"}
        </td>
        <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
          {formatMoney(li.earnedToDate)}
        </td>
        <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
          {formatMoney(li.prevBilled)}
        </td>
        <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right", fontWeight: 600 }}>
          {formatMoney(li.thisInvTotal)}
        </td>
      </tr>
    );
  }

  return <>{out}</>;
});

export default function ProjectDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = React.use(params);
  const router = useRouter();
  const busyOverlay = useBusyOverlay();
  const [project, setProject] = useState<Project | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  const [petlItemCount, setPetlItemCount] = useState<number | null>(null);
  const [petlTotalAmount, setPetlTotalAmount] = useState<number | null>(null);
  const [componentsCount, setComponentsCount] = useState<number | null>(null);
  const [petlItems, setPetlItems] = useState<PetlItem[]>([]);
  const [petlReconciliationEntries, setPetlReconciliationEntries] = useState<any[]>([]);
  const [petlLoading, setPetlLoading] = useState(false);
  const [petlEstimateVersionId, setPetlEstimateVersionId] = useState<string | null>(null);

  const [schedulePreview, setSchedulePreview] = useState<any | null>(null);
  const [schedulePreviewLoading, setSchedulePreviewLoading] = useState(false);
  const [schedulePreviewError, setSchedulePreviewError] = useState<string | null>(null);

  // Canonical, persisted schedule tasks (ProjectScheduleTask) bound to project
  // Units/Particles/org groups. These back the "Org structure" schedule
  // source, while the preview continues to reflect the live Xact-driven
  // engine.
  const [schedulePersistedTasks, setSchedulePersistedTasks] = useState<any[] | null>(null);
  const [schedulePersistedLoading, setSchedulePersistedLoading] = useState(false);
  const [schedulePersistedError, setSchedulePersistedError] = useState<string | null>(null);

  // Which schedule source is driving the Gantt. PREVIEW = Xact estimate
  // preview (in-memory). ORG = canonical persisted schedule from
  // ProjectScheduleTask (org-structure bound).
  const [scheduleSource, setScheduleSource] = useState<"PREVIEW" | "ORG">("PREVIEW");

  const [scheduleGroupMode, setScheduleGroupMode] = useState<"ROOM" | "TRADE" | "UNIT">("ROOM");
  // Optional filter to focus the schedule/Gantt on a single Unit (labels as
  // derived from unitGroups / project organization). "ALL" = no filter.
  const [scheduleUnitFilter, setScheduleUnitFilter] = useState<string>("ALL");
  // Optional multi-select filter for top-level org groups (e.g. ELECTRI, RISK__E, WASH_UT).
  const [scheduleOrgGroupFilters, setScheduleOrgGroupFilters] = useState<string[]>([]);
  const [scheduleSummaryExpanded, setScheduleSummaryExpanded] = useState(false);

  // Draft edits (client-side). We turn these into taskOverrides when the user clicks Apply.
  const [scheduleDraftOverrides, setScheduleDraftOverrides] = useState<
    Record<string, { durationDays?: number; startDate?: string; lockType?: "SOFT" | "HARD" }>
  >({});

  // Dependency editor: we store lag days and use it to derive startDate overrides.
  const [scheduleDraftDeps, setScheduleDraftDeps] = useState<
    Record<string, { predecessorId: string; lagDays: number }[]>
  >({});

  const [scheduleOverridesPayload, setScheduleOverridesPayload] = useState<
    Record<string, { durationDays?: number; startDate?: string; lockType?: "SOFT" | "HARD" }> | null
  >(null);

  const [scheduleInlineEditTaskId, setScheduleInlineEditTaskId] = useState<string | null>(null);

  const [scheduleStartDate, setScheduleStartDate] = useState<string>(() => {
    // Default to today; can be overridden in the scheduler preview endpoint.
    return new Date().toISOString().slice(0, 10);
  });

  const isoAddDays = (iso: string, days: number): string => {
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    d.setDate(d.getDate() + days);
    return d.toISOString().slice(0, 10);
  };

  const [scheduleViewPreset, setScheduleViewPreset] = useState<"ALL" | "30D" | "60D" | "90D" | "CUSTOM">(
    "60D",
  );

  const [scheduleZoom, setScheduleZoom] = useState<"AUTO" | "DAY" | "WEEK" | "MONTH">("AUTO");

  const [scheduleViewFrom, setScheduleViewFrom] = useState<string>(() => {
    return new Date().toISOString().slice(0, 10);
  });

  const [scheduleViewTo, setScheduleViewTo] = useState<string>(() => {
    const today = new Date().toISOString().slice(0, 10);
    return isoAddDays(today, 60);
  });

  // Keep the view window synced to the schedule start date when using a preset.
  useEffect(() => {
    if (scheduleViewPreset === "ALL" || scheduleViewPreset === "CUSTOM") return;
    const days = scheduleViewPreset === "30D" ? 30 : scheduleViewPreset === "60D" ? 60 : 90;
    setScheduleViewFrom(scheduleStartDate);
    setScheduleViewTo(isoAddDays(scheduleStartDate, days));
  }, [scheduleStartDate, scheduleViewPreset]);

  const [scheduleReloadTick, setScheduleReloadTick] = useState(0);

  // Reconciliation activity (any reconciliation entry exists for this sowItem)
  const [petlReconActivityIds, setPetlReconActivityIds] = useState<Set<string>>(
    () => new Set(),
  );

  // PETL load diagnostics (helps debug prod issues like 500s / misconfigured API base)
  const [petlLoadError, setPetlLoadError] = useState<string | null>(null);
  const [petlLastLoadDebug, setPetlLastLoadDebug] = useState<any | null>(null);
  const [petlShowDiagnostics, setPetlShowDiagnostics] = useState(false);

  // Increment to force reloads of PETL + groups after reconciliation mutations.
  const [petlReloadTick, setPetlReloadTick] = useState(0);

  const [participants, setParticipants] = useState<
    | {
        myOrganization: Participant[];
        collaborators: Participant[];
      }
    | null
  >(null);

  const [currentCompanyId, setCurrentCompanyId] = useState<string | null>(null);
  const [actorCompanyRole, setActorCompanyRole] = useState<CompanyRole | null>(null);
  const [actorGlobalRole, setActorGlobalRole] = useState<GlobalRole | null>(null);

  const [availableMembers, setAvailableMembers] = useState<
    { userId: string; email: string; role: string }[]
  >([]);
  const [newMemberRole, setNewMemberRole] = useState<"MANAGER" | "VIEWER">("MANAGER");
  const [bulkInternalSelection, setBulkInternalSelection] = useState<string[]>([]);
  const [bulkInternalSaving, setBulkInternalSaving] = useState(false);
  const [bulkInternalMessage, setBulkInternalMessage] = useState<string | null>(null);

  const [inviteEmail, setInviteEmail] = useState("");
  const [invitePassword, setInvitePassword] = useState("");
  const [inviteProjectRole, setInviteProjectRole] = useState<"MANAGER" | "VIEWER">("MANAGER");
  const [inviteSaving, setInviteSaving] = useState(false);
  const [inviteMessage, setInviteMessage] = useState<string | null>(null);

  // Controls which admin action panel (if any) is visible under Participants.
  const [participantAdminMode, setParticipantAdminMode] = useState<
    "none" | "internal" | "invite"
  >("none");

  const [availableTags, setAvailableTags] = useState<SimpleTag[]>([]);
  const [projectTags, setProjectTags] = useState<TagAssignmentDto[]>([]);
  const [tagsSaving, setTagsSaving] = useState(false);
  const [showTagManager, setShowTagManager] = useState(false);
  const [newTagLabel, setNewTagLabel] = useState("");

  // Progress controls state
  const [groupLoading, setGroupLoading] = useState(false);
  const [groups, setGroups] = useState<{
    id: number;
    particleId: string | null;
    roomName: string;
    itemsCount: number;
    totalAmount: number;
    completedAmount: number;
    percentComplete: number;
  }[]>([]);

  const [unitGroups, setUnitGroups] = useState<{
    id: number;
    unitId: string | null;
    unitLabel: string;
    rooms: {
      id: number;
      particleId: string | null;
      roomName: string;
      itemsCount: number;
      totalAmount: number;
      completedAmount: number;
      percentComplete: number;
    }[];
    itemsCount: number;
    totalAmount: number;
    completedAmount: number;
    percentComplete: number;
  }[]>([]);

  // Lightweight "needs reconciliation" flags for PETL lines.
  // For now this is stored in localStorage (per project) so PMs can quickly mark
  // rows that need follow-up (e.g. CO note without amount).
  const [petlReconFlagIds, setPetlReconFlagIds] = useState<Set<string>>(
    () => new Set(),
  );

  // PETL filters (multi-select). Empty array means "All".
  const [roomParticleIdFilters, setRoomParticleIdFilters] = useState<string[]>([]);
  const [categoryCodeFilters, setCategoryCodeFilters] = useState<string[]>([]);
  const [selectionCodeFilters, setSelectionCodeFilters] = useState<string[]>([]);
  const [petlOrgGroupFilters, setPetlOrgGroupFilters] = useState<string[]>([]);
  // Hide note badges and note-only reconciliation lines by default
  const [petlHideNotes, setPetlHideNotes] = useState(true);

  const roomParticleIdFilterSet = useMemo(
    () => new Set(roomParticleIdFilters),
    [roomParticleIdFilters],
  );
  const categoryCodeFilterSet = useMemo(
    () => new Set(categoryCodeFilters),
    [categoryCodeFilters],
  );
  const selectionCodeFilterSet = useMemo(
    () => new Set(selectionCodeFilters),
    [selectionCodeFilters],
  );
  const petlOrgGroupFilterSet = useMemo(
    () => new Set(petlOrgGroupFilters),
    [petlOrgGroupFilters],
  );

  const petlOrgGroupCodes = useMemo(() => {
    const codes = new Set<string>();
    for (const it of petlItems) {
      const raw = (it as any).projectParticle?.orgGroupCode ?? (it as any).orgGroupCode ?? null;
      const code = String(raw ?? "").trim();
      if (code) codes.add(code);
    }
    return Array.from(codes.values()).sort((a, b) => a.localeCompare(b));
  }, [petlItems]);

  // PETL view toggle: project organization grouping vs line sequence
  // Default to LINE_SEQUENCE (and persist per-project) so the cost book / line-by-line
  // reconciliation workflow is the primary view.
  const petlDisplayModeKey = `petlDisplayMode:v2:${id}`;

  const [petlDisplayMode, setPetlDisplayMode] = useState<PetlDisplayMode>(() => {
    if (typeof window === "undefined") return "LINE_SEQUENCE";

    // v2 key intentionally resets old defaults so new projects/users land on
    // LINE_SEQUENCE by default.
    const raw = localStorage.getItem(petlDisplayModeKey);
    if (
      raw === "PROJECT_GROUPING" ||
      raw === "LINE_SEQUENCE" ||
      raw === "RECONCILIATION_ONLY"
    ) {
      return raw;
    }

    return "LINE_SEQUENCE";
  });

  const [petlPercentFile, setPetlPercentFile] = useState<File | null>(null);
  const [petlPercentImporting, setPetlPercentImporting] = useState(false);
  const [petlPercentImportError, setPetlPercentImportError] = useState<string | null>(null);
  const [petlPercentJobId, setPetlPercentJobId] = useState<string | null>(null);
  const [petlPercentJob, setPetlPercentJob] = useState<any | null>(null);
  const [petlPercentJobError, setPetlPercentJobError] = useState<string | null>(null);

  const [petlReconcileNotesFile, setPetlReconcileNotesFile] = useState<File | null>(null);
  const [petlReconcileNotesImporting, setPetlReconcileNotesImporting] = useState(false);
  const [petlReconcileNotesImportError, setPetlReconcileNotesImportError] = useState<string | null>(null);
  const [petlReconcileNotesImportResult, setPetlReconcileNotesImportResult] = useState<any | null>(null);

  // Build PETL baseline directly from the tenant Cost Book.
  const [petlBaselineCostBookPickerOpen, setPetlBaselineCostBookPickerOpen] = useState(false);
  const [petlBaselineCostBookPickerBusy, setPetlBaselineCostBookPickerBusy] = useState(false);
  const [petlBaselineLocation, setPetlBaselineLocation] = useState("");
  const [petlBaselineMessage, setPetlBaselineMessage] = useState<string | null>(null);

  // BOM (Bill of Materials) state
  const [bomData, setBomData] = useState<any | null>(null);
  const [bomLoading, setBomLoading] = useState(false);
  const [bomError, setBomError] = useState<string | null>(null);
  const [bomView, setBomView] = useState<"petl" | "components">("petl");

  // Rarely used: keep import UIs behind a modal so they don't affect initial render/layout.
  const [importsModalOpen, setImportsModalOpen] = useState(false);

  const closeImportsModal = useCallback(() => {
    setImportsModalOpen(false);
    // Clear selected files so we don't end up with enabled submit buttons after remount.
    setPetlPercentFile(null);
    setPetlReconcileNotesFile(null);
    // Clear transient errors (results/job status can remain).
    setPetlPercentImportError(null);
    setPetlReconcileNotesImportError(null);
  }, []);

  // Async CSV generation with chunked processing to avoid blocking main thread
  const downloadPetlPercentCsv = useCallback(async () => {
    busyOverlay.setMessage("Generating CSV…");
    const done = busyOverlay.begin("Generating CSV…");

    try {
      // Yield to let the overlay render
      await new Promise((resolve) => requestAnimationFrame(resolve));

      const header = ["#", "% Complete"];
      const sortedItems = [...petlItems].sort((a, b) => a.lineNo - b.lineNo);

      // Process in chunks to avoid blocking
      const CHUNK_SIZE = 500;
      const rows: string[] = [];

      for (let i = 0; i < sortedItems.length; i += CHUNK_SIZE) {
        const chunk = sortedItems.slice(i, i + CHUNK_SIZE);
        for (const item of chunk) {
          const lineNo = String(item.lineNo).trim();
          // If a line is marked ACV-only, leave % blank so uploading the template
          // won't accidentally flip it to non-ACV-only.
          const pct = item.isAcvOnly ? "" : String(item.percentComplete ?? "");
          rows.push(`${lineNo},${pct}`);
        }
        // Yield to main thread between chunks
        if (i + CHUNK_SIZE < sortedItems.length) {
          await new Promise((resolve) => setTimeout(resolve, 0));
        }
      }

      const csv = [header.join(","), ...rows].join("\n");
      const fileName = `petl-percent-import-${id}.csv`;

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } finally {
      done();
    }
  }, [id, petlItems, busyOverlay]);

  useEffect(() => {
    if (!petlPercentJobId) return;
    let cancelled = false;
    let timer: number | null = null;

    const poll = async () => {
      const token = localStorage.getItem("accessToken");
      if (!token) {
        setPetlPercentJobError("Missing access token.");
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/import-jobs/${petlPercentJobId}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Failed to fetch job status (${res.status}) ${text}`);
        }
        const json = await res.json();
        if (cancelled) return;
        setPetlPercentJob(json);
        const done = json?.status === "SUCCEEDED" || json?.status === "FAILED";
        if (!done) {
          timer = window.setTimeout(poll, 4000);
        } else {
          // refresh PETL once import completes
          setPetlReloadTick((t) => t + 1);
        }
      } catch (err: any) {
        if (cancelled) return;
        setPetlPercentJobError(err?.message ?? "Failed to fetch job status.");
        timer = window.setTimeout(poll, 8000);
      }
    };

    poll();
    return () => {
      cancelled = true;
      if (timer != null) window.clearTimeout(timer);
    };
  }, [petlPercentJobId]);

  async function handlePetlPercentImport(e: React.FormEvent) {
    e.preventDefault();
    setPetlPercentImportError(null);

    if (!petlPercentFile) {
      setPetlPercentImportError("Choose a CSV file first.");
      return;
    }

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setPetlPercentImportError("Missing access token.");
      return;
    }

    try {
      setPetlPercentImporting(true);
      const form = new FormData();
      form.append("file", petlPercentFile);

      const res = await fetch(`${API_BASE}/projects/${id}/import-jobs/petl-percent`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: form,
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Import failed (${res.status}) ${text}`);
      }

      const json = await res.json().catch(() => ({}));
      const nextJobId = json?.jobId ?? null;
      setPetlPercentJobId(nextJobId);
      setPetlPercentJob(null);
      setPetlPercentJobError(null);
      setPetlPercentFile(null);
    } catch (err: any) {
      setPetlPercentImportError(err?.message ?? "Failed to queue import.");
    } finally {
      setPetlPercentImporting(false);
    }
  }

  async function handlePetlReconcileNotesImport(e: React.FormEvent) {
    e.preventDefault();
    setPetlReconcileNotesImportError(null);

    if (!petlReconcileNotesFile) {
      setPetlReconcileNotesImportError("Choose a CSV file first.");
      return;
    }

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setPetlReconcileNotesImportError("Missing access token.");
      return;
    }

    try {
      setPetlReconcileNotesImporting(true);
      const form = new FormData();
      form.append("file", petlReconcileNotesFile);

      const res = await fetch(`${API_BASE}/projects/${id}/petl/import-reconcile-notes`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: form,
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Import failed (${res.status}) ${text}`);
      }

      const json = await res.json().catch(() => ({}));
      setPetlReconcileNotesImportResult(json);
      setPetlReconcileNotesFile(null);

      // Refresh PETL/rollups + reconciliation drawer data.
      setPetlReloadTick((t) => t + 1);
      if (petlReconPanel.open && petlReconPanel.sowItemId) {
        void loadPetlReconciliation(petlReconPanel.sowItemId);
      }
    } catch (err: any) {
      setPetlReconcileNotesImportError(err?.message ?? "Failed to import notes.");
    } finally {
      setPetlReconcileNotesImporting(false);
    }
  }

  const [expandedRooms, setExpandedRooms] = useState<Set<string>>(new Set());
  const [expandedUnits, setExpandedUnits] = useState<Set<string>>(new Set());

  const [operation, setOperation] = useState<"set" | "increment" | "decrement">("set");
  const [operationPercent, setOperationPercent] = useState<string>("");
  const [bulkSaving, setBulkSaving] = useState(false);
  const [bulkMessage, setBulkMessage] = useState<string | null>(null);
  const [bulkConfirmPending, setBulkConfirmPending] = useState(false);

  // Pending PETL % approvals (PM/owner/admin only)
  const [pendingPetlSessions, setPendingPetlSessions] = useState<any[] | null>(null);
  const [pendingPetlLoading, setPendingPetlLoading] = useState(false);
  const [pendingPetlError, setPendingPetlError] = useState<string | null>(null);
  const [pendingPetlMessage, setPendingPetlMessage] = useState<string | null>(null);
  const [pendingPetlReloadTick, setPendingPetlReloadTick] = useState(0);

  const [selectionSummary, setSelectionSummary] = useState<{
    itemCount: number;
    totalAmount: number;
    completedAmount: number;
    percentComplete: number;
  } | null>(null);

  const [financialSummary, setFinancialSummary] = useState<FinancialSummary | null>(null);
  const [financialLoading, setFinancialLoading] = useState(false);
  const [financialError, setFinancialError] = useState<string | null>(null);
  // Track when we last entered the Financial tab to trigger refresh on each visit
  const [financialTabVisitTick, setFinancialTabVisitTick] = useState(0);

  // PETL archives (Admin/Owner)
  const [petlArchives, setPetlArchives] = useState<any[] | null>(null);
  const [petlArchivesLoading, setPetlArchivesLoading] = useState(false);
  const [petlArchivesError, setPetlArchivesError] = useState<string | null>(null);
  const [petlArchivesMessage, setPetlArchivesMessage] = useState<string | null>(null);
  const [petlArchivesCollapsed, setPetlArchivesCollapsed] = useState(true);

  // Bills (expenses)
  const [projectBills, setProjectBills] = useState<any[] | null>(null);
  const [projectBillsLoading, setProjectBillsLoading] = useState(false);
  const [projectBillsError, setProjectBillsError] = useState<string | null>(null);
  const [billsMessage, setBillsMessage] = useState<string | null>(null);
  const [billsCollapsed, setBillsCollapsed] = useState(false);

  const [billModalOpen, setBillModalOpen] = useState(false);
  const [billModalSaving, setBillModalSaving] = useState(false);
  const [billEditingId, setBillEditingId] = useState<string | null>(null);
  // Track linked daily log for receipt-based bills (blocks deletion)
  const [billLinkedDailyLog, setBillLinkedDailyLog] = useState<{
    id: string;
    title: string | null;
    type: string;
  } | null>(null);

  const [billVendorName, setBillVendorName] = useState("");
  const [billBillNumber, setBillBillNumber] = useState("");
  const [billBillDate, setBillBillDate] = useState("");
  const [billDueAt, setBillDueAt] = useState("");
  const [billStatus, setBillStatus] = useState<string>("DRAFT");
  const [billMemo, setBillMemo] = useState("");

  const [billLineKind, setBillLineKind] = useState<string>("MATERIALS");
  const [billLineDescription, setBillLineDescription] = useState("");
  const [billLineAmount, setBillLineAmount] = useState("");
  const [billLineTimecardStartDate, setBillLineTimecardStartDate] = useState("");
  const [billLineTimecardEndDate, setBillLineTimecardEndDate] = useState("");
  const [billBillable, setBillBillable] = useState(false);
  const [billMarkupPercent, setBillMarkupPercent] = useState<string>("25");

  const [billAttachmentProjectFileIds, setBillAttachmentProjectFileIds] = useState<string[]>([]);
  const [billEditingExistingAttachmentIds, setBillEditingExistingAttachmentIds] = useState<string[]>([]);
  const [billAttachmentFileOptions, setBillAttachmentFileOptions] = useState<any[] | null>(null);
  const [billAttachmentFileLoading, setBillAttachmentFileLoading] = useState(false);
  const [billAttachmentFileError, setBillAttachmentFileError] = useState<string | null>(null);

  // Bill modal drag-drop upload state
  const [billDragOver, setBillDragOver] = useState(false);
  const [billUploadedFiles, setBillUploadedFiles] = useState<Array<{ id: string; fileName: string; mimeType: string | null; storageUrl: string }>>([]);
  const [billUploading, setBillUploading] = useState(false);
  const [billOcrMessage, setBillOcrMessage] = useState<string | null>(null);

  // State for moving expense line items between invoices
  const [selectedExpenseLineIds, setSelectedExpenseLineIds] = useState<Set<string>>(new Set());
  const [moveExpenseLinesBusy, setMoveExpenseLinesBusy] = useState(false);
  const [moveExpenseLinesMessage, setMoveExpenseLinesMessage] = useState<string | null>(null);
  const [moveExpenseTargetInvoiceId, setMoveExpenseTargetInvoiceId] = useState<string>(""); // "" = new invoice

  // Invoices + payments (progress billing)
  const [projectInvoices, setProjectInvoices] = useState<any[] | null>(null);
  const [projectInvoicesLoading, setProjectInvoicesLoading] = useState(false);
  const [projectInvoicesError, setProjectInvoicesError] = useState<string | null>(null);

  // Invoice status filter - default all except VOID
  const [invoiceStatusFilters, setInvoiceStatusFilters] = useState<Set<string>>(
    () => new Set(["DRAFT", "ISSUED", "PARTIALLY_PAID", "PAID"])
  );

  const [activeInvoice, setActiveInvoice] = useState<any | null>(null);
  const [activeInvoiceLoading, setActiveInvoiceLoading] = useState(false);
  const [activeInvoiceError, setActiveInvoiceError] = useState<string | null>(null);
  // Toggle for unlocking issued invoices for editing (Admin/Owner only, no payments)
  const [invoiceEditUnlocked, setInvoiceEditUnlocked] = useState(false);

  const [invoiceMessage, setInvoiceMessage] = useState<string | null>(null);
  const [paymentsMessage, setPaymentsMessage] = useState<string | null>(null);
  const [invoiceAttachMenuOpen, setInvoiceAttachMenuOpen] = useState(false);

  // Inline edit for draft invoice number (Admin/Owner only)
  const [editingInvoiceNoId, setEditingInvoiceNoId] = useState<string | null>(null);
  const [editingInvoiceNoValue, setEditingInvoiceNoValue] = useState<string>("");

  async function loadActiveInvoice() {
    if (!project || !activeInvoice?.id) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setInvoiceMessage("Missing access token.");
      return;
    }

    setActiveInvoiceLoading(true);
    setActiveInvoiceError(null);
    try {
      const res = await fetch(
        `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}`,
        { headers: { Authorization: `Bearer ${token}` } },
      );
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Failed to load invoice (${res.status}) ${text}`);
      }
      const json: any = await res.json();
      setActiveInvoice(json);
    } catch (err: any) {
      setActiveInvoiceError(err?.message ?? "Failed to load invoice.");
    } finally {
      setActiveInvoiceLoading(false);
    }
  }

  // Invoice printing - field definitions for customizable print
  const INVOICE_PRINT_FIELD_DEFS = useMemo(() => [
    { key: "lineNo", label: "Line #" },
    { key: "categoryCode", label: "CAT" },
    { key: "selectionCode", label: "SEL" },
    { key: "description", label: "Description" },
    { key: "room", label: "Room" },
    { key: "unit", label: "Unit" },
    { key: "building", label: "Building" },
    { key: "percentComplete", label: "% Complete" },
    { key: "earnedTotal", label: "Earned Total" },
    { key: "prevBilledTotal", label: "Previously Billed" },
    { key: "thisInvTotal", label: "This Invoice" },
    { key: "billingTag", label: "Billing Tag" },
  ], []);

  // State for line exclusion modal
  const [invoiceLineExclusionModalOpen, setInvoiceLineExclusionModalOpen] = useState(false);

  // Default: ALL fields selected. User's last selection persists globally.
  const ALL_PRINT_FIELDS = useMemo(
    () => new Set(INVOICE_PRINT_FIELD_DEFS.map(f => f.key)),
    [INVOICE_PRINT_FIELD_DEFS]
  );

  // Invoice printing state
  const [invoicePrintDialogOpen, setInvoicePrintDialogOpen] = useState(false);
  const [invoicePrintLayout, setInvoicePrintLayout] = useState<"KEEP" | "GROUPED" | "FLAT">("KEEP");
  const [invoicePrintGroups, setInvoicePrintGroups] = useState<"KEEP" | "COLLAPSE_ALL" | "EXPAND_ALL">("KEEP");
  const [invoicePrintBusy, setInvoicePrintBusy] = useState(false);

  // Customizable print fields - persisted GLOBALLY (not per-project) so user's
  // last selection carries across projects
  const printFieldsKey = "invoicePrintFields:v2:global";
  const [invoicePrintFields, setInvoicePrintFields] = useState<Set<string>>(() => {
    if (typeof window === "undefined") return ALL_PRINT_FIELDS;
    try {
      const raw = localStorage.getItem(printFieldsKey);
      if (!raw) return ALL_PRINT_FIELDS;
      const arr = JSON.parse(raw);
      return Array.isArray(arr) && arr.length > 0 ? new Set(arr) : ALL_PRINT_FIELDS;
    } catch {
      return ALL_PRINT_FIELDS;
    }
  });

  // Persist print fields to localStorage (global)
  useEffect(() => {
    if (typeof window === "undefined") return;
    try {
      localStorage.setItem(printFieldsKey, JSON.stringify([...invoicePrintFields]));
    } catch {
      // ignore
    }
  }, [invoicePrintFields]);

  // Lines to exclude from print (per invoice, not persisted)
  const [invoicePrintExcludedLines, setInvoicePrintExcludedLines] = useState<Set<string>>(() => new Set());

  // Reset excluded lines and unlock state when invoice changes
  useEffect(() => {
    setInvoicePrintExcludedLines(new Set());
    setInvoiceEditUnlocked(false);
  }, [activeInvoice?.id]);

  // Group by field for print - supports multi-level hierarchy
  const printGroupByKey = `invoicePrintGroupBy:v2:${id}`;
  const [invoicePrintGroupBy, setInvoicePrintGroupBy] = useState<"none" | "room" | "unit" | "building" | "category" | "supplements" | "change-orders" | "acv-rebates">(() => {
    if (typeof window === "undefined") return "none";
    try {
      const raw = localStorage.getItem(printGroupByKey);
      if (raw === "room" || raw === "unit" || raw === "building" || raw === "category" || raw === "supplements" || raw === "change-orders" || raw === "acv-rebates") return raw as any;
      return "none";
    } catch {
      return "none";
    }
  });

  // Persist groupBy to localStorage
  useEffect(() => {
    if (typeof window === "undefined") return;
    try {
      localStorage.setItem(printGroupByKey, invoicePrintGroupBy);
    } catch {
      // ignore
    }
  }, [printGroupByKey, invoicePrintGroupBy]);

  // Consolidate by description - merges lines with same description, sums totals
  const printConsolidateKey = "invoicePrintConsolidate:v1:global";
  const [invoicePrintConsolidate, setInvoicePrintConsolidate] = useState<boolean>(() => {
    if (typeof window === "undefined") return false;
    try {
      return localStorage.getItem(printConsolidateKey) === "1";
    } catch {
      return false;
    }
  });

  // Persist consolidate setting
  useEffect(() => {
    if (typeof window === "undefined") return;
    try {
      localStorage.setItem(printConsolidateKey, invoicePrintConsolidate ? "1" : "0");
    } catch {
      // ignore
    }
  }, [invoicePrintConsolidate]);

  // Fields to hide when consolidating (they vary per line so don't make sense)
  const CONSOLIDATE_HIDDEN_FIELDS = new Set(["lineNo", "room", "unit", "building", "billingTag"]);

  // Toggle a print field on/off
  const togglePrintField = (fieldKey: string) => {
    React.startTransition(() => {
      setInvoicePrintFields(prev => {
        const next = new Set(prev);
        if (next.has(fieldKey)) {
          next.delete(fieldKey);
        } else {
          next.add(fieldKey);
        }
        return next;
      });
    });
  };

  // Toggle a line exclusion
  const togglePrintLineExclusion = (lineId: string) => {
    setInvoicePrintExcludedLines(prev => {
      const next = new Set(prev);
      if (next.has(lineId)) {
        next.delete(lineId);
      } else {
        next.add(lineId);
      }
      return next;
    });
  };

  // Select/deselect all lines for print
  const setAllLinesIncluded = (include: boolean) => {
    if (include) {
      setInvoicePrintExcludedLines(new Set());
    } else {
      const allIds = (activeInvoicePetlLines as any[]).map((li: any) => String(li?.id ?? "")).filter(Boolean);
      setInvoicePrintExcludedLines(new Set(allIds));
    }
  };

  // Detailed invoice view toggle: flat list vs PETL project grouping tree
  // Default to flat list (line sequence) for easier reconciliation with estimate.
  const invoiceGroupKey = `invoicePetlGroup:v2:${id}`;
  const [invoiceGroupEnabled, setInvoiceGroupEnabled] = useState<boolean>(() => {
    if (typeof window === "undefined") return false;
    try {
      const raw = localStorage.getItem(invoiceGroupKey);
      // default OFF (flat/line sequence view)
      return raw === "1";
    } catch {
      return false;
    }
  });

  const setInvoiceGroupEnabledPersisted = (next: boolean) => {
    setInvoiceGroupEnabled(next);
    if (typeof window !== "undefined") {
      try {
        localStorage.setItem(invoiceGroupKey, next ? "1" : "0");
      } catch {
        // ignore
      }
    }
  };

  const [invoiceGroupOpenBuildings, setInvoiceGroupOpenBuildings] = useState<Set<string>>(() => new Set());

  // PETL view: which PETL lines to show in the invoice detail (ALL / CARRIER / CLIENT / specialized views)
  const [invoicePetlView, setInvoicePetlView] = useState<"ALL" | "CARRIER" | "CLIENT" | "SUPPLEMENTS" | "CHANGE_ORDERS" | "ACV_REBATES">("ALL");

  // Invoice PETL line billing tags (edit on-demand to avoid rendering heavy selects for every row)
  const [invoicePetlTagEditingLineId, setInvoicePetlTagEditingLineId] = useState<string | null>(null);
  const [invoicePetlTagDraft, setInvoicePetlTagDraft] = useState<string>("NONE");
  const [invoicePetlTagSaving, setInvoicePetlTagSaving] = useState(false);

  // Invoice-to-invoice credit application (Apply deposit/credit)
  const [invoiceApplyModalOpen, setInvoiceApplyModalOpen] = useState(false);
  const [invoiceApplySources, setInvoiceApplySources] = useState<any[] | null>(null);
  const [invoiceApplySourcesLoading, setInvoiceApplySourcesLoading] = useState(false);
  const [invoiceApplySourcesError, setInvoiceApplySourcesError] = useState<string | null>(null);
  const [invoiceApplySelectedSourceId, setInvoiceApplySelectedSourceId] = useState<string>("");
  const [invoiceApplyAmount, setInvoiceApplyAmount] = useState<string>("");
  const [invoiceApplySaving, setInvoiceApplySaving] = useState(false);

  // Invoice unlock dialog (revert ISSUED -> DRAFT for $0 paid invoices)
  const [invoiceUnlockModalOpen, setInvoiceUnlockModalOpen] = useState(false);
  const [invoiceUnlockTarget, setInvoiceUnlockTarget] = useState<any | null>(null);
  const [invoiceUnlockReason, setInvoiceUnlockReason] = useState("");
  const [invoiceUnlockSaving, setInvoiceUnlockSaving] = useState(false);

  const activeInvoicePetlLines = useMemo(() => {
    const lines = activeInvoice?.petlLines;
    if (!Array.isArray(lines)) return [];
    // Sort by displayLineNo for consistent display (handles 1, 1.1, 1.2, 2, etc.)
    return [...lines].sort((a: any, b: any) => {
      const aDisplay = String(a?.displayLineNo ?? a?.sourceLineNoSnapshot ?? a?.lineNoSnapshot ?? "0");
      const bDisplay = String(b?.displayLineNo ?? b?.sourceLineNoSnapshot ?? b?.lineNoSnapshot ?? "0");
      // Parse as version-like strings: "1" < "1.1" < "1.2" < "2"
      const aParts = aDisplay.split(".").map((p: string) => Number(p) || 0);
      const bParts = bDisplay.split(".").map((p: string) => Number(p) || 0);
      for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
        const aVal = aParts[i] ?? 0;
        const bVal = bParts[i] ?? 0;
        if (aVal !== bVal) return aVal - bVal;
      }
      return 0;
    });
  }, [activeInvoice]);

  // Roll up invoiced/paid/outstanding for the Financial Overview.
  // Exclude DRAFT + VOID.
  const invoiceRollup = useMemo(() => {
    if (!Array.isArray(projectInvoices)) return null;

    let invoiced = 0;
    let paid = 0;
    let balanceDue = 0;
    let count = 0;

    for (const inv of projectInvoices) {
      const status = String(inv?.status ?? "").trim();
      if (!status) continue;
      if (status === "DRAFT" || status === "VOID") continue;

      count += 1;
      invoiced += Number(inv?.totalAmount ?? 0) || 0;
      paid += Number(inv?.paidAmount ?? 0) || 0;
      balanceDue += Number(inv?.balanceDue ?? 0) || 0;
    }

    return { invoiced, paid, balanceDue, count };
  }, [projectInvoices]);

  const billsRollup = useMemo(() => {
    if (!Array.isArray(projectBills)) return null;

    let count = 0;
    let total = 0;

    for (const b of projectBills) {
      count += 1;
      total += Number(b?.totalAmount ?? 0) || 0;
    }

    return { count, total };
  }, [projectBills]);

  // When a new invoice is opened, default the grouped view to COLLAPSED.
  // (Users can expand group → unit → room as needed.)
  useEffect(() => {
    if (!invoiceGroupEnabled) return;

    setInvoiceGroupOpenBuildings(new Set());

    // Reset any inline edit state when switching invoices.
    setInvoicePetlTagEditingLineId(null);
    setInvoicePetlTagDraft("NONE");
    setInvoicePetlTagSaving(false);
  }, [activeInvoice?.id, invoiceGroupEnabled]);

  const formatMoney = (value: any) => {
    const n = Number(value ?? 0);
    if (!Number.isFinite(n)) return "—";
    const abs = Math.abs(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return n < 0 ? `($${abs})` : `$${abs}`;
  };

  // Helper to get background color for invoice line items (supplements, COs, ACV)
  const getInvoiceLineBackground = (li: any): string => {
    const tag = getInvoicePetlEffectiveTag(li);
    const kind = String(li?.kind ?? "");
    
    // ACV items (yellow highlight)
    if (kind === "ACV" || kind === "ACV_HOLDBACK_CREDIT") return "#fef9c3"; // yellow-100
    
    // Supplements (light blue)
    if (tag === "SUPPLEMENT") return "#dbeafe"; // blue-100
    
    // Change orders and credits (light blue)
    if (tag === "CHANGE_ORDER" || tag === "SUPPLEMENT_CREDIT" || tag === "CO_CREDIT") return "#dbeafe"; // blue-100
    
    return "transparent";
  };

  // Check if line is subordinate (line-tied to parent)
  const isSubordinateLine = (li: any): boolean => {
    return li?.parentLineId || li?.anchorKind === "LINE_TIED";
  };

  const csvEscape = (value: any) => {
    if (value === null || value === undefined) return "";
    const s = String(value);
    // RFC4180-ish: escape quotes, wrap if contains quote/comma/newline.
    const needsWrap = /[",\n\r]/.test(s);
    const escaped = s.replace(/"/g, '""');
    return needsWrap ? `"${escaped}"` : escaped;
  };

  const buildCsv = (headers: string[], rows: Record<string, any>[]) => {
    const lines: string[] = [];
    lines.push(headers.map(csvEscape).join(","));
    for (const row of rows) {
      lines.push(headers.map((h) => csvEscape(row[h])).join(","));
    }
    return lines.join("\n") + "\n";
  };

  const downloadCsv = (filename: string, csvText: string) => {
    try {
      const blob = new Blob([csvText], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.rel = "noopener noreferrer";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch {
      // ignore
    }
  };

  const exportInvoicesCsv = async () => {
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setInvoiceMessage("Missing access token.");
      return;
    }

    setInvoiceMessage("Exporting invoices…");

    try {
      const res = await fetch(`${API_BASE}/projects/${project.id}/invoices`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Export failed (${res.status}) ${text}`);
      }

      const invoices: any[] = await res.json();
      const headers = [
        "invoiceId",
        "invoiceNo",
        "status",
        "issuedAt",
        "dueAt",
        "createdAt",
        "totalAmount",
        "paidAmount",
        "balanceDue",
        "billToName",
        "billToEmail",
        "memo",
      ];

      const rows = (Array.isArray(invoices) ? invoices : []).map((inv: any) => ({
        invoiceId: inv?.id ?? "",
        invoiceNo: inv?.invoiceNo ?? "",
        status: inv?.status ?? "",
        issuedAt: inv?.issuedAt ?? "",
        dueAt: inv?.dueAt ?? "",
        createdAt: inv?.createdAt ?? "",
        totalAmount: inv?.totalAmount ?? 0,
        paidAmount: inv?.paidAmount ?? 0,
        balanceDue: inv?.balanceDue ?? 0,
        billToName: inv?.billToName ?? "",
        billToEmail: inv?.billToEmail ?? "",
        memo: inv?.memo ?? "",
      }));

      const csv = buildCsv(headers, rows);
      const dateTag = new Date().toISOString().slice(0, 10);
      downloadCsv(`project_${project.id}_invoices_${dateTag}.csv`, csv);
      setInvoiceMessage(`Exported ${rows.length} invoice row(s).`);
    } catch (err: any) {
      setInvoiceMessage(err?.message ?? "Invoice export failed.");
    }
  };

  const exportPaymentsCsv = async () => {
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setPaymentsMessage("Missing access token.");
      return;
    }

    setPaymentsMessage("Exporting payments…");

    try {
      const [paymentsRes, invoicesRes] = await Promise.all([
        fetch(`${API_BASE}/projects/${project.id}/payments`, {
          headers: { Authorization: `Bearer ${token}` },
        }),
        fetch(`${API_BASE}/projects/${project.id}/invoices`, {
          headers: { Authorization: `Bearer ${token}` },
        }),
      ]);

      if (!paymentsRes.ok) {
        const text = await paymentsRes.text().catch(() => "");
        throw new Error(`Payments export failed (${paymentsRes.status}) ${text}`);
      }
      if (!invoicesRes.ok) {
        const text = await invoicesRes.text().catch(() => "");
        throw new Error(`Payments export failed (invoice lookup ${invoicesRes.status}) ${text}`);
      }

      const payments: any[] = await paymentsRes.json();
      const invoices: any[] = await invoicesRes.json();
      const invoiceById = new Map<string, any>();
      for (const inv of Array.isArray(invoices) ? invoices : []) {
        if (inv?.id) invoiceById.set(String(inv.id), inv);
      }

      const headers = [
        "rowType",
        "rowAmount",
        "paymentId",
        "paymentAmount",
        "paidAt",
        "method",
        "reference",
        "note",
        "paymentCreatedAt",
        "appliedAmount",
        "unappliedAmount",
        "applicationId",
        "applicationAmount",
        "invoiceId",
        "invoiceNo",
        "invoiceStatus",
        "invoiceIssuedAt",
        "invoiceDueAt",
      ];

      const rows: Record<string, any>[] = [];

      for (const p of Array.isArray(payments) ? payments : []) {
        const paymentId = String(p?.id ?? "");
        const paymentAmount = Number(p?.amount ?? 0) || 0;
        const paidAt = p?.paidAt ?? "";
        const method = p?.method ?? "";
        const reference = p?.reference ?? "";
        const note = p?.note ?? "";
        const paymentCreatedAt = p?.createdAt ?? "";
        const appliedAmount = Number(p?.appliedAmount ?? 0) || 0;
        const unappliedAmount = Number(p?.unappliedAmount ?? 0) || 0;

        const apps: any[] = Array.isArray(p?.applications) ? p.applications : [];

        for (const a of apps) {
          const invoiceId = String(a?.invoiceId ?? "");
          const inv = invoiceById.get(invoiceId);
          rows.push({
            rowType: "APPLICATION",
            rowAmount: Number(a?.amount ?? 0) || 0,
            paymentId,
            paymentAmount,
            paidAt,
            method,
            reference,
            note,
            paymentCreatedAt,
            appliedAmount,
            unappliedAmount,
            applicationId: a?.id ?? "",
            applicationAmount: a?.amount ?? 0,
            invoiceId,
            invoiceNo: inv?.invoiceNo ?? a?.invoiceNo ?? "",
            invoiceStatus: inv?.status ?? "",
            invoiceIssuedAt: inv?.issuedAt ?? "",
            invoiceDueAt: inv?.dueAt ?? "",
          });
        }

        if (unappliedAmount > 0) {
          rows.push({
            rowType: "UNAPPLIED",
            rowAmount: unappliedAmount,
            paymentId,
            paymentAmount,
            paidAt,
            method,
            reference,
            note,
            paymentCreatedAt,
            appliedAmount,
            unappliedAmount,
            applicationId: "",
            applicationAmount: "",
            invoiceId: "",
            invoiceNo: "",
            invoiceStatus: "",
            invoiceIssuedAt: "",
            invoiceDueAt: "",
          });
        }

        if (apps.length === 0 && unappliedAmount === 0) {
          rows.push({
            rowType: "PAYMENT",
            rowAmount: 0,
            paymentId,
            paymentAmount,
            paidAt,
            method,
            reference,
            note,
            paymentCreatedAt,
            appliedAmount,
            unappliedAmount,
            applicationId: "",
            applicationAmount: "",
            invoiceId: "",
            invoiceNo: "",
            invoiceStatus: "",
            invoiceIssuedAt: "",
            invoiceDueAt: "",
          });
        }
      }

      const csv = buildCsv(headers, rows);
      const dateTag = new Date().toISOString().slice(0, 10);
      downloadCsv(`project_${project.id}_payments_${dateTag}.csv`, csv);
      setPaymentsMessage(`Exported ${rows.length} row(s).`);
    } catch (err: any) {
      setPaymentsMessage(err?.message ?? "Payments export failed.");
    }
  };

  const refreshPetlArchives = () => {
    setPetlArchivesMessage(null);
    setPetlArchives(null);
  };

  const createPetlArchive = async () => {
    if (!project) return;

    setPetlArchivesMessage(null);

    if (!isAdminOrAbove) {
      setPetlArchivesMessage("Only Admin+ can create PETL archives.");
      return;
    }

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setPetlArchivesMessage("Missing access token.");
      return;
    }

    const label = window.prompt("Archive label (optional)", "") ?? "";
    const note = window.prompt("Archive note (optional)", "") ?? "";

    try {
      await busyOverlay.run("Creating PETL archive…", async () => {
        const res = await fetch(`${API_BASE}/projects/${project.id}/petl-archives`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            label: label.trim() || undefined,
            note: note.trim() || undefined,
          }),
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Create failed (${res.status}) ${text}`);
        }

        setPetlArchivesMessage("Archive created.");
        setPetlArchives(null);
      });
    } catch (err: any) {
      setPetlArchivesMessage(err?.message ?? "Failed to create archive.");
    }
  };

  const restorePetlArchive = async (archive: any) => {
    if (!project) return;

    setPetlArchivesMessage(null);

    if (!isAdminOrAbove) {
      setPetlArchivesMessage("Only Admin+ can restore PETL archives.");
      return;
    }

    const ok = window.confirm(
      "Restore this PETL archive into the SAME project?\n\nThis will create a NEW estimate version and replace the PETL baseline used for Financial/PETL views.",
    );
    if (!ok) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setPetlArchivesMessage("Missing access token.");
      return;
    }

    try {
      await busyOverlay.run("Restoring PETL archive…", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${project.id}/petl-archives/${archive.id}/restore`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Restore failed (${res.status}) ${text}`);
        }

        const json: any = await res.json().catch(() => ({}));
        const restoredId = json.restoredEstimateVersionId ?? null;

        setPetlArchivesMessage(
          restoredId ? `Restored (new estimate version: ${restoredId}).` : "Restored.",
        );

        // Force reload of derived financial/PETL views.
        setFinancialSummary(null);
        setSelectionSummary(null);
        setPetlReloadTick((t) => t + 1);

        // Refresh archive list
        setPetlArchives(null);
      });
    } catch (err: any) {
      setPetlArchivesMessage(err?.message ?? "Restore failed.");
    }
  };

  const resetBillForm = () => {
    setBillEditingId(null);
    setBillLinkedDailyLog(null);
    setBillVendorName("");
    setBillBillNumber("");
    setBillBillDate(todayIso);
    setBillDueAt("");
    setBillStatus("DRAFT");
    setBillMemo("");

    setBillLineKind("MATERIALS");
    setBillLineDescription("");
    setBillLineAmount("");
    setBillLineTimecardStartDate("");
    setBillLineTimecardEndDate("");

    setBillBillable(false);
    setBillMarkupPercent("25");

    setBillAttachmentProjectFileIds([]);
    setBillEditingExistingAttachmentIds([]);

    // Reset drag-drop upload state
    setBillUploadedFiles([]);
    setBillOcrMessage(null);
  };

  const openCreateBillModal = () => {
    resetBillForm();
    setBillsMessage(null);
    setBillModalOpen(true);
  };

  const openEditBillModal = (bill: any) => {
    const li = Array.isArray(bill?.lineItems) ? bill.lineItems[0] : null;

    setBillEditingId(String(bill?.id ?? ""));
    setBillVendorName(String(bill?.vendorName ?? ""));
    setBillBillNumber(String(bill?.billNumber ?? ""));
    setBillBillDate(bill?.billDate ? String(bill.billDate).slice(0, 10) : todayIso);
    setBillDueAt(bill?.dueAt ? String(bill.dueAt).slice(0, 10) : "");
    setBillStatus(String(bill?.status ?? "DRAFT") || "DRAFT");
    setBillMemo(String(bill?.memo ?? ""));

    setBillLineKind(String(li?.kind ?? "MATERIALS") || "MATERIALS");
    setBillLineDescription(String(li?.description ?? ""));
    setBillLineAmount(li?.amount != null ? String(li.amount) : "");
    setBillLineTimecardStartDate(li?.timecardStartDate ? String(li.timecardStartDate).slice(0, 10) : "");
    setBillLineTimecardEndDate(li?.timecardEndDate ? String(li.timecardEndDate).slice(0, 10) : "");

    setBillBillable(!!bill?.isBillable);
    setBillMarkupPercent(bill?.markupPercent != null ? String(bill.markupPercent) : "25");

    const attachments = Array.isArray(bill?.attachments) ? bill.attachments : [];
    const attachedIds = attachments
      .map((a: any) => String(a?.projectFileId ?? "").trim())
      .filter(Boolean);
    setBillAttachmentProjectFileIds(attachedIds);
    setBillEditingExistingAttachmentIds(attachedIds);

    // Populate billUploadedFiles with existing attachments so they display with thumbnails
    const existingAttachmentFiles = attachments.map((a: any) => ({
      id: String(a?.projectFileId ?? ""),
      fileName: String(a?.fileName ?? "Attachment"),
      mimeType: a?.mimeType ?? null,
      storageUrl: String(a?.fileUrl ?? ""),
    })).filter((f: any) => f.id && f.storageUrl);
    setBillUploadedFiles(existingAttachmentFiles);

    // Capture linked daily log info (prevents deletion if active receipt)
    const sourceDailyLog = bill?.sourceDailyLog;
    if (bill?.sourceDailyLogId && sourceDailyLog && sourceDailyLog.type === "RECEIPT_EXPENSE") {
      setBillLinkedDailyLog({
        id: String(bill.sourceDailyLogId),
        title: sourceDailyLog.title ?? null,
        type: sourceDailyLog.type,
      });
    } else {
      setBillLinkedDailyLog(null);
    }

    setBillOcrMessage(null);
    setBillsMessage(null);
    setBillModalOpen(true);
  };

  const closeBillModal = () => {
    if (billModalSaving) return;
    setBillModalOpen(false);
  };

  // Quick disposition for uncommitted receipts - update billable status without opening modal
  const quickSetBillBillable = async (billId: string, isBillable: boolean, markupPercent?: number) => {
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setBillsMessage("Missing access token.");
      return;
    }

    setBillsMessage(null);
    try {
      const payload: any = {
        isBillable,
        status: "APPROVED", // Auto-approve when dispositioning
      };
      if (isBillable && markupPercent !== undefined) {
        payload.markupPercent = markupPercent;
      }

      const res = await fetch(`${API_BASE}/projects/${project.id}/bills/${billId}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Update failed (${res.status}) ${text}`);
      }

      // Refresh bills list and financial summary
      setProjectBills(null);
      setFinancialSummary(null);
      setBillsMessage(isBillable ? "Marked as billable." : "Marked as not billable.");
    } catch (err: any) {
      setBillsMessage(err?.message ?? "Failed to update bill.");
    }
  };

  // Delete orphaned receipt bill (only allowed when source daily log is missing or changed type)
  const deleteOrphanedReceiptBill = async (billId: string, vendorName: string) => {
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setBillsMessage("Missing access token.");
      return;
    }

    const ok = window.confirm(
      `Delete this orphaned receipt from "${vendorName}"?\n\nThis action cannot be undone.`
    );
    if (!ok) return;

    setBillsMessage(null);
    try {
      const res = await fetch(`${API_BASE}/projects/${project.id}/bills/${billId}`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Delete failed (${res.status}) ${text}`);
      }

      // Refresh bills list and financial summary
      setProjectBills(null);
      setFinancialSummary(null);
      setBillsMessage("Receipt deleted.");
    } catch (err: any) {
      setBillsMessage(err?.message ?? "Failed to delete receipt.");
    }
  };

  const submitBillModal = async () => {
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setBillsMessage("Missing access token.");
      return;
    }

    const vendorName = billVendorName.trim();
    if (!vendorName) {
      setBillsMessage("Vendor name is required.");
      return;
    }

    const billDate = billBillDate || todayIso;
    const lineDesc = billLineDescription.trim();
    if (!lineDesc) {
      setBillsMessage("Line item description is required.");
      return;
    }

    const markupPct = billBillable ? Number(billMarkupPercent) : 0;
    const payload: any = {
      vendorName,
      billNumber: billBillNumber.trim() || undefined,
      billDate,
      dueAt: billDueAt || undefined,
      status: billStatus || undefined,
      memo: billMemo.trim() || undefined,
      isBillable: billBillable,
      markupPercent: billBillable && Number.isFinite(markupPct) ? markupPct : undefined,
      lineItem: {
        kind: billLineKind,
        description: lineDesc,
      },
    };

    const isLabor = String(billLineKind).toUpperCase() === "LABOR";

    if (billLineAmount.trim() === "") {
      if (isLabor) {
        if (!billLineTimecardStartDate || !billLineTimecardEndDate) {
          setBillsMessage("For labor, enter an Amount or set a timecard start/end range.");
          return;
        }
        payload.lineItem.amount = null;
        payload.lineItem.timecardStartDate = billLineTimecardStartDate;
        payload.lineItem.timecardEndDate = billLineTimecardEndDate;
      } else {
        setBillsMessage("Amount is required.");
        return;
      }
    } else {
      const amount = Number(billLineAmount);
      if (!Number.isFinite(amount)) {
        setBillsMessage("Amount must be a valid number.");
        return;
      }
      payload.lineItem.amount = amount;

      if (isLabor && billLineTimecardStartDate && billLineTimecardEndDate) {
        payload.lineItem.timecardStartDate = billLineTimecardStartDate;
        payload.lineItem.timecardEndDate = billLineTimecardEndDate;
      }
    }

    const isEdit = !!billEditingId;

    if (!isEdit) {
      // Include both checkbox-selected files and drag-drop uploaded files
      const allFileIds = [
        ...billAttachmentProjectFileIds,
        ...billUploadedFiles.map(f => f.id),
      ];
      payload.attachmentProjectFileIds = allFileIds;
    }

    setBillModalSaving(true);
    setBillsMessage(null);

    try {
      if (!isEdit) {
        const res = await fetch(`${API_BASE}/projects/${project.id}/bills`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Create failed (${res.status}) ${text}`);
        }
        await res.json().catch(() => null);
      } else {
        const res = await fetch(`${API_BASE}/projects/${project.id}/bills/${billEditingId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Update failed (${res.status}) ${text}`);
        }
        await res.json().catch(() => null);

        // Attach any newly-selected files (from checkbox selector)
        const toAttachFromCheckbox = billAttachmentProjectFileIds.filter(
          (pid) => !billEditingExistingAttachmentIds.includes(pid),
        );
        // Also attach any newly-uploaded files (from drag-drop)
        const toAttachFromUpload = billUploadedFiles
          .map(f => f.id)
          .filter((pid) => !billEditingExistingAttachmentIds.includes(pid));
        // Combine and dedupe
        const toAttach = [...new Set([...toAttachFromCheckbox, ...toAttachFromUpload])];
        
        for (const pid of toAttach) {
          const attachRes = await fetch(
            `${API_BASE}/projects/${project.id}/bills/${billEditingId}/attachments`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ projectFileId: pid }),
            },
          );
          if (!attachRes.ok) {
            const text = await attachRes.text().catch(() => "");
            throw new Error(`Attach failed (${attachRes.status}) ${text}`);
          }
        }
      }

      setProjectBills(null);
      setFinancialSummary(null);
      closeBillModal();
      setBillsMessage("Saved.");
    } catch (err: any) {
      setBillsMessage(err?.message ?? "Save failed.");
    } finally {
      setBillModalSaving(false);
    }
  };

  const htmlEscape = (value: any) => {
    const s = value === null || value === undefined ? "" : String(value);
    return s
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  };

  const fmtDate = (value: any) => {
    if (!value) return "";
    const d = new Date(value);
    if (!Number.isFinite(d.getTime())) return String(value);
    return d.toLocaleDateString();
  };

  const fmtCurrency = (value: any) => {
    const n = Number(value ?? 0);
    if (!Number.isFinite(n)) return "$0.00";
    const abs = Math.abs(n).toLocaleString(undefined, { maximumFractionDigits: 2 });
    return n < 0 ? `($${abs})` : `$${abs}`;
  };

  const printHtmlDocument = (title: string, htmlBody: string) => {
    // Use an iframe so we can print a clean, PDF-friendly HTML document
    // without mutating or re-styling the main app.
    const iframe = document.createElement("iframe");
    iframe.setAttribute("title", "invoice-print");
    iframe.style.position = "fixed";
    iframe.style.right = "0";
    iframe.style.bottom = "0";
    iframe.style.width = "0";
    iframe.style.height = "0";
    iframe.style.border = "0";
    iframe.style.opacity = "0";
    document.body.appendChild(iframe);

    const doc = iframe.contentDocument;
    const win = iframe.contentWindow;

    if (!doc || !win) {
      iframe.remove();
      return;
    }

    const fullHtml = `<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>${htmlEscape(title)}</title>
<style>
  @page { size: letter; margin: 0.6in 0.5in; }
  @page attachments { size: letter; margin: 0.4in; }
  * { box-sizing: border-box; }
  html, body {
    font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Helvetica, Arial, sans-serif;
    color: #1f2937;
    font-size: 12px;
    line-height: 1.4;
    margin: 0;
    padding: 0;
  }

  /* Header */
  .invoice-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 16px;
    border-bottom: 2px solid #e5e7eb;
    margin-bottom: 20px;
  }
  .company-logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .company-logo img {
    height: 48px;
    width: auto;
  }
  .company-logo-text {
    font-size: 22px;
    font-weight: 800;
    letter-spacing: 0.04em;
    color: #0f172a;
  }
  .company-info {
    text-align: right;
    font-size: 11px;
    color: #4b5563;
    line-height: 1.5;
  }
  .company-name {
    font-size: 14px;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 2px;
  }
  .company-tagline {
    font-size: 10px;
    color: #6b7280;
    font-style: italic;
    margin-top: 4px;
  }

  /* Bill To + Invoice Meta */
  .invoice-meta-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;
  }
  .bill-to {
    font-size: 12px;
  }
  .bill-to-label {
    font-weight: 700;
    color: #374151;
    margin-bottom: 4px;
  }
  .bill-to-name {
    font-size: 14px;
    font-weight: 600;
    color: #111827;
  }
  .bill-to-address {
    color: #4b5563;
    margin-top: 2px;
  }
  .invoice-details {
    text-align: right;
  }
  .invoice-details-row {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-bottom: 3px;
  }
  .invoice-details-label {
    color: #6b7280;
    min-width: 90px;
    text-align: right;
  }
  .invoice-details-value {
    font-weight: 600;
    color: #111827;
    min-width: 100px;
    text-align: right;
  }
  .invoice-details-value.amount {
    font-size: 16px;
    color: #0f172a;
  }

  /* Project Title */
  .project-title {
    font-size: 13px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 12px;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    margin-bottom: 20px;
  }
  thead tr {
    background: #f8fafc;
  }
  th {
    text-align: left;
    padding: 10px 12px;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  th.num { text-align: right; }
  td {
    padding: 8px 12px;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: top;
    color: #374151;
  }
  td.num {
    text-align: right;
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
  }
  tbody tr:nth-child(even) {
    background: #fafbfc;
  }
  tbody tr:hover {
    background: #f3f4f6;
  }

  /* Totals row */
  .totals-row td {
    font-weight: 700;
    background: #f1f5f9;
    border-top: 2px solid #e5e7eb;
    border-bottom: none;
    padding: 12px;
    font-size: 12px;
  }

  /* Section headers */
  .section-header {
    font-size: 12px;
    font-weight: 700;
    color: #1f2937;
    margin: 24px 0 10px 0;
    padding-bottom: 6px;
    border-bottom: 1px solid #e5e7eb;
  }

  /* Group rows */
  .group-row td {
    background: #f1f5f9;
    font-weight: 600;
    color: #1f2937;
    border-bottom: 1px solid #e5e7eb;
  }
  .indent { padding-left: 24px; }

  /* Tags */
  .tag {
    display: inline-block;
    font-size: 9px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    background: #e0e7ff;
    color: #3730a3;
    margin-left: 6px;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  /* Description / Notes */
  .invoice-notes {
    margin-top: 24px;
    padding: 12px 16px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 11px;
    color: #4b5563;
  }
  .invoice-notes-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 4px;
  }

  /* Footer */
  .invoice-footer {
    margin-top: 32px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
    font-size: 10px;
    color: #9ca3af;
    text-align: center;
  }

  /* Print optimizations */
  tr { page-break-inside: avoid; }
  .section-header { page-break-after: avoid; }
  thead { display: table-header-group; }
  @media print {
    tbody tr:nth-child(even) { background: #fafbfc !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    thead tr { background: #f8fafc !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .totals-row td { background: #f1f5f9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }

  /* Attachment images page */
  .attachments-page {
    page-break-before: always;
  }
  .attachments-page-header {
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 2px solid #e5e7eb;
  }
  .attachments-page-subheader {
    font-size: 10px;
    color: #6b7280;
    margin-bottom: 12px;
  }
  .attachments-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  .attachment-item {
    page-break-inside: avoid;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 6px;
    background: #fafafa;
  }
  .attachment-label {
    font-size: 8px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .attachment-image {
    width: 100%;
    height: 1in;
    object-fit: contain;
    border: 1px solid #e5e7eb;
    border-radius: 2px;
    background: #fff;
  }
  .attachment-non-image {
    padding: 8px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 2px;
    font-size: 9px;
    color: #6b7280;
    height: 1in;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
</head>
<body>
${htmlBody}
</body>
</html>`;

    doc.open();
    doc.write(fullHtml);
    doc.close();

    // Print after the iframe has had a moment to lay out.
    window.setTimeout(() => {
      try {
        win.focus();
        win.print();
      } finally {
        // Cleanup later; some browsers are finicky about removing immediately.
        window.setTimeout(() => iframe.remove(), 5000);
      }
    }, 120);
  };

  // Async print function that yields to main thread to avoid blocking
  const printActiveInvoiceAsHtml = async (opts: { layout: "KEEP" | "GROUPED" | "FLAT"; groups: "KEEP" | "COLLAPSE_ALL" | "EXPAND_ALL"; }) => {
    if (!activeInvoice) return;

    busyOverlay.setMessage("Preparing invoice for print…");
    const done = busyOverlay.begin("Preparing invoice for print…");

    try {
      // Yield to let overlay render
      await new Promise((resolve) => requestAnimationFrame(resolve));

    const resolvedLayout: "GROUPED" | "FLAT" =
      opts.layout === "KEEP" ? (invoiceGroupEnabled ? "GROUPED" : "FLAT") : opts.layout;

    const wantGrouped = resolvedLayout === "GROUPED";

    const getGroupKey = (g: any, idx: number) => {
      const rawKey = String(g?.groupKey ?? g?.groupLabel ?? "").trim();
      return rawKey || `__group_${idx}`;
    };

    const openGroups = (() => {
      if (!wantGrouped) return new Set<string>();
      if (opts.groups === "KEEP") return new Set(invoiceGroupOpenBuildings);
      if (opts.groups === "COLLAPSE_ALL") return new Set<string>();

      const all = new Set<string>();
      (invoicePetlGrouped as any[]).forEach((g, idx) => all.add(getGroupKey(g, idx)));
      return all;
    })();

    const invoiceNo = String(activeInvoice.invoiceNo ?? "Draft");
    // Format date as yyyy.mm.dd - HH:mm for filename
    const now = new Date();
    const dateStr = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, "0")}.${String(now.getDate()).padStart(2, "0")} - ${String(now.getHours()).padStart(2, "0")}${String(now.getMinutes()).padStart(2, "0")}`;
    const title = `Invoice ${invoiceNo} ${dateStr}`;

    const logoUrl = `${window.location.origin}/nexus-logo-mark.png`;

    // Build address lines for bill-to
    const billToAddress = [
      activeInvoice.billToAddress ?? "",
      [activeInvoice.billToCity, activeInvoice.billToState, activeInvoice.billToZip].filter(Boolean).join(", "),
    ].filter(s => s.trim()).join("<br>");

    // Project name for title
    const projectName = project?.name ?? "";

    const headerHtml = `
      <!-- Header: Logo + Company Info -->
      <div class="invoice-header">
        <div class="company-logo">
          <img src="${htmlEscape(logoUrl)}" alt="Nexus" />
          <span class="company-logo-text">NEXUS</span>
        </div>
        <div class="company-info">
          <div class="company-name">Nexus Fortified Structures LLC</div>
          <div>123 Construction Way, Suite 100</div>
          <div>Tampa, FL 33601</div>
          <div>Phone: (555) 123-4567</div>
          <div class="company-tagline">Building Excellence, Fortifying Futures</div>
        </div>
      </div>

      <!-- Bill To + Invoice Details -->
      <div class="invoice-meta-row">
        <div class="bill-to">
          <div class="bill-to-label">Bill To:</div>
          <div class="bill-to-name">${htmlEscape(activeInvoice.billToName ?? "")}</div>
          <div class="bill-to-address">${billToAddress || ""}</div>
        </div>
        <div class="invoice-details">
          <div class="invoice-details-row">
            <span class="invoice-details-label">Invoice ID:</span>
            <span class="invoice-details-value">${htmlEscape(invoiceNo)}</span>
          </div>
          <div class="invoice-details-row">
            <span class="invoice-details-label">Amount Due:</span>
            <span class="invoice-details-value amount">${htmlEscape(fmtCurrency(activeInvoice.balanceDue ?? activeInvoice.totalAmount ?? 0))}</span>
          </div>
          <div class="invoice-details-row">
            <span class="invoice-details-label">Due Date:</span>
            <span class="invoice-details-value">${htmlEscape(fmtDate(activeInvoice.dueAt) || "Upon Receipt")}</span>
          </div>
          <div class="invoice-details-row">
            <span class="invoice-details-label">Status:</span>
            <span class="invoice-details-value">${htmlEscape(activeInvoice.status ?? "DRAFT")}</span>
          </div>
        </div>
      </div>

      <!-- Project Title -->
      ${projectName ? `<div class="project-title">${htmlEscape(projectName)}</div>` : ""}
    `;

    const invoiceLinesHtml = (() => {
      const groups = activeInvoiceLineItemGroups;
      if (!groups || groups.length === 0) {
        return ``; // Skip if no manual line items
      }

      const totalAmount = groups.reduce((sum, g) => sum + g.subtotal, 0);

      const rows = groups
        .flatMap((g) => {
          const out: string[] = [];
          out.push(`
            <tr class="group-row">
              <td colspan="4">${htmlEscape(g.label)}</td>
              <td class="num">${htmlEscape(fmtCurrency(g.subtotal))}</td>
            </tr>
          `);

          for (const li of g.items) {
            out.push(`
              <tr>
                <td>${htmlEscape(li?.description ?? "")}</td>
                <td class="num">${li?.qty ?? ""}</td>
                <td>${htmlEscape(li?.unitCode ?? "")}</td>
                <td class="num">${li?.unitPrice ? fmtCurrency(li.unitPrice) : ""}</td>
                <td class="num">${htmlEscape(fmtCurrency(li?.amount ?? 0))}</td>
              </tr>
            `);
          }
          return out;
        })
        .join("\n");

      return `
        <div class="section-header">Additional Line Items</div>
        <table>
          <thead>
            <tr>
              <th>Description</th>
              <th class="num" style="width: 60px">Qty</th>
              <th style="width: 50px">Unit</th>
              <th class="num" style="width: 90px">Unit Price</th>
              <th class="num" style="width: 100px">Amount</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
          <tfoot>
            <tr class="totals-row">
              <td colspan="4">Subtotal</td>
              <td class="num">${htmlEscape(fmtCurrency(totalAmount))}</td>
            </tr>
          </tfoot>
        </table>
      `;
    })();

    const petlHtml = (() => {
      const allLines = activeInvoicePetlLines as any[];
      if (!allLines || allLines.length === 0) {
        return ``; // Skip if no PETL lines
      }

      // Filter out excluded lines
      const lines = allLines.filter((li: any) => {
        const lineId = String(li?.id ?? "");
        return !invoicePrintExcludedLines.has(lineId);
      });

      if (lines.length === 0) {
        return ``; // All lines excluded
      }

      const totalDelta = lines.reduce((sum: number, x: any) => sum + (Number(x?.thisInvTotal ?? 0) || 0), 0);

      // Helper to get field value from a line
      const getFieldValue = (li: any, fieldKey: string): string => {
        switch (fieldKey) {
          case "lineNo":
            return String(li?.sourceLineNoSnapshot ?? li?.lineNoSnapshot ?? "");
          case "categoryCode":
            return String(li?.categoryCodeSnapshot ?? "");
          case "selectionCode":
            return String(li?.selectionCodeSnapshot ?? "");
          case "description":
            return String(li?.descriptionSnapshot ?? "");
          case "room":
            return String(li?.projectParticleLabelSnapshot ?? "");
          case "unit":
            return String(li?.projectUnitLabelSnapshot ?? "");
          case "building":
            return String(li?.projectBuildingLabelSnapshot ?? "");
          case "percentComplete":
            return li?.percentCompleteSnapshot != null ? `${Number(li.percentCompleteSnapshot).toFixed(0)}%` : "";
          case "earnedTotal":
            return fmtCurrency(li?.earnedTotal ?? 0);
          case "prevBilledTotal":
            return fmtCurrency(li?.prevBilledTotal ?? 0);
          case "thisInvTotal":
            return fmtCurrency(li?.thisInvTotal ?? 0);
          case "billingTag":
            return formatBillingTag(getInvoicePetlEffectiveTag(li));
          default:
            return "";
        }
      };

      // Get enabled fields in order
      const enabledFields = INVOICE_PRINT_FIELD_DEFS.filter(f => invoicePrintFields.has(f.key));

      // Determine if we need to group
      const shouldGroup = invoicePrintGroupBy !== "none";

      // Build table headers
      const headerCells = enabledFields.map(f => {
        const isNumeric = ["percentComplete", "earnedTotal", "prevBilledTotal", "thisInvTotal"].includes(f.key);
        return `<th${isNumeric ? ' class="num"' : ''}>${htmlEscape(f.label)}</th>`;
      }).join("");

      // Helper to get group key for a line
      const getLineGroupKey = (li: any): string => {
        switch (invoicePrintGroupBy) {
          case "category":
            return String(li?.categoryCodeSnapshot ?? "(No category)").trim() || "(No category)";
          case "room":
            return String(li?.projectParticleLabelSnapshot ?? "(No room)").trim() || "(No room)";
          case "unit":
            return String(li?.projectUnitLabelSnapshot ?? "(No unit)").trim() || "(No unit)";
          case "building":
            return String(li?.projectBuildingLabelSnapshot ?? "(No building)").trim() || "(No building)";
          default:
            return "";
        }
      };

      // Build row HTML for a single line
      const buildLineRow = (li: any, indent = false): string => {
        const cells = enabledFields.map(f => {
          const isNumeric = ["percentComplete", "earnedTotal", "prevBilledTotal", "thisInvTotal"].includes(f.key);
          const value = getFieldValue(li, f.key);
          const className = isNumeric ? ' class="num"' : (indent && f.key === enabledFields[0]?.key ? ' class="indent"' : '');
          return `<td${className}>${htmlEscape(value)}</td>`;
        }).join("");
        return `<tr>${cells}</tr>`;
      };

      if (shouldGroup) {
        // Group lines
        const groupedMap = new Map<string, any[]>();
        for (const li of lines) {
          const gk = getLineGroupKey(li);
          const bucket = groupedMap.get(gk) ?? [];
          bucket.push(li);
          groupedMap.set(gk, bucket);
        }

        // Sort groups by first line number in each group
        const groups = Array.from(groupedMap.entries())
          .map(([key, groupLines]) => ({
            key,
            lines: groupLines.sort((a, b) => Number(a?.lineNoSnapshot ?? 0) - Number(b?.lineNoSnapshot ?? 0)),
            subtotal: groupLines.reduce((s, l) => s + (Number(l?.thisInvTotal ?? 0) || 0), 0),
          }))
          .sort((a, b) => {
            const aMin = Number(a.lines[0]?.lineNoSnapshot ?? 0);
            const bMin = Number(b.lines[0]?.lineNoSnapshot ?? 0);
            return aMin - bMin;
          });

        const rows = groups.flatMap(g => {
          const out: string[] = [];
          // Group header row
          const colSpan = enabledFields.length - 1;
          out.push(`
            <tr class="group-row">
              <td colspan="${colSpan}">${htmlEscape(g.key)}</td>
              <td class="num">${htmlEscape(fmtCurrency(g.subtotal))}</td>
            </tr>
          `);
          // Line rows
          for (const li of g.lines) {
            out.push(buildLineRow(li, true));
          }
          return out;
        }).join("\n");

        return `
          <div class="section-header">Estimate Line Items</div>
          <table>
            <thead>
              <tr>${headerCells}</tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
            <tfoot>
              <tr class="totals-row">
                <td colspan="${enabledFields.length - 1}">Totals:</td>
                <td class="num">${htmlEscape(fmtCurrency(totalDelta))}</td>
              </tr>
            </tfoot>
          </table>
        `;
      }

      // Flat view
      const sorted = [...lines].sort((a: any, b: any) => {
        const la = Number(a?.lineNoSnapshot ?? 0);
        const lb = Number(b?.lineNoSnapshot ?? 0);
        return la - lb;
      });

      const rows = sorted.map((li: any) => buildLineRow(li)).join("\n");

      return `
        <div class="section-header">Estimate Line Items</div>
        <table>
          <thead>
            <tr>${headerCells}</tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
          <tfoot>
            <tr class="totals-row">
              <td colspan="${enabledFields.length - 1}">Totals:</td>
              <td class="num">${htmlEscape(fmtCurrency(totalDelta))}</td>
            </tr>
          </tfoot>
        </table>
      `;
    })();

    // Memo / Notes section
    const memoHtml = activeInvoice.memo?.trim()
      ? `
        <div class="invoice-notes">
          <div class="invoice-notes-label">Description of Invoice</div>
          <div>${htmlEscape(activeInvoice.memo)}</div>
        </div>
      `
      : ``;

    // Attachments section (list on page 1)
    const attachmentsListHtml = (() => {
      const attachments = Array.isArray(activeInvoice?.attachments) ? activeInvoice.attachments : [];
      if (attachments.length === 0) return ``;
      const attachList = attachments.map((a: any) => `<li>${htmlEscape(String(a?.fileName ?? "Attachment"))}</li>`).join("\n");
      return `
        <div class="invoice-notes" style="margin-top: 16px;">
          <div class="invoice-notes-label">Supporting Documents (see attached)</div>
          <ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 11px;">
            ${attachList}
          </ul>
        </div>
      `;
    })();

    // Attachment images section (page 2+)
    const attachmentImagesHtml = (() => {
      // Collect all attachments: direct invoice attachments + bill attachments from line items
      const directAttachments = Array.isArray(activeInvoice?.attachments) ? activeInvoice.attachments : [];
      
      // Get bill attachments from line items that have a sourceBill
      const billAttachments: any[] = [];
      const lineItems = Array.isArray(activeInvoice?.lineItems) ? activeInvoice.lineItems : [];
      for (const li of lineItems) {
        const bill = li?.sourceBill;
        if (bill && Array.isArray(bill.attachments)) {
          for (const att of bill.attachments) {
            // Add vendor info to help identify the attachment
            billAttachments.push({
              ...att,
              _billVendor: bill.vendorName,
              _billNumber: bill.billNumber,
            });
          }
        }
      }
      
      const allAttachments = [...directAttachments, ...billAttachments];
      
      // Filter to only include image attachments that can be displayed
      const displayableAttachments = allAttachments.filter((a: any) => {
        const mime = String(a?.mimeType ?? "").toLowerCase();
        const fileName = String(a?.fileName ?? "").toLowerCase();
        // Support common image formats
        return (
          mime.startsWith("image/") ||
          fileName.endsWith(".jpg") ||
          fileName.endsWith(".jpeg") ||
          fileName.endsWith(".png") ||
          fileName.endsWith(".gif") ||
          fileName.endsWith(".webp")
        );
      });

      if (displayableAttachments.length === 0) return ``;

      const invoiceNo = String(activeInvoice.invoiceNo ?? "Draft");

      const attachmentItems = displayableAttachments.map((a: any, idx: number) => {
        const fileName = String(a?.fileName ?? `Attachment ${idx + 1}`);
        const fileUrl = String(a?.fileUrl ?? "");
        // For bill attachments, show vendor name
        const billInfo = a?._billVendor ? `${a._billVendor}${a._billNumber ? ` #${a._billNumber}` : ""}` : null;
        const label = billInfo ? `${billInfo} - ${fileName}` : fileName;
        
        return `
          <div class="attachment-item">
            <div class="attachment-label" title="${htmlEscape(label)}">${htmlEscape(label)}</div>
            <img src="${htmlEscape(fileUrl)}" alt="${htmlEscape(label)}" class="attachment-image" />
          </div>
        `;
      }).join("\n");

      return `
        <div class="attachments-page">
          <div class="attachments-page-header">Supporting Documents</div>
          <div class="attachments-page-subheader">Invoice ${htmlEscape(invoiceNo)} — ${htmlEscape(project?.name ?? "")}</div>
          <div class="attachments-grid">
            ${attachmentItems}
          </div>
        </div>
      `;
    })();

    // Footer
    const footerHtml = `
      <div class="invoice-footer">
        Thank you for your business. Payment is due upon receipt unless otherwise specified.
      </div>
    `;

    // Yield before final print
    await new Promise((resolve) => setTimeout(resolve, 0));

    const body = `${headerHtml}\n${petlHtml}\n${invoiceLinesHtml}\n${memoHtml}\n${attachmentsListHtml}\n${footerHtml}\n${attachmentImagesHtml}`;
    printHtmlDocument(title, body);
    } finally {
      done();
    }
  };

  const extractUnitGroupCode = (label: any) => {
    const s = String(label ?? "").trim();
    if (!s) return null;

    // e.g. "RISK__E - Risk - Exterior" or "ELECTRI — Electrical Room"
    // Note: group codes often contain underscores.
    const dashMatch = s.match(/^([A-Za-z0-9_]+)\s*[-–—].+$/);
    if (dashMatch) return dashMatch[1];

    // e.g. "RISK__E" or "ELECTRI Electrical Room" (building label is "CODE NAME")
    const firstToken = s.split(/\s+/)[0] ?? "";
    if (/^[A-Z0-9_]{3,}$/.test(firstToken)) return firstToken;

    return null;
  };

  const getInvoiceGroupLabels = (l: any) => {
    const buildingRaw = String(l?.projectBuildingLabelSnapshot ?? "").trim();
    const unitRaw = String(l?.projectUnitLabelSnapshot ?? "").trim();
    const roomRaw = String(l?.projectParticleLabelSnapshot ?? "").trim();

    const groupCode =
      extractUnitGroupCode(buildingRaw) ??
      extractUnitGroupCode(unitRaw) ??
      extractUnitGroupCode(roomRaw) ??
      null;

    const stripPrefix = (raw: string) => {
      if (!groupCode || !raw) return raw;
      const esc = groupCode.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&");
      const m = raw.match(new RegExp(`^${esc}\\s*[-–—]\\s*(.+)$`));
      return m?.[1] ? String(m[1]).trim() : raw;
    };

    const unit = stripPrefix(unitRaw) || null;
    const room = stripPrefix(roomRaw) || null;

    return {
      groupCode: groupCode || null,
      building: buildingRaw || null,
      unit,
      room,
    };
  };

  const activeInvoiceLineItemGroups = useMemo(() => {
    const items = Array.isArray(activeInvoice?.lineItems) ? activeInvoice.lineItems : [];

    const order = ["MANUAL", "BILLABLE_HOURS", "EQUIPMENT_RENTAL", "COST_BOOK", "OTHER"];
    const labelByKind: Record<string, string> = {
      MANUAL: "Manual",
      BILLABLE_HOURS: "Billable hours",
      EQUIPMENT_RENTAL: "Equipment rental",
      COST_BOOK: "From Cost Book",
      OTHER: "Other",
    };

    const groups = new Map<string, any[]>();
    for (const it of items) {
      const kind = String(it?.kind ?? "MANUAL").trim().toUpperCase() || "MANUAL";
      const bucket = groups.get(kind) ?? [];
      bucket.push(it);
      groups.set(kind, bucket);
    }

    const seen = new Set(order);
    const remainingKinds = [...groups.keys()]
      .filter((k) => !seen.has(k))
      .sort((a, b) => a.localeCompare(b));

    return [...order, ...remainingKinds]
      .map((kind) => {
        const groupItems = groups.get(kind) ?? [];
        const subtotal = groupItems.reduce(
          (sum, li) => sum + (Number(li?.amount ?? 0) || 0),
          0,
        );
        return {
          kind,
          label: labelByKind[kind] ?? kind,
          items: groupItems,
          subtotal,
        };
      })
      .filter((g) => g.items.length > 0);
  }, [activeInvoice?.lineItems]);

  const submitBaselinePetlFromCostBook = async (selection: CostBookSelection[]) => {
    if (!project) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setPetlBaselineMessage("Missing access token.");
      return;
    }

    if (!selection || selection.length === 0) {
      setPetlBaselineMessage("No cost book items selected.");
      return;
    }

    setPetlBaselineMessage(null);
    setPetlBaselineCostBookPickerBusy(true);

    try {
      const lines = selection.map((sel) => ({
        companyPriceListItemId: sel.item.id,
        qty: sel.qty,
      }));

      const body: any = { lines };
      const loc = petlBaselineLocation.trim();
      if (loc) body.locationDescription = loc;

      const res = await fetch(`${API_BASE}/projects/${project.id}/petl/add-from-cost-book`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        setPetlBaselineMessage(
          `Create PETL from Cost Book failed (${res.status}) ${text}`.trim(),
        );
        return;
      }

      // Best effort: ignore payload details; rely on existing PETL reload path.
      await res.json().catch(() => null);

      setPetlReloadTick((t) => t + 1);
      setPetlBaselineCostBookPickerOpen(false);
      setPetlBaselineMessage("Created PETL from Cost Book.");
    } catch (err: any) {
      setPetlBaselineMessage(err?.message ?? "Failed to create PETL from Cost Book.");
    } finally {
      setPetlBaselineCostBookPickerBusy(false);
    }
  };

  const submitAddInvoiceLinesFromCostBook = async (selection: CostBookSelection[]) => {
    if (!project) return;

    if (!activeInvoice || activeInvoice.status !== "DRAFT") {
      setInvoiceMessage("Open a draft invoice first (Open living invoice), then add Cost Book lines.");
      return;
    }

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setInvoiceMessage("Missing access token.");
      return;
    }

    if (!selection || selection.length === 0) {
      setInvoiceMessage("No cost book items selected.");
      return;
    }

    setInvoiceMessage(null);
    setInvoiceCostBookPickerBusy(true);

    try {
      let lastInvoiceJson: any = null;

      // Add sequentially to preserve a predictable line ordering.
      for (const sel of selection) {
        const item = sel.item;
        const qty = sel.qty;

        const cat = String(item.cat ?? "").trim();
        const selCode = String(item.sel ?? "").trim();
        const baseDesc = String(item.description ?? "").trim();
        const prefix = cat || selCode ? `${cat}${selCode ? `/${selCode}` : ""}` : "";
        const description = prefix ? `${prefix}${baseDesc ? ` - ${baseDesc}` : ""}` : baseDesc;

        const unitPrice =
          typeof item.unitPrice === "number" && Number.isFinite(item.unitPrice) ? item.unitPrice : 0;

        const res = await fetch(
          `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/lines`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              description: description || "(Cost Book item)",
              kind: "COST_BOOK",
              companyPriceListItemId: item.id,
              qty,
              unitPrice,
            }),
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Failed to add cost book line (${res.status}) ${text}`);
        }

        lastInvoiceJson = await res.json();
      }

      if (lastInvoiceJson) {
        setActiveInvoice(lastInvoiceJson);
        setProjectInvoices(null);
      }

      setInvoiceMessage(`Added ${selection.length} cost book line(s).`);
      setInvoiceCostBookPickerOpen(false);
    } catch (err: any) {
      setInvoiceMessage(err?.message ?? "Failed to add cost book lines.");
    } finally {
      setInvoiceCostBookPickerBusy(false);
    }
  };

  const toggleInvoiceBuildingOpen = useCallback((buildingKey: string) => {
    // Use startTransition to avoid blocking UI during large re-renders
    React.startTransition(() => {
      setInvoiceGroupOpenBuildings((prev) => {
        const next = new Set(prev);
        if (next.has(buildingKey)) next.delete(buildingKey);
        else next.add(buildingKey);
        return next;
      });
    });
  }, []);



  const invoicePetlBillingTagById = useMemo(() => {
    const map = new Map<string, string>();
    for (const l of activeInvoicePetlLines) {
      const id = String(l?.id ?? "").trim();
      if (!id) continue;
      const tag = String(l?.billingTag ?? "NONE").trim() || "NONE";
      map.set(id, tag);
    }
    return map;
  }, [activeInvoicePetlLines]);

  const getInvoicePetlEffectiveTag = (line: any): string => {
    const tag = String(line?.billingTag ?? "NONE").trim() || "NONE";
    if (tag !== "NONE") return tag;

    const parentId = String(line?.parentLineId ?? "").trim();
    if (!parentId) return "NONE";

    const parentTag = invoicePetlBillingTagById.get(parentId) ?? "NONE";
    return parentTag || "NONE";
  };

  const formatBillingTag = useCallback((tag: string) => {
    switch (tag) {
      case "PETL_LINE_ITEM":
        return "PETL Line Item";
      case "CHANGE_ORDER":
        return "Change Order";
      case "SUPPLEMENT":
        return "Supplement";
      case "WARRANTY":
        return "Warranty";
      default:
        return "";
    }
  }, []);

  // Memoized callback wrappers for virtualized invoice PETL table
  const handleStartInvoicePetlTagEdit = useCallback((lineId: string, currentTag: string) => {
    setInvoicePetlTagEditingLineId(lineId);
    setInvoicePetlTagDraft(currentTag);
  }, []);

  const handleInvoicePetlTagDraftChange = useCallback((value: string) => {
    setInvoicePetlTagDraft(value);
  }, []);

  const handleCancelInvoicePetlTagEdit = useCallback(() => {
    setInvoicePetlTagEditingLineId(null);
  }, []);

  const handleSaveInvoicePetlTag = useCallback(async (lineId: string) => {
    if (!project || !activeInvoice?.id || !lineId) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setInvoiceMessage("Missing access token.");
      return;
    }
    setInvoicePetlTagSaving(true);
    setInvoiceMessage(null);
    try {
      const res = await fetch(
        `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/petl-lines/${lineId}`,
        {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ billingTag: invoicePetlTagDraft }),
        },
      );
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        setInvoiceMessage(`Update failed (${res.status}) ${text}`);
        return;
      }
      const updated = await res.json().catch(() => null);
      setActiveInvoice((prev: any) => {
        if (!prev) return prev;
        const lines = Array.isArray(prev.petlLines) ? prev.petlLines : [];
        return {
          ...prev,
          petlLines: lines.map((x: any) =>
            x?.id === updated?.id ? { ...x, ...updated } : x,
          ),
        };
      });
      setInvoicePetlTagEditingLineId(null);
    } catch (err: any) {
      setInvoiceMessage(err?.message ?? "Update failed.");
    } finally {
      setInvoicePetlTagSaving(false);
    }
  }, [project, activeInvoice?.id, invoicePetlTagDraft]);

  // Memoized getters for virtualized component
  const getInvoiceLineBackgroundMemo = useCallback((li: any): string => {
    const tag = getInvoicePetlEffectiveTag(li);
    const kind = String(li?.kind ?? "");
    if (kind === "ACV" || kind === "ACV_HOLDBACK_CREDIT") return "#fef9c3";
    if (tag === "SUPPLEMENT") return "#dbeafe";
    if (tag === "CHANGE_ORDER" || tag === "SUPPLEMENT_CREDIT" || tag === "CO_CREDIT") return "#dbeafe";
    return "transparent";
  }, [invoicePetlBillingTagById]);

  const getInvoicePetlEffectiveTagMemo = useCallback((line: any): string => {
    const tag = String(line?.billingTag ?? "NONE").trim() || "NONE";
    if (tag !== "NONE") return tag;
    const parentId = String(line?.parentLineId ?? "").trim();
    if (!parentId) return "NONE";
    const parentTag = invoicePetlBillingTagById.get(parentId) ?? "NONE";
    return parentTag || "NONE";
  }, [invoicePetlBillingTagById]);

  const visibleInvoicePetlLines = useMemo(() => {
    if (invoicePetlView === "ALL") return activeInvoicePetlLines;
    const out: any[] = [];
    for (const li of activeInvoicePetlLines as any[]) {
      const kind = String(li?.kind ?? "").trim();
      const effTag = getInvoicePetlEffectiveTag(li);

      if (invoicePetlView === "CARRIER") {
        if (
          kind === "BASE" &&
          (effTag === "PETL_LINE_ITEM" || effTag === "SUPPLEMENT")
        ) {
          out.push(li);
        }
      } else if (invoicePetlView === "CLIENT") {
        if (
          kind === "ACV_HOLDBACK_CREDIT" ||
          effTag === "CHANGE_ORDER"
        ) {
          out.push(li);
        }
      } else if (invoicePetlView === "SUPPLEMENTS") {
        // Only supplements (not credits)
        if (effTag === "SUPPLEMENT") {
          out.push(li);
        }
      } else if (invoicePetlView === "CHANGE_ORDERS") {
        // Change orders + credits (supplement credits, CO credits, ACV credits)
        if (effTag === "CHANGE_ORDER" || effTag === "SUPPLEMENT_CREDIT" || effTag === "CO_CREDIT" || kind === "ACV_HOLDBACK_CREDIT") {
          out.push(li);
        }
      } else if (invoicePetlView === "ACV_REBATES") {
        // Only ACV items
        if (kind === "ACV_HOLDBACK_CREDIT" || kind === "ACV") {
          out.push(li);
        }
      }
    }
    return out;
  }, [activeInvoicePetlLines, invoicePetlView]);

  const { petlCarrierTotal, petlClientTotal } = useMemo(() => {
    let carrier = 0;
    let client = 0;

    for (const li of activeInvoicePetlLines as any[]) {
      const val = Number(li?.thisInvTotal ?? 0) || 0;
      if (!Number.isFinite(val)) continue;
      const kind = String(li?.kind ?? "").trim();
      const effTag = getInvoicePetlEffectiveTag(li);

      // Carrier: BASE PETL + SUPPLEMENT lines (no ACV credits, no change orders)
      if (
        kind === "BASE" &&
        (effTag === "PETL_LINE_ITEM" || effTag === "SUPPLEMENT")
      ) {
        carrier += val;
      }

      // Client: ACV holdback credits + Change Orders
      if (
        kind === "ACV_HOLDBACK_CREDIT" ||
        effTag === "CHANGE_ORDER"
      ) {
        client += val;
      }
    }

    return { petlCarrierTotal: carrier, petlClientTotal: client };
  }, [activeInvoicePetlLines]);

  const visiblePetlTotal = useMemo(
    () =>
      visibleInvoicePetlLines.reduce(
        (sum: number, li: any) => sum + (Number(li?.thisInvTotal ?? 0) || 0),
        0,
      ),
    [visibleInvoicePetlLines],
  );

  const invoicePetlGrouped = useMemo(() => {
    type Line = any;
    type Group = { groupKey: string; groupLabel: string; lines: Line[]; subtotal: number };

    // Goal: make Unit 01..15 the primary groups (no synthetic "Estimate line items" group row).
    // If a line has no Unit snapshot, fall back to group code / building label.
    const byGroup = new Map<string, Line[]>();

    for (const l of visibleInvoicePetlLines) {
      const meta = getInvoiceGroupLabels(l);

      const unitLabel = String(meta.unit ?? "").trim();
      const fallbackLabel =
        String(meta.groupCode ?? "").trim() ||
        String(meta.building ?? "").trim() ||
        "(No unit)";

      const groupLabel = unitLabel || fallbackLabel;
      const groupKey = groupLabel;

      const bucket = byGroup.get(groupKey) ?? [];
      bucket.push(l);
      byGroup.set(groupKey, bucket);
    }

    const groups: Group[] = [];

    // Helper to parse displayLineNo for sorting (handles "1", "1.001", "2", etc.)
    const parseDisplayLineNo = (li: any): number[] => {
      const display = String(li?.displayLineNo ?? li?.lineNoSnapshot ?? "0");
      return display.split(".").map(p => Number(p) || 0);
    };

    const compareDisplayLineNo = (a: any, b: any): number => {
      const aParts = parseDisplayLineNo(a);
      const bParts = parseDisplayLineNo(b);
      for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
        const aVal = aParts[i] ?? 0;
        const bVal = bParts[i] ?? 0;
        if (aVal !== bVal) return aVal - bVal;
      }
      // Fallback to kind for ties
      const ka = String(a?.kind ?? "");
      const kb = String(b?.kind ?? "");
      return ka.localeCompare(kb);
    };

    for (const [groupKey, lines] of byGroup.entries()) {
      // Sort lines within each group by displayLineNo (1, 1.001, 1.002, 2, etc.)
      const sorted = [...lines].sort(compareDisplayLineNo);

      const subtotal = sorted.reduce((sum, x) => sum + (Number(x?.thisInvTotal ?? 0) || 0), 0);

      // Track the minimum line number in this group for sorting groups
      const minLineNo = sorted.length > 0 ? parseDisplayLineNo(sorted[0])[0] : 0;

      groups.push({ groupKey, groupLabel: groupKey, lines: sorted, subtotal, minLineNo } as any);
    }

    // Sort groups by their minimum line number so they appear in estimate order
    groups.sort((a, b) => {
      const aMin = (a as any).minLineNo ?? 0;
      const bMin = (b as any).minLineNo ?? 0;
      return aMin - bMin;
    });

    return groups;
  }, [visibleInvoicePetlLines]);

  const [newInvoiceLineKind, setNewInvoiceLineKind] = useState<string>("MANUAL");
  const [newInvoiceLineBillingTag, setNewInvoiceLineBillingTag] = useState<string>("NONE");
  const [newInvoiceLineDesc, setNewInvoiceLineDesc] = useState("");
  const [newInvoiceLineQty, setNewInvoiceLineQty] = useState<string>("");
  const [newInvoiceLineUnitCode, setNewInvoiceLineUnitCode] = useState<string>("");
  const [newInvoiceLineUnitPrice, setNewInvoiceLineUnitPrice] = useState<string>("");
  const [newInvoiceLineAmount, setNewInvoiceLineAmount] = useState<string>("");

  // Company unit codes (editable dropdown list)
  const [companyUnitCodes, setCompanyUnitCodes] = useState<{ id: string; code: string; label: string | null }[] | null>(null);
  const [unitCodeManageOpen, setUnitCodeManageOpen] = useState(false);
  const [unitCodeEditId, setUnitCodeEditId] = useState<string | null>(null);
  const [unitCodeEditCode, setUnitCodeEditCode] = useState("");
  const [unitCodeEditLabel, setUnitCodeEditLabel] = useState("");
  const [unitCodeSaving, setUnitCodeSaving] = useState(false);

  const [invoiceCostBookPickerOpen, setInvoiceCostBookPickerOpen] = useState(false);
  const [invoiceCostBookPickerBusy, setInvoiceCostBookPickerBusy] = useState(false);

  const [issueBillToName, setIssueBillToName] = useState<string>("");
  const [issueBillToEmail, setIssueBillToEmail] = useState<string>("");
  const [issueMemo, setIssueMemo] = useState<string>("");
  const [issueDueAt, setIssueDueAt] = useState<string>("");

  // Invoice issue preview modal state
  const [invoiceIssuePreviewOpen, setInvoiceIssuePreviewOpen] = useState(false);
  const [invoiceIssueSaving, setInvoiceIssueSaving] = useState(false);

  // Default bill-to fields to project primary contact when opening a draft invoice
  useEffect(() => {
    if (!activeInvoice || activeInvoice.status !== "DRAFT") return;
    // Only set defaults if the fields are empty
    if (!issueBillToName && project?.primaryContactName) {
      setIssueBillToName(project.primaryContactName);
    }
    if (!issueBillToEmail && project?.primaryContactEmail) {
      setIssueBillToEmail(project.primaryContactEmail);
    }
  }, [activeInvoice?.id, project?.primaryContactName, project?.primaryContactEmail]);

  const [payAmount, setPayAmount] = useState<string>("");
  const [payMethod, setPayMethod] = useState<string>("ACH");
  const [payPaidAt, setPayPaidAt] = useState<string>("");
  const [payReference, setPayReference] = useState<string>("");
  const [payNote, setPayNote] = useState<string>("");
  const [recordPaymentSaving, setRecordPaymentSaving] = useState(false);

  const [projectPayments, setProjectPayments] = useState<any[] | null>(null);
  const [projectPaymentsLoading, setProjectPaymentsLoading] = useState(false);
  const [projectPaymentsError, setProjectPaymentsError] = useState<string | null>(null);

  // Reduce noise: keep the Payments card collapsed by default (persisted per project).
  const paymentsCollapsedStorageKey = `financialPaymentsCollapsed:v1:${id}`;
  const [paymentsCollapsed, setPaymentsCollapsed] = useState<boolean>(() => {
    if (typeof window === "undefined") return true;
    const raw = window.localStorage.getItem(paymentsCollapsedStorageKey);
    if (raw === "0") return false;
    if (raw === "1") return true;
    return true;
  });

  useEffect(() => {
    if (typeof window === "undefined") return;
    window.localStorage.setItem(paymentsCollapsedStorageKey, paymentsCollapsed ? "1" : "0");
  }, [paymentsCollapsedStorageKey, paymentsCollapsed]);

  // Apply UI (per payment)
  const [applyInvoiceByPaymentId, setApplyInvoiceByPaymentId] = useState<Record<string, string>>({});
  const [applyAmountByPaymentId, setApplyAmountByPaymentId] = useState<Record<string, string>>({});
  const [applySavingPaymentId, setApplySavingPaymentId] = useState<string | null>(null);
  const [applyMessageByPaymentId, setApplyMessageByPaymentId] = useState<Record<string, string>>({});

  const projectPaymentsSorted = useMemo(() => {
    const payments = projectPayments;
    if (!Array.isArray(payments)) return [];

    const sortKey = (p: any) => {
      const raw = p?.paidAt ?? p?.createdAt ?? null;
      const t = raw ? new Date(raw).getTime() : 0;
      return Number.isFinite(t) ? t : 0;
    };

    return [...payments].sort((a, b) => sortKey(b) - sortKey(a));
  }, [projectPayments]);

  const projectPaymentsTotal = useMemo(() => {
    return projectPaymentsSorted.reduce((sum, p: any) => sum + (Number(p?.amount ?? 0) || 0), 0);
  }, [projectPaymentsSorted]);

  const projectPaymentsUnappliedTotal = useMemo(() => {
    return projectPaymentsSorted.reduce(
      (sum, p: any) => sum + (Number(p?.unappliedAmount ?? 0) || 0),
      0,
    );
  }, [projectPaymentsSorted]);

  // Payroll roster (who has been paid on this project, including subs/1099s)
  const [payrollEmployees, setPayrollEmployees] = useState<ProjectEmployee[] | null>(null);
  const [payrollLoading, setPayrollLoading] = useState(false);
  const [payrollError, setPayrollError] = useState<string | null>(null);

  // Actor identity + project-level roles (for header display)
  const [actorDisplayName, setActorDisplayName] = useState<string | null>(null);
  const [actorProjectRoles, setActorProjectRoles] = useState<string[] | null>(null);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);

  const isPmOrAbove = useMemo(() => {
    const projectRoleOk =
      (actorProjectRoles ?? []).includes("OWNER") || (actorProjectRoles ?? []).includes("MANAGER");
    const companyRoleOk = actorCompanyRole === "OWNER" || actorCompanyRole === "ADMIN";
    const globalOk = actorGlobalRole === "SUPER_ADMIN";
    return globalOk || companyRoleOk || projectRoleOk;
  }, [actorProjectRoles, actorCompanyRole, actorGlobalRole]);

  const isAdminOrAbove = useMemo(() => {
    const companyRoleOk = actorCompanyRole === "OWNER" || actorCompanyRole === "ADMIN";
    const globalOk = actorGlobalRole === "SUPER_ADMIN";
    return globalOk || companyRoleOk;
  }, [actorCompanyRole, actorGlobalRole]);

  const [petlDiagnosticsModalOpen, setPetlDiagnosticsModalOpen] = useState(false);

  const deletePetlLineItem = async (item: PetlItem) => {
    // (kept in this file; this is invoked from the PETL UI itself)
    if (!isAdminOrAbove) {
      alert("Only Admin+ can delete PETL line items.");
      return;
    }

    const displayLineNo =
      item.sourceLineNo && item.sourceLineNo > 0 ? item.sourceLineNo : item.lineNo;

    const ok = window.confirm(
      `Delete PETL line #${displayLineNo}?\n\nThis will permanently remove the line item and associated reconciliation/edit history for this line.`,
    );
    if (!ok) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token.");
      return;
    }

    try {
      await busyOverlay.run(`Deleting line #${displayLineNo}…`, async () => {
        const res = await fetch(`${API_BASE}/projects/${id}/petl/${item.id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          alert(`Delete failed (${res.status}). ${text || ""}`.trim());
          return;
        }

        // Update local UI immediately.
        setPetlItems((prev) => prev.filter((it) => it.id !== item.id));
        setPetlReconActivityIds((prev) => {
          const next = new Set(prev);
          next.delete(item.id);
          return next;
        });
        setPetlReconFlagIds((prev) => {
          const next = new Set(prev);
          next.delete(item.id);
          return next;
        });

        setPetlReconPanel((prev) =>
          prev.open && prev.sowItemId === item.id ? { ...prev, open: false } : prev,
        );

        // Refresh PETL + groups + summary from server.
        setPetlReloadTick((t) => t + 1);
      });
    } catch (err: any) {
      alert(err?.message ?? "Delete failed.");
    }
  };

  const handlePetlWipeSuccess = useCallback(() => {
    // Reset local PETL state immediately.
    setPetlItems([]);
    setPetlReconciliationEntries([]);
    setPetlReconActivityIds(new Set());
    setGroups([]);
    setUnitGroups([]);
    setSelectionSummary(null);
    setPetlItemCount(0);
    setPetlTotalAmount(0);
    setComponentsCount(0);
    setPetlReconFlagIds(new Set());

    setPetlReconPanel((prev) => (prev.open ? { ...prev, open: false } : prev));

    // Reload summary endpoints.
    setPetlReloadTick((t) => t + 1);
  }, []);

  const [dailyLogs, setDailyLogs] = useState<DailyLog[]>([]);
  const [dailyLogsLoading, setDailyLogsLoading] = useState(false);
  const [dailyLogSaving, setDailyLogSaving] = useState(false);
  const [dailyLogMessage, setDailyLogMessage] = useState<string | null>(null);
  const [attachmentsUploading, setAttachmentsUploading] = useState(false);
  const [showPendingClientOnly, setShowPendingClientOnly] = useState(false);

  // Edit daily log modal state
  const [editDailyLog, setEditDailyLog] = useState<{
    open: boolean;
    log: DailyLog | null;
    draft: NewDailyLogState | null;
    saving: boolean;
    error: string | null;
  }>({ open: false, log: null, draft: null, saving: false, error: null });

  // View daily log modal state (with inline edit)
  const [viewDailyLog, setViewDailyLog] = useState<{
    open: boolean;
    log: DailyLog | null;
    draft: NewDailyLogState | null;
    editing: boolean;
    saving: boolean;
    error: string | null;
  }>({ open: false, log: null, draft: null, editing: false, saving: false, error: null });

  // Reassign daily log state
  const [reassignDailyLog, setReassignDailyLog] = useState<{
    open: boolean;
    logId: string | null;
    logTitle: string | null;
    targetProjectId: string;
    availableProjects: { id: string; name: string }[];
    loading: boolean;
    saving: boolean;
    error: string | null;
  }>({ open: false, logId: null, logTitle: null, targetProjectId: "", availableProjects: [], loading: false, saving: false, error: null });

  // Attachments viewer modal state (gallery with navigation)
  const [attachmentsViewer, setAttachmentsViewer] = useState<{
    open: boolean;
    log: DailyLog | null;
    currentIndex: number;
  }>({ open: false, log: null, currentIndex: 0 });

  // Debug: log whenever attachmentsViewer changes
  useEffect(() => {
    console.log('[GALLERY] attachmentsViewer state changed:', { open: attachmentsViewer.open, hasLog: !!attachmentsViewer.log, currentIndex: attachmentsViewer.currentIndex });
  }, [attachmentsViewer]);

  // PETL update modal (from Edit Daily Log)
  const [petlUpdateModal, setPetlUpdateModal] = useState<{
    open: boolean;
    log: DailyLog | null;
    percentComplete: string;
    saving: boolean;
    error: string | null;
  }>({ open: false, log: null, percentComplete: "", saving: false, error: null });

  // Drag state for Edit Daily Log attachments drop zone
  const [editLogDragOver, setEditLogDragOver] = useState(false);
  // Drag state for View Daily Log (edit mode) attachments drop zone
  const [viewLogDragOver, setViewLogDragOver] = useState(false);

  // Field PETL
  const [fieldPetlItems, setFieldPetlItems] = useState<FieldPetlItem[]>([]);
  const [fieldPetlLoading, setFieldPetlLoading] = useState(false);
  const [fieldPetlError, setFieldPetlError] = useState<string | null>(null);
  const [fieldPetlEdit, setFieldPetlEdit] = useState<FieldPetlEditState | null>(null);
  const [fieldPetlOrgGroupFilters, setFieldPetlOrgGroupFilters] = useState<string[]>([]);
  // Person/s onsite multi-select state for Daily Logs
  const [personOnsiteList, setPersonOnsiteList] = useState<string[]>([]);
  const [personOnsiteDraft, setPersonOnsiteDraft] = useState<string>("");
  const [personOnsiteGroups, setPersonOnsiteGroups] = useState<
    { id: string; name: string; members: string[] }[]
  >([]);
  const [selectedPersonOnsiteGroupId, setSelectedPersonOnsiteGroupId] = useState<string>("");
  // When launched from PETL, capture context for a new PUDL
  const [pudlContext, setPudlContext] = useState<{
    open: boolean;
    buildingId: string | null;
    unitId: string | null;
    roomParticleId: string | null;
    sowItemId: string | null;
    breadcrumb: string | null;
  }>({ open: false, buildingId: null, unitId: null, roomParticleId: null, sowItemId: null, breadcrumb: null });

  const [roomComponentsPanel, setRoomComponentsPanel] = useState<{
    open: boolean;
    loading: boolean;
    error: string | null;
    roomName: string;
    components: RoomComponentAgg[];
  }>({ open: false, loading: false, error: null, roomName: "", components: [] });

  // PETL reconciliation drawer
  const [petlReconPanel, setPetlReconPanel] = useState<{
    open: boolean;
    sowItemId: string | null;
    loading: boolean;
    error: string | null;
    data: any | null;
  }>({ open: false, sowItemId: null, loading: false, error: null, data: null });

  const [reconCreditComponents, setReconCreditComponents] = useState<{
    itemAmount: boolean;
    salesTaxAmount: boolean;
    opAmount: boolean;
  }>({ itemAmount: true, salesTaxAmount: true, opAmount: true });

  const [reconNote, setReconNote] = useState<string>("");

  type ReconEntryTag = "" | "SUPPLEMENT" | "CHANGE_ORDER" | "OTHER" | "WARRANTY";
  const [reconEntryTag, setReconEntryTag] = useState<ReconEntryTag>("");

  const [reconPlaceholderKind, setReconPlaceholderKind] = useState<string>("NOTE_ONLY");
  const [reconTagShake, setReconTagShake] = useState(false);

  useEffect(() => {
    if (!reconTagShake) return;
    const id = window.setTimeout(() => setReconTagShake(false), 200);
    return () => window.clearTimeout(id);
  }, [reconTagShake]);

  // Derived reconciliation entries + numbering for the drawer table
  const reconEntries = (petlReconPanel.data?.reconciliationCase?.entries || []) as any[];
  const reconBaseLineNoRaw = petlReconPanel.data?.sowItem?.lineNo;
  const reconBaseLineNo =
    typeof reconBaseLineNoRaw === "number" && Number.isFinite(reconBaseLineNoRaw)
      ? reconBaseLineNoRaw
      : null;

  const reconNumbered = reconEntries.filter((x) => String(x.kind) !== "NOTE_ONLY");
  const reconSeqById = new Map<string, number>();
  reconNumbered.forEach((x, idx) => {
    if (x?.id) reconSeqById.set(String(x.id), idx + 1);
  });

  const [reconEntryEdit, setReconEntryEdit] = useState<
    | null
    | {
        entry: any;
        draft: {
          kind: string;
          tag: ReconEntryTag;
          description: string;
          note: string;
          qty: string;
          unit: string;
          unitCost: string;
          itemAmount: string;
          salesTaxAmount: string;
          opAmount: string;
          rcvAmount: string;
          percentComplete: string;
          // Activity and cost component fields
          activity: string;
          workersWage: string;
          laborBurden: string;
          laborOverhead: string;
          materialCost: string;
          equipmentCost: string;
        };
        rcvManuallyEdited: boolean;
        saving: boolean;
        error: string | null;
      }
  >(null);

  const [reconEditCostBookOpen, setReconEditCostBookOpen] = useState(false);
  const reconTagSelectRef = useRef<HTMLSelectElement | null>(null);
  const [reconFilePickerOpen, setReconFilePickerOpen] = useState(false);
  const [reconAttachmentUploading, setReconAttachmentUploading] = useState(false);
  const [reconPhotoViewerIndex, setReconPhotoViewerIndex] = useState<number | null>(null);
  const reconFileUploadInputRef = useRef<HTMLInputElement | null>(null);
  
  // Draggable modal support
  const reconEditDraggable = useDraggable();
  const reconPanelDraggable = useDraggable();

  // Reconciliation workflow modal state
  const [reconWorkflowModal, setReconWorkflowModal] = useState<{
    open: boolean;
    sowItemId: string | null;
    sowItem: any | null;
    step: 'selectSource' | 'initial' | 'supplement' | 'changeOrder';
    existingEntry?: any; // Pass existing entry when editing to pre-fill modal
  } | null>(null);
  const [reconWorkflowUseNote, setReconWorkflowUseNote] = useState(false);

  const [costBookModalOpen, setCostBookModalOpen] = useState(false);
  const [petlCostBookPickerBusy, setPetlCostBookPickerBusy] = useState(false);

  const [importRoomBuckets, setImportRoomBuckets] = useState<ImportRoomBucket[] | null>(null);
  const [importRoomBucketsLoading, setImportRoomBucketsLoading] = useState(false);
  const [importRoomBucketsError, setImportRoomBucketsError] = useState<string | null>(null);
  const [importRoomBucketsSelection, setImportRoomBucketsSelection] = useState<Set<string>>(
    () => new Set(),
  );
  const [assignTargetType, setAssignTargetType] = useState<"existing" | "new">("existing");
  const [assignExistingUnitId, setAssignExistingUnitId] = useState<string>("");
  const [assignNewUnitLabel, setAssignNewUnitLabel] = useState<string>("");
  const [assignNewUnitFloor, setAssignNewUnitFloor] = useState<string>("");
  const [assignSubmitting, setAssignSubmitting] = useState(false);
  const [assignMessage, setAssignMessage] = useState<string | null>(null);
  const [expandedImportBucketKeys, setExpandedImportBucketKeys] = useState<Set<string>>(
    () => new Set(),
  );
  const [expandedImportUnitKeys, setExpandedImportUnitKeys] = useState<Set<string>>(
    () => new Set(),
  );
  const [importRoomBucketLines, setImportRoomBucketLines] = useState<
    Record<
      string,
      {
        loading: boolean;
        error: string | null;
        rows: ImportRoomLine[];
      }
    >
  >({});

  const toggleImportUnitExpanded = (unitKey: string) => {
    setExpandedImportUnitKeys(prev => {
      const next = new Set(prev);
      if (next.has(unitKey)) next.delete(unitKey);
      else next.add(unitKey);
      return next;
    });
  };

  const importRoomBucketsByUnit = useMemo(() => {
    if (!importRoomBuckets) return [];

    const map = new Map<
      string,
      {
        unitKey: string;
        unitId: string | null;
        unitLabel: string;
        buckets: ImportRoomBucket[];
        lineCount: number;
        totalAmount: number;
      }
    >();

    for (const b of importRoomBuckets) {
      const unitKey = b.assignedUnitId ?? "unassigned";
      const unitLabel = b.assignedUnitLabel ?? "Unassigned";
      const existing = map.get(unitKey);
      if (!existing) {
        map.set(unitKey, {
          unitKey,
          unitId: b.assignedUnitId,
          unitLabel,
          buckets: [b],
          lineCount: b.lineCount ?? 0,
          totalAmount: b.totalAmount ?? 0,
        });
      } else {
        existing.buckets.push(b);
        existing.lineCount += b.lineCount ?? 0;
        existing.totalAmount += b.totalAmount ?? 0;
      }
    }

    const unitSortKey = (label: string) => {
      const s = String(label ?? "");
      const m = s.match(/^Unit\s+0*(\d+)\b/i);
      if (m) {
        const n = Number(m[1]);
        if (Number.isFinite(n)) return { kind: 0, n, s };
      }
      return { kind: 1, n: Number.POSITIVE_INFINITY, s: s.toLowerCase() };
    };

    const arr = Array.from(map.values());
    arr.sort((a, b) => {
      if (a.unitKey === "unassigned" && b.unitKey !== "unassigned") return -1;
      if (b.unitKey === "unassigned" && a.unitKey !== "unassigned") return 1;

      const ka = unitSortKey(a.unitLabel);
      const kb = unitSortKey(b.unitLabel);
      if (ka.kind !== kb.kind) return ka.kind - kb.kind;
      if (ka.n !== kb.n) return ka.n - kb.n;
      return ka.s.localeCompare(kb.s);
    });

    return arr;
  }, [importRoomBuckets]);

  const [newDailyLog, setNewDailyLog] = useState<NewDailyLogState>(() => {
    const today = new Date().toISOString().slice(0, 10);
    return {
      logDate: today,
      title: "",
      tags: "",
      type: "PUDL" as DailyLogType,
      weatherSummary: "",
      workPerformed: "",
      crewOnSite: "",
      issues: "",
      safetyIncidents: "",
      manpowerOnsite: "",
      personOnsite: "",
      confidentialNotes: "",
      shareInternal: true,
      shareSubs: false,
      shareClient: false,
      sharePrivate: false,
      // Receipt/expense defaults
      expenseVendor: "",
      expenseAmount: "",
      expenseDate: today,
      attachmentProjectFileIds: [],
    };
  });

  const [hierarchy, setHierarchy] = useState<{
    project: any;
    buildings: any[];
    units: any[];
  } | null>(null);

  // Compute which hierarchy levels are available based on the project structure
  // (used for dynamic invoice print grouping options)
  const invoicePrintHierarchyLevels = useMemo(() => {
    const levels: { key: "building" | "unit" | "room"; label: string; count: number }[] = [];
    if (!hierarchy) return levels;

    // Count buildings
    const buildingCount = hierarchy.buildings?.length ?? 0;
    if (buildingCount > 0) {
      levels.push({ key: "building", label: "Building", count: buildingCount });
    }

    // Count units (from buildings + standalone)
    const buildingUnits = (hierarchy.buildings ?? []).reduce((sum: number, b: any) => sum + (b.units?.length ?? 0), 0);
    const standaloneUnits = hierarchy.units?.length ?? 0;
    const unitCount = buildingUnits + standaloneUnits;
    if (unitCount > 0) {
      levels.push({ key: "unit", label: "Unit", count: unitCount });
    }

    // Count rooms/particles
    const buildingRooms = (hierarchy.buildings ?? []).reduce((sum: number, b: any) => {
      const unitRooms = (b.units ?? []).reduce((s: number, u: any) => s + (u.particles?.length ?? 0), 0);
      return sum + unitRooms + (b.particles?.length ?? 0);
    }, 0);
    const standaloneUnitRooms = (hierarchy.units ?? []).reduce((sum: number, u: any) => sum + (u.particles?.length ?? 0), 0);
    const roomCount = buildingRooms + standaloneUnitRooms;
    if (roomCount > 0) {
      levels.push({ key: "room", label: "Room", count: roomCount });
    }

    return levels;
  }, [hierarchy]);

  // Precompute a breadcrumb label for each room particle so click handlers don't
  // have to walk/flatten the hierarchy tree (helps INP on PETL buttons).
  const roomBreadcrumbByParticleId = useMemo(() => {
    const map = new Map<string, string>();
    if (!hierarchy) return map;

    const formatBuilding = (b: any) => `${b?.code || ""} ${b?.name || ""}`.trim();
    const formatUnit = (u: any) => {
      if (!u) return "";
      const floorLabel = typeof u.floor === "number" ? ` (Floor ${u.floor})` : "";
      return `${u.label || ""}${floorLabel}`.trim();
    };
    const formatRoom = (p: any) => (p?.fullLabel || p?.name || "").trim();

    for (const b of hierarchy.buildings ?? []) {
      for (const u of b.units ?? []) {
        for (const p of u.particles ?? []) {
          const parts = [formatBuilding(b), formatUnit(u), formatRoom(p)].filter(Boolean);
          if (p?.id) map.set(p.id, parts.join(" · "));
        }
      }
      for (const p of b.particles ?? []) {
        const parts = [formatBuilding(b), formatRoom(p)].filter(Boolean);
        if (p?.id) map.set(p.id, parts.join(" · "));
      }
    }

    for (const u of hierarchy.units ?? []) {
      for (const p of u.particles ?? []) {
        const parts = [formatUnit(u), formatRoom(p)].filter(Boolean);
        if (p?.id) map.set(p.id, parts.join(" · "));
      }
    }

    return map;
  }, [hierarchy]);

  // Reconciliation entries grouped by parent PETL sowItemId.
  // NOTE: This is defined early so petlItemsByRoomParticleId can use it.
  const reconEntriesBySowItemId = useMemo(() => {
    const map = new Map<string, any[]>();
    for (const entry of petlReconciliationEntries) {
      const parentId = String(entry?.parentSowItemId ?? "").trim();
      if (!parentId) continue;
      const arr = map.get(parentId);
      if (arr) arr.push(entry);
      else map.set(parentId, [entry]);
    }

    // Keep deterministic order for rendering and numbering.
    for (const [k, arr] of map.entries()) {
      arr.sort((a, b) => {
        const ta = new Date(a?.createdAt ?? 0).getTime();
        const tb = new Date(b?.createdAt ?? 0).getTime();
        if (ta !== tb) return ta - tb;
        return String(a?.id ?? "").localeCompare(String(b?.id ?? ""));
      });
      map.set(k, arr);
    }

    return map;
  }, [petlReconciliationEntries]);

  // Avoid O(rooms * items) filtering during render of the Rooms/Zones table.
  // Build a lookup map once per PETL/filter change.
  // NOTE: This includes the full filter logic (including reconciliation entries)
  // so we don't need to call matchesFilters() again during render.
  const petlItemsByRoomParticleId = useMemo(() => {
    const map = new Map<string, PetlItem[]>();

    for (const item of petlItems) {
      const particleId = item.projectParticle?.id;
      if (!particleId) continue;

      // Apply room filter
      if (roomParticleIdFilterSet.size > 0) {
        // Check item's particle and reconciliation entries' particles
        const recon = reconEntriesBySowItemId.get(item.id) ?? [];
        const candidateParticleIds = new Set<string>();
        candidateParticleIds.add(particleId);
        for (const e of recon) {
          const pid = String(e?.projectParticleId ?? "").trim();
          if (pid) candidateParticleIds.add(pid);
        }
        const roomOk = Array.from(candidateParticleIds).some((pid) => roomParticleIdFilterSet.has(pid));
        if (!roomOk) continue;
      }

      // Apply category filter (including reconciliation entries)
      if (categoryCodeFilterSet.size > 0) {
        const itemCode = String(item.categoryCode ?? "").trim();
        const recon = reconEntriesBySowItemId.get(item.id) ?? [];
        const reconCodes = recon.map((e) => String(e?.categoryCode ?? "").trim()).filter(Boolean);
        if (!itemCode && reconCodes.length === 0) continue;
        const catOk =
          (itemCode && categoryCodeFilterSet.has(itemCode)) ||
          reconCodes.some((c) => categoryCodeFilterSet.has(c));
        if (!catOk) continue;
      }

      // Apply selection filter (including reconciliation entries)
      if (selectionCodeFilterSet.size > 0) {
        const itemCode = String(item.selectionCode ?? "").trim();
        const recon = reconEntriesBySowItemId.get(item.id) ?? [];
        const reconCodes = recon.map((e) => String(e?.selectionCode ?? "").trim()).filter(Boolean);
        if (!itemCode && reconCodes.length === 0) continue;
        const selOk =
          (itemCode && selectionCodeFilterSet.has(itemCode)) ||
          reconCodes.some((c) => selectionCodeFilterSet.has(c));
        if (!selOk) continue;
      }

      const existing = map.get(particleId);
      if (existing) existing.push(item);
      else map.set(particleId, [item]);
    }

    // Ensure consistent ordering for the per-room expanded list.
    for (const items of map.values()) {
      items.sort((a, b) => a.lineNo - b.lineNo);
    }

    return map;
  }, [petlItems, roomParticleIdFilterSet, categoryCodeFilterSet, selectionCodeFilterSet, reconEntriesBySowItemId]);

  // Derived list of known project participants for use in the Daily Log
  // "Person/s onsite" multi-select. We include both myOrganization and
  // collaborators, deduplicated by display label.
  const personOnsiteOptions = useMemo(() => {
    if (!participants) return [] as { value: string; label: string }[];

    const opts: { value: string; label: string }[] = [];

    const addParticipant = (m: Participant) => {
      const user: any = m.user as any;
      const first = (user?.firstName || "").trim();
      const last = (user?.lastName || "").trim();
      const name = [first, last].filter(Boolean).join(" ");
      const label = name || (user?.email as string) || "(user)";
      if (!label) return;
      opts.push({ value: label, label });
    };

    for (const m of participants.myOrganization ?? []) addParticipant(m as any);
    for (const m of participants.collaborators ?? []) addParticipant(m as any);

    const seen = new Set<string>();
    const deduped = opts.filter(opt => {
      const key = opt.value.toLowerCase();
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    deduped.sort((a, b) => a.label.localeCompare(b.label));
    return deduped;
  }, [participants]);

  // Helper to keep Person/s onsite list, backing string, and manpower count in sync.
  function updatePersonOnsiteList(updater: (prev: string[]) => string[]) {
    setPersonOnsiteList(prevNames => {
      const next = updater(prevNames).map(name => name.trim()).filter(Boolean);
      const joined = next.join(", ");
      setNewDailyLog(prevLog => ({
        ...prevLog,
        personOnsite: joined,
        manpowerOnsite: next.length ? String(next.length) : "",
      }));
      return next;
    });
  }

  // Favorite Person/s onsite groups (saved locally per project).
  useEffect(() => {
    if (!project) return;
    if (typeof window === "undefined") return;
    try {
      const raw = window.localStorage.getItem(`dailyLogPersonGroups:${project.id}`);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return;
      const cleaned = parsed
        .filter((g: any) => g && typeof g.name === "string" && Array.isArray(g.members))
        .map((g: any) => ({
          id: String(g.id ?? `${g.name}-${Math.random().toString(36).slice(2, 8)}`),
          name: String(g.name),
          members: g.members.map((m: any) => String(m)).filter((m: string) => !!m.trim()),
        }));
      setPersonOnsiteGroups(cleaned);
    } catch {
      // ignore localStorage parsing errors
    }
  }, [project]);

  function persistPersonOnsiteGroups(next: { id: string; name: string; members: string[] }[]) {
    setPersonOnsiteGroups(next);
    if (typeof window !== "undefined" && project) {
      try {
        window.localStorage.setItem(`dailyLogPersonGroups:${project.id}`, JSON.stringify(next));
      } catch {
        // ignore storage errors
      }
    }
  }

  const [structureOpen, setStructureOpen] = useState(false);

  // Split "which tab is highlighted" from "which tab content is mounted".
  // Switching content can be expensive (unmounting a large tab + mounting PETL), so we
  // update the underline immediately, then transition the content change on the next frame.
  const [activeTab, setActiveTab] = useState<TabKey>("DAILY_LOGS");
  const [activeTabUi, setActiveTabUi] = useState<TabKey>("DAILY_LOGS");
  const [, startTabTransition] = useTransition();

  const setTab = useCallback(
    (next: TabKey, opts?: { deferContentSwitch?: boolean }) => {
      setActiveTabUi(next);

      if (opts?.deferContentSwitch) {
        if (typeof window !== "undefined") {
          window.requestAnimationFrame(() => {
            startTabTransition(() => setActiveTab(next));
          });
        } else {
          setActiveTab(next);
        }
        return;
      }

      setActiveTab(next);
    },
    [startTabTransition],
  );

  // PETL UI is very heavy to mount; show a lightweight shell first so the tab content
  // paints quickly, then mount the full PETL UI on the next frame.
  const [petlTabMounted, setPetlTabMounted] = useState(false);
  useEffect(() => {
    if (activeTab !== "PETL") {
      setPetlTabMounted(false);
      return;
    }

    let raf = 0;
    raf = window.requestAnimationFrame(() => {
      setPetlTabMounted(true);
    });

    return () => {
      if (raf) window.cancelAnimationFrame(raf);
    };
  }, [activeTab]);

  // PETL fetch is expensive; avoid duplicate in-flight loads and avoid re-fetching
  // on simple tab switches (SUMMARY <-> PETL) unless explicitly reloaded.
  const petlLoadInFlightRef = useRef(false);
  const petlLastSuccessfulLoadRef = useRef<null | { projectId: string; reloadTick: number }>(
    null,
  );

  // Load/save reconciliation flags per project.
  useEffect(() => {
    if (!project || typeof window === "undefined") return;
    const key = `petlReconFlags:${project.id}`;
    try {
      const raw = window.localStorage.getItem(key);
      if (!raw) {
        setPetlReconFlagIds(new Set());
        return;
      }
      const ids = JSON.parse(raw);
      if (Array.isArray(ids)) {
        setPetlReconFlagIds(new Set(ids.filter((v) => typeof v === "string")));
      }
    } catch {
      setPetlReconFlagIds(new Set());
    }
  }, [project]);

  useEffect(() => {
    if (!project || typeof window === "undefined") return;
    const key = `petlReconFlags:${project.id}`;
    try {
      window.localStorage.setItem(key, JSON.stringify(Array.from(petlReconFlagIds)));
    } catch {
      // ignore storage errors
    }
  }, [project, petlReconFlagIds]);

  // Default Time Accounting link to "today" for this project
  const todayIso = useMemo(() => new Date().toISOString().slice(0, 10), []);

  // Reveal PID only after user clicks the project name in the header
  const [showPid, setShowPid] = useState(false);


  // Project header edit state
  const [editProjectMode, setEditProjectMode] = useState(false);

  // The project page is very large; toggling edit mode can cause a noticeable UI stall.
  // Track it as a transition and surface a delayed overlay (after 20ms) so the click
  // feels responsive even when React has heavy work to do.
  const [isEditTransitionPending, startEditTransition] = useTransition();
  const editTransitionOverlayLabelRef = useRef<string>("Working…");
  const editTransitionOverlayDoneRef = useRef<null | (() => void)>(null);

  // PETL tab is also heavy (large tables, filtering, reconciliation drawer). Use a
  // dedicated transition so PETL UI work yields and the delayed overlay can show.
  const [isPetlTransitionPending, startPetlTransition] = useTransition();
  const petlTransitionOverlayLabelRef = useRef<string>("Working…");
  const petlTransitionOverlayDoneRef = useRef<null | (() => void)>(null);

  // General UI transition for toggle buttons, schedule controls, etc.
  // This prevents 2+ second INP issues when clicking buttons that trigger re-renders.
  const [, startUiTransition] = useTransition();

  useEffect(() => {
    if (isEditTransitionPending) {
      if (!editTransitionOverlayDoneRef.current) {
        editTransitionOverlayDoneRef.current = busyOverlay.begin(
          editTransitionOverlayLabelRef.current,
        );
      }
      return;
    }

    if (editTransitionOverlayDoneRef.current) {
      editTransitionOverlayDoneRef.current();
      editTransitionOverlayDoneRef.current = null;
    }
  }, [isEditTransitionPending, busyOverlay.begin]);

  useEffect(() => {
    if (isPetlTransitionPending) {
      if (!petlTransitionOverlayDoneRef.current) {
        petlTransitionOverlayDoneRef.current = busyOverlay.begin(
          petlTransitionOverlayLabelRef.current,
        );
      }
      return;
    }

    if (petlTransitionOverlayDoneRef.current) {
      petlTransitionOverlayDoneRef.current();
      petlTransitionOverlayDoneRef.current = null;
    }
  }, [isPetlTransitionPending, busyOverlay.begin]);

  // Wrap filter setters in transitions to avoid blocking UI on large datasets
  const setRoomParticleIdFiltersTransition = useCallback((next: string[]) => {
    startPetlTransition(() => setRoomParticleIdFilters(next));
  }, [startPetlTransition]);

  const setCategoryCodeFiltersTransition = useCallback((next: string[]) => {
    startPetlTransition(() => setCategoryCodeFilters(next));
  }, [startPetlTransition]);

  const setSelectionCodeFiltersTransition = useCallback((next: string[]) => {
    startPetlTransition(() => setSelectionCodeFilters(next));
  }, [startPetlTransition]);

  const setPetlOrgGroupFiltersTransition = useCallback((next: string[]) => {
    startPetlTransition(() => setPetlOrgGroupFilters(next));
  }, [startPetlTransition]);

  // Wrap schedule setters in transitions to avoid 2+ second INP issues
  const setScheduleZoomTransition = useCallback((next: "AUTO" | "DAY" | "WEEK" | "MONTH") => {
    startUiTransition(() => setScheduleZoom(next));
  }, [startUiTransition]);

  const setScheduleViewPresetTransition = useCallback((next: "ALL" | "30D" | "60D" | "90D" | "CUSTOM") => {
    startUiTransition(() => setScheduleViewPreset(next));
  }, [startUiTransition]);

  const setScheduleGroupModeTransition = useCallback((next: "ROOM" | "TRADE" | "UNIT") => {
    startUiTransition(() => setScheduleGroupMode(next));
  }, [startUiTransition]);

  const setScheduleSourceTransition = useCallback((next: "PREVIEW" | "ORG") => {
    startUiTransition(() => setScheduleSource(next));
  }, [startUiTransition]);

  const setScheduleSummaryExpandedTransition = useCallback((next: boolean | ((prev: boolean) => boolean)) => {
    startUiTransition(() => setScheduleSummaryExpanded(next));
  }, [startUiTransition]);

  const setScheduleReloadTickTransition = useCallback((fn: (t: number) => number) => {
    startUiTransition(() => setScheduleReloadTick(fn));
  }, [startUiTransition]);

  // Use transition for display mode changes to avoid blocking
  const setPetlDisplayModePersisted = useCallback((mode: PetlDisplayMode) => {
    petlTransitionOverlayLabelRef.current = "Switching view…";
    busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
    startPetlTransition(() => {
      setPetlDisplayMode(mode);
      if (typeof window !== "undefined") {
        try {
          localStorage.setItem(petlDisplayModeKey, mode);
          // Best effort: clear legacy key so we don't flip back after refresh.
          localStorage.removeItem(`petlDisplayMode:${id}`);
        } catch {
          // ignore storage errors
        }
      }
    });
  }, [id, petlDisplayModeKey, busyOverlay, startPetlTransition]);

  // SOP: when PETL is doing real work
  // delayed overlay automatically based on the existing loading flags.
  const petlLoadingOverlayDoneRef = useRef<null | (() => void)>(null);
  useEffect(() => {
    // Only show this overlay when the user is actually on the PETL tab.
    if (activeTab !== "PETL") {
      if (petlLoadingOverlayDoneRef.current) {
        petlLoadingOverlayDoneRef.current();
        petlLoadingOverlayDoneRef.current = null;
      }
      return;
    }

    if (petlLoading) {
      if (!petlLoadingOverlayDoneRef.current) {
        busyOverlay.setMessage("Loading PETL…");
        petlLoadingOverlayDoneRef.current = busyOverlay.begin("Loading PETL…");
      }
      return;
    }

    if (petlLoadingOverlayDoneRef.current) {
      petlLoadingOverlayDoneRef.current();
      petlLoadingOverlayDoneRef.current = null;
    }
  }, [activeTab, busyOverlay.begin, busyOverlay.setMessage, petlLoading]);

  const pendingApprovalsOverlayDoneRef = useRef<null | (() => void)>(null);
  useEffect(() => {
    if (activeTab !== "PETL") {
      if (pendingApprovalsOverlayDoneRef.current) {
        pendingApprovalsOverlayDoneRef.current();
        pendingApprovalsOverlayDoneRef.current = null;
      }
      return;
    }

    if (pendingPetlLoading) {
      if (!pendingApprovalsOverlayDoneRef.current) {
        busyOverlay.setMessage("Loading approvals…");
        pendingApprovalsOverlayDoneRef.current = busyOverlay.begin(
          "Loading approvals…",
        );
      }
      return;
    }

    if (pendingApprovalsOverlayDoneRef.current) {
      pendingApprovalsOverlayDoneRef.current();
      pendingApprovalsOverlayDoneRef.current = null;
    }
  }, [activeTab, busyOverlay.begin, busyOverlay.setMessage, pendingPetlLoading]);

  const [editProject, setEditProject] = useState<
    | null
    | {
        name: string;
        status: string;
        addressLine1: string;
        addressLine2: string | null;
        city: string;
        state: string;
        primaryContactName: string | null;
        primaryContactEmail: string | null;
        primaryContactPhone: string | null;
      }
  >(null);
  const [editProjectSaving, setEditProjectSaving] = useState(false);
  const [editProjectMessage, setEditProjectMessage] = useState<string | null>(null);
  const [deleteProjectMessage, setDeleteProjectMessage] = useState<string | null>(null);
  const [editProjectState, setEditProjectState] = useState<ProjectStateChoice>("OPEN");

  // Tenant client search state for linking
  interface TenantClientResult {
    id: string;
    firstName: string;
    lastName: string;
    displayName: string | null;
    email: string | null;
    phone: string | null;
    company: string | null;
    projectCount?: number;
  }
  const [clientLinkMode, setClientLinkMode] = useState(false);
  const [clientSearchQuery, setClientSearchQuery] = useState("");
  const [clientSearchResults, setClientSearchResults] = useState<TenantClientResult[]>([]);
  const [clientSearching, setClientSearching] = useState(false);
  const [selectedTenantClient, setSelectedTenantClient] = useState<TenantClientResult | null>(null);
  const clientNameSearchTimeoutRef = useRef<NodeJS.Timeout | null>(null);

  // Search for tenant clients by name, email, or phone
  const searchTenantClients = async (query: string) => {
    if (!query || query.length < 2) {
      setClientSearchResults([]);
      return;
    }
    const token = typeof window !== "undefined" ? localStorage.getItem("accessToken") : null;
    if (!token) return;

    try {
      setClientSearching(true);
      const res = await fetch(
        `${API_BASE}/clients/search?q=${encodeURIComponent(query)}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      if (res.ok) {
        const data = await res.json();
        setClientSearchResults(Array.isArray(data) ? data : []);
      }
    } catch {
      // Ignore search errors
    } finally {
      setClientSearching(false);
    }
  };

  // Handle selecting a client from search results
  const handleSelectTenantClient = (client: TenantClientResult) => {
    setSelectedTenantClient(client);
    setClientSearchQuery("");
    setClientSearchResults([]);
    // Auto-fill contact fields from selected client
    setEditProject(prev =>
      prev
        ? {
            ...prev,
            primaryContactName: client.displayName || `${client.firstName} ${client.lastName}`.trim(),
            primaryContactEmail: client.email || null,
            primaryContactPhone: client.phone || null,
          }
        : prev
    );
  };

  // Clear client link
  const handleClearTenantClientLink = () => {
    setSelectedTenantClient(null);
    setEditProject(prev =>
      prev
        ? {
            ...prev,
            primaryContactName: null,
            primaryContactEmail: null,
            primaryContactPhone: null,
          }
        : prev
    );
  };

  const searchParams = useSearchParams();

  const invoiceFullscreen = searchParams?.get("invoiceFullscreen") === "1";
  const invoiceIdFromUrl = searchParams?.get("invoiceId") || null;

  useEffect(() => {
    const tab = searchParams?.get("tab");
    if (!tab) return;

    if (
      tab === "SUMMARY" ||
      tab === "SCHEDULE" ||
      tab === "PETL" ||
      tab === "STRUCTURE" ||
      tab === "DAILY_LOGS" ||
      tab === "FILES" ||
      tab === "FINANCIAL"
    ) {
      setTab(tab as TabKey);
    } else if (tab.toUpperCase() === "PETL") {
      setTab("PETL");
    } else if (tab.toUpperCase() === "SCHEDULE") {
      setTab("SCHEDULE");
    }
  }, [searchParams, setTab]);

  const overallSummary = useMemo(() => {
    if (petlItems.length === 0 && petlReconciliationEntries.length === 0) {
      return null;
    }
    let count = 0;
    let total = 0;
    let completed = 0;

    for (const item of petlItems) {
      const amt = item.rcvAmount ?? item.itemAmount ?? 0;
      // ACV items still count toward progress - ACV affects payer type, not work completion.
      const pct = item.percentComplete ?? 0;
      count += 1;
      total += amt;
      completed += amt * (pct / 100);
    }

    for (const entry of petlReconciliationEntries) {
      const amt = entry?.rcvAmount ?? 0;
      const pct = entry?.percentComplete ?? 0;
      count += 1;
      total += amt;
      completed += amt * (pct / 100);
    }

    return {
      itemCount: count,
      totalAmount: total,
      completedAmount: completed,
      percentComplete: total > 0 ? (completed / total) * 100 : 0
    };
  }, [petlItems, petlReconciliationEntries]);

  // Derived filter options
  const roomOptions = useMemo(() => {
    const seen = new Set<string>();
    const opts: { value: string; label: string }[] = [];
    for (const g of groups) {
      if (!g.particleId) continue;
      if (seen.has(g.particleId)) continue;
      seen.add(g.particleId);
      opts.push({ value: g.particleId, label: g.roomName });
    }
    return opts.sort((a, b) => a.label.localeCompare(b.label));
  }, [groups]);

  // Orphan reconciliation entries (carried forward but not attached to a
  // specific PETL line in the latest estimate version).
  const orphanReconEntries = useMemo(() => {
    return petlReconciliationEntries.filter((entry: any) => {
      const hasParent = String(entry?.parentSowItemId ?? "").trim().length > 0;
      const hasOriginLine =
        typeof entry?.originLineNo === "number" && Number.isFinite(entry.originLineNo);
      return !hasParent && hasOriginLine;
    });
  }, [petlReconciliationEntries]);

  // UI: expand/collapse reconciliation sub-lines per PETL line item.
  const [petlReconExpandedIds, setPetlReconExpandedIds] = useState<Set<string>>(
    () => new Set(),
  );

  // When entering "Reconciliation only" mode, auto-expand all lines that have reconciliation activity.
  useEffect(() => {
    if (petlDisplayMode !== "RECONCILIATION_ONLY") return;
    setPetlReconExpandedIds(new Set(Array.from(petlReconActivityIds)));
  }, [petlDisplayMode, petlReconActivityIds]);

  const categoryOptions = useMemo(() => {
    const set = new Set<string>();
    for (const item of petlItems) {
      if (item.categoryCode) set.add(item.categoryCode);
    }
    for (const entry of petlReconciliationEntries) {
      const cat = entry?.categoryCode;
      if (typeof cat === "string" && cat.trim()) set.add(cat);
    }
    return Array.from(set.values()).sort();
  }, [petlItems, petlReconciliationEntries]);

  const selectionOptions = useMemo(() => {
    const set = new Set<string>();
    for (const item of petlItems) {
      if (item.selectionCode) set.add(item.selectionCode);
    }
    for (const entry of petlReconciliationEntries) {
      const sel = entry?.selectionCode;
      if (typeof sel === "string" && sel.trim()) set.add(sel);
    }
    return Array.from(set.values()).sort();
  }, [petlItems, petlReconciliationEntries]);

  const hasReconciliationActivity = (sowItemId: string) => {
    return petlReconActivityIds.has(sowItemId);
  };

  const matchesFilters = (item: PetlItem) => {
    const particleId = item.projectParticle?.id ?? null;
    const recon = reconEntriesBySowItemId.get(item.id) ?? [];

    if (roomParticleIdFilterSet.size > 0) {
      const candidateParticleIds = new Set<string>();
      if (particleId) candidateParticleIds.add(particleId);
      for (const e of recon) {
        const pid = String(e?.projectParticleId ?? "").trim();
        if (pid) candidateParticleIds.add(pid);
      }

      // Must match at least one particle.
      const ok = Array.from(candidateParticleIds).some((pid) => roomParticleIdFilterSet.has(pid));
      if (!ok) return false;
    }

    if (categoryCodeFilterSet.size > 0) {
      const itemCode = String(item.categoryCode ?? "").trim();
      const reconCodes = recon.map((e) => String(e?.categoryCode ?? "").trim()).filter(Boolean);
      if (!itemCode && reconCodes.length === 0) return false;
      const ok =
        (itemCode && categoryCodeFilterSet.has(itemCode)) ||
        reconCodes.some((c) => categoryCodeFilterSet.has(c));
      if (!ok) return false;
    }

    if (selectionCodeFilterSet.size > 0) {
      const itemCode = String(item.selectionCode ?? "").trim();
      const reconCodes = recon.map((e) => String(e?.selectionCode ?? "").trim()).filter(Boolean);
      if (!itemCode && reconCodes.length === 0) return false;
      const ok =
        (itemCode && selectionCodeFilterSet.has(itemCode)) ||
        reconCodes.some((c) => selectionCodeFilterSet.has(c));
      if (!ok) return false;
    }

    return true;
  };


  const petlFlatItems = useMemo(() => {
    const filtered = petlItems.filter((it) => {
      if (!matchesFilters(it)) return false;
      if (petlDisplayMode === "RECONCILIATION_ONLY") {
        return petlReconActivityIds.has(it.id);
      }
      return true;
    });

    // Sort: Standalone COs first (at the top), then regular items by lineNo
    filtered.sort((a, b) => {
      const aIsCo = a.isStandaloneChangeOrder ?? false;
      const bIsCo = b.isStandaloneChangeOrder ?? false;

      // COs sort to the top
      if (aIsCo && !bIsCo) return -1;
      if (!aIsCo && bIsCo) return 1;

      // Both are COs: sort by source line, then sequence
      if (aIsCo && bIsCo) {
        const aSource = a.coSourceLineNo ?? 0;
        const bSource = b.coSourceLineNo ?? 0;
        if (aSource !== bSource) return aSource - bSource;
        return (a.coSequenceNo ?? 0) - (b.coSequenceNo ?? 0);
      }

      // Both are regular items: sort by lineNo
      return a.lineNo - b.lineNo;
    });
    return filtered;
  }, [
    petlItems,
    petlReconciliationEntries,
    reconEntriesBySowItemId,
    petlDisplayMode,
    petlReconActivityIds,
    roomParticleIdFilterSet,
    categoryCodeFilterSet,
    selectionCodeFilterSet,
  ]);

  const [petlEditingCell, setPetlEditingCell] = useState<
    | null
    | {
        sowItemId: string;
        field: "qty" | "unit" | "rcvAmount" | "categoryCode" | "selectionCode";
      }
  >(null);
  const [petlEditDraft, setPetlEditDraft] = useState<string>("");
  const [petlEditSaving, setPetlEditSaving] = useState(false);

  // Brief toast notification for single-line saves
  const [petlToast, setPetlToast] = useState<string | null>(null);
  const petlToastTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const showPetlToast = useCallback((msg: string, durationMs = 2500) => {
    if (petlToastTimeoutRef.current) clearTimeout(petlToastTimeoutRef.current);
    setPetlToast(msg);
    petlToastTimeoutRef.current = setTimeout(() => setPetlToast(null), durationMs);
  }, []);

  const openPetlCellEditor = useCallback(
    (
      sowItemId: string,
      field: "qty" | "unit" | "rcvAmount" | "categoryCode" | "selectionCode",
      current: any,
    ) => {
      if (!isPmOrAbove) return;
      let draft = "";
      if (current !== null && current !== undefined) {
        draft = String(current);
      }
      setPetlEditingCell({ sowItemId, field });
      setPetlEditDraft(draft);
    },
    [isPmOrAbove],
  );

  const cancelPetlCellEditor = useCallback(() => {
    if (petlEditSaving) return;
    setPetlEditingCell(null);
    setPetlEditDraft("");
  }, [petlEditSaving]);

  const savePetlInlineEdit = useCallback(async () => {
    if (!petlEditingCell) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return;
    }

    const { sowItemId, field } = petlEditingCell;
    let payload: any = {};
    const raw = petlEditDraft.trim();

    if (field === "qty" || field === "rcvAmount") {
      if (raw === "") {
        payload[field] = null;
      } else {
        const n = Number(raw);
        if (!Number.isFinite(n)) {
          alert("Value must be a number.");
          return;
        }
        payload[field] = n;
      }
    } else {
      // string fields
      payload[field] = raw === "" ? null : raw;
    }

    setPetlEditSaving(true);

    try {
      await busyOverlay.run("Saving PETL edit…", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${id}/petl/${sowItemId}/line`,
          {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          alert(`Save failed (${res.status}) ${text}`.trim());
          return;
        }

        const json = await res.json().catch(() => null as any);

        if (json && json.status === "ok") {
          const updatedId = String(json.sowItemId ?? sowItemId);
          setPetlItems((prev) =>
            prev.map((it) =>
              it.id === updatedId
                ? {
                    ...it,
                    qty: json.qty ?? it.qty,
                    unit: json.unit ?? it.unit,
                    itemAmount:
                      json.itemAmount !== undefined ? json.itemAmount : it.itemAmount,
                    rcvAmount:
                      json.rcvAmount !== undefined ? json.rcvAmount : it.rcvAmount,
                    categoryCode:
                      json.categoryCode !== undefined ? json.categoryCode : it.categoryCode,
                    selectionCode:
                      json.selectionCode !== undefined
                        ? json.selectionCode
                        : it.selectionCode,
                    description:
                      json.description !== undefined ? json.description : it.description,
                  }
                : it,
            ),
          );
        }
      });
    } catch (err: any) {
      alert(err?.message ?? "Save failed");
    } finally {
      setPetlEditSaving(false);
      cancelPetlCellEditor();
      // Keep server-side summaries in sync after edits that affect dollars.
      setPetlReloadTick((t) => t + 1);
    }
  }, [petlEditingCell, petlEditDraft, busyOverlay, id, cancelPetlCellEditor]);

  const petlFlatListRef = useRef<HTMLDivElement | null>(null);

  const toggleImportBucketExpanded = async (bucket: ImportRoomBucket) => {
    const key = `${bucket.groupCode ?? ""}::${bucket.groupDescription ?? ""}`;
    setExpandedImportBucketKeys(prev => {
      const next = new Set(prev);
      if (next.has(key)) next.delete(key);
      else next.add(key);
      return next;
    });

    // If we don't have rows loaded for this bucket yet, fetch them.
    if (!importRoomBucketLines[key]) {
      const token = typeof window !== "undefined"
        ? localStorage.getItem("accessToken")
        : null;
      if (!token) {
        setImportRoomBucketLines(prev => ({
          ...prev,
          [key]: {
            loading: false,
            error: "Missing access token. Please login again.",
            rows: [],
          },
        }));
        return;
      }

      setImportRoomBucketLines(prev => ({
        ...prev,
        [key]: { loading: true, error: null, rows: [] },
      }));

      try {
        const params = new URLSearchParams();
        if (bucket.groupCode != null) params.set("groupCode", bucket.groupCode);
        if (bucket.groupDescription != null) {
          params.set("groupDescription", bucket.groupDescription);
        }
        const res = await fetch(
          `${API_BASE}/projects/${id}/import-structure/room-lines?${params.toString()}`,
          {
            headers: { Authorization: `Bearer ${token}` },
          },
        );
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          setImportRoomBucketLines(prev => ({
            ...prev,
            [key]: {
              loading: false,
              error: `Failed to load lines (${res.status}) ${text}`,
              rows: [],
            },
          }));
          return;
        }
        const json: any = await res.json();
        const rows: ImportRoomLine[] = Array.isArray(json.rows) ? json.rows : [];
        setImportRoomBucketLines(prev => ({
          ...prev,
          [key]: { loading: false, error: null, rows },
        }));
      } catch (err: any) {
        setImportRoomBucketLines(prev => ({
          ...prev,
          [key]: {
            loading: false,
            error: err?.message ?? "Failed to load lines",
            rows: [],
          },
        }));
      }
    }
  };

  // Initial load: just project + estimate summary for a fast first paint
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setError("Missing access token. Please login again.");
      setLoading(false);
      return;
    }

    let cancelled = false;

    async function loadInitial() {
      try {
        const res = await fetch(`${API_BASE}/projects/${id}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (!res.ok) {
          throw new Error(`Failed to load project (${res.status})`);
        }
        const found: Project = await res.json();
        if (cancelled) return;
        setProject(found);

        // Lightweight estimate summary (item count + total amount)
        try {
          const summaryRes = await fetch(`${API_BASE}/projects/${id}/estimate-summary`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (summaryRes.ok) {
            const summary: any = await summaryRes.json();
            if (cancelled) return;
            setPetlItemCount(typeof summary.itemCount === "number" ? summary.itemCount : null);
            setPetlTotalAmount(
              typeof summary.totalAmount === "number" ? summary.totalAmount : null,
            );
            setComponentsCount(
              typeof summary.componentsCount === "number" ? summary.componentsCount : null,
            );
          }
        } catch {
          // Ignore summary errors in this lightweight view
        }
      } catch (err: any) {
        if (cancelled) return;
        setError(err.message || "Unknown error");
      } finally {
        if (cancelled) return;
        setLoading(false);
      }
    }

    void loadInitial();

    return () => {
      cancelled = true;
    };
  }, [id]);

  // Load PETL-related data when project is available and user views PETL/STRUCTURE
  useEffect(() => {
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) return;

    const shouldLoadPetl =
      activeTab === "PETL" ||
      activeTab === "STRUCTURE" ||
      activeTab === "SUMMARY" ||
      petlDiagnosticsModalOpen;

    if (!shouldLoadPetl) {
      // SUMMARY also benefits from PETL data for overall/selection summaries
      return;
    }

    // Avoid double-fetching when the user toggles tabs quickly.
    if (petlLoadInFlightRef.current) return;

    // If we already loaded successfully for the current reload tick, don't re-fetch
    // just because the tab switched.
    const last = petlLastSuccessfulLoadRef.current;
    const alreadyLoadedForTick =
      last?.projectId === project.id && last?.reloadTick === petlReloadTick;

    if (alreadyLoadedForTick && !petlDiagnosticsModalOpen) {
      return;
    }

    let cancelled = false;

    const loadPetl = async () => {
      petlLoadInFlightRef.current = true;

      const petlUrl = `${API_BASE}/projects/${project.id}/petl`;
      const groupsUrl = `${API_BASE}/projects/${project.id}/petl-groups`;
      const summaryUrl = `${API_BASE}/projects/${project.id}/estimate-summary`;

      try {
        setPetlLoading(true);
        setPetlLoadError(null);

        const [petlRes, groupsRes, summaryRes] = await Promise.all([
          fetch(petlUrl, {
            headers: { Authorization: `Bearer ${token}` },
          }),
          fetch(groupsUrl, {
            headers: { Authorization: `Bearer ${token}` },
          }),
          fetch(summaryUrl, {
            headers: { Authorization: `Bearer ${token}` },
          }),
        ]);

        const debug: any = {
          requestedAt: new Date().toISOString(),
          apiBase: API_BASE,
          projectId: project.id,
          petl: {
            url: petlUrl,
            status: petlRes.status,
            ok: petlRes.ok,
          },
          groups: {
            url: groupsUrl,
            status: groupsRes.status,
            ok: groupsRes.ok,
          },
          estimateSummary: {
            url: summaryUrl,
            status: summaryRes.status,
            ok: summaryRes.ok,
          },
        };

        // PETL
        if (!cancelled && petlRes.ok) {
          const petl: any = await petlRes.json();
          const items: PetlItem[] = Array.isArray(petl.items) ? petl.items : [];
          const recon: any[] = Array.isArray(petl.reconciliationEntries)
            ? petl.reconciliationEntries
            : [];
          const activityIds: string[] = Array.isArray(petl.reconciliationActivitySowItemIds)
            ? petl.reconciliationActivitySowItemIds
            : [];

          setPetlItems(items);
          setPetlReconciliationEntries(recon);
          setPetlReconActivityIds(
            new Set(activityIds.filter((v) => typeof v === "string" && v.length > 0)),
          );

          // Mark this reload tick as successfully loaded so tab switches don't trigger
          // redundant refreshes.
          petlLastSuccessfulLoadRef.current = { projectId: project.id, reloadTick: petlReloadTick };

          debug.petl.estimateVersionId = petl?.estimateVersionId ?? null;
          debug.petl.itemsCount = items.length;
          setPetlEstimateVersionId(petl?.estimateVersionId ?? null);
          debug.petl.reconciliationEntriesCount = recon.length;
          debug.petl.reconciliationActivitySowItemIdsCount = activityIds.length;
        } else if (!cancelled && !petlRes.ok) {
          const text = await petlRes.text().catch(() => "");
          debug.petl.errorText = text.slice(0, 5000);

          setPetlItems([]);
          setPetlReconciliationEntries([]);
          setPetlReconActivityIds(new Set());
          setPetlEstimateVersionId(null);

          setPetlLoadError(
            `PETL fetch failed (${petlRes.status}). ${text || "<empty response>"}`.slice(0, 8000),
          );
          setPetlShowDiagnostics(true);
        }

        // Groups
        if (!cancelled && groupsRes.ok) {
          const json: any = await groupsRes.json();
          setGroups(Array.isArray(json.groups) ? json.groups : []);
          setUnitGroups(Array.isArray(json.unitGroups) ? json.unitGroups : []);
          debug.groups.groupsCount = Array.isArray(json.groups) ? json.groups.length : 0;
          debug.groups.unitGroupsCount = Array.isArray(json.unitGroups) ? json.unitGroups.length : 0;
        } else if (!cancelled && !groupsRes.ok) {
          const text = await groupsRes.text().catch(() => "");
          debug.groups.errorText = text.slice(0, 2000);
        }

        // Estimate summary
        if (!cancelled && summaryRes.ok) {
          const summary: any = await summaryRes.json();
          setPetlItemCount(typeof summary.itemCount === "number" ? summary.itemCount : null);
          setPetlTotalAmount(typeof summary.totalAmount === "number" ? summary.totalAmount : null);
          setComponentsCount(typeof summary.componentsCount === "number" ? summary.componentsCount : null);

          debug.estimateSummary.itemCount = summary?.itemCount ?? null;
          debug.estimateSummary.totalAmount = summary?.totalAmount ?? null;
          debug.estimateSummary.componentsCount = summary?.componentsCount ?? null;
        } else if (!cancelled && !summaryRes.ok) {
          const text = await summaryRes.text().catch(() => "");
          debug.estimateSummary.errorText = text.slice(0, 2000);
        }

        if (!cancelled) {
          setPetlLastLoadDebug(debug);
        }
      } catch (err: any) {
        if (cancelled) return;
        setPetlItems([]);
        setPetlReconciliationEntries([]);
        setPetlReconActivityIds(new Set());
        setPetlLoadError(err?.message ?? "PETL fetch failed (network error)");
        setPetlShowDiagnostics(true);
        setPetlLastLoadDebug({
          requestedAt: new Date().toISOString(),
          apiBase: API_BASE,
          projectId: project.id,
          error: err?.message ?? String(err),
        });
      } finally {
        petlLoadInFlightRef.current = false;
        if (!cancelled) setPetlLoading(false);
      }
    };

    void loadPetl();

    return () => {
      cancelled = true;
    };
  }, [project, activeTab, petlReloadTick, petlDiagnosticsModalOpen]);

  // Schedule preview (Gantt) uses the project's imported estimate version.
  useEffect(() => {
    if (!project) return;

    // We show the Gantt on the dedicated Schedule tab, and on Summary only when expanded.
    const showSchedule =
      activeTab === "SCHEDULE" || (activeTab === "SUMMARY" && scheduleSummaryExpanded);
    if (!showSchedule) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setSchedulePreview(null);
      setSchedulePreviewError("Missing access token. Please login again.");
      setSchedulePreviewLoading(false);
      return;
    }

    if (!petlEstimateVersionId) {
      // PETL might still be loading; avoid surfacing an error until we actually have an estimateVersionId.
      setSchedulePreview(null);
      setSchedulePreviewError(null);
      setSchedulePreviewLoading(false);
      return;
    }

    let cancelled = false;

    const loadPreview = async () => {
      setSchedulePreviewLoading(true);
      setSchedulePreviewError(null);

      try {
        const res = await fetch(
          `${API_BASE}/projects/${project.id}/xact-schedule/estimate/${petlEstimateVersionId}/preview`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              startDate: scheduleStartDate,
              taskOverrides: scheduleOverridesPayload ?? undefined,
            }),
          },
        );

        if (cancelled) return;

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          setSchedulePreview(null);
          setSchedulePreviewError(
            `Failed to generate schedule preview (${res.status}). ${text}`.slice(0, 2000),
          );
          return;
        }

        const json: any = await res.json();
        if (cancelled) return;
        setSchedulePreview(json);
      } catch (err: any) {
        if (cancelled) return;
        setSchedulePreview(null);
        setSchedulePreviewError(err?.message ?? "Failed to generate schedule preview");
      } finally {
        if (!cancelled) setSchedulePreviewLoading(false);
      }
    };

    void loadPreview();

    return () => {
      cancelled = true;
    };
  }, [
    project,
    activeTab,
    petlEstimateVersionId,
    scheduleStartDate,
    scheduleReloadTick,
    scheduleSummaryExpanded,
    scheduleOverridesPayload,
  ]);

  // Canonical, persisted schedule tasks for the current project/estimate.
  // These are only loaded when the schedule is visible and the source is set
  // to ORG so we avoid unnecessary traffic.
  useEffect(() => {
    if (!project) return;

    const showSchedule =
      activeTab === "SCHEDULE" || (activeTab === "SUMMARY" && scheduleSummaryExpanded);
    if (!showSchedule) return;

    if (scheduleSource !== "ORG") return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setSchedulePersistedTasks(null);
      setSchedulePersistedError("Missing access token. Please login again.");
      setSchedulePersistedLoading(false);
      return;
    }

    if (!petlEstimateVersionId) {
      // Wait until we know which estimate version backs PETL before attempting
      // to load canonical tasks.
      setSchedulePersistedTasks(null);
      setSchedulePersistedError(null);
      setSchedulePersistedLoading(false);
      return;
    }

    let cancelled = false;

    const loadTasks = async () => {
      setSchedulePersistedLoading(true);
      setSchedulePersistedError(null);

      try {
        const res = await fetch(
          `${API_BASE}/projects/${project.id}/xact-schedule/estimate/${petlEstimateVersionId}/tasks`,
          {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          },
        );

        if (cancelled) return;

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          setSchedulePersistedTasks(null);
          setSchedulePersistedError(
            `Failed to load canonical schedule tasks (${res.status}). ${text}`.slice(0, 2000),
          );
          return;
        }

        const json: any = await res.json();
        if (cancelled) return;

        const rows = Array.isArray(json) ? json : [];
        setSchedulePersistedTasks(rows);
      } catch (err: any) {
        if (cancelled) return;
        setSchedulePersistedTasks(null);
        setSchedulePersistedError(err?.message ?? "Failed to load canonical schedule tasks");
      } finally {
        if (!cancelled) setSchedulePersistedLoading(false);
      }
    };

    void loadTasks();

    return () => {
      cancelled = true;
    };
  }, [
    project,
    activeTab,
    petlEstimateVersionId,
    scheduleSource,
    scheduleReloadTick,
    scheduleSummaryExpanded,
  ]);

  // Load BOM data when BOM tab is active
  useEffect(() => {
    if (!project) return;
    if (activeTab !== "BOM") return;
    if (bomData) return; // Already loaded

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setBomError("Missing access token. Please login again.");
      return;
    }

    let cancelled = false;

    const loadBom = async () => {
      setBomLoading(true);
      setBomError(null);

      try {
        const res = await fetch(`${API_BASE}/projects/${project.id}/bom`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (cancelled) return;

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          setBomError(`Failed to load BOM (${res.status}). ${text}`.slice(0, 500));
          return;
        }

        const json = await res.json();
        if (cancelled) return;
        setBomData(json);
      } catch (err: any) {
        if (cancelled) return;
        setBomError(err?.message ?? "Failed to load BOM");
      } finally {
        if (!cancelled) setBomLoading(false);
      }
    };

    void loadBom();

    return () => {
      cancelled = true;
    };
  }, [project, activeTab, bomData]);

  const addDaysIso = (iso: string, deltaDays: number): string => {
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    d.setDate(d.getDate() + deltaDays);
    // normalize back to YYYY-MM-DD
    return d.toISOString().slice(0, 10);
  };

  const bumpToWeekdayIso = (iso: string): string => {
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    const day = d.getDay();
    // 0=Sun,6=Sat
    if (day === 6) d.setDate(d.getDate() + 2);
    if (day === 0) d.setDate(d.getDate() + 1);
    return d.toISOString().slice(0, 10);
  };

  const maxIso = (a: string, b: string): string => {
    if (!a) return b;
    if (!b) return a;
    return a >= b ? a : b;
  };

  const roomToUnitLabel = useMemo(() => {
    const map = new Map<string, string>();
    for (const ug of unitGroups) {
      const unitLabel = String((ug as any)?.unitLabel ?? "").trim();
      if (!unitLabel) continue;
      const rooms: any[] = Array.isArray((ug as any)?.rooms) ? (ug as any).rooms : [];
      for (const r of rooms) {
        const roomName = String(r?.roomName ?? "").trim();
        if (!roomName) continue;
        if (!map.has(roomName)) {
          map.set(roomName, unitLabel);
        }
      }
    }
    return map;
  }, [unitGroups]);

  // Unique list of unit labels for the schedule filter, sorted with the same
  // Unit 1 / Unit 2 / Unit 10-friendly behavior used elsewhere.
  const scheduleUnitLabels = useMemo(() => {
    const labels = unitGroups.map((ug) => String((ug as any)?.unitLabel || "(No unit)").trim());
    const unique = Array.from(new Set(labels));

    const unitSortKey = (label: string) => {
      const s = String(label ?? "");
      const m = s.match(/^Unit\s+0*(\d+)\b/i);
      if (m) {
        const n = Number(m[1]);
        if (Number.isFinite(n)) return { kind: 0, n, s };
      }
      return { kind: 1, n: Number.POSITIVE_INFINITY, s: s.toLowerCase() };
    };

    return unique.sort((a, b) => {
      const ka = unitSortKey(a);
      const kb = unitSortKey(b);
      if (ka.kind !== kb.kind) return ka.kind - kb.kind;
      if (ka.n !== kb.n) return ka.n - kb.n;
      return ka.s.localeCompare(kb.s);
    });
  }, [unitGroups]);

  // All preview tasks (Xact-driven estimate schedule) and canonical org-bound
  // tasks (persisted ProjectScheduleTask rows).
  const schedulePreviewTasksAll: any[] = useMemo(
    () =>
      Array.isArray(schedulePreview?.scheduledTasks)
        ? (schedulePreview!.scheduledTasks as any[])
        : [],
    [schedulePreview],
  );

  const scheduleOrgTasksAll: any[] = useMemo(
    () => (Array.isArray(schedulePersistedTasks) ? schedulePersistedTasks : []),
    [schedulePersistedTasks],
  );

  // Top-level org groups (e.g. ELECTRI, RISK__E) derived from whichever
  // schedule source is currently active. Prefer explicit orgGroupCode when
  // available, falling back to parsing the room label.
  const scheduleOrgGroupCodes = useMemo(() => {
    const codes = new Set<string>();

    const sourceTasks =
      scheduleSource === "ORG" && scheduleOrgTasksAll.length > 0
        ? scheduleOrgTasksAll
        : schedulePreviewTasksAll;

    for (const t of sourceTasks as any[]) {
      const explicit = String((t as any)?.orgGroupCode ?? "").trim();
      if (explicit) {
        codes.add(explicit);
        continue;
      }

      const room = String((t as any)?.room ?? "").trim();
      if (!room) continue;
      const code = scheduleExtractGroupCode(room);
      if (code) codes.add(code);
    }

    return Array.from(codes.values()).sort((a, b) => a.localeCompare(b));
  }, [scheduleSource, schedulePreviewTasksAll, scheduleOrgTasksAll]);

  const scheduleOrgGroupFilterSet = useMemo(
    () => new Set(scheduleOrgGroupFilters),
    [scheduleOrgGroupFilters],
  );

  // Tasks used for the edit panel and override/dependency editing always come
  // from the PREVIEW source so that overrides remain keyed by the synthetic
  // work package ids (wp-1, wp-2, ...). Filters still apply.
  const scheduleTasks: any[] = useMemo(() => {
    const all = schedulePreviewTasksAll;

    if (all.length === 0) return [];

    const filtered = all.filter((t: any) => {
      const room = String(t?.room ?? "").trim();
      const unitLabel = roomToUnitLabel.get(room) ?? (room ? "Unassigned" : "Project");

      const explicit = String((t as any)?.orgGroupCode ?? "").trim();
      const groupCode = explicit || scheduleExtractGroupCode(room);

      if (scheduleOrgGroupFilterSet.size > 0) {
        if (!groupCode || !scheduleOrgGroupFilterSet.has(groupCode)) return false;
      }

      if (scheduleUnitFilter && scheduleUnitFilter !== "ALL") {
        if (unitLabel !== scheduleUnitFilter) return false;
      }

      return true;
    });

    const hasFilters =
      scheduleOrgGroupFilterSet.size > 0 ||
      (scheduleUnitFilter && scheduleUnitFilter !== "ALL");

    if (!hasFilters) return all;
    return filtered;
  }, [
    schedulePreviewTasksAll,
    scheduleOrgGroupFilterSet,
    scheduleUnitFilter,
    roomToUnitLabel,
  ]);

  // Tasks feeding the Gantt come from whichever schedule source is active.
  const scheduleGanttTasks: any[] = useMemo(() => {
    const baseAll =
      scheduleSource === "ORG" && scheduleOrgTasksAll.length > 0
        ? scheduleOrgTasksAll
        : schedulePreviewTasksAll;

    if (baseAll.length === 0) return [];

    const filtered = baseAll.filter((t: any) => {
      const room = String(t?.room ?? "").trim();
      const unitLabel = roomToUnitLabel.get(room) ?? (room ? "Unassigned" : "Project");

      const explicit = String((t as any)?.orgGroupCode ?? "").trim();
      const groupCode = explicit || scheduleExtractGroupCode(room);

      if (scheduleOrgGroupFilterSet.size > 0) {
        if (!groupCode || !scheduleOrgGroupFilterSet.has(groupCode)) return false;
      }

      if (scheduleUnitFilter && scheduleUnitFilter !== "ALL") {
        if (unitLabel !== scheduleUnitFilter) return false;
      }

      return true;
    });

    const hasFilters =
      scheduleOrgGroupFilterSet.size > 0 ||
      (scheduleUnitFilter && scheduleUnitFilter !== "ALL");

    if (!hasFilters) return baseAll;
    return filtered;
  }, [
    scheduleSource,
    schedulePreviewTasksAll,
    scheduleOrgTasksAll,
    scheduleOrgGroupFilterSet,
    scheduleUnitFilter,
    roomToUnitLabel,
  ]);

  const scheduleTaskById = useMemo(() => {
    const m = new Map<string, any>();
    for (const t of schedulePreviewTasksAll) {
      if (t?.id) m.set(String(t.id), t);
    }
    return m;
  }, [schedulePreviewTasksAll]);

  const buildOverridesFromDrafts = useCallback(() => {
    // Start with explicit overrides.
    const overrides: Record<string, { durationDays?: number; startDate?: string; lockType?: "SOFT" | "HARD" }> =
      JSON.parse(JSON.stringify(scheduleDraftOverrides || {}));

    // Apply dependency-derived start date constraints.
    for (const [taskId, deps] of Object.entries(scheduleDraftDeps || {})) {
      if (!Array.isArray(deps) || deps.length === 0) continue;

      let requiredStart = "";
      for (const dep of deps) {
        const predId = String(dep?.predecessorId ?? "").trim();
        if (!predId) continue;
        const pred = scheduleTaskById.get(predId);
        if (!pred) continue;

        const predEnd = String(pred?.endDate ?? pred?.startDate ?? "").trim();
        if (!predEnd) continue;

        const lag = Number(dep?.lagDays ?? 0);
        const candidate = bumpToWeekdayIso(addDaysIso(predEnd, Number.isFinite(lag) ? lag : 0));
        requiredStart = requiredStart ? maxIso(requiredStart, candidate) : candidate;
      }

      if (!requiredStart) continue;

      const existing = overrides[taskId] ?? {};
      const nextStart = existing.startDate ? maxIso(existing.startDate, requiredStart) : requiredStart;
      overrides[taskId] = { ...existing, startDate: nextStart };
    }

    return overrides;
  }, [scheduleDraftOverrides, scheduleDraftDeps, scheduleTaskById]);

  const scheduleGanttText = useMemo(
    () => {
      const allTasks: any[] = scheduleGanttTasks;

    if (allTasks.length === 0) return "";

    // Keep diagram sizes manageable by letting the user window the chart.
    const fromIso = scheduleViewPreset === "ALL" ? "" : String(scheduleViewFrom || "").trim();
    const toIso = scheduleViewPreset === "ALL" ? "" : String(scheduleViewTo || "").trim();

    const tasks = allTasks.filter((t) => {
      if (scheduleViewPreset === "ALL") return true;
      const s = String(t?.startDate ?? "").trim();
      const e = String(t?.endDate ?? t?.startDate ?? "").trim();

      // If we don't have valid window bounds, fall back to showing everything.
      if (!fromIso || !toIso) return true;
      if (!s || !e) return true;

      // overlap test (inclusive)
      return s <= toIso && e >= fromIso;
    });

    if (tasks.length === 0) return "";

    const titleSuffix =
      scheduleViewPreset === "ALL"
        ? ""
        : ` · ${fromIso || "?"} → ${toIso || "?"}`;

    const titleBase =
      scheduleSource === "ORG" ? "Project Schedule (org structure)" : "Project Schedule (preview)";

    const daysBetweenIso = (aIso: string, bIso: string): number => {
      const a = new Date(aIso);
      const b = new Date(bIso);
      if (Number.isNaN(a.getTime()) || Number.isNaN(b.getTime())) return 0;
      const ms = b.getTime() - a.getTime();
      return Math.max(0, Math.round(ms / (1000 * 60 * 60 * 24)));
    };

    const inferredZoom = (() => {
      if (scheduleZoom !== "AUTO") return scheduleZoom;

      // Prefer the user-selected window bounds if present, otherwise infer from tasks.
      let from = fromIso;
      let to = toIso;

      if (!from || !to) {
        let min = "";
        let max = "";
        for (const t of tasks) {
          const s = String(t?.startDate ?? "").trim();
          const e = String(t?.endDate ?? t?.startDate ?? "").trim();
          if (s && (!min || s < min)) min = s;
          if (e && (!max || e > max)) max = e;
        }
        from = min;
        to = max;
      }

      const spanDays = from && to ? daysBetweenIso(from, to) : 0;
      if (spanDays <= 21) return "DAY";
      if (spanDays <= 140) return "WEEK";
      return "MONTH";
    })();

    const axisFormat =
      inferredZoom === "MONTH"
        ? "%b %Y"
        : inferredZoom === "WEEK"
        ? "%b W%W"
        : "%b %d";

    const tickInterval =
      inferredZoom === "MONTH"
        ? "1month"
        : inferredZoom === "WEEK"
        ? "1week"
        : "1day";

    const header: string[] = [
      "gantt",
      `  title ${titleBase}${titleSuffix}`,
      "  dateFormat  YYYY-MM-DD",
      `  axisFormat  ${axisFormat}`,
      `  tickInterval ${tickInterval}`,
      // Keep work weeks aligned to Monday.
      ...(inferredZoom === "WEEK" ? ["  weekday monday"] : []),
      "",
    ];

    const groupOf = (t: any): string => {
      if (scheduleGroupMode === "TRADE") {
        return String(t?.trade ?? "Unknown").trim() || "Unknown";
      }

      const room = String(t?.room ?? "").trim();
      if (scheduleGroupMode === "UNIT") {
        return roomToUnitLabel.get(room) ?? (room ? "Unassigned" : "Project");
      }

      return room || "Project";
    };

    const hoursSuffixOf = (t: any): string => {
      const h = Number(t?.totalLaborHours);
      if (!Number.isFinite(h) || h <= 0) return "";
      const rounded = h >= 100 ? Math.round(h) : Math.round(h * 10) / 10;
      return ` (${rounded}h)`;
    };

    const labelOf = (t: any): string => {
      const hoursSuffix = hoursSuffixOf(t);

      const room = String(t?.room ?? "Project").trim() || "Project";
      const trade = String(t?.trade ?? "Trade").trim() || "Trade";
      const phase = String(t?.phaseLabel ?? "Work").trim() || "Work";

      if (scheduleGroupMode === "TRADE") {
        return `${room} · ${phase}${hoursSuffix}`;
      }

      if (scheduleGroupMode === "UNIT") {
        return `${room} · ${trade} · ${phase}${hoursSuffix}`;
      }

      return `${trade} · ${phase}${hoursSuffix}`;
    };

    const durationToken = (t: any): string => {
      const d = Number(t?.durationDays);
      if (!Number.isFinite(d) || d <= 0) return "1d";
      if (Math.abs(d - Math.round(d)) < 1e-9) {
        return `${Math.round(d)}d`;
      }
      // Mermaid supports hour durations (e.g. 4h) and our scheduler uses 8h/day.
      const hours = Math.max(1, Math.round(d * 8));
      return `${hours}h`;
    };

    const grouped = new Map<string, any[]>();
    for (const t of tasks) {
      const g = groupOf(t);
      const arr = grouped.get(g);
      if (arr) arr.push(t);
      else grouped.set(g, [t]);
    }

    // When grouping by Unit, sort using the same numeric-friendly logic as the
    // PETL project grouping (Unit 1, Unit 2, ... Unit 10) instead of
    // pure lexicographic order (which would put "Unit 10" before "Unit 2").
    const unitSortKey = (label: string) => {
      const s = String(label ?? "");
      const m = s.match(/^Unit\s+0*(\d+)\b/i);
      if (m) {
        const n = Number(m[1]);
        if (Number.isFinite(n)) return { kind: 0, n, s };
      }
      return { kind: 1, n: Number.POSITIVE_INFINITY, s: s.toLowerCase() };
    };

    let groupNames = Array.from(grouped.keys());
    if (scheduleGroupMode === "UNIT") {
      groupNames = groupNames.sort((a, b) => {
        const ka = unitSortKey(a);
        const kb = unitSortKey(b);
        if (ka.kind !== kb.kind) return ka.kind - kb.kind;
        if (ka.n !== kb.n) return ka.n - kb.n;
        return ka.s.localeCompare(kb.s);
      });
    } else {
      groupNames = groupNames.sort((a, b) => a.localeCompare(b));
    }

    for (const groupName of groupNames) {
      header.push(`  section ${groupName.replace(/\r|\n/g, " ")}`);
      const groupTasks = grouped.get(groupName) ?? [];
      groupTasks.sort((a, b) => {
        const sa = String(a?.startDate ?? "");
        const sb = String(b?.startDate ?? "");
        if (sa !== sb) return sa.localeCompare(sb);
        const pa = Number(a?.phaseCode ?? 0);
        const pb = Number(b?.phaseCode ?? 0);
        return pa - pb;
      });

      for (const t of groupTasks) {
        const start = String(t?.startDate ?? "").trim();
        if (!start) continue;

        const rawLabel = labelOf(t).replace(/:/g, "-");

        // Keep the hours suffix visible even when truncating.
        const hoursMatch = rawLabel.match(/ \([0-9.]+h\)$/);
        const hoursSuffix = hoursMatch ? hoursMatch[0] : "";
        const base = hoursSuffix ? rawLabel.slice(0, -hoursSuffix.length) : rawLabel;

        const maxLen = 72;
        const baseMax = Math.max(20, maxLen - hoursSuffix.length);
        const baseTrunc = base.length > baseMax ? `${base.slice(0, Math.max(0, baseMax - 1))}…` : base;
        const label = `${baseTrunc}${hoursSuffix}`;
        const id = makeMermaidSafeId(`${t?.id ?? "task"}_${groupName}`);
        header.push(`  ${label}: ${id}, ${start}, ${durationToken(t)}`);
      }

      header.push("");
    }

    return header.join("\n");
  }, [
    scheduleTasks,
    scheduleGroupMode,
    roomToUnitLabel,
    scheduleViewPreset,
    scheduleViewFrom,
    scheduleViewTo,
    scheduleZoom,
  ]);

  const renderSchedulePanel = (opts: { mode: "SUMMARY" | "SCHEDULE" }) => (
    <div
      style={{
        borderRadius: 8,
        border: "1px solid #e5e7eb",
        background: "#ffffff",
        marginBottom: 12,
      }}
    >
      <div
        style={{
          padding: "6px 10px",
          borderBottom: "1px solid #e5e7eb",
          fontSize: 13,
          fontWeight: 600,
          background: "#f3f4f6",
          display: "flex",
          alignItems: "center",
          justifyContent: "space-between",
          gap: 12,
          flexWrap: "wrap",
        }}
      >
        <span>Schedule (Gantt)</span>

        <div style={{ display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
          {opts.mode === "SUMMARY" && (
            <button
              type="button"
              onClick={() => setScheduleSummaryExpandedTransition((v) => !v)}
              style={{
                padding: "4px 8px",
                borderRadius: 6,
                border: "1px solid #d1d5db",
                background: "#ffffff",
                cursor: "pointer",
                fontSize: 12,
              }}
            >
              {scheduleSummaryExpanded ? "Hide Schedule" : "Show Schedule"}
            </button>
          )}

          {(opts.mode === "SCHEDULE" || scheduleSummaryExpanded) && (
            <Fragment>
              <div style={{ display: "flex", gap: 6, alignItems: "center", fontSize: 12 }}>
                <span style={{ color: "#6b7280" }}>Source:</span>
                <button
                  type="button"
                  onClick={() => setScheduleSourceTransition("PREVIEW")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleSource === "PREVIEW" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                  title="Xact-driven estimate preview (live interpolation)"
                >
                  Estimate (Xact)
                </button>
                <button
                  type="button"
                  onClick={() => setScheduleSourceTransition("ORG")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleSource === "ORG" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                  title="Canonical org-structure schedule (persisted)"
                >
                  Org structure
                </button>
              </div>

              <button
                type="button"
                onClick={() => {
                  setScheduleOverridesPayload(buildOverridesFromDrafts());
                  setScheduleReloadTick((t) => t + 1);
                }}
                style={{
                  padding: "4px 8px",
                  borderRadius: 6,
                  border: "1px solid #d1d5db",
                  background: "#ffffff",
                  cursor: "pointer",
                  fontSize: 12,
                }}
                title="Apply manual edits (durations / dependencies) to the preview"
              >
                Apply edits
              </button>

              <button
                type="button"
                onClick={() => {
                  setScheduleDraftOverrides({});
                  setScheduleDraftDeps({});
                  setScheduleOverridesPayload(null);
                  setScheduleReloadTick((t) => t + 1);
                }}
                style={{
                  padding: "4px 8px",
                  borderRadius: 6,
                  border: "1px solid #d1d5db",
                  background: "#ffffff",
                  cursor: "pointer",
                  fontSize: 12,
                }}
                title="Clear manual edits"
              >
                Reset edits
              </button>
              <div style={{ display: "flex", gap: 6, alignItems: "center", fontSize: 12 }}>
                <span style={{ color: "#6b7280" }}>Group:</span>
                <button
                  type="button"
                  onClick={() => setScheduleGroupModeTransition("ROOM")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleGroupMode === "ROOM" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Room
                </button>
                <button
                  type="button"
                  onClick={() => setScheduleGroupModeTransition("TRADE")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleGroupMode === "TRADE" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Trade
                </button>
                <button
                  type="button"
                  onClick={() => setScheduleGroupModeTransition("UNIT")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleGroupMode === "UNIT" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Unit
                </button>
              </div>

              {/* Optional: filter schedule to a single Unit to approximate a
                  collapsible project organization view. */}
              {scheduleGroupMode === "UNIT" && scheduleUnitLabels.length > 0 && (
                <div style={{ display: "flex", gap: 6, alignItems: "center", fontSize: 12 }}>
                  <span style={{ color: "#6b7280" }}>Unit scope:</span>
                  <select
                    value={scheduleUnitFilter}
                    onChange={(e) => setScheduleUnitFilter(e.target.value)}
                    style={{
                      padding: "3px 6px",
                      borderRadius: 6,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                    }}
                  >
                    <option value="ALL">All units</option>
                    {scheduleUnitLabels.map((label) => (
                      <option key={label} value={label}>
                        {label}
                      </option>
                    ))}
                  </select>
                </div>
              )}

              {scheduleOrgGroupCodes.length > 0 && (
                <div style={{ display: "flex", gap: 6, alignItems: "center", fontSize: 12 }}>
                  <span style={{ color: "#6b7280" }}>Org group:</span>
                  <CheckboxMultiSelect
                    placeholder="All groups"
                    options={scheduleOrgGroupCodes.map((code) => ({ value: code, label: code }))}
                    selectedValues={scheduleOrgGroupFilters}
                    onChangeSelectedValues={setScheduleOrgGroupFilters}
                    minWidth={160}
                    minListHeight={220}
                  />
                </div>
              )}

              <div style={{ display: "flex", gap: 6, alignItems: "center", fontSize: 12 }}>
                <span style={{ color: "#6b7280" }}>Schedule Start:</span>
                <input
                  type="date"
                  value={scheduleStartDate}
                  onChange={(e) => setScheduleStartDate(e.target.value)}
                  style={{
                    padding: "3px 6px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                  }}
                />
              </div>
              <div style={{ display: "flex", gap: 6, alignItems: "center", fontSize: 12 }}>
                <span style={{ color: "#6b7280" }}>Zoom:</span>
                <button
                  type="button"
                  onClick={() => setScheduleZoomTransition("AUTO")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleZoom === "AUTO" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Auto
                </button>
                <button
                  type="button"
                  onClick={() => setScheduleZoomTransition("DAY")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleZoom === "DAY" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Day
                </button>
                <button
                  type="button"
                  onClick={() => setScheduleZoomTransition("WEEK")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleZoom === "WEEK" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Week
                </button>
                <button
                  type="button"
                  onClick={() => setScheduleZoomTransition("MONTH")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleZoom === "MONTH" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Month
                </button>
              </div>

              <div style={{ display: "flex", gap: 6, alignItems: "center", fontSize: 12 }}>
                <span style={{ color: "#6b7280" }}>Window:</span>

                <button
                  type="button"
                  onClick={() => setScheduleViewPresetTransition("ALL")}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: scheduleViewPreset === "ALL" ? "#e0f2fe" : "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  All
                </button>

                {([
                  { key: "30D", label: "30d" },
                  { key: "60D", label: "60d" },
                  { key: "90D", label: "90d" },
                ] as { key: "30D" | "60D" | "90D"; label: string }[]).map((p) => (
                  <button
                    key={p.key}
                    type="button"
                    onClick={() => setScheduleViewPresetTransition(p.key)}
                    style={{
                      padding: "4px 8px",
                      borderRadius: 6,
                      border: "1px solid #d1d5db",
                      background: scheduleViewPreset === p.key ? "#e0f2fe" : "#ffffff",
                      cursor: "pointer",
                      fontSize: 12,
                    }}
                  >
                    {p.label}
                  </button>
                ))}

                <input
                  type="date"
                  value={scheduleViewFrom}
                  onChange={(e) => {
                    setScheduleViewPreset("CUSTOM");
                    setScheduleViewFrom(e.target.value);
                  }}
                  style={{
                    padding: "3px 6px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                  }}
                  disabled={scheduleViewPreset === "ALL"}
                  title="Window start"
                />
                <span style={{ color: "#6b7280" }}>→</span>
                <input
                  type="date"
                  value={scheduleViewTo}
                  onChange={(e) => {
                    setScheduleViewPreset("CUSTOM");
                    setScheduleViewTo(e.target.value);
                  }}
                  style={{
                    padding: "3px 6px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                  }}
                  disabled={scheduleViewPreset === "ALL"}
                  title="Window end"
                />
              </div>

              <button
                type="button"
                onClick={() => setScheduleReloadTickTransition((t) => t + 1)}
                style={{
                  padding: "4px 8px",
                  borderRadius: 6,
                  border: "1px solid #d1d5db",
                  background: "#ffffff",
                  cursor: "pointer",
                  fontSize: 12,
                }}
              >
                Refresh
              </button>
            </Fragment>
          )}
        </div>
      </div>

      {opts.mode === "SUMMARY" && !scheduleSummaryExpanded ? null : (
        <div style={{ padding: 10 }}>
          {!petlEstimateVersionId && (
            <div style={{ fontSize: 12, color: "#6b7280" }}>
              Waiting for estimate data… (Open PETL at least once, or import Xactimate RAW + Components.)
            </div>
          )}

        {petlEstimateVersionId && scheduleSource === "PREVIEW" && schedulePreviewLoading && (
          <div style={{ fontSize: 12, color: "#6b7280" }}>Generating schedule preview…</div>
        )}

        {petlEstimateVersionId && scheduleSource === "ORG" && schedulePersistedLoading && (
          <div style={{ fontSize: 12, color: "#6b7280" }}>Loading canonical org schedule…</div>
        )}

        {petlEstimateVersionId &&
          scheduleSource === "PREVIEW" &&
          schedulePreviewError &&
          !schedulePreviewLoading && (
            <div
              style={{
                marginTop: 8,
                padding: 10,
                borderRadius: 8,
                border: "1px solid #fecaca",
                background: "#fef2f2",
                color: "#991b1b",
                fontSize: 12,
              }}
            >
              {schedulePreviewError}
            </div>
          )}

        {petlEstimateVersionId &&
          scheduleSource === "ORG" &&
          schedulePersistedError &&
          !schedulePersistedLoading && (
            <div
              style={{
                marginTop: 8,
                padding: 10,
                borderRadius: 8,
                border: "1px solid #fecaca",
                background: "#fef2f2",
                color: "#991b1b",
                fontSize: 12,
              }}
            >
              {schedulePersistedError}
            </div>
          )}

        {petlEstimateVersionId &&
          !schedulePreviewError &&
          !schedulePersistedError &&
          !schedulePreviewLoading &&
          !schedulePersistedLoading &&
          !scheduleGanttText && (
            <div style={{ fontSize: 12, color: "#6b7280" }}>
              No schedule tasks available yet. (Make sure Xact RAW + Components are imported.)
            </div>
          )}

        {petlEstimateVersionId && scheduleGanttText && (
          <div style={{ marginTop: 10 }}>
            <MermaidGantt ganttText={scheduleGanttText} stickyHeader maxHeightPx={1280} />
          </div>
        )}

        {/* Edit panel (basic) */}
        {petlEstimateVersionId && scheduleTasks.length > 0 && (
          <div style={{ marginTop: 12 }}>
            <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Edit schedule</div>
            <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 6 }}>
              Select a task to override duration/start. Dependencies are modeled as “must start after predecessor end + lag days”.
            </div>

            <div style={{ maxHeight: 440, overflow: "auto", border: "1px solid #e5e7eb", borderRadius: 8 }}>
              <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                <thead style={{ position: "sticky", top: 0, background: "#f9fafb" }}>
                  <tr>
                    <th style={{ textAlign: "left", padding: "6px 8px", borderBottom: "1px solid #e5e7eb" }}>Task</th>
                    <th style={{ textAlign: "left", padding: "6px 8px", borderBottom: "1px solid #e5e7eb" }}>Start</th>
                    <th style={{ textAlign: "left", padding: "6px 8px", borderBottom: "1px solid #e5e7eb" }}>End</th>
                    <th style={{ textAlign: "right", padding: "6px 8px", borderBottom: "1px solid #e5e7eb" }}>Days</th>
                    <th style={{ textAlign: "right", padding: "6px 8px", borderBottom: "1px solid #e5e7eb" }}>Hours</th>
                    <th style={{ padding: "6px 8px", borderBottom: "1px solid #e5e7eb" }} />
                  </tr>
                </thead>
                <tbody>
                  {scheduleTasks
                    .filter((t) => String(t?.kind ?? "") !== "MITIGATION")
                    .slice()
                    .sort((a, b) => String(a?.startDate ?? "").localeCompare(String(b?.startDate ?? "")))
                    .slice(0, 200)
                    .map((t) => {
                      const taskId = String(t.id);
                      const isOpen = scheduleInlineEditTaskId === taskId;
                      const override = scheduleDraftOverrides[taskId] ?? {};
                      const deps = scheduleDraftDeps[taskId] ?? [];

                      const setOverride = (patch: any) => {
                        setScheduleDraftOverrides((prev) => ({
                          ...prev,
                          [taskId]: { ...(prev[taskId] ?? {}), ...patch },
                        }));
                      };

                      const setDeps = (next: any[]) => {
                        setScheduleDraftDeps((prev) => ({
                          ...prev,
                          [taskId]: next,
                        }));
                      };

                      const allTaskOptions = isOpen
                        ? scheduleTasks
                            .filter(
                              (x) =>
                                x &&
                                String(x.id) !== taskId &&
                                String(x.kind ?? "") !== "MITIGATION",
                            )
                            .slice()
                            .sort((a, b) =>
                              String(a?.startDate ?? "").localeCompare(
                                String(b?.startDate ?? ""),
                              ),
                            )
                        : [];

                      return (
                        <Fragment key={taskId}>
                          <tr>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderBottom: "1px solid #f3f4f6",
                              }}
                            >
                              <div style={{ fontWeight: 600 }}>{taskId}</div>
                              <div style={{ color: "#6b7280" }}>
                                {(String(t?.room ?? "") || "Project") +
                                  " · " +
                                  (String(t?.trade ?? "") || "")}
                              </div>
                            </td>
                            <td style={{ padding: "6px 8px", borderBottom: "1px solid #f3f4f6" }}>
                              {String(t?.startDate ?? "")}
                            </td>
                            <td style={{ padding: "6px 8px", borderBottom: "1px solid #f3f4f6" }}>
                              {String(t?.endDate ?? "")}
                            </td>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderBottom: "1px solid #f3f4f6",
                                textAlign: "right",
                              }}
                            >
                              {Number(t?.durationDays ?? 0).toFixed(1)}
                            </td>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderBottom: "1px solid #f3f4f6",
                                textAlign: "right",
                              }}
                            >
                              {Number(t?.totalLaborHours ?? 0).toFixed(0)}
                            </td>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderBottom: "1px solid #f3f4f6",
                                textAlign: "right",
                              }}
                            >
                              <button
                                type="button"
                                onClick={() =>
                                  setScheduleInlineEditTaskId((prev) =>
                                    prev === taskId ? null : taskId,
                                  )
                                }
                                style={{
                                  padding: "4px 8px",
                                  borderRadius: 6,
                                  border: "1px solid #d1d5db",
                                  background: "#ffffff",
                                  cursor: "pointer",
                                  fontSize: 12,
                                }}
                              >
                                {isOpen ? "Close" : "Edit"}
                              </button>
                            </td>
                          </tr>

                          {isOpen && (
                            <tr>
                              <td
                                colSpan={6}
                                style={{
                                  padding: 10,
                                  borderBottom: "1px solid #f3f4f6",
                                  background: "#f9fafb",
                                }}
                              >
                                <div
                                  style={{
                                    display: "flex",
                                    gap: 12,
                                    flexWrap: "wrap",
                                    alignItems: "center",
                                    marginBottom: 10,
                                  }}
                                >
                                  <label
                                    style={{
                                      display: "flex",
                                      gap: 6,
                                      alignItems: "center",
                                      fontSize: 12,
                                    }}
                                  >
                                    <span style={{ color: "#6b7280" }}>Start</span>
                                    <input
                                      type="date"
                                      value={override.startDate ?? ""}
                                      onChange={(e) =>
                                        setOverride({
                                          startDate: e.target.value || undefined,
                                        })
                                      }
                                      style={{
                                        padding: "3px 6px",
                                        borderRadius: 6,
                                        border: "1px solid #d1d5db",
                                        fontSize: 12,
                                      }}
                                    />
                                    <button
                                      type="button"
                                      onClick={() => setOverride({ startDate: undefined })}
                                      style={{
                                        padding: "3px 6px",
                                        borderRadius: 6,
                                        border: "1px solid #d1d5db",
                                        background: "#ffffff",
                                        cursor: "pointer",
                                        fontSize: 12,
                                      }}
                                    >
                                      Clear
                                    </button>
                                  </label>

                                  <label
                                    style={{
                                      display: "flex",
                                      gap: 6,
                                      alignItems: "center",
                                      fontSize: 12,
                                    }}
                                  >
                                    <span style={{ color: "#6b7280" }}>Lock</span>
                                    <select
                                      value={override.lockType ?? "SOFT"}
                                      onChange={(e) =>
                                        setOverride({ lockType: e.target.value as any })
                                      }
                                      style={{
                                        padding: "3px 6px",
                                        borderRadius: 6,
                                        border: "1px solid #d1d5db",
                                        fontSize: 12,
                                      }}
                                    >
                                      <option value="SOFT">Soft</option>
                                      <option value="HARD">Hard</option>
                                    </select>
                                  </label>

                                  <label
                                    style={{
                                      display: "flex",
                                      gap: 6,
                                      alignItems: "center",
                                      fontSize: 12,
                                    }}
                                  >
                                    <span style={{ color: "#6b7280" }}>Duration</span>
                                    <input
                                      type="number"
                                      step="0.5"
                                      min="0"
                                      value={override.durationDays ?? ""}
                                      onChange={(e) => {
                                        const v = e.target.value;
                                        const n = v === "" ? undefined : Number(v);
                                        setOverride({
                                          durationDays:
                                            n && Number.isFinite(n) ? n : undefined,
                                        });
                                      }}
                                      style={{
                                        width: 110,
                                        padding: "3px 6px",
                                        borderRadius: 6,
                                        border: "1px solid #d1d5db",
                                        fontSize: 12,
                                      }}
                                    />
                                    <span style={{ color: "#6b7280" }}>days</span>
                                    <button
                                      type="button"
                                      onClick={() => setOverride({ durationDays: undefined })}
                                      style={{
                                        padding: "3px 6px",
                                        borderRadius: 6,
                                        border: "1px solid #d1d5db",
                                        background: "#ffffff",
                                        cursor: "pointer",
                                        fontSize: 12,
                                      }}
                                    >
                                      Clear
                                    </button>
                                  </label>
                                </div>

                                <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 6 }}>
                                  Dependencies
                                </div>

                                <div
                                  style={{
                                    display: "flex",
                                    gap: 8,
                                    alignItems: "center",
                                    marginBottom: 8,
                                    flexWrap: "wrap",
                                  }}
                                >
                                  <select
                                    defaultValue=""
                                    onChange={(e) => {
                                      const pred = e.target.value;
                                      if (!pred) return;
                                      e.target.value = "";
                                      if (deps.some((d: any) => d.predecessorId === pred)) return;
                                      setDeps([...deps, { predecessorId: pred, lagDays: 0 }]);
                                    }}
                                    style={{
                                      padding: "3px 6px",
                                      borderRadius: 6,
                                      border: "1px solid #d1d5db",
                                      fontSize: 12,
                                      maxWidth: 520,
                                    }}
                                  >
                                    <option value="">+ Add predecessor…</option>
                                    {allTaskOptions.slice(0, 400).map((x: any) => (
                                      <option key={String(x.id)} value={String(x.id)}>
                                        {String(x.id)} — {(String(x.room ?? "") || "Project") +
                                          " · " +
                                          String(x.trade ?? "")}
                                      </option>
                                    ))}
                                  </select>
                                  <span style={{ color: "#6b7280" }}>
                                    Lag days (negative = lead/overlap)
                                  </span>
                                </div>

                                {deps.length === 0 ? (
                                  <div style={{ fontSize: 12, color: "#6b7280" }}>
                                    No manual dependencies.
                                  </div>
                                ) : (
                                  <div style={{ border: "1px solid #e5e7eb", borderRadius: 8 }}>
                                    {deps.map((d: any, idx: number) => (
                                      <div
                                        key={d.predecessorId}
                                        style={{
                                          display: "flex",
                                          gap: 10,
                                          alignItems: "center",
                                          padding: "6px 8px",
                                          borderTop: idx === 0 ? "none" : "1px solid #f3f4f6",
                                          background: "#ffffff",
                                        }}
                                      >
                                        <div style={{ flex: 1 }}>
                                          <div style={{ fontWeight: 600, fontSize: 12 }}>{d.predecessorId}</div>
                                          <div style={{ color: "#6b7280", fontSize: 11 }}>
                                            Ends {String(scheduleTaskById.get(d.predecessorId)?.endDate ?? "")}
                                          </div>
                                        </div>

                                        <label
                                          style={{
                                            display: "flex",
                                            gap: 6,
                                            alignItems: "center",
                                            fontSize: 12,
                                          }}
                                        >
                                          <span style={{ color: "#6b7280" }}>Lag</span>
                                          <input
                                            type="number"
                                            step="1"
                                            value={Number(d.lagDays ?? 0)}
                                            onChange={(e) => {
                                              const n = Number(e.target.value);
                                              const next = deps.slice();
                                              next[idx] = {
                                                ...next[idx],
                                                lagDays: Number.isFinite(n) ? n : 0,
                                              };
                                              setDeps(next);
                                            }}
                                            style={{
                                              width: 90,
                                              padding: "3px 6px",
                                              borderRadius: 6,
                                              border: "1px solid #d1d5db",
                                              fontSize: 12,
                                            }}
                                          />
                                        </label>

                                        <button
                                          type="button"
                                          onClick={() => {
                                            setDeps(
                                              deps.filter((x: any) => x.predecessorId !== d.predecessorId),
                                            );
                                          }}
                                          style={{
                                            padding: "3px 6px",
                                            borderRadius: 6,
                                            border: "1px solid #d1d5db",
                                            background: "#ffffff",
                                            cursor: "pointer",
                                            fontSize: 12,
                                          }}
                                        >
                                          Remove
                                        </button>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </td>
                            </tr>
                          )}
                        </Fragment>
                      );
                    })}
                </tbody>
              </table>
            </div>
          </div>
        )}

        </div>
      )}
    </div>
  );

  // Load pending PETL % update sessions (PM/owner/admin only)
  useEffect(() => {
    if (!project) return;
    if (activeTab !== "PETL") return;

    // Clear when not allowed so we don't show stale data after role changes.
    if (!isPmOrAbove) {
      setPendingPetlSessions(null);
      setPendingPetlError(null);
      setPendingPetlLoading(false);
      return;
    }

    const token = localStorage.getItem("accessToken");
    if (!token) return;

    let cancelled = false;

    const loadPending = async () => {
      setPendingPetlLoading(true);
      setPendingPetlError(null);
      try {
        const res = await fetch(
          `${API_BASE}/projects/${project.id}/petl/percent-updates/pending`,
          { headers: { Authorization: `Bearer ${token}` } },
        );

        if (cancelled) return;

        if (res.status === 403) {
          // Hide queue for non-PM roles.
          setPendingPetlSessions(null);
          return;
        }

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Failed to load pending approvals (${res.status}) ${text}`);
        }

        const json: any = await res.json();
        setPendingPetlSessions(Array.isArray(json) ? json : []);
      } catch (err: any) {
        if (!cancelled) {
          setPendingPetlError(err?.message ?? "Failed to load pending approvals.");
        }
      } finally {
        if (!cancelled) setPendingPetlLoading(false);
      }
    };

    void loadPending();

    return () => {
      cancelled = true;
    };
  }, [project, activeTab, isPmOrAbove, pendingPetlReloadTick]);

  // Load hierarchy lazily when STRUCTURE or FINANCIAL tab is opened
  // (FINANCIAL needs it for dynamic invoice grouping options)
  useEffect(() => {
    if (!project) return;
    if (activeTab !== "STRUCTURE" && activeTab !== "FINANCIAL") return;
    // Skip if already loaded (avoid re-fetching when switching between these tabs)
    if (hierarchy) return;
    const token = localStorage.getItem("accessToken");
    if (!token) return;

    let cancelled = false;

    const loadHierarchy = async () => {
      try {
        const hRes = await fetch(`${API_BASE}/projects/${project.id}/hierarchy`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (!cancelled && hRes.ok) {
          const json: any = await hRes.json();
          setHierarchy(json);
        }
      } catch {
        // optional
      }
    };

    void loadHierarchy();

    return () => {
      cancelled = true;
    };
  }, [project, activeTab, hierarchy]);

  // Load import structuring room buckets when STRUCTURE tab is opened
  useEffect(() => {
    if (!project) return;
    if (activeTab !== "STRUCTURE") return;
    const token = localStorage.getItem("accessToken");
    if (!token) return;

    let cancelled = false;

    const loadBuckets = async () => {
      try {
        setImportRoomBucketsLoading(true);
        setImportRoomBucketsSelection(new Set());
        const bucketsRes = await fetch(
          `${API_BASE}/projects/${project.id}/import-structure/room-buckets`,
          {
            headers: { Authorization: `Bearer ${token}` },
          },
        );
        if (cancelled) return;
        if (bucketsRes.ok) {
          const json: any = await bucketsRes.json();
          setImportRoomBuckets(Array.isArray(json.buckets) ? json.buckets : []);
        } else if (bucketsRes.status === 404) {
          setImportRoomBuckets([]);
        }
      } catch (err: any) {
        if (!cancelled) {
          setImportRoomBucketsError(
            err?.message ?? "Unable to load import structuring buckets.",
          );
        }
      } finally {
        if (!cancelled) setImportRoomBucketsLoading(false);
      }
    };

    void loadBuckets();

    return () => {
      cancelled = true;
    };
  }, [project, activeTab]);

  // Load organization-related metadata (company members, tags, participants, actor roles).
  // Keep this available for PM-gated actions in PETL/FINANCIAL tabs as well.
  useEffect(() => {
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) return;

    const shouldLoad =
      activeTab === "SUMMARY" ||
      activeTab === "DAILY_LOGS" ||
      activeTab === "PETL" ||
      activeTab === "FINANCIAL";
    if (!shouldLoad) return;

    let cancelled = false;

    const loadMeta = async () => {
      try {
        const [companyRes, meRes, tagRes, projTagsRes, partsRes] = await Promise.all([
          fetch(`${API_BASE}/companies/me`, {
            headers: { Authorization: `Bearer ${token}` },
          }),
          fetch(`${API_BASE}/users/me`, {
            headers: { Authorization: `Bearer ${token}` },
          }),
          fetch(`${API_BASE}/tags?entityType=project`, {
            headers: { Authorization: `Bearer ${token}` },
          }),
          fetch(`${API_BASE}/tags/projects/${project.id}`, {
            headers: { Authorization: `Bearer ${token}` },
          }),
          fetch(`${API_BASE}/projects/${project.id}/participants`, {
            headers: { Authorization: `Bearer ${token}` },
          }),
        ]);

        let myUserId: string | null = null;

        if (!cancelled && meRes.ok) {
          const meJson: any = await meRes.json();
          const globalRole: GlobalRole = meJson.globalRole ?? "NONE";
          setActorGlobalRole(globalRole);

          myUserId = meJson.id ?? null;
          setCurrentUserId(myUserId);
          const fullNameParts = [meJson.firstName, meJson.lastName].filter(Boolean);
          const fullName = fullNameParts.length ? fullNameParts.join(" ") : null;
          const displayName = fullName ? `${fullName} (${meJson.email})` : meJson.email;
          setActorDisplayName(displayName || null);

          const storedCompanyId =
            typeof window !== "undefined"
              ? window.localStorage.getItem("companyId")
              : null;
          let effectiveCompanyId = storedCompanyId;
          if (!effectiveCompanyId && Array.isArray(meJson.memberships) && meJson.memberships[0]) {
            effectiveCompanyId = meJson.memberships[0].companyId;
          }
          if (effectiveCompanyId) {
            setCurrentCompanyId(effectiveCompanyId);
            const membership = meJson.memberships?.find(
              (m: any) => m.companyId === effectiveCompanyId,
            );
            if (membership) {
              setActorCompanyRole(membership.role as CompanyRole);
            }
          }
        }

        if (!cancelled && companyRes.ok) {
          const companyJson: any = await companyRes.json();
          if (!currentCompanyId && companyJson?.id) {
            setCurrentCompanyId(companyJson.id);
          }
          const members: any[] = companyJson?.memberships ?? [];
          setAvailableMembers(
            members.map((m) => ({
              userId: m.userId,
              email: m.user?.email ?? "(user)",
              role: m.role,
            })),
          );
        }

        if (!cancelled && tagRes.ok) {
          const tagsJson: any[] = await tagRes.json();
          setAvailableTags(
            (tagsJson || []).map((t) => ({
              id: t.id,
              code: t.code,
              label: t.label,
              color: t.color ?? null,
            })),
          );
        }

        if (!cancelled && projTagsRes.ok) {
          const projTagsJson: TagAssignmentDto[] = await projTagsRes.json();
          setProjectTags(projTagsJson || []);
        }

        if (!cancelled && partsRes.ok) {
          const json: any = await partsRes.json();
          setParticipants({
            myOrganization: json.myOrganization ?? [],
            collaborators: json.collaborators ?? [],
          });

          if (myUserId) {
            const mine: Participant[] = (json.myOrganization ?? []).filter(
              (p: Participant) => p.userId === myUserId,
            );
            const roles = Array.from(new Set(mine.map(p => p.role).filter(Boolean)));
            setActorProjectRoles(roles.length ? roles : null);
          }
        }
      } catch {
        // optional; safe to ignore for now
      }
    };

    void loadMeta();

    return () => {
      cancelled = true;
    };
  }, [project, activeTab]);

  // Load daily logs only when DAILY_LOGS tab is active
  useEffect(() => {
    if (!project) return;
    if (activeTab !== "DAILY_LOGS") return;
    const token = localStorage.getItem("accessToken");
    if (!token) return;

    let cancelled = false;

    const loadLogs = async () => {
      try {
        setDailyLogsLoading(true);
        const logsRes = await fetch(`${API_BASE}/projects/${project.id}/daily-logs`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (!cancelled && logsRes.ok) {
          const json: any = await logsRes.json();
          const logs: DailyLog[] = Array.isArray(json) ? json : json.items ?? [];
          setDailyLogs(logs);
        }
      } catch {
        // leave logs empty on error
      } finally {
        if (!cancelled) setDailyLogsLoading(false);
      }
    };

    void loadLogs();

    return () => {
      cancelled = true;
    };
  }, [project, activeTab]);

  // Load Field PETL scope when DAILY_LOGS tab is active
  useEffect(() => {
    if (!project) return;
    if (activeTab !== "DAILY_LOGS") return;
    const token = localStorage.getItem("accessToken");
    if (!token) return;

    let cancelled = false;

    const loadFieldPetl = async () => {
      try {
        setFieldPetlLoading(true);
        setFieldPetlError(null);
        const res = await fetch(`${API_BASE}/projects/${project.id}/petl-field`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Field PETL load failed (${res.status}) ${text}`);
        }
        const json: any = await res.json();
        if (cancelled) return;
        const items: any[] = Array.isArray(json?.items) ? json.items : [];
        const mapped: FieldPetlItem[] = items.map((it: any) => ({
          sowItemId: String(it.id),
          lineNo: Number(it.lineNo ?? 0),
          roomParticleId: it.roomParticleId ?? null,
          roomName: it.roomName ?? null,
          categoryCode: it.categoryCode ?? null,
          selectionCode: it.selectionCode ?? null,
          activity: it.activity ?? null,
          description: it.description ?? null,
          unit: it.unit ?? null,
          originalQty: typeof it.originalQty === "number" ? it.originalQty : null,
          qty: typeof it.qty === "number" ? it.qty : null,
          qtyFlaggedIncorrect: !!it.qtyFlaggedIncorrect,
          qtyFieldReported:
            typeof it.qtyFieldReported === "number" ? it.qtyFieldReported : null,
          qtyReviewStatus: it.qtyReviewStatus ?? null,
          orgGroupCode: it.orgGroupCode ?? null,
        }));
        setFieldPetlItems(mapped);
      } catch (err: any) {
        if (!cancelled) {
          setFieldPetlError(err?.message ?? "Failed to load Field PETL.");
          setFieldPetlItems([]);
        }
      } finally {
        if (!cancelled) setFieldPetlLoading(false);
      }
    };

    void loadFieldPetl();

    return () => {
      cancelled = true;
    };
  }, [project, activeTab]);

  const fieldPetlOrgGroupFilterSet = useMemo(
    () => new Set(fieldPetlOrgGroupFilters),
    [fieldPetlOrgGroupFilters],
  );

  const fieldPetlOrgGroupCodes = useMemo(() => {
    const codes = new Set<string>();
    for (const it of fieldPetlItems) {
      const code = String(it.orgGroupCode ?? "").trim();
      if (code) codes.add(code);
    }
    return Array.from(codes.values()).sort((a, b) => a.localeCompare(b));
  }, [fieldPetlItems]);

  const openFieldPetlEdit = useCallback((item: FieldPetlItem) => {
    setFieldPetlEdit({
      item,
      incorrect: item.qtyFlaggedIncorrect,
      fieldQty:
        item.qtyFieldReported != null && !Number.isNaN(item.qtyFieldReported)
          ? String(item.qtyFieldReported)
          : "",
      newPercent: "",
      note: "",
      saving: false,
      error: null,
    });
  }, []);

  const closeFieldPetlEdit = useCallback(() => {
    setFieldPetlEdit(null);
  }, []);

  const submitFieldPetlEdit = useCallback(async () => {
    if (!project || !fieldPetlEdit) return;
    const { item, incorrect, fieldQty, newPercent, note } = fieldPetlEdit;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setFieldPetlEdit(prev => (prev ? { ...prev, error: "Missing access token." } : prev));
      return;
    }

    let parsedFieldQty: number | null = null;
    if (incorrect) {
      if (!fieldQty.trim()) {
        setFieldPetlEdit(prev => (prev ? { ...prev, error: "Enter a field quantity." } : prev));
        return;
      }
      parsedFieldQty = Number(fieldQty);
      if (!Number.isFinite(parsedFieldQty) || parsedFieldQty < 0) {
        setFieldPetlEdit(prev => (prev ? { ...prev, error: "Field qty must be a non-negative number." } : prev));
        return;
      }
    }

    let parsedPercent: number | null = null;
    const pctRaw = newPercent.trim();
    if (pctRaw !== "") {
      const n = Number(pctRaw);
      if (!Number.isFinite(n) || n < 0 || n > 100) {
        setFieldPetlEdit(prev => (prev ? { ...prev, error: "Percent must be between 0 and 100." } : prev));
        return;
      }
      parsedPercent = n;
    }

    setFieldPetlEdit(prev => (prev ? { ...prev, saving: true, error: null } : prev));

    try {
      // 1) Qty flags
      if (incorrect || item.qtyFlaggedIncorrect) {
        const payload = incorrect
          ? {
              items: [
                {
                  sowItemId: item.sowItemId,
                  qtyFlaggedIncorrect: true,
                  qtyFieldReported: parsedFieldQty,
                  notes: note || null,
                },
              ],
            }
          : {
              items: [
                {
                  sowItemId: item.sowItemId,
                  qtyFlaggedIncorrect: false,
                  qtyFieldReported: null,
                  notes: null,
                },
              ],
            };

        const res = await fetch(
          `${API_BASE}/projects/${project.id}/petl-field/qty-flags`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
          },
        );
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Qty flag failed (${res.status}) ${text}`);
        }
      }

      // 2) Percent update (optional)
      if (parsedPercent != null) {
        const res = await fetch(
          `${API_BASE}/projects/${project.id}/petl/percentage-edits`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              changes: [
                {
                  sowItemId: item.sowItemId,
                  newPercent: parsedPercent,
                },
              ],
            }),
          },
        );
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Percent update failed (${res.status}) ${text}`);
        }
      }

      // Reload Field PETL scope to reflect new flags
      try {
        const res = await fetch(`${API_BASE}/projects/${project.id}/petl-field`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (res.ok) {
          const json: any = await res.json();
          const items: any[] = Array.isArray(json?.items) ? json.items : [];
          const mapped: FieldPetlItem[] = items.map((it: any) => ({
            sowItemId: String(it.id),
            lineNo: Number(it.lineNo ?? 0),
            roomParticleId: it.roomParticleId ?? null,
            roomName: it.roomName ?? null,
            categoryCode: it.categoryCode ?? null,
            selectionCode: it.selectionCode ?? null,
            activity: it.activity ?? null,
            description: it.description ?? null,
            unit: it.unit ?? null,
            originalQty: typeof it.originalQty === "number" ? it.originalQty : null,
            qty: typeof it.qty === "number" ? it.qty : null,
            qtyFlaggedIncorrect: !!it.qtyFlaggedIncorrect,
            qtyFieldReported:
              typeof it.qtyFieldReported === "number" ? it.qtyFieldReported : null,
            qtyReviewStatus: it.qtyReviewStatus ?? null,
            orgGroupCode: it.orgGroupCode ?? null,
          }));
          setFieldPetlItems(mapped);
        }
      } catch {
        // non-fatal
      }

      // Close modal
      setFieldPetlEdit(null);
    } catch (err: any) {
      setFieldPetlEdit(prev =>
        prev ? { ...prev, saving: false, error: err?.message ?? "Save failed." } : prev,
      );
      return;
    }
  }, [project, fieldPetlEdit]);

  // Initial selection summary (no filters) once PETL items are present
  useEffect(() => {
    if (!project) return;
    if (!petlItems.length) return;
    const token = localStorage.getItem("accessToken");
    if (!token) return;

    let cancelled = false;

    const loadInitialSelection = async () => {
      try {
        const selRes = await fetch(
          `${API_BASE}/projects/${project.id}/petl-selection-summary`,
          {
            headers: { Authorization: `Bearer ${token}` },
          },
        );
        if (!cancelled && selRes.ok) {
          const json: any = await selRes.json();
          setSelectionSummary({
            itemCount: json.itemCount ?? 0,
            totalAmount: json.totalAmount ?? 0,
            completedAmount: json.completedAmount ?? 0,
            percentComplete: json.percentComplete ?? 0,
          });
        }
      } catch {
        // ignore, summary is optional
      }
    };

    void loadInitialSelection();

    return () => {
      cancelled = true;
    };
  }, [project, petlItems]);

  // Refresh selection summary whenever filters change
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;

    const params = new URLSearchParams();

    for (const roomParticleId of roomParticleIdFilters) {
      params.append("roomParticleId", roomParticleId);
    }
    for (const categoryCode of categoryCodeFilters) {
      params.append("categoryCode", categoryCode);
    }
    for (const selectionCode of selectionCodeFilters) {
      params.append("selectionCode", selectionCode);
    }

    let cancelled = false;

    // Always use the server for selection rollups so reconciliation adjustments
    // are included (even when no filters are set).
    fetch(
      `${API_BASE}/projects/${project.id}/petl-selection-summary?${params.toString()}`,
      {
        headers: { Authorization: `Bearer ${token}` }
      }
    )
      .then(res => (res.ok ? res.json() : null))
      .then(json => {
        if (cancelled || !json) return;
        setSelectionSummary({
          itemCount: json.itemCount ?? 0,
          totalAmount: json.totalAmount ?? 0,
          completedAmount: json.completedAmount ?? 0,
          percentComplete: json.percentComplete ?? 0
        });
      })
      .catch(() => {
        // ignore
      });

    return () => {
      cancelled = true;
    };
  }, [project, roomParticleIdFilters, categoryCodeFilters, selectionCodeFilters]);

  // Refresh selection summary when petlReloadTick changes (e.g., after reconciliation percent update)
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;
    if (petlReloadTick === 0) return; // Skip initial mount

    const params = new URLSearchParams();

    for (const roomParticleId of roomParticleIdFilters) {
      params.append("roomParticleId", roomParticleId);
    }
    for (const categoryCode of categoryCodeFilters) {
      params.append("categoryCode", categoryCode);
    }
    for (const selectionCode of selectionCodeFilters) {
      params.append("selectionCode", selectionCode);
    }

    let cancelled = false;

    fetch(
      `${API_BASE}/projects/${project.id}/petl-selection-summary?${params.toString()}`,
      {
        headers: { Authorization: `Bearer ${token}` }
      }
    )
      .then(res => (res.ok ? res.json() : null))
      .then(json => {
        if (cancelled || !json) return;
        setSelectionSummary({
          itemCount: json.itemCount ?? 0,
          totalAmount: json.totalAmount ?? 0,
          completedAmount: json.completedAmount ?? 0,
          percentComplete: json.percentComplete ?? 0
        });
      })
      .catch(() => {
        // ignore
      });

    return () => {
      cancelled = true;
    };
  }, [petlReloadTick, project, roomParticleIdFilters, categoryCodeFilters, selectionCodeFilters]);

  // Increment visit tick when entering Financial tab to trigger a fresh fetch
  useEffect(() => {
    if (activeTab === "FINANCIAL") {
      setFinancialTabVisitTick((t) => t + 1);
    }
  }, [activeTab]);

  // Fetch financial summary whenever we enter the Financial tab
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;
    if (activeTab !== "FINANCIAL") return;
    if (financialTabVisitTick === 0) return; // Skip initial mount

    let cancelled = false;

    setFinancialLoading(true);
    setFinancialError(null);

    fetch(`${API_BASE}/projects/${project.id}/financial-summary`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => (res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))))
      .then((json: any) => {
        if (cancelled) return;
        setFinancialSummary({
          totalRcvClaim: json.totalRcvClaim ?? 0,
          totalAcvClaim: json.totalAcvClaim ?? 0,
          workCompleteRcv: json.workCompleteRcv ?? 0,
          acvReturn: json.acvReturn ?? 0,
          opRate: json.opRate ?? 0,
          acvOP: json.acvOP ?? 0,
          totalDueWorkBillable: json.totalDueWorkBillable ?? 0,
          depositRate: json.depositRate ?? 0.5,
          depositBaseline: json.depositBaseline ?? 0,
          billedToDate: json.billedToDate ?? 0,
          duePayable: json.duePayable ?? 0,
          dueAmount: json.dueAmount ?? 0,
          snapshotComputedAt: json.snapshotComputedAt ?? null,
          snapshotSource: json.snapshotSource ?? "none",
        });
      })
      .catch((err: any) => {
        if (cancelled) return;
        setFinancialError(err?.message ?? "Failed to load financial summary.");
      })
      .finally(() => {
        if (cancelled) return;
        setFinancialLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [activeTab, project, financialTabVisitTick]);

  // Lazy-load PETL archives when Financial tab is opened (Admin/Owner)
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;
    if (activeTab !== "FINANCIAL") return;
    if (petlArchivesCollapsed) return;
    if (!isAdminOrAbove) return;
    if (petlArchives) return;

    let cancelled = false;

    setPetlArchivesLoading(true);
    setPetlArchivesError(null);

    fetch(`${API_BASE}/projects/${project.id}/petl-archives`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => (res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))))
      .then((json: any) => {
        if (cancelled) return;
        setPetlArchives(Array.isArray(json) ? json : []);
      })
      .catch((err: any) => {
        if (cancelled) return;
        setPetlArchivesError(err?.message ?? "Failed to load PETL archives.");
      })
      .finally(() => {
        if (cancelled) return;
        setPetlArchivesLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [activeTab, project, petlArchives, petlArchivesCollapsed, isAdminOrAbove]);

  // Lazy-load bills list when Financial tab is opened
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;
    if (activeTab !== "FINANCIAL") return;
    if (projectBills) return;

    let cancelled = false;

    setProjectBillsLoading(true);
    setProjectBillsError(null);

    fetch(`${API_BASE}/projects/${project.id}/bills`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => (res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))))
      .then((json: any) => {
        if (cancelled) return;
        setProjectBills(Array.isArray(json) ? json : []);
      })
      .catch((err: any) => {
        if (cancelled) return;
        setProjectBillsError(err?.message ?? "Failed to load bills.");
      })
      .finally(() => {
        if (cancelled) return;
        setProjectBillsLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [activeTab, project, projectBills]);

  // Lazy-load project files for bill/invoice attachment picker
  useEffect(() => {
    // Load when bill modal is open, invoice fullscreen, OR viewing an active invoice
    if (!billModalOpen && !invoiceFullscreen && !activeInvoice) return;
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) return;
    if (billAttachmentFileOptions) return;

    let cancelled = false;

    setBillAttachmentFileLoading(true);
    setBillAttachmentFileError(null);

    fetch(`${API_BASE}/projects/${project.id}/files`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => (res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))))
      .then((json: any) => {
        if (cancelled) return;
        setBillAttachmentFileOptions(Array.isArray(json) ? json : []);
      })
      .catch((err: any) => {
        if (cancelled) return;
        setBillAttachmentFileError(err?.message ?? "Failed to load project files.");
      })
      .finally(() => {
        if (cancelled) return;
        setBillAttachmentFileLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [billModalOpen, invoiceFullscreen, activeInvoice, project, billAttachmentFileOptions]);

  // Lazy-load invoices list when Financial tab is opened
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;
    if (activeTab !== "FINANCIAL") return;
    if (projectInvoices) return;

    let cancelled = false;

    setProjectInvoicesLoading(true);
    setProjectInvoicesError(null);

    fetch(`${API_BASE}/projects/${project.id}/invoices`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => (res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))))
      .then((json: any) => {
        if (cancelled) return;
        setProjectInvoices(Array.isArray(json) ? json : []);
      })
      .catch((err: any) => {
        if (cancelled) return;
        setProjectInvoicesError(err?.message ?? "Failed to load invoices.");
      })
      .finally(() => {
        if (cancelled) return;
        setProjectInvoicesLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [activeTab, project, projectInvoices]);

  // If the URL requests a specific invoice, load it automatically (useful for full-screen invoice tabs).
  const invoiceLoadedIdRef = useRef<string | null>(null);
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;
    if (activeTab !== "FINANCIAL") return;
    if (!invoiceIdFromUrl) {
      invoiceLoadedIdRef.current = null;
      return;
    }

    // Skip if we already loaded this exact invoice
    if (invoiceLoadedIdRef.current === invoiceIdFromUrl) return;

    console.log("[URL Effect] Loading invoice:", invoiceIdFromUrl);
    invoiceLoadedIdRef.current = invoiceIdFromUrl;

    setActiveInvoiceLoading(true);
    setActiveInvoiceError(null);

    fetch(`${API_BASE}/projects/${project.id}/invoices/${invoiceIdFromUrl}`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(async (res) => {
        console.log("[URL Effect] Response:", res.status);
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Failed to load invoice (${res.status}) ${text}`);
        }
        return res.json();
      })
      .then((json: any) => {
        console.log("[URL Effect] Got JSON:", json?.id, json?.status);
        setActiveInvoice(json);
        setActiveInvoiceLoading(false);
      })
      .catch((err: any) => {
        console.log("[URL Effect] Error:", err?.message);
        setActiveInvoiceError(err?.message ?? "Failed to load invoice.");
        setActiveInvoiceLoading(false);
        invoiceLoadedIdRef.current = null; // Allow retry
      });
  }, [activeTab, project, invoiceIdFromUrl]);

  // Lazy-load project payments (cash receipts) when Financial tab is opened.
  // If the Payments card is collapsed, defer loading until the user expands it.
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;
    if (activeTab !== "FINANCIAL") return;
    if (paymentsCollapsed) return;
    if (projectPayments) return;

    let cancelled = false;

    setProjectPaymentsLoading(true);
    setProjectPaymentsError(null);

    fetch(`${API_BASE}/projects/${project.id}/payments`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => (res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))))
      .then((json: any) => {
        if (cancelled) return;
        setProjectPayments(Array.isArray(json) ? json : []);
      })
      .catch((err: any) => {
        if (cancelled) return;
        setProjectPaymentsError(err?.message ?? "Failed to load payments.");
      })
      .finally(() => {
        if (cancelled) return;
        setProjectPaymentsLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [activeTab, project, projectPayments, paymentsCollapsed]);

  // Keep issue form defaults in sync with the currently opened invoice
  // If invoice has no bill-to info, fall back to project's primary contact
  const projectPrimaryContactName = (project as any)?.primaryContactName ?? "";
  const projectPrimaryContactEmail = (project as any)?.primaryContactEmail ?? "";
  const activeInvoiceId = activeInvoice?.id ?? null;
  useEffect(() => {
    if (!activeInvoice) return;
    const billToName = activeInvoice.billToName || projectPrimaryContactName || "";
    const billToEmail = activeInvoice.billToEmail || projectPrimaryContactEmail || "";
    setIssueBillToName(String(billToName));
    setIssueBillToEmail(String(billToEmail));
    setIssueMemo(String(activeInvoice.memo ?? ""));
    setIssueDueAt(activeInvoice.dueAt ? String(activeInvoice.dueAt).slice(0, 10) : "");
  }, [activeInvoiceId, projectPrimaryContactName, projectPrimaryContactEmail, activeInvoice]);

  // Lazy-load company unit codes when Financial tab is opened (for invoice line item dropdown).
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token) return;
    if (activeTab !== "FINANCIAL") return;
    if (companyUnitCodes) return;

    fetch(`${API_BASE}/companies/me/unit-codes`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => (res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))))
      .then((json: any) => {
        setCompanyUnitCodes(Array.isArray(json) ? json : []);
      })
      .catch(() => {
        // Ignore - unit codes are optional
        setCompanyUnitCodes([]);
      });
  }, [activeTab, companyUnitCodes]);

  // Lazy-load payroll roster when Financial tab is opened (first time).
  useEffect(() => {
    const token = localStorage.getItem("accessToken");
    if (!token || !project) return;
    if (activeTab !== "FINANCIAL") return;
    if (payrollEmployees) return;

    let cancelled = false;
    setPayrollLoading(true);
    setPayrollError(null);

    fetch(`${API_BASE}/projects/${project.id}/employees`, {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => (res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))))
      .then((json: any) => {
        if (cancelled) return;
        const rows: ProjectEmployee[] = Array.isArray(json)
          ? json
          : [];
        setPayrollEmployees(rows);
      })
      .catch((err: any) => {
        if (cancelled) return;
        setPayrollError(err?.message ?? "Failed to load payroll roster.");
      })
      .finally(() => {
        if (cancelled) return;
        setPayrollLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [activeTab, project, payrollEmployees]);

  const toggleRoomExpanded = useCallback(
    (particleId: string | null) => {
      if (!particleId) return;

      petlTransitionOverlayLabelRef.current = "Updating room view…";
      busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);

      startPetlTransition(() => {
        setExpandedRooms(prev => {
          const next = new Set(prev);
          if (next.has(particleId)) next.delete(particleId);
          else next.add(particleId);
          return next;
        });
      });
    },
    [busyOverlay.setMessage, startPetlTransition],
  );

  const toggleUnitExpanded = useCallback(
    (unitId: string | null) => {
      const key = unitId ?? "__no_unit__";

      petlTransitionOverlayLabelRef.current = "Updating unit view…";
      busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);

      startPetlTransition(() => {
        setExpandedUnits(prev => {
          const next = new Set(prev);
          if (next.has(key)) next.delete(key);
          else next.add(key);
          return next;
        });
      });
    },
    [busyOverlay.setMessage, startPetlTransition],
  );

  const isPetlReconFlagged = (sowItemId: string) => petlReconFlagIds.has(sowItemId);

  const togglePetlReconFlag = (sowItemId: string) => {
    setPetlReconFlagIds((prev) => {
      const next = new Set(prev);
      if (next.has(sowItemId)) next.delete(sowItemId);
      else next.add(sowItemId);
      return next;
    });
  };

  const loadPetlReconciliation = async (sowItemId: string) => {
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setPetlReconPanel({
        open: true,
        sowItemId,
        loading: false,
        error: "Missing access token. Please login again.",
        data: null,
      });
      return;
    }

    setPetlReconPanel(prev => ({
      ...prev,
      open: true,
      sowItemId,
      loading: true,
      error: null,
    }));

    try {
      await busyOverlay.run("Loading reconciliation…", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${id}/petl/${sowItemId}/reconciliation`,
          {
            headers: { Authorization: `Bearer ${token}` },
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          setPetlReconPanel(prev => ({
            ...prev,
            loading: false,
            error: `Failed to load reconciliation (${res.status}) ${text}`,
            data: null,
          }));
          return;
        }

        const json: any = await res.json();
        setPetlReconPanel(prev => ({
          ...prev,
          loading: false,
          error: null,
          data: json,
        }));

        // Load cross-version case history ("time machine") if a case exists.
        const caseId = json?.reconciliationCase?.id as string | undefined;
        if (caseId) {
          try {
            const histRes = await fetch(
              `${API_BASE}/projects/${id}/petl-reconciliation/cases/${caseId}/history`,
              {
                headers: { Authorization: `Bearer ${token}` },
              },
            );
            if (histRes.ok) {
              const historyJson: any = await histRes.json().catch(() => null);
              if (historyJson) {
                setPetlReconPanel(prev => ({
                  ...prev,
                  data: {
                    ...(prev.data ?? json),
                    history: historyJson,
                  },
                }));
              }
            }
          } catch {
            // Non-fatal: keep the main reconciliation UI working even if history fails.
          }
        }
      });

    } catch (err: any) {
      setPetlReconPanel(prev => ({
        ...prev,
        loading: false,
        error: err?.message ?? "Failed to load reconciliation",
        data: null,
      }));
    }
  };
  const openPetlReconciliation = async (sowItemId: string) => {
    // Find the SOW item to display context in the workflow modal
    const sowItem = petlItems.find(it => it.id === sowItemId) ?? null;
    const itemNote = String(sowItem?.itemNote ?? "");
    
    // If note exists, start at selectSource step to let user choose note vs line item
    // Otherwise go directly to supplement/change order selection
    const initialStep = itemNote ? 'selectSource' : 'initial';
    
    // Open the new guided workflow modal
    setReconWorkflowModal({
      open: true,
      sowItemId,
      sowItem,
      step: initialStep,
    });
    
    // Initialize note checkbox state
    setReconWorkflowUseNote(false);
  };

  // The line-sequence PETL table can be very large. Memoize its JSX so opening the
  // reconciliation drawer doesn't force React to rebuild thousands of rows.
  // Lowered threshold from 100 to 50 for better paint performance on medium-sized PETLs.
  const VIRTUALIZATION_THRESHOLD = 50;
  const useVirtualizedTable = petlFlatItems.length > VIRTUALIZATION_THRESHOLD;

  // Callbacks for virtualized table
  const handleVirtualToggleExpand = useCallback((itemId: string) => {
    setPetlReconExpandedIds((prev) => {
      const next = new Set(prev);
      if (next.has(itemId)) next.delete(itemId);
      else next.add(itemId);
      return next;
    });
  }, []);

  const handleVirtualToggleFlag = useCallback((itemId: string) => {
    petlTransitionOverlayLabelRef.current = petlReconFlagIds.has(itemId)
      ? "Removing flag…"
      : "Flagging for review…";
    busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
    startPetlTransition(() => togglePetlReconFlag(itemId));
  }, [petlReconFlagIds, busyOverlay, startPetlTransition, togglePetlReconFlag]);

  const handleVirtualOpenReconciliation = useCallback((itemId: string) => {
    void openPetlReconciliation(itemId);
  }, [openPetlReconciliation]);

  const handleVirtualDeleteItem = useCallback((item: PetlItem) => {
    void deletePetlLineItem(item);
  }, [deletePetlLineItem]);

  // Track container height in state to avoid layout thrashing during render
  const [petlContainerHeight, setPetlContainerHeight] = useState(600);
  useEffect(() => {
    if (typeof window === "undefined") return;
    const updateHeight = () => {
      setPetlContainerHeight(Math.max(400, window.innerHeight - 320));
    };
    updateHeight();
    window.addEventListener("resize", updateHeight);
    return () => window.removeEventListener("resize", updateHeight);
  }, []);

  // Memoized handler to edit reconciliation entry via workflow modal
  const handleVirtualEditReconEntry = useCallback((entry: any) => {
    // When editing an existing reconciliation entry, open the workflow modal
    // so the user can review/change the transaction type (Supplement vs Change Order)
    const sowItemId = String(entry?.sowItemId ?? "");
    if (!sowItemId) {
      console.error("Cannot edit reconciliation entry: missing sowItemId");
      return;
    }
    
    // Find the SOW item
    const sowItem = petlItems.find(it => it.id === sowItemId) ?? null;
    const itemNote = String(sowItem?.itemNote ?? "");
    
    // Always start at 'initial' step (Supplement vs Change Order choice)
    // The user can change the transaction type if needed
    setReconWorkflowModal({
      open: true,
      sowItemId,
      sowItem,
      step: 'initial',
      existingEntry: entry, // Pass the existing entry so we can pre-fill values
    });
    
    setReconWorkflowUseNote(false);
  }, [petlItems]);

  // Memoized handler to delete reconciliation entry
  const handleVirtualDeleteReconEntry = useCallback(async (entry: any) => {
    if (!window.confirm("Delete this reconciliation entry?")) {
      return;
    }
    
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return;
    }
    
    try {
      await busyOverlay.run("Deleting reconciliation entry...", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${id}/petl-reconciliation/entries/${entry.id}`,
          {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          },
        );
        
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          alert(`Delete failed (${res.status}) ${text}`);
          return;
        }
        
        // Refresh PETL to show updated data
        setPetlReloadTick(t => t + 1);
        showPetlToast("Reconciliation entry deleted");
      });
    } catch (err: any) {
      alert(err?.message ?? "Failed to delete reconciliation entry");
    }
  }, [id, busyOverlay, showPetlToast]);

  // Callback when reconciliation entry percent complete changes inline
  const handleReconPercentChanged = useCallback((entryId: string, newPercent: number) => {
    // Optimistic update - update the entry in petlReconciliationEntries immediately
    setPetlReconciliationEntries((prev) => 
      prev.map((entry) => 
        entry.id === entryId 
          ? { ...entry, percentComplete: newPercent }
          : entry
      )
    );
    
    // Debounced refresh from server to get updated totals
    // The timeout ensures we don't spam the server if user changes % multiple times
    setTimeout(() => {
      setPetlReloadTick(t => t + 1);
    }, 500);
    
    showPetlToast(`Percent complete updated to ${newPercent}%`);
  }, [showPetlToast]);

  const handleVirtualPercentChange = useCallback(
    async (sowItemId: string, displayLineNo: string | number, newPercent: number, isAcvOnly: boolean) => {
      const token = localStorage.getItem("accessToken");
      if (!token) {
        alert("Missing access token; please log in again.");
        return;
      }

      await busyOverlay.run(`Updating line #${displayLineNo}…`, async () => {
        try {
          // Optimistic update
          setPetlItems((prev) =>
            prev.map((it) =>
              it.id === sowItemId
                ? { ...it, percentComplete: newPercent, isAcvOnly }
                : it,
            ),
          );

          const res = await fetch(
            `${API_BASE}/projects/${id}/petl/${sowItemId}/percent`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                newPercent,
                acvOnly: isAcvOnly,
              }),
            },
          );

          if (!res.ok) {
            console.error("Per-line update failed", res.status);
            showPetlToast(`Failed to save line #${displayLineNo}`);
            return;
          }

          showPetlToast(
            isAcvOnly
              ? `Line #${displayLineNo} set to ACV only`
              : `Line #${displayLineNo} set to ${newPercent}%`
          );

          // Refresh PETL from server
          try {
            const petlRes = await fetch(`${API_BASE}/projects/${id}/petl`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (petlRes.ok) {
              const petl: any = await petlRes.json();
              const items: PetlItem[] = Array.isArray(petl.items) ? petl.items : [];
              setPetlItems(items);
            }
          } catch {
            // non-fatal
          }

          // Refresh groups
          try {
            setGroupLoading(true);
            const groupsRes = await fetch(`${API_BASE}/projects/${id}/petl-groups`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (groupsRes.ok) {
              const json: any = await groupsRes.json();
              setGroups(Array.isArray(json.groups) ? json.groups : []);
              setUnitGroups(Array.isArray(json.unitGroups) ? json.unitGroups : []);
            }
          } catch {
            // non-fatal
          } finally {
            setGroupLoading(false);
          }

          // Refresh the active invoice so Living Invoice reflects PETL changes
          if (activeInvoice?.id) {
            try {
              const invRes = await fetch(
                `${API_BASE}/projects/${id}/invoices/${activeInvoice.id}`,
                { headers: { Authorization: `Bearer ${token}` } },
              );
              if (invRes.ok) {
                const invJson = await invRes.json();
                setActiveInvoice(invJson);
              }
            } catch {
              // non-fatal
            }
          }
          // Also refresh the invoice list to update totals
          setProjectInvoices(null);
        } catch (err) {
          console.error(err);
        }
      });
    },
    [id, busyOverlay, showPetlToast, activeInvoice?.id],
  );

  const petlLineSequenceTable = useMemo(() => {
    // Critical: don't even *build* the large JSX tree unless the PETL tab content is mounted.
    // (PETL data may load while on SUMMARY for the progress summary.)
    if (activeTab !== "PETL") {
      return null;
    }

    const shouldShow =
      (petlDisplayMode === "LINE_SEQUENCE" || petlDisplayMode === "RECONCILIATION_ONLY") &&
      !petlLoading &&
      petlItems.length > 0;

    if (!shouldShow) {
      return null;
    }

    const result = (
      <div style={{ marginTop: 16 }}>
        <h2 style={{ fontSize: 16, fontWeight: 600, marginBottom: 8 }}>
          {petlDisplayMode === "RECONCILIATION_ONLY"
            ? "Estimate items (Reconciliation activity only)"
            : "Estimate items"}
        </h2>

        {orphanReconEntries.length > 0 && (
          <div
            style={{
              marginBottom: 12,
              padding: 10,
              borderRadius: 8,
              border: "1px dashed #e5e7eb",
              background: "#fffbeb",
              fontSize: 11,
            }}
          >
            <div style={{ fontWeight: 600, marginBottom: 4 }}>Orphaned reconciliation entries</div>
            <div style={{ color: "#92400e", marginBottom: 6 }}>
              These entries were carried forward from a prior estimate version but do not
              currently match a PETL line. Review and re-attach them to the correct line item.
            </div>
            <div style={{ maxHeight: 140, overflowY: "auto" }}>
              <table
                style={{
                  width: "100%",
                  borderCollapse: "collapse",
                  minWidth: 420,
                }}
              >
                <thead>
                  <tr>
                    <th style={{ textAlign: "left", padding: "4px 6px", width: 110 }}>Origin line</th>
                    <th style={{ textAlign: "left", padding: "4px 6px", width: 70 }}>Kind</th>
                    <th style={{ textAlign: "left", padding: "4px 6px", width: 80 }}>Tag</th>
                    <th style={{ textAlign: "right", padding: "4px 6px", width: 80 }}>RCV</th>
                    <th style={{ textAlign: "left", padding: "4px 6px" }}>Note</th>
                  </tr>
                </thead>
                <tbody>
                  {orphanReconEntries.map((e: any) => {
                    const originLine = e.originLineNo as number;
                    const tagRaw = String(e?.tag ?? "").trim();
                    const tagLabel =
                      tagRaw === "SUPPLEMENT"
                        ? "Supplement"
                        : tagRaw === "CHANGE_ORDER"
                          ? "Change order"
                          : tagRaw === "OTHER"
                            ? "Other"
                            : tagRaw === "WARRANTY"
                              ? "Warranty"
                              : "";
                    return (
                      <tr key={e.id} style={{ borderTop: "1px solid #fef3c7" }}>
                        <td style={{ padding: "4px 6px", whiteSpace: "nowrap" }}>
                          Line {originLine}
                        </td>
                        <td style={{ padding: "4px 6px", whiteSpace: "nowrap" }}>{e.kind}</td>
                        <td style={{ padding: "4px 6px", whiteSpace: "nowrap" }}>{tagLabel || "—"}</td>
                        <td style={{ padding: "4px 6px", textAlign: "right" }}>
                          {(e.rcvAmount ?? 0).toLocaleString(undefined, {
                            maximumFractionDigits: 2,
                          })}
                        </td>
                        <td
                          style={{
                            padding: "4px 6px",
                            maxWidth: 260,
                            whiteSpace: "nowrap",
                            overflow: "hidden",
                            textOverflow: "ellipsis",
                          }}
                        >
                          {e.note ?? ""}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {isPmOrAbove && !isAdminOrAbove && (
          <div
            style={{
              fontSize: 11,
              color: "#9ca3af",
              marginBottom: 4,
            }}
          >
            Some PETL actions and fields are available only to Admin/Owner/Super Admin.
          </div>
        )}

        {useVirtualizedTable ? (
          <PetlVirtualizedTable
            items={petlFlatItems}
            reconEntriesBySowItemId={reconEntriesBySowItemId}
            expandedIds={petlReconExpandedIds}
            flaggedIds={petlReconFlagIds}
            reconActivityIds={petlReconActivityIds}
            isPmOrAbove={isPmOrAbove}
            isAdminOrAbove={isAdminOrAbove}
            editingCell={petlEditingCell}
            editDraft={petlEditDraft}
            editSaving={petlEditSaving}
            containerHeight={petlContainerHeight}
            hideNotes={petlHideNotes}
            onToggleExpand={handleVirtualToggleExpand}
            onToggleFlag={handleVirtualToggleFlag}
            onOpenReconciliation={handleVirtualOpenReconciliation}
            onDeleteItem={handleVirtualDeleteItem}
            onOpenCellEditor={openPetlCellEditor}
            onEditDraftChange={setPetlEditDraft}
            onSaveEdit={savePetlInlineEdit}
            onCancelEdit={cancelPetlCellEditor}
            onPercentChange={handleVirtualPercentChange}
            onEditReconEntry={handleVirtualEditReconEntry}
            onDeleteReconEntry={handleVirtualDeleteReconEntry}
            onReconPercentChanged={handleReconPercentChanged}
          />
        ) : (
        <div
          ref={petlFlatListRef}
          style={{
            height: "calc(100vh - 320px)",
            overflow: "auto",
            borderRadius: 8,
            border: "1px solid #e5e7eb",
            backgroundColor: "#ffffff",
          }}
        >
          <table
            id="petl-items-table"
            style={{
              width: "100%",
              borderCollapse: "collapse",
              fontSize: 12,
            }}
          >
            <thead>
              <tr style={{ backgroundColor: "#f9fafb" }}>
                <th
                  style={{
                    textAlign: "left",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Line
                </th>
                <th
                  style={{
                    textAlign: "left",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Room
                </th>
                <th
                  style={{
                    textAlign: "left",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Task
                </th>
                <th
                  style={{
                    textAlign: "right",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Qty
                </th>
                <th
                  style={{
                    textAlign: "right",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Unit
                </th>
                <th
                  style={{
                    textAlign: "right",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Total
                </th>
                <th
                  style={{
                    textAlign: "right",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  RCV
                </th>
                <th
                  style={{
                    textAlign: "right",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  %
                </th>
                <th
                  style={{
                    textAlign: "left",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Cat
                </th>
                <th
                  style={{
                    textAlign: "left",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Sel
                </th>
                <th
                  style={{
                    textAlign: "left",
                    padding: "6px 8px",
                    position: "sticky",
                    top: 0,
                    zIndex: 1,
                    background: "#f9fafb",
                  }}
                >
                  Recon
                </th>
              </tr>
            </thead>
            <tbody>
              {petlFlatItems.flatMap((item) => {
                const flagged = isPetlReconFlagged(item.id);
                const hasRecon = hasReconciliationActivity(item.id);

                const allRecon = reconEntriesBySowItemId.get(item.id) ?? [];
                const reconFinancial = allRecon.filter((e) => e?.rcvAmount != null);
                const reconSeqById = new Map<string, number>();
                reconFinancial.forEach((e, idx) => {
                  if (e?.id) reconSeqById.set(String(e.id), idx + 1);
                });

                const expanded = petlReconExpandedIds.has(item.id);
                const showSublines = expanded && reconFinancial.length > 0;

                const bg = flagged
                  ? "#fef3c7"
                  : hasRecon
                    ? "#e0f2fe"
                    : "transparent";

                const displayLineNo =
                  item.sourceLineNo && item.sourceLineNo > 0 ? item.sourceLineNo : item.lineNo;

                const out: any[] = [];

                out.push(
                  <tr key={item.id} style={{ backgroundColor: bg }}>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        whiteSpace: "nowrap",
                      }}
                    >
                      <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
                        {reconFinancial.length > 0 ? (
                          <button
                            type="button"
                            onClick={() => {
                              setPetlReconExpandedIds((prev) => {
                                const next = new Set(prev);
                                if (next.has(item.id)) next.delete(item.id);
                                else next.add(item.id);
                                return next;
                              });
                            }}
                            style={{
                              border: "none",
                              background: "transparent",
                              cursor: "pointer",
                              padding: 0,
                              fontSize: 12,
                              color: "#2563eb",
                              width: 14,
                              textAlign: "center",
                            }}
                            aria-label={expanded ? "Collapse reconciliation lines" : "Expand reconciliation lines"}
                            title={expanded ? "Collapse reconciliation lines" : `Show ${reconFinancial.length} reconciliation line(s)`}
                          >
                            {showSublines ? "▾" : "▸"}
                          </button>
                        ) : (
                          <span style={{ width: 14 }} />
                        )}
                        <span>{displayLineNo}</span>
                      </div>
                    </td>
                    <td
                      title={item.projectParticle?.fullLabel ?? item.projectParticle?.name ?? ""}
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        whiteSpace: "nowrap",
                        overflow: "hidden",
                        textOverflow: "ellipsis",
                        maxWidth: 220,
                      }}
                    >
                      {item.projectParticle?.fullLabel ?? item.projectParticle?.name ?? ""}
                    </td>
                    <td
                      title={item.description ?? ""}
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        whiteSpace: "nowrap",
                        overflow: "hidden",
                        textOverflow: "ellipsis",
                        maxWidth: 520,
                      }}
                    >
                      {item.description ?? ""}
                    </td>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        textAlign: "right",
                        whiteSpace: "nowrap",
                      }}
                    >
                      {isPmOrAbove &&
                      petlEditingCell?.sowItemId === item.id &&
                      petlEditingCell.field === "qty" ? (
                        <input
                          type="number"
                          value={petlEditDraft}
                          autoFocus
                          onChange={(e) => setPetlEditDraft(e.target.value)}
                          onBlur={savePetlInlineEdit}
                          onKeyDown={(e) => {
                            if (e.key === "Enter") {
                              void savePetlInlineEdit();
                            } else if (e.key === "Escape") {
                              cancelPetlCellEditor();
                            }
                          }}
                          disabled={petlEditSaving}
                          style={{
                            width: 80,
                            padding: "2px 4px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 11,
                          }}
                        />
                      ) : (
                        <button
                          type="button"
                          disabled={!isPmOrAbove}
                          onClick={() =>
                            openPetlCellEditor(item.id, "qty", item.qty)
                          }
                          style={{
                            border: "none",
                            background: "transparent",
                            padding: 0,
                            margin: 0,
                            cursor: isPmOrAbove ? "pointer" : "default",
                            minWidth: 60,
                            textAlign: "right",
                            fontFamily: "inherit",
                            fontSize: 12,
                          }}
                        >
                          {item.qty ?? ""}
                        </button>
                      )}
                    </td>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        textAlign: "right",
                        whiteSpace: "nowrap",
                      }}
                    >
                      {isPmOrAbove &&
                      petlEditingCell?.sowItemId === item.id &&
                      petlEditingCell.field === "unit" ? (
                        <input
                          type="text"
                          value={petlEditDraft}
                          autoFocus
                          onChange={(e) => setPetlEditDraft(e.target.value)}
                          onBlur={savePetlInlineEdit}
                          onKeyDown={(e) => {
                            if (e.key === "Enter") {
                              void savePetlInlineEdit();
                            } else if (e.key === "Escape") {
                              cancelPetlCellEditor();
                            }
                          }}
                          disabled={petlEditSaving}
                          style={{
                            width: 80,
                            padding: "2px 4px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 11,
                          }}
                        />
                      ) : (
                        <button
                          type="button"
                          disabled={!isPmOrAbove}
                          onClick={() =>
                            openPetlCellEditor(item.id, "unit", item.unit)
                          }
                          style={{
                            border: "none",
                            background: "transparent",
                            padding: 0,
                            margin: 0,
                            cursor: isPmOrAbove ? "pointer" : "default",
                            minWidth: 60,
                            textAlign: "right",
                            fontFamily: "inherit",
                            fontSize: 12,
                          }}
                        >
                          {item.unit ?? ""}
                        </button>
                      )}
                    </td>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        textAlign: "right",
                        whiteSpace: "nowrap",
                      }}
                    >
                      {item.itemAmount != null
                        ? item.itemAmount.toLocaleString(undefined, {
                            maximumFractionDigits: 2,
                          })
                        : ""}
                    </td>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        textAlign: "right",
                        whiteSpace: "nowrap",
                      }}
                    >
                      {isPmOrAbove &&
                      petlEditingCell?.sowItemId === item.id &&
                      petlEditingCell.field === "rcvAmount" ? (
                        <input
                          type="number"
                          value={petlEditDraft}
                          autoFocus
                          onChange={(e) => setPetlEditDraft(e.target.value)}
                          onBlur={savePetlInlineEdit}
                          onKeyDown={(e) => {
                            if (e.key === "Enter") {
                              void savePetlInlineEdit();
                            } else if (e.key === "Escape") {
                              cancelPetlCellEditor();
                            }
                          }}
                          disabled={petlEditSaving}
                          style={{
                            width: 100,
                            padding: "2px 4px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 11,
                          }}
                        />
                      ) : (
                        <button
                          type="button"
                          disabled={!isPmOrAbove}
                          onClick={() =>
                            openPetlCellEditor(item.id, "rcvAmount", item.rcvAmount)
                          }
                          style={{
                            border: "none",
                            background: "transparent",
                            padding: 0,
                            margin: 0,
                            cursor: isPmOrAbove ? "pointer" : "default",
                            minWidth: 80,
                            textAlign: "right",
                            fontFamily: "inherit",
                            fontSize: 12,
                          }}
                        >
                          {item.rcvAmount != null
                            ? item.rcvAmount.toLocaleString(undefined, {
                                maximumFractionDigits: 2,
                              })
                            : ""}
                        </button>
                      )}
                    </td>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        textAlign: "right",
                        whiteSpace: "nowrap",
                      }}
                    >
                      <select
                        value={item.isAcvOnly ? "ACV" : String(item.percentComplete)}
                        onChange={async (e) => {
                          const value = e.target.value;
                          const isAcv = value === "ACV";
                          const percent = isAcv ? 0 : Number(value);
                          if (
                            !isAcv &&
                            (Number.isNaN(percent) || percent < 0 || percent > 100)
                          ) {
                            return;
                          }

                          const token = localStorage.getItem("accessToken");
                          if (!token) {
                            alert("Missing access token; please log in again.");
                            return;
                          }

                          await busyOverlay.run(`Updating line #${displayLineNo}…`, async () => {
                            try {
                              setPetlItems((prev) =>
                                prev.map((it) =>
                                  it.id === item.id
                                    ? {
                                        ...it,
                                        percentComplete: percent,
                                        isAcvOnly: isAcv,
                                      }
                                    : it,
                                ),
                              );

                              const res = await fetch(
                                `${API_BASE}/projects/${id}/petl/${item.id}/percent`,
                                {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({
                                    newPercent: percent,
                                    acvOnly: isAcv,
                                  }),
                                },
                              );
                              if (!res.ok) {
                                console.error("Per-line update failed", res.status);
                                showPetlToast(`Failed to save line #${displayLineNo}`);
                                return;
                              }

                              // Show brief toast confirmation
                              showPetlToast(
                                isAcv
                                  ? `Line #${displayLineNo} set to ACV only`
                                  : `Line #${displayLineNo} set to ${percent}%`
                              );

                              // After a single-line edit in the flat PETL table,
                              // also refresh the server-backed PETL + groups so the
                              // Rooms/Zones summary reflects the current values.
                              try {
                                const petlRes = await fetch(`${API_BASE}/projects/${id}/petl`, {
                                  headers: { Authorization: `Bearer ${token}` },
                                });
                                if (petlRes.ok) {
                                  const petl: any = await petlRes.json();
                                  const items: PetlItem[] = Array.isArray(petl.items)
                                    ? petl.items
                                    : [];
                                  setPetlItems(items);
                                }
                              } catch {
                                // non-fatal
                              }

                              try {
                                setGroupLoading(true);
                                const groupsRes = await fetch(
                                  `${API_BASE}/projects/${id}/petl-groups`,
                                  {
                                    headers: { Authorization: `Bearer ${token}` },
                                  },
                                );
                                if (groupsRes.ok) {
                                  const json: any = await groupsRes.json();
                                  setGroups(Array.isArray(json.groups) ? json.groups : []);
                                  setUnitGroups(
                                    Array.isArray(json.unitGroups) ? json.unitGroups : [],
                                  );
                                }
                              } catch {
                                // non-fatal
                              } finally {
                                setGroupLoading(false);
                              }
                            } catch (err) {
                              console.error(err);
                            }
                          });
                        }}
                        style={{
                          width: 80,
                          padding: "2px 4px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 11,
                        }}
                      >
                        <option value="0">0%</option>
                        <option value="10">10%</option>
                        <option value="20">20%</option>
                        <option value="30">30%</option>
                        <option value="40">40%</option>
                        <option value="50">50%</option>
                        <option value="60">60%</option>
                        <option value="70">70%</option>
                        <option value="80">80%</option>
                        <option value="90">90%</option>
                        <option value="100">100%</option>
                        <option value="ACV">ACV only</option>
                      </select>
                    </td>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        whiteSpace: "nowrap",
                      }}
                    >
                      {isPmOrAbove &&
                      petlEditingCell?.sowItemId === item.id &&
                      petlEditingCell.field === "categoryCode" ? (
                        <input
                          type="text"
                          value={petlEditDraft}
                          autoFocus
                          onChange={(e) => setPetlEditDraft(e.target.value)}
                          onBlur={savePetlInlineEdit}
                          onKeyDown={(e) => {
                            if (e.key === "Enter") {
                              void savePetlInlineEdit();
                            } else if (e.key === "Escape") {
                              cancelPetlCellEditor();
                            }
                          }}
                          disabled={petlEditSaving}
                          style={{
                            width: 80,
                            padding: "2px 4px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 11,
                          }}
                        />
                      ) : (
                        <button
                          type="button"
                          disabled={!isPmOrAbove}
                          onClick={() =>
                            openPetlCellEditor(
                              item.id,
                              "categoryCode",
                              item.categoryCode,
                            )
                          }
                          style={{
                            border: "none",
                            background: "transparent",
                            padding: 0,
                            margin: 0,
                            cursor: isPmOrAbove ? "pointer" : "default",
                            minWidth: 60,
                            textAlign: "left",
                            fontFamily: "inherit",
                            fontSize: 12,
                          }}
                        >
                          {item.categoryCode ?? ""}
                        </button>
                      )}
                    </td>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        whiteSpace: "nowrap",
                      }}
                    >
                      {isPmOrAbove &&
                      petlEditingCell?.sowItemId === item.id &&
                      petlEditingCell.field === "selectionCode" ? (
                        <input
                          type="text"
                          value={petlEditDraft}
                          autoFocus
                          onChange={(e) => setPetlEditDraft(e.target.value)}
                          onBlur={savePetlInlineEdit}
                          onKeyDown={(e) => {
                            if (e.key === "Enter") {
                              void savePetlInlineEdit();
                            } else if (e.key === "Escape") {
                              cancelPetlCellEditor();
                            }
                          }}
                          disabled={petlEditSaving}
                          style={{
                            width: 80,
                            padding: "2px 4px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 11,
                          }}
                        />
                      ) : (
                        <button
                          type="button"
                          disabled={!isPmOrAbove}
                          onClick={() =>
                            openPetlCellEditor(
                              item.id,
                              "selectionCode",
                              item.selectionCode,
                            )
                          }
                          style={{
                            border: "none",
                            background: "transparent",
                            padding: 0,
                            margin: 0,
                            cursor: isPmOrAbove ? "pointer" : "default",
                            minWidth: 60,
                            textAlign: "left",
                            fontFamily: "inherit",
                            fontSize: 12,
                          }}
                        >
                          {item.selectionCode ?? ""}
                        </button>
                      )}
                    </td>
                    <td
                      style={{
                        padding: "4px 8px",
                        borderTop: "1px solid #e5e7eb",
                        whiteSpace: "nowrap",
                      }}
                    >
                      <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
                        <button
                          type="button"
                          onClick={() => {
                            petlTransitionOverlayLabelRef.current = flagged
                              ? "Removing flag…"
                              : "Flagging for review…";
                            busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
                            startPetlTransition(() => togglePetlReconFlag(item.id));
                          }}
                          style={{
                            padding: "2px 6px",
                            borderRadius: 999,
                            border: flagged ? "1px solid #b45309" : "1px solid #d1d5db",
                            background: flagged ? "#fffbeb" : "#ffffff",
                            fontSize: 11,
                            cursor: "pointer",
                            color: flagged ? "#92400e" : "#374151",
                          }}
                        >
                          {flagged ? "Needs review" : "Flag"}
                        </button>
                        <button
                          type="button"
                          onClick={() => {
                            void openPetlReconciliation(item.id);
                          }}
                          style={{
                            padding: "2px 6px",
                            borderRadius: 999,
                            border: "1px solid #2563eb",
                            background: "#eff6ff",
                            fontSize: 11,
                            cursor: "pointer",
                            color: "#1d4ed8",
                          }}
                        >
                          Reconcile
                        </button>
                        {isAdminOrAbove ? (
                          <button
                            type="button"
                            onClick={() => {
                              void deletePetlLineItem(item);
                            }}
                            style={{
                              padding: "2px 6px",
                              borderRadius: 999,
                              border: "1px solid #b91c1c",
                              background: "#fff1f2",
                              fontSize: 11,
                              cursor: "pointer",
                              color: "#b91c1c",
                            }}
                          >
                            Delete
                          </button>
                        ) : (
                          isPmOrAbove && (
                            <span
                              style={{
                                fontSize: 10,
                                color: "#9ca3af",
                                padding: "0 6px",
                                borderRadius: 999,
                                border: "1px dashed #e5e7eb",
                              }}
                              title="Additional admin-only actions are available for this line"
                            >
                              Admin-only
                            </span>
                          )
                        )}
                      </div>
                    </td>
                  </tr>,
                );

                if (showSublines) {
                  for (const e of reconFinancial) {
                    const entryId = String(e?.id ?? "");
                    if (!entryId) continue;
                    const seq = reconSeqById.get(entryId);
                    if (!seq) continue;

                    const lineLabel = `${displayLineNo}.${seq}`;
                    const kind = String(e?.kind ?? "").trim();
                    const desc = String(e?.description ?? "").trim();
                    const note = String(e?.note ?? "").trim();
                    const label = desc || note ? `${kind}: ${desc || note}` : kind;

                    const itemAmt = typeof e?.itemAmount === "number" ? e.itemAmount : null;
                    const rcvAmt = typeof e?.rcvAmount === "number" ? e.rcvAmount : null;
                    const isCredit = kind === "CREDIT" || (rcvAmt != null && rcvAmt < 0);
                    const pct = e?.isPercentCompleteLocked ? 0 : (e?.percentComplete ?? 0);

                    out.push(
                      <tr
                        key={`${item.id}::recon::${entryId}`}
                        style={{
                          backgroundColor: "#f8fafc",
                          color: isCredit ? "#b91c1c" : "#111827",
                        }}
                      >
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            whiteSpace: "nowrap",
                            fontFamily:
                              "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",
                          }}
                        >
                          <span style={{ paddingLeft: 18 }}>↳ {lineLabel}</span>
                        </td>
                        <td style={{ padding: "4px 8px", borderTop: "1px solid #e5e7eb" }}>
                          {/* under the parent row */}
                        </td>
                        <td
                          title={label}
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            whiteSpace: "nowrap",
                            overflow: "hidden",
                            textOverflow: "ellipsis",
                            maxWidth: 520,
                          }}
                        >
                          <span style={{ color: "#6b7280" }}>[{kind}]</span>{" "}
                          {desc || note || ""}
                        </td>
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            textAlign: "right",
                            whiteSpace: "nowrap",
                          }}
                        >
                          {e?.qty ?? ""}
                        </td>
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            textAlign: "right",
                            whiteSpace: "nowrap",
                          }}
                        >
                          {e?.unit ?? ""}
                        </td>
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            textAlign: "right",
                            whiteSpace: "nowrap",
                          }}
                        >
                          {itemAmt != null
                            ? itemAmt.toLocaleString(undefined, { maximumFractionDigits: 2 })
                            : ""}
                        </td>
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            textAlign: "right",
                            whiteSpace: "nowrap",
                            fontWeight: 600,
                          }}
                        >
                          {rcvAmt != null
                            ? rcvAmt.toLocaleString(undefined, { maximumFractionDigits: 2 })
                            : ""}
                        </td>
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            textAlign: "right",
                            whiteSpace: "nowrap",
                          }}
                        >
                          {e?.isPercentCompleteLocked ? (
                            "—"
                          ) : (
                            <select
                              value={String(pct)}
                              onChange={(ev) => {
                                const next = Number(ev.target.value);
                                if (Number.isNaN(next)) return;
                                void submitReconEntryPercent(entryId, next);
                              }}
                              style={{
                                width: 80,
                                padding: "2px 4px",
                                borderRadius: 4,
                                border: "1px solid #d1d5db",
                                fontSize: 11,
                              }}
                            >
                              <option value="0">0%</option>
                              <option value="10">10%</option>
                              <option value="20">20%</option>
                              <option value="30">30%</option>
                              <option value="40">40%</option>
                              <option value="50">50%</option>
                              <option value="60">60%</option>
                              <option value="70">70%</option>
                              <option value="80">80%</option>
                              <option value="90">90%</option>
                              <option value="100">100%</option>
                            </select>
                          )}
                        </td>
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            whiteSpace: "nowrap",
                          }}
                        >
                          {e?.categoryCode ?? ""}
                        </td>
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            whiteSpace: "nowrap",
                          }}
                        >
                          {e?.selectionCode ?? ""}
                        </td>
                        <td
                          style={{
                            padding: "4px 8px",
                            borderTop: "1px solid #e5e7eb",
                            whiteSpace: "nowrap",
                            color: "#6b7280",
                            fontSize: 11,
                          }}
                        >
                          {/* no actions */}
                        </td>
                      </tr>,
                    );
                  }
                }

                return out;
              })}
            </tbody>
          </table>
        </div>
        )}
      </div>
    );
    return result;
  }, [
    activeTab,
    id,
    isAdminOrAbove,
    isPmOrAbove,
    petlDisplayMode,
    petlFlatItems,
    petlLoading,
    petlReconActivityIds,
    petlReconExpandedIds,
    petlReconFlagIds,
    petlItems.length,
    reconEntriesBySowItemId,
    useVirtualizedTable,
    petlEditingCell,
    petlEditDraft,
    petlEditSaving,
    handleVirtualToggleExpand,
    handleVirtualToggleFlag,
    handleVirtualOpenReconciliation,
    handleVirtualDeleteItem,
    openPetlCellEditor,
    savePetlInlineEdit,
    cancelPetlCellEditor,
    handleVirtualPercentChange,
    petlContainerHeight,
  ]);

  const submitReconCredit = async () => {
    const sowItemId = petlReconPanel.sowItemId;
    if (!sowItemId) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return;
    }

    try {
      await busyOverlay.run("Creating credit…", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${id}/petl/${sowItemId}/reconciliation/credit`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              note: reconNote || null,
              tag: reconEntryTag || null,
              components: reconCreditComponents,
            }),
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          alert(`Failed to create credit (${res.status}) ${text}`);
          return;
        }

        setPetlReloadTick(t => t + 1);
        await loadPetlReconciliation(sowItemId);
      });

    } catch (err: any) {
      alert(err?.message ?? "Failed to create credit");
    }
  };

  const submitReconPlaceholder = async () => {
    const sowItemId = petlReconPanel.sowItemId;
    if (!sowItemId) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return;
    }

    try {
      await busyOverlay.run("Creating placeholder…", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${id}/petl/${sowItemId}/reconciliation/placeholder`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              kind: reconPlaceholderKind,
              tag: reconEntryTag || null,
              note: reconNote || null,
            }),
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          alert(`Failed to create placeholder (${res.status}) ${text}`);
          return;
        }

        setPetlReloadTick(t => t + 1);
        await loadPetlReconciliation(sowItemId);
      });

    } catch (err: any) {
      alert(err?.message ?? "Failed to create placeholder");
    }
  };

  // Save button in the main PETL reconciliation drawer: if the user has entered
  // a note and/or tag, persist it as a NOTE_ONLY reconciliation entry; otherwise
  // just close the drawer.
  const saveReconPanel = async () => {
    if (!project || !petlReconPanel.sowItemId) {
      setPetlReconPanel(prev => ({ ...prev, open: false }));
      return;
    }

    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return;
    }

    const note = (reconNote || "").trim();
    const tag = (reconEntryTag || "") as ReconEntryTag;

    // If nothing has been entered, treat Save as a simple close.
    if (!note && !tag) {
      setPetlReconPanel(prev => ({ ...prev, open: false }));
      return;
    }

    const sowItemId = petlReconPanel.sowItemId;

    try {
      await busyOverlay.run("Saving reconciliation note…", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${project.id}/petl/${sowItemId}/reconciliation/placeholder`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              kind: "NOTE_ONLY",
              tag: tag || null,
              note: note || null,
            }),
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          alert(`Failed to save reconciliation note (${res.status}) ${text}`);
          return;
        }

        setPetlReloadTick(t => t + 1);
        await loadPetlReconciliation(sowItemId);
      });

      setPetlReconPanel(prev => ({ ...prev, open: false }));
    } catch (err: any) {
      alert(err?.message ?? "Failed to save reconciliation note");
    }
  };

  const submitAddFromCostBook = async (companyPriceListItemId: string, qty: number) => {
    const sowItemId = petlReconPanel.sowItemId;
    if (!sowItemId) return false;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return false;
    }

    if (!Number.isFinite(qty) || qty <= 0) {
      alert("Qty must be a positive number");
      return false;
    }

    try {
      return await busyOverlay.run("Adding from cost book…", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${id}/petl/${sowItemId}/reconciliation/add-from-cost-book`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              companyPriceListItemId,
              qty,
              tag: reconEntryTag || null,
              note: reconNote || null,
            }),
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          alert(`Failed to add from cost book (${res.status}) ${text}`);
          return false;
        }

        setPetlReloadTick(t => t + 1);
        await loadPetlReconciliation(sowItemId);
        return true;
      });

    } catch (err: any) {
      alert(err?.message ?? "Failed to add from cost book");
      return false;
    }
  };

  const submitReconEntryPercent = async (entryId: string, newPercent: number) => {
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return;
    }

    try {
      await busyOverlay.run("Updating reconciliation percent…", async () => {
        const res = await fetch(
          `${API_BASE}/projects/${id}/petl-reconciliation/entries/${entryId}/percent`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ newPercent }),
          },
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          alert(`Failed to update percent (${res.status}) ${text}`);
          return;
        }

        showPetlToast(`Reconciliation entry set to ${newPercent}%`);

        setPetlReloadTick(t => t + 1);
        if (petlReconPanel.sowItemId) {
          await loadPetlReconciliation(petlReconPanel.sowItemId);
        }
      });

    } catch (err: any) {
      alert(err?.message ?? "Failed to update percent");
    }
  };

  const openReconEntryEdit = (entry: any) => {
    const tag = String(entry?.tag ?? "").trim();
    const draftTag: ReconEntryTag =
      tag === "SUPPLEMENT" || tag === "CHANGE_ORDER" || tag === "OTHER" || tag === "WARRANTY"
        ? (tag as ReconEntryTag)
        : "";

    // Activity enum values (matching Xactimate: &=R&R, -=Remove, +=Replace, R=D&R, M=Materials, F=Repair, I=Install)
    const validActivities = ["REMOVE_AND_REPLACE", "REMOVE", "REPLACE", "DETACH_AND_RESET", "MATERIALS", "REPAIR", "INSTALL_ONLY"];
    const rawActivity = String(entry?.activity ?? "").trim();
    const draftActivity = validActivities.includes(rawActivity) ? rawActivity : "";

    // Get parent Xact cost components for fallback (from reconciliation panel data)
    const parentXact = petlReconPanel.data?.xactCostComponents;

    // Helper to get cost component value: entry value first, then parent Xact value as fallback
    const getCostComponent = (
      entryVal: number | null | undefined,
      parentVal: number | null | undefined
    ): string => {
      if (typeof entryVal === "number" && Number.isFinite(entryVal)) {
        return String(entryVal);
      }
      if (typeof parentVal === "number" && Number.isFinite(parentVal)) {
        return String(parentVal);
      }
      return "";
    };

    // Always start with rcvManuallyEdited: false so auto-calc works.
    // Only set to true when user directly types in the RCV field.
    setReconEntryEdit({
      entry,
      draft: {
        kind: String(entry?.kind ?? "ADD"),
        tag: draftTag,
        description: String(entry?.description ?? ""),
        note: String(entry?.note ?? ""),
        qty:
          typeof entry?.qty === "number" && Number.isFinite(entry.qty)
            ? String(entry.qty)
            : "",
        unit: String(entry?.unit ?? ""),
        unitCost:
          typeof entry?.unitCost === "number" && Number.isFinite(entry.unitCost)
            ? String(entry.unitCost)
            : "",
        itemAmount:
          typeof entry?.itemAmount === "number" && Number.isFinite(entry.itemAmount)
            ? String(entry.itemAmount)
            : "",
        salesTaxAmount:
          typeof entry?.salesTaxAmount === "number" && Number.isFinite(entry.salesTaxAmount)
            ? String(entry.salesTaxAmount)
            : "",
        opAmount:
          typeof entry?.opAmount === "number" && Number.isFinite(entry.opAmount)
            ? String(entry.opAmount)
            : "",
        rcvAmount:
          typeof entry?.rcvAmount === "number" && Number.isFinite(entry.rcvAmount)
            ? String(entry.rcvAmount)
            : "",
        percentComplete:
          typeof entry?.percentComplete === "number" && Number.isFinite(entry.percentComplete)
            ? String(entry.percentComplete)
            : "100",
        // Activity and cost component fields - use parent Xact components as fallback
        activity: draftActivity,
        workersWage: getCostComponent(entry?.workersWage, parentXact?.workersWage),
        laborBurden: getCostComponent(entry?.laborBurden, parentXact?.laborBurden),
        laborOverhead: getCostComponent(entry?.laborOverhead, parentXact?.laborOverhead),
        materialCost: getCostComponent(entry?.materialCost, parentXact?.material),
        equipmentCost: getCostComponent(entry?.equipmentCost, parentXact?.equipment),
      },
      rcvManuallyEdited: false,
      saving: false,
      error: null,
    });
  };

  const closeReconEntryEdit = () => {
    setReconEntryEdit(null);
    reconEditDraggable.reset();
  };

  // Helper: parse a string to number, treating blank as 0
  const parseReconNumber = (raw: string): number => {
    const s = raw.trim().replace(/,/g, "");
    if (!s) return 0;
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };

  // Helper: compute RCV from draft fields (itemAmount + tax + opAmount)
  // Also derives itemAmount from qty * unitCost if itemAmount is blank
  const computeReconRcv = (draft: typeof reconEntryEdit extends null ? never : NonNullable<typeof reconEntryEdit>["draft"]): string => {
    const qty = parseReconNumber(draft.qty);
    const unitCost = parseReconNumber(draft.unitCost);
    const itemAmountRaw = draft.itemAmount.trim();
    
    // If itemAmount is blank but qty and unitCost exist, derive it
    let itemAmount = parseReconNumber(draft.itemAmount);
    if (!itemAmountRaw && qty !== 0 && unitCost !== 0) {
      itemAmount = qty * unitCost;
    }
    
    const tax = parseReconNumber(draft.salesTaxAmount);
    const op = parseReconNumber(draft.opAmount);
    
    const rcv = itemAmount + tax + op;
    // Return empty string if result is 0 to keep placeholder behavior
    return rcv === 0 ? "" : String(rcv);
  };

  // Update a financial field with bidirectional calculation:
  // - Editing unitCost with valid Qty → recalculates itemAmount
  // - Editing itemAmount with valid Qty → recalculates unitCost
  // - Editing qty → recalculates itemAmount (if unitCost present) or unitCost (if itemAmount present)
  // - Always recalculates RCV unless user has manually edited it
  const updateReconFinancialField = (
    field: "qty" | "unitCost" | "itemAmount" | "salesTaxAmount" | "opAmount",
    value: string
  ) => {
    setReconEntryEdit((prev) => {
      if (!prev) return prev;
      const newDraft = { ...prev.draft, [field]: value };
      
      const qty = parseReconNumber(newDraft.qty);
      const unitCost = parseReconNumber(newDraft.unitCost);
      const itemAmount = parseReconNumber(newDraft.itemAmount);
      
      // Bidirectional calculation between unitCost and itemAmount
      if (field === "unitCost" && qty !== 0) {
        // User is editing unitCost → recalculate itemAmount
        const newUnitCost = parseReconNumber(value);
        if (newUnitCost !== 0) {
          newDraft.itemAmount = String(qty * newUnitCost);
        }
      } else if (field === "itemAmount" && qty !== 0) {
        // User is editing itemAmount → recalculate unitCost
        const newItemAmount = parseReconNumber(value);
        if (newItemAmount !== 0) {
          newDraft.unitCost = String(newItemAmount / qty);
        }
      } else if (field === "qty") {
        // User is editing qty → recalculate based on what's available
        const newQty = parseReconNumber(value);
        if (newQty !== 0) {
          if (unitCost !== 0) {
            // Prefer deriving itemAmount from unitCost
            newDraft.itemAmount = String(newQty * unitCost);
          } else if (itemAmount !== 0) {
            // Fall back to deriving unitCost from itemAmount
            newDraft.unitCost = String(itemAmount / newQty);
          }
        }
      }
      
      // Auto-compute RCV if user hasn't manually edited it
      if (!prev.rcvManuallyEdited) {
        const finalItemAmount = parseReconNumber(newDraft.itemAmount);
        const tax = parseReconNumber(newDraft.salesTaxAmount);
        const op = parseReconNumber(newDraft.opAmount);
        const rcv = finalItemAmount + tax + op;
        newDraft.rcvAmount = rcv === 0 ? "" : String(rcv);
      }
      
      return { ...prev, draft: newDraft };
    });
  };

  // Update a cost component field and auto-recalculate based on activity
  const updateReconCostComponent = (
    field: "workersWage" | "laborBurden" | "laborOverhead" | "materialCost" | "equipmentCost",
    value: string
  ) => {
    setReconEntryEdit((prev) => {
      if (!prev) return prev;
      const newDraft = { ...prev.draft, [field]: value };

      // Only auto-recalculate if activity is set
      const activity = newDraft.activity;
      if (activity) {
        const workersWage = parseReconNumber(newDraft.workersWage || "");
        const laborBurden = parseReconNumber(newDraft.laborBurden || "");
        const laborOverhead = parseReconNumber(newDraft.laborOverhead || "");
        const materialCost = parseReconNumber(newDraft.materialCost || "");
        const equipmentCost = parseReconNumber(newDraft.equipmentCost || "");
        const laborTotal = workersWage + laborBurden + laborOverhead;

        let derivedTotal = 0;
        switch (activity) {
          case "REMOVE_AND_REPLACE":
            derivedTotal = laborTotal + materialCost + equipmentCost;
            break;
          case "REMOVE":
          case "DETACH_AND_RESET":
            derivedTotal = laborTotal;
            break;
          case "REPLACE":
            derivedTotal = laborTotal + equipmentCost;
            break;
          case "MATERIALS":
            derivedTotal = materialCost;
            break;
          default:
            derivedTotal = laborTotal + materialCost + equipmentCost;
        }

        if (derivedTotal > 0) {
          const qty = parseReconNumber(newDraft.qty || "") || 1;
          newDraft.unitCost = String(derivedTotal / qty);
          newDraft.itemAmount = String(derivedTotal);

          // Auto-update RCV if not manually edited
          if (!prev.rcvManuallyEdited) {
            const tax = parseReconNumber(newDraft.salesTaxAmount || "");
            const op = parseReconNumber(newDraft.opAmount || "");
            newDraft.rcvAmount = String(derivedTotal + tax + op);
          }
        }
      }

      return { ...prev, draft: newDraft };
    });
  };

  const deleteReconEntryFromEditor = async () => {
    if (!reconEntryEdit) return;
    if (!project) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return;
    }
    if (
      !window.confirm(
        "Delete this reconciliation entry? Use Reject if you just want to keep a record without charging.",
      )
    ) {
      return;
    }
    try {
      const res = await fetch(
        `${API_BASE}/projects/${project.id}/petl-reconciliation/entries/${reconEntryEdit.entry.id}`,
        {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        },
      );
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        alert(`Delete failed (${res.status}) ${text}`);
        return;
      }
      setReconEntryEdit(null);
      setPetlReloadTick((t) => t + 1);
      if (petlReconPanel.sowItemId) {
        void loadPetlReconciliation(petlReconPanel.sowItemId);
      }
      await loadActiveInvoice();
    } catch (err: any) {
      alert(err?.message ?? "Failed to delete reconciliation entry.");
    }
  };

  const saveReconEntryEdit = async () => {
    if (!reconEntryEdit) return;

    if (!reconEntryEdit.draft.tag) {
      setReconTagShake(true);
      return;
    }
    
    // Warn if Activity is missing but allow save (backend will handle validation)
    if (!reconEntryEdit.draft.activity) {
      if (!window.confirm("Activity is not set. This helps identify the scope of work. Continue saving anyway?")) {
        return;
      }
    }

    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token; please log in again.");
      return;
    }

    const entry = reconEntryEdit.entry;
    const d = reconEntryEdit.draft;

    const patch: any = {};

    const cleanNumber = (raw: string): number | null => {
      const s = raw.trim().replace(/,/g, "");
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    };

    const nextKind = d.kind || "ADD";
    const prevKind = entry?.kind ?? "ADD";
    if (nextKind !== prevKind) patch.kind = nextKind;

    const nextTag = d.tag || null;
    const prevTag = entry?.tag ?? null;
    if (nextTag !== prevTag) patch.tag = nextTag;

    const nextDesc = d.description.trim() || null;
    const prevDesc = entry?.description ?? null;
    if (nextDesc !== prevDesc) patch.description = nextDesc;

    const nextNote = d.note.trim() || null;
    const prevNote = entry?.note ?? null;
    if (nextNote !== prevNote) patch.note = nextNote;

    const qtyRaw = d.qty;
    const qtyVal = cleanNumber(qtyRaw);
    if (qtyRaw.trim() !== "" && qtyVal === null) {
      alert("Qty must be a number (or blank).");
      return;
    }
    const nextQty = qtyVal;
    const prevQty = typeof entry?.qty === "number" ? entry.qty : null;
    if (nextQty !== prevQty) patch.qty = nextQty;

    const unitRaw = d.unit.trim();
    const nextUnit = unitRaw || null;
    const prevUnit = entry?.unit ?? null;
    if (nextUnit !== prevUnit) patch.unit = nextUnit;

    const unitCostRaw = d.unitCost;
    const unitCostVal = cleanNumber(unitCostRaw);
    if (unitCostRaw.trim() !== "" && unitCostVal === null) {
      alert("Unit cost must be a number (or blank).");
      return;
    }
    const nextUnitCost = unitCostVal;
    const prevUnitCost = typeof entry?.unitCost === "number" ? entry.unitCost : null;
    if (nextUnitCost !== prevUnitCost) patch.unitCost = nextUnitCost;

    const itemRaw = d.itemAmount;
    const itemVal = cleanNumber(itemRaw);
    if (itemRaw.trim() !== "" && itemVal === null) {
      alert("Item amount must be a number (or blank).");
      return;
    }
    let nextItem = itemVal;
    const prevItem = typeof entry?.itemAmount === "number" ? entry.itemAmount : null;

    const taxRaw = d.salesTaxAmount;
    const taxVal = cleanNumber(taxRaw);
    if (taxRaw.trim() !== "" && taxVal === null) {
      alert("Tax amount must be a number (or blank).");
      return;
    }
    let nextTax = taxVal;
    const prevTax = typeof entry?.salesTaxAmount === "number" ? entry.salesTaxAmount : null;

    const opRaw = d.opAmount;
    const opVal = cleanNumber(opRaw);
    if (opRaw.trim() !== "" && opVal === null) {
      alert("O&P amount must be a number (or blank).");
      return;
    }
    let nextOp = opVal;
    const prevOp = typeof entry?.opAmount === "number" ? entry.opAmount : null;

    const rcvRaw = d.rcvAmount;
    const rcvVal = cleanNumber(rcvRaw);
    if (rcvRaw.trim() !== "" && rcvVal === null) {
      alert("RCV must be a number (or blank).");
      return;
    }
    let nextRcv = rcvVal;
    const prevRcv = typeof entry?.rcvAmount === "number" ? entry.rcvAmount : null;

    // Derive itemAmount/RCV when qty/unitCost change and amounts are not explicitly overridden.
    const qtyChanged = nextQty !== prevQty;
    const unitCostChanged = nextUnitCost !== prevUnitCost;

    if (nextItem === null && (qtyChanged || unitCostChanged)) {
      const qtyForCalc = nextQty ?? prevQty;
      const unitForCalc = nextUnitCost ?? prevUnitCost;
      if (qtyForCalc != null && unitForCalc != null) {
        nextItem = qtyForCalc * unitForCalc;
      }
    }

    // If RCV wasn't explicitly set, recompute from components when they change.
    const itemForCalc = nextItem ?? prevItem ?? 0;
    const taxForCalc = nextTax ?? prevTax ?? 0;
    const opForCalc = nextOp ?? prevOp ?? 0;

    const anyAmountChanged =
      nextItem !== prevItem || nextTax !== prevTax || nextOp !== prevOp;

    if (rcvRaw.trim() === "" && anyAmountChanged) {
      nextRcv = itemForCalc + taxForCalc + opForCalc;
    }

    // Now build patch only for fields that changed.
    if (nextItem !== prevItem) patch.itemAmount = nextItem;
    if (nextTax !== prevTax) patch.salesTaxAmount = nextTax;
    if (nextOp !== prevOp) patch.opAmount = nextOp;
    if (nextRcv !== prevRcv) patch.rcvAmount = nextRcv;

    // Percent complete
    const pctRaw = d.percentComplete.trim();
    const pctVal = pctRaw === "" ? 100 : Number(pctRaw);
    if (!Number.isFinite(pctVal) || pctVal < 0 || pctVal > 100) {
      alert("Percent complete must be 0-100.");
      return;
    }
    const prevPct = typeof entry?.percentComplete === "number" ? entry.percentComplete : 0;
    if (pctVal !== prevPct) patch.percentComplete = pctVal;

    // Activity and cost component fields
    const nextActivity = d.activity || null;
    const prevActivity = entry?.activity ?? null;
    if (nextActivity !== prevActivity) patch.activity = nextActivity;

    const workersWageRaw = d.workersWage || "";
    const workersWageVal = cleanNumber(workersWageRaw);
    if (workersWageRaw.trim() !== "" && workersWageVal === null) {
      alert("Worker's Wage must be a number (or blank).");
      return;
    }
    const nextWorkersWage = workersWageVal;
    const prevWorkersWage = typeof entry?.workersWage === "number" ? entry.workersWage : null;
    if (nextWorkersWage !== prevWorkersWage) patch.workersWage = nextWorkersWage;

    const laborBurdenRaw = d.laborBurden || "";
    const laborBurdenVal = cleanNumber(laborBurdenRaw);
    if (laborBurdenRaw.trim() !== "" && laborBurdenVal === null) {
      alert("Labor Burden must be a number (or blank).");
      return;
    }
    const nextLaborBurden = laborBurdenVal;
    const prevLaborBurden = typeof entry?.laborBurden === "number" ? entry.laborBurden : null;
    if (nextLaborBurden !== prevLaborBurden) patch.laborBurden = nextLaborBurden;

    const laborOverheadRaw = d.laborOverhead || "";
    const laborOverheadVal = cleanNumber(laborOverheadRaw);
    if (laborOverheadRaw.trim() !== "" && laborOverheadVal === null) {
      alert("Labor Overhead must be a number (or blank).");
      return;
    }
    const nextLaborOverhead = laborOverheadVal;
    const prevLaborOverhead = typeof entry?.laborOverhead === "number" ? entry.laborOverhead : null;
    if (nextLaborOverhead !== prevLaborOverhead) patch.laborOverhead = nextLaborOverhead;

    const materialCostRaw = d.materialCost || "";
    const materialCostVal = cleanNumber(materialCostRaw);
    if (materialCostRaw.trim() !== "" && materialCostVal === null) {
      alert("Material Cost must be a number (or blank).");
      return;
    }
    const nextMaterialCost = materialCostVal;
    const prevMaterialCost = typeof entry?.materialCost === "number" ? entry.materialCost : null;
    if (nextMaterialCost !== prevMaterialCost) patch.materialCost = nextMaterialCost;

    const equipmentCostRaw = d.equipmentCost || "";
    const equipmentCostVal = cleanNumber(equipmentCostRaw);
    if (equipmentCostRaw.trim() !== "" && equipmentCostVal === null) {
      alert("Equipment Cost must be a number (or blank).");
      return;
    }
    const nextEquipmentCost = equipmentCostVal;
    const prevEquipmentCost = typeof entry?.equipmentCost === "number" ? entry.equipmentCost : null;
    if (nextEquipmentCost !== prevEquipmentCost) patch.equipmentCost = nextEquipmentCost;

    if (Object.keys(patch).length === 0) {
      closeReconEntryEdit();
      return;
    }

    setReconEntryEdit((prev) => (prev ? { ...prev, saving: true, error: null } : prev));

    try {
      const res = await fetch(
        `${API_BASE}/projects/${id}/petl-reconciliation/entries/${entry.id}`,
        {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(patch),
        },
      );

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        setReconEntryEdit((prev) =>
          prev ? { ...prev, saving: false, error: `Save failed (${res.status}) ${text}` } : prev,
        );
        return;
      }

      // Give backend a moment to process and commit the changes
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // Refresh PETL items and reconciliation data
      setPetlReloadTick((t) => t + 1);
      
      // Reload reconciliation panel if open
      if (petlReconPanel.sowItemId) {
        await loadPetlReconciliation(petlReconPanel.sowItemId);
      }
      
      // Explicitly fetch fresh PETL items to show updated values
      try {
        const petlRes = await fetch(`${API_BASE}/projects/${id}/petl`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (petlRes.ok) {
          const petl: any = await petlRes.json();
          const items: PetlItem[] = Array.isArray(petl.items) ? petl.items : [];
          setPetlItems(items);
          
          // Also update reconciliation entries
          const recon: any[] = Array.isArray(petl.reconciliationEntries)
            ? petl.reconciliationEntries
            : [];
          setPetlReconciliationEntries(recon);
        }
      } catch {
        // Non-fatal - the reload tick will trigger refresh anyway
      }

      closeReconEntryEdit();
    } catch (err: any) {
      setReconEntryEdit((prev) =>
        prev ? { ...prev, saving: false, error: err?.message ?? "Save failed" } : prev,
      );
    }
  };

  const filteredItemsForRoom = (particleId: string | null) => {
    if (!particleId) return [] as PetlItem[];
    return petlItemsByRoomParticleId.get(particleId) ?? ([] as PetlItem[]);
  };

  const openRoomComponentsPanel = async (roomId: string | null, roomName: string) => {
    if (!roomId) return;

    // PETL interaction: show delayed overlay for potentially heavy fetch + rerender.
    const done = busyOverlay.begin("Loading components…");

    // Preserve old behavior: clicking "Components" scopes the Room filter to that room.
    setRoomParticleIdFilters([roomId]);

    setRoomComponentsPanel({
      open: true,
      loading: true,
      error: null,
      roomName,
      components: [],
    });

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setRoomComponentsPanel(prev => ({
        ...prev,
        loading: false,
        error: "Missing access token. Please login again.",
      }));
      done();
      return;
    }

    try {
      const params = new URLSearchParams();
      params.set("roomParticleId", roomId);

      // Multi-select filters: repeat query params.
      for (const cat of categoryCodeFilters) params.append("categoryCode", cat);
      for (const sel of selectionCodeFilters) params.append("selectionCode", sel);

      const res = await fetch(
        `${API_BASE}/projects/${id}/petl-components?${params.toString()}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        },
      );
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        setRoomComponentsPanel(prev => ({
          ...prev,
          loading: false,
          error: `Failed to load components (${res.status}) ${text}`,
        }));
        return;
      }
      const json: any = await res.json();
      const items: RoomComponentAgg[] = Array.isArray(json.components)
        ? json.components
        : [];
      setRoomComponentsPanel(prev => ({
        ...prev,
        loading: false,
        components: items,
      }));
    } catch (err: any) {
      setRoomComponentsPanel(prev => ({
        ...prev,
        loading: false,
        error: err?.message ?? "Failed to load components",
      }));
    } finally {
      done();
    }
  };

  const handleCreateDailyLog = async (e: React.FormEvent) => {
    e.preventDefault();
    setDailyLogMessage(null);

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setDailyLogMessage("Missing access token. Please login again.");
      return;
    }

    if (!newDailyLog.logDate) {
      setDailyLogMessage("Log date is required.");
      return;
    }

    setDailyLogSaving(true);
    try {
      await busyOverlay.run("Saving daily log…", async () => {
        const tagsArray = newDailyLog.tags
          .split(",")
          .map(t => t.trim())
          .filter(Boolean);

        const isReceiptExpense = newDailyLog.type === "RECEIPT_EXPENSE";

        // Auto-fill title from notes if empty
        let finalTitle = newDailyLog.title.trim();
        if (!finalTitle && newDailyLog.workPerformed.trim()) {
          finalTitle = summarizeToTitle(newDailyLog.workPerformed);
        }

        const body: any = {
          logDate: newDailyLog.logDate,
          title: finalTitle || null,
          tags: tagsArray,
          type: newDailyLog.type,
          weatherSummary: newDailyLog.weatherSummary || null,
          crewOnSite: newDailyLog.crewOnSite || null,
          workPerformed: newDailyLog.workPerformed || null,
          issues: newDailyLog.issues || null,
          safetyIncidents: newDailyLog.safetyIncidents || null,
          manpowerOnsite: newDailyLog.manpowerOnsite || null,
          personOnsite: newDailyLog.personOnsite || null,
          confidentialNotes: newDailyLog.confidentialNotes || null,
          shareInternal: isReceiptExpense ? false : newDailyLog.shareInternal,
          shareSubs: isReceiptExpense ? false : newDailyLog.shareSubs,
          shareClient: isReceiptExpense ? false : newDailyLog.shareClient,
          sharePrivate: isReceiptExpense ? true : newDailyLog.sharePrivate,
          notifyUserIds: [] as string[],
        };

        // Receipt/expense fields
        if (isReceiptExpense) {
          body.expenseVendor = newDailyLog.expenseVendor || null;
          const amt = parseFloat(newDailyLog.expenseAmount);
          body.expenseAmount = !isNaN(amt) ? amt : null;
          body.expenseDate = newDailyLog.expenseDate || null;
        }

        // Attachment file IDs
        if (newDailyLog.attachmentProjectFileIds && newDailyLog.attachmentProjectFileIds.length > 0) {
          body.attachmentProjectFileIds = newDailyLog.attachmentProjectFileIds;
        }

        // Attach PETL context if present (PUDL scenario)
        if (newDailyLog.buildingId) body.buildingId = newDailyLog.buildingId;
        if (newDailyLog.unitId) body.unitId = newDailyLog.unitId;
        if (newDailyLog.roomParticleId) body.roomParticleId = newDailyLog.roomParticleId;
        if (newDailyLog.sowItemId) body.sowItemId = newDailyLog.sowItemId;

        const res = await fetch(`${API_BASE}/projects/${id}/daily-logs`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          setDailyLogMessage(`Failed to save log (${res.status}).`);
          return;
        }

        const created: DailyLog = await res.json();
        setDailyLogs(prev => [created, ...prev]);

        setNewDailyLog(prev => ({
          ...prev,
          title: "",
          tags: "",
          type: "PUDL" as DailyLogType,
          weatherSummary: "",
          workPerformed: "",
          crewOnSite: "",
          issues: "",
          safetyIncidents: "",
          manpowerOnsite: "",
          personOnsite: "",
          confidentialNotes: "",
          expenseVendor: "",
          expenseAmount: "",
          expenseDate: new Date().toISOString().slice(0, 10),
          attachmentProjectFileIds: [],
          attachmentFiles: [],
          buildingId: undefined,
          unitId: undefined,
          roomParticleId: undefined,
          sowItemId: undefined,
        }));
        setPersonOnsiteList([]);
        setPersonOnsiteDraft("");
        setSelectedPersonOnsiteGroupId("");

        setPudlContext({
          open: false,
          buildingId: null,
          unitId: null,
          roomParticleId: null,
          sowItemId: null,
          breadcrumb: null,
        });

        setDailyLogMessage("Daily log saved.");
      });
    } catch (err: any) {
      setDailyLogMessage(err?.message || "Error saving daily log.");
    } finally {
      setDailyLogSaving(false);
    }
  };

  // Open edit daily log modal
  const openEditDailyLog = (log: DailyLog) => {
    setEditDailyLog({
      open: true,
      log,
      draft: {
        logDate: log.logDate ? log.logDate.slice(0, 10) : "",
        title: log.title || "",
        tags: "",
        type: log.type || "PUDL",
        weatherSummary: log.weatherSummary || "",
        workPerformed: log.workPerformed || "",
        crewOnSite: log.crewOnSite || "",
        issues: log.issues || "",
        safetyIncidents: log.safetyIncidents || "",
        manpowerOnsite: log.manpowerOnsite || "",
        personOnsite: log.personOnsite || "",
        confidentialNotes: log.confidentialNotes || "",
        shareInternal: log.shareInternal,
        shareSubs: log.shareSubs,
        shareClient: log.shareClient,
        sharePrivate: log.sharePrivate,
        expenseVendor: log.expenseVendor || "",
        expenseAmount: log.expenseAmount != null ? String(log.expenseAmount) : "",
        expenseDate: log.expenseDate ? log.expenseDate.slice(0, 10) : "",
      },
      saving: false,
      error: null,
    });
  };

  const closeEditDailyLog = () => {
    setEditDailyLog({ open: false, log: null, draft: null, saving: false, error: null });
  };

  // Delete a daily log (PM+ only)
  const handleDeleteDailyLog = async (logId: string, logTitle?: string | null) => {
    const confirmed = window.confirm(
      `Are you sure you want to delete this daily log${logTitle ? `: "${logTitle}"` : ""}? This action cannot be undone.`
    );
    if (!confirmed) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token. Please login again.");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/projects/${id}/daily-logs/${logId}`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        alert(`Failed to delete daily log (${res.status}): ${text}`);
        return;
      }

      // Remove from local state
      setDailyLogs(prev => prev.filter(l => l.id !== logId));
      setDailyLogMessage("Daily log deleted.");
    } catch (err: any) {
      alert(`Error deleting daily log: ${err?.message || "Unknown error"}`);
    }
  };

  const handleUpdateDailyLog = async () => {
    if (!editDailyLog.log || !editDailyLog.draft) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setEditDailyLog(prev => ({ ...prev, error: "Missing access token." }));
      return;
    }

    setEditDailyLog(prev => ({ ...prev, saving: true, error: null }));

    try {
      const draft = editDailyLog.draft;
      const isReceiptExpense = draft.type === "RECEIPT_EXPENSE";

      const body: any = {
        logDate: draft.logDate || null,
        title: draft.title || null,
        type: draft.type,
        weatherSummary: draft.weatherSummary || null,
        crewOnSite: draft.crewOnSite || null,
        workPerformed: draft.workPerformed || null,
        issues: draft.issues || null,
        safetyIncidents: draft.safetyIncidents || null,
        manpowerOnsite: draft.manpowerOnsite || null,
        personOnsite: draft.personOnsite || null,
        confidentialNotes: draft.confidentialNotes || null,
        shareInternal: isReceiptExpense ? false : draft.shareInternal,
        shareSubs: isReceiptExpense ? false : draft.shareSubs,
        shareClient: isReceiptExpense ? false : draft.shareClient,
        sharePrivate: isReceiptExpense ? true : draft.sharePrivate,
      };

      if (isReceiptExpense) {
        body.expenseVendor = draft.expenseVendor || null;
        const amt = parseFloat(draft.expenseAmount);
        body.expenseAmount = !isNaN(amt) ? amt : null;
        body.expenseDate = draft.expenseDate || null;
      }

      const res = await fetch(`${API_BASE}/daily-logs/${editDailyLog.log.id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        setEditDailyLog(prev => ({ ...prev, saving: false, error: `Update failed (${res.status}) ${text}` }));
        return;
      }

      const updated: DailyLog = await res.json();
      setDailyLogs(prev => prev.map(l => (l.id === updated.id ? { ...l, ...updated } : l)));
      closeEditDailyLog();
    } catch (err: any) {
      setEditDailyLog(prev => ({ ...prev, saving: false, error: err?.message || "Update failed." }));
    }
  };

  // Open attachments viewer (gallery mode)
  const openAttachmentsViewer = (log: DailyLog, startIndex = 0) => {
    console.log('[GALLERY] openAttachmentsViewer called, log.id:', log.id, 'attachments:', log.attachments?.length);
    setAttachmentsViewer({ open: true, log, currentIndex: startIndex });
  };

  const closeAttachmentsViewer = () => {
    setAttachmentsViewer({ open: false, log: null, currentIndex: 0 });
  };

  // Open reassign daily log modal
  const openReassignDailyLog = async (log: DailyLog) => {
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("Missing access token.");
      return;
    }

    setReassignDailyLog({
      open: true,
      logId: log.id,
      logTitle: log.title,
      targetProjectId: "",
      availableProjects: [],
      loading: true,
      saving: false,
      error: null,
    });

    try {
      const res = await fetch(`${API_BASE}/projects`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!res.ok) throw new Error("Failed to load projects");
      const projects = await res.json();
      // Filter out current project
      const available = (Array.isArray(projects) ? projects : [])
        .filter((p: any) => p.id !== id)
        .map((p: any) => ({ id: p.id, name: p.name }))
        .sort((a: any, b: any) => (a.name || "").localeCompare(b.name || ""));
      setReassignDailyLog(prev => ({ ...prev, availableProjects: available, loading: false }));
    } catch (err: any) {
      setReassignDailyLog(prev => ({ ...prev, loading: false, error: err?.message || "Failed to load projects" }));
    }
  };

  const handleReassignDailyLog = async () => {
    if (!reassignDailyLog.logId || !reassignDailyLog.targetProjectId) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setReassignDailyLog(prev => ({ ...prev, error: "Missing access token." }));
      return;
    }

    setReassignDailyLog(prev => ({ ...prev, saving: true, error: null }));

    try {
      const res = await fetch(`${API_BASE}/daily-logs/${reassignDailyLog.logId}/reassign`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ targetProjectId: reassignDailyLog.targetProjectId }),
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(text || `Reassign failed (${res.status})`);
      }

      const result = await res.json();

      // Remove from local state since it's now in a different project
      setDailyLogs(prev => prev.filter(l => l.id !== reassignDailyLog.logId));

      // Close view modal if open
      if (viewDailyLog.log?.id === reassignDailyLog.logId) {
        setViewDailyLog({ open: false, log: null, draft: null, editing: false, saving: false, error: null });
      }

      // Close reassign modal
      setReassignDailyLog({ open: false, logId: null, logTitle: null, targetProjectId: "", availableProjects: [], loading: false, saving: false, error: null });

      setDailyLogMessage(`Daily log reassigned to ${result.newProjectName}.`);
    } catch (err: any) {
      setReassignDailyLog(prev => ({ ...prev, saving: false, error: err?.message || "Reassign failed" }));
    }
  };

  const goToPrevAttachment = () => {
    setAttachmentsViewer(prev => {
      if (!prev.log?.attachments?.length) return prev;
      const newIndex = prev.currentIndex > 0 ? prev.currentIndex - 1 : prev.log.attachments.length - 1;
      return { ...prev, currentIndex: newIndex };
    });
  };

  const goToNextAttachment = () => {
    setAttachmentsViewer(prev => {
      if (!prev.log?.attachments?.length) return prev;
      const newIndex = prev.currentIndex < prev.log.attachments.length - 1 ? prev.currentIndex + 1 : 0;
      return { ...prev, currentIndex: newIndex };
    });
  };

  // PETL Update Modal handlers
  const openPetlUpdateModal = (log: DailyLog) => {
    // Find the linked SOW item's current percent from petlItems if available
    let currentPercent = "";
    if (log.sowItem?.id) {
      const petlItem = petlItems.find(p => p.id === log.sowItem?.id);
      if (petlItem && typeof petlItem.percentComplete === "number") {
        currentPercent = String(petlItem.percentComplete);
      }
    }
    setPetlUpdateModal({ open: true, log, percentComplete: currentPercent, saving: false, error: null });
  };

  const closePetlUpdateModal = () => {
    setPetlUpdateModal({ open: false, log: null, percentComplete: "", saving: false, error: null });
  };

  const handleSavePetlUpdate = async () => {
    if (!petlUpdateModal.log?.sowItem?.id) return;

    const token = localStorage.getItem("accessToken");
    if (!token) {
      setPetlUpdateModal(prev => ({ ...prev, error: "Missing access token." }));
      return;
    }

    const pct = parseFloat(petlUpdateModal.percentComplete);
    if (isNaN(pct) || pct < 0 || pct > 100) {
      setPetlUpdateModal(prev => ({ ...prev, error: "Percent must be between 0 and 100." }));
      return;
    }

    setPetlUpdateModal(prev => ({ ...prev, saving: true, error: null }));

    try {
      const res = await fetch(`${API_BASE}/projects/${id}/petl/${petlUpdateModal.log!.sowItem!.id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ percentComplete: pct }),
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        setPetlUpdateModal(prev => ({ ...prev, saving: false, error: `Update failed (${res.status}) ${text}` }));
        return;
      }

      // Update local petlItems state
      setPetlItems(prev => prev.map(p => p.id === petlUpdateModal.log!.sowItem!.id ? { ...p, percentComplete: pct } : p));
      closePetlUpdateModal();
    } catch (err: any) {
      setPetlUpdateModal(prev => ({ ...prev, saving: false, error: err?.message || "Update failed." }));
    }
  };

  // Attachments Gallery Modal - render BEFORE early returns so it shows regardless of loading state
  const attachmentsGalleryModal = attachmentsViewer.open && attachmentsViewer.log && (
    <div
      style={{
        position: "fixed",
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        zIndex: 999999,
        backgroundColor: "rgba(0, 0, 0, 0.92)",
        display: "flex",
        flexDirection: "column",
        alignItems: "center",
        justifyContent: "center",
      }}
      onClick={closeAttachmentsViewer}
    >
      {(() => {
        console.log('[GALLERY] Rendering attachmentsGalleryModal');
        const att = attachmentsViewer.log?.attachments?.[attachmentsViewer.currentIndex];
        const url = att?.fileUrl || "";
        const name = att?.fileName || "attachment";
        const isImg = /\.(png|jpe?g|gif|webp)$/i.test(url) || (att?.mimeType || "").startsWith("image/");
        const total = attachmentsViewer.log?.attachments?.length || 0;
        const hasMultiple = total > 1;
        
        return (
          <>
            {/* Close button */}
            <button
              type="button"
              onClick={closeAttachmentsViewer}
              style={{
                position: "absolute",
                top: 20,
                right: 20,
                border: "none",
                background: "rgba(255,255,255,0.2)",
                borderRadius: 8,
                cursor: "pointer",
                fontSize: 20,
                padding: "8px 16px",
                color: "#ffffff",
              }}
            >
              ✕ Close
            </button>

            {/* Header info */}
            <div style={{ position: "absolute", top: 20, left: 20, color: "#ffffff" }}>
              <div style={{ fontSize: 16, fontWeight: 600 }}>
                {attachmentsViewer.log?.title || "Daily Log"}
              </div>
              <div style={{ fontSize: 13, opacity: 0.7 }}>
                {attachmentsViewer.currentIndex + 1} of {total}
              </div>
            </div>

            {/* Main content */}
            <div onClick={e => e.stopPropagation()} style={{ maxWidth: "90vw", maxHeight: "75vh" }}>
              {isImg ? (
                <img src={url} alt={name} style={{ maxWidth: "90vw", maxHeight: "75vh", objectFit: "contain", borderRadius: 8 }} />
              ) : (
                <div style={{ padding: 40, background: "rgba(255,255,255,0.1)", borderRadius: 12, textAlign: "center" }}>
                  <div style={{ fontSize: 64, marginBottom: 16 }}>📄</div>
                  <div style={{ color: "#fff", marginBottom: 16 }}>{name}</div>
                  <a href={url} target="_blank" rel="noopener noreferrer" style={{ color: "#60a5fa" }}>Open file →</a>
                </div>
              )}
            </div>

            {/* Navigation arrows */}
            {hasMultiple && (
              <>
                <button
                  type="button"
                  onClick={(e) => { e.stopPropagation(); goToPrevAttachment(); }}
                  style={{ position: "absolute", left: 20, top: "50%", transform: "translateY(-50%)", width: 50, height: 50, borderRadius: "50%", border: "none", background: "rgba(255,255,255,0.2)", color: "#fff", fontSize: 28, cursor: "pointer" }}
                >
                  ‹
                </button>
                <button
                  type="button"
                  onClick={(e) => { e.stopPropagation(); goToNextAttachment(); }}
                  style={{ position: "absolute", right: 20, top: "50%", transform: "translateY(-50%)", width: 50, height: 50, borderRadius: "50%", border: "none", background: "rgba(255,255,255,0.2)", color: "#fff", fontSize: 28, cursor: "pointer" }}
                >
                  ›
                </button>
              </>
            )}

            {/* Thumbnails */}
            {hasMultiple && (
              <div onClick={e => e.stopPropagation()} style={{ position: "absolute", bottom: 20, display: "flex", gap: 8, padding: "10px 16px", background: "rgba(0,0,0,0.5)", borderRadius: 8 }}>
                {attachmentsViewer.log?.attachments?.map((a, idx) => {
                  const thumbUrl = a.fileUrl || "";
                  const isActive = idx === attachmentsViewer.currentIndex;
                  const isThumbImg = /\.(png|jpe?g|gif|webp)$/i.test(thumbUrl);
                  return (
                    <button key={a.id} type="button" onClick={() => setAttachmentsViewer(prev => ({ ...prev, currentIndex: idx }))} style={{ width: 50, height: 50, borderRadius: 4, border: isActive ? "2px solid #60a5fa" : "2px solid transparent", padding: 0, cursor: "pointer", overflow: "hidden", opacity: isActive ? 1 : 0.5 }}>
                      {isThumbImg ? <img src={thumbUrl} alt="" style={{ width: "100%", height: "100%", objectFit: "cover" }} /> : <div style={{ width: "100%", height: "100%", display: "flex", alignItems: "center", justifyContent: "center", background: "#374151", fontSize: 20 }}>📄</div>}
                    </button>
                  );
                })}
              </div>
            )}
          </>
        );
      })()}
    </div>
  );

  // Edit Daily Log Modal - render BEFORE early returns so it shows regardless of loading state
  const editDailyLogModal = editDailyLog.open && editDailyLog.draft && (
    <div
      style={{
        position: "fixed",
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        zIndex: 99999,
        backgroundColor: "rgba(15, 23, 42, 0.6)",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
      }}
      onClick={closeEditDailyLog}
    >
      <div
        style={{
          width: 600,
          maxWidth: "96vw",
          maxHeight: "90vh",
          overflowY: "auto",
          backgroundColor: "#ffffff",
          borderRadius: 10,
          border: "1px solid #e5e7eb",
          boxShadow: "0 16px 40px rgba(15,23,42,0.35)",
          padding: 16,
          fontSize: 13,
        }}
        onClick={e => e.stopPropagation()}
      >
        <div
          style={{
            display: "flex",
            alignItems: "center",
            justifyContent: "space-between",
            marginBottom: 12,
          }}
        >
          <div style={{ fontSize: 15, fontWeight: 600 }}>Edit Daily Log</div>
          <button
            type="button"
            onClick={closeEditDailyLog}
            style={{
              border: "none",
              background: "transparent",
              cursor: "pointer",
              fontSize: 18,
              lineHeight: 1,
              padding: 4,
            }}
            aria-label="Close"
          >
            ×
          </button>
        </div>

        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
          <div>
            <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Type</label>
            <select
              value={editDailyLog.draft.type}
              onChange={e =>
                setEditDailyLog(prev => ({
                  ...prev,
                  draft: prev.draft ? { ...prev.draft, type: e.target.value as DailyLogType } : null,
                }))
              }
              style={{
                width: "100%",
                padding: "6px 8px",
                borderRadius: 4,
                border: "1px solid #d1d5db",
                fontSize: 12,
              }}
            >
              <option value="PUDL">Daily Log (PUDL)</option>
              <option value="RECEIPT_EXPENSE">Receipt / Expense</option>
              <option value="JSA">Job Safety Assessment</option>
              <option value="INCIDENT">Incident Report</option>
              <option value="QUALITY">Quality Inspection</option>
            </select>
          </div>
          <div>
            <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Date</label>
            <input
              type="date"
              value={editDailyLog.draft.logDate}
              onChange={e =>
                setEditDailyLog(prev => ({
                  ...prev,
                  draft: prev.draft ? { ...prev.draft, logDate: e.target.value } : null,
                }))
              }
              style={{
                width: "100%",
                padding: "6px 8px",
                borderRadius: 4,
                border: "1px solid #d1d5db",
                fontSize: 12,
              }}
            />
          </div>
        </div>

        <div style={{ marginBottom: 12 }}>
          <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Title</label>
          <input
            type="text"
            value={editDailyLog.draft.title}
            onChange={e =>
              setEditDailyLog(prev => ({
                ...prev,
                draft: prev.draft ? { ...prev.draft, title: e.target.value } : null,
              }))
            }
            style={{
              width: "100%",
              padding: "6px 8px",
              borderRadius: 4,
              border: "1px solid #d1d5db",
              fontSize: 12,
            }}
          />
        </div>

        <div style={{ marginBottom: 12 }}>
          <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Work Performed</label>
          <textarea
            value={editDailyLog.draft.workPerformed}
            onChange={e =>
              setEditDailyLog(prev => ({
                ...prev,
                draft: prev.draft ? { ...prev.draft, workPerformed: e.target.value } : null,
              }))
            }
            rows={3}
            style={{
              width: "100%",
              padding: "6px 8px",
              borderRadius: 4,
              border: "1px solid #d1d5db",
              fontSize: 12,
              resize: "vertical",
            }}
          />
        </div>

        <div style={{ marginBottom: 12 }}>
          <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Crew On Site</label>
          <textarea
            value={editDailyLog.draft.crewOnSite}
            onChange={e =>
              setEditDailyLog(prev => ({
                ...prev,
                draft: prev.draft ? { ...prev.draft, crewOnSite: e.target.value } : null,
              }))
            }
            rows={2}
            style={{
              width: "100%",
              padding: "6px 8px",
              borderRadius: 4,
              border: "1px solid #d1d5db",
              fontSize: 12,
              resize: "vertical",
            }}
          />
        </div>

        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
          <div>
            <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Issues</label>
            <textarea
              value={editDailyLog.draft.issues}
              onChange={e =>
                setEditDailyLog(prev => ({
                  ...prev,
                  draft: prev.draft ? { ...prev.draft, issues: e.target.value } : null,
                }))
              }
              rows={2}
              style={{
                width: "100%",
                padding: "6px 8px",
                borderRadius: 4,
                border: "1px solid #d1d5db",
                fontSize: 12,
                resize: "vertical",
              }}
            />
          </div>
          <div>
            <label style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 12, marginBottom: 2 }}>
              Safety Note
              {editDailyLog.draft.safetyIncidents && editDailyLog.draft.safetyIncidents.trim() !== "" && (
                <span style={{ fontSize: 9, fontWeight: 600, padding: "2px 6px", borderRadius: 4, backgroundColor: "#fef2f2", color: "#b91c1c", border: "1px solid #fecaca" }}>⚠️ Safety Review</span>
              )}
            </label>
            <textarea
              value={editDailyLog.draft.safetyIncidents}
              onChange={e =>
                setEditDailyLog(prev => ({
                  ...prev,
                  draft: prev.draft ? { ...prev.draft, safetyIncidents: e.target.value } : null,
                }))
              }
              rows={2}
              style={{
                width: "100%",
                padding: "6px 8px",
                borderRadius: 4,
                border: editDailyLog.draft.safetyIncidents && editDailyLog.draft.safetyIncidents.trim() !== "" ? "1px solid #fca5a5" : "1px solid #d1d5db",
                fontSize: 12,
                resize: "vertical",
                backgroundColor: editDailyLog.draft.safetyIncidents && editDailyLog.draft.safetyIncidents.trim() !== "" ? "#fef2f2" : "#ffffff",
              }}
            />
          </div>
        </div>

        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
          <div>
            <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Weather</label>
            <input
              type="text"
              value={editDailyLog.draft.weatherSummary}
              onChange={e =>
                setEditDailyLog(prev => ({
                  ...prev,
                  draft: prev.draft ? { ...prev.draft, weatherSummary: e.target.value } : null,
                }))
              }
              style={{
                width: "100%",
                padding: "6px 8px",
                borderRadius: 4,
                border: "1px solid #d1d5db",
                fontSize: 12,
              }}
            />
          </div>
          <div>
            <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Person Onsite</label>
            <input
              type="text"
              value={editDailyLog.draft.personOnsite}
              onChange={e =>
                setEditDailyLog(prev => ({
                  ...prev,
                  draft: prev.draft ? { ...prev.draft, personOnsite: e.target.value } : null,
                }))
              }
              style={{
                width: "100%",
                padding: "6px 8px",
                borderRadius: 4,
                border: "1px solid #d1d5db",
                fontSize: 12,
              }}
            />
          </div>
        </div>

        <div style={{ marginBottom: 12 }}>
          <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Confidential Notes (NO PRINT)</label>
          <textarea
            value={editDailyLog.draft.confidentialNotes}
            onChange={e =>
              setEditDailyLog(prev => ({
                ...prev,
                draft: prev.draft ? { ...prev.draft, confidentialNotes: e.target.value } : null,
              }))
            }
            rows={2}
            style={{
              width: "100%",
              padding: "6px 8px",
              borderRadius: 4,
              border: "1px solid #d1d5db",
              fontSize: 12,
              resize: "vertical",
            }}
          />
        </div>

        {/* Receipt/Expense fields - shown when type is RECEIPT_EXPENSE */}
        {editDailyLog.draft.type === "RECEIPT_EXPENSE" && (
          <div style={{ marginBottom: 12, padding: 10, background: "#fef3c7", borderRadius: 6, border: "1px solid #fcd34d" }}>
            <div style={{ fontSize: 11, fontWeight: 600, marginBottom: 6, color: "#92400e" }}>Receipt Details</div>
            <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr", gap: 8 }}>
              <div>
                <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>Vendor</label>
                <input
                  type="text"
                  value={editDailyLog.draft.expenseVendor}
                  onChange={e =>
                    setEditDailyLog(prev => ({
                      ...prev,
                      draft: prev.draft ? { ...prev.draft, expenseVendor: e.target.value } : null,
                    }))
                  }
                  style={{
                    width: "100%",
                    padding: "4px 6px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                  }}
                />
              </div>
              <div>
                <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>Amount</label>
                <input
                  type="number"
                  step="0.01"
                  value={editDailyLog.draft.expenseAmount}
                  onChange={e =>
                    setEditDailyLog(prev => ({
                      ...prev,
                      draft: prev.draft ? { ...prev.draft, expenseAmount: e.target.value } : null,
                    }))
                  }
                  style={{
                    width: "100%",
                    padding: "4px 6px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                  }}
                />
              </div>
              <div>
                <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>Receipt Date</label>
                <input
                  type="date"
                  value={editDailyLog.draft.expenseDate}
                  onChange={e =>
                    setEditDailyLog(prev => ({
                      ...prev,
                      draft: prev.draft ? { ...prev.draft, expenseDate: e.target.value } : null,
                    }))
                  }
                  style={{
                    width: "100%",
                    padding: "4px 6px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                  }}
                />
              </div>
            </div>
          </div>
        )}

        {editDailyLog.error && (
          <div style={{ marginBottom: 12, color: "#b91c1c", fontSize: 12 }}>
            {editDailyLog.error}
          </div>
        )}

        {/* Permission check: author or PM+ can delete/move */}
        {(() => {
          const isAuthor = editDailyLog.log?.createdByUser?.id === currentUserId;
          const isPmPlus = project && (project.userRole === "OWNER" || project.userRole === "ADMIN" || project.userRole === "PM");
          const canDeleteOrMove = isAuthor || isPmPlus;

          return (
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              {/* Delete and Move buttons on the left */}
              {canDeleteOrMove && editDailyLog.log ? (
                <div style={{ display: "flex", gap: 8 }}>
                  <button
                    type="button"
                    disabled={editDailyLog.saving}
                    onClick={async () => {
                      if (!editDailyLog.log) return;
                      const ok = window.confirm(
                        "Delete this daily log?\n\nThis action cannot be undone. Any linked draft bill will also be deleted."
                      );
                      if (!ok) return;

                      const token = localStorage.getItem("accessToken");
                      if (!token) {
                        setEditDailyLog(prev => ({ ...prev, error: "Missing access token." }));
                        return;
                      }

                      setEditDailyLog(prev => ({ ...prev, saving: true, error: null }));
                      try {
                        const res = await fetch(
                          `${API_BASE}/daily-logs/${editDailyLog.log!.id}`,
                          {
                            method: "DELETE",
                            headers: {
                              Authorization: `Bearer ${token}`,
                            },
                          }
                        );
                        if (!res.ok) {
                          const text = await res.text().catch(() => "");
                          setEditDailyLog(prev => ({ ...prev, saving: false, error: `Delete failed (${res.status}) ${text}` }));
                          return;
                        }
                        // Remove from local state
                        setDailyLogs(prev => prev.filter(l => l.id !== editDailyLog.log!.id));
                        // Close modal
                        setEditDailyLog({ open: false, log: null, draft: null, saving: false, error: null });
                        setDailyLogMessage("Daily log deleted.");
                      } catch (err: any) {
                        setEditDailyLog(prev => ({ ...prev, saving: false, error: err?.message ?? "Delete failed." }));
                      }
                    }}
                    style={{
                      padding: "8px 14px",
                      borderRadius: 6,
                      border: "1px solid #dc2626",
                      background: "#fef2f2",
                      color: "#b91c1c",
                      cursor: editDailyLog.saving ? "default" : "pointer",
                      fontSize: 12,
                    }}
                  >
                    Delete
                  </button>
                  <button
                    type="button"
                    disabled={editDailyLog.saving}
                    onClick={() => {
                      if (!editDailyLog.log) return;
                      // Close edit modal and open reassign modal
                      const log = editDailyLog.log;
                      setEditDailyLog({ open: false, log: null, draft: null, saving: false, error: null });
                      openReassignDailyLog(log);
                    }}
                    style={{
                      padding: "8px 14px",
                      borderRadius: 6,
                      border: "1px solid #2563eb",
                      background: "#eff6ff",
                      color: "#1d4ed8",
                      cursor: editDailyLog.saving ? "default" : "pointer",
                      fontSize: 12,
                    }}
                  >
                    Move to Project…
                  </button>
                </div>
              ) : (
                <div />
              )}
              {/* Cancel and Save buttons on the right */}
              <div style={{ display: "flex", gap: 8 }}>
                <button
                  type="button"
                  onClick={closeEditDailyLog}
                  style={{
                    padding: "8px 14px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Cancel
                </button>
                <button
                  type="button"
                  onClick={handleUpdateDailyLog}
                  disabled={editDailyLog.saving}
                  style={{
                    padding: "8px 14px",
                    borderRadius: 6,
                    border: "1px solid #0f172a",
                    background: editDailyLog.saving ? "#e5e7eb" : "#0f172a",
                    color: editDailyLog.saving ? "#4b5563" : "#f9fafb",
                    cursor: editDailyLog.saving ? "default" : "pointer",
                    fontSize: 12,
                  }}
                >
                  {editDailyLog.saving ? "Saving…" : "Save Changes"}
                </button>
              </div>
            </div>
          );
        })()}
      </div>
    </div>
  );

  if (loading) {
    return (
      <>
        {attachmentsGalleryModal}
        {editDailyLogModal}
        <div className="app-card">
          <p style={{ fontSize: 14, color: "#6b7280" }}>Loading project…</p>
        </div>
      </>
    );
  }

  if (error || !project) {
    return (
      <>
        {attachmentsGalleryModal}
        {editDailyLogModal}
        <div className="app-card">
          <h1 style={{ marginTop: 0, fontSize: 20 }}>Project</h1>
          <p style={{ color: "#b91c1c" }}>{error ?? "Project not found."}</p>
        </div>
      </>
    );
  }

  const canEditProjectHeader =
    actorGlobalRole === "SUPER_ADMIN" ||
    actorCompanyRole === "OWNER" ||
    actorCompanyRole === "ADMIN";

  // Precompute a formatted project address and a Google Maps link for click-to-open behavior
  const projectAddressParts: string[] = [];
  if (project.addressLine1) projectAddressParts.push(project.addressLine1);
  if (project.addressLine2) projectAddressParts.push(project.addressLine2);
  const cityState = [project.city, project.state].filter(Boolean).join(", ");
  if (cityState) projectAddressParts.push(cityState);
  const projectAddress = projectAddressParts.join(", ");
  const projectMapsUrl = projectAddress
    ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(projectAddress)}`
    : null;

  const beginEditProject = () => {
    if (!project) return;

    editTransitionOverlayLabelRef.current = "Opening editor…";
    busyOverlay.setMessage(editTransitionOverlayLabelRef.current);

    startEditTransition(() => {
      setEditProjectMessage(null);
      setDeleteProjectMessage(null);
      setEditProject({
        name: project.name,
        status: project.status,
        addressLine1: project.addressLine1,
        addressLine2: project.addressLine2 ?? null,
        city: project.city,
        state: project.state,
        primaryContactName: project.primaryContactName ?? null,
        primaryContactEmail: project.primaryContactEmail ?? null,
        primaryContactPhone: project.primaryContactPhone ?? null,
      });

      const s = (project.status || "").toLowerCase();
      if (s === "archived") setEditProjectState("ARCHIVED");
      else if (s === "deleted") setEditProjectState("DELETED");
      else if (s === "warranty") setEditProjectState("WARRANTY");
      else setEditProjectState("OPEN");

      setEditProjectMode(true);
    });
  };

  const cancelEditProject = () => {
    editTransitionOverlayLabelRef.current = "Closing editor…";
    busyOverlay.setMessage(editTransitionOverlayLabelRef.current);

    startEditTransition(() => {
      setEditProjectMode(false);
      setEditProjectMessage(null);
      setDeleteProjectMessage(null);
    });
  };

  const saveEditProject = async () => {
    if (!project) return;
    if (!editProject) return;
    const token = localStorage.getItem("accessToken");
    if (!token) {
      setEditProjectMessage("Missing access token. Please login again.");
      return;
    }
    setEditProjectSaving(true);
    setEditProjectMessage(null);
    setDeleteProjectMessage(null);
    try {
      await busyOverlay.run("Saving project…", async () => {
        // Map the chosen state to a canonical status string
        let nextStatus = editProject.status || project.status || "open";
        const state = editProjectState;
        if (state === "ARCHIVED") nextStatus = "archived";
        else if (state === "DELETED") nextStatus = "deleted";
        else if (state === "WARRANTY") nextStatus = "warranty";
        else if (state === "OPEN") nextStatus = "open";

        const body: any = {
          name: editProject.name,
          status: nextStatus,
          addressLine1: editProject.addressLine1,
          addressLine2: editProject.addressLine2,
          city: editProject.city,
          state: editProject.state,
          primaryContactName: editProject.primaryContactName,
          primaryContactEmail: editProject.primaryContactEmail,
          primaryContactPhone: editProject.primaryContactPhone,
        };
        const res = await fetch(`${API_BASE}/projects/${project.id}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          setEditProjectMessage(`Failed to save project (${res.status}).`);
          return;
        }
        const updated = (await res.json()) as Project;
        setProject(updated);
        setEditProjectMode(false);
        setEditProjectMessage("Project updated.");
      });
    } catch (err: any) {
      setEditProjectMessage(err?.message ?? "Error saving project.");
    } finally {
      setEditProjectSaving(false);
    }
  };

  // No separate deactivate/delete functions anymore; state is controlled via
  // the Project state toggle + status field and saved in saveEditProject.

  return (
    <div
      className="app-card"
      style={
        invoiceFullscreen
          ? {
              // Cancel app shell padding so the invoice can use the full viewport.
              margin: "-12px -20px -24px",
              borderRadius: 0,
              padding: 12,
              maxHeight: "none",
            }
          : undefined
      }
    >
      {/* GALLERY MODAL - INLINE TEST */}
      {attachmentsViewer.open && attachmentsViewer.log && (() => {
        const log = attachmentsViewer.log;
        const attachments = log.attachments || [];
        const currentIndex = attachmentsViewer.currentIndex;
        const currentAttachment = attachments[currentIndex];
        
        // Helper to detect image by mimeType OR file extension
        const isImageFile = (att: { mimeType?: string | null; fileUrl?: string; fileName?: string | null }) => {
          if (att.mimeType?.startsWith("image/")) return true;
          const url = att.fileUrl || att.fileName || "";
          const ext = url.split(".").pop()?.toLowerCase() || "";
          return ["jpg", "jpeg", "png", "gif", "webp", "bmp", "svg", "heic", "heif"].includes(ext);
        };
        
        // Touch/swipe state tracking
        let touchStartX = 0;
        let touchStartY = 0;
        let initialPinchDistance = 0;
        let currentScale = 1;
        
        const handleTouchStart = (e: React.TouchEvent) => {
          if (e.touches.length === 1) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
          } else if (e.touches.length === 2) {
            // Pinch start
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            initialPinchDistance = Math.sqrt(dx * dx + dy * dy);
          }
        };
        
        const handleTouchMove = (e: React.TouchEvent) => {
          if (e.touches.length === 2 && initialPinchDistance > 0) {
            // Pinch zoom
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const scale = Math.max(0.5, Math.min(4, distance / initialPinchDistance * currentScale));
            const img = document.getElementById("gallery-main-image") as HTMLImageElement;
            if (img) {
              img.style.transform = `scale(${scale})`;
            }
          }
        };
        
        const handleTouchEnd = (e: React.TouchEvent) => {
          if (e.changedTouches.length === 1 && initialPinchDistance === 0) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // Only trigger swipe if horizontal movement > 50px and greater than vertical
            if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
              if (deltaX > 0 && attachments.length > 1) {
                goToPrevAttachment();
              } else if (deltaX < 0 && attachments.length > 1) {
                goToNextAttachment();
              }
            }
          }
          // Reset pinch tracking
          initialPinchDistance = 0;
        };
        
        const resetZoom = () => {
          currentScale = 1;
          const img = document.getElementById("gallery-main-image") as HTMLImageElement;
          if (img) {
            img.style.transform = "scale(1)";
          }
        };
        
        return (
          <div
            id="gallery-modal-inline"
            style={{
              position: "fixed",
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              width: "100vw",
              height: "100vh",
              backgroundColor: "rgba(0, 0, 0, 0.95)",
              zIndex: 2147483647,
              display: "flex",
              flexDirection: "column",
              alignItems: "center",
              justifyContent: "center",
              touchAction: "none", // Prevent browser handling of touch
            }}
            onClick={() => setAttachmentsViewer({ open: false, log: null, currentIndex: 0 })}
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
          >
            {/* Close button - larger for mobile */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                setAttachmentsViewer({ open: false, log: null, currentIndex: 0 });
              }}
              style={{
                position: "absolute",
                top: 16,
                right: 16,
                background: "white",
                border: "none",
                borderRadius: "50%",
                width: 48,
                height: 48,
                minWidth: 48,
                minHeight: 48,
                fontSize: 28,
                cursor: "pointer",
                zIndex: 2147483647,
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                boxShadow: "0 2px 8px rgba(0,0,0,0.3)",
              }}
            >
              ×
            </button>
            
            {/* Reset zoom button (shows when zoomed) */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                resetZoom();
              }}
              style={{
                position: "absolute",
                top: 16,
                left: 16,
                background: "white",
                border: "none",
                borderRadius: 8,
                padding: "8px 12px",
                fontSize: 14,
                cursor: "pointer",
                zIndex: 2147483647,
                boxShadow: "0 2px 8px rgba(0,0,0,0.3)",
              }}
            >
              Reset Zoom
            </button>
            
            {/* Title */}
            <div style={{ color: "white", fontSize: 16, marginBottom: 12, padding: "0 60px", textAlign: "center" }}>
              {attachments.length > 1 ? `${currentIndex + 1} of ${attachments.length}` : "Attachment"}
            </div>
            
            {/* Swipe hint for mobile */}
            {attachments.length > 1 && (
              <div style={{ color: "rgba(255,255,255,0.5)", fontSize: 12, marginBottom: 8 }}>
                Swipe to navigate • Pinch to zoom
              </div>
            )}
            
            {/* Main content area */}
            <div
              style={{
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                gap: 12,
                maxWidth: "95vw",
                maxHeight: "65vh",
                flex: 1,
                width: "100%",
              }}
              onClick={(e) => e.stopPropagation()}
            >
              {/* Left arrow - larger touch target, hidden on very small screens */}
              {attachments.length > 1 && (
                <button
                  onClick={() => goToPrevAttachment()}
                  style={{
                    background: "rgba(255,255,255,0.9)",
                    border: "none",
                    borderRadius: "50%",
                    width: 56,
                    height: 56,
                    minWidth: 56,
                    minHeight: 56,
                    fontSize: 28,
                    cursor: "pointer",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    boxShadow: "0 2px 8px rgba(0,0,0,0.3)",
                    flexShrink: 0,
                  }}
                  aria-label="Previous"
                >
                  ‹
                </button>
              )}
              
              {/* Image/file display */}
              {currentAttachment && (
                <div style={{ textAlign: "center", overflow: "hidden", maxWidth: "80vw", maxHeight: "60vh" }}>
                  {isImageFile(currentAttachment) ? (
                    <img
                      id="gallery-main-image"
                      src={currentAttachment.fileUrl}
                      alt={currentAttachment.fileName || "Attachment"}
                      style={{
                        maxWidth: "80vw",
                        maxHeight: "60vh",
                        objectFit: "contain",
                        borderRadius: 8,
                        transition: "transform 0.1s ease-out",
                        transformOrigin: "center center",
                      }}
                      onDoubleClick={(e) => {
                        e.stopPropagation();
                        const img = e.currentTarget;
                        if (currentScale === 1) {
                          currentScale = 2;
                          img.style.transform = "scale(2)";
                        } else {
                          currentScale = 1;
                          img.style.transform = "scale(1)";
                        }
                      }}
                    />
                  ) : (
                    <div
                      style={{
                        padding: 32,
                        background: "white",
                        borderRadius: 8,
                        textAlign: "center",
                        maxWidth: "80vw",
                      }}
                    >
                      <div style={{ fontSize: 48, marginBottom: 10 }}>📄</div>
                      <div style={{ fontWeight: 600, wordBreak: "break-word" }}>{currentAttachment.fileName}</div>
                      <a
                        href={currentAttachment.fileUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{
                          display: "inline-block",
                          marginTop: 12,
                          padding: "12px 24px",
                          background: "#2563eb",
                          color: "white",
                          borderRadius: 6,
                          textDecoration: "none",
                          fontSize: 16,
                          fontWeight: 500,
                        }}
                      >
                        Open File
                      </a>
                    </div>
                  )}
                </div>
              )}
              
              {/* Right arrow - larger touch target */}
              {attachments.length > 1 && (
                <button
                  onClick={() => goToNextAttachment()}
                  style={{
                    background: "rgba(255,255,255,0.9)",
                    border: "none",
                    borderRadius: "50%",
                    width: 56,
                    height: 56,
                    minWidth: 56,
                    minHeight: 56,
                    fontSize: 28,
                    cursor: "pointer",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    boxShadow: "0 2px 8px rgba(0,0,0,0.3)",
                    flexShrink: 0,
                  }}
                  aria-label="Next"
                >
                  ›
                </button>
              )}
            </div>
            
            {/* Thumbnail strip - scrollable on mobile */}
            {attachments.length > 1 && (
              <div
                style={{
                  display: "flex",
                  gap: 8,
                  marginTop: 16,
                  padding: 12,
                  background: "rgba(255,255,255,0.1)",
                  borderRadius: 8,
                  overflowX: "auto",
                  maxWidth: "90vw",
                  WebkitOverflowScrolling: "touch",
                }}
                onClick={(e) => e.stopPropagation()}
              >
                {attachments.map((att: any, idx: number) => (
                  <button
                    key={att.id}
                    onClick={() => {
                      resetZoom();
                      setAttachmentsViewer(prev => ({ ...prev, currentIndex: idx }));
                    }}
                    style={{
                      width: 56,
                      height: 56,
                      minWidth: 56,
                      minHeight: 56,
                      border: idx === currentIndex ? "3px solid #2563eb" : "2px solid transparent",
                      borderRadius: 6,
                      padding: 0,
                      cursor: "pointer",
                      overflow: "hidden",
                      background: "white",
                      flexShrink: 0,
                    }}
                  >
                    {isImageFile(att) ? (
                      <img
                        src={att.fileUrl}
                        alt=""
                        style={{ width: "100%", height: "100%", objectFit: "cover" }}
                      />
                    ) : (
                      <div style={{ fontSize: 24, lineHeight: "56px" }}>📄</div>
                    )}
                  </button>
                ))}
              </div>
            )}
          </div>
        );
      })()}
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "flex-start",
          gap: 12,
        }}
      >
        <div>
          {!editProjectMode && (
            <>
              <div style={{ display: "flex", alignItems: "baseline", gap: 8 }}>
                <button
                  type="button"
                  onClick={() => setShowPid(true)}
                  style={{
                    margin: 0,
                    padding: 0,
                    border: "none",
                    background: "transparent",
                    fontSize: 20,
                    fontWeight: 600,
                    color: "#111827",
                    cursor: "pointer",
                    textAlign: "left",
                  }}
                >
                  {project.name}
                </button>
                {showPid && (
                  <span style={{ fontSize: 11, color: "#9ca3af" }}>
                    PID: {project.id}
                  </span>
                )}
              </div>
              <RoleVisible minRole="CREW">
                <p style={{ fontSize: 13, color: "#6b7280", marginTop: 4 }}>
                  Status: {project.status}
                </p>
              </RoleVisible>
              {actorDisplayName && (
                <RoleVisible minRole="PM">
                  <p style={{ fontSize: 11, color: "#6b7280", marginTop: 2 }}>
                    You are logged in as {actorDisplayName}
                    {actorProjectRoles && actorProjectRoles.length > 0 && (
                      <>
                        {" "}· Project role(s): {actorProjectRoles.join(", ")}
                      </>
                    )}
                  </p>
                </RoleVisible>
              )}
              <RoleVisible minRole="FOREMAN">
                <p style={{ fontSize: 13, marginTop: 8 }}>
                  {projectMapsUrl && projectAddress ? (
                    <a
                      href={projectMapsUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{ color: "#2563eb", textDecoration: "none" }}
                    >
                      {projectAddress}
                    </a>
                  ) : (
                    <>
                      {project.addressLine1}
                      {project.addressLine2 ? `, ${project.addressLine2}` : ""}
                      <br />
                      {project.city}, {project.state}
                    </>
                  )}
                </p>
              </RoleVisible>
            </>
          )}

          {editProjectMode && editProject && (
            <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
              <div>
                <label style={{ display: "block", fontSize: 12, fontWeight: 600 }}>
                  Job name
                </label>
                <input
                  value={editProject.name}
                  onChange={e =>
                    setEditProject(prev =>
                      prev ? { ...prev, name: e.target.value } : prev,
                    )
                  }
                  style={{
                    width: "100%",
                    padding: "4px 6px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    fontSize: 13,
                  }}
                />
              </div>
              <div>
                <label style={{ display: "block", fontSize: 12, fontWeight: 600 }}>
                  Status
                </label>
                <input
                  value={editProject.status}
                  onChange={e =>
                    setEditProject(prev =>
                      prev ? { ...prev, status: e.target.value } : prev,
                    )
                  }
                  style={{
                    width: "100%",
                    padding: "4px 6px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    fontSize: 13,
                  }}
                />
              </div>
              <div
                style={{
                  display: "flex",
                  flexWrap: "wrap",
                  gap: 6,
                  alignItems: "flex-start",
                }}
              >
                <div style={{ flex: "1 1 220px", minWidth: 200 }}>
                  <label
                    style={{ display: "block", fontSize: 12, fontWeight: 600 }}
                  >
                    Address line 1
                  </label>
                  <input
                    value={editProject.addressLine1}
                    onChange={e =>
                      setEditProject(prev =>
                        prev
                          ? { ...prev, addressLine1: e.target.value }
                          : prev,
                      )
                    }
                    style={{
                      width: "100%",
                      padding: "4px 6px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 13,
                    }}
                  />
                </div>
                <div style={{ flex: "1 1 180px", minWidth: 180 }}>
                  <label
                    style={{ display: "block", fontSize: 12, fontWeight: 600 }}
                  >
                    Address line 2
                  </label>
                  <input
                    value={editProject.addressLine2 ?? ""}
                    onChange={e =>
                      setEditProject(prev =>
                        prev
                          ? { ...prev, addressLine2: e.target.value || null }
                          : prev,
                      )
                    }
                    style={{
                      width: "100%",
                      padding: "4px 6px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 13,
                    }}
                  />
                </div>
                <div style={{ flex: "0 0 160px", minWidth: 140 }}>
                  <label
                    style={{ display: "block", fontSize: 12, fontWeight: 600 }}
                  >
                    City
                  </label>
                  <input
                    value={editProject.city}
                    onChange={e =>
                      setEditProject(prev =>
                        prev ? { ...prev, city: e.target.value } : prev,
                      )
                    }
                    style={{
                      width: "100%",
                      padding: "4px 6px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 13,
                    }}
                  />
                </div>
                <div style={{ flex: "0 0 80px" }}>
                  <label
                    style={{ display: "block", fontSize: 12, fontWeight: 600 }}
                  >
                    State
                  </label>
                  <input
                    value={editProject.state}
                    onChange={e =>
                      setEditProject(prev =>
                        prev ? { ...prev, state: e.target.value } : prev,
                      )
                    }
                    style={{
                      width: "100%",
                      padding: "4px 6px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 13,
                    }}
                  />
                </div>
              </div>

              {/* Client Contact Section */}
              <div
                style={{
                  marginTop: 12,
                  paddingTop: 10,
                  borderTop: "1px solid #e5e7eb",
                }}
              >
                <div style={{ marginBottom: 6 }}>
                  <label style={{ fontSize: 12, fontWeight: 600 }}>
                    Client Contact (for invoices & correspondence)
                  </label>
                  <div style={{ fontSize: 10, color: "#6b7280", marginTop: 2 }}>
                    Start typing to search existing clients
                  </div>
                </div>

                {selectedTenantClient ? (
                  <div>
                    {selectedTenantClient ? (
                      <div
                        style={{
                          padding: 10,
                          borderRadius: 6,
                          border: "1px solid #10b981",
                          background: "#ecfdf5",
                          marginBottom: 8,
                        }}
                      >
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                          <div>
                            <div style={{ fontWeight: 600, fontSize: 13, color: "#065f46" }}>
                              {selectedTenantClient.displayName || `${selectedTenantClient.firstName} ${selectedTenantClient.lastName}`}
                            </div>
                            {selectedTenantClient.email && (
                              <div style={{ fontSize: 12, color: "#047857" }}>{selectedTenantClient.email}</div>
                            )}
                            {selectedTenantClient.phone && (
                              <div style={{ fontSize: 12, color: "#047857" }}>{selectedTenantClient.phone}</div>
                            )}
                            {selectedTenantClient.company && (
                              <div style={{ fontSize: 11, color: "#6b7280", marginTop: 2 }}>
                                {selectedTenantClient.company}
                              </div>
                            )}
                            {selectedTenantClient.projectCount != null && selectedTenantClient.projectCount > 0 && (
                              <div style={{ fontSize: 10, color: "#065f46", marginTop: 4 }}>
                                Linked to {selectedTenantClient.projectCount} other project(s)
                              </div>
                            )}
                          </div>
                          <button
                            type="button"
                            onClick={handleClearTenantClientLink}
                            style={{
                              padding: "2px 8px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              background: "#fff",
                              fontSize: 11,
                              cursor: "pointer",
                            }}
                          >
                            Clear
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div style={{ position: "relative", marginBottom: 8 }}>
                        <input
                          type="text"
                          value={clientSearchQuery}
                          onChange={e => {
                            setClientSearchQuery(e.target.value);
                            searchTenantClients(e.target.value);
                          }}
                          placeholder="Search by name, email, or phone..."
                          style={{
                            width: "100%",
                            padding: "6px 8px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 13,
                          }}
                        />
                        {clientSearching && (
                          <div style={{ position: "absolute", right: 8, top: 8, fontSize: 11, color: "#9ca3af" }}>
                            Searching...
                          </div>
                        )}
                        {clientSearchResults.length > 0 && (
                          <div
                            style={{
                              position: "absolute",
                              top: "100%",
                              left: 0,
                              right: 0,
                              zIndex: 10,
                              background: "#fff",
                              border: "1px solid #d1d5db",
                              borderRadius: 6,
                              boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
                              maxHeight: 240,
                              overflowY: "auto",
                            }}
                          >
                            {clientSearchResults.map(client => (
                              <div
                                key={client.id}
                                onClick={() => handleSelectTenantClient(client)}
                                style={{
                                  padding: "8px 10px",
                                  cursor: "pointer",
                                  borderBottom: "1px solid #f3f4f6",
                                }}
                                onMouseEnter={e => (e.currentTarget.style.background = "#f9fafb")}
                                onMouseLeave={e => (e.currentTarget.style.background = "transparent")}
                              >
                                <div style={{ fontSize: 13, fontWeight: 500 }}>
                                  {client.displayName || `${client.firstName} ${client.lastName}`}
                                </div>
                                {client.email && (
                                  <div style={{ fontSize: 11, color: "#6b7280" }}>{client.email}</div>
                                )}
                                {client.phone && (
                                  <div style={{ fontSize: 11, color: "#6b7280" }}>{client.phone}</div>
                                )}
                                {client.projectCount != null && client.projectCount > 0 && (
                                  <div style={{ fontSize: 10, color: "#2563eb", marginTop: 2 }}>
                                    {client.projectCount} project(s)
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                        {clientSearchQuery.length >= 2 && clientSearchResults.length === 0 && !clientSearching && (
                          <div style={{ fontSize: 11, color: "#9ca3af", marginTop: 4 }}>
                            No clients found. Uncheck to enter new contact info manually.
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                ) : (
                  <div
                    style={{
                      display: "flex",
                      flexWrap: "wrap",
                      gap: 6,
                      alignItems: "flex-start",
                    }}
                  >
                    <div style={{ flex: "1 1 200px", minWidth: 180, position: "relative" }}>
                      <label style={{ display: "block", fontSize: 12, fontWeight: 600 }}>
                        Client Name
                      </label>
                      <div style={{ position: "relative" }}>
                        <input
                          value={editProject.primaryContactName ?? ""}
                          onChange={e => {
                            const val = e.target.value;
                            setEditProject(prev =>
                              prev
                                ? { ...prev, primaryContactName: val || null }
                                : prev,
                            );
                            // Debounced search as user types
                            if (clientNameSearchTimeoutRef.current) clearTimeout(clientNameSearchTimeoutRef.current);
                            clientNameSearchTimeoutRef.current = setTimeout(() => {
                              searchTenantClients(val);
                            }, 300);
                          }}
                          onBlur={() => {
                            // Delay to allow click on search result
                            setTimeout(() => setClientSearchResults([]), 200);
                          }}
                          placeholder="Start typing to search..."
                          style={{
                            width: "100%",
                            padding: "4px 6px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 13,
                          }}
                        />
                        {clientSearching && (
                          <div style={{ position: "absolute", right: 8, top: 6, fontSize: 10, color: "#9ca3af" }}>...</div>
                        )}
                        {clientSearchResults.length > 0 && (editProject.primaryContactName?.length ?? 0) >= 2 && (
                          <div
                            style={{
                              position: "absolute",
                              top: "100%",
                              left: 0,
                              right: 0,
                              zIndex: 100,
                              background: "#fff",
                              border: "1px solid #d1d5db",
                              borderRadius: 6,
                              boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
                              maxHeight: 200,
                              overflowY: "auto",
                            }}
                          >
                            <div style={{ padding: "4px 8px", fontSize: 10, color: "#6b7280", borderBottom: "1px solid #e5e7eb" }}>
                              Select to auto-fill all fields
                            </div>
                            {clientSearchResults.map(client => (
                              <div
                                key={client.id}
                                onMouseDown={(e) => {
                                  e.preventDefault();
                                  handleSelectTenantClient(client);
                                }}
                                style={{
                                  padding: "8px 10px",
                                  cursor: "pointer",
                                  borderBottom: "1px solid #f3f4f6",
                                }}
                                onMouseEnter={e => (e.currentTarget.style.background = "#f9fafb")}
                                onMouseLeave={e => (e.currentTarget.style.background = "transparent")}
                              >
                                <div style={{ fontSize: 13, fontWeight: 500 }}>
                                  {client.displayName || `${client.firstName} ${client.lastName}`}
                                </div>
                                {client.email && (
                                  <div style={{ fontSize: 11, color: "#6b7280" }}>{client.email}</div>
                                )}
                                {client.phone && (
                                  <div style={{ fontSize: 11, color: "#6b7280" }}>{client.phone}</div>
                                )}
                                {client.projectCount != null && client.projectCount > 0 && (
                                  <div style={{ fontSize: 10, color: "#2563eb", marginTop: 2 }}>
                                    {client.projectCount} project(s)
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                    <div style={{ flex: "1 1 200px", minWidth: 180 }}>
                      <label style={{ display: "block", fontSize: 12, fontWeight: 600 }}>
                        Email
                      </label>
                      <input
                        type="email"
                        value={editProject.primaryContactEmail ?? ""}
                        onChange={e =>
                          setEditProject(prev =>
                            prev
                              ? { ...prev, primaryContactEmail: e.target.value || null }
                              : prev,
                          )
                        }
                        placeholder="email@example.com"
                        style={{
                          width: "100%",
                          padding: "4px 6px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 13,
                        }}
                      />
                    </div>
                    <div style={{ flex: "0 0 160px", minWidth: 140 }}>
                      <label style={{ display: "block", fontSize: 12, fontWeight: 600 }}>
                        Phone
                      </label>
                      <input
                        type="tel"
                        value={editProject.primaryContactPhone ?? ""}
                        onChange={e =>
                          setEditProject(prev =>
                            prev
                              ? { ...prev, primaryContactPhone: e.target.value || null }
                              : prev,
                          )
                        }
                        placeholder="(555) 123-4567"
                        style={{
                          width: "100%",
                          padding: "4px 6px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 13,
                        }}
                      />
                    </div>
                  </div>
                )}
              </div>

              {/* Project state toggle (Open / Archived / Deleted / Warranty) */}
              <div style={{ marginTop: 8 }}>
                <label style={{ display: "block", fontSize: 12, fontWeight: 600 }}>
                  Project state
                </label>
                <div
                  style={{
                    display: "flex",
                    flexWrap: "wrap",
                    gap: 6,
                    marginTop: 4,
                  }}
                >
                  {(
                    [
                      { key: "OPEN", label: "Open" },
                      { key: "ARCHIVED", label: "Archived" },
                      { key: "DELETED", label: "Deleted" },
                      { key: "WARRANTY", label: "Warranty" },
                    ] as { key: ProjectStateChoice; label: string }[]
                  ).map(option => {
                    const isSelected = editProjectState === option.key;
                    return (
                      <button
                        key={option.key}
                        type="button"
                        onClick={() => setEditProjectState(option.key)}
                        style={{
                          padding: "3px 10px",
                          borderRadius: 999,
                          border: isSelected
                            ? "1px solid #0f172a"
                            : "1px solid #d1d5db",
                          backgroundColor: isSelected ? "#0f172a" : "#ffffff",
                          color: isSelected ? "#f9fafb" : "#374151",
                          fontSize: 11,
                          cursor: "pointer",
                        }}
                      >
                        {option.label}
                      </button>
                    );
                  })}

                  <button
                    type="button"
                    onClick={() => {
                      setPetlShowDiagnostics(true);
                      setPetlDiagnosticsModalOpen(true);
                    }}
                    style={{
                      padding: "3px 10px",
                      borderRadius: 999,
                      border: "1px solid #d1d5db",
                      backgroundColor: "#ffffff",
                      color: "#374151",
                      fontSize: 11,
                      cursor: "pointer",
                    }}
                  >
                    PETL Diagnostics
                  </button>

                  {project && (
                    <AdminPetlTools
                      projectId={project.id}
                      isAdminOrAbove={isAdminOrAbove}
                      onDeleted={handlePetlWipeSuccess}
                    />
                  )}
                </div>
                <p style={{ marginTop: 4, fontSize: 11, color: "#6b7280" }}>
                  This state is saved directly on the project (status field) and used
                  for filtering in the projects list.
                </p>
              </div>
            </div>
          )}
        </div>

        {/* Client Contact Info - Always visible, inline editable with auto-search for Admin+ */}
        {!editProjectMode && (
          <RoleVisible minRole="FOREMAN">
            <div
              style={{
                flex: "1 1 auto",
                maxWidth: 320,
                minWidth: 200,
                marginLeft: 24,
                padding: "8px 12px",
                backgroundColor: "#f9fafb",
                borderRadius: 6,
                border: "1px solid #e5e7eb",
              }}
            >
              <div style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", marginBottom: 6 }}>
                Client Contact
              </div>
              <ClientContactSection
                projectId={project.id}
                name={project.primaryContactName || null}
                email={project.primaryContactEmail || null}
                phone={project.primaryContactPhone || null}
                canEdit={isAdminOrAbove}
                onUpdate={async (fields) => {
                  const token = localStorage.getItem("accessToken");
                  if (!token) return;
                  const body: Record<string, string | null> = {};
                  if ("name" in fields) body.primaryContactName = fields.name ?? null;
                  if ("email" in fields) body.primaryContactEmail = fields.email ?? null;
                  if ("phone" in fields) body.primaryContactPhone = fields.phone ?? null;
                  const res = await fetch(`${API_BASE}/projects/${project.id}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                    body: JSON.stringify(body),
                  });
                  if (res.ok) {
                    const updated = await res.json();
                    setProject(updated);
                  }
                }}
              />
            </div>
          </RoleVisible>
        )}

        {canEditProjectHeader && (
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              alignItems: "flex-end",
              gap: 6,
            }}
          >
            {!editProjectMode && (
              <RoleVisible minRole="ADMIN">
                <button
                  type="button"
                  onClick={beginEditProject}
                  style={{
                    padding: "4px 10px",
                    borderRadius: 999,
                    border: "1px solid #0f172a",
                    background: "#0f172a",
                    color: "#f9fafb",
                    fontSize: 12,
                    cursor: "pointer",
                  }}
                >
                  Edit project
                </button>
              </RoleVisible>
            )}
            {editProjectMode && (
              <div style={{ display: "flex", gap: 8 }}>
                <button
                  type="button"
                  onClick={saveEditProject}
                  disabled={editProjectSaving}
                  style={{
                    padding: "4px 10px",
                    borderRadius: 999,
                    border: "1px solid #0f172a",
                    background: editProjectSaving ? "#e5e7eb" : "#0f172a",
                    color: editProjectSaving ? "#4b5563" : "#f9fafb",
                    fontSize: 12,
                    cursor: editProjectSaving ? "default" : "pointer",
                  }}
                >
                  {editProjectSaving ? "Saving…" : "Save"}
                </button>
                <button
                  type="button"
                  onClick={cancelEditProject}
                  disabled={editProjectSaving}
                  style={{
                    padding: "4px 10px",
                    borderRadius: 999,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    color: "#374151",
                    fontSize: 12,
                    cursor: editProjectSaving ? "default" : "pointer",
                  }}
                >
                  Cancel
                </button>
              </div>
            )}
            {editProjectMessage && (
              <p
                style={{
                  margin: 0,
                  fontSize: 11,
                  color: editProjectMessage.toLowerCase().includes("fail")
                    ? "#b91c1c"
                    : "#16a34a",
                }}
              >
                {editProjectMessage}
              </p>
            )}
          </div>
        )}
      </div>

      <p style={{ fontSize: 12, color: "#9ca3af", marginTop: 8 }}>
        Created: {new Date(project.createdAt).toLocaleString()}
      </p>

      {petlItemCount !== null && (
        <p style={{ fontSize: 13, color: "#6b7280", marginTop: 8 }}>
          Latest estimate: {petlItemCount} items,
          {" "}
          {petlTotalAmount !== null
            ? `$${petlTotalAmount.toLocaleString(undefined, {
                maximumFractionDigits: 2,
              })}`
            : "total N/A"}
        </p>
      )}

      {/* Baseline reminder / components reminder */}
      {petlItemCount === 0 && (
        <div
          style={{
            marginTop: 12,
            padding: 12,
            borderRadius: 8,
            border: "1px solid #0f172a",
            background: "#fef9c3",
            fontSize: 12,
            color: "#0f172a",
          }}
        >
          <div style={{ fontWeight: 600, marginBottom: 4 }}>
            Estimate baseline not created yet
          </div>
          <p style={{ margin: 0, marginBottom: 8 }}>
            This project doesn&apos;t yet have an estimate baseline. You can either
            import Xactimate CSV exports or build a PETL baseline directly from
            your tenant Cost Book.
          </p>

          <div style={{ marginBottom: 8 }}>
            <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>
              Final material location (optional)
            </div>
            <input
              value={petlBaselineLocation}
              onChange={(e) => setPetlBaselineLocation(e.target.value)}
              placeholder="e.g. Main yard – 1234 Logistics Way"
              style={{
                width: "100%",
                maxWidth: 420,
                padding: "4px 6px",
                borderRadius: 4,
                border: "1px solid #d1d5db",
                fontSize: 12,
              }}
            />
          </div>

          <div
            style={{
              display: "flex",
              flexWrap: "wrap",
              gap: 8,
            }}
          >
            <button
              type="button"
              onClick={() => {
                if (typeof window !== "undefined") {
                  window.location.href = `/projects/import?projectId=${project.id}`;
                }
              }}
              style={{
                padding: "6px 10px",
                borderRadius: 4,
                border: "1px solid #0f172a",
                backgroundColor: "#0f172a",
                color: "#f9fafb",
                fontSize: 12,
                cursor: "pointer",
                whiteSpace: "nowrap",
              }}
            >
              Import Xactimate CSVs
            </button>

            {isPmOrAbove && (
              <button
                type="button"
                onClick={() => {
                  petlTransitionOverlayLabelRef.current = "Opening cost book…";
                  busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
                  startPetlTransition(() => setPetlBaselineCostBookPickerOpen(true));
                }}
                style={{
                  padding: "6px 10px",
                  borderRadius: 4,
                  border: "1px solid #2563eb",
                  backgroundColor: "#eff6ff",
                  color: "#1d4ed8",
                  fontSize: 12,
                  cursor: "pointer",
                  whiteSpace: "nowrap",
                }}
              >
                Build PETL from Cost Book
              </button>
            )}
          </div>

          {petlBaselineMessage && (
            <div style={{ marginTop: 6, fontSize: 11, color: "#4b5563" }}>
              {petlBaselineMessage}
            </div>
          )}
        </div>
      )}

      {petlBaselineCostBookPickerOpen && (
        <CostBookPickerModal
          title="Tenant Cost Book"
          subtitle={
            petlBaselineLocation.trim()
              ? `Build PETL from Cost Book – Location: ${petlBaselineLocation.trim()}`
              : "Build PETL from Cost Book"
          }
          confirmLabel={
            petlBaselineCostBookPickerBusy ? "Adding…" : "Add selected to PETL"
          }
          confirmDisabled={petlBaselineCostBookPickerBusy}
          onConfirm={submitBaselinePetlFromCostBook}
          onClose={() => {
            if (petlBaselineCostBookPickerBusy) return;
            petlTransitionOverlayLabelRef.current = "Closing cost book…";
            busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
            startPetlTransition(() => setPetlBaselineCostBookPickerOpen(false));
          }}
        />
      )}

      {petlItemCount !== null && petlItemCount > 0 && componentsCount === 0 && (
        <div
          style={{
            marginTop: 8,
            padding: 10,
            borderRadius: 6,
            border: "1px solid #0f172a",
            background: "#fef9c3",
            fontSize: 11,
            color: "#0f172a",
          }}
        >
          <span style={{ fontWeight: 600 }}>Heads up:</span> line items are
          imported, but components CSV hasn&apos;t been imported yet. When you&apos;re
          ready, upload the components CSV from the Import screen so we can
          break each task into detailed materials, labor, and equipment.
        </div>
      )}

      {/* Tab strip for project detail sections */}
      <div
        style={{
          marginTop: 16,
          borderBottom: "1px solid #e5e7eb",
          display: "flex",
          gap: 8,
        }}
      >
      {(
          [
            { key: "SUMMARY", label: "Job parameters" },
            { key: "DAILY_LOGS", label: "Daily Logs" },
            { key: "SCHEDULE", label: "Schedule" },
            { key: "PETL", label: "PETL" },
            { key: "BOM", label: "BOM" },
            { key: "STRUCTURE", label: "Project Organization" },
            ...(isAdminOrAbove ? [{ key: "JOURNAL" as TabKey, label: "Journal" }] : []),
            { key: "FINANCIAL", label: "Financial" },
            { key: "FILES", label: "Files" },
          ] as { key: TabKey; label: string }[]
        ).map(tab => (
          <button
            key={tab.key}
            type="button"
            onClick={() => {
              // PETL is heavy: update underline instantly, then transition the content
              // switch (unmounting previous tab + mounting PETL shell) on the next frame.
              if (tab.key === "PETL") {
                setPetlTabMounted(false);
                setTab("PETL", { deferContentSwitch: true });
                return;
              }

              setTab(tab.key);
            }}
            style={{
              border: "none",
              borderBottom:
                activeTabUi === tab.key
                  ? "2px solid #2563eb"
                  : "2px solid transparent",
              padding: "6px 8px",
              background: "transparent",
              cursor: "pointer",
              fontSize: 13,
              color: activeTabUi === tab.key ? "#111827" : "#6b7280",
              fontWeight: activeTabUi === tab.key ? 600 : 400,
            }}
          >
            {tab.label}
          </button>
        ))}
      </div>

      {activeTabUi === "PETL" && activeTab !== "PETL" && (
        <div style={{ marginTop: 8, fontSize: 12, color: "#6b7280" }}>Opening PETL…</div>
      )}

      {/* Three-column summary: Left (Filtered Selection), Center (CSI Project Totals), Right (Filtered Reconciliation) */}
      {(overallSummary || selectionSummary || petlReconciliationEntries.length > 0) && (
        <div style={{ 
          display: "flex", 
          gap: 16, 
          fontSize: 12, 
          color: "#4b5563", 
          marginTop: 8,
          flexWrap: "wrap",
          width: "100%"
        }}>
          {/* LEFT COLUMN: Filtered selection summary */}
          <div style={{ flex: "1 1 0", minWidth: 200 }}>
            {selectionSummary && (
              <>
                <div style={{ fontWeight: 600, marginBottom: 4, color: "#111827" }}>
                  {roomParticleIdFilters.length ||
                  categoryCodeFilters.length ||
                  selectionCodeFilters.length
                    ? "Filtered Selection"
                    : "All Items"}
                </div>
                <div style={{ fontSize: 11, lineHeight: 1.5 }}>
                  <RoleVisible minRole="CLIENT">
                    <div>Progress: {selectionSummary.percentComplete.toFixed(2)}%</div>
                  </RoleVisible>
                  {selectionSummary.totalAmount > 0 && (
                    <RoleVisible minRole="SUPER">
                      <div>
                        Total: $
                        {selectionSummary.totalAmount.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}
                      </div>
                    </RoleVisible>
                  )}
                  {selectionSummary.completedAmount > 0 && (
                    <RoleVisible minRole="SUPER">
                      <div>
                        Completed: $
                        {selectionSummary.completedAmount.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}
                      </div>
                    </RoleVisible>
                  )}
                </div>
              </>
            )}
          </div>

          {/* CENTER COLUMN: Critical Success Indicators (CSI) - Project totals */}
          <div style={{ flex: "1 1 0", minWidth: 280, paddingLeft: 16, borderLeft: "2px solid #e5e7eb" }}>
            <div style={{ fontWeight: 600, marginBottom: 4, color: "#111827" }}>Critical Success Indicators</div>
            <div style={{ fontSize: 11, lineHeight: 1.5 }}>
              {overallSummary && (
                <>
                  <RoleVisible minRole="CLIENT">
                    <div>Overall Progress: {overallSummary.percentComplete.toFixed(2)}%</div>
                  </RoleVisible>
                  {overallSummary.totalAmount > 0 && (
                    <RoleVisible minRole="SUPER">
                      <div>
                        Contract Value: ${overallSummary.totalAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                      </div>
                    </RoleVisible>
                  )}
                </>
              )}
              {(() => {
                // Calculate PROJECT-LEVEL reconciliation totals (all entries, no filters)
                let projectSupplementTotal = 0;
                let projectChangeOrderTotal = 0;
                let projectAcvRebateTotal = 0;

                for (const entry of petlReconciliationEntries) {
                  const qty = typeof entry.qty === "number" ? entry.qty : 0;
                  const unitCost = typeof entry.unitCost === "number" ? entry.unitCost : 0;
                  const percent = typeof entry.percentComplete === "number" ? entry.percentComplete : 0;
                  const lineTotal = qty * unitCost;
                  const completedAmount = (lineTotal * percent) / 100;

                  if (entry.tag === "SUPPLEMENT") {
                    if (entry.kind === "CREDIT") {
                      projectAcvRebateTotal += completedAmount;
                    } else {
                      projectSupplementTotal += completedAmount;
                    }
                  } else if (entry.tag === "CHANGE_ORDER") {
                    if (entry.kind === "CREDIT") {
                      projectAcvRebateTotal += completedAmount;
                    } else {
                      projectChangeOrderTotal += completedAmount;
                    }
                  }
                }

                return (
                  <>
                    <RoleVisible minRole="SUPER">
                      <div>
                        Supplements: $
                        {projectSupplementTotal.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}
                      </div>
                    </RoleVisible>
                    <RoleVisible minRole="SUPER">
                      <div>
                        Change Orders: $
                        {projectChangeOrderTotal.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}
                      </div>
                    </RoleVisible>
                    <RoleVisible minRole="SUPER">
                      <div>
                        ACV Rebate: $
                        {projectAcvRebateTotal.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}
                      </div>
                    </RoleVisible>
                  </>
                );
              })()}
            </div>
          </div>

          {/* RIGHT COLUMN: Filtered reconciliation activity */}
          <div style={{ flex: "1 1 0", minWidth: 200, paddingLeft: 16, borderLeft: "2px solid #e5e7eb" }}>
              <div style={{ fontWeight: 600, marginBottom: 4, color: "#111827" }}>
                {roomParticleIdFilters.length ||
                categoryCodeFilters.length ||
                selectionCodeFilters.length
                  ? "Filtered Reconciliation"
                  : "Reconciliation Activity"}
              </div>
              {(() => {
                // Calculate FILTERED reconciliation totals based on current selection
                let filteredSupplementTotal = 0;
                let filteredChangeOrderTotal = 0;
                let filteredAcvRebateTotal = 0;

                // Build set of filtered SOW item IDs
                const filteredSowItemIds = new Set<string>();
                const hasFilters = roomParticleIdFilters.length || categoryCodeFilters.length || selectionCodeFilters.length;
                
                if (hasFilters) {
                  for (const item of petlItems) {
                    const matchesRoom = !roomParticleIdFilters.length || roomParticleIdFilters.includes(item.projectParticle?.id ?? "");
                    const matchesCategory = !categoryCodeFilters.length || categoryCodeFilters.includes(item.categoryCode ?? "");
                    const matchesSelection = !selectionCodeFilters.length || selectionCodeFilters.includes(item.selectionCode ?? "");
                    
                    if (matchesRoom && matchesCategory && matchesSelection) {
                      filteredSowItemIds.add(item.id);
                    }
                  }
                }

                for (const entry of petlReconciliationEntries) {
                  // If filters are active, only include entries whose sowItemId is in the filtered set
                  if (hasFilters && !filteredSowItemIds.has(String(entry.sowItemId ?? ""))) {
                    continue;
                  }

                  const qty = typeof entry.qty === "number" ? entry.qty : 0;
                  const unitCost = typeof entry.unitCost === "number" ? entry.unitCost : 0;
                  const percent = typeof entry.percentComplete === "number" ? entry.percentComplete : 0;
                  const lineTotal = qty * unitCost;
                  const completedAmount = (lineTotal * percent) / 100;

                  if (entry.tag === "SUPPLEMENT") {
                    if (entry.kind === "CREDIT") {
                      filteredAcvRebateTotal += completedAmount;
                    } else {
                      filteredSupplementTotal += completedAmount;
                    }
                  } else if (entry.tag === "CHANGE_ORDER") {
                    if (entry.kind === "CREDIT") {
                      filteredAcvRebateTotal += completedAmount;
                    } else {
                      filteredChangeOrderTotal += completedAmount;
                    }
                  }
                }

                return (
                  <div style={{ fontSize: 11, lineHeight: 1.5 }}>
                    <RoleVisible minRole="SUPER">
                      <div>
                        Supplements: $
                        {filteredSupplementTotal.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}
                      </div>
                    </RoleVisible>
                    <RoleVisible minRole="SUPER">
                      <div>
                        Change Orders: $
                        {filteredChangeOrderTotal.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}
                      </div>
                    </RoleVisible>
                    <RoleVisible minRole="SUPER">
                      <div>
                        ACV Rebate: $
                        {filteredAcvRebateTotal.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}
                      </div>
                    </RoleVisible>
                  </div>
                );
              })()}
          </div>
        </div>
      )}

      <hr style={{ margin: "16px 0", borderColor: "#e5e7eb" }} />

      {/* SUMMARY tab content */}
      {activeTab === "SUMMARY" && (
        <div style={{ marginBottom: 16 }}>
          {/* General Info card */}
          <div
            style={{
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
              marginBottom: 12,
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
              }}
            >
              General Info
            </div>
            <div
              style={{
                padding: 10,
                display: "grid",
                gridTemplateColumns: "1fr 1fr",
                gap: 8,
                fontSize: 13,
              }}
            >
              <div>
                <div><strong>Job:</strong> {project.name}</div>
                <div><strong>Job Type:</strong> N/A</div>
                <div><strong>Job Group:</strong> N/A</div>
                <div><strong>Contract Type:</strong> N/A</div>
                <div>
                  <strong>Address:</strong>{" "}
                  {projectMapsUrl && projectAddress ? (
                    <a
                      href={projectMapsUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{ color: "#2563eb", textDecoration: "none" }}
                    >
                      {projectAddress}
                    </a>
                  ) : (
                    projectAddress || "N/A"
                  )}
                </div>
                <div><strong>Square Feet:</strong> N/A</div>
                <div><strong>Lot Info:</strong> N/A</div>
              </div>
              <div>
                <div><strong>Status:</strong> {project.status}</div>
                <div><strong>Project Managers:</strong> N/A</div>
                <div><strong>Projected Start:</strong> N/A</div>
                <div><strong>Actual Start:</strong> N/A</div>
                <div><strong>Projected Completion:</strong> N/A</div>
                <div><strong>Actual Completion:</strong> N/A</div>
                <div><strong>Permit #:</strong> N/A</div>
                <RoleVisible minRole="SUPER">
                  <div>
                    <strong>Contract Price:</strong>{" "}
                    {petlTotalAmount != null
                      ? `$${petlTotalAmount.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}`
                      : "$0.00"}
                  </div>
                </RoleVisible>
              </div>
            </div>
          </div>

          <ScheduleSection
            projectId={project.id}
            petlEstimateVersionId={petlEstimateVersionId}
            roomToUnitLabel={roomToUnitLabel}
            unitGroups={unitGroups}
            mode="SUMMARY"
            apiBase={API_BASE}
          />

          {/* Job Notes card */}
          <div
            style={{
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
              marginBottom: 12,
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
              }}
            >
              Job Notes
            </div>
            <div style={{ padding: 10, fontSize: 13 }}>
              <div style={{ marginBottom: 8 }}>
                <div style={{ fontWeight: 600 }}>Notes for Internal Users:</div>
                <div style={{ color: "#6b7280" }}>N/A</div>
              </div>
              <div>
                <div style={{ fontWeight: 600 }}>Notes for Subs/Vendors:</div>
                <div style={{ color: "#6b7280" }}>N/A</div>
              </div>
            </div>
          </div>

          {/* Custom fields card */}
          <div
            style={{
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
              }}
            >
              Custom fields
            </div>
            <div style={{ padding: 10, fontSize: 13 }}>
              <div>Claim Information: N/A</div>
              <div>Policy Documents: N/A</div>
              <div>Permit Parcel ID: N/A</div>
              <div>Contractor License: N/A</div>
              <div>FL GIS Link: N/A</div>
              <div>Local Supplier Link: N/A</div>
              <div># Property Special Notes: N/A</div>
            </div>
          </div>

          {/* Job Groups / Tags card */}
          <div
            style={{
              marginTop: 12,
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
              }}
            >
              Job Groups / Tags
            </div>
            <div style={{ padding: 10, fontSize: 13 }}>
              {availableTags.length === 0 ? (
                <div style={{ color: "#6b7280" }}>
                  No project tags defined yet.
                </div>
              ) : (
                <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                  {availableTags.map(tag => {
                    const isSelected = projectTags.some(t => t.tagId === tag.id);
                    return (
                      <span
                        key={tag.id}
                        style={{
                          borderRadius: 999,
                          border: isSelected
                            ? "1px solid #2563eb"
                            : "1px solid #d1d5db",
                          backgroundColor: isSelected ? "#eff6ff" : "#ffffff",
                          color: "#111827",
                          padding: "2px 10px",
                          fontSize: 12,
                        }}
                      >
                        {tag.label}
                      </span>
                    );
                  })}
                </div>
              )}
              {tagsSaving && (
                <div style={{ marginTop: 8, fontSize: 11, color: "#6b7280" }}>
                  Saving tags…
                </div>
              )}
              {(actorCompanyRole === "OWNER" || actorCompanyRole === "ADMIN") && (
                <div style={{ marginTop: 8 }}>
                  <button
                    type="button"
                    onClick={() => setShowTagManager(true)}
                    style={{
                      padding: "4px 10px",
                      borderRadius: 999,
                      border: "1px solid #d1d5db",
                      background: "#ffffff",
                      fontSize: 12,
                      cursor: "pointer",
                    }}
                  >
                    Manage tags (PM+)
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Tag manager overlay for PM+ */}
          {showTagManager && (actorCompanyRole === "OWNER" || actorCompanyRole === "ADMIN") && (
            <div
              style={{
                position: "fixed",
                inset: 0,
                background: "rgba(15,23,42,0.35)",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                zIndex: 40,
              }}
            >
              <div
                style={{
                  width: 360,
                  maxWidth: "90vw",
                  background: "#ffffff",
                  borderRadius: 8,
                  boxShadow: "0 10px 25px rgba(15,23,42,0.35)",
                  border: "1px solid #e5e7eb",
                  padding: 12,
                  fontSize: 13,
                }}
              >
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    marginBottom: 8,
                  }}
                >
                  <div style={{ fontWeight: 600 }}>Manage job tags</div>
                  <button
                    type="button"
                    onClick={() => setShowTagManager(false)}
                    style={{
                      border: "none",
                      background: "transparent",
                      cursor: "pointer",
                      fontSize: 14,
                    }}
                  >
                    ✕
                  </button>
                </div>

                <div style={{ marginBottom: 8 }}>
                  <div style={{ marginBottom: 4 }}>Attach existing tags</div>
                  {availableTags.length === 0 ? (
                    <div style={{ color: "#6b7280" }}>No tags defined for this company yet.</div>
                  ) : (
                    <div
                      style={{
                        display: "flex",
                        flexWrap: "wrap",
                        gap: 6,
                        padding: 4,
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        maxHeight: 180,
                        overflowY: "auto",
                      }}
                    >
                      {availableTags.map(tag => {
                        const isSelected = projectTags.some(t => t.tagId === tag.id);
                        return (
                          <button
                            key={tag.id}
                            type="button"
                            disabled={tagsSaving}
                            onClick={async () => {
                              const token = localStorage.getItem("accessToken");
                              if (!token) {
                                alert("Missing access token; please log in again.");
                                return;
                              }
                              if (tagsSaving) return;
                              setTagsSaving(true);
                              const nextTagIds = isSelected
                                ? projectTags
                                    .filter(t => t.tagId !== tag.id)
                                    .map(t => t.tagId)
                                : [...projectTags.map(t => t.tagId), tag.id];
                              try {
                                const res = await fetch(`${API_BASE}/tags/projects/${id}`, {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({ tagIds: nextTagIds }),
                                });
                                if (res.ok) {
                                  const updated: TagAssignmentDto[] = await res.json();
                                  setProjectTags(updated || []);
                                } else if (res.status === 403) {
                                  alert("You do not have permission to edit tags for this project.");
                                  setShowTagManager(false);
                                }
                              } finally {
                                setTagsSaving(false);
                              }
                            }}
                            style={{
                              borderRadius: 999,
                              border: isSelected
                                ? "1px solid #2563eb"
                                : "1px solid #d1d5db",
                              backgroundColor: isSelected ? "#eff6ff" : "#ffffff",
                              color: "#111827",
                              padding: "2px 10px",
                              fontSize: 12,
                              cursor: tagsSaving ? "default" : "pointer",
                            }}
                          >
                            {tag.label}
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* New tag */}
                <div style={{ marginTop: 8 }}>
                  <div style={{ marginBottom: 4 }}>New tag label</div>
                  <input
                    value={newTagLabel}
                    onChange={e => setNewTagLabel(e.target.value)}
                    placeholder="e.g. Group: Fortified Structures"
                    style={{
                      width: "100%",
                      padding: "4px 6px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                    }}
                  />
                  <button
                    type="button"
                    disabled={tagsSaving || !newTagLabel.trim()}
                    onClick={async () => {
                      const label = newTagLabel.trim();
                      if (!label) return;
                      const token = localStorage.getItem("accessToken");
                      if (!token) {
                        alert("Missing access token; please log in again.");
                        return;
                      }
                      setTagsSaving(true);
                      try {
                        const res = await fetch(`${API_BASE}/tags/projects/${id}/create`, {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({ label }),
                        });
                        if (!res.ok) {
                          const text = await res.text().catch(() => "");
                          alert(
                            `Failed to create tag (${res.status}). ${text || "Check your permissions."}`,
                          );
                          if (res.status === 403) {
                            setShowTagManager(false);
                          }
                          return;
                        }
                        const created: { id: string; code: string; label: string; color: string | null } =
                          await res.json();
                        // Refresh available tags list and mark it selected for this project
                        const newAvailable = [
                          ...availableTags,
                          {
                            id: created.id,
                            code: created.code,
                            label: created.label,
                            color: created.color,
                          },
                        ];
                        setAvailableTags(newAvailable);

                        const resAssign = await fetch(`${API_BASE}/tags/projects/${id}`, {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({ tagIds: [...projectTags.map(t => t.tagId), created.id] }),
                        });
                        if (resAssign.ok) {
                          const updated: TagAssignmentDto[] = await resAssign.json();
                          setProjectTags(updated || []);
                          setNewTagLabel("");
                        }
                      } finally {
                        setTagsSaving(false);
                      }
                    }}
                    style={{
                      marginTop: 6,
                      padding: "4px 10px",
                      borderRadius: 4,
                      border: "1px solid #0f172a",
                      background: tagsSaving ? "#e5e7eb" : "#0f172a",
                      color: tagsSaving ? "#4b5563" : "#f9fafb",
                      fontSize: 12,
                      cursor: tagsSaving ? "default" : "pointer",
                    }}
                  >
                    {tagsSaving ? "Saving…" : "Create & attach"}
                  </button>
                  <p style={{ fontSize: 11, color: "#6b7280", marginTop: 4 }}>
                    PMs/Owners/Admins can create project tags here. Codes are derived
                    automatically from labels.
                  </p>
                </div>

                <div style={{ marginTop: 10, display: "flex", justifyContent: "flex-end", gap: 8 }}>
                  <button
                    type="button"
                    onClick={() => setShowTagManager(false)}
                    style={{
                      padding: "4px 10px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      background: "#ffffff",
                      fontSize: 12,
                      cursor: "pointer",
                    }}
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Participants card */}
          <div
            style={{
              marginTop: 12,
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
                display: "flex",
                alignItems: "center",
                justifyContent: "flex-start",
                gap: 8,
              }}
            >
              <span>Participants</span>
              {(actorGlobalRole === "SUPER_ADMIN" ||
                actorCompanyRole === "OWNER" ||
                actorCompanyRole === "ADMIN" ||
                actorCompanyRole === "MEMBER") && (
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <select
                    value={participantAdminMode}
                    onChange={e => {
                      const value = e.target.value as
                        | "none"
                        | "internal"
                        | "invite";
                      setParticipantAdminMode(value);
                    }}
                    style={{
                      marginLeft: 8,
                      padding: "4px 8px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                      background: "#ffffff",
                    }}
                  >
                    <option value="none">Add participants…</option>
                    <option value="internal">Add Nexus user(s) from my company</option>
                    {actorGlobalRole === "SUPER_ADMIN" && (
                      <option value="invite">
                        Add new user with temp password
                      </option>
                    )}
                  </select>
                </div>
              )}
            </div>
            <div
              style={{
                padding: 10,
                display: "grid",
                gridTemplateColumns: "1fr 1fr",
                gap: 16,
                fontSize: 13,
              }}
            >
              {/* My Organization */}
              <div>
                <div style={{ fontWeight: 600, marginBottom: 4 }}>My Organization</div>
                {!participants || participants.myOrganization.length === 0 ? (
                  <div style={{ color: "#6b7280" }}>No internal users yet.</div>
                ) : (
                  <ul style={{ margin: 0, paddingLeft: 16 }}>
                    {participants.myOrganization.map((m, index) => (
                      <li key={`${m.id ?? m.userId ?? "member"}-${index}`}>
                        {m.user?.email ? (
                          <a
                            href={`mailto:${m.user.email}`}
                            style={{ color: "#2563eb", textDecoration: "none" }}
                          >
                            {m.user.email}
                          </a>
                        ) : (
                          "(user)"
                        )}
                        {m.role && (
                          <span style={{ color: "#6b7280" }}> — {m.role}</span>
                        )}
                      </li>
                    ))}
                  </ul>
                )}
                {/* Inline add-internal-user control has been removed in favor of the bulk selector
                    below. Use the Participants header dropdown to open the multi-select panel.
                */}
              </div>

              {/* Collaborators */}
              <div>
                <div style={{ fontWeight: 600, marginBottom: 4 }}>Collaborators</div>
                {!participants || participants.collaborators.length === 0 ? (
                  <div style={{ color: "#6b7280" }}>No collaborators yet.</div>
                ) : (
                  <div>
                    {Object.entries(
                      participants.collaborators.reduce<Record<string, Participant[]>>(
                        (acc, m) => {
                          const key = m.company?.name ?? "Unknown organization";
                          if (!acc[key]) acc[key] = [];
                          acc[key].push(m);
                          return acc;
                        },
                      {}),
                    ).map(([companyName, members]) => (
                      <div key={companyName} style={{ marginBottom: 6 }}>
                        <div style={{ fontWeight: 600 }}>{companyName}</div>
                        <ul style={{ margin: 0, paddingLeft: 16 }}>
                            {members.map((m, index) => (
                              <li key={`${m.id ?? m.userId ?? "collab"}-${index}`}>
                                {m.user?.email ? (
                                  <a
                                    href={`mailto:${m.user.email}`}
                                    style={{ color: "#2563eb", textDecoration: "none" }}
                                  >
                                    {m.user.email}
                                  </a>
                                ) : (
                                  "(user)"
                                )}
                                {m.role && (
                                  <span style={{ color: "#6b7280" }}> — {m.role}</span>
                                )}
                              </li>
                            ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                )}

                {/* Placeholder: collaborator management UI (to be implemented) */}
                {(actorGlobalRole === "SUPER_ADMIN" ||
                  actorCompanyRole === "OWNER" ||
                  actorCompanyRole === "ADMIN") && (
                  <div style={{ marginTop: 8 }}>
                    <button
                      type="button"
                      onClick={() => {
                        // Placeholder only for now; real collaborator flows will be wired later.
                        alert(
                          "Collaborator management is coming soon. This will let you connect external organizations and users to this project.",
                        );
                      }}
                      style={{
                        padding: "4px 8px",
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        backgroundColor: "#f9fafb",
                        fontSize: 12,
                        cursor: "pointer",
                      }}
                    >
                      + Add collaborator (coming soon)
                    </button>
                  </div>
                )}
              </div>
            </div>

            {/* Admin / foreman bulk add + invite panel, driven by dropdown mode */}
            {(actorGlobalRole === "SUPER_ADMIN" ||
              actorCompanyRole === "OWNER" ||
              actorCompanyRole === "ADMIN" ||
              actorCompanyRole === "MEMBER") &&
              participantAdminMode !== "none" && (
              <div
                style={{
                  borderTop: "1px solid #e5e7eb",
                  padding: 10,
                  fontSize: 12,
                  background: "#f9fafb",
                }}
              >
                <div
                  style={{
                    display: "grid",
                    gridTemplateColumns: "1.2fr 1.1fr",
                    gap: 16,
                    alignItems: "flex-start",
                  }}
                >
                  {/* Bulk add existing internal users (mode: internal) */}
                  {participantAdminMode === "internal" && (
                    <div>
                    <div style={{ fontWeight: 600, marginBottom: 4 }}>
                      Add existing internal users
                    </div>
                    <p style={{ marginTop: 0, marginBottom: 6, color: "#6b7280" }}>
                      Select one or more company members and add them to this project
                      with a project-level role.
                    </p>
                    <div
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: 8,
                        marginBottom: 6,
                      }}
                    >
                      <span style={{ fontSize: 11, color: "#4b5563" }}>Project role</span>
                      <select
                        value={newMemberRole}
                        onChange={e =>
                          setNewMemberRole(e.target.value as "MANAGER" | "VIEWER")
                        }
                        style={{
                          padding: "2px 6px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                        }}
                      >
                        <option value="MANAGER">Manager</option>
                        <option value="VIEWER">Viewer</option>
                      </select>
                    </div>
                    <div
                      style={{
                        maxHeight: 160,
                        overflow: "auto",
                        border: "1px solid #e5e7eb",
                        borderRadius: 4,
                        background: "#ffffff",
                        padding: 6,
                      }}
                    >
                      {(() => {
                        const addableMembers = availableMembers.filter(m =>
                          !participants?.myOrganization.some(p => p.userId === m.userId),
                        );
                        if (addableMembers.length === 0) {
                          return (
                            <div style={{ fontSize: 12, color: "#6b7280" }}>
                              All company members are already on this project.
                            </div>
                          );
                        }
                        const allSelected =
                          addableMembers.length > 0 &&
                          addableMembers.every(m =>
                            bulkInternalSelection.includes(m.userId),
                          );
                        return (
                          <>
                            <div
                              style={{
                                marginBottom: 4,
                                display: "flex",
                                alignItems: "center",
                                gap: 6,
                              }}
                            >
                              <label
                                style={{
                                  display: "flex",
                                  alignItems: "center",
                                  gap: 6,
                                  fontSize: 12,
                                  color: "#4b5563",
                                }}
                              >
                                <input
                                  type="checkbox"
                                  checked={allSelected}
                                  onChange={e => {
                                    const checked = e.target.checked;
                                    setBulkInternalSelection(
                                      checked
                                        ? addableMembers.map(m => m.userId)
                                        : [],
                                    );
                                  }}
                                />
                                <span>Select all</span>
                              </label>
                            </div>
                            <ul
                              style={{
                                listStyle: "none",
                                padding: 0,
                                margin: 0,
                                display: "flex",
                                flexDirection: "column",
                                gap: 4,
                              }}
                            >
                              {addableMembers.map(m => (
                                <li key={m.userId}>
                                  <label
                                    style={{
                                      display: "flex",
                                      alignItems: "center",
                                      gap: 6,
                                    }}
                                  >
                                    <input
                                      type="checkbox"
                                      checked={bulkInternalSelection.includes(m.userId)}
                                      onChange={e => {
                                        setBulkInternalSelection(prev => {
                                          if (e.target.checked) {
                                            return [...prev, m.userId];
                                          }
                                          return prev.filter(id => id !== m.userId);
                                        });
                                      }}
                                    />
                                    <span>{m.email}</span>
                                    {m.role && (
                                      <span
                                        style={{
                                          fontSize: 11,
                                          color: "#6b7280",
                                        }}
                                      >
                                        ({m.role})
                                      </span>
                                    )}
                                  </label>
                                </li>
                              ))}
                            </ul>
                          </>
                        );
                      })()}
                    </div>
                    <div style={{ marginTop: 6, display: "flex", gap: 8 }}>
                      <button
                        type="button"
                        disabled={
                          bulkInternalSaving || bulkInternalSelection.length === 0
                        }
                        onClick={async () => {
                          setBulkInternalMessage(null);
                          if (!bulkInternalSelection.length) return;
                          const token = localStorage.getItem("accessToken");
                          if (!token) {
                            setBulkInternalMessage(
                              "Missing access token; please log in again.",
                            );
                            return;
                          }
                          try {
                            setBulkInternalSaving(true);
                            const uniqueIds = Array.from(
                              new Set(bulkInternalSelection),
                            );
                            for (const userId of uniqueIds) {
                              // eslint-disable-next-line no-await-in-loop
                              await fetch(`${API_BASE}/projects/${id}/members`, {
                                method: "POST",
                                headers: {
                                  "Content-Type": "application/json",
                                  Authorization: `Bearer ${token}`,
                                },
                                body: JSON.stringify({
                                  userId,
                                  role: newMemberRole,
                                }),
                              });
                            }
                            // Refresh participants
                            const partsRes = await fetch(
                              `${API_BASE}/projects/${id}/participants`,
                              {
                                headers: { Authorization: `Bearer ${token}` },
                              },
                            );
                            if (partsRes.ok) {
                              const json: any = await partsRes.json();
                              setParticipants({
                                myOrganization: json.myOrganization ?? [],
                                collaborators: json.collaborators ?? [],
                              });
                            }
                            setBulkInternalMessage(
                              `Added ${bulkInternalSelection.length} user(s) to this project.`,
                            );
                            setBulkInternalSelection([]);
                          } catch (err: any) {
                            setBulkInternalMessage(
                              err?.message ?? "Failed to add internal users.",
                            );
                          } finally {
                            setBulkInternalSaving(false);
                          }
                        }}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 4,
                          border: "1px solid #0f172a",
                          backgroundColor:
                            bulkInternalSaving || bulkInternalSelection.length === 0
                              ? "#e5e7eb"
                              : "#0f172a",
                          color:
                            bulkInternalSaving || bulkInternalSelection.length === 0
                              ? "#4b5563"
                              : "#f9fafb",
                          fontSize: 12,
                          cursor:
                            bulkInternalSaving || bulkInternalSelection.length === 0
                              ? "default"
                              : "pointer",
                        }}
                      >
                        {bulkInternalSaving
                          ? "Adding…"
                          : "Add selected to project"}
                      </button>
                      {bulkInternalMessage && (
                        <span
                          style={{
                            fontSize: 11,
                            color: bulkInternalMessage.toLowerCase().includes(
                              "fail",
                            )
                              ? "#b91c1c"
                              : "#4b5563",
                            alignSelf: "center",
                          }}
                        >
                          {bulkInternalMessage}
                        </span>
                      )}
                    </div>
                  </div>
                  )}

                  {/* SUPER_ADMIN-only: invite new user with temp password (mode: invite) */}
                  {actorGlobalRole === "SUPER_ADMIN" &&
                    participantAdminMode === "invite" && (
                    <div>
                      <div style={{ fontWeight: 600, marginBottom: 4 }}>
                        Invite new user with temporary password
                      </div>
                      <p
                        style={{
                          marginTop: 0,
                          marginBottom: 6,
                          color: "#6b7280",
                        }}
                      >
                        Creates a user, attaches them to your company as a MEMBER,
                        and adds them to this project. Share the temp password
                        with the user out-of-band.
                      </p>
                      <div
                        style={{
                          display: "flex",
                          flexDirection: "column",
                          gap: 6,
                        }}
                      >
                        <label style={{ fontSize: 12 }}>
                          <span
                            style={{ display: "block", marginBottom: 2 }}
                          >
                            Email
                          </span>
                          <input
                            type="email"
                            value={inviteEmail}
                            onChange={e => setInviteEmail(e.target.value)}
                            style={{
                              width: "100%",
                              padding: "6px 8px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                        </label>
                        <label style={{ fontSize: 12 }}>
                          <span
                            style={{ display: "block", marginBottom: 2 }}
                          >
                            Temporary password
                          </span>
                          <input
                            type="password"
                            value={invitePassword}
                            onChange={e => setInvitePassword(e.target.value)}
                            style={{
                              width: "100%",
                              padding: "6px 8px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                        </label>
                        <label style={{ fontSize: 12 }}>
                          <span
                            style={{ display: "block", marginBottom: 2 }}
                          >
                            Project role
                          </span>
                          <select
                            value={inviteProjectRole}
                            onChange={e =>
                              setInviteProjectRole(
                                e.target.value as "MANAGER" | "VIEWER",
                              )
                            }
                            style={{
                              width: "100%",
                              padding: "6px 8px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          >
                            <option value="MANAGER">Manager</option>
                            <option value="VIEWER">Viewer</option>
                          </select>
                        </label>
                        <button
                          type="button"
                          disabled={
                            inviteSaving ||
                            !inviteEmail.trim() ||
                            !invitePassword.trim() ||
                            !currentCompanyId
                          }
                          onClick={async () => {
                            setInviteMessage(null);
                            if (!currentCompanyId) {
                              setInviteMessage("Missing company context.");
                              return;
                            }
                            const token = localStorage.getItem("accessToken");
                            if (!token) {
                              setInviteMessage(
                                "Missing access token; please log in again.",
                              );
                              return;
                            }
                            try {
                              setInviteSaving(true);
                              const createRes = await fetch(
                                `${API_BASE}/admin/create-user-with-password`,
                                {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({
                                    email: inviteEmail.trim(),
                                    password: invitePassword,
                                    companyId: currentCompanyId,
                                    role: "MEMBER",
                                  }),
                                },
                              );
                              if (!createRes.ok) {
                                const text = await createRes
                                  .text()
                                  .catch(() => "");
                                setInviteMessage(
                                  `Failed to create user (${createRes.status}) ${text}`,
                                );
                                return;
                              }
                              const created: any = await createRes.json();
                              const newUserId: string | undefined =
                                created?.user?.id ?? created?.id;
                              if (!newUserId) {
                                setInviteMessage(
                                  "User was created but no user ID was returned.",
                                );
                                return;
                              }
                              const attachRes = await fetch(
                                `${API_BASE}/projects/${id}/members`,
                                {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({
                                    userId: newUserId,
                                    role: inviteProjectRole,
                                  }),
                                },
                              );
                              if (!attachRes.ok) {
                                const text = await attachRes
                                  .text()
                                  .catch(() => "");
                              setInviteMessage(
                                  `User created but failed to add to project (${attachRes.status}) ${text}`,
                                );
                                return;
                              }
                              const partsRes = await fetch(
                                `${API_BASE}/projects/${id}/participants`,
                                {
                                  headers: { Authorization: `Bearer ${token}` },
                                },
                              );
                              if (partsRes.ok) {
                                const json: any = await partsRes.json();
                                setParticipants({
                                  myOrganization: json.myOrganization ?? [],
                                  collaborators: json.collaborators ?? [],
                                });
                              }
                              setInviteMessage(
                                "User created and added to this project.",
                              );
                              setInviteEmail("");
                              setInvitePassword("");
                            } catch (err: any) {
                              setInviteMessage(
                                err?.message ?? "Failed to invite user.",
                              );
                            } finally {
                              setInviteSaving(false);
                            }
                          }}
                          style={{
                            marginTop: 4,
                            padding: "6px 10px",
                            borderRadius: 4,
                            border: "1px solid #0f172a",
                            backgroundColor:
                              inviteSaving ||
                              !inviteEmail.trim() ||
                              !invitePassword.trim() ||
                              !currentCompanyId
                                ? "#e5e7eb"
                                : "#0f172a",
                            color:
                              inviteSaving ||
                              !inviteEmail.trim() ||
                              !invitePassword.trim() ||
                              !currentCompanyId
                                ? "#4b5563"
                                : "#f9fafb",
                            fontSize: 12,
                            cursor:
                              inviteSaving ||
                              !inviteEmail.trim() ||
                              !invitePassword.trim() ||
                              !currentCompanyId
                                ? "default"
                                : "pointer",
                          }}
                        >
                          {inviteSaving ? "Inviting…" : "Invite and add to project"}
                        </button>
                        {inviteMessage && (
                          <p
                            style={{
                              margin: 0,
                              marginTop: 4,
                              fontSize: 11,
                              color: inviteMessage
                                .toLowerCase()
                                .includes("fail")
                                ? "#b91c1c"
                                : "#4b5563",
                            }}
                          >
                            {inviteMessage}
                          </p>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* FINANCIAL tab content */}
      {activeTab === "FINANCIAL" && (
        <div
          style={
            invoiceFullscreen
              ? { marginTop: 0, marginBottom: 0 }
              : { marginTop: 8, marginBottom: 16 }
          }
        >
          <div
            style={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
              marginBottom: 8,
            }}
          >
            {activeInvoice ? (
              <button
                type="button"
                className="no-print"
                onClick={() => {
                  setActiveInvoice(null);
                  if (invoiceFullscreen) {
                    router.push(`/projects/${id}?tab=FINANCIAL`);
                  }
                }}
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: 6,
                  padding: 0,
                  margin: 0,
                  border: "none",
                  background: "none",
                  color: "#2563eb",
                  fontSize: 14,
                  fontWeight: 600,
                  cursor: "pointer",
                }}
              >
                <span style={{ fontSize: 16 }}>←</span>
                Back to Financial Overview
              </button>
            ) : (
              <h2 style={{ fontSize: 16, fontWeight: 600, margin: 0 }}>Financial Overview</h2>
            )}
            <div style={{ display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
              <button
                type="button"
                onClick={exportInvoicesCsv}
                style={{
                  padding: "4px 8px",
                  borderRadius: 4,
                  border: "1px solid #d1d5db",
                  backgroundColor: "#ffffff",
                  color: "#111827",
                  fontSize: 12,
                  cursor: "pointer",
                  whiteSpace: "nowrap",
                }}
              >
                Export invoices (CSV)
              </button>
              <button
                type="button"
                onClick={exportPaymentsCsv}
                style={{
                  padding: "4px 8px",
                  borderRadius: 4,
                  border: "1px solid #d1d5db",
                  backgroundColor: "#ffffff",
                  color: "#111827",
                  fontSize: 12,
                  cursor: "pointer",
                  whiteSpace: "nowrap",
                }}
              >
                Export payments (CSV)
              </button>
              <button
                type="button"
                onClick={() => setInvoiceCostBookPickerOpen(true)}
                style={{
                  padding: "4px 8px",
                  borderRadius: 4,
                  border: "1px solid #2563eb",
                  backgroundColor: "#eff6ff",
                  color: "#1d4ed8",
                  fontSize: 12,
                  cursor: "pointer",
                  whiteSpace: "nowrap",
                }}
              >
                Open Tenant Cost Book
              </button>
              <a
                href={`/projects/${id}/timecards/${todayIso}`}
                style={{
                  padding: "4px 8px",
                  borderRadius: 4,
                  border: "1px solid #0f172a",
                  backgroundColor: "#0f172a",
                  color: "#f9fafb",
                  fontSize: 12,
                  textDecoration: "none",
                  whiteSpace: "nowrap",
                }}
              >
                Open Time Accounting
              </a>
            </div>
          </div>

          {invoiceCostBookPickerOpen && (
            <CostBookPickerModal
              title="Tenant Cost Book"
              subtitle={
                activeInvoice?.status === "DRAFT"
                  ? "Select line items to add to the current draft invoice."
                  : "Browse the tenant cost book. (Open a draft invoice to add selected items.)"
              }
              confirmLabel={invoiceCostBookPickerBusy ? "Adding…" : "Add selected to invoice"}
              confirmDisabled={
                invoiceCostBookPickerBusy || !activeInvoice || activeInvoice.status !== "DRAFT"
              }
              onConfirm={submitAddInvoiceLinesFromCostBook}
              onClose={() => {
                if (invoiceCostBookPickerBusy) return;
                setInvoiceCostBookPickerOpen(false);
              }}
            />
          )}

          {/* Unit Code Management Modal (Admin only) */}
          {unitCodeManageOpen && (
            <div
              style={{
                position: "fixed",
                inset: 0,
                zIndex: 80,
                backgroundColor: "rgba(15, 23, 42, 0.35)",
                display: "flex",
                justifyContent: "center",
                alignItems: "flex-start",
                padding: "10vh 12px",
              }}
              onClick={() => {
                if (!unitCodeSaving) {
                  setUnitCodeManageOpen(false);
                  setUnitCodeEditId(null);
                  setUnitCodeEditCode("");
                  setUnitCodeEditLabel("");
                }
              }}
            >
              <div
                style={{
                  width: 420,
                  maxWidth: "96vw",
                  maxHeight: "70vh",
                  backgroundColor: "#ffffff",
                  borderRadius: 10,
                  border: "1px solid #e5e7eb",
                  boxShadow: "0 12px 32px rgba(15,23,42,0.18)",
                  overflow: "hidden",
                  display: "flex",
                  flexDirection: "column",
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <div
                  style={{
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                    padding: "10px 12px",
                    borderBottom: "1px solid #e5e7eb",
                    backgroundColor: "#f8fafc",
                  }}
                >
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 700 }}>Manage Unit Codes</div>
                    <div style={{ fontSize: 11, color: "#6b7280" }}>Max 5 characters per code</div>
                  </div>
                  <button
                    type="button"
                    onClick={() => {
                      if (!unitCodeSaving) {
                        setUnitCodeManageOpen(false);
                        setUnitCodeEditId(null);
                        setUnitCodeEditCode("");
                        setUnitCodeEditLabel("");
                      }
                    }}
                    style={{
                      border: "none",
                      background: "transparent",
                      cursor: unitCodeSaving ? "default" : "pointer",
                      fontSize: 18,
                      lineHeight: 1,
                      padding: 6,
                      opacity: unitCodeSaving ? 0.5 : 1,
                    }}
                    aria-label="Close"
                    disabled={unitCodeSaving}
                  >
                    ×
                  </button>
                </div>

                <div style={{ padding: 12, overflowY: "auto", flex: 1 }}>
                  {/* Existing unit codes list */}
                  {(companyUnitCodes ?? []).length === 0 ? (
                    <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 12 }}>
                      No unit codes yet. Add your first one below.
                    </div>
                  ) : (
                    <div style={{ marginBottom: 12 }}>
                      {(companyUnitCodes ?? []).map((uc) => (
                        <div
                          key={uc.id}
                          style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 8,
                            padding: "6px 8px",
                            borderRadius: 4,
                            background: unitCodeEditId === uc.id ? "#eff6ff" : "#f9fafb",
                            marginBottom: 4,
                          }}
                        >
                          {unitCodeEditId === uc.id ? (
                            <>
                              <input
                                value={unitCodeEditCode}
                                onChange={(e) => setUnitCodeEditCode(e.target.value.toUpperCase().slice(0, 5))}
                                placeholder="Code"
                                style={{
                                  width: 60,
                                  padding: "4px 6px",
                                  borderRadius: 4,
                                  border: "1px solid #93c5fd",
                                  fontSize: 12,
                                  fontWeight: 600,
                                }}
                                maxLength={5}
                              />
                              <input
                                value={unitCodeEditLabel}
                                onChange={(e) => setUnitCodeEditLabel(e.target.value)}
                                placeholder="Label (optional)"
                                style={{
                                  flex: 1,
                                  padding: "4px 6px",
                                  borderRadius: 4,
                                  border: "1px solid #93c5fd",
                                  fontSize: 12,
                                }}
                              />
                              <button
                                type="button"
                                disabled={unitCodeSaving || !unitCodeEditCode.trim()}
                                onClick={async () => {
                                  const token = localStorage.getItem("accessToken");
                                  if (!token) return;
                                  setUnitCodeSaving(true);
                                  try {
                                    const res = await fetch(
                                      `${API_BASE}/companies/me/unit-codes/${uc.id}`,
                                      {
                                        method: "PATCH",
                                        headers: {
                                          "Content-Type": "application/json",
                                          Authorization: `Bearer ${token}`,
                                        },
                                        body: JSON.stringify({
                                          code: unitCodeEditCode.trim(),
                                          label: unitCodeEditLabel.trim() || null,
                                        }),
                                      }
                                    );
                                    if (res.ok) {
                                      setCompanyUnitCodes(null); // Refetch
                                      setUnitCodeEditId(null);
                                      setUnitCodeEditCode("");
                                      setUnitCodeEditLabel("");
                                    }
                                  } finally {
                                    setUnitCodeSaving(false);
                                  }
                                }}
                                style={{
                                  padding: "4px 8px",
                                  borderRadius: 4,
                                  border: "1px solid #16a34a",
                                  background: "#16a34a",
                                  color: "#fff",
                                  fontSize: 11,
                                  cursor: unitCodeSaving || !unitCodeEditCode.trim() ? "not-allowed" : "pointer",
                                }}
                              >
                                {unitCodeSaving ? "…" : "Save"}
                              </button>
                              <button
                                type="button"
                                onClick={() => {
                                  setUnitCodeEditId(null);
                                  setUnitCodeEditCode("");
                                  setUnitCodeEditLabel("");
                                }}
                                style={{
                                  padding: "4px 8px",
                                  borderRadius: 4,
                                  border: "1px solid #d1d5db",
                                  background: "#fff",
                                  fontSize: 11,
                                  cursor: "pointer",
                                }}
                              >
                                Cancel
                              </button>
                            </>
                          ) : (
                            <>
                              <span style={{ fontWeight: 600, fontSize: 12, minWidth: 50 }}>{uc.code}</span>
                              <span style={{ flex: 1, fontSize: 12, color: "#6b7280" }}>
                                {uc.label || "(no label)"}
                              </span>
                              <button
                                type="button"
                                onClick={() => {
                                  setUnitCodeEditId(uc.id);
                                  setUnitCodeEditCode(uc.code);
                                  setUnitCodeEditLabel(uc.label || "");
                                }}
                                style={{
                                  padding: "2px 6px",
                                  borderRadius: 4,
                                  border: "1px solid #d1d5db",
                                  background: "#fff",
                                  fontSize: 10,
                                  cursor: "pointer",
                                }}
                              >
                                Edit
                              </button>
                              <button
                                type="button"
                                disabled={unitCodeSaving}
                                onClick={async () => {
                                  if (!confirm(`Delete unit code "${uc.code}"?`)) return;
                                  const token = localStorage.getItem("accessToken");
                                  if (!token) return;
                                  setUnitCodeSaving(true);
                                  try {
                                    const res = await fetch(
                                      `${API_BASE}/companies/me/unit-codes/${uc.id}`,
                                      {
                                        method: "DELETE",
                                        headers: { Authorization: `Bearer ${token}` },
                                      }
                                    );
                                    if (res.ok) {
                                      setCompanyUnitCodes(null); // Refetch
                                    }
                                  } finally {
                                    setUnitCodeSaving(false);
                                  }
                                }}
                                style={{
                                  padding: "2px 6px",
                                  borderRadius: 4,
                                  border: "1px solid #fca5a5",
                                  background: "#fef2f2",
                                  color: "#b91c1c",
                                  fontSize: 10,
                                  cursor: unitCodeSaving ? "not-allowed" : "pointer",
                                }}
                              >
                                Delete
                              </button>
                            </>
                          )}
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Add new unit code form */}
                  <div style={{ borderTop: "1px solid #e5e7eb", paddingTop: 12 }}>
                    <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 8 }}>Add New Unit Code</div>
                    <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                      <input
                        value={unitCodeEditId === null ? unitCodeEditCode : ""}
                        onChange={(e) => {
                          if (unitCodeEditId !== null) {
                            setUnitCodeEditId(null);
                          }
                          setUnitCodeEditCode(e.target.value.toUpperCase().slice(0, 5));
                        }}
                        placeholder="Code (max 5)"
                        style={{
                          width: 80,
                          padding: "6px 8px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                          fontWeight: 600,
                        }}
                        maxLength={5}
                        disabled={unitCodeEditId !== null}
                      />
                      <input
                        value={unitCodeEditId === null ? unitCodeEditLabel : ""}
                        onChange={(e) => {
                          if (unitCodeEditId !== null) {
                            setUnitCodeEditId(null);
                          }
                          setUnitCodeEditLabel(e.target.value);
                        }}
                        placeholder="Label (e.g. Each, Hour, Square Foot)"
                        style={{
                          flex: 1,
                          padding: "6px 8px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                        }}
                        disabled={unitCodeEditId !== null}
                      />
                      <button
                        type="button"
                        disabled={unitCodeSaving || unitCodeEditId !== null || !unitCodeEditCode.trim()}
                        onClick={async () => {
                          const token = localStorage.getItem("accessToken");
                          if (!token || !unitCodeEditCode.trim()) return;
                          setUnitCodeSaving(true);
                          try {
                            const res = await fetch(`${API_BASE}/companies/me/unit-codes`, {
                              method: "POST",
                              headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                              },
                              body: JSON.stringify({
                                code: unitCodeEditCode.trim(),
                                label: unitCodeEditLabel.trim() || null,
                              }),
                            });
                            if (res.ok) {
                              setCompanyUnitCodes(null); // Refetch
                              setUnitCodeEditCode("");
                              setUnitCodeEditLabel("");
                            } else {
                              const text = await res.text().catch(() => "");
                              alert(text || "Failed to add unit code");
                            }
                          } finally {
                            setUnitCodeSaving(false);
                          }
                        }}
                        style={{
                          padding: "6px 12px",
                          borderRadius: 4,
                          border: "1px solid #2563eb",
                          background: "#2563eb",
                          color: "#fff",
                          fontSize: 12,
                          cursor:
                            unitCodeSaving || unitCodeEditId !== null || !unitCodeEditCode.trim()
                              ? "not-allowed"
                              : "pointer",
                        }}
                      >
                        {unitCodeSaving ? "Adding…" : "Add"}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {billModalOpen && (
            <div
              style={{
                position: "fixed",
                inset: 0,
                zIndex: 70,
                backgroundColor: "rgba(15, 23, 42, 0.35)",
                display: "flex",
                justifyContent: "center",
                alignItems: "flex-start",
                padding: "8vh 12px",
              }}
              onClick={closeBillModal}
            >
              <div
                style={{
                  width: 760,
                  maxWidth: "96vw",
                  backgroundColor: "#ffffff",
                  borderRadius: 10,
                  border: "1px solid #e5e7eb",
                  boxShadow: "0 12px 32px rgba(15,23,42,0.18)",
                  overflow: "hidden",
                }}
                onClick={(e) => e.stopPropagation()}
              >
                <div
                  style={{
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                    padding: "10px 12px",
                    borderBottom: "1px solid #e5e7eb",
                    backgroundColor: "#f8fafc",
                  }}
                >
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 700 }}>
                      {billEditingId ? "Edit bill" : "Add bill"}
                    </div>
                    <div style={{ fontSize: 12, color: "#6b7280" }}>
                      Single line item MVP. Add multiple attachments if needed.
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={closeBillModal}
                    style={{
                      border: "none",
                      background: "transparent",
                      cursor: billModalSaving ? "default" : "pointer",
                      fontSize: 18,
                      lineHeight: 1,
                      padding: 6,
                      opacity: billModalSaving ? 0.5 : 1,
                    }}
                    aria-label="Close bill modal"
                    disabled={billModalSaving}
                  >
                    ×
                  </button>
                </div>

                <div style={{ padding: 12, fontSize: 12 }}>
                  {billsMessage && (
                    <div
                      style={{
                        marginBottom: 10,
                        color: billsMessage.toLowerCase().includes("fail") ? "#b91c1c" : "#4b5563",
                      }}
                    >
                      {billsMessage}
                    </div>
                  )}

                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                    <div>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Vendor</div>
                      <input
                        value={billVendorName}
                        onChange={(e) => setBillVendorName(e.target.value)}
                        placeholder="Vendor name"
                        style={{
                          width: "100%",
                          padding: "6px 8px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                        }}
                      />
                    </div>

                    <div>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Bill #</div>
                      <input
                        value={billBillNumber}
                        onChange={(e) => setBillBillNumber(e.target.value)}
                        placeholder="(optional)"
                        style={{
                          width: "100%",
                          padding: "6px 8px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                        }}
                      />
                    </div>

                    <div>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Bill date</div>
                      <input
                        type="date"
                        value={billBillDate}
                        onChange={(e) => setBillBillDate(e.target.value)}
                        style={{
                          width: "100%",
                          padding: "6px 8px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                        }}
                      />
                    </div>

                    <div>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Due date</div>
                      <input
                        type="date"
                        value={billDueAt}
                        onChange={(e) => setBillDueAt(e.target.value)}
                        style={{
                          width: "100%",
                          padding: "6px 8px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                        }}
                      />
                    </div>

                    <div>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Status</div>
                      <select
                        value={billStatus}
                        onChange={(e) => setBillStatus(e.target.value)}
                        style={{
                          width: "100%",
                          padding: "6px 8px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                        }}
                      >
                        <option value="DRAFT">Draft</option>
                        <option value="POSTED">Posted</option>
                        <option value="PAID">Paid</option>
                        <option value="VOID">Void</option>
                      </select>
                    </div>

                    <div style={{ gridColumn: "1 / -1" }}>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Memo</div>
                      <input
                        value={billMemo}
                        onChange={(e) => setBillMemo(e.target.value)}
                        placeholder="(optional)"
                        style={{
                          width: "100%",
                          padding: "6px 8px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                        }}
                      />
                    </div>

                    <div>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Line kind</div>
                      <select
                        value={billLineKind}
                        onChange={(e) => setBillLineKind(e.target.value)}
                        style={{
                          width: "100%",
                          padding: "6px 8px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                        }}
                      >
                        <option value="MATERIALS">Materials</option>
                        <option value="LABOR">Labor</option>
                        <option value="EQUIPMENT">Equipment</option>
                        <option value="LABOR_AND_MATERIALS">Labor & Materials</option>
                        <option value="OTHER">Other</option>
                      </select>
                    </div>

                    <div>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Amount</div>
                      <input
                        value={billLineAmount}
                        onChange={(e) => setBillLineAmount(e.target.value)}
                        placeholder={billLineKind === "LABOR" ? "(optional; derive from timecards)" : "Amount"}
                        style={{
                          width: "100%",
                          padding: "6px 8px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                        }}
                      />
                    </div>

                    <div style={{ gridColumn: "1 / -1" }}>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Line description</div>
                      <DescriptionPicker
                        value={billLineDescription}
                        onChange={setBillLineDescription}
                        category="BILL"
                        placeholder="What is this bill for?"
                        style={{ width: "100%" }}
                      />
                    </div>

                    <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                      <label style={{ display: "flex", alignItems: "center", gap: 6, cursor: "pointer" }}>
                        <input
                          type="checkbox"
                          checked={billBillable}
                          onChange={(e) => {
                            const checked = e.target.checked;
                            setBillBillable(checked);
                            // Default to 25% markup when checking billable
                            if (checked && (!billMarkupPercent || billMarkupPercent === "0")) {
                              setBillMarkupPercent("25");
                            }
                          }}
                        />
                        <span style={{ fontSize: 12, fontWeight: 500 }}>Billable?</span>
                      </label>
                      {billBillable && (
                        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                          <span style={{ fontSize: 11, color: "#4b5563" }}>Markup %</span>
                          <input
                            type="number"
                            value={billMarkupPercent}
                            onChange={(e) => setBillMarkupPercent(e.target.value)}
                            min="0"
                            max="100"
                            style={{
                              width: 70,
                              padding: "4px 6px",
                              borderRadius: 6,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                        </div>
                      )}
                    </div>

                    {billBillable && billLineAmount && (
                      <div style={{ fontSize: 11, color: "#4b5563", display: "flex", gap: 16 }}>
                        {(() => {
                          const cost = Number(billLineAmount) || 0;
                          const markup = Number(billMarkupPercent) || 0;
                          const gmDollars = cost * (markup / 100);
                          const billableAmount = cost + gmDollars;
                          const gmPercent = billableAmount > 0 ? (gmDollars / billableAmount) * 100 : 0;
                          return (
                            <>
                              <span><strong>GM%:</strong> {gmPercent.toFixed(1)}%</span>
                              <span><strong>GM$:</strong> ${gmDollars.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                              <span><strong>Billable Total:</strong> ${billableAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            </>
                          );
                        })()}
                      </div>
                    )}

                    {billLineKind === "LABOR" && (
                      <>
                        <div>
                          <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Timecards start</div>
                          <input
                            type="date"
                            value={billLineTimecardStartDate}
                            onChange={(e) => setBillLineTimecardStartDate(e.target.value)}
                            style={{
                              width: "100%",
                              padding: "6px 8px",
                              borderRadius: 6,
                              border: "1px solid #d1d5db",
                            }}
                          />
                        </div>
                        <div>
                          <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Timecards end</div>
                          <input
                            type="date"
                            value={billLineTimecardEndDate}
                            onChange={(e) => setBillLineTimecardEndDate(e.target.value)}
                            style={{
                              width: "100%",
                              padding: "6px 8px",
                              borderRadius: 6,
                              border: "1px solid #d1d5db",
                            }}
                          />
                        </div>
                        <div style={{ gridColumn: "1 / -1", fontSize: 11, color: "#6b7280" }}>
                          Leave Amount blank to derive labor from timecards using each worker&apos;s default pay rate.
                        </div>
                      </>
                    )}

                    <div style={{ gridColumn: "1 / -1" }}>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 6 }}>Attachments</div>
                      
                      {/* Drag-drop upload zone */}
                      <div
                        onDragOver={e => { e.preventDefault(); e.stopPropagation(); setBillDragOver(true); }}
                        onDragLeave={e => { e.preventDefault(); e.stopPropagation(); setBillDragOver(false); }}
                        onDrop={async e => {
                          e.preventDefault();
                          e.stopPropagation();
                          setBillDragOver(false);
                          const files = e.dataTransfer.files;
                          if (!files || files.length === 0 || !project) return;
                          const token = localStorage.getItem("accessToken");
                          if (!token) {
                            setBillsMessage("Missing access token.");
                            return;
                          }
                          setBillUploading(true);
                          setBillOcrMessage(null);
                          const uploadedFiles: Array<{ id: string; fileName: string; mimeType: string | null; storageUrl: string }> = [];
                          const errors: string[] = [];
                          for (const file of Array.from(files)) {
                            try {
                              // Upload via the nexus uploads utility
                              const link = await uploadImageFileToNexusUploads(file, "BILL");
                              // Register the file in the project
                              const registerRes = await fetch(`${API_BASE}/projects/${id}/files`, {
                                method: "POST",
                                headers: {
                                  "Content-Type": "application/json",
                                  Authorization: `Bearer ${token}`,
                                },
                                body: JSON.stringify({
                                  fileUri: link.url,
                                  fileName: link.label || file.name,
                                  mimeType: file.type || null,
                                  sizeBytes: file.size || null,
                                }),
                              });
                              if (registerRes.ok) {
                                const registered = await registerRes.json();
                                uploadedFiles.push({
                                  id: registered.id,
                                  fileName: registered.fileName || file.name,
                                  mimeType: registered.mimeType || file.type || null,
                                  storageUrl: registered.storageUrl || link.url,
                                });
                              } else {
                                errors.push(`${file.name}: Failed to register`);
                              }
                            } catch (err: any) {
                              errors.push(`${file.name}: ${err?.message || "Upload failed"}`);
                            }
                          }
                          if (uploadedFiles.length > 0) {
                            setBillUploadedFiles(prev => [...prev, ...uploadedFiles]);
                            // Run OCR on first image file for auto-fill
                            const firstImage = uploadedFiles.find(f =>
                              f.mimeType?.startsWith("image/") ||
                              f.fileName?.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/)
                            );
                            if (firstImage) {
                              setBillOcrMessage("Running OCR...");
                              try {
                                const ocrRes = await fetch(`${API_BASE}/projects/${id}/daily-logs/ocr`, {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({ projectFileId: firstImage.id }),
                                });
                                if (ocrRes.ok) {
                                  const ocrData = await ocrRes.json();
                                  if (ocrData.success) {
                                    // Auto-fill bill fields from OCR
                                    if (ocrData.vendor && !billVendorName) {
                                      setBillVendorName(ocrData.vendor);
                                    }
                                    if (ocrData.amount != null && !billLineAmount) {
                                      setBillLineAmount(String(ocrData.amount));
                                    }
                                    if (ocrData.date && !billBillDate) {
                                      setBillBillDate(ocrData.date);
                                    }
                                    const conf = ocrData.confidence ? `(${Math.round(ocrData.confidence * 100)}% confidence)` : "";
                                    setBillOcrMessage(`✓ OCR: ${ocrData.vendor || "?"} - $${ocrData.amount?.toFixed(2) || "?"} ${conf}`);
                                  } else {
                                    setBillOcrMessage(`OCR: ${ocrData.error || "Could not extract data"}`);
                                  }
                                } else {
                                  setBillOcrMessage("✓ File attached (OCR unavailable)");
                                }
                              } catch (ocrErr: any) {
                                setBillOcrMessage(`✓ File attached (OCR error: ${ocrErr?.message || "failed"})`);
                              }
                            } else {
                              setBillOcrMessage(`✓ ${uploadedFiles.length} file(s) attached`);
                            }
                          }
                          if (errors.length > 0) {
                            setBillsMessage(`Errors: ${errors.join(", ")}`);
                          }
                          setBillUploading(false);
                        }}
                        style={{
                          padding: 20,
                          border: billDragOver ? "2px dashed #2563eb" : "2px dashed #d1d5db",
                          borderRadius: 8,
                          backgroundColor: billDragOver ? "#eff6ff" : "#f9fafb",
                          textAlign: "center",
                          cursor: billUploading ? "wait" : "pointer",
                          transition: "all 0.15s ease",
                        }}
                        onClick={() => {
                          if (billUploading) return;
                          document.getElementById("bill-file-input")?.click();
                        }}
                      >
                        <div style={{ fontSize: 28, marginBottom: 4 }}>{billDragOver ? "📥" : billUploading ? "⏳" : "📎"}</div>
                        <div style={{ fontSize: 12, color: billDragOver ? "#2563eb" : "#6b7280", fontWeight: 500 }}>
                          {billUploading ? "Uploading..." : billDragOver ? "Drop files here" : "Drag & drop receipt or invoice"}
                        </div>
                        <div style={{ fontSize: 11, color: "#9ca3af", marginTop: 2 }}>
                          {billUploading ? "Please wait" : "or click to browse • OCR will auto-fill fields"}
                        </div>
                        <input
                          id="bill-file-input"
                          type="file"
                          accept="image/*,.pdf"
                          multiple
                          onChange={async e => {
                            const files = e.target.files;
                            if (!files || files.length === 0 || !project) return;
                            const token = localStorage.getItem("accessToken");
                            if (!token) {
                              setBillsMessage("Missing access token.");
                              return;
                            }
                            setBillUploading(true);
                            setBillOcrMessage(null);
                            const uploadedFiles: Array<{ id: string; fileName: string; mimeType: string | null; storageUrl: string }> = [];
                            const errors: string[] = [];
                            for (const file of Array.from(files)) {
                              try {
                                const link = await uploadImageFileToNexusUploads(file, "BILL");
                                const registerRes = await fetch(`${API_BASE}/projects/${id}/files`, {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({
                                    fileUri: link.url,
                                    fileName: link.label || file.name,
                                    mimeType: file.type || null,
                                    sizeBytes: file.size || null,
                                  }),
                                });
                                if (registerRes.ok) {
                                  const registered = await registerRes.json();
                                  uploadedFiles.push({
                                    id: registered.id,
                                    fileName: registered.fileName || file.name,
                                    mimeType: registered.mimeType || file.type || null,
                                    storageUrl: registered.storageUrl || link.url,
                                  });
                                } else {
                                  errors.push(`${file.name}: Failed to register`);
                                }
                              } catch (err: any) {
                                errors.push(`${file.name}: ${err?.message || "Upload failed"}`);
                              }
                            }
                            if (uploadedFiles.length > 0) {
                              setBillUploadedFiles(prev => [...prev, ...uploadedFiles]);
                              const firstImage = uploadedFiles.find(f =>
                                f.mimeType?.startsWith("image/") ||
                                f.fileName?.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/)
                              );
                              if (firstImage) {
                                setBillOcrMessage("Running OCR...");
                                try {
                                  const ocrRes = await fetch(`${API_BASE}/projects/${id}/daily-logs/ocr`, {
                                    method: "POST",
                                    headers: {
                                      "Content-Type": "application/json",
                                      Authorization: `Bearer ${token}`,
                                    },
                                    body: JSON.stringify({ projectFileId: firstImage.id }),
                                  });
                                  if (ocrRes.ok) {
                                    const ocrData = await ocrRes.json();
                                    if (ocrData.success) {
                                      if (ocrData.vendor && !billVendorName) {
                                        setBillVendorName(ocrData.vendor);
                                      }
                                      if (ocrData.amount != null && !billLineAmount) {
                                        setBillLineAmount(String(ocrData.amount));
                                      }
                                      if (ocrData.date && !billBillDate) {
                                        setBillBillDate(ocrData.date);
                                      }
                                      const conf = ocrData.confidence ? `(${Math.round(ocrData.confidence * 100)}% confidence)` : "";
                                      setBillOcrMessage(`✓ OCR: ${ocrData.vendor || "?"} - $${ocrData.amount?.toFixed(2) || "?"} ${conf}`);
                                    } else {
                                      setBillOcrMessage(`OCR: ${ocrData.error || "Could not extract data"}`);
                                    }
                                  } else {
                                    setBillOcrMessage("✓ File attached (OCR unavailable)");
                                  }
                                } catch (ocrErr: any) {
                                  setBillOcrMessage(`✓ File attached (OCR error: ${ocrErr?.message || "failed"})`);
                                }
                              } else {
                                setBillOcrMessage(`✓ ${uploadedFiles.length} file(s) attached`);
                              }
                            }
                            if (errors.length > 0) {
                              setBillsMessage(`Errors: ${errors.join(", ")}`);
                            }
                            setBillUploading(false);
                            e.target.value = "";
                          }}
                          style={{ display: "none" }}
                        />
                      </div>

                      {/* OCR status message */}
                      {billOcrMessage && (
                        <div style={{
                          marginTop: 8,
                          fontSize: 11,
                          color: billOcrMessage.startsWith("✓") ? "#16a34a" : billOcrMessage.includes("Running") ? "#2563eb" : "#6b7280",
                          fontWeight: 500,
                        }}>
                          {billOcrMessage}
                        </div>
                      )}

                      {/* Display uploaded files with thumbnails */}
                      {billUploadedFiles.length > 0 && (
                        <div style={{
                          marginTop: 10,
                          display: "flex",
                          flexWrap: "wrap",
                          gap: 8,
                          padding: 8,
                          background: "#f0fdf4",
                          borderRadius: 6,
                          border: "1px solid #bbf7d0",
                        }}>
                          {billUploadedFiles.map((file, idx) => (
                            <div
                              key={file.id}
                              style={{
                                position: "relative",
                                width: 70,
                                textAlign: "center",
                              }}
                            >
                              {/* Remove button */}
                              <button
                                type="button"
                                onClick={() => {
                                  setBillUploadedFiles(prev => prev.filter((_, i) => i !== idx));
                                }}
                                style={{
                                  position: "absolute",
                                  top: -6,
                                  right: -6,
                                  width: 18,
                                  height: 18,
                                  borderRadius: "50%",
                                  border: "none",
                                  background: "#ef4444",
                                  color: "white",
                                  fontSize: 11,
                                  cursor: "pointer",
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  zIndex: 1,
                                }}
                                title="Remove"
                              >
                                ×
                              </button>
                              {/* Thumbnail or icon */}
                              {file.mimeType?.startsWith("image/") ? (
                                <img
                                  src={file.storageUrl.startsWith("gs://")
                                    ? `https://storage.googleapis.com/${file.storageUrl.replace("gs://", "")}`
                                    : file.storageUrl}
                                  alt={file.fileName}
                                  style={{
                                    width: 50,
                                    height: 50,
                                    objectFit: "cover",
                                    borderRadius: 4,
                                    border: "1px solid #d1d5db",
                                  }}
                                />
                              ) : (
                                <div style={{
                                  width: 50,
                                  height: 50,
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  background: "white",
                                  borderRadius: 4,
                                  border: "1px solid #d1d5db",
                                  fontSize: 20,
                                }}>
                                  📄
                                </div>
                              )}
                              {/* File name */}
                              <div style={{
                                fontSize: 9,
                                color: "#374151",
                                marginTop: 2,
                                overflow: "hidden",
                                textOverflow: "ellipsis",
                                whiteSpace: "nowrap",
                                maxWidth: 70,
                              }}>
                                {file.fileName}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 12 }}>
                    {/* Delete button - only when editing */}
                    {billEditingId ? (
                      <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                        <button
                          type="button"
                          disabled={billModalSaving}
                          onClick={async () => {
                            if (!project || !billEditingId) return;

                            // If linked to a receipt daily log, show helper message instead of deleting
                            if (billLinkedDailyLog) {
                              setBillsMessage(
                                `This bill is linked to a Receipt daily log and cannot be deleted directly. ` +
                                `Delete or change the type of the linked daily log first.`
                              );
                              return;
                            }

                            const ok = window.confirm(
                              "Delete this bill?\n\nThis action cannot be undone. If this bill is marked billable, " +
                              "the corresponding invoice line item will also be removed."
                            );
                            if (!ok) return;

                            const token = localStorage.getItem("accessToken");
                            if (!token) {
                              setBillsMessage("Missing access token.");
                              return;
                            }

                            setBillModalSaving(true);
                            setBillsMessage(null);
                            try {
                              const res = await fetch(
                                `${API_BASE}/projects/${project.id}/bills/${billEditingId}`,
                                {
                                  method: "DELETE",
                                  headers: {
                                    Authorization: `Bearer ${token}`,
                                  },
                                }
                              );
                              if (!res.ok) {
                                const text = await res.text().catch(() => "");
                                setBillsMessage(`Delete failed (${res.status}) ${text}`);
                                setBillModalSaving(false);
                                return;
                              }
                              // Refresh bills list and close modal
                              setProjectBills(null);
                              setFinancialSummary(null);
                              setBillModalOpen(false);
                              setBillsMessage("Bill deleted.");
                            } catch (err: any) {
                              setBillsMessage(err?.message ?? "Delete failed.");
                            } finally {
                              setBillModalSaving(false);
                            }
                          }}
                          style={{
                            padding: "6px 10px",
                            borderRadius: 6,
                            border: "1px solid #dc2626",
                            background: "#fef2f2",
                            color: "#b91c1c",
                            cursor: billModalSaving ? "default" : "pointer",
                            fontSize: 12,
                            opacity: billLinkedDailyLog ? 0.5 : 1,
                          }}
                        >
                          Delete Bill
                        </button>
                        {/* Show "Edit Daily Log" button when linked to a receipt */}
                        {billLinkedDailyLog && (
                          <button
                            type="button"
                            onClick={async () => {
                              // Fetch the daily log and open it for editing
                              const token = localStorage.getItem("accessToken");
                              if (!token) {
                                setBillsMessage("Missing access token.");
                                return;
                              }

                              try {
                                const res = await fetch(
                                  `${API_BASE}/daily-logs/${billLinkedDailyLog.id}`,
                                  { headers: { Authorization: `Bearer ${token}` } }
                                );
                                if (!res.ok) {
                                  setBillsMessage("Failed to load linked daily log.");
                                  return;
                                }
                                const log: DailyLog = await res.json();
                                // Close bill modal and open daily log edit modal
                                setBillModalOpen(false);
                                openEditDailyLog(log);
                              } catch (err: any) {
                                setBillsMessage(err?.message ?? "Failed to load daily log.");
                              }
                            }}
                            style={{
                              padding: "4px 8px",
                              borderRadius: 4,
                              border: "1px solid #2563eb",
                              background: "#eff6ff",
                              color: "#1d4ed8",
                              cursor: "pointer",
                              fontSize: 11,
                            }}
                          >
                            Edit Linked Daily Log
                          </button>
                        )}
                      </div>
                    ) : (
                      <div />
                    )}
                    <div style={{ display: "flex", gap: 8 }}>
                      <button
                        type="button"
                        onClick={closeBillModal}
                        disabled={billModalSaving}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 6,
                          border: "1px solid #d1d5db",
                          background: "#ffffff",
                          cursor: billModalSaving ? "default" : "pointer",
                          fontSize: 12,
                        }}
                      >
                        Cancel
                      </button>
                      <button
                        type="button"
                        onClick={submitBillModal}
                        disabled={billModalSaving}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 6,
                          border: "1px solid #0f172a",
                          background: "#0f172a",
                          color: "#f9fafb",
                          cursor: billModalSaving ? "default" : "pointer",
                          fontSize: 12,
                        }}
                      >
                        {billModalSaving ? "Saving…" : "Save"}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {invoiceFullscreen && (
            <div style={{ marginBottom: 10 }}>
              <button
                type="button"
                onClick={() => router.push(`/projects/${id}?tab=FINANCIAL`)}
                style={{
                  fontSize: 13,
                  fontWeight: 600,
                  color: "#0f172a",
                  textDecoration: "none",
                  border: "none",
                  background: "transparent",
                  padding: 0,
                  cursor: "pointer",
                }}
              >
                 Back to project
              </button>
            </div>
          )}

          {!invoiceFullscreen && (
            <>
              {financialLoading && (
                <p style={{ fontSize: 12, color: "#6b7280" }}>Loading financial summary…</p>
              )}

          {financialError && !financialLoading && (
            <p style={{ fontSize: 12, color: "#b91c1c" }}>{financialError}</p>
          )}

          {!financialSummary && !financialLoading && !financialError && (
            <p style={{ fontSize: 12, color: "#6b7280" }}>
              No financial snapshot has been computed yet for this project.
            </p>
          )}

          {financialSummary && !financialError && (
            <>
              {/* Snapshot age + refresh */}
              <div
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  fontSize: 12,
                  marginBottom: 4,
                  color: "#4b5563",
                }}
              >
                <span>
                  {financialSummary.snapshotComputedAt
                    ? (() => {
                        const ageMs =
                          Date.now() -
                          new Date(financialSummary.snapshotComputedAt).getTime();
                        const ageHours = ageMs / 36e5;
                        const label =
                          ageHours < 1
                            ? "under an hour old"
                            : ageHours < 24
                            ? `${ageHours.toFixed(1)} hours old`
                            : `${(ageHours / 24).toFixed(1)} days old`;
                        return `Latest financial overview is ${label}.`;
                      })()
                    : "No snapshot age available."}
                </span>
                <button
                  type="button"
                  onClick={async () => {
                    if (!project) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      alert("Missing access token; please log in again.");
                      return;
                    }
                    setFinancialLoading(true);
                    setFinancialError(null);
                    try {
                      const res = await fetch(
                        `${API_BASE}/projects/${project.id}/financial-summary?forceRefresh=true`,
                        { headers: { Authorization: `Bearer ${token}` } },
                      );
                      if (!res.ok) {
                        const text = await res.text().catch(() => "");
                        throw new Error(`Refresh failed (${res.status}) ${text}`);
                      }
                      const json: any = await res.json();
                      setFinancialSummary({
                        totalRcvClaim: json.totalRcvClaim ?? 0,
                        totalAcvClaim: json.totalAcvClaim ?? 0,
                        workCompleteRcv: json.workCompleteRcv ?? 0,
                        acvReturn: json.acvReturn ?? 0,
                        opRate: json.opRate ?? 0,
                        acvOP: json.acvOP ?? 0,
                        totalDueWorkBillable: json.totalDueWorkBillable ?? 0,
                        depositRate: json.depositRate ?? 0.5,
                        depositBaseline: json.depositBaseline ?? 0,
                        billedToDate: json.billedToDate ?? 0,
                        duePayable: json.duePayable ?? 0,
                        dueAmount: json.dueAmount ?? 0,
                        snapshotComputedAt: json.snapshotComputedAt ?? null,
                        snapshotSource: json.snapshotSource ?? "recomputed",
                      });
                    } catch (err: any) {
                      setFinancialError(
                        err?.message ?? "Failed to refresh financial summary.",
                      );
                    } finally {
                      setFinancialLoading(false);
                    }
                  }}
                  disabled={financialLoading}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 4,
                    border: "1px solid #0f172a",
                    backgroundColor: financialLoading ? "#e5e7eb" : "#0f172a",
                    color: financialLoading ? "#4b5563" : "#f9fafb",
                    fontSize: 11,
                    cursor: financialLoading ? "default" : "pointer",
                  }}
                >
                  {financialLoading ? "Updating…" : "Update now"}
                </button>
              </div>

              {/* Summary cards */}
              <div
                style={{
                  display: "grid",
                  gridTemplateColumns: "1.2fr 1fr",
                  gap: 12,
                  alignItems: "flex-start",
                }}
              >
                {/* Left: claim + work math */}
                <div
                  style={{
                    borderRadius: 8,
                    border: "1px solid #e5e7eb",
                    background: "#ffffff",
                    padding: 10,
                    fontSize: 13,
                  }}
                >
                  <div style={{ fontWeight: 600, marginBottom: 6 }}>
                    Carrier / Scope Summary
                  </div>
                  <div
                    style={{
                      display: "grid",
                      gridTemplateColumns: "1.4fr 1fr",
                      rowGap: 4,
                    }}
                  >
                    <div>Total RCV Claim</div>
                    <div style={{ textAlign: "right" }}>
                      ${financialSummary.totalRcvClaim.toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>

                    <div>ACV Return (credit bucket)</div>
                    <div style={{ textAlign: "right" }}>
                      ${financialSummary.acvReturn.toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>

                    <div>ACV O&P ({Math.round(financialSummary.opRate * 100)}%)</div>
                    <div style={{ textAlign: "right" }}>
                      ${financialSummary.acvOP.toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>

                    <div>Work Complete (RCV basis)</div>
                    <div style={{ textAlign: "right" }}>
                      ${financialSummary.workCompleteRcv.toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>

                    <div
                      style={{
                        fontWeight: 600,
                        borderTop: "1px solid #e5e7eb",
                        paddingTop: 4,
                      }}
                    >
                      Total Due (Work Complete) – Billable
                    </div>
                    <div
                      style={{
                        textAlign: "right",
                        fontWeight: 600,
                        borderTop: "1px solid #e5e7eb",
                        paddingTop: 4,
                      }}
                    >
                      ${financialSummary.totalDueWorkBillable.toLocaleString(
                        undefined,
                        {
                          maximumFractionDigits: 2,
                        },
                      )}
                    </div>
                  </div>
                </div>

                {/* Right: deposit + due payable */}
                <div
                  style={{
                    borderRadius: 8,
                    border: "1px solid #e5e7eb",
                    background: "#ffffff",
                    padding: 10,
                    fontSize: 13,
                  }}
                >
                  <div style={{ fontWeight: 600, marginBottom: 6 }}>
                    Deposits &amp; Due Amount
                  </div>
                  <div
                    style={{
                      display: "grid",
                      gridTemplateColumns: "1.4fr 1fr",
                      rowGap: 4,
                    }}
                  >
                    <div>Invoiced to date</div>
                    <div style={{ textAlign: "right" }}>
                      ${(
                        invoiceRollup?.invoiced ?? financialSummary.billedToDate
                      ).toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>

                    <div>Paid to date</div>
                    <div style={{ textAlign: "right" }}>
                      {invoiceRollup ? (
                        <>${invoiceRollup.paid.toLocaleString(undefined, { maximumFractionDigits: 2 })}</>
                      ) : (
                        <span style={{ color: "#9ca3af" }}>—</span>
                      )}
                    </div>

                    <div
                      style={{
                        fontWeight: 600,
                        borderBottom: "1px solid #e5e7eb",
                        paddingBottom: 4,
                        marginBottom: 2,
                      }}
                    >
                      Outstanding
                    </div>
                    <div
                      style={{
                        textAlign: "right",
                        fontWeight: 600,
                        borderBottom: "1px solid #e5e7eb",
                        paddingBottom: 4,
                        marginBottom: 2,
                      }}
                    >
                      {invoiceRollup ? (
                        <>${invoiceRollup.balanceDue.toLocaleString(undefined, { maximumFractionDigits: 2 })}</>
                      ) : (
                        <span style={{ color: "#9ca3af" }}>—</span>
                      )}
                    </div>

                    <div>Work complete (earned) not yet billed</div>
                    <div style={{ textAlign: "right" }}>
                      ${Math.max(
                        0,
                        financialSummary.totalDueWorkBillable -
                          (invoiceRollup?.invoiced ?? financialSummary.billedToDate),
                      ).toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>

                    <div>
                      Deposit baseline ({Math.round(financialSummary.depositRate * 100)}%)
                    </div>
                    <div style={{ textAlign: "right" }}>
                      ${financialSummary.depositBaseline.toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>

                    <div
                      style={{
                        fontWeight: 600,
                        borderTop: "1px solid #e5e7eb",
                        paddingTop: 4,
                      }}
                    >
                      Due Payable (baseline deposit)
                    </div>
                    <div
                      style={{
                        textAlign: "right",
                        fontWeight: 600,
                        borderTop: "1px solid #e5e7eb",
                        paddingTop: 4,
                      }}
                    >
                      ${financialSummary.duePayable.toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>

                    <div>Due Amount (above 50%, not yet billed)</div>
                    <div style={{ textAlign: "right" }}>
                      ${financialSummary.dueAmount.toLocaleString(undefined, {
                        maximumFractionDigits: 2,
                      })}
                    </div>
                  </div>

                  <p style={{ marginTop: 8, fontSize: 11, color: "#6b7280" }}>
                    Invoiced/Paid/Outstanding are calculated from issued invoices (excluding draft/void).
                    Deposit baseline is {Math.round(financialSummary.depositRate * 100)}% of Total Due.
                    Work complete not yet billed includes the baseline deposit portion; Due Amount is only the portion above that baseline.
                  </p>
                </div>
              </div>

            </>
          )}

          {isAdminOrAbove && (
            <div
              style={{
                marginTop: 16,
                borderRadius: 8,
                border: "1px solid #e5e7eb",
                background: "#ffffff",
              }}
            >
              <div
                style={{
                  padding: "6px 10px",
                  borderBottom: petlArchivesCollapsed ? "none" : "1px solid #e5e7eb",
                  fontSize: 13,
                  fontWeight: 600,
                  background: "#f3f4f6",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                  gap: 8,
                }}
              >
                <button
                  type="button"
                  onClick={() => setPetlArchivesCollapsed((v) => !v)}
                  style={{
                    border: "none",
                    background: "transparent",
                    cursor: "pointer",
                    padding: 0,
                    fontSize: 13,
                    fontWeight: 600,
                    color: "#111827",
                    display: "flex",
                    alignItems: "baseline",
                    gap: 8,
                    textAlign: "left",
                  }}
                >
                  <span style={{ fontFamily: "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace" }}>
                    {petlArchivesCollapsed ? "▸" : "▾"}
                  </span>
                  <span>PETL Archives</span>
                  {Array.isArray(petlArchives) && (
                    <span style={{ fontSize: 11, fontWeight: 500, color: "#6b7280" }}>
                      · {petlArchives.length}
                    </span>
                  )}
                </button>

                {!petlArchivesCollapsed && (
                  <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
                    <button
                      type="button"
                      onClick={refreshPetlArchives}
                      disabled={petlArchivesLoading}
                      style={{
                        padding: "4px 8px",
                        borderRadius: 6,
                        border: "1px solid #d1d5db",
                        background: "#ffffff",
                        cursor: petlArchivesLoading ? "default" : "pointer",
                        fontSize: 12,
                      }}
                    >
                      {petlArchivesLoading ? "Refreshing…" : "Refresh"}
                    </button>
                    <button
                      type="button"
                      onClick={createPetlArchive}
                      style={{
                        padding: "4px 8px",
                        borderRadius: 6,
                        border: "1px solid #0f172a",
                        background: "#0f172a",
                        color: "#f9fafb",
                        cursor: "pointer",
                        fontSize: 12,
                      }}
                    >
                      + Create archive
                    </button>
                  </div>
                )}
              </div>

              {!petlArchivesCollapsed && (
                <div style={{ padding: 10, fontSize: 12 }}>
                  {petlArchivesMessage && (
                    <div
                      style={{
                        marginBottom: 8,
                        fontSize: 12,
                        color: petlArchivesMessage.toLowerCase().includes("fail") ? "#b91c1c" : "#4b5563",
                      }}
                    >
                      {petlArchivesMessage}
                    </div>
                  )}

                  {petlArchivesLoading && (
                    <div style={{ color: "#6b7280" }}>Loading PETL archives…</div>
                  )}
                  {petlArchivesError && !petlArchivesLoading && (
                    <div style={{ color: "#b91c1c" }}>{petlArchivesError}</div>
                  )}

                  {!petlArchivesLoading && !petlArchivesError && Array.isArray(petlArchives) && petlArchives.length === 0 && (
                    <div style={{ color: "#6b7280" }}>No PETL archives yet.</div>
                  )}

                  {!petlArchivesLoading && !petlArchivesError && Array.isArray(petlArchives) && petlArchives.length > 0 && (
                    <div style={{ overflowX: "auto" }}>
                      <table style={{ width: "100%", borderCollapse: "collapse" }}>
                        <thead>
                          <tr style={{ textAlign: "left", borderBottom: "1px solid #e5e7eb" }}>
                            <th style={{ padding: "6px 8px" }}>Created</th>
                            <th style={{ padding: "6px 8px" }}>Label</th>
                            <th style={{ padding: "6px 8px" }}>Source</th>
                            <th style={{ padding: "6px 8px" }}>File</th>
                            <th style={{ padding: "6px 8px" }}>Restored</th>
                            <th style={{ padding: "6px 8px", textAlign: "right" }}>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {petlArchives.map((a: any) => {
                            const createdAt = a?.createdAt ? new Date(a.createdAt).toLocaleString() : "—";
                            const label = String(a?.label ?? "").trim() || "—";
                            const note = String(a?.note ?? "").trim() || "";
                            const sourceSeq = a?.sourceEstimateVersion?.sequenceNo;
                            const sourceLabel =
                              typeof sourceSeq === "number" ? `v${sourceSeq}` : (a?.sourceEstimateVersion?.id ?? "—");
                            const fileName = a?.projectFile?.fileName ?? "—";
                            const restoredAt = a?.restoredAt ? new Date(a.restoredAt).toLocaleString() : "—";

                            return (
                              <tr key={String(a?.id ?? Math.random())}>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", whiteSpace: "nowrap" }}>
                                  {createdAt}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                  <div style={{ fontWeight: 600 }}>{label}</div>
                                  {note ? (
                                    <div style={{ fontSize: 11, color: "#6b7280" }}>{note}</div>
                                  ) : null}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", color: "#4b5563" }}>
                                  {sourceLabel}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", color: "#4b5563" }}>
                                  {fileName}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", color: "#4b5563" }}>
                                  {restoredAt}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                                  <button
                                    type="button"
                                    onClick={() => restorePetlArchive(a)}
                                    style={{
                                      padding: "2px 6px",
                                      borderRadius: 4,
                                      border: "1px solid #d1d5db",
                                      background: "#ffffff",
                                      fontSize: 11,
                                      cursor: "pointer",
                                    }}
                                  >
                                    Restore
                                  </button>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}

                  {!petlArchivesLoading && !petlArchivesError && !Array.isArray(petlArchives) && (
                    <div style={{ color: "#6b7280" }}>Open this section to load archives.</div>
                  )}
                </div>
              )}
            </div>
          )}

          {/* Bills (Expenses) */}
          <div
            style={{
              marginTop: 16,
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: billsCollapsed ? "none" : "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                gap: 8,
              }}
            >
              <button
                type="button"
                onClick={() => setBillsCollapsed((v) => !v)}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  padding: 0,
                  fontSize: 13,
                  fontWeight: 600,
                  color: "#111827",
                  display: "flex",
                  alignItems: "baseline",
                  gap: 8,
                  textAlign: "left",
                }}
              >
                <span style={{ fontFamily: "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace" }}>
                  {billsCollapsed ? "▸" : "▾"}
                </span>
                <span>Bills (Expenses)</span>
                {billsRollup && (
                  <span style={{ fontSize: 11, fontWeight: 500, color: "#6b7280" }}>
                    · {billsRollup.count} · Total {formatMoney(billsRollup.total)}
                  </span>
                )}
              </button>

              {!billsCollapsed && (
                <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
                  <button
                    type="button"
                    onClick={() => {
                      setBillsMessage(null);
                      setProjectBills(null);
                    }}
                    disabled={projectBillsLoading}
                    style={{
                      padding: "4px 8px",
                      borderRadius: 6,
                      border: "1px solid #d1d5db",
                      background: "#ffffff",
                      cursor: projectBillsLoading ? "default" : "pointer",
                      fontSize: 12,
                    }}
                  >
                    {projectBillsLoading ? "Refreshing…" : "Refresh"}
                  </button>
                  <button
                    type="button"
                    onClick={openCreateBillModal}
                    style={{
                      padding: "4px 8px",
                      borderRadius: 6,
                      border: "1px solid #0f172a",
                      background: "#0f172a",
                      color: "#f9fafb",
                      cursor: "pointer",
                      fontSize: 12,
                    }}
                  >
                    + Add bill
                  </button>
                </div>
              )}
            </div>

            {!billsCollapsed && (
              <div style={{ padding: 10, fontSize: 12 }}>
                {billsMessage && (
                  <div
                    style={{
                      marginBottom: 8,
                      fontSize: 12,
                      color: billsMessage.toLowerCase().includes("fail") ? "#b91c1c" : "#4b5563",
                    }}
                  >
                    {billsMessage}
                  </div>
                )}

                {/* Uncommitted Receipts Section - Draft bills from daily log receipts */}
                {!projectBillsLoading && projectBills && (() => {
                  const uncommittedReceipts = projectBills.filter(
                    (b: any) => b?.sourceDailyLogId && b?.status === "DRAFT"
                  );
                  if (uncommittedReceipts.length === 0) return null;
                  return (
                    <div
                      style={{
                        marginBottom: 12,
                        padding: "10px 12px",
                        borderRadius: 6,
                        background: "#fef3c7",
                        border: "1px solid #fcd34d",
                      }}
                    >
                      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
                        <div style={{ fontSize: 13, fontWeight: 600, color: "#92400e" }}>
                          📥 Uncommitted Receipts ({uncommittedReceipts.length})
                        </div>
                        <span style={{ fontSize: 11, color: "#b45309" }}>
                          Submitted by field crew - review and commit
                        </span>
                      </div>
                      <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                        {uncommittedReceipts.map((b: any) => {
                          const li = Array.isArray(b?.lineItems) ? b.lineItems[0] : null;
                          const attachments: any[] = Array.isArray(b?.attachments) ? b.attachments : [];
                          // Determine if receipt is "orphaned" - source daily log is missing or changed type
                          const sourceDailyLog = b?.sourceDailyLog;
                          const isOrphaned = b?.sourceDailyLogId && (
                            !sourceDailyLog || sourceDailyLog.type !== "RECEIPT_EXPENSE"
                          );
                          return (
                            <div
                              key={String(b?.id ?? Math.random())}
                              style={{
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "space-between",
                                gap: 8,
                                padding: "6px 8px",
                                borderRadius: 4,
                                background: isOrphaned ? "#fef2f2" : "#fffbeb",
                                border: isOrphaned ? "1px dashed #f87171" : "none",
                              }}
                            >
                              <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: 600, fontSize: 12, display: "flex", alignItems: "center", gap: 4 }}>
                                  {b?.vendorName ?? "Unknown Vendor"}
                                  {isOrphaned && (
                                    <span style={{ fontSize: 10, color: "#dc2626", fontWeight: 400 }} title="Source daily log was deleted or changed">
                                      (orphaned)
                                    </span>
                                  )}
                                </div>
                                <div style={{ fontSize: 11, color: "#6b7280" }}>
                                  {b?.billDate ? String(b.billDate).slice(0, 10) : "No date"}
                                  {li?.description && ` · ${li.description}`}
                                </div>
                              </div>
                              <div style={{ fontWeight: 600, fontSize: 13, color: "#92400e" }}>
                                {formatMoney(b?.totalAmount)}
                              </div>
                              {attachments.length > 0 && (
                                <a
                                  href={String(attachments[0]?.fileUrl ?? "#")}
                                  target="_blank"
                                  rel="noreferrer"
                                  style={{ fontSize: 11, color: "#2563eb" }}
                                  title="View receipt"
                                >
                                  🖼️ View
                                </a>
                              )}
                              {/* Quick disposition buttons */}
                              <div style={{ display: "flex", gap: 4 }}>
                                <button
                                  type="button"
                                  onClick={() => quickSetBillBillable(String(b?.id), true, 25)}
                                  style={{
                                    padding: "3px 6px",
                                    borderRadius: 4,
                                    border: "1px solid #16a34a",
                                    background: "#dcfce7",
                                    color: "#166534",
                                    cursor: "pointer",
                                    fontSize: 10,
                                    fontWeight: 500,
                                  }}
                                  title="Mark as billable expense (25% markup)"
                                >
                                  ✓ Billable
                                </button>
                                <button
                                  type="button"
                                  onClick={() => quickSetBillBillable(String(b?.id), false)}
                                  style={{
                                    padding: "3px 6px",
                                    borderRadius: 4,
                                    border: "1px solid #6b7280",
                                    background: "#f3f4f6",
                                    color: "#374151",
                                    cursor: "pointer",
                                    fontSize: 10,
                                    fontWeight: 500,
                                  }}
                                  title="Mark as non-billable expense"
                                >
                                  ✗ Not Billable
                                </button>
                              </div>
                              <button
                                type="button"
                                onClick={() => openEditBillModal(b)}
                                style={{
                                  padding: "3px 8px",
                                  borderRadius: 4,
                                  border: "1px solid #92400e",
                                  background: "#f59e0b",
                                  color: "#ffffff",
                                  cursor: "pointer",
                                  fontSize: 11,
                                  fontWeight: 500,
                                }}
                              >
                                Review
                              </button>
                              {/* Delete button - only shown for orphaned receipts */}
                              {isOrphaned && (
                                <button
                                  type="button"
                                  onClick={() => deleteOrphanedReceiptBill(String(b?.id), b?.vendorName ?? "Unknown")}
                                  style={{
                                    padding: "3px 6px",
                                    borderRadius: 4,
                                    border: "1px solid #dc2626",
                                    background: "#fef2f2",
                                    color: "#dc2626",
                                    cursor: "pointer",
                                    fontSize: 10,
                                    fontWeight: 500,
                                  }}
                                  title="Delete this orphaned receipt"
                                >
                                  🗑️ Delete
                                </button>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })()}

                {projectBillsLoading && <div style={{ color: "#6b7280" }}>Loading bills…</div>}
                {projectBillsError && !projectBillsLoading && (
                  <div style={{ color: "#b91c1c" }}>{projectBillsError}</div>
                )}

                {!projectBillsLoading && !projectBillsError && projectBills && projectBills.length === 0 && (
                  <div style={{ color: "#6b7280" }}>No bills recorded yet.</div>
                )}

                {!projectBillsLoading && !projectBillsError && projectBills && projectBills.length > 0 && (
                  <div style={{ overflowX: "auto" }}>
                    <table style={{ width: "100%", borderCollapse: "collapse" }}>
                      <thead>
                        <tr style={{ textAlign: "left", borderBottom: "1px solid #e5e7eb" }}>
                          <th style={{ padding: "6px 8px" }}>Vendor</th>
                          <th style={{ padding: "6px 8px" }}>Bill date</th>
                          <th style={{ padding: "6px 8px" }}>Status</th>
                          <th style={{ padding: "6px 8px" }}>Kind</th>
                          <th style={{ padding: "6px 8px" }}>Description</th>
                          <th style={{ padding: "6px 8px", textAlign: "right" }}>Amount</th>
                          <th style={{ padding: "6px 8px", textAlign: "center" }}>Billable</th>
                          <th style={{ padding: "6px 8px", textAlign: "right" }}>GM%</th>
                          <th style={{ padding: "6px 8px", textAlign: "right" }}>GM$</th>
                          <th style={{ padding: "6px 8px" }}>Attachments</th>
                          <th style={{ padding: "6px 8px", textAlign: "right" }}>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[...projectBills]
                          .sort((a, b) => {
                            const da = String(a?.billDate ?? "");
                            const db = String(b?.billDate ?? "");
                            if (da !== db) return db.localeCompare(da);
                            return String(b?.createdAt ?? "").localeCompare(String(a?.createdAt ?? ""));
                          })
                          .map((b: any) => {
                            const li = Array.isArray(b?.lineItems) ? b.lineItems[0] : null;
                            const attachments: any[] = Array.isArray(b?.attachments) ? b.attachments : [];
                            const isBillable = !!b?.isBillable;
                            const cost = Number(b?.totalAmount) || 0;
                            const markupPct = Number(b?.markupPercent) || 0;
                            const gmDollars = isBillable ? cost * (markupPct / 100) : 0;
                            const billableTotal = cost + gmDollars;
                            const gmPercent = isBillable && billableTotal > 0 ? (gmDollars / billableTotal) * 100 : 0;
                            return (
                              <tr key={String(b?.id ?? Math.random())}>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                  {b?.vendorName ?? "—"}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", color: "#4b5563" }}>
                                  {b?.billDate ? String(b.billDate).slice(0, 10) : "—"}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", color: "#4b5563" }}>
                                  {b?.status ?? "—"}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", color: "#4b5563" }}>
                                  {li?.kind ?? "—"}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                  <div style={{ fontWeight: 600 }}>{li?.description ?? "—"}</div>
                                  {b?.billNumber && (
                                    <div style={{ fontSize: 11, color: "#6b7280" }}>#{String(b.billNumber)}</div>
                                  )}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right", fontWeight: 600 }}>
                                  {formatMoney(b?.totalAmount)}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "center" }}>
                                  {isBillable ? (
                                    <span style={{ color: "#16a34a", fontWeight: 600 }}>✓ {markupPct}%</span>
                                  ) : (
                                    <span style={{ color: "#9ca3af" }}>—</span>
                                  )}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right", color: isBillable ? "#111827" : "#9ca3af" }}>
                                  {isBillable ? `${gmPercent.toFixed(1)}%` : "—"}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right", fontWeight: isBillable ? 600 : 400, color: isBillable ? "#16a34a" : "#9ca3af" }}>
                                  {isBillable ? formatMoney(gmDollars) : "—"}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                  {attachments.length === 0 ? (
                                    <span style={{ color: "#9ca3af" }}>—</span>
                                  ) : (
                                    <div style={{ display: "flex", flexDirection: "column", gap: 2 }}>
                                      {attachments.slice(0, 3).map((a: any) => (
                                        <a
                                          key={String(a?.id ?? a?.projectFileId ?? Math.random())}
                                          href={String(a?.fileUrl ?? "#")}
                                          target="_blank"
                                          rel="noreferrer"
                                          style={{ fontSize: 11, color: "#2563eb", textDecoration: "none" }}
                                        >
                                          {String(a?.fileName ?? "Attachment")}
                                        </a>
                                      ))}
                                      {attachments.length > 3 && (
                                        <span style={{ fontSize: 11, color: "#6b7280" }}>
                                          +{attachments.length - 3} more
                                        </span>
                                      )}
                                    </div>
                                  )}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                                  <button
                                    type="button"
                                    onClick={() => openEditBillModal(b)}
                                    style={{
                                      padding: "2px 6px",
                                      borderRadius: 4,
                                      border: "1px solid #d1d5db",
                                      background: "#ffffff",
                                      fontSize: 11,
                                      cursor: "pointer",
                                    }}
                                  >
                                    Edit
                                  </button>
                                </td>
                              </tr>
                            );
                          })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Billable Expenses Invoice */}
          {(() => {
            const billableBills = (projectBills ?? []).filter((b: any) => b?.isBillable);
            const billableTotal = billableBills.reduce((sum: number, b: any) => sum + (Number(b?.billableAmount) || 0), 0);
            const costTotal = billableBills.reduce((sum: number, b: any) => sum + (Number(b?.totalAmount) || 0), 0);
            const gmTotal = billableTotal - costTotal;

            // Find the EXPENSE category invoice
            const expenseInvoice = (projectInvoices ?? []).find((inv: any) => inv?.category === "EXPENSE");

            if (billableBills.length === 0) return null;

            return (
              <div
                style={{
                  marginTop: 16,
                  borderRadius: 8,
                  border: "1px solid #16a34a",
                  background: "#f0fdf4",
                }}
              >
                <div
                  style={{
                    padding: "10px 12px",
                    fontSize: 13,
                    fontWeight: 600,
                    background: "#dcfce7",
                    borderBottom: "1px solid #16a34a",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                    gap: 8,
                  }}
                >
                  <div style={{ display: "flex", alignItems: "baseline", gap: 8 }}>
                    <span>💰 Billable Expenses Invoice</span>
                    <span style={{ fontSize: 11, fontWeight: 500, color: "#166534" }}>
                      · {billableBills.length} item{billableBills.length !== 1 ? "s" : ""} · Total {formatMoney(billableTotal)}
                      {expenseInvoice && ` · ${expenseInvoice.status}`}
                      {expenseInvoice?.invoiceNo && ` · ${expenseInvoice.invoiceNo}`}
                    </span>
                  </div>
                  <div style={{ display: "flex", gap: 6 }}>
                    <button
                      type="button"
                      onClick={async () => {
                        if (!project) return;
                        const token = localStorage.getItem("accessToken");
                        if (!token) return;
                        try {
                          // Create/sync the expense invoice
                          const res = await fetch(
                            `${API_BASE}/projects/${project.id}/invoices/sync-billable-expenses`,
                            {
                              method: "POST",
                              headers: {
                                Authorization: `Bearer ${token}`,
                                "Content-Type": "application/json",
                              },
                              body: JSON.stringify({}),
                            }
                          );
                          if (res.ok) {
                            const fullInvoice = await res.json();
                            setActiveInvoice(fullInvoice);
                            // Navigate to fullscreen invoice view
                            router.push(`/projects/${id}?tab=FINANCIAL&invoiceFullscreen=1&invoiceId=${fullInvoice.id}`);
                            // Refresh invoices list
                            setProjectInvoices(null);
                          }
                        } catch {
                          // ignore
                        }
                      }}
                      style={{
                        padding: "4px 10px",
                        borderRadius: 4,
                        border: "1px solid #166534",
                        background: "#166534",
                        color: "#ffffff",
                        fontSize: 11,
                        cursor: "pointer",
                        fontWeight: 600,
                      }}
                    >
                      {expenseInvoice ? "Open Invoice" : "Create Invoice"}
                    </button>
                  </div>
                </div>
                <div style={{ padding: 12, fontSize: 12 }}>
                  <div style={{ display: "flex", gap: 24, flexWrap: "wrap", marginBottom: 12 }}>
                    <div>
                      <div style={{ fontSize: 11, color: "#166534", marginBottom: 2 }}>Cost</div>
                      <div style={{ fontWeight: 600 }}>{formatMoney(costTotal)}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 11, color: "#166534", marginBottom: 2 }}>Gross Margin</div>
                      <div style={{ fontWeight: 600, color: "#16a34a" }}>{formatMoney(gmTotal)}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 11, color: "#166534", marginBottom: 2 }}>Billable Total</div>
                      <div style={{ fontWeight: 700, fontSize: 14 }}>{formatMoney(billableTotal)}</div>
                    </div>
                  </div>
                  <div style={{ fontSize: 11, color: "#166534" }}>
                    This invoice is auto-generated from bills marked as &quot;Billable&quot;. Review the items below and issue when ready.
                  </div>
                  {/* Move expense lines action bar */}
                  {expenseInvoice && expenseInvoice.status === "DRAFT" && selectedExpenseLineIds.size > 0 && (() => {
                    // Get all DRAFT invoices except the current expense invoice
                    const allDraftInvoices = (projectInvoices ?? []).filter(
                      (inv: any) => inv?.status === "DRAFT"
                    );
                    const otherDraftInvoices = allDraftInvoices.filter(
                      (inv: any) => inv?.id !== expenseInvoice.id
                    );
                    return (
                    <div style={{ marginTop: 8, padding: "8px 10px", background: "#dbeafe", borderRadius: 6 }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 10, flexWrap: "wrap" }}>
                      <span style={{ fontSize: 11, fontWeight: 600, color: "#1d4ed8" }}>
                        {selectedExpenseLineIds.size} line{selectedExpenseLineIds.size !== 1 ? "s" : ""} selected
                      </span>
                      <span style={{ fontSize: 11, color: "#1d4ed8" }}>→ Move to:</span>
                      <select
                        value={moveExpenseTargetInvoiceId}
                        onChange={(e) => setMoveExpenseTargetInvoiceId(e.target.value)}
                        style={{
                          padding: "4px 8px",
                          borderRadius: 4,
                          border: "1px solid #93c5fd",
                          fontSize: 11,
                          background: "#ffffff",
                        }}
                      >
                        <option value="">New Invoice</option>
                        {otherDraftInvoices.map((inv: any) => {
                          // Find index among ALL drafts for consistent numbering
                          const draftNum = allDraftInvoices.findIndex((d: any) => d?.id === inv?.id) + 1;
                          const label = inv.invoiceNo ?? `Draft #${draftNum}`;
                          const category = inv.category === "EXPENSE" ? "Expenses" : inv.category === "PETL" ? "Progress" : inv.category ?? "Invoice";
                          const amount = typeof inv.totalAmount === "number" ? ` $${inv.totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : "";
                          return (
                            <option key={inv.id} value={inv.id}>
                              {label} ({category}{amount})
                            </option>
                          );
                        })}
                      </select>
                      <button
                        type="button"
                        disabled={moveExpenseLinesBusy}
                        onClick={async () => {
                          if (!project || !expenseInvoice) return;
                          const token = localStorage.getItem("accessToken");
                          if (!token) {
                            setMoveExpenseLinesMessage("Missing access token.");
                            return;
                          }

                          // Get the bill IDs for selected items
                          const billIds: string[] = Array.from(selectedExpenseLineIds);

                          if (billIds.length === 0) {
                            setMoveExpenseLinesMessage("No items selected.");
                            return;
                          }

                          const targetLabel = moveExpenseTargetInvoiceId
                            ? otherDraftInvoices.find((inv: any) => inv.id === moveExpenseTargetInvoiceId)?.invoiceNo ?? "selected invoice"
                            : "a new invoice";
                          const ok = window.confirm(
                            `Move ${billIds.length} expense${billIds.length !== 1 ? "s" : ""} to ${targetLabel}?`
                          );
                          if (!ok) return;

                          setMoveExpenseLinesBusy(true);
                          setMoveExpenseLinesMessage(null);

                          try {
                            const payload: { billIds: string[]; targetInvoiceId?: string } = { billIds };
                            if (moveExpenseTargetInvoiceId) {
                              payload.targetInvoiceId = moveExpenseTargetInvoiceId;
                            }
                            const res = await fetch(
                              `${API_BASE}/projects/${project.id}/invoices/${expenseInvoice.id}/move-expense-lines`,
                              {
                                method: "POST",
                                headers: {
                                  "Content-Type": "application/json",
                                  Authorization: `Bearer ${token}`,
                                },
                                body: JSON.stringify(payload),
                              }
                            );

                            if (!res.ok) {
                              const text = await res.text().catch(() => "");
                              throw new Error(`Failed to move lines (${res.status}) ${text}`);
                            }

                            const result = await res.json();
                            const destLabel = result.targetInvoice?.invoiceNo ?? "target invoice";
                            setMoveExpenseLinesMessage(
                              `Moved ${result.movedLineCount ?? billIds.length} expense(s) to ${destLabel}.`
                            );
                            setSelectedExpenseLineIds(new Set());
                            setMoveExpenseTargetInvoiceId("");
                            // Refresh invoices and bills
                            setProjectInvoices(null);
                            setProjectBills(null);
                          } catch (err: any) {
                            setMoveExpenseLinesMessage(err?.message ?? "Failed to move lines.");
                          } finally {
                            setMoveExpenseLinesBusy(false);
                          }
                        }}
                        style={{
                          padding: "4px 10px",
                          borderRadius: 4,
                          border: "1px solid #1d4ed8",
                          background: "#1d4ed8",
                          color: "#ffffff",
                          fontSize: 11,
                          cursor: moveExpenseLinesBusy ? "wait" : "pointer",
                          fontWeight: 600,
                        }}
                      >
                        {moveExpenseLinesBusy ? "Moving…" : "Move"}
                      </button>
                      <button
                        type="button"
                        onClick={() => {
                          setSelectedExpenseLineIds(new Set());
                          setMoveExpenseTargetInvoiceId("");
                        }}
                        style={{
                          padding: "4px 10px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          background: "#ffffff",
                          fontSize: 11,
                          cursor: "pointer",
                        }}
                      >
                        Clear
                      </button>
                      </div>
                      <div style={{ marginTop: 6, fontSize: 10, color: "#6b7280" }}>
                        Dropdown shows other draft invoices to consolidate into (current Expenses invoice excluded).
                        {otherDraftInvoices.length === 0 && " No other drafts available."}
                      </div>
                    </div>
                    );
                  })()}
                  {moveExpenseLinesMessage && (
                    <div style={{ marginTop: 6, fontSize: 11, color: moveExpenseLinesMessage.includes("fail") || moveExpenseLinesMessage.includes("Failed") ? "#b91c1c" : "#166534" }}>
                      {moveExpenseLinesMessage}
                    </div>
                  )}
                  <div style={{ marginTop: 12 }}>
                    <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
                      <thead>
                        <tr style={{ textAlign: "left", borderBottom: "1px solid #bbf7d0" }}>
                          {expenseInvoice && expenseInvoice.status === "DRAFT" && (
                            <th style={{ padding: "4px 6px", width: 24 }}>
                              <input
                                type="checkbox"
                                checked={selectedExpenseLineIds.size === billableBills.length && billableBills.length > 0}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setSelectedExpenseLineIds(new Set(billableBills.map((b: any) => String(b?.id ?? ""))));
                                  } else {
                                    setSelectedExpenseLineIds(new Set());
                                  }
                                }}
                                style={{ cursor: "pointer" }}
                              />
                            </th>
                          )}
                          <th style={{ padding: "4px 6px" }}>Vendor</th>
                          <th style={{ padding: "4px 6px" }}>Invoice</th>
                          <th style={{ padding: "4px 6px" }}>Description</th>
                          <th style={{ padding: "4px 6px", textAlign: "right" }}>Cost</th>
                          <th style={{ padding: "4px 6px", textAlign: "right" }}>GM%</th>
                          <th style={{ padding: "4px 6px", textAlign: "right" }}>Billable</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[...billableBills]
                          .sort((a: any, b: any) => {
                            // Sort by createdAt descending (newest first)
                            const dateA = new Date(a?.createdAt ?? 0).getTime();
                            const dateB = new Date(b?.createdAt ?? 0).getTime();
                            return dateB - dateA;
                          })
                          .map((b: any) => {
                          const li = Array.isArray(b?.lineItems) ? b.lineItems[0] : null;
                          const cost = Number(b?.totalAmount) || 0;
                          const billable = Number(b?.billableAmount) || 0;
                          const gmPct = billable > 0 ? ((billable - cost) / billable) * 100 : 0;
                          const billId = String(b?.id ?? "");
                          const isSelected = selectedExpenseLineIds.has(billId);
                          
                          // Check if this expense's invoice is paid/locked
                          // Use invoiceLines to find the actual invoice this bill is attached to
                          const invoiceLine = Array.isArray(b?.invoiceLines) ? b.invoiceLines[0] : null;
                          const targetInv = invoiceLine?.invoice ?? null;
                          const isPaid = targetInv && (targetInv.status === "PAID" || targetInv.status === "PARTIALLY_PAID");
                          const isLocked = targetInv && targetInv.status !== "DRAFT";
                          
                          // Row styling based on status
                          const rowBg = isSelected ? "#dbeafe" : isPaid ? "#fef2f2" : undefined;
                          const textColor = isPaid ? "#991b1b" : isLocked ? "#6b7280" : "#166534";
                          
                          return (
                            <tr key={billId || Math.random()} style={{ borderTop: "1px solid #bbf7d0", background: rowBg }}>
                              {expenseInvoice && expenseInvoice.status === "DRAFT" && (
                                <td style={{ padding: "4px 6px" }}>
                                  <input
                                    type="checkbox"
                                    checked={isSelected}
                                    onChange={(e) => {
                                      setSelectedExpenseLineIds((prev) => {
                                        const next = new Set(prev);
                                        if (e.target.checked) {
                                          next.add(billId);
                                        } else {
                                          next.delete(billId);
                                        }
                                        return next;
                                      });
                                    }}
                                    style={{ cursor: "pointer" }}
                                    disabled={isLocked}
                                  />
                                </td>
                              )}
                              <td style={{ padding: "4px 6px", color: textColor }}>{b?.vendorName ?? "—"}</td>
                              <td style={{ padding: "4px 6px", fontSize: 10 }}>
                                {targetInv ? (
                                  <span style={{
                                    padding: "2px 6px",
                                    borderRadius: 4,
                                    background: isPaid ? "#fecaca" : isLocked ? "#e5e7eb" : "#dcfce7",
                                    color: isPaid ? "#991b1b" : isLocked ? "#4b5563" : "#166534",
                                    fontSize: 10,
                                  }}>
                                    {targetInv.invoiceNo ?? "Draft"}
                                  </span>
                                ) : (
                                  <span style={{ color: "#9ca3af" }}>—</span>
                                )}
                              </td>
                              <td style={{ padding: "4px 6px", color: textColor }}>{li?.description ?? "—"}</td>
                              <td style={{ padding: "4px 6px", textAlign: "right", color: textColor }}>{formatMoney(cost)}</td>
                              <td style={{ padding: "4px 6px", textAlign: "right", color: isPaid ? "#991b1b" : "#16a34a" }}>{gmPct.toFixed(1)}%</td>
                              <td style={{ padding: "4px 6px", textAlign: "right", fontWeight: 600, color: textColor }}>{formatMoney(billable)}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            );
          })()}

          {/* Payments */}
          <div
            style={{
              marginTop: 16,
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: paymentsCollapsed ? "none" : "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                gap: 8,
              }}
            >
              <button
                type="button"
                onClick={() => setPaymentsCollapsed((v) => !v)}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  padding: 0,
                  fontSize: 13,
                  fontWeight: 600,
                  color: "#111827",
                  display: "flex",
                  alignItems: "baseline",
                  gap: 8,
                  textAlign: "left",
                }}
              >
                <span style={{ fontFamily: "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace" }}>
                  {paymentsCollapsed ? "▸" : "▾"}
                </span>
                <span>Payments</span>
                {projectPayments && (
                  <span style={{ fontSize: 11, fontWeight: 500, color: "#6b7280" }}>
                    · {projectPaymentsSorted.length} · Total {formatMoney(projectPaymentsTotal)} · Unapplied{" "}
                    {formatMoney(projectPaymentsUnappliedTotal)}
                  </span>
                )}
              </button>

              {!paymentsCollapsed && (
                <button
                  type="button"
                  onClick={() => {
                    setPaymentsMessage(null);
                    setProjectPayments(null);
                  }}
                  disabled={projectPaymentsLoading}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    cursor: projectPaymentsLoading ? "default" : "pointer",
                    fontSize: 12,
                  }}
                >
                  {projectPaymentsLoading ? "Refreshing…" : "Refresh"}
                </button>
              )}
            </div>

            {!paymentsCollapsed && (
              <div style={{ padding: 10, fontSize: 12 }}>
              {paymentsMessage && (
                <div
                  style={{
                    marginBottom: 8,
                    fontSize: 12,
                    color: paymentsMessage.toLowerCase().includes("fail") ? "#b91c1c" : "#4b5563",
                  }}
                >
                  {paymentsMessage}
                </div>
              )}

              {projectPaymentsLoading && (
                <div style={{ color: "#6b7280" }}>Loading payments…</div>
              )}
              {projectPaymentsError && !projectPaymentsLoading && (
                <div style={{ color: "#b91c1c" }}>{projectPaymentsError}</div>
              )}

              {!projectPaymentsLoading &&
                !projectPaymentsError &&
                projectPayments &&
                projectPayments.length === 0 && (
                  <div style={{ color: "#6b7280" }}>No payments recorded yet.</div>
                )}

              {!projectPaymentsLoading &&
                !projectPaymentsError &&
                projectPayments &&
                projectPayments.length > 0 && (
                  <>
                    <div style={{ marginBottom: 8, fontSize: 11, color: "#6b7280" }}>
                      Showing <strong>{projectPaymentsSorted.length}</strong> payments · Total{" "}
                      <strong>{formatMoney(projectPaymentsTotal)}</strong>
                    </div>
                    <div
                      style={{
                        display: "grid",
                        gridTemplateColumns: "repeat(auto-fill, minmax(240px, 1fr))",
                        gap: 8,
                      }}
                    >
                      {projectPaymentsSorted.map((p: any) => {
                      const paidAtLabel = p?.paidAt
                        ? new Date(p.paidAt).toLocaleDateString()
                        : "—";
                      const method = String(p?.method ?? "").trim() || "—";
                      const reference = String(p?.reference ?? "").trim();
                      const note = String(p?.note ?? "").trim();

                      const appliedAmount = Number(p?.appliedAmount ?? 0) || 0;
                      const unappliedAmount = Number(p?.unappliedAmount ?? 0) || 0;
                      const apps: any[] = Array.isArray(p?.applications) ? p.applications : [];

                      const invoiceOptions = (projectInvoices ?? []).filter(
                        (inv: any) => String(inv?.status) !== "VOID",
                      );

                      const paymentId = String(p?.id ?? "");
                      const selectedInvoiceId = applyInvoiceByPaymentId[paymentId] ?? "";
                      const selectedAmountStr = applyAmountByPaymentId[paymentId] ?? "";
                      const applyMsg = applyMessageByPaymentId[paymentId] ?? "";

                      return (
                        <div
                          key={paymentId}
                          style={{
                            flex: "0 0 auto",
                            minWidth: 240,
                            borderRadius: 8,
                            border: "1px solid #e5e7eb",
                            background: "#f9fafb",
                            padding: 8,
                          }}
                        >
                          <div style={{ display: "flex", justifyContent: "space-between", gap: 8 }}>
                            <div style={{ fontWeight: 700 }}>{formatMoney(p?.amount)}</div>
                            <div style={{ fontSize: 11, color: "#6b7280" }}>{paidAtLabel}</div>
                          </div>
                          <div style={{ marginTop: 2, fontSize: 11, color: "#4b5563" }}>
                            {method}
                            {reference ? ` · ${reference}` : ""}
                          </div>

                          <div style={{ marginTop: 6, fontSize: 11, color: "#4b5563" }}>
                            Applied: <strong>{formatMoney(appliedAmount)}</strong> · Unapplied:{" "}
                            <strong>{formatMoney(unappliedAmount)}</strong>
                          </div>

                          {apps.length > 0 && (
                            <div style={{ marginTop: 6, fontSize: 11, color: "#4b5563" }}>
                              <div style={{ fontWeight: 600, marginBottom: 2 }}>Applications</div>
                              {apps.map((a: any) => {
                                const invId = String(a?.invoiceId ?? "").trim();
                                const canRemove = Boolean(invId);
                                const label = a.invoiceNo ?? "(draft)";

                                return (
                                  <div
                                    key={a.id}
                                    style={{ display: "flex", justifyContent: "space-between", gap: 8, alignItems: "center" }}
                                  >
                                    <span>{label}</span>
                                    <span style={{ display: "flex", gap: 8, alignItems: "center" }}>
                                      <span style={{ fontWeight: 600 }}>{formatMoney(a.amount)}</span>
                                      {canRemove && (
                                        <button
                                          type="button"
                                          onClick={async () => {
                                            if (!project) return;
                                            const token = localStorage.getItem("accessToken");
                                            if (!token) {
                                              setPaymentsMessage("Missing access token.");
                                              return;
                                            }

                                            const ok = window.confirm(
                                              `Remove this payment from invoice ${label}?\n\nThis does not delete the payment record; it just unassigns it so you can apply it elsewhere.`,
                                            );
                                            if (!ok) return;

                                            setPaymentsMessage(null);
                                            setApplyMessageByPaymentId((prev) => ({
                                              ...prev,
                                              [paymentId]: `Removing from ${label}…`,
                                            }));

                                            try {
                                              const res = await fetch(
                                                `${API_BASE}/projects/${project.id}/payments/${paymentId}/apply/${invId}`,
                                                {
                                                  method: "DELETE",
                                                  headers: { Authorization: `Bearer ${token}` },
                                                },
                                              );
                                              if (!res.ok) {
                                                const text = await res.text().catch(() => "");
                                                const msg = `Remove failed (${res.status}) ${text}`;
                                                setPaymentsMessage(msg);
                                                setApplyMessageByPaymentId((prev) => ({ ...prev, [paymentId]: msg }));
                                                return;
                                              }

                                              // refresh lists + active invoice if open
                                              setProjectPayments(null);
                                              setProjectInvoices(null);
                                              setFinancialSummary(null);

                                              if (activeInvoice?.id === invId) {
                                                const invRes = await fetch(
                                                  `${API_BASE}/projects/${project.id}/invoices/${invId}`,
                                                  { headers: { Authorization: `Bearer ${token}` } },
                                                );
                                                if (invRes.ok) {
                                                  const json = await invRes.json();
                                                  setActiveInvoice(json);
                                                }
                                              }

                                              setApplyMessageByPaymentId((prev) => ({
                                                ...prev,
                                                [paymentId]: `Removed from ${label}.`,
                                              }));
                                            } catch (err: any) {
                                              const msg = err?.message ?? "Remove failed.";
                                              setPaymentsMessage(msg);
                                              setApplyMessageByPaymentId((prev) => ({ ...prev, [paymentId]: msg }));
                                            }
                                          }}
                                          style={{
                                            padding: "2px 6px",
                                            borderRadius: 6,
                                            border: "1px solid #b91c1c",
                                            background: "#fee2e2",
                                            color: "#991b1b",
                                            fontSize: 11,
                                            cursor: "pointer",
                                            whiteSpace: "nowrap",
                                          }}
                                        >
                                          Remove
                                        </button>
                                      )}
                                    </span>
                                  </div>
                                );
                              })}
                            </div>
                          )}

                          {note && (
                            <div style={{ marginTop: 6, fontSize: 11, color: "#6b7280" }}>
                              {note}
                            </div>
                          )}

                          {applyMsg && (
                            <div
                              style={{
                                marginTop: 6,
                                fontSize: 11,
                                color: applyMsg.toLowerCase().includes("fail") ? "#b91c1c" : "#4b5563",
                              }}
                            >
                              {applyMsg}
                            </div>
                          )}

                          {unappliedAmount > 0 && (
                            <div style={{ marginTop: 8 }}>
                              <div style={{ fontWeight: 600, fontSize: 11, marginBottom: 4 }}>
                                Apply payment
                              </div>

                              {projectInvoicesLoading && (
                                <div style={{ fontSize: 11, color: "#6b7280" }}>Loading invoices…</div>
                              )}

                              {!projectInvoicesLoading && invoiceOptions.length === 0 && (
                                <div style={{ fontSize: 11, color: "#6b7280" }}>
                                  No invoices available to apply to.
                                </div>
                              )}

                              {!projectInvoicesLoading && invoiceOptions.length > 0 && (
                                <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                                  <select
                                    value={selectedInvoiceId}
                                    onChange={(e) => {
                                      const next = e.target.value;
                                      setApplyInvoiceByPaymentId((prev) => ({ ...prev, [paymentId]: next }));
                                      setApplyMessageByPaymentId((prev) => ({ ...prev, [paymentId]: "" }));
                                    }}
                                    style={{
                                      flex: "1 1 180px",
                                      padding: "6px 8px",
                                      borderRadius: 4,
                                      border: "1px solid #d1d5db",
                                      fontSize: 12,
                                    }}
                                  >
                                    <option value="">Select invoice…</option>
                                    {invoiceOptions.map((inv: any) => (
                                      <option key={inv.id} value={inv.id}>
                                        {(inv.invoiceNo ?? "(draft)") +
                                          ` · ${inv.status}` +
                                          ` · Bal ${formatMoney(inv.balanceDue ?? 0)}`}
                                      </option>
                                    ))}
                                  </select>
                                  <input
                                    placeholder={`Amount (max ${formatMoney(unappliedAmount)})`}
                                    value={selectedAmountStr}
                                    onChange={(e) => {
                                      const next = e.target.value;
                                      setApplyAmountByPaymentId((prev) => ({ ...prev, [paymentId]: next }));
                                      setApplyMessageByPaymentId((prev) => ({ ...prev, [paymentId]: "" }));
                                    }}
                                    style={{
                                      width: 140,
                                      padding: "6px 8px",
                                      borderRadius: 4,
                                      border: "1px solid #d1d5db",
                                      fontSize: 12,
                                    }}
                                  />
                                  <button
                                    type="button"
                                    disabled={applySavingPaymentId === paymentId}
                                    onClick={async () => {
                                      if (!project) return;
                                      const token = localStorage.getItem("accessToken");
                                      if (!token) {
                                        setPaymentsMessage("Missing access token.");
                                        setApplyMessageByPaymentId((prev) => ({
                                          ...prev,
                                          [paymentId]: "Apply failed: missing access token.",
                                        }));
                                        return;
                                      }

                                      const invoiceId = (applyInvoiceByPaymentId[paymentId] ?? "").trim();
                                      if (!invoiceId) {
                                        setApplyMessageByPaymentId((prev) => ({
                                          ...prev,
                                          [paymentId]: "Select an invoice to apply to.",
                                        }));
                                        return;
                                      }

                                      const amountRaw = (applyAmountByPaymentId[paymentId] ?? "").trim();
                                      const normalizedAmountRaw = amountRaw.replace(/[$,\s]/g, "");
                                      const amount = Number(normalizedAmountRaw);
                                      if (!Number.isFinite(amount) || amount <= 0) {
                                        setApplyMessageByPaymentId((prev) => ({
                                          ...prev,
                                          [paymentId]: "Apply amount must be a positive number.",
                                        }));
                                        return;
                                      }

                                      setApplySavingPaymentId(paymentId);
                                      setApplyMessageByPaymentId((prev) => ({ ...prev, [paymentId]: "Applying…" }));
                                      setPaymentsMessage(null);
                                      try {
                                        const res = await fetch(
                                          `${API_BASE}/projects/${project.id}/payments/${paymentId}/apply`,
                                          {
                                            method: "POST",
                                            headers: {
                                              "Content-Type": "application/json",
                                              Authorization: `Bearer ${token}`,
                                            },
                                            body: JSON.stringify({ invoiceId, amount }),
                                          },
                                        );
                                        if (!res.ok) {
                                          const text = await res.text().catch(() => "");
                                          const hint =
                                            res.status >= 500 &&
                                            (text.includes("ProjectPaymentApplication") ||
                                              text.toLowerCase().includes("paymentapplication") ||
                                              text.toLowerCase().includes("not migrated"))
                                              ? " Apply requires the payment application migration; run database migrations and restart the API."
                                              : "";
                                          const msg = `Apply failed (${res.status}) ${text}${hint}`.trim();
                                          setPaymentsMessage(msg);
                                          setApplyMessageByPaymentId((prev) => ({ ...prev, [paymentId]: msg }));
                                          return;
                                        }

                                        setProjectPayments(null);
                                        setProjectInvoices(null);
                                        setFinancialSummary(null);

                                        if (activeInvoice?.id === invoiceId) {
                                          const invRes = await fetch(
                                            `${API_BASE}/projects/${project.id}/invoices/${invoiceId}`,
                                            { headers: { Authorization: `Bearer ${token}` } },
                                          );
                                          if (invRes.ok) {
                                            const json = await invRes.json();
                                            setActiveInvoice(json);
                                          }
                                        }

                                        setApplyInvoiceByPaymentId((prev) => ({ ...prev, [paymentId]: "" }));
                                        setApplyAmountByPaymentId((prev) => ({ ...prev, [paymentId]: "" }));
                                        setApplyMessageByPaymentId((prev) => ({ ...prev, [paymentId]: "Payment applied." }));
                                        setPaymentsMessage("Payment applied.");
                                      } catch (err: any) {
                                        const msg = err?.message ?? "Apply failed.";
                                        setPaymentsMessage(msg);
                                        setApplyMessageByPaymentId((prev) => ({ ...prev, [paymentId]: msg }));
                                      } finally {
                                        setApplySavingPaymentId(null);
                                      }
                                    }}
                                    style={{
                                      padding: "6px 10px",
                                      borderRadius: 4,
                                      border: "1px solid #0f172a",
                                      background: "#0f172a",
                                      color: "#f9fafb",
                                      fontSize: 12,
                                      cursor: applySavingPaymentId === paymentId ? "default" : "pointer",
                                    }}
                                  >
                                    {applySavingPaymentId === paymentId ? "Applying…" : "Apply"}
                                  </button>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      );
                      })}
                    </div>
                  </>
                )}

              <div style={{ marginTop: 10 }}>
                <div style={{ fontWeight: 600, marginBottom: 6 }}>Record payment</div>
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap", alignItems: "center" }}>
                  <input
                    placeholder="Amount"
                    value={payAmount}
                    onChange={e => setPayAmount(e.target.value)}
                    style={{
                      width: 120,
                      padding: "6px 8px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                    }}
                  />
                  <select
                    value={payMethod}
                    onChange={e => setPayMethod(e.target.value)}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                    }}
                  >
                    <option value="WIRE">WIRE</option>
                    <option value="ACH">ACH</option>
                    <option value="CHECK">CHECK</option>
                    <option value="OTHER">OTHER</option>
                  </select>
                  <input
                    type="date"
                    value={payPaidAt}
                    onChange={e => setPayPaidAt(e.target.value)}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                    }}
                  />
                  <input
                    placeholder="Reference"
                    value={payReference}
                    onChange={e => setPayReference(e.target.value)}
                    style={{
                      width: 160,
                      padding: "6px 8px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                    }}
                  />
                  <input
                    placeholder="Note"
                    value={payNote}
                    onChange={e => setPayNote(e.target.value)}
                    style={{
                      flex: "1 1 200px",
                      padding: "6px 8px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                    }}
                  />
                  <button
                    type="button"
                    disabled={recordPaymentSaving}
                    onClick={async () => {
                      if (!project) return;
                      const token = localStorage.getItem("accessToken");
                      if (!token) {
                        setPaymentsMessage("Missing access token.");
                        return;
                      }

                      const amountRaw = String(payAmount ?? "").trim();
                      const normalizedAmountRaw = amountRaw.replace(/[$,\s]/g, "");
                      const amount = Number(normalizedAmountRaw);
                      if (!Number.isFinite(amount) || amount <= 0) {
                        setPaymentsMessage("Payment amount must be a positive number.");
                        return;
                      }

                      setRecordPaymentSaving(true);
                      setPaymentsMessage(null);
                      try {
                        const res = await fetch(`${API_BASE}/projects/${project.id}/payments`, {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({
                            amount,
                            method: payMethod,
                            paidAt: payPaidAt || undefined,
                            reference: payReference.trim() || undefined,
                            note: payNote.trim() || undefined,
                          }),
                        });
                        if (!res.ok) {
                          const text = await res.text().catch(() => "");
                          const hint =
                            text.includes("billing is not initialized") ||
                            text.includes("billing tables") ||
                            text.includes("ProjectPayment")
                              ? " Run DB migrations + prisma generate, then restart the API."
                              : "";
                          setPaymentsMessage(`Record payment failed (${res.status}) ${text}${hint}`);
                          return;
                        }

                        setProjectPayments(null);
                        setFinancialSummary(null);

                        setPayAmount("");
                        setPayPaidAt("");
                        setPayReference("");
                        setPayNote("");
                        setPaymentsMessage("Payment recorded.");
                      } catch (err: any) {
                        setPaymentsMessage(err?.message ?? "Record payment failed.");
                      } finally {
                        setRecordPaymentSaving(false);
                      }
                    }}
                    style={{
                      padding: "6px 10px",
                      borderRadius: 4,
                      border: "1px solid #0f172a",
                      background: recordPaymentSaving ? "#e5e7eb" : "#0f172a",
                      color: recordPaymentSaving ? "#4b5563" : "#f9fafb",
                      fontSize: 12,
                      cursor: recordPaymentSaving ? "default" : "pointer",
                    }}
                  >
                    {recordPaymentSaving ? "Recording…" : "Record"}
                  </button>
                </div>
              </div>
              </div>
            )}
          </div>

          {/* Payroll & Workforce roster */}
          <div
            style={{
              marginTop: 10,
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
              }}
            >
              Payroll &amp; Workforce
            </div>
            <div style={{ padding: 10, fontSize: 12 }}>
              <p style={{ marginTop: 0, marginBottom: 8, color: "#4b5563" }}>
                This roster shows everyone who has recorded payroll on this project
                (including subs and 1099s), based on Certified Payroll and LCP data.
                It does not grant them login access.
              </p>

              {payrollLoading && (
                <p style={{ fontSize: 12, color: "#6b7280" }}>
                  Loading payroll roster…
                </p>
              )}

              {payrollError && !payrollLoading && (
                <p style={{ fontSize: 12, color: "#b91c1c" }}>{payrollError}</p>
              )}

              {!payrollLoading &&
                !payrollError &&
                (!payrollEmployees || payrollEmployees.length === 0) && (
                  <p style={{ fontSize: 12, color: "#6b7280" }}>
                    No payroll records found yet for this project.
                  </p>
                )}

              {!payrollLoading && !payrollError && payrollEmployees && payrollEmployees.length > 0 && (
                <div style={{ maxHeight: "60vh", overflow: "auto" }}>
                  <table
                    style={{
                      width: "100%",
                      borderCollapse: "collapse",
                      fontSize: 12,
                    }}
                  >
                    <thead>
                      <tr style={{ backgroundColor: "#f9fafb" }}>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>Name</th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>Role / Class</th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>SSN (last 4)</th>
                        <th style={{ textAlign: "right", padding: "6px 8px" }}>Total Hours</th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>First Week</th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>Last Week</th>
                      </tr>
                    </thead>
                    <tbody>
                      {payrollEmployees.map((emp, idx) => {
                        const name = [emp.firstName ?? "", emp.lastName ?? ""]
                          .map(s => s.trim())
                          .filter(Boolean)
                          .join(" ") || "(Unnamed)";
                        const firstWeek = emp.firstWeekEnd
                          ? new Date(emp.firstWeekEnd).toLocaleDateString()
                          : "—";
                        const lastWeek = emp.lastWeekEnd
                          ? new Date(emp.lastWeekEnd).toLocaleDateString()
                          : "—";
                        const hasDetails = !!emp.employeeId;
                        const detailHref = hasDetails
                          ? `/projects/${project.id}/payroll/${encodeURIComponent(
                              emp.employeeId as string,
                            )}`
                          : undefined;
                        return (
                          <tr key={`${emp.employeeId ?? "emp"}-${idx}`}>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderTop: "1px solid #e5e7eb",
                              }}
                            >
                              {hasDetails ? (
                                <a
                                  href={detailHref}
                                  style={{ color: "#2563eb", textDecoration: "none" }}
                                >
                                  {name}
                                </a>
                              ) : (
                                name
                              )}
                            </td>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderTop: "1px solid #e5e7eb",
                                color: "#4b5563",
                              }}
                            >
                              {emp.classCode || "—"}
                            </td>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderTop: "1px solid #e5e7eb",
                                color: "#4b5563",
                              }}
                            >
                              {emp.ssnLast4 ? `***-**-${emp.ssnLast4}` : "—"}
                            </td>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderTop: "1px solid #e5e7eb",
                                textAlign: "right",
                              }}
                            >
                              {emp.totalHours.toFixed(2)}
                            </td>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderTop: "1px solid #e5e7eb",
                              }}
                            >
                              {firstWeek}
                            </td>
                            <td
                              style={{
                                padding: "6px 8px",
                                borderTop: "1px solid #e5e7eb",
                              }}
                            >
                              {lastWeek}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>

            </>
          )}

          {/* Invoices */}
          <div
            style={{
              marginTop: 16,
              borderRadius: 8,
              border: "1px solid #e5e7eb",
              background: "#ffffff",
            }}
          >
            <div
              style={{
                padding: "6px 10px",
                borderBottom: "1px solid #e5e7eb",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                gap: 8,
              }}
            >
              <span>Invoices</span>
              <button
                type="button"
                onClick={() => {
                  setInvoiceMessage(null);
                  setProjectInvoices(null);
                  setActiveInvoice(null);
                }}
                disabled={projectInvoicesLoading}
                style={{
                  padding: "4px 8px",
                  borderRadius: 6,
                  border: "1px solid #d1d5db",
                  background: "#ffffff",
                  cursor: projectInvoicesLoading ? "default" : "pointer",
                  fontSize: 12,
                }}
              >
                {projectInvoicesLoading ? "Refreshing…" : "Refresh"}
              </button>
            </div>

            <div style={{ padding: 10, fontSize: 12 }}>
              {invoiceMessage && (
                <div
                  style={{
                    marginBottom: 8,
                    fontSize: 12,
                    color: invoiceMessage.toLowerCase().includes("fail") ? "#b91c1c" : "#4b5563",
                  }}
                >
                  {invoiceMessage}
                </div>
              )}

              <div style={{ display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
                <button
                  type="button"
                  onClick={async () => {
                    if (!project) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      setInvoiceMessage("Missing access token.");
                      return;
                    }

                    setInvoiceMessage(null);
                    setActiveInvoiceLoading(true);
                    setActiveInvoiceError(null);

                    try {
                      const res = await fetch(`${API_BASE}/projects/${project.id}/invoices/draft`, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          Authorization: `Bearer ${token}`,
                        },
                        body: JSON.stringify({}),
                      });

                      if (!res.ok) {
                        const text = await res.text().catch(() => "");
                        throw new Error(`Failed to open draft invoice (${res.status}) ${text}`);
                      }

                      const json: any = await res.json();

                      if (!invoiceFullscreen) {
                        // Navigate in the same tab into full-screen invoice mode.
                        router.push(
                          `/projects/${project.id}?tab=FINANCIAL&invoiceFullscreen=1&invoiceId=${json.id}`,
                        );
                      }

                      // Keep local state in sync so the invoice renders immediately.
                      setActiveInvoice(json);
                      setProjectInvoices(null);
                    } catch (err: any) {
                      setActiveInvoiceError(err?.message ?? "Failed to open draft invoice.");
                    } finally {
                      setActiveInvoiceLoading(false);
                    }
                  }}
                  style={{
                    padding: "6px 10px",
                    borderRadius: 4,
                    border: "1px solid #0f172a",
                    backgroundColor: "#0f172a",
                    color: "#f9fafb",
                    fontSize: 12,
                    cursor: "pointer",
                  }}
                >
                  Open living invoice (draft)
                </button>

                {/* Status filter radio bar */}
                <div
                  style={{
                    display: "inline-flex",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    overflow: "hidden",
                  }}
                >
                  {(["DRAFT", "ISSUED", "PARTIALLY_PAID", "PAID", "VOID"] as const).map((status, idx) => {
                    const isActive = invoiceStatusFilters.has(status);
                    const label = status === "PARTIALLY_PAID" ? "Partial" : status.charAt(0) + status.slice(1).toLowerCase();
                    return (
                      <button
                        key={status}
                        type="button"
                        onClick={() => {
                          setInvoiceStatusFilters((prev) => {
                            const next = new Set(prev);
                            if (next.has(status)) {
                              next.delete(status);
                            } else {
                              next.add(status);
                            }
                            return next;
                          });
                        }}
                        style={{
                          padding: "4px 10px",
                          border: "none",
                          borderLeft: idx > 0 ? "1px solid #d1d5db" : "none",
                          backgroundColor: isActive ? "#2563eb" : "#f9fafb",
                          color: isActive ? "#ffffff" : "#374151",
                          fontSize: 11,
                          cursor: "pointer",
                          fontWeight: isActive ? 500 : 400,
                        }}
                      >
                        {label}
                      </button>
                    );
                  })}
                </div>

                {activeInvoiceLoading && (
                  <span style={{ fontSize: 12, color: "#6b7280" }}>Loading invoice…</span>
                )}
                {activeInvoiceError && (
                  <span style={{ fontSize: 12, color: "#b91c1c" }}>{activeInvoiceError}</span>
                )}

                {/* Flexible spacer */}
                <div style={{ flex: 1 }} />

                <button
                  type="button"
                  onClick={async () => {
                    if (!project) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      setInvoiceMessage("Missing access token.");
                      return;
                    }

                    const ok = window.confirm(
                      "Create a new draft invoice?\n\nThis will create a separate draft even if another draft exists.",
                    );
                    if (!ok) return;

                    setInvoiceMessage(null);
                    setActiveInvoiceLoading(true);
                    setActiveInvoiceError(null);

                    try {
                      const res = await fetch(`${API_BASE}/projects/${project.id}/invoices/draft`, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          Authorization: `Bearer ${token}`,
                        },
                        body: JSON.stringify({ forceNew: true }),
                      });

                      if (!res.ok) {
                        const text = await res.text().catch(() => "");
                        throw new Error(`Failed to create draft invoice (${res.status}) ${text}`);
                      }

                      const json: any = await res.json();

                      if (!invoiceFullscreen) {
                        // Navigate in the same tab into full-screen invoice mode.
                        router.push(
                          `/projects/${project.id}?tab=FINANCIAL&invoiceFullscreen=1&invoiceId=${json.id}`,
                        );
                      }

                      setActiveInvoice(json);
                      setProjectInvoices(null);
                      setInvoiceMessage("New draft invoice created.");
                    } catch (err: any) {
                      setActiveInvoiceError(err?.message ?? "Failed to create draft invoice.");
                    } finally {
                      setActiveInvoiceLoading(false);
                    }
                  }}
                  style={{
                    padding: "6px 10px",
                    borderRadius: 4,
                    border: "1px solid #2563eb",
                    backgroundColor: "#eff6ff",
                    color: "#1d4ed8",
                    fontSize: 12,
                    cursor: "pointer",
                  }}
                >
                  New invoice
                </button>
              </div>

              <div style={{ marginTop: 10 }}>
                {projectInvoicesLoading && (
                  <div style={{ color: "#6b7280" }}>Loading invoices…</div>
                )}
                {projectInvoicesError && !projectInvoicesLoading && (
                  <div style={{ color: "#b91c1c" }}>{projectInvoicesError}</div>
                )}

                {!projectInvoicesLoading &&
                  !projectInvoicesError &&
                  projectInvoices &&
                  projectInvoices.length === 0 && (
                    <div style={{ color: "#6b7280" }}>No invoices yet.</div>
                  )}

                {!projectInvoicesLoading &&
                  !projectInvoicesError &&
                  projectInvoices &&
                  projectInvoices.length > 0 &&
                  projectInvoices.filter((inv: any) => invoiceStatusFilters.has(inv.status)).length === 0 && (
                    <div style={{ color: "#6b7280" }}>No invoices match the selected filters.</div>
                  )}

                {!projectInvoicesLoading &&
                  !projectInvoicesError &&
                  projectInvoices &&
                  projectInvoices.length > 0 &&
                  projectInvoices.filter((inv: any) => invoiceStatusFilters.has(inv.status)).length > 0 && (
                    <div style={{ maxHeight: invoiceFullscreen ? "45vh" : 240, overflow: "auto" }}>
                      <table
                        style={{
                          width: "100%",
                          borderCollapse: "collapse",
                          fontSize: 12,
                        }}
                      >
                        <thead>
                          <tr style={{ backgroundColor: "#f9fafb" }}>
                            <th style={{ textAlign: "left", padding: "6px 8px" }}>Invoice</th>
                            <th style={{ textAlign: "left", padding: "6px 8px" }}>Type</th>
                            <th style={{ textAlign: "left", padding: "6px 8px" }}>Status</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}>Total</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}>Paid</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}>Balance</th>
                            <th style={{ textAlign: "left", padding: "6px 8px" }}>Issued</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}></th>
                          </tr>
                        </thead>
                        <tbody>
                          {projectInvoices
                            .filter((inv: any) => invoiceStatusFilters.has(inv.status))
                            .sort((a: any, b: any) => {
                              // Sort by createdAt descending (newest first)
                              const dateA = new Date(a.createdAt ?? 0).getTime();
                              const dateB = new Date(b.createdAt ?? 0).getTime();
                              return dateB - dateA;
                            })
                            .map((inv: any) => (
                            <tr
                              key={inv.id}
                              style={{ cursor: "pointer" }}
                              onClick={async () => {
                                console.log("[Row Click] Clicked invoice:", inv.id, inv.status);
                                const token = localStorage.getItem("accessToken");
                                if (!token) {
                                  setInvoiceMessage("Missing access token.");
                                  return;
                                }

                                // Start loading the invoice immediately
                                setInvoiceMessage(null);
                                setActiveInvoiceLoading(true);
                                setActiveInvoiceError(null);
                                invoiceLoadedIdRef.current = inv.id;

                                try {
                                  const res = await fetch(
                                    `${API_BASE}/projects/${project.id}/invoices/${inv.id}`,
                                    { headers: { Authorization: `Bearer ${token}` } },
                                  );
                                  if (!res.ok) {
                                    const text = await res.text().catch(() => "");
                                    throw new Error(
                                      `Failed to load invoice (${res.status}) ${text}`,
                                    );
                                  }
                                  const json: any = await res.json();
                                  // DEBUG: Show what we loaded
                                  setInvoiceMessage(`Loaded invoice: ${json?.id} status=${json?.status}`);
                                  setActiveInvoice(json);

                                  // Navigate to fullscreen AFTER successfully loading
                                  if (!invoiceFullscreen) {
                                    router.push(
                                      `/projects/${project.id}?tab=FINANCIAL&invoiceFullscreen=1&invoiceId=${inv.id}`,
                                      { scroll: false },
                                    );
                                  }
                                } catch (err: any) {
                                  setActiveInvoiceError(err?.message ?? "Failed to load invoice.");
                                  setInvoiceMessage(`ERROR: ${err?.message}`);
                                  invoiceLoadedIdRef.current = null;
                                } finally {
                                  setActiveInvoiceLoading(false);
                                }
                              }}
                            >
                              <td
                                style={{
                                  padding: "6px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  fontWeight: inv.status === "DRAFT" ? 600 : 400,
                                }}
                              >
                                {/* Inline editable invoice number for DRAFT invoices (Admin/Owner only) */}
                                {inv.status === "DRAFT" &&
                                  project &&
                                  (project.userRole === "OWNER" || project.userRole === "ADMIN") ? (
                                  editingInvoiceNoId === inv.id ? (
                                    <input
                                      type="text"
                                      value={editingInvoiceNoValue}
                                      onChange={(e) => setEditingInvoiceNoValue(e.target.value)}
                                      onBlur={async () => {
                                        // Save on blur
                                        const token = localStorage.getItem("accessToken");
                                        if (token && project) {
                                          try {
                                            const res = await fetch(
                                              `${API_BASE}/projects/${project.id}/invoices/${inv.id}`,
                                              {
                                                method: "PATCH",
                                                headers: {
                                                  "Content-Type": "application/json",
                                                  Authorization: `Bearer ${token}`,
                                                },
                                                body: JSON.stringify({ invoiceNo: editingInvoiceNoValue || null }),
                                              },
                                            );
                                            if (res.ok) {
                                              // Update local state
                                              setProjectInvoices((prev) =>
                                                prev?.map((i) =>
                                                  i.id === inv.id ? { ...i, invoiceNo: editingInvoiceNoValue || null } : i
                                                ) ?? null
                                              );
                                            }
                                          } catch {
                                            // ignore
                                          }
                                        }
                                        setEditingInvoiceNoId(null);
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === "Enter") {
                                          (e.target as HTMLInputElement).blur();
                                        } else if (e.key === "Escape") {
                                          setEditingInvoiceNoId(null);
                                        }
                                      }}
                                      onClick={(e) => e.stopPropagation()}
                                      autoFocus
                                      style={{
                                        width: 80,
                                        padding: "2px 4px",
                                        fontSize: 12,
                                        border: "1px solid #2563eb",
                                        borderRadius: 3,
                                        outline: "none",
                                      }}
                                      placeholder="(draft)"
                                    />
                                  ) : (
                                    <span
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setEditingInvoiceNoId(inv.id);
                                        setEditingInvoiceNoValue(inv.invoiceNo ?? "");
                                      }}
                                      style={{
                                        cursor: "text",
                                        borderBottom: "1px dashed #9ca3af",
                                        paddingBottom: 1,
                                      }}
                                      title="Click to edit invoice number"
                                    >
                                      {inv.invoiceNo ?? "(draft)"}
                                    </span>
                                  )
                                ) : (
                                  <span
                                    onClick={async (e) => {
                                      // Explicit click handler for non-draft invoice numbers
                                      console.log("[Invoice Number Click] Clicked:", inv.id, inv.status);
                                      e.stopPropagation();
                                      const token = localStorage.getItem("accessToken");
                                      if (!token) {
                                        setInvoiceMessage("Missing access token.");
                                        return;
                                      }
                                      setInvoiceMessage(null);
                                      setActiveInvoiceLoading(true);
                                      setActiveInvoiceError(null);
                                      invoiceLoadedIdRef.current = inv.id;
                                      try {
                                        const res = await fetch(
                                          `${API_BASE}/projects/${project.id}/invoices/${inv.id}`,
                                          { headers: { Authorization: `Bearer ${token}` } },
                                        );
                                        if (!res.ok) {
                                          const text = await res.text().catch(() => "");
                                          throw new Error(`Failed to load invoice (${res.status}) ${text}`);
                                        }
                                        const json: any = await res.json();
                                        setActiveInvoice(json);
                                        // Navigate to fullscreen AFTER successfully loading
                                        if (!invoiceFullscreen) {
                                          router.push(
                                            `/projects/${project.id}?tab=FINANCIAL&invoiceFullscreen=1&invoiceId=${inv.id}`,
                                            { scroll: false },
                                          );
                                        }
                                      } catch (err: any) {
                                        setActiveInvoiceError(err?.message ?? "Failed to load invoice.");
                                        invoiceLoadedIdRef.current = null;
                                      } finally {
                                        setActiveInvoiceLoading(false);
                                      }
                                    }}
                                    style={{ cursor: "pointer", color: "#2563eb" }}
                                    title="Click to view invoice"
                                  >
                                    {inv.invoiceNo ?? "(draft)"}
                                  </span>
                                )}
                              </td>
                              <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", fontSize: 11 }}>
                                <span style={{
                                  padding: "2px 6px",
                                  borderRadius: 4,
                                  background: inv.category === "EXPENSE" ? "#dcfce7" : inv.category === "PETL" ? "#dbeafe" : "#f3f4f6",
                                  color: inv.category === "EXPENSE" ? "#166534" : inv.category === "PETL" ? "#1d4ed8" : "#374151",
                                }}>
                                  {inv.category === "EXPENSE" ? "Expenses" : inv.category === "PETL" ? "Progress" : inv.category ?? "—"}
                                </span>
                              </td>
                              <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                {inv.status}
                              </td>
                              <td
                                style={{
                                  padding: "6px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  textAlign: "right",
                                }}
                              >
                                {(inv.totalAmount ?? 0).toLocaleString(undefined, {
                                  maximumFractionDigits: 2,
                                })}
                              </td>
                              <td
                                style={{
                                  padding: "6px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  textAlign: "right",
                                }}
                              >
                                {(inv.paidAmount ?? 0).toLocaleString(undefined, {
                                  maximumFractionDigits: 2,
                                })}
                              </td>
                              <td
                                style={{
                                  padding: "6px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  textAlign: "right",
                                }}
                              >
                                {(inv.balanceDue ?? 0).toLocaleString(undefined, {
                                  maximumFractionDigits: 2,
                                })}
                              </td>
                              <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                {inv.issuedAt ? new Date(inv.issuedAt).toLocaleDateString() : "—"}
                              </td>
                              <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                                {inv.status === "DRAFT" && (inv.totalAmount ?? 0) === 0 && (
                                  <button
                                    type="button"
                                    onClick={async (e) => {
                                      e.stopPropagation();
                                      if (!project) return;
                                      const ok = window.confirm(
                                        "Delete this empty draft invoice?\n\nThis action cannot be undone.",
                                      );
                                      if (!ok) return;

                                      const token = localStorage.getItem("accessToken");
                                      if (!token) {
                                        setInvoiceMessage("Missing access token.");
                                        return;
                                      }
                                      setInvoiceMessage(null);
                                      try {
                                        const res = await fetch(
                                          `${API_BASE}/projects/${project.id}/invoices/${inv.id}`,
                                          {
                                            method: "DELETE",
                                            headers: {
                                              Authorization: `Bearer ${token}`,
                                            },
                                          },
                                        );
                                        if (!res.ok) {
                                          const text = await res.text().catch(() => "");
                                          setInvoiceMessage(
                                            `Delete failed (${res.status}) ${text}`,
                                          );
                                          return;
                                        }
                                        setProjectInvoices(null);
                                        setInvoiceMessage("Draft invoice deleted.");
                                      } catch (err: any) {
                                        setInvoiceMessage(err?.message ?? "Delete failed.");
                                      }
                                    }}
                                    style={{
                                      padding: "3px 8px",
                                      borderRadius: 4,
                                      border: "1px solid #dc2626",
                                      background: "#fef2f2",
                                      color: "#b91c1c",
                                      fontSize: 11,
                                      cursor: "pointer",
                                      whiteSpace: "nowrap",
                                    }}
                                  >
                                    Delete $0 Draft
                                  </button>
                                )}
                                {/* Unlock button for issued invoices with $0 paid (Admin/Owner only) */}
                                {inv.status !== "DRAFT" &&
                                  inv.status !== "VOID" &&
                                  (inv.paidAmount ?? 0) === 0 &&
                                  project &&
                                  (project.userRole === "OWNER" || project.userRole === "ADMIN") && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setInvoiceUnlockTarget(inv);
                                      setInvoiceUnlockReason("");
                                      setInvoiceUnlockModalOpen(true);
                                    }}
                                    style={{
                                      padding: "3px 8px",
                                      borderRadius: 4,
                                      border: "1px solid #2563eb",
                                      background: "#eff6ff",
                                      color: "#1d4ed8",
                                      fontSize: 11,
                                      cursor: "pointer",
                                      whiteSpace: "nowrap",
                                    }}
                                  >
                                    Unlock
                                  </button>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
              </div>

              {activeInvoice && (
                <div
                  data-print-scope="invoice"
                  style={{
                    marginTop: 16,
                    padding: 16,
                    borderRadius: 8,
                    border: activeInvoice.status === "DRAFT" ? "2px solid #3b82f6" : "1px solid #e5e7eb",
                    background: activeInvoice.status === "DRAFT" ? "#eff6ff" : "#ffffff",
                    boxShadow: activeInvoice.status === "DRAFT" ? "0 4px 12px rgba(59, 130, 246, 0.15)" : "none",
                  }}
                >
                  <div style={{ display: "flex", justifyContent: "space-between", gap: 12 }}>
                    <div>
                      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                        <img
                          src="/nexus-logo-mark.png"
                          alt="Nexus"
                          style={{ height: 24, width: "auto" }}
                        />
                        <div style={{ fontWeight: 600, fontSize: 13 }}>
                          {activeInvoice.invoiceNo ?? "Draft invoice"}
                        </div>
                      </div>
                      <div style={{ fontSize: 12, color: "#6b7280" }}>
                        Status: {activeInvoice.status}
                        {activeInvoice.issuedAt
                          ? ` · Issued ${new Date(activeInvoice.issuedAt).toLocaleDateString()}`
                          : ""}
                        {(activeInvoice.revisionNumber ?? 1) > 1 && (
                          <span style={{ marginLeft: 8 }}>· Revision {activeInvoice.revisionNumber}</span>
                        )}
                      </div>
                      {/* Show unlock history if present */}
                      {Array.isArray(activeInvoice.unlockHistory) && activeInvoice.unlockHistory.length > 0 && (
                        <div
                          style={{
                            marginTop: 4,
                            padding: "6px 10px",
                            background: "#fef3c7",
                            borderRadius: 6,
                            fontSize: 11,
                            color: "#92400e",
                          }}
                        >
                          <strong>Unlock history:</strong>
                          {activeInvoice.unlockHistory.map((h: any, i: number) => (
                            <div key={i} style={{ marginTop: 2 }}>
                              Rev {(h.fromRevision ?? 0) + 1} → {(h.fromRevision ?? 0) + 2}:
                              {h.unlockedAt ? ` ${new Date(h.unlockedAt).toLocaleString()}` : ""}
                              {h.unlockedByEmail ? ` by ${h.unlockedByEmail}` : ""}
                              {h.reason ? ` — "${h.reason}"` : ""}
                            </div>
                          ))}
                        </div>
                      )}

                      {invoiceFullscreen && (
                        <div className="no-print" style={{ marginTop: 8, display: "flex", gap: 8, flexWrap: "wrap" }}>
                          {/* Lock/Unlock toggle for issued invoices (Admin/Owner only) */}
                          {activeInvoice.status !== "DRAFT" &&
                            activeInvoice.status !== "VOID" &&
                            project &&
                            (project.userRole === "OWNER" || project.userRole === "ADMIN") && (
                            <div
                              style={{
                                display: "inline-flex",
                                alignItems: "center",
                                gap: 8,
                                padding: "4px 10px",
                                borderRadius: 6,
                                border: "1px solid #e5e7eb",
                                background: "#f9fafb",
                              }}
                            >
                              <span style={{ fontSize: 11, color: "#6b7280" }}>Invoice:</span>
                              <button
                                type="button"
                                onClick={() => setInvoiceEditUnlocked(false)}
                                style={{
                                  padding: "3px 10px",
                                  borderRadius: 4,
                                  border: !invoiceEditUnlocked ? "1px solid #dc2626" : "1px solid #d1d5db",
                                  background: !invoiceEditUnlocked ? "#fef2f2" : "#ffffff",
                                  color: !invoiceEditUnlocked ? "#b91c1c" : "#6b7280",
                                  fontSize: 11,
                                  fontWeight: !invoiceEditUnlocked ? 600 : 400,
                                  cursor: "pointer",
                                }}
                              >
                                🔒 Locked
                              </button>
                              <button
                                type="button"
                                onClick={() => {
                                  if ((activeInvoice.paidAmount ?? 0) > 0) {
                                    setInvoiceMessage("Cannot unlock: invoice has payments applied. Void the invoice to make changes.");
                                    return;
                                  }
                                  setInvoiceEditUnlocked(true);
                                }}
                                disabled={(activeInvoice.paidAmount ?? 0) > 0}
                                title={(activeInvoice.paidAmount ?? 0) > 0 ? "Cannot unlock: payments have been applied" : "Unlock for editing"}
                                style={{
                                  padding: "3px 10px",
                                  borderRadius: 4,
                                  border: invoiceEditUnlocked ? "1px solid #16a34a" : "1px solid #d1d5db",
                                  background: invoiceEditUnlocked ? "#dcfce7" : (activeInvoice.paidAmount ?? 0) > 0 ? "#f3f4f6" : "#ffffff",
                                  color: invoiceEditUnlocked ? "#166534" : (activeInvoice.paidAmount ?? 0) > 0 ? "#9ca3af" : "#6b7280",
                                  fontSize: 11,
                                  fontWeight: invoiceEditUnlocked ? 600 : 400,
                                  cursor: (activeInvoice.paidAmount ?? 0) > 0 ? "not-allowed" : "pointer",
                                }}
                              >
                                🔓 Unlocked
                              </button>
                              {(activeInvoice.paidAmount ?? 0) > 0 && (
                                <span style={{ fontSize: 10, color: "#b91c1c" }}>
                                  (has payments)
                                </span>
                              )}
                            </div>
                          )}

                          <button
                            type="button"
                            onClick={() => {
                              setInvoicePrintLayout("KEEP");
                              setInvoicePrintGroups("KEEP");
                              setInvoicePrintDialogOpen(true);
                            }}
                            style={{
                              padding: "6px 10px",
                              borderRadius: 6,
                              border: "1px solid #0f172a",
                              background: "#0f172a",
                              color: "#f9fafb",
                              fontSize: 12,
                              cursor: "pointer",
                            }}
                          >
                            Print / Save PDF
                          </button>

                          {(activeInvoice.status === "DRAFT" || invoiceEditUnlocked) && (
                            <>
                              <button
                                type="button"
                                onClick={async () => {
                                  if (!project || !activeInvoice?.id) return;
                                  const token = localStorage.getItem("accessToken");
                                  if (!token) {
                                    setInvoiceMessage("Missing access token.");
                                    return;
                                  }

                                  setInvoiceMessage("Syncing from PETL...");
                                  try {
                                    const res = await fetch(
                                      `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/sync-from-petl`,
                                      {
                                        method: "POST",
                                        headers: {
                                          Authorization: `Bearer ${token}`,
                                          "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({}),
                                      },
                                    );
                                    if (!res.ok) {
                                      const text = await res.text().catch(() => "");
                                      setInvoiceMessage(`Sync failed (${res.status}) ${text}`);
                                      return;
                                    }
                                    // Reload the invoice to show updated line items
                                    const invRes = await fetch(
                                      `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}`,
                                      { headers: { Authorization: `Bearer ${token}` } },
                                    );
                                    if (invRes.ok) {
                                      const invJson = await invRes.json();
                                      setActiveInvoice(invJson);
                                      setInvoiceMessage("Invoice synced from PETL successfully.");
                                    } else {
                                      setInvoiceMessage("Synced, but failed to reload invoice.");
                                    }
                                  } catch (err: any) {
                                    setInvoiceMessage(err?.message ?? "Sync failed.");
                                  }
                                }}
                                style={{
                                  padding: "6px 10px",
                                  borderRadius: 6,
                                  border: "1px solid #2563eb",
                                  background: "#eff6ff",
                                  color: "#1d4ed8",
                                  fontSize: 12,
                                  cursor: "pointer",
                                }}
                              >
                                Sync from PETL
                              </button>
                              <button
                                type="button"
                                onClick={async () => {
                                  if (!project || !activeInvoice?.id) return;
                                  const token = localStorage.getItem("accessToken");
                                  if (!token) {
                                    setInvoiceMessage("Missing access token.");
                                    return;
                                  }

                                  setInvoiceApplyModalOpen(true);
                                  setInvoiceApplySources(null);
                                  setInvoiceApplySourcesLoading(true);
                                  setInvoiceApplySourcesError(null);
                                  setInvoiceApplySelectedSourceId("");
                                  setInvoiceApplyAmount("");

                                try {
                                  const res = await fetch(
                                    `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/applications/sources`,
                                    {
                                      headers: {
                                        Authorization: `Bearer ${token}`,
                                      },
                                    },
                                  );
                                  if (!res.ok) {
                                    const text = await res.text().catch(() => "");
                                    setInvoiceApplySourcesError(
                                      `Failed to load deposit/credit invoices (${res.status}) ${text}`,
                                    );
                                    return;
                                  }
                                  const json: any = await res.json().catch(() => []);
                                  setInvoiceApplySources(Array.isArray(json) ? json : []);
                                } catch (err: any) {
                                  setInvoiceApplySourcesError(err?.message ?? "Failed to load deposit/credit invoices.");
                                } finally {
                                  setInvoiceApplySourcesLoading(false);
                                }
                              }}
                              style={{
                                padding: "6px 10px",
                                borderRadius: 6,
                                border: "1px solid #d1d5db",
                                background: "#ffffff",
                                color: "#111827",
                                fontSize: 12,
                                cursor: "pointer",
                              }}
                            >
                              Apply deposit/credit
                            </button>
                            </>
                          )}

                          {/* Void button for issued/locked invoices (not draft, not already void) */}
                          {activeInvoice.status !== "DRAFT" && activeInvoice.status !== "VOID" && (
                            <button
                              type="button"
                              onClick={async () => {
                                if (!project || !activeInvoice?.id) return;
                                const reason = window.prompt(
                                  `Void invoice ${activeInvoice.invoiceNo ?? "this invoice"}?\n\nEnter a reason (optional):`,
                                  ""
                                );
                                if (reason === null) return; // User cancelled

                                const ok = window.confirm(
                                  `Are you sure you want to void invoice ${activeInvoice.invoiceNo ?? "this invoice"}?\n\n` +
                                  "This action cannot be undone. The invoice will be marked as VOID and no further payments can be recorded against it."
                                );
                                if (!ok) return;

                                const token = localStorage.getItem("accessToken");
                                if (!token) {
                                  setInvoiceMessage("Missing access token.");
                                  return;
                                }

                                setInvoiceMessage("Voiding invoice...");
                                try {
                                  const res = await fetch(
                                    `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/void`,
                                    {
                                      method: "POST",
                                      headers: {
                                        "Content-Type": "application/json",
                                        Authorization: `Bearer ${token}`,
                                      },
                                      body: JSON.stringify({ reason: reason.trim() || undefined }),
                                    }
                                  );
                                  if (!res.ok) {
                                    const text = await res.text().catch(() => "");
                                    setInvoiceMessage(`Void failed (${res.status}) ${text}`);
                                    return;
                                  }
                                  const json: any = await res.json();
                                  setActiveInvoice(json);
                                  setProjectInvoices(null);
                                  setFinancialSummary(null);
                                  setInvoiceMessage("Invoice voided.");
                                } catch (err: any) {
                                  setInvoiceMessage(err?.message ?? "Void failed.");
                                }
                              }}
                              style={{
                                padding: "6px 10px",
                                borderRadius: 6,
                                border: "1px solid #dc2626",
                                background: "#fef2f2",
                                color: "#b91c1c",
                                fontSize: 12,
                                cursor: "pointer",
                              }}
                            >
                              Void Invoice
                            </button>
                          )}

                          {/* Unlock button for issued invoices with $0 paid (Admin/Owner only) */}
                          {activeInvoice.status !== "DRAFT" &&
                            activeInvoice.status !== "VOID" &&
                            (activeInvoice.paidAmount ?? 0) === 0 &&
                            project &&
                            (project.userRole === "OWNER" || project.userRole === "ADMIN") && (
                            <button
                              type="button"
                              onClick={() => {
                                setInvoiceUnlockTarget(activeInvoice);
                                setInvoiceUnlockReason("");
                                setInvoiceUnlockModalOpen(true);
                              }}
                              style={{
                                padding: "6px 10px",
                                borderRadius: 6,
                                border: "1px solid #2563eb",
                                background: "#eff6ff",
                                color: "#1d4ed8",
                                fontSize: 12,
                                cursor: "pointer",
                              }}
                            >
                              Unlock for Editing
                            </button>
                          )}

                          {/* Show void status badge */}
                          {activeInvoice.status === "VOID" && (
                            <span
                              style={{
                                padding: "4px 10px",
                                borderRadius: 6,
                                background: "#fef2f2",
                                border: "1px solid #fecaca",
                                color: "#b91c1c",
                                fontSize: 11,
                                fontWeight: 600,
                              }}
                            >
                              VOIDED
                            </span>
                          )}

                          <div style={{ fontSize: 11, color: "#6b7280", alignSelf: "center" }}>
                            Tip: choose "Save as PDF" in the print dialog.
                          </div>
                        </div>
                      )}
                    </div>
                    <div style={{ textAlign: "right" }}>
                      <div style={{ fontSize: 12, color: "#6b7280" }}>Total</div>
                      <div style={{ fontWeight: 600, fontSize: 14 }}>
                        {formatMoney(activeInvoice.totalAmount ?? 0)}
                      </div>
                    </div>
                  </div>

      {invoiceApplyModalOpen && activeInvoice && (
        <div
          className="no-print"
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 80,
            background: "rgba(15,23,42,0.45)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            padding: 12,
          }}
          onClick={() => {
            if (invoiceApplySaving) return;
            setInvoiceApplyModalOpen(false);
          }}
        >
          <div
            style={{
              width: 560,
              maxWidth: "96vw",
              maxHeight: "90vh",
              overflow: "auto",
              background: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 20px 50px rgba(15,23,42,0.35)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div
              style={{
                padding: "10px 12px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
              }}
            >
              <div>
                Apply deposit / credit
                <div style={{ fontSize: 11, fontWeight: 400, color: "#6b7280" }}>
                  Create a credit line on this invoice from another issued invoice (e.g., a deposit or
                  prior credit).
                </div>
              </div>
              <button
                type="button"
                onClick={() => {
                  if (invoiceApplySaving) return;
                  setInvoiceApplyModalOpen(false);
                }}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: invoiceApplySaving ? "default" : "pointer",
                  fontSize: 18,
                  lineHeight: 1,
                }}
                aria-label="Close apply deposit/credit dialog"
              >
                ×
              </button>
            </div>

            <div style={{ padding: 12, display: "flex", flexDirection: "column", gap: 10 }}>
              <div style={{ fontSize: 12, color: "#374151" }}>
                Target invoice: <strong>{activeInvoice.invoiceNo ?? "Draft invoice"}</strong>
              </div>

              {invoiceApplySourcesLoading && (
                <div style={{ fontSize: 12, color: "#6b7280" }}>Loading deposit/credit invoices…</div>
              )}

              {invoiceApplySourcesError && !invoiceApplySourcesLoading && (
                <div style={{ fontSize: 12, color: "#b91c1c" }}>{invoiceApplySourcesError}</div>
              )}

              {!invoiceApplySourcesLoading && !invoiceApplySourcesError && (
                <>
                  {(!invoiceApplySources || invoiceApplySources.length === 0) && (
                    <div style={{ fontSize: 12, color: "#6b7280" }}>
                      No eligible invoices found. Create or issue a deposit/credit invoice first.
                    </div>
                  )}

                  {invoiceApplySources && invoiceApplySources.length > 0 && (
                    <div style={{ maxHeight: 240, overflow: "auto", border: "1px solid #e5e7eb", borderRadius: 8 }}>
                      <table
                        style={{
                          width: "100%",
                          borderCollapse: "collapse",
                          fontSize: 12,
                        }}
                      >
                        <thead>
                          <tr style={{ backgroundColor: "#f9fafb" }}>
                            <th style={{ textAlign: "left", padding: "6px 8px" }}>Source invoice</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}>Total</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}>Applied</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}>Remaining</th>
                          </tr>
                        </thead>
                        <tbody>
                          {invoiceApplySources.map((src: any) => {
                            const id = String(src?.id ?? "");
                            const remaining = Number(src?.remainingAmount ?? 0) || 0;
                            const applied = Number(src?.appliedAmount ?? 0) || 0;
                            const total = Number(src?.totalAmount ?? 0) || 0;
                            const selected = invoiceApplySelectedSourceId === id;
                            const label = src?.invoiceNo ?? "(unissued)";
                            return (
                              <tr
                                key={id}
                                style={{ cursor: "pointer", background: selected ? "#eff6ff" : "transparent" }}
                                onClick={() => setInvoiceApplySelectedSourceId(id)}
                              >
                                <td
                                  style={{
                                    padding: "6px 8px",
                                    borderTop: "1px solid #e5e7eb",
                                  }}
                                >
                                  <label style={{ display: "flex", alignItems: "center", gap: 6, cursor: "pointer" }}>
                                    <input
                                      type="radio"
                                      name="invoiceApplySource"
                                      checked={selected}
                                      onChange={() => setInvoiceApplySelectedSourceId(id)}
                                    />
                                    <span>
                                      {label} · {src?.status ?? ""}
                                    </span>
                                  </label>
                                </td>
                                <td
                                  style={{
                                    padding: "6px 8px",
                                    borderTop: "1px solid #e5e7eb",
                                    textAlign: "right",
                                  }}
                                >
                                  {total.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                                </td>
                                <td
                                  style={{
                                    padding: "6px 8px",
                                    borderTop: "1px solid #e5e7eb",
                                    textAlign: "right",
                                  }}
                                >
                                  {applied.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                                </td>
                                <td
                                  style={{
                                    padding: "6px 8px",
                                    borderTop: "1px solid #e5e7eb",
                                    textAlign: "right",
                                  }}
                                >
                                  {remaining.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}

                  <div style={{ marginTop: 10, display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
                    <input
                      placeholder="Amount to apply"
                      value={invoiceApplyAmount}
                      onChange={(e) => setInvoiceApplyAmount(e.target.value)}
                      style={{
                        flex: "1 1 160px",
                        padding: "6px 8px",
                        borderRadius: 6,
                        border: "1px solid #d1d5db",
                        fontSize: 12,
                      }}
                    />
                    <button
                      type="button"
                      disabled={invoiceApplySaving}
                      onClick={async () => {
                        if (!project || !activeInvoice?.id) return;
                        const token = localStorage.getItem("accessToken");
                        if (!token) {
                          setInvoiceMessage("Missing access token.");
                          return;
                        }

                        const sourceId = invoiceApplySelectedSourceId.trim();
                        if (!sourceId) {
                          setInvoiceMessage("Select a source invoice to apply from.");
                          return;
                        }

                        const raw = invoiceApplyAmount.trim();
                        const normalized = raw.replace(/[$,\s]/g, "");
                        const amount = Number(normalized);
                        if (!Number.isFinite(amount) || amount <= 0) {
                          setInvoiceMessage("Apply amount must be a positive number.");
                          return;
                        }

                        setInvoiceApplySaving(true);
                        setInvoiceMessage(null);
                        try {
                          const res = await fetch(
                            `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/applications`,
                            {
                              method: "POST",
                              headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                              },
                              body: JSON.stringify({ sourceInvoiceId: sourceId, amount }),
                            },
                          );
                          if (!res.ok) {
                            const text = await res.text().catch(() => "");
                            setInvoiceMessage(`Apply failed (${res.status}) ${text}`);
                            return;
                          }
                          const json: any = await res.json().catch(() => null);
                          if (json) {
                            setActiveInvoice(json);
                            setProjectInvoices(null);
                            setFinancialSummary(null);
                          }
                          setInvoiceApplyModalOpen(false);
                          setInvoiceMessage("Credit applied to invoice.");
                        } catch (err: any) {
                          setInvoiceMessage(err?.message ?? "Apply failed.");
                        } finally {
                          setInvoiceApplySaving(false);
                        }
                      }}
                      style={{
                        padding: "6px 10px",
                        borderRadius: 8,
                        border: "1px solid #0f172a",
                        background: invoiceApplySaving ? "#e5e7eb" : "#0f172a",
                        color: invoiceApplySaving ? "#4b5563" : "#f9fafb",
                        fontSize: 12,
                        cursor: invoiceApplySaving ? "default" : "pointer",
                      }}
                    >
                      {invoiceApplySaving ? "Applying…" : "Apply credit"}
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Invoice Unlock Confirmation Dialog */}
      {invoiceUnlockModalOpen && invoiceUnlockTarget && (
        <div
          className="no-print"
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 85,
            background: "rgba(15,23,42,0.55)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            padding: 12,
          }}
          onClick={() => {
            if (invoiceUnlockSaving) return;
            setInvoiceUnlockModalOpen(false);
          }}
        >
          <div
            style={{
              width: 480,
              maxWidth: "96vw",
              background: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 20px 50px rgba(15,23,42,0.35)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div
              style={{
                padding: "12px 16px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 14,
                fontWeight: 600,
                background: "#eff6ff",
              }}
            >
              <div>
                🔓 Unlock Invoice
                <div style={{ fontSize: 11, fontWeight: 400, color: "#6b7280" }}>
                  Revert to DRAFT for editing
                </div>
              </div>
              <button
                type="button"
                onClick={() => {
                  if (invoiceUnlockSaving) return;
                  setInvoiceUnlockModalOpen(false);
                }}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: invoiceUnlockSaving ? "default" : "pointer",
                  fontSize: 20,
                  lineHeight: 1,
                }}
                aria-label="Close unlock dialog"
              >
                ×
              </button>
            </div>

            <div style={{ padding: 16 }}>
              <div style={{ fontSize: 13, color: "#374151", marginBottom: 12 }}>
                You are about to unlock invoice <strong>{invoiceUnlockTarget.invoiceNo ?? "(Draft)"}</strong>.
              </div>
              <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 16 }}>
                This will revert the invoice to DRAFT status so you can make changes.
                The invoice number will be kept, and the revision number will be incremented.
              </div>

              <div style={{ marginBottom: 16 }}>
                <label style={{ display: "block", fontSize: 12, fontWeight: 500, marginBottom: 4 }}>
                  Reason for unlocking <span style={{ color: "#dc2626" }}>*</span>
                </label>
                <textarea
                  value={invoiceUnlockReason}
                  onChange={(e) => setInvoiceUnlockReason(e.target.value)}
                  placeholder="Explain why this invoice needs to be unlocked (required for audit trail)..."
                  rows={3}
                  style={{
                    width: "100%",
                    padding: "8px 10px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                    resize: "vertical",
                  }}
                />
              </div>

              <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
                <button
                  type="button"
                  onClick={() => setInvoiceUnlockModalOpen(false)}
                  disabled={invoiceUnlockSaving}
                  style={{
                    padding: "8px 14px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    color: "#374151",
                    fontSize: 12,
                    cursor: invoiceUnlockSaving ? "default" : "pointer",
                  }}
                >
                  Cancel
                </button>
                <button
                  type="button"
                  disabled={invoiceUnlockSaving || !invoiceUnlockReason.trim()}
                  onClick={async () => {
                    if (!project || !invoiceUnlockTarget?.id) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      setInvoiceMessage("Missing access token.");
                      return;
                    }

                    const reason = invoiceUnlockReason.trim();
                    if (!reason) {
                      setInvoiceMessage("Please provide a reason for unlocking.");
                      return;
                    }

                    setInvoiceUnlockSaving(true);
                    setInvoiceMessage(null);
                    try {
                      const res = await fetch(
                        `${API_BASE}/projects/${project.id}/invoices/${invoiceUnlockTarget.id}/unlock`,
                        {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({ reason }),
                        }
                      );
                      if (!res.ok) {
                        const text = await res.text().catch(() => "");
                        setInvoiceMessage(`Unlock failed (${res.status}) ${text}`);
                        return;
                      }
                      const json: any = await res.json();
                      // Update the active invoice if it's the one we unlocked
                      if (activeInvoice?.id === invoiceUnlockTarget.id) {
                        setActiveInvoice(json);
                      }
                      // Refresh invoice list
                      setProjectInvoices(null);
                      setInvoiceUnlockModalOpen(false);
                      setInvoiceMessage(
                        `Invoice unlocked and reverted to DRAFT (Rev ${json.revisionNumber ?? 1}).`
                      );
                    } catch (err: any) {
                      setInvoiceMessage(err?.message ?? "Unlock failed.");
                    } finally {
                      setInvoiceUnlockSaving(false);
                    }
                  }}
                  style={{
                    padding: "8px 14px",
                    borderRadius: 6,
                    border: "1px solid #2563eb",
                    background:
                      invoiceUnlockSaving || !invoiceUnlockReason.trim()
                        ? "#e5e7eb"
                        : "#2563eb",
                    color:
                      invoiceUnlockSaving || !invoiceUnlockReason.trim()
                        ? "#6b7280"
                        : "#ffffff",
                    fontSize: 12,
                    cursor:
                      invoiceUnlockSaving || !invoiceUnlockReason.trim()
                        ? "default"
                        : "pointer",
                  }}
                >
                  {invoiceUnlockSaving ? "Unlocking…" : "Unlock Invoice"}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Invoice Issue Preview Modal */}
      {invoiceIssuePreviewOpen && activeInvoice && activeInvoice.status === "DRAFT" && (
        <div
          className="no-print"
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 85,
            background: "rgba(15,23,42,0.55)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            padding: 12,
          }}
          onClick={() => {
            if (invoiceIssueSaving) return;
            setInvoiceIssuePreviewOpen(false);
          }}
        >
          <div
            style={{
              width: 700,
              maxWidth: "96vw",
              maxHeight: "90vh",
              overflow: "auto",
              background: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 20px 50px rgba(15,23,42,0.35)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div
              style={{
                padding: "12px 16px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 14,
                fontWeight: 600,
                background: "#f3f4f6",
              }}
            >
              <div>
                📄 Invoice Preview
                <div style={{ fontSize: 11, fontWeight: 400, color: "#6b7280" }}>
                  Review invoice details before issuing. Once issued, the invoice will be locked.
                </div>
              </div>
              <button
                type="button"
                onClick={() => {
                  if (invoiceIssueSaving) return;
                  setInvoiceIssuePreviewOpen(false);
                }}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: invoiceIssueSaving ? "default" : "pointer",
                  fontSize: 20,
                  lineHeight: 1,
                }}
                aria-label="Close invoice preview"
              >
                ×
              </button>
            </div>

            {/* Invoice Preview Content */}
            <div style={{ padding: 16 }}>
              {/* Bill To Info */}
              <div style={{ marginBottom: 16, padding: 12, background: "#f9fafb", borderRadius: 8 }}>
                <div style={{ fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 8 }}>Bill To</div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                  <div>
                    <div style={{ fontSize: 10, color: "#6b7280", marginBottom: 2 }}>Name</div>
                    <div style={{ fontSize: 13, fontWeight: 500 }}>{issueBillToName || "(not specified)"}</div>
                  </div>
                  <div>
                    <div style={{ fontSize: 10, color: "#6b7280", marginBottom: 2 }}>Email</div>
                    <div style={{ fontSize: 13, fontWeight: 500 }}>{issueBillToEmail || "(not specified)"}</div>
                  </div>
                </div>
                {issueMemo && (
                  <div style={{ marginTop: 8 }}>
                    <div style={{ fontSize: 10, color: "#6b7280", marginBottom: 2 }}>Memo</div>
                    <div style={{ fontSize: 12, color: "#374151" }}>{issueMemo}</div>
                  </div>
                )}
                {issueDueAt && (
                  <div style={{ marginTop: 8 }}>
                    <div style={{ fontSize: 10, color: "#6b7280", marginBottom: 2 }}>Due Date</div>
                    <div style={{ fontSize: 12, color: "#374151" }}>{new Date(issueDueAt).toLocaleDateString()}</div>
                  </div>
                )}
              </div>

              {/* Line Items Summary */}
              <div style={{ marginBottom: 16 }}>
                <div style={{ fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 8 }}>Line Items</div>
                <div style={{ maxHeight: 200, overflow: "auto", border: "1px solid #e5e7eb", borderRadius: 6 }}>
                  <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
                    <thead>
                      <tr style={{ background: "#f3f4f6" }}>
                        <th style={{ padding: "6px 8px", textAlign: "left", borderBottom: "1px solid #e5e7eb" }}>Description</th>
                        <th style={{ padding: "6px 8px", textAlign: "right", borderBottom: "1px solid #e5e7eb", width: 100 }}>Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      {activeInvoiceLineItemGroups.flatMap((group) =>
                        group.items.map((li: any) => {
                          const isCredit = String(li.kind ?? "").toUpperCase() === "CREDIT" || (Number(li.amount ?? 0) < 0);
                          const amt = Number(li.amount ?? 0);
                          return (
                            <tr key={li.id} style={{ borderBottom: "1px solid #f3f4f6" }}>
                              <td style={{ padding: "4px 8px", color: isCredit ? "#b91c1c" : undefined }}>
                                {li.description ?? ""}
                              </td>
                              <td
                                style={{
                                  padding: "4px 8px",
                                  textAlign: "right",
                                  color: isCredit ? "#b91c1c" : undefined,
                                  fontWeight: isCredit ? 600 : undefined,
                                }}
                              >
                                {isCredit || amt < 0
                                  ? `-$${Math.abs(amt).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                  : `$${amt.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`}
                              </td>
                            </tr>
                          );
                        })
                      )}
                      {(activeInvoicePetlLines as any[]).slice(0, 5).map((li: any) => (
                        <tr key={li.id} style={{ borderBottom: "1px solid #f3f4f6" }}>
                          <td style={{ padding: "4px 8px" }}>{li.descriptionSnapshot ?? "PETL Line"}</td>
                          <td style={{ padding: "4px 8px", textAlign: "right" }}>
                            ${(Number(li.thisInvTotal ?? 0) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          </td>
                        </tr>
                      ))}
                      {(activeInvoicePetlLines as any[]).length > 5 && (
                        <tr style={{ borderBottom: "1px solid #f3f4f6" }}>
                          <td colSpan={2} style={{ padding: "4px 8px", color: "#6b7280", fontStyle: "italic" }}>
                            + {(activeInvoicePetlLines as any[]).length - 5} more PETL lines…
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Total */}
              <div style={{ textAlign: "right", marginBottom: 20, padding: "12px 16px", background: "#f0fdf4", borderRadius: 8, border: "1px solid #16a34a" }}>
                <div style={{ fontSize: 11, color: "#166534" }}>Invoice Total</div>
                <div style={{ fontSize: 20, fontWeight: 700, color: "#166534" }}>
                  {formatMoney(activeInvoice.totalAmount ?? 0)}
                </div>
              </div>

              {/* Action Buttons */}
              <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
                <button
                  type="button"
                  disabled={invoiceIssueSaving}
                  onClick={() => setInvoiceIssuePreviewOpen(false)}
                  style={{
                    padding: "8px 16px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    fontSize: 12,
                    cursor: invoiceIssueSaving ? "default" : "pointer",
                  }}
                >
                  Cancel
                </button>
                <button
                  type="button"
                  disabled={invoiceIssueSaving}
                  onClick={async () => {
                    if (!project) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      setInvoiceMessage("Missing access token.");
                      return;
                    }
                    setInvoiceIssueSaving(true);
                    setInvoiceMessage(null);
                    try {
                      const res = await fetch(
                        `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/issue`,
                        {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({
                            billToName: issueBillToName.trim() || undefined,
                            billToEmail: issueBillToEmail.trim() || undefined,
                            memo: issueMemo.trim() || undefined,
                            dueAt: issueDueAt || undefined,
                          }),
                        },
                      );
                      if (!res.ok) {
                        const text = await res.text().catch(() => "");
                        setInvoiceMessage(`Issue failed (${res.status}) ${text}`);
                        return;
                      }
                      const json: any = await res.json();
                      setActiveInvoice(json);
                      setProjectInvoices(null);
                      setFinancialSummary(null);
                      setInvoiceIssuePreviewOpen(false);
                      setInvoiceMessage("Invoice issued and locked.");
                    } catch (err: any) {
                      setInvoiceMessage(err?.message ?? "Issue failed.");
                    } finally {
                      setInvoiceIssueSaving(false);
                    }
                  }}
                  style={{
                    padding: "8px 16px",
                    borderRadius: 6,
                    border: "1px solid #16a34a",
                    background: "#16a34a",
                    color: "#ffffff",
                    fontSize: 12,
                    fontWeight: 600,
                    cursor: invoiceIssueSaving ? "wait" : "pointer",
                  }}
                >
                  {invoiceIssueSaving ? "Saving…" : "Save (Lock & Issue)"}
                </button>
                <button
                  type="button"
                  disabled={invoiceIssueSaving || !issueBillToEmail}
                  onClick={async () => {
                    if (!project) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      setInvoiceMessage("Missing access token.");
                      return;
                    }
                    if (!issueBillToEmail.trim()) {
                      setInvoiceMessage("Email is required to send to client.");
                      return;
                    }
                    setInvoiceIssueSaving(true);
                    setInvoiceMessage(null);
                    try {
                      // Issue the invoice
                      const res = await fetch(
                        `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/issue`,
                        {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({
                            billToName: issueBillToName.trim() || undefined,
                            billToEmail: issueBillToEmail.trim() || undefined,
                            memo: issueMemo.trim() || undefined,
                            dueAt: issueDueAt || undefined,
                            sendToClient: true, // Flag to send email
                          }),
                        },
                      );
                      if (!res.ok) {
                        const text = await res.text().catch(() => "");
                        setInvoiceMessage(`Issue failed (${res.status}) ${text}`);
                        return;
                      }
                      const json: any = await res.json();
                      setActiveInvoice(json);
                      setProjectInvoices(null);
                      setFinancialSummary(null);
                      setInvoiceIssuePreviewOpen(false);
                      setInvoiceMessage(`Invoice issued and sent to ${issueBillToEmail}.`);
                    } catch (err: any) {
                      setInvoiceMessage(err?.message ?? "Issue failed.");
                    } finally {
                      setInvoiceIssueSaving(false);
                    }
                  }}
                  style={{
                    padding: "8px 16px",
                    borderRadius: 6,
                    border: "1px solid #2563eb",
                    background: invoiceIssueSaving || !issueBillToEmail ? "#bfdbfe" : "#2563eb",
                    color: invoiceIssueSaving || !issueBillToEmail ? "#6b7280" : "#ffffff",
                    fontSize: 12,
                    fontWeight: 600,
                    cursor: invoiceIssueSaving || !issueBillToEmail ? "not-allowed" : "pointer",
                  }}
                  title={!issueBillToEmail ? "Enter an email address to send to client" : ""}
                >
                  {invoiceIssueSaving ? "Sending…" : "Save & Send to Client"}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {invoicePrintDialogOpen && (() => {
        // Compute preview data - filter excluded lines and apply view-specific filters
        // Sort by displayLineNo to match PETL view (1, 1.1, 1.2, 2, 2.1, etc.)
        const previewLines = (activeInvoicePetlLines as any[])
          .filter((li: any) => {
            const lineId = String(li?.id ?? "");
            if (invoicePrintExcludedLines.has(lineId)) return false;
            
            // Apply view-specific filters
            const tag = getInvoicePetlEffectiveTag(li);
            
            if (invoicePrintGroupBy === "supplements") {
              // Only show supplements (not credits)
              return tag === "SUPPLEMENT";
            }
            
            if (invoicePrintGroupBy === "change-orders") {
              // Show change orders + credits (both supplement and CO credits)
              return tag === "CHANGE_ORDER" || tag === "SUPPLEMENT_CREDIT" || tag === "CO_CREDIT" || li.kind === "ACV_HOLDBACK_CREDIT";
            }
            
            if (invoicePrintGroupBy === "acv-rebates") {
              // Only show ACV-only items and ACV holdback credits
              return li.kind === "ACV_HOLDBACK_CREDIT" || li.kind === "ACV";
            }
            
            return true;
          })
          .sort((a: any, b: any) => {
            // Use displayLineNo for sorting (handles 1, 1.1, 1.2, 2, etc.)
            const aDisplay = String(a?.displayLineNo ?? a?.sourceLineNoSnapshot ?? a?.lineNoSnapshot ?? "0");
            const bDisplay = String(b?.displayLineNo ?? b?.sourceLineNoSnapshot ?? b?.lineNoSnapshot ?? "0");
            // Parse as version-like strings: "1" < "1.1" < "1.2" < "2"
            const aParts = aDisplay.split(".").map(p => Number(p) || 0);
            const bParts = bDisplay.split(".").map(p => Number(p) || 0);
            for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
              const aVal = aParts[i] ?? 0;
              const bVal = bParts[i] ?? 0;
              if (aVal !== bVal) return aVal - bVal;
            }
            return 0;
          });
        const previewTotal = previewLines.reduce((sum: number, li: any) => sum + (Number(li?.thisInvTotal ?? 0) || 0), 0);
        
        // Filter fields: hide certain columns when consolidating
        const enabledFieldsPreview = INVOICE_PRINT_FIELD_DEFS.filter(f => {
          if (!invoicePrintFields.has(f.key)) return false;
          if (invoicePrintConsolidate && CONSOLIDATE_HIDDEN_FIELDS.has(f.key)) return false;
          return true;
        });

        // Helper to get display line number (matches PETL view)
        const getDisplayLineNo = (li: any): string => {
          if (li?.displayLineNo != null && String(li.displayLineNo).trim()) {
            return String(li.displayLineNo).trim();
          }
          return String(li?.sourceLineNoSnapshot ?? li?.lineNoSnapshot ?? "");
        };

        // Check if line is a child (has parentLineId, anchorKind LINE_TIED, or displayLineNo like "1.1")
        const isChildLine = (li: any): boolean => {
          if (li?.parentLineId) return true;
          if (li?.anchorKind === "LINE_TIED") return true;
          if (li?.kind === "ACV_HOLDBACK_CREDIT") return true;
          const displayNo = getDisplayLineNo(li);
          return displayNo.includes(".");
        };

        // Determine line type for styling (supplement, change order, ACV, or none)
        const getLineType = (li: any): "supplement" | "change-order" | "acv" | "none" => {
          const tag = getInvoicePetlEffectiveTag(li);
          const kind = String(li?.kind ?? "");
          
          // ACV items (yellow highlight)
          if (kind === "ACV" || kind === "ACV_HOLDBACK_CREDIT") return "acv";
          
          // Supplements (light blue)
          if (tag === "SUPPLEMENT") return "supplement";
          
          // Change orders and credits (light blue)
          if (tag === "CHANGE_ORDER" || tag === "SUPPLEMENT_CREDIT" || tag === "CO_CREDIT") return "change-order";
          
          return "none";
        };

        // Get row background color based on line type
        const getRowBackground = (li: any, idx: number): string => {
          const lineType = getLineType(li);
          
          if (lineType === "acv") return "#fef9c3"; // yellow-100
          if (lineType === "supplement" || lineType === "change-order") return "#dbeafe"; // blue-100
          
          // Default alternating background for standard lines
          return idx % 2 === 1 ? "#fafafa" : "transparent";
        };

        // Check if line is standalone (not subordinate to parent line)
        const isStandaloneLine = (li: any): boolean => {
          // Standalone if it doesn't have a parent and is not line-tied
          return !li?.parentLineId && li?.anchorKind !== "LINE_TIED";
        };

        // Helper to get field value for preview
        const getPreviewFieldValue = (li: any, fieldKey: string): string => {
          const isChild = isChildLine(li);
          const displayNo = getDisplayLineNo(li);
          
          switch (fieldKey) {
            case "lineNo": {
              // Add arrow prefix for subordinate lines only (not standalone COs/supplements)
              const lineType = getLineType(li);
              const isStandalone = isStandaloneLine(li);
              
              // Standalone CO/supplement: indent but no arrow
              if (isStandalone && (lineType === "change-order" || lineType === "supplement")) {
                return `  ${displayNo}`;
              }
              
              // Subordinate line: show arrow
              if (isChild) {
                return `↳ ${displayNo}`;
              }
              
              // Regular line
              return displayNo;
            }
            case "categoryCode": return String(li?.categoryCodeSnapshot ?? "");
            case "selectionCode": return String(li?.selectionCodeSnapshot ?? "");
            case "description": {
              // For child lines, show kind indicator
              const kind = String(li?.kind ?? "");
              const anchorKind = String(li?.anchorKind ?? "");
              const billingTag = String(li?.billingTag ?? "");
              const desc = String(li?.descriptionSnapshot ?? "");
              // ACV credits (80% rebate)
              if (kind === "ACV_HOLDBACK_CREDIT") return "[CREDIT] " + desc;
              // Line-tied reconciliation entries
              if (anchorKind === "LINE_TIED") {
                if (billingTag === "SUPPLEMENT") return "[SUPP] " + desc;
                if (billingTag === "CHANGE_ORDER") return "[CO] " + desc;
                // Regular ADD/CREDIT/etc
                return "[ADD] " + desc;
              }
              return desc;
            }
            case "room": return String(li?.projectParticleLabelSnapshot ?? "");
            case "unit": return String(li?.projectUnitLabelSnapshot ?? "");
            case "building": return String(li?.projectBuildingLabelSnapshot ?? "");
            case "percentComplete": return li?.percentCompleteSnapshot != null ? `${Number(li.percentCompleteSnapshot).toFixed(0)}%` : "";
            case "earnedTotal": return fmtCurrency(li?.earnedTotal ?? 0);
            case "prevBilledTotal": return fmtCurrency(li?.prevBilledTotal ?? 0);
            case "thisInvTotal": return fmtCurrency(li?.thisInvTotal ?? 0);
            case "billingTag": return formatBillingTag(getInvoicePetlEffectiveTag(li));
            default: return "";
          }
        };

        // Group preview lines if needed
        const getPreviewGroupKey = (li: any): string => {
          switch (invoicePrintGroupBy) {
            case "category": return String(li?.categoryCodeSnapshot ?? "(No category)").trim() || "(No category)";
            case "room": return String(li?.projectParticleLabelSnapshot ?? "(No room)").trim() || "(No room)";
            case "unit": return String(li?.projectUnitLabelSnapshot ?? "(No unit)").trim() || "(No unit)";
            case "building": return String(li?.projectBuildingLabelSnapshot ?? "(No building)").trim() || "(No building)";
            case "supplements": return "Supplements";
            case "change-orders": {
              // Group change orders and ACV rebates together, but separate credits from regular COs
              const tag = getInvoicePetlEffectiveTag(li);
              if (tag === "SUPPLEMENT_CREDIT" || tag === "CO_CREDIT") return "Credits / ACV Rebates";
              return "Change Orders";
            }
            case "acv-rebates": return "ACV Rebates Only";
            default: return "";
          }
        };

        // Consolidate lines by description - merges lines with same description, aggregates values
        const consolidateLines = (lines: any[]): any[] => {
          if (!invoicePrintConsolidate) return lines;
          
          const map = new Map<string, any>();
          for (const li of lines) {
            const desc = String(li?.descriptionSnapshot ?? "").trim();
            const existing = map.get(desc);
            if (!existing) {
              // First occurrence - clone the line
              map.set(desc, {
                ...li,
                _consolidated: true,
                _lineCount: 1,
                earnedTotal: Number(li?.earnedTotal ?? 0) || 0,
                prevBilledTotal: Number(li?.prevBilledTotal ?? 0) || 0,
                thisInvTotal: Number(li?.thisInvTotal ?? 0) || 0,
                _weightedPercentSum: (Number(li?.percentCompleteSnapshot ?? 0) || 0) * (Number(li?.earnedTotal ?? 0) || 0),
                _earnedForWeighting: Number(li?.earnedTotal ?? 0) || 0,
              });
            } else {
              // Merge into existing
              existing._lineCount += 1;
              existing.earnedTotal += Number(li?.earnedTotal ?? 0) || 0;
              existing.prevBilledTotal += Number(li?.prevBilledTotal ?? 0) || 0;
              existing.thisInvTotal += Number(li?.thisInvTotal ?? 0) || 0;
              existing._weightedPercentSum += (Number(li?.percentCompleteSnapshot ?? 0) || 0) * (Number(li?.earnedTotal ?? 0) || 0);
              existing._earnedForWeighting += Number(li?.earnedTotal ?? 0) || 0;
            }
          }
          
          // Calculate weighted average % complete
          for (const li of map.values()) {
            if (li._earnedForWeighting > 0) {
              li.percentCompleteSnapshot = li._weightedPercentSum / li._earnedForWeighting;
            } else {
              li.percentCompleteSnapshot = 0;
            }
          }
          
          return Array.from(map.values());
        };

        const previewGrouped = invoicePrintGroupBy !== "none" ? (() => {
          const map = new Map<string, any[]>();
          for (const li of previewLines) {
            const gk = getPreviewGroupKey(li);
            const bucket = map.get(gk) ?? [];
            bucket.push(li);
            map.set(gk, bucket);
          }
          return Array.from(map.entries())
            .map(([key, lines]) => {
              const consolidated = consolidateLines(lines);
              return {
                key,
                lines: consolidated.sort((a, b) => Number(a?.lineNoSnapshot ?? 0) - Number(b?.lineNoSnapshot ?? 0)),
                subtotal: consolidated.reduce((s, l) => s + (Number(l?.thisInvTotal ?? 0) || 0), 0),
              };
            })
            .sort((a, b) => Number(a.lines[0]?.lineNoSnapshot ?? 0) - Number(b.lines[0]?.lineNoSnapshot ?? 0));
        })() : null;
        
        // For flat view (no grouping) with consolidation
        const previewLinesForDisplay = invoicePrintGroupBy === "none" && invoicePrintConsolidate
          ? consolidateLines(previewLines)
          : previewLines;

        return (
        <div
          className="no-print"
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 80,
            background: "rgba(15,23,42,0.45)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            padding: 12,
          }}
          onClick={() => setInvoicePrintDialogOpen(false)}
        >
          <div
            style={{
              width: 1400,
              maxWidth: "98vw",
              height: "92vh",
              display: "flex",
              flexDirection: "column",
              background: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 20px 50px rgba(15,23,42,0.35)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div
              style={{
                padding: "10px 16px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 14,
                fontWeight: 600,
                background: "#f3f4f6",
                flexShrink: 0,
              }}
            >
              <div>
                Customize Invoice Print
                <div style={{ fontSize: 11, fontWeight: 400, color: "#6b7280" }}>
                  Select fields, exclude lines, and configure grouping. Preview updates live.
                </div>
              </div>
              <button
                type="button"
                onClick={() => setInvoicePrintDialogOpen(false)}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  fontSize: 20,
                  lineHeight: 1,
                  padding: 4,
                }}
                aria-label="Close print dialog"
              >
                ×
              </button>
            </div>

            {/* Main content: Settings at top, Preview below */}
            <div style={{ display: "flex", flexDirection: "column", flex: 1, overflow: "hidden" }}>
              {/* Top: Settings Panel */}
              <div
                style={{
                  flexShrink: 0,
                  borderBottom: "1px solid #e5e7eb",
                  padding: "12px 20px",
                  background: "#fafafa",
                }}
              >
                {/* Row 1: Columns */}
                <div style={{ marginBottom: 12 }}>
                  <div style={{ fontSize: 11, fontWeight: 600, marginBottom: 6, color: "#6b7280", textTransform: "uppercase", letterSpacing: "0.5px" }}>
                    Columns
                  </div>
                  <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
                    {INVOICE_PRINT_FIELD_DEFS.map((field) => (
                      <label
                        key={field.key}
                        style={{
                          display: "flex",
                          gap: 4,
                          alignItems: "center",
                          fontSize: 11,
                          padding: "4px 8px",
                          borderRadius: 4,
                          background: invoicePrintFields.has(field.key) ? "#dbeafe" : "#ffffff",
                          border: `1px solid ${invoicePrintFields.has(field.key) ? "#3b82f6" : "#d1d5db"}`,
                          cursor: "pointer",
                          userSelect: "none",
                        }}
                      >
                        <input
                          type="checkbox"
                          checked={invoicePrintFields.has(field.key)}
                          onChange={() => togglePrintField(field.key)}
                          style={{ margin: 0, width: 12, height: 12 }}
                        />
                        {field.label}
                      </label>
                    ))}
                  </div>
                </div>

                {/* Row 2: Group By + Actions */}
                <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between", gap: 24 }}>
                  {/* Grouping - Dynamic hierarchy levels */}
                  <div>
                    <div style={{ fontSize: 11, fontWeight: 600, marginBottom: 6, color: "#6b7280", textTransform: "uppercase", letterSpacing: "0.5px" }}>
                      Group By
                    </div>
                    <div style={{ display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
                      {/* Base options: None + CAT + Reconciliation views */}
                      {[
                        { value: "none", label: "None" },
                        { value: "category", label: "CAT" },
                        { value: "supplements", label: "Supplements" },
                        { value: "change-orders", label: "Change Orders" },
                        { value: "acv-rebates", label: "ACV Rebates" },
                      ].map((opt) => (
                        <label
                          key={opt.value}
                          style={{
                            display: "flex",
                            gap: 4,
                            alignItems: "center",
                            fontSize: 11,
                            padding: "4px 8px",
                            borderRadius: 4,
                            background: invoicePrintGroupBy === opt.value ? "#dbeafe" : "#ffffff",
                            border: `1px solid ${invoicePrintGroupBy === opt.value ? "#3b82f6" : "#d1d5db"}`,
                            cursor: "pointer",
                          }}
                        >
                          <input
                            type="radio"
                            name="invoicePrintGroupBy"
                            value={opt.value}
                            checked={invoicePrintGroupBy === opt.value}
                            onChange={() => React.startTransition(() => setInvoicePrintGroupBy(opt.value as any))}
                            style={{ margin: 0, width: 12, height: 12 }}
                          />
                          {opt.label}
                        </label>
                      ))}
                      {/* Separator if hierarchy levels exist */}
                      {invoicePrintHierarchyLevels.length > 0 && (
                        <span style={{ color: "#d1d5db", fontSize: 11 }}>|</span>
                      )}
                      {/* Location hierarchy levels */}
                      {invoicePrintHierarchyLevels.map((level) => (
                        <label
                          key={level.key}
                          style={{
                            display: "flex",
                            gap: 4,
                            alignItems: "center",
                            fontSize: 11,
                            padding: "4px 8px",
                            borderRadius: 4,
                            background: invoicePrintGroupBy === level.key ? "#dbeafe" : "#ffffff",
                            border: `1px solid ${invoicePrintGroupBy === level.key ? "#3b82f6" : "#d1d5db"}`,
                            cursor: "pointer",
                          }}
                        >
                          <input
                            type="radio"
                            name="invoicePrintGroupBy"
                            value={level.key}
                            checked={invoicePrintGroupBy === level.key}
                            onChange={() => React.startTransition(() => setInvoicePrintGroupBy(level.key))}
                            style={{ margin: 0, width: 12, height: 12 }}
                          />
                          {level.label}
                          <span style={{ fontSize: 9, color: "#6b7280" }}>({level.count})</span>
                        </label>
                      ))}
                      {invoicePrintHierarchyLevels.length === 0 && (
                        <span style={{ fontSize: 10, color: "#9ca3af", fontStyle: "italic" }}>
                          (Set up structure in STRUCTURE tab for location grouping)
                        </span>
                      )}
                      {/* Separator before consolidate */}
                      <span style={{ color: "#d1d5db", fontSize: 11, marginLeft: 8 }}>|</span>
                      {/* Consolidate toggle */}
                      <label
                        style={{
                          display: "flex",
                          gap: 4,
                          alignItems: "center",
                          fontSize: 11,
                          padding: "4px 8px",
                          borderRadius: 4,
                          background: invoicePrintConsolidate ? "#fef3c7" : "#ffffff",
                          border: `1px solid ${invoicePrintConsolidate ? "#f59e0b" : "#d1d5db"}`,
                          cursor: "pointer",
                        }}
                      >
                        <input
                          type="checkbox"
                          checked={invoicePrintConsolidate}
                          onChange={() => React.startTransition(() => setInvoicePrintConsolidate(prev => !prev))}
                          style={{ margin: 0, width: 12, height: 12 }}
                        />
                        Consolidate by Description
                      </label>
                    </div>
                  </div>

                  {/* Actions */}
                  <div style={{ display: "flex", alignItems: "center", gap: 8, flexShrink: 0 }}>
                    <button
                      type="button"
                      onClick={() => setInvoiceLineExclusionModalOpen(true)}
                      style={{
                        padding: "6px 12px",
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        background: "#ffffff",
                        cursor: "pointer",
                        fontSize: 11,
                        display: "flex",
                        alignItems: "center",
                        gap: 6,
                      }}
                    >
                      Exclude line item/s
                      {invoicePrintExcludedLines.size > 0 && (
                        <span
                          style={{
                            background: "#ef4444",
                            color: "#ffffff",
                            padding: "1px 5px",
                            borderRadius: 8,
                            fontSize: 10,
                            fontWeight: 600,
                          }}
                        >
                          {invoicePrintExcludedLines.size}
                        </span>
                      )}
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        setInvoicePrintFields(ALL_PRINT_FIELDS);
                        setInvoicePrintGroupBy("none");
                        setInvoicePrintConsolidate(false);
                        setInvoicePrintExcludedLines(new Set());
                      }}
                      style={{
                        padding: "6px 10px",
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        background: "#ffffff",
                        cursor: "pointer",
                        fontSize: 11,
                        color: "#6b7280",
                      }}
                    >
                      Reset
                    </button>
                    <button
                      type="button"
                      disabled={invoicePrintBusy || invoicePrintFields.size === 0}
                      onClick={() => {
                        if (!activeInvoice) return;
                        if (invoicePrintFields.size === 0) return;

                        setInvoicePrintBusy(true);
                        try {
                          printActiveInvoiceAsHtml({
                            layout: invoicePrintGroupBy === "none" ? "FLAT" : "GROUPED",
                            groups: "EXPAND_ALL",
                          });
                          setInvoicePrintDialogOpen(false);
                        } finally {
                          window.setTimeout(() => setInvoicePrintBusy(false), 300);
                        }
                      }}
                      style={{
                        padding: "6px 16px",
                        borderRadius: 4,
                        border: "1px solid #0f172a",
                        background: invoicePrintBusy || invoicePrintFields.size === 0 ? "#e5e7eb" : "#0f172a",
                        color: invoicePrintBusy || invoicePrintFields.size === 0 ? "#4b5563" : "#f9fafb",
                        cursor: invoicePrintBusy || invoicePrintFields.size === 0 ? "default" : "pointer",
                        fontSize: 11,
                        fontWeight: 600,
                      }}
                    >
                      {invoicePrintBusy ? "Preparing…" : "Print / Save PDF"}
                    </button>
                  </div>
                </div>
              </div>

              {/* Bottom: Invoice Preview */}
              <div
                style={{
                  flex: 1,
                  overflow: "auto",
                  background: "#f1f5f9",
                  padding: 20,
                }}
              >
                <div
                  style={{
                    background: "#ffffff",
                    borderRadius: 8,
                    boxShadow: "0 2px 12px rgba(0,0,0,0.08)",
                    padding: 24,
                    minHeight: "100%",
                  }}
                >
                  {/* Preview Header */}
                  <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 20, paddingBottom: 16, borderBottom: "2px solid #e5e7eb" }}>
                    <div>
                      <div style={{ fontSize: 20, fontWeight: 700, color: "#1f2937" }}>INVOICE</div>
                      <div style={{ fontSize: 12, color: "#6b7280", marginTop: 2 }}>#{activeInvoice?.invoiceNumber ?? "—"}</div>
                    </div>
                    <div style={{ textAlign: "right", fontSize: 12, color: "#4b5563" }}>
                      <div style={{ fontWeight: 600 }}>Nexus Fortified Structures LLC</div>
                      <div style={{ color: "#6b7280" }}>{new Date().toLocaleDateString()}</div>
                    </div>
                  </div>

                  {/* Preview summary */}
                  <div style={{ marginBottom: 16, fontSize: 12, color: "#6b7280" }}>
                    {previewLines.length} line{previewLines.length !== 1 ? "s" : ""}
                    {invoicePrintConsolidate && ` → ${previewGrouped ? previewGrouped.reduce((sum, g) => sum + g.lines.length, 0) : previewLinesForDisplay.length} consolidated`}
                    {" · "}{enabledFieldsPreview.length} column{enabledFieldsPreview.length !== 1 ? "s" : ""}
                    {invoicePrintGroupBy !== "none" && ` · Grouped by ${invoicePrintGroupBy}`}
                    {invoicePrintConsolidate && " · Consolidated by description"}
                  </div>

                  {/* Preview Table */}
                  {enabledFieldsPreview.length === 0 ? (
                    <div style={{ textAlign: "center", color: "#9ca3af", padding: 40 }}>
                      Select at least one column to preview
                    </div>
                  ) : previewLines.length === 0 ? (
                    <div style={{ textAlign: "center", color: "#9ca3af", padding: 40 }}>
                      No lines included in invoice
                    </div>
                  ) : (
                    <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                      <thead>
                        <tr style={{ background: "#f9fafb" }}>
                          {enabledFieldsPreview.map((f) => (
                            <th
                              key={f.key}
                              style={{
                                padding: "8px 10px",
                                textAlign: ["earnedTotal", "prevBilledTotal", "thisInvTotal", "percentComplete"].includes(f.key) ? "right" : "left",
                                borderBottom: "2px solid #e5e7eb",
                                fontWeight: 600,
                                fontSize: 11,
                                color: "#374151",
                              }}
                            >
                              {f.label}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {previewGrouped ? (
                          // Grouped view
                          previewGrouped.map((group) => (
                            <React.Fragment key={group.key}>
                              {/* Group header row */}
                              <tr style={{ background: "#eef2ff" }}>
                                <td
                                  colSpan={enabledFieldsPreview.length}
                                  style={{
                                    padding: "8px 10px",
                                    fontWeight: 600,
                                    fontSize: 12,
                                    color: "#1f2937",
                                    borderBottom: "1px solid #c7d2fe",
                                  }}
                                >
                                  {group.key}
                                </td>
                              </tr>
                              {/* Group lines - show all */}
                              {group.lines.map((li: any, idx: number) => {
                                const isChild = isChildLine(li);
                                const rowBg = getRowBackground(li, idx);
                                return (
                                  <tr key={li?.id ?? idx} style={{ background: rowBg }}>
                                    {enabledFieldsPreview.map((f) => (
                                      <td
                                        key={f.key}
                                        style={{
                                          padding: "6px 10px",
                                          paddingLeft: isChild && f.key === "lineNo" ? 20 : 10,
                                          textAlign: ["earnedTotal", "prevBilledTotal", "thisInvTotal", "percentComplete"].includes(f.key) ? "right" : "left",
                                          borderBottom: "1px solid #f3f4f6",
                                          maxWidth: f.key === "description" ? 280 : undefined,
                                          overflow: "hidden",
                                          textOverflow: "ellipsis",
                                          whiteSpace: "nowrap",
                                        }}
                                      >
                                        {getPreviewFieldValue(li, f.key)}
                                      </td>
                                    ))}
                                  </tr>
                                );
                              })}
                              {/* Group subtotal */}
                              <tr style={{ background: "#f8fafc" }}>
                                <td
                                  colSpan={enabledFieldsPreview.length - 1}
                                  style={{ padding: "6px 10px", textAlign: "right", fontWeight: 500, borderBottom: "1px solid #e5e7eb", fontSize: 11 }}
                                >
                                  Subtotal:
                                </td>
                                <td
                                  style={{ padding: "6px 10px", textAlign: "right", fontWeight: 600, borderBottom: "1px solid #e5e7eb" }}
                                >
                                  {fmtCurrency(group.subtotal)}
                                </td>
                              </tr>
                            </React.Fragment>
                          ))
                        ) : (
                          // Flat view - show all lines (or consolidated lines)
                          previewLinesForDisplay.map((li: any, idx: number) => {
                            const isChild = isChildLine(li);
                            const rowBg = getRowBackground(li, idx);
                            return (
                              <tr 
                                key={li?.id ?? `consolidated-${idx}`} 
                                style={{ background: rowBg }}
                              >
                                {enabledFieldsPreview.map((f) => (
                                  <td
                                    key={f.key}
                                    style={{
                                      padding: "6px 10px",
                                      paddingLeft: isChild && f.key === "lineNo" ? 20 : 10,
                                      textAlign: ["earnedTotal", "prevBilledTotal", "thisInvTotal", "percentComplete"].includes(f.key) ? "right" : "left",
                                      borderBottom: "1px solid #f3f4f6",
                                      maxWidth: f.key === "description" ? 280 : undefined,
                                      overflow: "hidden",
                                      textOverflow: "ellipsis",
                                      whiteSpace: "nowrap",
                                      fontSize: isChild ? 11 : 12,
                                      color: isChild ? "#6b7280" : undefined,
                                    }}
                                  >
                                    {getPreviewFieldValue(li, f.key)}
                                  </td>
                                ))}
                              </tr>
                            );
                          })
                        )}
                      </tbody>
                    </table>
                  )}

                  {/* Preview total for PETL */}
                  {previewLines.length > 0 && enabledFieldsPreview.length > 0 && (
                    <div
                      style={{
                        marginTop: 12,
                        paddingTop: 10,
                        borderTop: "2px solid #1f2937",
                        display: "flex",
                        justifyContent: "flex-end",
                        gap: 16,
                      }}
                    >
                      <span style={{ fontWeight: 600, fontSize: 12 }}>PETL Total:</span>
                      <span style={{ fontWeight: 700, fontSize: 12, fontVariantNumeric: "tabular-nums" }}>
                        {fmtCurrency(previewTotal)}
                      </span>
                    </div>
                  )}

                  {/* Manual Line Items Preview */}
                  {activeInvoiceLineItemGroups.length > 0 && (
                    <div style={{ marginTop: 24 }}>
                      <div style={{ fontWeight: 600, fontSize: 13, marginBottom: 8, color: "#1f2937" }}>
                        Additional Line Items
                      </div>
                      <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                        <thead>
                          <tr style={{ background: "#f9fafb" }}>
                            <th style={{ padding: "8px 10px", textAlign: "left", borderBottom: "2px solid #e5e7eb", fontWeight: 600, fontSize: 11, color: "#374151" }}>Description</th>
                            <th style={{ padding: "8px 10px", textAlign: "right", borderBottom: "2px solid #e5e7eb", fontWeight: 600, fontSize: 11, color: "#374151", width: 80 }}>Qty</th>
                            <th style={{ padding: "8px 10px", textAlign: "right", borderBottom: "2px solid #e5e7eb", fontWeight: 600, fontSize: 11, color: "#374151", width: 100 }}>Unit Price</th>
                            <th style={{ padding: "8px 10px", textAlign: "right", borderBottom: "2px solid #e5e7eb", fontWeight: 600, fontSize: 11, color: "#374151", width: 100 }}>Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          {activeInvoiceLineItemGroups.map((group) => (
                            <React.Fragment key={group.kind}>
                              {/* Group header */}
                              <tr style={{ background: "#eef2ff" }}>
                                <td
                                  colSpan={4}
                                  style={{
                                    padding: "6px 10px",
                                    fontWeight: 600,
                                    fontSize: 11,
                                    color: "#4338ca",
                                    borderBottom: "1px solid #c7d2fe",
                                  }}
                                >
                                  {group.label}
                                </td>
                              </tr>
                              {/* Group items */}
                              {group.items.map((li: any, idx: number) => (
                                <tr key={li?.id ?? idx} style={{ background: idx % 2 === 1 ? "#fafafa" : "transparent" }}>
                                  <td style={{ padding: "6px 10px", borderBottom: "1px solid #f3f4f6" }}>
                                    {li?.description ?? ""}
                                  </td>
                                  <td style={{ padding: "6px 10px", textAlign: "right", borderBottom: "1px solid #f3f4f6" }}>
                                    {li?.qty ?? ""}
                                  </td>
                                  <td style={{ padding: "6px 10px", textAlign: "right", borderBottom: "1px solid #f3f4f6" }}>
                                    {li?.unitPrice ? fmtCurrency(li.unitPrice) : ""}
                                  </td>
                                  <td style={{ padding: "6px 10px", textAlign: "right", borderBottom: "1px solid #f3f4f6", fontVariantNumeric: "tabular-nums" }}>
                                    {fmtCurrency(li?.amount ?? 0)}
                                  </td>
                                </tr>
                              ))}
                            </React.Fragment>
                          ))}
                        </tbody>
                        <tfoot>
                          <tr style={{ background: "#f8fafc" }}>
                            <td colSpan={3} style={{ padding: "8px 10px", textAlign: "right", fontWeight: 600, borderTop: "2px solid #e5e7eb" }}>
                              Additional Items Total:
                            </td>
                            <td style={{ padding: "8px 10px", textAlign: "right", fontWeight: 700, borderTop: "2px solid #e5e7eb", fontVariantNumeric: "tabular-nums" }}>
                              {fmtCurrency(activeInvoiceLineItemGroups.reduce((sum, g) => sum + g.subtotal, 0))}
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
        );
      })()}

      {/* Line Exclusion Modal */}
      {invoiceLineExclusionModalOpen && (
        <div
          className="no-print"
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 90,
            background: "rgba(15,23,42,0.5)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            padding: 12,
          }}
          onClick={() => setInvoiceLineExclusionModalOpen(false)}
        >
          <div
            style={{
              width: 600,
              maxWidth: "95vw",
              maxHeight: "80vh",
              display: "flex",
              flexDirection: "column",
              background: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 20px 50px rgba(15,23,42,0.35)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div
              style={{
                padding: "12px 16px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 14,
                fontWeight: 600,
                background: "#f3f4f6",
                flexShrink: 0,
              }}
            >
              <div>
                Exclude Line Items
                <div style={{ fontSize: 11, fontWeight: 400, color: "#6b7280" }}>
                  Uncheck lines to exclude them from the printed invoice.
                </div>
              </div>
              <button
                type="button"
                onClick={() => setInvoiceLineExclusionModalOpen(false)}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  fontSize: 20,
                  lineHeight: 1,
                }}
              >
                ×
              </button>
            </div>

            {/* Quick actions */}
            <div
              style={{
                padding: "8px 16px",
                borderBottom: "1px solid #f3f4f6",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                background: "#fafafa",
              }}
            >
              <div style={{ fontSize: 12, color: "#4b5563" }}>
                {(activeInvoicePetlLines as any[]).length - invoicePrintExcludedLines.size} of {(activeInvoicePetlLines as any[]).length} lines included
              </div>
              <div style={{ display: "flex", gap: 8 }}>
                <button
                  type="button"
                  onClick={() => setAllLinesIncluded(true)}
                  style={{
                    padding: "4px 10px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    fontSize: 11,
                    cursor: "pointer",
                  }}
                >
                  Include All
                </button>
                <button
                  type="button"
                  onClick={() => setAllLinesIncluded(false)}
                  style={{
                    padding: "4px 10px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    fontSize: 11,
                    cursor: "pointer",
                  }}
                >
                  Exclude All
                </button>
              </div>
            </div>

            {/* Line list */}
            <div style={{ flex: 1, overflow: "auto", padding: "0" }}>
              <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                <thead>
                  <tr style={{ background: "#f9fafb", position: "sticky", top: 0 }}>
                    <th style={{ padding: "8px 12px", textAlign: "left", borderBottom: "1px solid #e5e7eb", width: 40 }}>✓</th>
                    <th style={{ padding: "8px 12px", textAlign: "left", borderBottom: "1px solid #e5e7eb", width: 50 }}>#</th>
                    <th style={{ padding: "8px 12px", textAlign: "left", borderBottom: "1px solid #e5e7eb" }}>Task / Description</th>
                    <th style={{ padding: "8px 12px", textAlign: "right", borderBottom: "1px solid #e5e7eb", width: 100 }}>Amount</th>
                  </tr>
                </thead>
                <tbody>
                  {(activeInvoicePetlLines as any[]).map((li: any) => {
                    const lineId = String(li?.id ?? "");
                    const isExcluded = invoicePrintExcludedLines.has(lineId);
                    const lineNo = li?.sourceLineNoSnapshot ?? li?.lineNoSnapshot ?? "";
                    const cat = li?.categoryCodeSnapshot ?? "";
                    const desc = li?.descriptionSnapshot ?? "";
                    const amt = li?.thisInvTotal ?? 0;
                    const label = [cat, desc].filter(Boolean).join(" · ") || "Line item";

                    return (
                      <tr
                        key={lineId}
                        style={{
                          background: isExcluded ? "#fef2f2" : "transparent",
                          opacity: isExcluded ? 0.6 : 1,
                          cursor: "pointer",
                        }}
                        onClick={() => togglePrintLineExclusion(lineId)}
                      >
                        <td style={{ padding: "6px 12px", borderBottom: "1px solid #f3f4f6" }}>
                          <input
                            type="checkbox"
                            checked={!isExcluded}
                            onChange={() => togglePrintLineExclusion(lineId)}
                            onClick={(e) => e.stopPropagation()}
                            style={{ margin: 0, cursor: "pointer" }}
                          />
                        </td>
                        <td style={{ padding: "6px 12px", borderBottom: "1px solid #f3f4f6", color: "#6b7280" }}>
                          {lineNo}
                        </td>
                        <td
                          style={{
                            padding: "6px 12px",
                            borderBottom: "1px solid #f3f4f6",
                            maxWidth: 300,
                            overflow: "hidden",
                            textOverflow: "ellipsis",
                            whiteSpace: "nowrap",
                          }}
                          title={label}
                        >
                          {label}
                        </td>
                        <td
                          style={{
                            padding: "6px 12px",
                            borderBottom: "1px solid #f3f4f6",
                            textAlign: "right",
                            fontVariantNumeric: "tabular-nums",
                          }}
                        >
                          {fmtCurrency(amt)}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* Footer */}
            <div
              style={{
                padding: "12px 16px",
                borderTop: "1px solid #e5e7eb",
                display: "flex",
                justifyContent: "flex-end",
                background: "#f9fafb",
                flexShrink: 0,
              }}
            >
              <button
                type="button"
                onClick={() => setInvoiceLineExclusionModalOpen(false)}
                style={{
                  padding: "8px 20px",
                  borderRadius: 6,
                  border: "1px solid #0f172a",
                  background: "#0f172a",
                  color: "#f9fafb",
                  cursor: "pointer",
                  fontSize: 12,
                  fontWeight: 600,
                }}
              >
                Done
              </button>
            </div>
          </div>
        </div>
      )}

                  {/* Detailed invoice (PETL) */}
                  <div style={{ marginTop: 12 }}>
                    <div
                      style={{
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "center",
                        gap: 12,
                        marginBottom: 6,
                      }}
                    >
                      <div style={{ fontWeight: 600 }}>Estimate line items (PETL)</div>
                      <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
                        <label style={{ display: "flex", gap: 6, alignItems: "center", fontSize: 12 }}>
                          <input
                            type="checkbox"
                            checked={invoiceGroupEnabled}
                            onChange={(e) => setInvoiceGroupEnabledPersisted(e.target.checked)}
                          />
                          Group
                        </label>
                        <div style={{ display: "flex", gap: 4, alignItems: "center", fontSize: 11, flexWrap: "wrap" }}>
                          <span style={{ color: "#6b7280" }}>View:</span>
                          {(["ALL", "CARRIER", "CLIENT"] as const).map((mode) => {
                            const label = mode === "ALL" ? "All" : mode === "CARRIER" ? "Carrier" : "Client";
                            const active = invoicePetlView === mode;
                            return (
                              <button
                                key={mode}
                                type="button"
                                onClick={() => setInvoicePetlView(mode)}
                                style={{
                                  padding: "2px 8px",
                                  borderRadius: 999,
                                  border: active ? "1px solid #0f172a" : "1px solid #d1d5db",
                                  background: active ? "#0f172a" : "#ffffff",
                                  color: active ? "#f9fafb" : "#374151",
                                  fontSize: 11,
                                  cursor: "pointer",
                                }}
                              >
                                {label}
                              </button>
                            );
                          })}
                          <span style={{ color: "#d1d5db" }}>|</span>
                          {(["SUPPLEMENTS", "CHANGE_ORDERS", "ACV_REBATES"] as const).map((mode) => {
                            const label = mode === "SUPPLEMENTS" ? "Supplements" : mode === "CHANGE_ORDERS" ? "Change Orders" : "ACV Rebates";
                            const active = invoicePetlView === mode;
                            return (
                              <button
                                key={mode}
                                type="button"
                                onClick={() => setInvoicePetlView(mode)}
                                style={{
                                  padding: "2px 8px",
                                  borderRadius: 999,
                                  border: active ? "1px solid #3b82f6" : "1px solid #d1d5db",
                                  background: active ? "#dbeafe" : "#ffffff",
                                  color: active ? "#1e40af" : "#374151",
                                  fontSize: 11,
                                  cursor: "pointer",
                                }}
                              >
                                {label}
                              </button>
                            );
                          })}
                        </div>
                      </div>
                    </div>

                    {activeInvoicePetlLines.length === 0 ? (
                      <div style={{ fontSize: 12, color: "#6b7280" }}>
                        No PETL-derived invoice detail lines yet. (If you just enabled this feature,
                        run database migrations and restart the API.)
                      </div>
                    ) : invoiceGroupEnabled ? (
                      /* Virtualized grouped view for performance at scale */
                      <InvoicePetlVirtualizedTable
                        groups={invoicePetlGrouped}
                        openGroupKeys={invoiceGroupOpenBuildings}
                        onToggleGroup={toggleInvoiceBuildingOpen}
                        editingLineId={invoicePetlTagEditingLineId}
                        editDraft={invoicePetlTagDraft}
                        editSaving={invoicePetlTagSaving}
                        onStartEdit={handleStartInvoicePetlTagEdit}
                        onEditDraftChange={handleInvoicePetlTagDraftChange}
                        onSaveEdit={handleSaveInvoicePetlTag}
                        onCancelEdit={handleCancelInvoicePetlTagEdit}
                        formatMoney={formatMoney}
                        formatBillingTag={formatBillingTag}
                        getLineBackground={getInvoiceLineBackgroundMemo}
                        getEffectiveTag={getInvoicePetlEffectiveTagMemo}
                        containerHeight={invoiceFullscreen ? 500 : 360}
                      />
                    ) : (
                      /* Virtualized flat view for performance at scale */
                      <>
                        <InvoicePetlFlatVirtualizedTable
                          lines={visibleInvoicePetlLines as any[]}
                          editingLineId={invoicePetlTagEditingLineId}
                          editDraft={invoicePetlTagDraft}
                          editSaving={invoicePetlTagSaving}
                          onStartEdit={handleStartInvoicePetlTagEdit}
                          onEditDraftChange={handleInvoicePetlTagDraftChange}
                          onSaveEdit={handleSaveInvoicePetlTag}
                          onCancelEdit={handleCancelInvoicePetlTagEdit}
                          formatMoney={formatMoney}
                          formatBillingTag={formatBillingTag}
                          getLineBackground={getInvoiceLineBackgroundMemo}
                          getEffectiveTag={getInvoicePetlEffectiveTagMemo}
                          containerHeight={invoiceFullscreen ? 500 : 360}
                        />
                        {/* Totals footer */}
                        <div
                          style={{
                            display: "flex",
                            flexDirection: "column",
                            gap: 4,
                            marginTop: 8,
                            padding: "8px 12px",
                            background: "#f9fafb",
                            borderRadius: 6,
                            fontSize: 12,
                          }}
                        >
                          <div style={{ display: "flex", justifyContent: "space-between", fontWeight: 700 }}>
                            <span>
                              {invoicePetlView === "ALL"
                                ? "Total PETL (Δ)"
                                : invoicePetlView === "CARRIER"
                                ? "Total PETL (Carrier, Δ)"
                                : "Total PETL (Client, Δ)"}
                            </span>
                            <span>{formatMoney(visiblePetlTotal)}</span>
                          </div>
                          {invoicePetlView === "ALL" && (
                            <>
                              <div style={{ display: "flex", justifyContent: "space-between", fontWeight: 600, color: "#4b5563" }}>
                                <span>Carrier PETL (Δ)</span>
                                <span>{formatMoney(petlCarrierTotal)}</span>
                              </div>
                              <div style={{ display: "flex", justifyContent: "space-between", fontWeight: 600, color: "#4b5563" }}>
                                <span>Client PETL (Δ)</span>
                                <span>{formatMoney(petlClientTotal)}</span>
                              </div>
                            </>
                          )}
                        </div>
                      </>
                    )}
                  </div>

                  {/* Draft: line item CRUD + issue */}
                  {activeInvoice.status === "DRAFT" && (
                    <div style={{ marginTop: 10 }}>
                      <div
                        style={{
                          display: "flex",
                          justifyContent: "space-between",
                          alignItems: "center",
                          gap: 8,
                          marginBottom: 6,
                        }}
                      >
                        <div style={{ fontWeight: 600 }}>Line items</div>
                        <button
                          type="button"
                          onClick={() => setInvoiceCostBookPickerOpen(true)}
                          style={{
                            padding: "3px 10px",
                            borderRadius: 999,
                            border: "1px solid #2563eb",
                            backgroundColor: "#eff6ff",
                            color: "#1d4ed8",
                            fontSize: 11,
                            cursor: "pointer",
                            whiteSpace: "nowrap",
                          }}
                        >
                          Add from Cost Book
                        </button>
                      </div>

                      <div style={{ maxHeight: invoiceFullscreen ? "45vh" : 240, overflow: "auto" }}>
                        <table
                          style={{
                            width: "100%",
                            borderCollapse: "collapse",
                            fontSize: 12,
                          }}
                        >
                          <thead>
                            <tr style={{ backgroundColor: "#f9fafb" }}>
                              <th style={{ textAlign: "left", padding: "6px 8px" }}>Description</th>
                              <th style={{ textAlign: "right", padding: "6px 8px" }}>Qty</th>
                              <th style={{ textAlign: "right", padding: "6px 8px" }}>Unit $</th>
                              <th style={{ textAlign: "right", padding: "6px 8px" }}>Amount</th>
                              <th style={{ textAlign: "right", padding: "6px 8px" }}>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {activeInvoiceLineItemGroups.length === 0 ? (
                              <tr>
                                <td
                                  colSpan={5}
                                  style={{
                                    padding: "8px 10px",
                                    borderTop: "1px solid #e5e7eb",
                                    color: "#6b7280",
                                    fontSize: 12,
                                  }}
                                >
                                  No invoice lines yet.
                                </td>
                              </tr>
                            ) : (
                              activeInvoiceLineItemGroups.flatMap((group) => {
                                const rows: React.ReactNode[] = [];

                                rows.push(
                                  <tr key={`group-${group.kind}`} style={{ background: "#f3f4f6" }}>
                                    <td
                                      colSpan={5}
                                      style={{
                                        padding: "6px 8px",
                                        borderTop: "1px solid #e5e7eb",
                                        fontWeight: 700,
                                        color: "#111827",
                                      }}
                                    >
                                      {group.label} · {formatMoney(group.subtotal)}
                                    </td>
                                  </tr>,
                                );

                                for (const li of group.items) {
                                  const isCredit = String(li.kind ?? "").toUpperCase() === "CREDIT" || (Number(li.amount ?? 0) < 0);
                                  rows.push(
                                    <tr key={li.id}>
                                      <td
                                        style={{
                                          padding: "6px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          color: isCredit ? "#b91c1c" : undefined,
                                        }}
                                      >
                                        {li.description}
                                      </td>
                                      <td
                                        style={{
                                          padding: "6px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          textAlign: "right",
                                          color: isCredit ? "#b91c1c" : "#4b5563",
                                        }}
                                      >
                                        {li.qty != null ? li.qty : ""}
                                      </td>
                                      <td
                                        style={{
                                          padding: "6px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          textAlign: "right",
                                          color: isCredit ? "#b91c1c" : undefined,
                                        }}
                                      >
                                        {li.unitPrice != null ? (
                                          isCredit && li.unitPrice > 0 
                                            ? `-${formatMoney(Math.abs(li.unitPrice))}`
                                            : formatMoney(li.unitPrice)
                                        ) : ""}
                                      </td>
                                      <td
                                        style={{
                                          padding: "6px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          textAlign: "right",
                                          color: isCredit ? "#b91c1c" : "#4b5563",
                                          fontWeight: isCredit ? 600 : undefined,
                                        }}
                                      >
                                        {(() => {
                                          const amt = Number(li.amount ?? 0);
                                          if (isCredit || amt < 0) {
                                            return `-$${Math.abs(amt).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                                          }
                                          return `$${amt.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                                        })()}
                                      </td>
                                      <td
                                        style={{
                                          padding: "6px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          textAlign: "right",
                                          whiteSpace: "nowrap",
                                        }}
                                      >
                                        <button
                                          type="button"
                                          onClick={async () => {
                                            if (!project) return;
                                            const token = localStorage.getItem("accessToken");
                                            if (!token) {
                                              setInvoiceMessage("Missing access token.");
                                              return;
                                            }

                                            const nextDesc =
                                              prompt("Description", String(li.description ?? "")) ??
                                              String(li.description ?? "");

                                            const nextAmountStr =
                                              prompt("Amount", String(li.amount ?? "")) ??
                                              String(li.amount ?? "");
                                            const nextAmount = Number(nextAmountStr);
                                            if (!Number.isFinite(nextAmount) || nextAmount <= 0) {
                                              setInvoiceMessage("Amount must be a positive number.");
                                              return;
                                            }

                                            const nextKindRaw =
                                              prompt(
                                                "Kind (MANUAL, BILLABLE_HOURS, EQUIPMENT_RENTAL, LABOR_ONLY, MATERIALS_ONLY, LABOR_AND_MATERIALS, COST_BOOK, OTHER)",
                                                String(li.kind ?? "MANUAL"),
                                              ) ?? String(li.kind ?? "MANUAL");
                                            const nextKind = nextKindRaw.trim().toUpperCase();
                                            const allowedKinds = new Set([
                                              "MANUAL",
                                              "BILLABLE_HOURS",
                                              "EQUIPMENT_RENTAL",
                                              "LABOR_ONLY",
                                              "MATERIALS_ONLY",
                                              "LABOR_AND_MATERIALS",
                                              "COST_BOOK",
                                              "OTHER",
                                            ]);
                                            if (!allowedKinds.has(nextKind)) {
                                              setInvoiceMessage("Invalid kind.");
                                              return;
                                            }

                                            const nextTagRaw =
                                              prompt(
                                                "Billing tag (NONE, PETL_LINE_ITEM, CHANGE_ORDER, SUPPLEMENT, WARRANTY)",
                                                String(li.billingTag ?? "NONE"),
                                              ) ?? String(li.billingTag ?? "NONE");
                                            const nextTag = nextTagRaw.trim().toUpperCase();
                                            const allowedTags = new Set([
                                              "NONE",
                                              "PETL_LINE_ITEM",
                                              "CHANGE_ORDER",
                                              "SUPPLEMENT",
                                              "WARRANTY",
                                            ]);
                                            if (!allowedTags.has(nextTag)) {
                                              setInvoiceMessage("Invalid billing tag.");
                                              return;
                                            }

                                            try {
                                              const res = await fetch(
                                                `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/lines/${li.id}`,
                                                {
                                                  method: "PATCH",
                                                  headers: {
                                                    "Content-Type": "application/json",
                                                    Authorization: `Bearer ${token}`,
                                                  },
                                                  body: JSON.stringify({
                                                    description: nextDesc,
                                                    amount: nextAmount,
                                                    kind: nextKind,
                                                    billingTag: nextTag,
                                                  }),
                                                },
                                              );
                                              if (!res.ok) {
                                                const text = await res.text().catch(() => "");
                                                setInvoiceMessage(
                                                  `Edit failed (${res.status}) ${text}`,
                                                );
                                                return;
                                              }
                                              const json: any = await res.json();
                                              setActiveInvoice(json);
                                              setProjectInvoices(null);
                                            } catch (err: any) {
                                              setInvoiceMessage(err?.message ?? "Edit failed.");
                                            }
                                          }}
                                          style={{
                                            padding: "2px 6px",
                                            borderRadius: 4,
                                            border: "1px solid #d1d5db",
                                            background: "#ffffff",
                                            fontSize: 11,
                                            cursor: "pointer",
                                            marginRight: 6,
                                          }}
                                        >
                                          Edit
                                        </button>
                                        <button
                                          type="button"
                                          onClick={async () => {
                                            if (!project) return;
                                            const token = localStorage.getItem("accessToken");
                                            if (!token) {
                                              setInvoiceMessage("Missing access token.");
                                              return;
                                            }
                                            if (!confirm("Delete this line item?") ) return;

                                            try {
                                              const res = await fetch(
                                                `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/lines/${li.id}`,
                                                {
                                                  method: "DELETE",
                                                  headers: { Authorization: `Bearer ${token}` },
                                                },
                                              );
                                              if (!res.ok) {
                                                const text = await res.text().catch(() => "");
                                                setInvoiceMessage(
                                                  `Delete failed (${res.status}) ${text}`,
                                                );
                                                return;
                                              }
                                              const json: any = await res.json();
                                              setActiveInvoice(json);
                                              setProjectInvoices(null);
                                            } catch (err: any) {
                                              setInvoiceMessage(err?.message ?? "Delete failed.");
                                            }
                                          }}
                                          style={{
                                            padding: "2px 6px",
                                            borderRadius: 4,
                                            border: "1px solid #b91c1c",
                                            background: "#fee2e2",
                                            color: "#991b1b",
                                            fontSize: 11,
                                            cursor: "pointer",
                                          }}
                                        >
                                          Delete
                                        </button>
                                      </td>
                                    </tr>,
                                  );
                                }

                                return rows;
                              })
                            )}
                          </tbody>
                        </table>
                      </div>

                      <div style={{ marginTop: 10, display: "flex", gap: 6, flexWrap: "wrap" }}>
                        <select
                          value={newInvoiceLineKind}
                          onChange={e => {
                            const kind = e.target.value;
                            setNewInvoiceLineKind(kind);
                            // Auto-set billing tag to CREDIT when CREDIT kind is selected
                            if (kind === "CREDIT") {
                              setNewInvoiceLineBillingTag("CREDIT");
                            }
                          }}
                          style={{
                            padding: "6px 8px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 12,
                            minWidth: 160,
                          }}
                        >
                          <option value="MANUAL">Manual</option>
                          <option value="BILLABLE_HOURS">Billable hours</option>
                          <option value="EQUIPMENT_RENTAL">Equipment rental</option>
                          <option value="LABOR_ONLY">Labor Only</option>
                          <option value="MATERIALS_ONLY">Materials only</option>
                          <option value="LABOR_AND_MATERIALS">Labor & Materials</option>
                          <option value="CREDIT">Credit</option>
                          <option value="OTHER">Other</option>
                        </select>

                        <select
                          value={newInvoiceLineBillingTag}
                          onChange={e => setNewInvoiceLineBillingTag(e.target.value)}
                          style={{
                            padding: "6px 8px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 12,
                            minWidth: 160,
                          }}
                        >
                          <option value="NONE">(no tag)</option>
                          <option value="PETL_LINE_ITEM">PETL Line Item</option>
                          <option value="CHANGE_ORDER">Change Order</option>
                          <option value="SUPPLEMENT">Supplement</option>
                          <option value="WARRANTY">Warranty</option>
                          <option value="CREDIT">Credit</option>
                        </select>
                        <input
                          placeholder="Description"
                          value={newInvoiceLineDesc}
                          onChange={e => setNewInvoiceLineDesc(e.target.value)}
                          style={{
                            flex: "1 1 260px",
                            padding: "6px 8px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 12,
                          }}
                        />
                        <input
                          placeholder="Qty"
                          value={newInvoiceLineQty}
                          onChange={e => {
                            const val = e.target.value;
                            setNewInvoiceLineQty(val);
                            // Auto-calculate amount if qty and unitPrice are valid
                            const q = Number(val);
                            const u = Number(newInvoiceLineUnitPrice);
                            if (Number.isFinite(q) && Number.isFinite(u) && val.trim() !== "" && newInvoiceLineUnitPrice.trim() !== "") {
                              setNewInvoiceLineAmount((q * u).toFixed(2));
                            }
                          }}
                          style={{
                            width: 60,
                            padding: "6px 8px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 12,
                          }}
                        />
                        <select
                          value={newInvoiceLineUnitCode}
                          onChange={e => {
                            const val = e.target.value;
                            if (val === "__MANAGE__") {
                              setUnitCodeManageOpen(true);
                              return;
                            }
                            setNewInvoiceLineUnitCode(val);
                          }}
                          style={{
                            width: 70,
                            padding: "6px 4px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 11,
                          }}
                          title="Unit code (e.g. EA, HR, SF)"
                        >
                          <option value="">Unit</option>
                          {(companyUnitCodes ?? []).map(uc => (
                            <option key={uc.id} value={uc.code}>
                              {uc.code}{uc.label ? ` - ${uc.label}` : ""}
                            </option>
                          ))}
                          {isAdminOrAbove && (
                            <option value="__MANAGE__" style={{ fontStyle: "italic", color: "#6b7280" }}>
                              ✏️ Add/Edit List
                            </option>
                          )}
                        </select>
                        <input
                          placeholder="Unit $"
                          value={newInvoiceLineUnitPrice}
                          onChange={e => {
                            const val = e.target.value;
                            setNewInvoiceLineUnitPrice(val);
                            // Auto-calculate amount if qty and unitPrice are valid
                            const q = Number(newInvoiceLineQty);
                            const u = Number(val);
                            if (Number.isFinite(q) && Number.isFinite(u) && newInvoiceLineQty.trim() !== "" && val.trim() !== "") {
                              setNewInvoiceLineAmount((q * u).toFixed(2));
                            }
                          }}
                          style={{
                            width: 100,
                            padding: "6px 8px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 12,
                          }}
                        />
                        <input
                          placeholder="Amount"
                          value={newInvoiceLineAmount}
                          onChange={e => setNewInvoiceLineAmount(e.target.value)}
                          title="Auto-calculated from Qty × Unit $, or enter manually"
                          style={{
                            width: 140,
                            padding: "6px 8px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 12,
                            background: newInvoiceLineQty.trim() !== "" && newInvoiceLineUnitPrice.trim() !== "" ? "#f0fdf4" : "#ffffff",
                          }}
                        />
                        <button
                          type="button"
                          onClick={async () => {
                            if (!project) return;
                            const token = localStorage.getItem("accessToken");
                            if (!token) {
                              setInvoiceMessage("Missing access token.");
                              return;
                            }

                            const desc = newInvoiceLineDesc.trim();
                            if (!desc) {
                              setInvoiceMessage("Line description is required.");
                              return;
                            }

                            const qty = newInvoiceLineQty.trim() === "" ? undefined : Number(newInvoiceLineQty);
                            let unitPrice =
                              newInvoiceLineUnitPrice.trim() === "" ? undefined : Number(newInvoiceLineUnitPrice);
                            let amount =
                              newInvoiceLineAmount.trim() === "" ? undefined : Number(newInvoiceLineAmount);

                            if (
                              (qty !== undefined && !Number.isFinite(qty)) ||
                              (unitPrice !== undefined && !Number.isFinite(unitPrice)) ||
                              (amount !== undefined && !Number.isFinite(amount))
                            ) {
                              setInvoiceMessage("Qty / Unit / Amount must be valid numbers.");
                              return;
                            }

                            // Calculate amount from qty × unitPrice if not explicitly provided
                            if (amount === undefined && qty !== undefined && unitPrice !== undefined) {
                              amount = qty * unitPrice;
                            }

                            // For CREDIT kind, ensure amount is negative
                            if (newInvoiceLineKind === "CREDIT" && amount !== undefined && amount > 0) {
                              amount = -Math.abs(amount);
                            }

                            try {
                              const res = await fetch(
                                `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/lines`,
                                {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({
                                    kind: newInvoiceLineKind,
                                    billingTag: newInvoiceLineBillingTag,
                                    description: desc,
                                    qty,
                                    unitCode: newInvoiceLineUnitCode || undefined,
                                    unitPrice,
                                    amount,
                                  }),
                                },
                              );
                              if (!res.ok) {
                                const text = await res.text().catch(() => "");
                                setInvoiceMessage(
                                  `Add line failed (${res.status}) ${text}`,
                                );
                                return;
                              }
                              const json: any = await res.json();
                              setActiveInvoice(json);
                              setProjectInvoices(null);
                              setNewInvoiceLineDesc("");
                              setNewInvoiceLineQty("");
                              setNewInvoiceLineUnitCode("");
                              setNewInvoiceLineUnitPrice("");
                              setNewInvoiceLineAmount("");
                              setInvoiceMessage("Line added.");
                            } catch (err: any) {
                              setInvoiceMessage(err?.message ?? "Add line failed.");
                            }
                          }}
                          style={{
                            padding: "6px 10px",
                            borderRadius: 4,
                            border: "1px solid #0f172a",
                            background: "#0f172a",
                            color: "#f9fafb",
                            fontSize: 12,
                            cursor: "pointer",
                          }}
                        >
                        Add line
                        </button>

                        {/* Attach button - narrow vertical oval with paperclip */}
                        <div style={{ position: "relative" }}>
                          <button
                            type="button"
                            onClick={() => setInvoiceAttachMenuOpen(prev => !prev)}
                            style={{
                              padding: "2px 4px",
                              borderRadius: 10,
                              border: "1px solid #0f172a",
                              background: "#ffffff",
                              cursor: "pointer",
                              display: "flex",
                              flexDirection: "column",
                              alignItems: "center",
                              justifyContent: "center",
                              height: 32,
                              minWidth: 20,
                            }}
                            title="Attach file"
                          >
<span style={{ fontSize: 16, display: "inline-block", transform: "rotate(45deg)" }}>📎</span>
                          </button>
                          {invoiceAttachMenuOpen && (<>
                            {/* Invisible backdrop to close menu on click outside */}
                            <div
                              onClick={() => setInvoiceAttachMenuOpen(false)}
                              style={{
                                position: "fixed",
                                inset: 0,
                                zIndex: 99,
                              }}
                            />
                            <div
                              style={{
                                position: "absolute",
                                top: "100%",
                                right: 0,
                                marginTop: 4,
                                background: "#ffffff",
                                border: "1px solid #e5e7eb",
                                borderRadius: 6,
                                boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
                                zIndex: 100,
                                minWidth: 180,
                                overflow: "hidden",
                              }}
                            >
                                <div style={{ padding: "6px 10px", fontSize: 11, color: "#6b7280", borderBottom: "1px solid #e5e7eb" }}>
                                  Attachment Source
                                </div>
                                {/* Photo/Camera option */}
                                <label
                                  style={{
                                    display: "flex",
                                    alignItems: "center",
                                    gap: 8,
                                    padding: "8px 12px",
                                    cursor: "pointer",
                                    fontSize: 12,
                                  }}
                                  onMouseEnter={e => (e.currentTarget.style.background = "#f3f4f6")}
                                  onMouseLeave={e => (e.currentTarget.style.background = "transparent")}
                                >
                                  <span>📷</span>
                                  <span>Take Photo</span>
                                  <input
                                    type="file"
                                    accept="image/*"
                                    capture="environment"
                                    style={{ display: "none" }}
                                    onChange={async (e) => {
                                      const file = e.target.files?.[0];
                                      if (!file || !project || !activeInvoice?.id) return;
                                      setInvoiceAttachMenuOpen(false);
                                      const token = localStorage.getItem("accessToken");
                                      if (!token) {
                                        setInvoiceMessage("Missing access token.");
                                        return;
                                      }
                                      try {
                                        setInvoiceMessage("Uploading...");
                                        // Step 1: get signed upload URL
                                        const metaRes = await fetch(
                                          `${API_BASE}/projects/${project.id}/files/upload-url`,
                                          {
                                            method: "POST",
                                            headers: {
                                              "Content-Type": "application/json",
                                              Authorization: `Bearer ${token}`,
                                            },
                                            body: JSON.stringify({
                                              contentType: file.type || "image/jpeg",
                                              fileName: file.name || "photo.jpg",
                                            }),
                                          }
                                        );
                                        if (!metaRes.ok) {
                                          setInvoiceMessage(`Upload failed (${metaRes.status})`);
                                          return;
                                        }
                                        const meta = await metaRes.json();
                                        // Step 2: upload to storage
                                        const putRes = await fetch(meta.uploadUrl, {
                                          method: "PUT",
                                          headers: { "Content-Type": file.type || "image/jpeg" },
                                          body: file,
                                        });
                                        if (!putRes.ok) {
                                          setInvoiceMessage(`Upload failed (${putRes.status})`);
                                          return;
                                        }
                                        // Step 3: compute hash and register file
                                        const contentHash = await computeFileHash(file);
                                        const registerRes = await fetch(
                                          `${API_BASE}/projects/${project.id}/files`,
                                          {
                                            method: "POST",
                                            headers: {
                                              "Content-Type": "application/json",
                                              Authorization: `Bearer ${token}`,
                                            },
                                            body: JSON.stringify({
                                              fileUri: meta.fileUri,
                                              fileName: file.name || "photo.jpg",
                                              mimeType: file.type || "image/jpeg",
                                              sizeBytes: file.size,
                                              contentHash,
                                            }),
                                          }
                                        );
                                        if (!registerRes.ok) {
                                          setInvoiceMessage(`Register failed (${registerRes.status})`);
                                          return;
                                        }
                                        const uploaded = await registerRes.json();
                                        // Step 4: attach to invoice
                                        const attachRes = await fetch(
                                          `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/attachments`,
                                          {
                                            method: "POST",
                                            headers: {
                                              "Content-Type": "application/json",
                                              Authorization: `Bearer ${token}`,
                                            },
                                            body: JSON.stringify({ projectFileId: uploaded.id }),
                                          }
                                        );
                                        if (!attachRes.ok) {
                                          setInvoiceMessage(`Attach failed (${attachRes.status})`);
                                          return;
                                        }
                                        const json = await attachRes.json();
                                        setActiveInvoice(json);
                                        setInvoiceMessage(uploaded.isDuplicate ? "Photo linked (existing file)." : "Photo attached.");
                                      } catch (err: any) {
                                        setInvoiceMessage(err?.message ?? "Upload failed.");
                                      }
                                      e.target.value = "";
                                    }}
                                  />
                                </label>
                                {/* Upload file option */}
                                <label
                                  style={{
                                    display: "flex",
                                    alignItems: "center",
                                    gap: 8,
                                    padding: "8px 12px",
                                    cursor: "pointer",
                                    fontSize: 12,
                                  }}
                                  onMouseEnter={e => (e.currentTarget.style.background = "#f3f4f6")}
                                  onMouseLeave={e => (e.currentTarget.style.background = "transparent")}
                                >
                                  <span>📄</span>
                                  <span>Upload File</span>
                                  <input
                                    type="file"
                                    accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx"
                                    style={{ display: "none" }}
                                    onChange={async (e) => {
                                      const file = e.target.files?.[0];
                                      if (!file || !project || !activeInvoice?.id) return;
                                      setInvoiceAttachMenuOpen(false);
                                      const token = localStorage.getItem("accessToken");
                                      if (!token) {
                                        setInvoiceMessage("Missing access token.");
                                        return;
                                      }
                                      try {
                                        setInvoiceMessage("Uploading...");
                                        // Step 1: get signed upload URL
                                        const metaRes = await fetch(
                                          `${API_BASE}/projects/${project.id}/files/upload-url`,
                                          {
                                            method: "POST",
                                            headers: {
                                              "Content-Type": "application/json",
                                              Authorization: `Bearer ${token}`,
                                            },
                                            body: JSON.stringify({
                                              contentType: file.type || "application/octet-stream",
                                              fileName: file.name || "attachment",
                                            }),
                                          }
                                        );
                                        if (!metaRes.ok) {
                                          setInvoiceMessage(`Upload failed (${metaRes.status})`);
                                          return;
                                        }
                                        const meta = await metaRes.json();
                                        // Step 2: upload to storage
                                        const putRes = await fetch(meta.uploadUrl, {
                                          method: "PUT",
                                          headers: { "Content-Type": file.type || "application/octet-stream" },
                                          body: file,
                                        });
                                        if (!putRes.ok) {
                                          setInvoiceMessage(`Upload failed (${putRes.status})`);
                                          return;
                                        }
                                        // Step 3: compute hash and register file
                                        const contentHash = await computeFileHash(file);
                                        const registerRes = await fetch(
                                          `${API_BASE}/projects/${project.id}/files`,
                                          {
                                            method: "POST",
                                            headers: {
                                              "Content-Type": "application/json",
                                              Authorization: `Bearer ${token}`,
                                            },
                                            body: JSON.stringify({
                                              fileUri: meta.fileUri,
                                              fileName: file.name || "attachment",
                                              mimeType: file.type || undefined,
                                              sizeBytes: file.size,
                                              contentHash,
                                            }),
                                          }
                                        );
                                        if (!registerRes.ok) {
                                          setInvoiceMessage(`Register failed (${registerRes.status})`);
                                          return;
                                        }
                                        const uploaded = await registerRes.json();
                                        // Step 4: attach to invoice
                                        const attachRes = await fetch(
                                          `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/attachments`,
                                          {
                                            method: "POST",
                                            headers: {
                                              "Content-Type": "application/json",
                                              Authorization: `Bearer ${token}`,
                                            },
                                            body: JSON.stringify({ projectFileId: uploaded.id }),
                                          }
                                        );
                                        if (!attachRes.ok) {
                                          setInvoiceMessage(`Attach failed (${attachRes.status})`);
                                          return;
                                        }
                                        const json = await attachRes.json();
                                        setActiveInvoice(json);
                                        setInvoiceMessage(uploaded.isDuplicate ? "File linked (existing file)." : "File attached.");
                                      } catch (err: any) {
                                        setInvoiceMessage(err?.message ?? "Upload failed.");
                                      }
                                      e.target.value = "";
                                    }}
                                  />
                                </label>
                                {/* Project Link option - link to existing file */}
                                <div
                                  style={{
                                    borderTop: "1px solid #e5e7eb",
                                  }}
                                >
                                  <div
                                    style={{
                                      display: "flex",
                                      alignItems: "center",
                                      gap: 8,
                                      padding: "8px 12px",
                                      fontSize: 12,
                                      color: "#111827",
                                    }}
                                  >
                                    <span>🔗</span>
                                    <span>Project Link</span>
                                  </div>
                                  <select
                                    id="invoice-attach-file-select"
                                    style={{
                                      width: "calc(100% - 24px)",
                                      margin: "0 12px 8px 12px",
                                      padding: "4px 6px",
                                      borderRadius: 4,
                                      border: "1px solid #d1d5db",
                                      fontSize: 11,
                                    }}
                                    onChange={async (e) => {
                                      const projectFileId = e.target.value;
                                      if (!projectFileId || !project || !activeInvoice?.id) return;
                                      setInvoiceAttachMenuOpen(false);
                                      const token = localStorage.getItem("accessToken");
                                      if (!token) {
                                        setInvoiceMessage("Missing access token.");
                                        return;
                                      }
                                      try {
                                        const res = await fetch(
                                          `${API_BASE}/projects/${project.id}/invoices/${activeInvoice.id}/attachments`,
                                          {
                                            method: "POST",
                                            headers: {
                                              "Content-Type": "application/json",
                                              Authorization: `Bearer ${token}`,
                                            },
                                            body: JSON.stringify({ projectFileId }),
                                          }
                                        );
                                        if (!res.ok) {
                                          const text = await res.text().catch(() => "");
                                          setInvoiceMessage(`Attach failed (${res.status}) ${text}`);
                                          return;
                                        }
                                        const json = await res.json();
                                        setActiveInvoice(json);
                                        setInvoiceMessage("File attached.");
                                      } catch (err: any) {
                                        setInvoiceMessage(err?.message ?? "Attach failed.");
                                      }
                                      e.target.value = "";
                                    }}
                                  >
                                    <option value="">Select file...</option>
                                    {Array.isArray(billAttachmentFileOptions) && billAttachmentFileOptions.map((f: any) => (
                                      <option key={f.id} value={f.id}>{f.fileName}</option>
                                    ))}
                                  </select>
                                </div>
                            </div>
                            </>)}
                        </div>
                      </div>

                      {/* Attachments list */}
                      {Array.isArray(activeInvoice?.attachments) && activeInvoice.attachments.length > 0 && (
                        <div style={{ marginTop: 8 }}>
                          <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 4 }}>Attachments</div>
                          <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
                            {activeInvoice.attachments.map((a: any) => (
                              <a
                                key={String(a?.id ?? a?.projectFileId ?? Math.random())}
                                href={String(a?.fileUrl ?? "#")}
                                target="_blank"
                                rel="noreferrer"
                                style={{
                                  fontSize: 11,
                                  color: "#2563eb",
                                  textDecoration: "none",
                                  padding: "2px 6px",
                                  background: "#eff6ff",
                                  borderRadius: 4,
                                }}
                              >
                                📎 {String(a?.fileName ?? "Attachment")}
                              </a>
                            ))}
                          </div>
                        </div>
                      )}

                      <div style={{ marginTop: 12 }}>
                        <div style={{ fontWeight: 600, marginBottom: 6 }}>Issue invoice</div>
                        <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                          <input
                            placeholder="Bill to name"
                            value={issueBillToName}
                            onChange={e => setIssueBillToName(e.target.value)}
                            style={{
                              flex: "1 1 180px",
                              padding: "6px 8px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                          <input
                            placeholder="Bill to email"
                            value={issueBillToEmail}
                            onChange={e => setIssueBillToEmail(e.target.value)}
                            style={{
                              flex: "1 1 220px",
                              padding: "6px 8px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                          <input
                            placeholder="Memo"
                            value={issueMemo}
                            onChange={e => setIssueMemo(e.target.value)}
                            style={{
                              flex: "1 1 260px",
                              padding: "6px 8px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                          <input
                            type="date"
                            value={issueDueAt}
                            onChange={e => setIssueDueAt(e.target.value)}
                            style={{
                              padding: "6px 8px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                          <button
                            type="button"
                            onClick={() => setInvoiceIssuePreviewOpen(true)}
                            style={{
                              padding: "6px 10px",
                              borderRadius: 4,
                              border: "1px solid #16a34a",
                              background: "#dcfce7",
                              color: "#166534",
                              fontSize: 12,
                              cursor: "pointer",
                            }}
                          >
                            Lock &amp; Issue
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Issued: payments shown above Payroll & Workforce */}
                </div>
              )}
            </div>
          </div>
        </div>
      )}
      {/* BOM tab content */}
      {activeTab === "BOM" && (
        <div style={{ marginTop: 8, marginBottom: 16 }}>
          <h2 style={{ fontSize: 16, fontWeight: 600, marginBottom: 6 }}>
            Bill of Materials (BOM)
          </h2>
          <p style={{ fontSize: 12, color: "#4b5563", marginBottom: 12 }}>
            Aggregated material costs from the PETL (qty × per-unit material), grouped by Cat/Sel.
            Compare with the Components CSV to reconcile.
          </p>

          {bomLoading && (
            <p style={{ fontSize: 12, color: "#6b7280" }}>Loading BOM data…</p>
          )}

          {bomError && (
            <p style={{ fontSize: 12, color: "#b91c1c" }}>{bomError}</p>
          )}

          {bomData && (
            <div>
              {/* View toggle */}
              <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
                <button
                  type="button"
                  onClick={() => setBomView("petl")}
                  style={{
                    padding: "6px 12px",
                    fontSize: 12,
                    border: "1px solid #e5e7eb",
                    borderRadius: 4,
                    background: bomView === "petl" ? "#2563eb" : "#fff",
                    color: bomView === "petl" ? "#fff" : "#374151",
                    cursor: "pointer",
                    fontWeight: bomView === "petl" ? 600 : 400,
                  }}
                >
                  PETL BOM ({bomData.petlBom?.uniqueCatSelCount ?? 0} Cat/Sel)
                </button>
                <button
                  type="button"
                  onClick={() => setBomView("components")}
                  style={{
                    padding: "6px 12px",
                    fontSize: 12,
                    border: "1px solid #e5e7eb",
                    borderRadius: 4,
                    background: bomView === "components" ? "#2563eb" : "#fff",
                    color: bomView === "components" ? "#fff" : "#374151",
                    cursor: "pointer",
                    fontWeight: bomView === "components" ? 600 : 400,
                  }}
                >
                  Components CSV ({bomData.componentsBom?.itemCount ?? 0} items)
                </button>
              </div>

              {/* Summary */}
              <div
                style={{
                  display: "flex",
                  gap: 24,
                  marginBottom: 16,
                  padding: 12,
                  background: "#f9fafb",
                  borderRadius: 6,
                  fontSize: 12,
                }}
              >
                <div>
                  <div style={{ color: "#6b7280", marginBottom: 2 }}>PETL Materials</div>
                  <div style={{ fontWeight: 600, fontSize: 14 }}>
                    ${(bomData.petlBom?.totalMaterialCost ?? 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}
                  </div>
                  <div style={{ color: "#9ca3af", fontSize: 11 }}>
                    {bomData.petlBom?.lineCount ?? 0} lines
                    {(bomData.petlBom?.manualLineCount ?? 0) > 0 && (
                      <span style={{ color: "#f59e0b" }}> ({bomData.petlBom.manualLineCount} manual)</span>
                    )}
                  </div>
                </div>
                <div>
                  <div style={{ color: "#6b7280", marginBottom: 2 }}>Components Total</div>
                  <div style={{ fontWeight: 600, fontSize: 14 }}>
                    ${(bomData.componentsBom?.totalCost ?? 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}
                  </div>
                  <div style={{ color: "#9ca3af", fontSize: 11 }}>
                    {bomData.componentsBom?.itemCount ?? 0} unique
                    {(bomData.componentsBom?.rawRowCount ?? 0) > (bomData.componentsBom?.itemCount ?? 0) && (
                      <span> (de-duped from {bomData.componentsBom.rawRowCount})</span>
                    )}
                  </div>
                </div>
              </div>

              {/* PETL BOM View */}
              {bomView === "petl" && bomData.petlBom && (
                <div>
                  {/* Category summary */}
                  <div style={{ marginBottom: 16 }}>
                    <h3 style={{ fontSize: 13, fontWeight: 600, marginBottom: 8 }}>By Category</h3>
                    <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                      {(bomData.petlBom.byCategory ?? []).map((cat: any) => (
                        <div
                          key={cat.category}
                          style={{
                            padding: "6px 10px",
                            background: "#eef2ff",
                            borderRadius: 4,
                            fontSize: 11,
                          }}
                        >
                          <span style={{ fontWeight: 600 }}>{cat.category}</span>:
                          ${cat.totalMaterialCost?.toLocaleString(undefined, { maximumFractionDigits: 0 }) ?? 0}
                          <span style={{ color: "#6b7280" }}> ({cat.lineCount} lines)</span>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* PETL BOM table */}
                  <div style={{ overflowX: "auto" }}>
                    <table style={{ width: "100%", fontSize: 11, borderCollapse: "collapse" }}>
                      <thead>
                        <tr style={{ background: "#f3f4f6", textAlign: "left" }}>
                          <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb" }}>Cat/Sel</th>
                          <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb", textAlign: "right" }}>Total Qty</th>
                          <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb" }}>Unit</th>
                          <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb", textAlign: "right" }}>Material $</th>
                          <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb", textAlign: "right" }}>Lines</th>
                          <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb" }}>Sample Descriptions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(bomData.petlBom.items ?? []).map((item: any, idx: number) => (
                          <tr key={item.catSel || idx} style={{ borderBottom: "1px solid #f3f4f6" }}>
                            <td style={{ padding: "6px", fontWeight: 500 }}>{item.catSel || "(none)"}</td>
                            <td style={{ padding: "6px", textAlign: "right" }}>
                              {item.totalQty?.toLocaleString(undefined, { maximumFractionDigits: 2 }) ?? 0}
                            </td>
                            <td style={{ padding: "6px", color: "#6b7280" }}>{item.unit}</td>
                            <td style={{ padding: "6px", textAlign: "right", fontWeight: 500 }}>
                              ${item.totalMaterialCost?.toLocaleString(undefined, { maximumFractionDigits: 2 }) ?? 0}
                            </td>
                            <td style={{ padding: "6px", textAlign: "right", color: "#6b7280" }}>{item.lineCount}</td>
                            <td style={{ padding: "6px", color: "#9ca3af", fontSize: 10, maxWidth: 300, overflow: "hidden", textOverflow: "ellipsis" }}>
                              {(item.sampleDescriptions ?? []).join("; ")}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Components BOM View */}
              {bomView === "components" && bomData.componentsBom && (
                <div>
                  {bomData.componentsBom.items?.length === 0 ? (
                    <p style={{ fontSize: 12, color: "#6b7280", fontStyle: "italic" }}>
                      No components CSV imported yet. Import the components CSV from the Import screen.
                    </p>
                  ) : (
                    <div style={{ overflowX: "auto" }}>
                      <table style={{ width: "100%", fontSize: 11, borderCollapse: "collapse" }}>
                        <thead>
                          <tr style={{ background: "#f3f4f6", textAlign: "left" }}>
                            <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb" }}>Code</th>
                            <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb" }}>Description</th>
                            <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb", textAlign: "right" }}>Qty</th>
                            <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb" }}>Unit</th>
                            <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb", textAlign: "right" }}>Unit $</th>
                            <th style={{ padding: "8px 6px", borderBottom: "1px solid #e5e7eb", textAlign: "right" }}>Total $</th>
                          </tr>
                        </thead>
                        <tbody>
                          {(bomData.componentsBom.items ?? []).map((item: any, idx: number) => (
                            <tr key={item.code || idx} style={{ borderBottom: "1px solid #f3f4f6" }}>
                              <td style={{ padding: "6px", fontWeight: 500 }}>{item.code}</td>
                              <td style={{ padding: "6px", maxWidth: 300, overflow: "hidden", textOverflow: "ellipsis" }}>
                                {item.description}
                              </td>
                              <td style={{ padding: "6px", textAlign: "right" }}>
                                {item.quantity?.toLocaleString(undefined, { maximumFractionDigits: 2 }) ?? 0}
                              </td>
                              <td style={{ padding: "6px", color: "#6b7280" }}>{item.unit}</td>
                              <td style={{ padding: "6px", textAlign: "right", color: "#6b7280" }}>
                                ${item.unitPrice?.toLocaleString(undefined, { maximumFractionDigits: 2 }) ?? 0}
                              </td>
                              <td style={{ padding: "6px", textAlign: "right", fontWeight: 500 }}>
                                ${item.total?.toLocaleString(undefined, { maximumFractionDigits: 2 }) ?? 0}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* IMPORT STRUCTURE tab content */}
      {activeTab === "STRUCTURE" && (
        <div style={{ marginTop: 8, marginBottom: 16 }}>
          <h2 style={{ fontSize: 16, fontWeight: 600, marginBottom: 6 }}>
            Project Organization
          </h2>
          <p style={{ fontSize: 12, color: "#4b5563", marginBottom: 12 }}>
            Organize your project structure: <strong>Property → Buildings → Units → Rooms</strong>.
            Assign imported room buckets to units to build the hierarchy.
          </p>

          {/* Real-time Hierarchy Tree */}
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "320px 1fr",
              gap: 16,
              marginBottom: 16,
            }}
          >
            {/* Left: Hierarchy Tree */}
            <div
              style={{
                border: "1px solid #e5e7eb",
                borderRadius: 8,
                background: "#ffffff",
                overflow: "hidden",
              }}
            >
              <div
                style={{
                  padding: "8px 12px",
                  background: "#f3f4f6",
                  borderBottom: "1px solid #e5e7eb",
                  fontSize: 12,
                  fontWeight: 600,
                }}
              >
                Hierarchy Tree
              </div>
              <div style={{ padding: 12, fontSize: 12, maxHeight: 400, overflow: "auto" }}>
                {/* Property (Project) - Root */}
                <div style={{ marginBottom: 8 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 6, fontWeight: 600, color: "#1f2937" }}>
                    <span style={{ fontSize: 14 }}>🏠</span>
                    <span>{project?.name || "Project"}</span>
                  </div>
                  {project?.addressLine1 && (
                    <div style={{ marginLeft: 22, fontSize: 11, color: "#6b7280" }}>
                      {project.addressLine1}
                      {project.city && `, ${project.city}`}
                      {project.state && `, ${project.state}`}
                    </div>
                  )}
                </div>

                {/* Buildings with their units */}
                {hierarchy?.buildings && hierarchy.buildings.length > 0 && (
                  <div style={{ marginLeft: 12, borderLeft: "2px solid #e5e7eb", paddingLeft: 12 }}>
                    {hierarchy.buildings.map((b: any) => (
                      <div key={b.id} style={{ marginBottom: 8 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 6, fontWeight: 600, color: "#4338ca" }}>
                          <span style={{ fontSize: 13 }}>🏢</span>
                          <span>{b.code ? `${b.code} - ` : ""}{b.name || "Building"}</span>
                        </div>
                        {/* Units in this building */}
                        {b.units && b.units.length > 0 && (
                          <div style={{ marginLeft: 12, borderLeft: "2px solid #c7d2fe", paddingLeft: 12, marginTop: 4 }}>
                            {b.units.map((u: any) => (
                              <div key={u.id} style={{ marginBottom: 6 }}>
                                <div style={{ display: "flex", alignItems: "center", gap: 6, fontWeight: 500, color: "#0891b2" }}>
                                  <span style={{ fontSize: 12 }}>📦</span>
                                  <span>{u.label}{typeof u.floor === "number" ? ` (Floor ${u.floor})` : ""}</span>
                                </div>
                                {/* Rooms in this unit */}
                                {u.particles && u.particles.length > 0 && (
                                  <div style={{ marginLeft: 12, marginTop: 2 }}>
                                    {u.particles.map((p: any) => (
                                      <div key={p.id} style={{ display: "flex", alignItems: "center", gap: 4, color: "#6b7280", fontSize: 11, marginBottom: 2 }}>
                                        <span>📍</span>
                                        <span>{p.name || p.fullLabel || "Room"}</span>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                        {/* Rooms directly in building (no unit) */}
                        {b.particles && b.particles.length > 0 && (
                          <div style={{ marginLeft: 12, marginTop: 4 }}>
                            {b.particles.map((p: any) => (
                              <div key={p.id} style={{ display: "flex", alignItems: "center", gap: 4, color: "#6b7280", fontSize: 11, marginBottom: 2 }}>
                                <span>📍</span>
                                <span>{p.name || p.fullLabel || "Room"}</span>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* Standalone Units (no building) */}
                {hierarchy?.units && hierarchy.units.length > 0 && (
                  <div style={{ marginLeft: 12, borderLeft: "2px solid #e5e7eb", paddingLeft: 12 }}>
                    {hierarchy.units.map((u: any) => (
                      <div key={u.id} style={{ marginBottom: 6 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 6, fontWeight: 500, color: "#0891b2" }}>
                          <span style={{ fontSize: 12 }}>📦</span>
                          <span>{u.label}{typeof u.floor === "number" ? ` (Floor ${u.floor})` : ""}</span>
                          <span style={{ fontSize: 10, color: "#9ca3af", fontWeight: 400 }}>(no building)</span>
                        </div>
                        {/* Rooms in this unit */}
                        {u.particles && u.particles.length > 0 && (
                          <div style={{ marginLeft: 12, marginTop: 2 }}>
                            {u.particles.map((p: any) => (
                              <div key={p.id} style={{ display: "flex", alignItems: "center", gap: 4, color: "#6b7280", fontSize: 11, marginBottom: 2 }}>
                                <span>📍</span>
                                <span>{p.name || p.fullLabel || "Room"}</span>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* Empty state */}
                {(!hierarchy || ((!hierarchy.buildings || hierarchy.buildings.length === 0) && (!hierarchy.units || hierarchy.units.length === 0))) && (
                  <div style={{ marginLeft: 12, color: "#9ca3af", fontStyle: "italic" }}>
                    No buildings or units yet. Assign room buckets below to create the structure.
                  </div>
                )}

                {/* Summary stats */}
                {hierarchy && (
                  <div style={{ marginTop: 12, paddingTop: 8, borderTop: "1px solid #e5e7eb", fontSize: 11, color: "#6b7280" }}>
                    <div>Buildings: {hierarchy.buildings?.length || 0}</div>
                    <div>Units: {(hierarchy.buildings?.reduce((sum: number, b: any) => sum + (b.units?.length || 0), 0) || 0) + (hierarchy.units?.length || 0)}</div>
                    <div>Rooms: {
                      (hierarchy.buildings?.reduce((sum: number, b: any) => {
                        const unitRooms = (b.units || []).reduce((s: number, u: any) => s + (u.particles?.length || 0), 0);
                        return sum + unitRooms + (b.particles?.length || 0);
                      }, 0) || 0) +
                      (hierarchy.units?.reduce((sum: number, u: any) => sum + (u.particles?.length || 0), 0) || 0)
                    }</div>
                  </div>
                )}
              </div>
            </div>

            {/* Right: Assignment Panel */}
            <div
              style={{
                border: "1px solid #e5e7eb",
                borderRadius: 8,
                background: "#ffffff",
                overflow: "hidden",
              }}
            >
              <div
                style={{
                  padding: "8px 12px",
                  background: "#f3f4f6",
                  borderBottom: "1px solid #e5e7eb",
                  fontSize: 12,
                  fontWeight: 600,
                }}
              >
                Room Buckets (from Xactimate Import)
              </div>
              <div style={{ padding: 12 }}>
                {importRoomBucketsLoading && (
                  <p style={{ fontSize: 12, color: "#6b7280" }}>Loading room buckets…</p>
                )}

                {!importRoomBucketsLoading && importRoomBucketsError && (
                  <p style={{ fontSize: 12, color: "#b91c1c" }}>{importRoomBucketsError}</p>
                )}

                {!importRoomBucketsLoading &&
                  !importRoomBucketsError &&
                  importRoomBuckets &&
                  importRoomBuckets.length === 0 && (
                    <p style={{ fontSize: 12, color: "#6b7280" }}>
                      No RAW Xactimate imports found for this project yet.
                    </p>
                  )}

                {!importRoomBucketsLoading &&
                  !importRoomBucketsError &&
                  importRoomBuckets &&
                  importRoomBuckets.length > 0 && (
                    <>
                {/* Assignment controls */}
                <div
                  style={{
                    display: "flex",
                    flexWrap: "wrap",
                    gap: 12,
                    alignItems: "flex-end",
                    marginBottom: 8,
                  }}
                >
                  <div style={{ fontSize: 12 }}>
                    <div style={{ marginBottom: 4, fontWeight: 600 }}>
                      Selected buckets: {importRoomBucketsSelection.size}
                    </div>
                    <div style={{ color: "#6b7280" }}>
                      Tip: use the checkboxes to multi-select similar buckets and
                      assign them to a Unit.
                    </div>
                  </div>

                  <div
                    style={{
                      marginLeft: "auto",
                      display: "flex",
                      flexWrap: "wrap",
                      gap: 8,
                      alignItems: "center",
                      fontSize: 12,
                    }}
                  >
                    <span style={{ fontWeight: 600 }}>Assign to Unit:</span>

                    <label style={{ display: "flex", alignItems: "center", gap: 4 }}>
                      <input
                        type="radio"
                        name="assignTargetType"
                        value="existing"
                        checked={assignTargetType === "existing"}
                        onChange={() => setAssignTargetType("existing")}
                      />
                      <span>Existing</span>
                    </label>

                    <label style={{ display: "flex", alignItems: "center", gap: 4 }}>
                      <input
                        type="radio"
                        name="assignTargetType"
                        value="new"
                        checked={assignTargetType === "new"}
                        onChange={() => setAssignTargetType("new")}
                      />
                      <span>New</span>
                    </label>

                    {assignTargetType === "existing" && (
                      <select
                        value={assignExistingUnitId}
                        onChange={e => setAssignExistingUnitId(e.target.value)}
                        style={{
                          padding: "4px 6px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                          minWidth: 160,
                        }}
                      >
                        <option value="">Select unit…</option>
                        {hierarchy && (
                          <>
                            {hierarchy.buildings.map((b: any) =>
                              (b.units || []).map((u: any) => (
                                <option key={u.id} value={u.id}>
                                  {u.label}
                                  {typeof u.floor === "number"
                                    ? ` (Floor ${u.floor})`
                                    : ""}
                                </option>
                              )),
                            )}
                            {hierarchy.units.map((u: any) => (
                              <option key={u.id} value={u.id}>
                                {u.label}
                                {typeof u.floor === "number" ? ` (Floor ${u.floor})` : ""}
                              </option>
                            ))}
                          </>
                        )}
                      </select>
                    )}

                    {assignTargetType === "new" && (
                      <>
                        <input
                          type="text"
                          placeholder="New unit label (e.g. Unit 163 L)"
                          value={assignNewUnitLabel}
                          onChange={e => setAssignNewUnitLabel(e.target.value)}
                          style={{
                            padding: "4px 6px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 12,
                            minWidth: 180,
                          }}
                        />
                        <input
                          type="number"
                          placeholder="Floor"
                          value={assignNewUnitFloor}
                          onChange={e => setAssignNewUnitFloor(e.target.value)}
                          style={{
                            width: 70,
                            padding: "4px 6px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            fontSize: 12,
                          }}
                        />
                      </>
                    )}

                    <button
                      type="button"
                      disabled={
                        assignSubmitting ||
                        importRoomBucketsSelection.size === 0 ||
                        (assignTargetType === "existing" && !assignExistingUnitId) ||
                        (assignTargetType === "new" && !assignNewUnitLabel.trim())
                      }
                      onClick={async () => {
                        setAssignMessage(null);
                        if (importRoomBucketsSelection.size === 0) return;
                        const token = localStorage.getItem("accessToken");
                        if (!token) {
                          setAssignMessage("Missing access token. Please login again.");
                          return;
                        }

                        const selectedKeys = new Set(importRoomBucketsSelection);
                        const bucketsPayload = (importRoomBuckets || [])
                          .filter(b =>
                            selectedKeys.has(
                              `${b.groupCode ?? ""}::${b.groupDescription ?? ""}`,
                            ),
                          )
                          .map(b => ({
                            groupCode: b.groupCode,
                            groupDescription: b.groupDescription,
                          }));
                        if (bucketsPayload.length === 0) {
                          setAssignMessage("No matching buckets found for selection.");
                          return;
                        }

                        const target: any =
                          assignTargetType === "existing"
                            ? { type: "existing", unitId: assignExistingUnitId }
                            : {
                                type: "new",
                                label: assignNewUnitLabel,
                                floor:
                                  assignNewUnitFloor.trim() === ""
                                    ? null
                                    : Number(assignNewUnitFloor),
                              };

                        setAssignSubmitting(true);
                        try {
                          const res = await fetch(
                            `${API_BASE}/projects/${id}/import-structure/assign-buckets-to-unit`,
                            {
                              method: "POST",
                              headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                              },
                              body: JSON.stringify({ target, buckets: bucketsPayload }),
                            },
                          );
                          if (!res.ok) {
                            const text = await res.text().catch(() => "");
                            setAssignMessage(
                              `Assign failed (${res.status}). ${text || ""}`,
                            );
                            return;
                          }

                          setAssignMessage("Assigned buckets to unit.");
                          setImportRoomBucketsSelection(new Set());
                          // Refresh buckets and hierarchy so the tree updates in real-time
                          try {
                            setImportRoomBucketsLoading(true);
                            const [bucketsRes, hierarchyRes] = await Promise.all([
                              fetch(
                                `${API_BASE}/projects/${id}/import-structure/room-buckets`,
                                { headers: { Authorization: `Bearer ${token}` } },
                              ),
                              fetch(
                                `${API_BASE}/projects/${id}/hierarchy`,
                                { headers: { Authorization: `Bearer ${token}` } },
                              ),
                            ]);
                            if (bucketsRes.ok) {
                              const json: any = await bucketsRes.json();
                              setImportRoomBuckets(
                                Array.isArray(json.buckets) ? json.buckets : [],
                              );
                            }
                            if (hierarchyRes.ok) {
                              const hierarchyJson: any = await hierarchyRes.json();
                              setHierarchy(hierarchyJson);
                            }
                          } finally {
                            setImportRoomBucketsLoading(false);
                          }
                        } catch (err: any) {
                          setAssignMessage(err?.message || "Assign failed.");
                        } finally {
                          setAssignSubmitting(false);
                        }
                      }}
                      style={{
                        padding: "6px 10px",
                        borderRadius: 4,
                        border: "1px solid #0f172a",
                        backgroundColor:
                          assignSubmitting || importRoomBucketsSelection.size === 0
                            ? "#e5e7eb"
                            : "#0f172a",
                        color:
                          assignSubmitting || importRoomBucketsSelection.size === 0
                            ? "#4b5563"
                            : "#f9fafb",
                        fontSize: 12,
                        cursor:
                          assignSubmitting || importRoomBucketsSelection.size === 0
                            ? "default"
                            : "pointer",
                      }}
                    >
                      {assignSubmitting ? "Assigning…" : "Assign selected"}
                    </button>
                  </div>
                </div>

                {assignMessage && (
                  <div
                    style={{
                      marginBottom: 8,
                      fontSize: 12,
                      color: assignMessage.toLowerCase().includes("fail")
                        ? "#b91c1c"
                        : "#4b5563",
                    }}
                  >
                    {assignMessage}
                  </div>
                )}

                <div style={{ maxHeight: "75vh", overflow: "auto" }}>
                  <table
                    style={{
                      width: "100%",
                      borderCollapse: "collapse",
                      fontSize: 12,
                    }}
                  >
                    <thead>
                      <tr style={{ backgroundColor: "#f9fafb" }}>
                        <th style={{ padding: "6px 8px" }}>
                          <input
                            type="checkbox"
                            checked={
                              importRoomBucketsSelection.size > 0 &&
                              importRoomBucketsSelection.size ===
                                importRoomBuckets.length
                            }
                            onChange={e => {
                              if (!importRoomBuckets) return;
                              const checked = e.target.checked;
                              if (!checked) {
                                setImportRoomBucketsSelection(new Set());
                              } else {
                                const next = new Set<string>();
                                for (const b of importRoomBuckets) {
                                  const key = `${b.groupCode ?? ""}::${
                                    b.groupDescription ?? ""
                                  }`;
                                  next.add(key);
                                }
                                setImportRoomBucketsSelection(next);
                              }
                            }}
                          />
                        </th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>Assigned Unit</th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>Bucket</th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>Group Code</th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>
                          Group Description
                        </th>
                        <th style={{ textAlign: "right", padding: "6px 8px" }}>Lines</th>
                        <th style={{ textAlign: "right", padding: "6px 8px" }}>Total</th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>
                          Assigned Unit
                        </th>
                        <th style={{ textAlign: "left", padding: "6px 8px" }}>
                          Assigned Room Label
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {importRoomBucketsByUnit.map(unitGroup => {
                        const unitIsExpanded = expandedImportUnitKeys.has(unitGroup.unitKey);

                        const unitBucketKeys = unitGroup.buckets.map(
                          b => `${b.groupCode ?? ""}::${b.groupDescription ?? ""}`,
                        );

                        const unitAllSelected =
                          unitBucketKeys.length > 0 &&
                          unitBucketKeys.every(k => importRoomBucketsSelection.has(k));

                        return (
                          <Fragment key={`unit::${unitGroup.unitKey}`}>
                            <tr>
                              <td
                                style={{
                                  padding: "4px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  background: "#f9fafb",
                                }}
                              >
                                <input
                                  type="checkbox"
                                  checked={unitAllSelected}
                                  onChange={e => {
                                    const checked = e.target.checked;
                                    setImportRoomBucketsSelection(prev => {
                                      const next = new Set(prev);
                                      for (const k of unitBucketKeys) {
                                        if (checked) next.add(k);
                                        else next.delete(k);
                                      }
                                      return next;
                                    });
                                  }}
                                />
                              </td>
                              <td
                                style={{
                                  padding: "4px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  fontSize: 12,
                                  fontWeight: 600,
                                  color: "#111827",
                                  whiteSpace: "nowrap",
                                  cursor: "pointer",
                                  background: "#f9fafb",
                                }}
                                onClick={() => toggleImportUnitExpanded(unitGroup.unitKey)}
                              >
                                {unitIsExpanded ? "▾" : "▸"} {unitGroup.unitLabel}
                              </td>
                              <td
                                style={{
                                  padding: "4px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  background: "#f9fafb",
                                  color: "#6b7280",
                                  whiteSpace: "nowrap",
                                }}
                              >
                                {unitGroup.buckets.length} buckets
                              </td>
                              <td style={{ padding: "4px 8px", borderTop: "1px solid #e5e7eb", background: "#f9fafb" }} />
                              <td style={{ padding: "4px 8px", borderTop: "1px solid #e5e7eb", background: "#f9fafb" }} />
                              <td
                                style={{
                                  padding: "4px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  textAlign: "right",
                                  background: "#f9fafb",
                                  whiteSpace: "nowrap",
                                }}
                              >
                                {unitGroup.lineCount}
                              </td>
                              <td
                                style={{
                                  padding: "4px 8px",
                                  borderTop: "1px solid #e5e7eb",
                                  textAlign: "right",
                                  background: "#f9fafb",
                                  whiteSpace: "nowrap",
                                }}
                              >
                                {unitGroup.totalAmount.toLocaleString(undefined, {
                                  maximumFractionDigits: 2,
                                })}
                              </td>
                              <td style={{ padding: "4px 8px", borderTop: "1px solid #e5e7eb", background: "#f9fafb" }} />
                              <td style={{ padding: "4px 8px", borderTop: "1px solid #e5e7eb", background: "#f9fafb" }} />
                            </tr>

                            {unitIsExpanded &&
                              unitGroup.buckets.map((b, idx) => {
                                const key = `${b.groupCode ?? ""}::${
                                  b.groupDescription ?? ""
                                }`;
                                const selected = importRoomBucketsSelection.has(key);
                                const isExpanded = expandedImportBucketKeys.has(key);
                                const linesEntry = importRoomBucketLines[key];

                                return (
                                  <Fragment key={`${unitGroup.unitKey}::${key}::${idx}`}>
                                    <tr>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                        }}
                                      >
                                        <input
                                          type="checkbox"
                                          checked={selected}
                                          onChange={e => {
                                            setImportRoomBucketsSelection(prev => {
                                              const next = new Set(prev);
                                              if (e.target.checked) next.add(key);
                                              else next.delete(key);
                                              return next;
                                            });
                                          }}
                                        />
                                      </td>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          fontSize: 11,
                                          color: "#9ca3af",
                                          whiteSpace: "nowrap",
                                        }}
                                      >
                                        {/* grouped under the unit row */}
                                      </td>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          cursor: "pointer",
                                          color: "#2563eb",
                                          whiteSpace: "nowrap",
                                        }}
                                        onClick={() => toggleImportBucketExpanded(b)}
                                      >
                                        {isExpanded ? "▾" : "▸"} Bucket
                                      </td>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          whiteSpace: "nowrap",
                                        }}
                                      >
                                        {b.groupCode ?? ""}
                                      </td>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                        }}
                                      >
                                        {b.groupDescription ?? ""}
                                      </td>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          textAlign: "right",
                                        }}
                                      >
                                        {b.lineCount}
                                      </td>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          textAlign: "right",
                                        }}
                                      >
                                        {b.totalAmount.toLocaleString(undefined, {
                                          maximumFractionDigits: 2,
                                        })}
                                      </td>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          fontSize: 11,
                                          color: "#4b5563",
                                        }}
                                      >
                                        {b.assignedUnitLabel ?? "—"}
                                      </td>
                                      <td
                                        style={{
                                          padding: "4px 8px",
                                          borderTop: "1px solid #e5e7eb",
                                          fontSize: 11,
                                          color: "#4b5563",
                                        }}
                                      >
                                        {b.assignedFullLabel ?? "—"}
                                      </td>
                                    </tr>

                                    {isExpanded && (
                                      <tr key={`${key}::${idx}::lines`}>
                                        <td colSpan={9} style={{ padding: 0, borderTop: "none" }}>
                                          <div
                                            style={{
                                              backgroundColor: "#f9fafb",
                                              padding: "4px 8px 8px 32px",
                                            }}
                                          >
                                            {!linesEntry && (
                                              <div
                                                style={{
                                                  fontSize: 12,
                                                  color: "#6b7280",
                                                }}
                                              >
                                                Loading lines…
                                              </div>
                                            )}
                                            {linesEntry && linesEntry.loading && (
                                              <div
                                                style={{
                                                  fontSize: 12,
                                                  color: "#6b7280",
                                                }}
                                              >
                                                Loading lines…
                                              </div>
                                            )}
                                            {linesEntry &&
                                              linesEntry.error &&
                                              !linesEntry.loading && (
                                                <div
                                                  style={{
                                                    fontSize: 12,
                                                    color: "#b91c1c",
                                                  }}
                                                >
                                                  {linesEntry.error}
                                                </div>
                                              )}
                                            {linesEntry &&
                                              !linesEntry.loading &&
                                              !linesEntry.error && (
                                                <table
                                                  style={{
                                                    width: "100%",
                                                    borderCollapse: "collapse",
                                                    fontSize: 11,
                                                  }}
                                                >
                                                  <thead>
                                                    <tr style={{ backgroundColor: "#e5e7eb" }}>
                                                      <th
                                                        style={{
                                                          textAlign: "left",
                                                          padding: "4px 6px",
                                                        }}
                                                      >
                                                        Line
                                                      </th>
                                                      <th
                                                        style={{
                                                          textAlign: "left",
                                                          padding: "4px 6px",
                                                        }}
                                                      >
                                                        Description
                                                      </th>
                                                      <th
                                                        style={{
                                                          textAlign: "right",
                                                          padding: "4px 6px",
                                                        }}
                                                      >
                                                        Qty
                                                      </th>
                                                      <th
                                                        style={{
                                                          textAlign: "right",
                                                          padding: "4px 6px",
                                                        }}
                                                      >
                                                        Unit
                                                      </th>
                                                      <th
                                                        style={{
                                                          textAlign: "right",
                                                          padding: "4px 6px",
                                                        }}
                                                      >
                                                        Total
                                                      </th>
                                                      <th
                                                        style={{
                                                          textAlign: "left",
                                                          padding: "4px 6px",
                                                        }}
                                                      >
                                                        Cat
                                                      </th>
                                                      <th
                                                        style={{
                                                          textAlign: "left",
                                                          padding: "4px 6px",
                                                        }}
                                                      >
                                                        Sel
                                                      </th>
                                                      <th
                                                        style={{
                                                          textAlign: "left",
                                                          padding: "4px 6px",
                                                        }}
                                                      >
                                                        Source
                                                      </th>
                                                    </tr>
                                                  </thead>
                                                  <tbody>
                                                    {linesEntry.rows.map(line => (
                                                      <tr key={line.lineNo}>
                                                        <td
                                                          style={{
                                                            padding: "3px 6px",
                                                            borderTop:
                                                              "1px solid #e5e7eb",
                                                          }}
                                                        >
                                                          {line.lineNo}
                                                        </td>
                                                        <td
                                                          style={{
                                                            padding: "3px 6px",
                                                            borderTop:
                                                              "1px solid #e5e7eb",
                                                          }}
                                                        >
                                                          {line.desc ?? ""}
                                                        </td>
                                                        <td
                                                          style={{
                                                            padding: "3px 6px",
                                                            borderTop:
                                                              "1px solid #e5e7eb",
                                                            textAlign: "right",
                                                          }}
                                                        >
                                                          {line.qty ?? ""}
                                                        </td>
                                                        <td
                                                          style={{
                                                            padding: "3px 6px",
                                                            borderTop:
                                                              "1px solid #e5e7eb",
                                                            textAlign: "right",
                                                          }}
                                                        >
                                                          {line.unit ?? ""}
                                                        </td>
                                                        <td
                                                          style={{
                                                            padding: "3px 6px",
                                                            borderTop:
                                                              "1px solid #e5e7eb",
                                                            textAlign: "right",
                                                          }}
                                                        >
                                                          {line.itemAmount != null
                                                            ? line.itemAmount.toLocaleString(
                                                                undefined,
                                                                {
                                                                  maximumFractionDigits: 2,
                                                                },
                                                              )
                                                            : ""}
                                                        </td>
                                                        <td
                                                          style={{
                                                            padding: "3px 6px",
                                                            borderTop:
                                                              "1px solid #e5e7eb",
                                                          }}
                                                        >
                                                          {line.cat ?? ""}
                                                        </td>
                                                        <td
                                                          style={{
                                                            padding: "3px 6px",
                                                            borderTop:
                                                              "1px solid #e5e7eb",
                                                          }}
                                                        >
                                                          {line.sel ?? ""}
                                                        </td>
                                                        <td
                                                          style={{
                                                            padding: "3px 6px",
                                                            borderTop:
                                                              "1px solid #e5e7eb",
                                                            fontSize: 10,
                                                            color: "#6b7280",
                                                          }}
                                                        >
                                                          {line.sourceName ??
                                                            line.owner ??
                                                            ""}
                                                        </td>
                                                      </tr>
                                                    ))}
                                                  </tbody>
                                                </table>
                                              )}
                                          </div>
                                        </td>
                                      </tr>
                                    )}
                                  </Fragment>
                                );
                              })}
                          </Fragment>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </>
            )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* JOURNAL tab content (Admin+ only) */}
      {activeTab === "JOURNAL" && isAdminOrAbove && (
        <div style={{ marginTop: 8, marginBottom: 16 }}>
          <h2 style={{ fontSize: 16, fontWeight: 600, marginBottom: 6 }}>Claim Journal</h2>
          <p style={{ fontSize: 12, color: "#6b7280", marginBottom: 12 }}>
            Track carrier negotiations, submissions, responses, and approvals in an append-only audit trail.
          </p>
          <JournalTab projectId={id} apiBase={API_BASE} />
        </div>
      )}

      {/* DAILY_LOGS tab content */}
      {activeTab === "DAILY_LOGS" && (
        <div style={{ marginTop: 8, marginBottom: 16 }}>
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "2fr 3fr",
              gap: 12,
              alignItems: "flex-start",
            }}
          >
            {/* Left column: log info + permissions */}
            <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
              <div
                style={{
                  borderRadius: 8,
                  border: "1px solid #e5e7eb",
                  background: "#ffffff",
                }}
              >
                <div
                  style={{
                    padding: "6px 10px",
                    borderBottom: "1px solid #e5e7eb",
                    fontSize: 13,
                    fontWeight: 600,
                    background: "#f3f4f6",
                  }}
                >
                  Daily Log Information
                </div>
                <form onSubmit={handleCreateDailyLog} style={{ padding: 10, fontSize: 13 }}>
                  <div style={{ marginBottom: 6 }}>
                    <div style={{ fontWeight: 600, marginBottom: 2 }}>Job</div>
                    <div style={{ color: "#4b5563" }}>{project.name}</div>
                  </div>

                  <div style={{ display: "flex", gap: 8, marginBottom: 6 }}>
                    <div style={{ flex: 1 }}>
                      <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                        Type
                      </label>
                      <select
                        value={newDailyLog.type}
                        onChange={e =>
                          setNewDailyLog(prev => ({ ...prev, type: e.target.value as DailyLogType }))
                        }
                        style={{
                          width: "100%",
                          padding: "4px 6px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                        }}
                      >
                        <option value="PUDL">Daily Log (PUDL)</option>
                        <option value="RECEIPT_EXPENSE">Receipt / Expense</option>
                        <option value="JSA">Job Safety Assessment</option>
                        <option value="INCIDENT">Incident Report</option>
                        <option value="QUALITY">Quality Inspection</option>
                      </select>
                    </div>
                    <div style={{ flex: 1 }}>
                      <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                        Date
                      </label>
                      <input
                        type="date"
                        value={newDailyLog.logDate}
                        onChange={e =>
                          setNewDailyLog(prev => ({ ...prev, logDate: e.target.value }))
                        }
                        style={{
                          width: "100%",
                          padding: "4px 6px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                        }}
                      />
                    </div>
                  </div>

                  {/* Receipt/Expense fields - shown when type is RECEIPT_EXPENSE */}
                  {newDailyLog.type === "RECEIPT_EXPENSE" && (
                    <div
                      style={{
                        marginBottom: 6,
                        padding: "8px",
                        borderRadius: 4,
                        background: "#fef3c7",
                        border: "1px solid #fcd34d",
                      }}
                    >
                      <div style={{ fontSize: 11, fontWeight: 600, marginBottom: 6, color: "#92400e" }}>
                        Receipt Details
                      </div>
                      <div style={{ display: "flex", gap: 8, marginBottom: 6 }}>
                        <div style={{ flex: 2 }}>
                          <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>
                            Vendor
                          </label>
                          <input
                            type="text"
                            value={newDailyLog.expenseVendor}
                            onChange={e =>
                              setNewDailyLog(prev => ({ ...prev, expenseVendor: e.target.value }))
                            }
                            placeholder="Home Depot, Lowe's, etc."
                            style={{
                              width: "100%",
                              padding: "4px 6px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                        </div>
                        <div style={{ flex: 1 }}>
                          <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>
                            Amount
                          </label>
                          <input
                            type="number"
                            step="0.01"
                            min="0"
                            value={newDailyLog.expenseAmount}
                            onChange={e =>
                              setNewDailyLog(prev => ({ ...prev, expenseAmount: e.target.value }))
                            }
                            placeholder="0.00"
                            style={{
                              width: "100%",
                              padding: "4px 6px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                        </div>
                        <div style={{ flex: 1 }}>
                          <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>
                            Receipt Date
                          </label>
                          <input
                            type="date"
                            value={newDailyLog.expenseDate}
                            onChange={e =>
                              setNewDailyLog(prev => ({ ...prev, expenseDate: e.target.value }))
                            }
                            style={{
                              width: "100%",
                              padding: "4px 6px",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 12,
                            }}
                          />
                        </div>
                      </div>
                      <div style={{ fontSize: 10, color: "#92400e" }}>
                        📸 Attach a receipt photo below. OCR will auto-extract vendor and amount.
                      </div>
                    </div>
                  )}

                  {pudlContext.open && pudlContext.breadcrumb && (
                    <div
                      style={{
                        marginBottom: 6,
                        padding: "6px 8px",
                        borderRadius: 4,
                        background: "#eff6ff",
                        border: "1px solid #bfdbfe",
                        fontSize: 12,
                        color: "#1d4ed8",
                      }}
                    >
                      <div style={{ fontWeight: 600 }}>PUDL context</div>
                      <div>{pudlContext.breadcrumb}</div>
                    </div>
                  )}

                  <div style={{ marginBottom: 6 }}>
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 2 }}>
                      <label style={{ fontSize: 12 }}>
                        Subject / Title
                      </label>
                      {newDailyLog.workPerformed.trim().length > 10 && !newDailyLog.title.trim() && (
                        <button
                          type="button"
                          onClick={() => setNewDailyLog(prev => ({ ...prev, title: summarizeToTitle(prev.workPerformed) }))}
                          style={{
                            padding: "2px 6px",
                            borderRadius: 4,
                            border: "1px solid #d1d5db",
                            background: "#fefce8",
                            fontSize: 10,
                            cursor: "pointer",
                            display: "flex",
                            alignItems: "center",
                            gap: 3,
                          }}
                        >
                          ✨ Auto-generate
                        </button>
                      )}
                    </div>
                    <DescriptionPicker
                      value={newDailyLog.title}
                      onChange={(val) => setNewDailyLog(prev => ({ ...prev, title: val }))}
                      category="DAILY_LOG"
                      placeholder="Auto-fills from notes if left empty"
                      style={{ width: "100%" }}
                      inputStyle={{ fontSize: 12, padding: "4px 6px" }}
                    />
                  </div>

                  <div style={{ marginBottom: 6 }}>
                    <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                      Tags (comma separated)
                    </label>
                    <input
                      type="text"
                      value={newDailyLog.tags}
                      onChange={e =>
                        setNewDailyLog(prev => ({ ...prev, tags: e.target.value }))
                      }
                      placeholder="roof, phase-1, interior"
                      style={{
                        width: "100%",
                        padding: "4px 6px",
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        fontSize: 12,
                      }}
                    />
                  </div>

                  <div
                    style={{
                      display: "flex",
                      gap: 8,
                      marginBottom: 6,
                      alignItems: "flex-start",
                      flexWrap: "wrap",
                    }}
                  >
                    <div style={{ flex: 2, minWidth: 0 }}>
                      <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                        Person/s onsite
                      </label>
                      {(() => {
                        const availableOptions = personOnsiteOptions.filter(opt =>
                          !personOnsiteList.some(
                            name => name.toLowerCase() === opt.value.toLowerCase(),
                          ),
                        );
                        return (
                          <>
                            {availableOptions.length > 0 && (
                              <div style={{ marginBottom: 4 }}>
                                <select
                                  value=""
                                  onChange={e => {
                                    const value = e.target.value;
                                    if (!value) return;
                                    updatePersonOnsiteList(prev =>
                                      prev.some(
                                        name =>
                                          name.toLowerCase() === value.toLowerCase(),
                                      )
                                        ? prev
                                        : [...prev, value],
                                    );
                                  }}
                                  style={{
                                    width: "100%",
                                    padding: "4px 6px",
                                    borderRadius: 4,
                                    border: "1px solid #d1d5db",
                                    fontSize: 12,
                                    marginBottom: 4,
                                  }}
                                >
                                  <option value="">Add from project roster…</option>
                                  {availableOptions.map(opt => (
                                    <option key={opt.value} value={opt.value}>
                                      {opt.label}
                                    </option>
                                  ))}
                                </select>
                              </div>
                            )}

                            <div
                              style={{
                                minHeight: 34,
                                padding: "4px 6px",
                                borderRadius: 4,
                                border: "1px solid #d1d5db",
                                display: "flex",
                                flexWrap: "wrap",
                                gap: 4,
                                cursor: "text",
                              }}
                              onClick={() => {
                                const inputEl = document.getElementById(
                                  "person-onsite-draft-input",
                                ) as HTMLInputElement | null;
                                inputEl?.focus();
                              }}
                            >
                              {personOnsiteList.map(name => (
                                <span
                                  key={name}
                                  style={{
                                    display: "inline-flex",
                                    alignItems: "center",
                                    gap: 4,
                                    padding: "2px 6px",
                                    borderRadius: 999,
                                    backgroundColor: "#eff6ff",
                                    border: "1px solid #bfdbfe",
                                    fontSize: 11,
                                    color: "#1d4ed8",
                                  }}
                                >
                                  <span>{name}</span>
                                  <button
                                    type="button"
                                    onClick={e => {
                                      e.stopPropagation();
                                      updatePersonOnsiteList(prev =>
                                        prev.filter(n => n !== name),
                                      );
                                    }}
                                    style={{
                                      border: "none",
                                      background: "transparent",
                                      cursor: "pointer",
                                      fontSize: 11,
                                      color: "#1d4ed8",
                                    }}
                                  >
                                    ×
                                  </button>
                                </span>
                              ))}
                              <input
                                id="person-onsite-draft-input"
                                type="text"
                                value={personOnsiteDraft}
                                onChange={e => setPersonOnsiteDraft(e.target.value)}
                                onKeyDown={e => {
                                  if (e.key === "Enter" || e.key === ",") {
                                    e.preventDefault();
                                    const raw = personOnsiteDraft.trim();
                                    if (!raw) return;
                                    updatePersonOnsiteList(prev =>
                                      prev.some(
                                        name =>
                                          name.toLowerCase() === raw.toLowerCase(),
                                      )
                                        ? prev
                                        : [...prev, raw],
                                    );
                                    setPersonOnsiteDraft("");
                                  }
                                }}
                                onBlur={e => {
                                  const raw = e.target.value.trim();
                                  if (!raw) {
                                    setPersonOnsiteDraft("");
                                    return;
                                  }
                                  updatePersonOnsiteList(prev =>
                                    prev.some(
                                      name =>
                                        name.toLowerCase() === raw.toLowerCase(),
                                    )
                                      ? prev
                                      : [...prev, raw],
                                  );
                                  setPersonOnsiteDraft("");
                                }}
                                placeholder={
                                  personOnsiteList.length === 0
                                    ? "Type a person onsite and press Enter…"
                                    : "Type another name and press Enter…"
                                }
                                style={{
                                  flex: 1,
                                  minWidth: 120,
                                  border: "none",
                                  outline: "none",
                                  fontSize: 12,
                                  padding: 0,
                                }}
                              />
                            </div>

                            <div style={{ marginTop: 4, fontSize: 11, color: "#6b7280" }}>
                              If a person isn&apos;t in the roster dropdown, type their name
                              above. We&apos;ll create a workflow item for tenant admin to add
                              them to this project.
                            </div>

                            <div
                              style={{
                                marginTop: 6,
                                fontSize: 11,
                                color: "#4b5563",
                                display: "flex",
                                flexWrap: "wrap",
                                gap: 6,
                                alignItems: "center",
                              }}
                            >
                              <button
                                type="button"
                                disabled={personOnsiteList.length === 0}
                                onClick={() => {
                                  if (!personOnsiteList.length) return;
                                  const name = window.prompt(
                                    "Name this person/s onsite group (favorites)",
                                  );
                                  if (!name) return;
                                  const trimmed = name.trim();
                                  if (!trimmed) return;
                                  const id = `grp-${Date.now().toString(36)}-${Math.random()
                                    .toString(36)
                                    .slice(2, 8)}`;
                                  const group = {
                                    id,
                                    name: trimmed,
                                    members: [...personOnsiteList],
                                  };
                                  persistPersonOnsiteGroups([
                                    ...personOnsiteGroups,
                                    group,
                                  ]);
                                  setSelectedPersonOnsiteGroupId(id);
                                }}
                                style={{
                                  padding: "3px 8px",
                                  borderRadius: 999,
                                  border: "1px solid #d1d5db",
                                  backgroundColor:
                                    personOnsiteList.length === 0
                                      ? "#f9fafb"
                                      : "#ffffff",
                                  fontSize: 11,
                                  cursor:
                                    personOnsiteList.length === 0
                                      ? "default"
                                      : "pointer",
                                }}
                              >
                                Save group as favorite
                              </button>
                              {personOnsiteGroups.length > 0 && (
                                <>
                                  <span>Favorites:</span>
                                  <select
                                    value={selectedPersonOnsiteGroupId}
                                    onChange={e => {
                                      const id = e.target.value;
                                      setSelectedPersonOnsiteGroupId(id);
                                      const group = personOnsiteGroups.find(g => g.id === id);
                                      if (group) {
                                        updatePersonOnsiteList(() => [...group.members]);
                                      }
                                    }}
                                    style={{
                                      padding: "3px 6px",
                                      borderRadius: 4,
                                      border: "1px solid #d1d5db",
                                      fontSize: 11,
                                    }}
                                  >
                                    <option value="">Select group…</option>
                                    {personOnsiteGroups.map(g => (
                                      <option key={g.id} value={g.id}>
                                        {g.name}
                                      </option>
                                    ))}
                                  </select>
                                </>
                              )}
                            </div>
                          </>
                        );
                      })()}
                    </div>

                    <div style={{ flex: 1, minWidth: 140 }}>
                      <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                        Manpower onsite DL
                      </label>
                      <input
                        type="text"
                        value={personOnsiteList.length ? String(personOnsiteList.length) : ""}
                        readOnly
                        style={{
                          width: "100%",
                          padding: "4px 6px",
                          borderRadius: 4,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                          backgroundColor: "#f9fafb",
                          color: "#4b5563",
                        }}
                      />
                    </div>
                  </div>

                  <div style={{ marginBottom: 6 }}>
                    <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                      Confidential – NO PRINT
                    </label>
                    <textarea
                      value={newDailyLog.confidentialNotes}
                      onChange={e =>
                        setNewDailyLog(prev => ({ ...prev, confidentialNotes: e.target.value }))
                      }
                      rows={3}
                      style={{
                        width: "100%",
                        padding: "4px 6px",
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        fontSize: 12,
                        resize: "vertical",
                      }}
                    />
                  </div>

                  {/* Attachment Upload Section - Drag & Drop */}
                  <div style={{ marginTop: 8, marginBottom: 8 }}>
                    <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>
                      Attachments
                    </div>
                    <FileDropZone
                      accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx"
                      multiple={true}
                      buttonLabel="Browse Files"
                      buttonIcon="📷"
                      hint={newDailyLog.type === "RECEIPT_EXPENSE" 
                        ? "Drag photos from Finder/Photos app, or use camera on mobile" 
                        : "Drag files from Finder, Photos, or click to browse"}
                      minHeight={100}
                      onFiles={async (files) => {
                        const token = localStorage.getItem("accessToken");
                        if (!token) {
                          setDailyLogMessage("Missing access token.");
                          return;
                        }

                        const uploadedFiles: { id: string; fileName: string; mimeType: string | null; storageUrl: string }[] = [];
                        const errors: string[] = [];

                        for (const file of files) {
                          try {
                            setDailyLogMessage(`Uploading ${file.name}...`);
                            
                            // Step 1: Get signed upload URL from project files endpoint
                            const urlRes = await fetch(`${API_BASE}/projects/${id}/files/upload-url`, {
                              method: "POST",
                              headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                              },
                              body: JSON.stringify({
                                contentType: file.type || "application/octet-stream",
                                fileName: file.name,
                              }),
                            });
                            if (!urlRes.ok) {
                              errors.push(`${file.name}: Failed to get upload URL (${urlRes.status})`);
                              continue;
                            }
                            const { uploadUrl, fileUri } = await urlRes.json();

                            // Step 2: Upload file to GCS via signed URL
                            const putRes = await fetch(uploadUrl, {
                              method: "PUT",
                              headers: {
                                "Content-Type": file.type || "application/octet-stream",
                              },
                              body: file,
                            });
                            if (!putRes.ok) {
                              errors.push(`${file.name}: Upload failed (${putRes.status})`);
                              continue;
                            }

                            // Step 3: Register the file in the project
                            const registerRes = await fetch(`${API_BASE}/projects/${id}/files`, {
                              method: "POST",
                              headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                              },
                              body: JSON.stringify({
                                fileUri,
                                fileName: file.name,
                                mimeType: file.type || null,
                                sizeBytes: file.size || null,
                              }),
                            });
                            if (!registerRes.ok) {
                              errors.push(`${file.name}: Failed to register file (${registerRes.status})`);
                              continue;
                            }
                            const uploaded = await registerRes.json();
                            uploadedFiles.push({
                              id: uploaded.id,
                              fileName: uploaded.fileName || file.name,
                              mimeType: uploaded.mimeType || file.type || null,
                              storageUrl: uploaded.storageUrl || fileUri,
                            });
                          } catch (err: any) {
                            errors.push(`${file.name}: ${err?.message || "Unknown error"}`);
                          }
                        }

                        if (uploadedFiles.length > 0) {
                          setNewDailyLog(prev => ({
                            ...prev,
                            attachmentProjectFileIds: [
                              ...(prev.attachmentProjectFileIds || []),
                              ...uploadedFiles.map(f => f.id),
                            ],
                            attachmentFiles: [
                              ...(prev.attachmentFiles || []),
                              ...uploadedFiles,
                            ],
                          }));

                          // For RECEIPT_EXPENSE: run immediate OCR on first image file
                          if (newDailyLog.type === "RECEIPT_EXPENSE") {
                            const firstImage = uploadedFiles.find(f => 
                              f.mimeType?.startsWith("image/") ||
                              f.fileName?.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/)
                            );
                            if (firstImage) {
                              setDailyLogMessage("Running OCR on receipt...");
                              try {
                                const ocrRes = await fetch(`${API_BASE}/projects/${id}/daily-logs/ocr`, {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({ projectFileId: firstImage.id }),
                                });
                                if (ocrRes.ok) {
                                  const ocrData = await ocrRes.json();
                                  if (ocrData.success) {
                                    // Build auto-generated title: "Expense - Vendor $Amount"
                                    const vendorName = ocrData.vendor || "Unknown Vendor";
                                    const amountStr = ocrData.amount != null ? `$${ocrData.amount.toFixed(2)}` : "";
                                    const autoTitle = `Expense - ${vendorName}${amountStr ? " " + amountStr : ""}`;
                                    
                                    setNewDailyLog(prev => ({
                                      ...prev,
                                      title: autoTitle,
                                      expenseVendor: ocrData.vendor || prev.expenseVendor,
                                      expenseAmount: ocrData.amount != null ? String(ocrData.amount) : prev.expenseAmount,
                                      expenseDate: ocrData.date || prev.expenseDate,
                                      workPerformed: "This note was automatically created by OCR, review needed.",
                                    }));
                                    const conf = ocrData.confidence ? `(${Math.round(ocrData.confidence * 100)}% confidence)` : "";
                                    setDailyLogMessage(`✓ OCR extracted: ${vendorName} - ${amountStr || "$?"} ${conf}`);
                                  } else {
                                    setDailyLogMessage(`OCR: ${ocrData.error || "Could not extract data"}`);
                                  }
                                } else {
                                  setDailyLogMessage(`✓ File attached (OCR unavailable)`);
                                }
                              } catch (ocrErr: any) {
                                setDailyLogMessage(`✓ File attached (OCR error: ${ocrErr?.message || "failed"})`);
                              }
                              return; // Skip the generic success message below
                            }
                          }
                        }

                        if (errors.length > 0) {
                          setDailyLogMessage(`Errors: ${errors.join(", ")}`);
                        } else {
                          setDailyLogMessage(`✓ ${uploadedFiles.length} file(s) attached`);
                        }
                      }}
                    />
                    {/* Display attached files with thumbnails */}
                    {newDailyLog.attachmentFiles && newDailyLog.attachmentFiles.length > 0 && (
                      <div style={{ 
                        marginTop: 8, 
                        display: "flex", 
                        flexWrap: "wrap", 
                        gap: 8,
                        padding: 8,
                        background: "#f0fdf4",
                        borderRadius: 6,
                        border: "1px solid #bbf7d0",
                      }}>
                        {newDailyLog.attachmentFiles.map((file, idx) => (
                          <div 
                            key={file.id} 
                            style={{ 
                              position: "relative",
                              width: 80, 
                              textAlign: "center",
                            }}
                          >
                            {/* Remove button */}
                            <button
                              type="button"
                              onClick={() => {
                                setNewDailyLog(prev => ({
                                  ...prev,
                                  attachmentProjectFileIds: (prev.attachmentProjectFileIds || []).filter((_, i) => i !== idx),
                                  attachmentFiles: (prev.attachmentFiles || []).filter((_, i) => i !== idx),
                                }));
                              }}
                              style={{
                                position: "absolute",
                                top: -6,
                                right: -6,
                                width: 20,
                                height: 20,
                                borderRadius: "50%",
                                border: "none",
                                background: "#ef4444",
                                color: "white",
                                fontSize: 12,
                                cursor: "pointer",
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                                zIndex: 1,
                              }}
                              title="Remove"
                            >
                              ×
                            </button>
                            {/* Thumbnail or icon */}
                            {file.mimeType?.startsWith("image/") ? (
                              <img
                                src={file.storageUrl.startsWith("gs://") 
                                  ? `https://storage.googleapis.com/${file.storageUrl.replace("gs://", "")}`
                                  : file.storageUrl}
                                alt={file.fileName}
                                style={{
                                  width: 60,
                                  height: 60,
                                  objectFit: "cover",
                                  borderRadius: 4,
                                  border: "1px solid #d1d5db",
                                }}
                              />
                            ) : (
                              <div style={{
                                width: 60,
                                height: 60,
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                                background: "white",
                                borderRadius: 4,
                                border: "1px solid #d1d5db",
                                fontSize: 24,
                              }}>
                                📄
                              </div>
                            )}
                            {/* File name */}
                            <div style={{ 
                              fontSize: 9, 
                              color: "#374151",
                              marginTop: 2,
                              overflow: "hidden",
                              textOverflow: "ellipsis",
                              whiteSpace: "nowrap",
                              maxWidth: 80,
                            }}>
                              {file.fileName}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  <div style={{ marginTop: 8, marginBottom: 8 }}>
                    <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>
                      Permissions
                      {newDailyLog.type === "RECEIPT_EXPENSE" && (
                        <span style={{ fontWeight: 400, color: "#6b7280", marginLeft: 6 }}>
                          (locked for receipts)
                        </span>
                      )}
                    </div>
                    <label style={{ display: "flex", alignItems: "center", gap: 6, opacity: newDailyLog.type === "RECEIPT_EXPENSE" ? 0.5 : 1 }}>
                      <input
                        type="checkbox"
                        checked={newDailyLog.type === "RECEIPT_EXPENSE" ? false : newDailyLog.shareInternal}
                        disabled={newDailyLog.type === "RECEIPT_EXPENSE"}
                        onChange={e =>
                          setNewDailyLog(prev => ({ ...prev, shareInternal: e.target.checked }))
                        }
                      />
                      <span>Internal Users</span>
                    </label>
                    <label style={{ display: "flex", alignItems: "center", gap: 6, opacity: newDailyLog.type === "RECEIPT_EXPENSE" ? 0.5 : 1 }}>
                      <input
                        type="checkbox"
                        checked={newDailyLog.type === "RECEIPT_EXPENSE" ? false : newDailyLog.shareSubs}
                        disabled={newDailyLog.type === "RECEIPT_EXPENSE"}
                        onChange={e =>
                          setNewDailyLog(prev => ({ ...prev, shareSubs: e.target.checked }))
                        }
                      />
                      <span>Subs / Vendors</span>
                    </label>
                    <label style={{ display: "flex", alignItems: "center", gap: 6, opacity: newDailyLog.type === "RECEIPT_EXPENSE" ? 0.5 : 1 }}>
                      <input
                        type="checkbox"
                        checked={newDailyLog.type === "RECEIPT_EXPENSE" ? false : newDailyLog.shareClient}
                        disabled={newDailyLog.type === "RECEIPT_EXPENSE"}
                        onChange={e =>
                          setNewDailyLog(prev => ({ ...prev, shareClient: e.target.checked }))
                        }
                      />
                      <span>Client</span>
                    </label>
                    <label style={{ display: "flex", alignItems: "center", gap: 6 }}>
                      <input
                        type="checkbox"
                        checked={newDailyLog.type === "RECEIPT_EXPENSE" ? true : newDailyLog.sharePrivate}
                        disabled={newDailyLog.type === "RECEIPT_EXPENSE"}
                        onChange={e =>
                          setNewDailyLog(prev => ({ ...prev, sharePrivate: e.target.checked }))
                        }
                      />
                      <span>Private (creator only)</span>
                    </label>
                  </div>

                  <div style={{ marginTop: 10, textAlign: "right" }}>
                    <button
                      type="submit"
                      disabled={dailyLogSaving}
                      style={{
                        padding: "6px 10px",
                        borderRadius: 4,
                        border: "1px solid #0f172a",
                        backgroundColor: dailyLogSaving ? "#e5e7eb" : "#0f172a",
                        color: dailyLogSaving ? "#4b5563" : "#f9fafb",
                        fontSize: 12,
                        cursor: dailyLogSaving ? "default" : "pointer",
                      }}
                    >
                      {dailyLogSaving ? "Saving…" : "Publish Daily Log"}
                    </button>
                  </div>

                  {dailyLogMessage && (
                    <div
                      style={{
                        marginTop: 6,
                        fontSize: 12,
                        color: dailyLogMessage.includes("Failed") ? "#b91c1c" : "#4b5563",
                      }}
                    >
                      {dailyLogMessage}
                    </div>
                  )}
                </form>
              </div>

              {/* Notes card - moved to left column */}
              <div
                style={{
                  borderRadius: 8,
                  border: "1px solid #e5e7eb",
                  background: "#ffffff",
                }}
              >
                <div
                  style={{
                    padding: "6px 10px",
                    borderBottom: "1px solid #e5e7eb",
                    fontSize: 13,
                    fontWeight: 600,
                    background: "#f3f4f6",
                  }}
                >
                  Notes
                </div>
                <div style={{ padding: 10, fontSize: 13 }}>
                  <div style={{ marginBottom: 6 }}>
                    <div style={{ fontSize: 12, marginBottom: 2 }}>Work Performed</div>
                    <textarea
                      value={newDailyLog.workPerformed}
                      onChange={e =>
                        setNewDailyLog(prev => ({ ...prev, workPerformed: e.target.value }))
                      }
                      rows={4}
                      style={{
                        width: "100%",
                        padding: "4px 6px",
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        fontSize: 12,
                        resize: "vertical",
                      }}
                    />
                  </div>
                  <div style={{ marginBottom: 6 }}>
                    <div style={{ fontSize: 12, marginBottom: 2 }}>Issues</div>
                    <textarea
                      value={newDailyLog.issues}
                      onChange={e =>
                        setNewDailyLog(prev => ({ ...prev, issues: e.target.value }))
                      }
                      rows={3}
                      style={{
                        width: "100%",
                        padding: "4px 6px",
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        fontSize: 12,
                        resize: "vertical",
                      }}
                    />
                  </div>
                  <div>
                    <div style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 12, marginBottom: 2 }}>
                      Safety Note
                      {newDailyLog.safetyIncidents && newDailyLog.safetyIncidents.trim() !== "" && (
                        <span style={{ fontSize: 9, fontWeight: 600, padding: "2px 6px", borderRadius: 4, backgroundColor: "#fef2f2", color: "#b91c1c", border: "1px solid #fecaca" }}>⚠️ Safety Review</span>
                      )}
                    </div>
                    <textarea
                      value={newDailyLog.safetyIncidents}
                      onChange={e =>
                        setNewDailyLog(prev => ({ ...prev, safetyIncidents: e.target.value }))
                      }
                      rows={3}
                      style={{
                        width: "100%",
                        padding: "4px 6px",
                        borderRadius: 4,
                        border: newDailyLog.safetyIncidents && newDailyLog.safetyIncidents.trim() !== "" ? "1px solid #fca5a5" : "1px solid #d1d5db",
                        fontSize: 12,
                        resize: "vertical",
                        backgroundColor: newDailyLog.safetyIncidents && newDailyLog.safetyIncidents.trim() !== "" ? "#fef2f2" : "#ffffff",
                      }}
                    />
                  </div>
                </div>
              </div>

              {/* Weather card - moved to left column */}
              <div
                style={{
                  borderRadius: 8,
                  border: "1px solid #e5e7eb",
                  background: "#ffffff",
                }}
              >
                <div
                  style={{
                    padding: "6px 10px",
                    borderBottom: "1px solid #e5e7eb",
                    fontSize: 13,
                    fontWeight: 600,
                    background: "#f3f4f6",
                  }}
                >
                  Weather
                </div>
                <div style={{ padding: 10, fontSize: 13 }}>
                  <div style={{ marginBottom: 6 }}>
                    <div style={{ fontSize: 12, marginBottom: 2 }}>
                      Weather Conditions / Notes
                    </div>
                    <textarea
                      value={newDailyLog.weatherSummary}
                      onChange={e =>
                        setNewDailyLog(prev => ({ ...prev, weatherSummary: e.target.value }))
                      }
                      rows={3}
                      style={{
                        width: "100%",
                        padding: "4px 6px",
                        borderRadius: 4,
                        border: "1px solid #d1d5db",
                        fontSize: 12,
                        resize: "vertical",
                      }}
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Right column: Daily Logs list at top */}
            <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
              <div
                style={{
                  borderRadius: 8,
                  border: "1px solid #e5e7eb",
                  background: "#ffffff",
                }}
              >
                <div
                  style={{
                    padding: "6px 10px",
                    borderBottom: "1px solid #e5e7eb",
                    fontSize: 13,
                    fontWeight: 600,
                    background: "#f3f4f6",
                  }}
                >
                  Daily Logs
                </div>
                <div style={{ padding: 10, fontSize: 13 }}>
                  {dailyLogsLoading && (
                    <div style={{ color: "#6b7280" }}>Loading daily logs…</div>
                  )}
                  {!dailyLogsLoading && dailyLogs.length === 0 && (
                    <div style={{ color: "#6b7280" }}>
                      No daily logs yet. Use the form above to publish the first one.
                    </div>
                  )}
                  {!dailyLogsLoading && dailyLogs.length > 0 && (
                    <>
                      <div style={{
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "center",
                        marginBottom: 4,
                        fontSize: 12,
                        color: "#4b5563",
                      }}>
                        <div>
                          Pending client logs: {dailyLogs.filter(l => l.shareClient && !l.effectiveShareClient).length}
                        </div>
                        <label style={{ display: "flex", alignItems: "center", gap: 4 }}>
                          <input
                            type="checkbox"
                            checked={showPendingClientOnly}
                            onChange={e => setShowPendingClientOnly(e.target.checked)}
                          />
                          <span>Show only pending client logs</span>
                        </label>
                      </div>

                      <div style={{ maxHeight: 400, overflowY: "auto" }}>
                        <table
                        style={{
                          width: "100%",
                          borderCollapse: "collapse",
                          fontSize: 12,
                        }}
                      >
                        <thead>
                          <tr style={{ backgroundColor: "#f9fafb" }}>
                            <th style={{ textAlign: "center", padding: "4px 6px", width: 100 }}>Actions</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>Date</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>Type</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>Title</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>
                              Work Performed
                            </th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>
                              Status
                            </th>
                            <th style={{ textAlign: "center", padding: "4px 6px", width: 40 }}></th>
                          </tr>
                        </thead>
                        <tbody>
                          {dailyLogs
                            .filter(log =>
                              !showPendingClientOnly
                                ? true
                                : log.shareClient && !log.effectiveShareClient,
                            )
                            .slice(0, 10)
                            .map(log => (
                            <tr key={log.id}>
                              {/* View, Edit & Delete actions */}
                              <td
                                style={{
                                  padding: "4px 6px",
                                  borderTop: "1px solid #e5e7eb",
                                  textAlign: "center",
                                }}
                              >
                                <div style={{ display: "flex", gap: 4, justifyContent: "center" }}>
                                  {/* View button - available to all */}
                                  <button
                                    type="button"
                                    onClick={() => setViewDailyLog({
                                      open: true,
                                      log,
                                      draft: {
                                        type: log.type || "PUDL",
                                        title: log.title || "",
                                        tags: "",
                                        logDate: log.logDate ? log.logDate.slice(0, 10) : "",
                                        workPerformed: log.workPerformed || "",
                                        crewOnSite: log.crewOnSite || "",
                                        issues: log.issues || "",
                                        safetyIncidents: log.safetyIncidents || "",
                                        weatherSummary: log.weatherSummary || "",
                                        personOnsite: log.personOnsite || "",
                                        manpowerOnsite: log.manpowerOnsite != null ? String(log.manpowerOnsite) : "",
                                        confidentialNotes: log.confidentialNotes || "",
                                        shareInternal: log.shareInternal ?? true,
                                        shareSubs: log.shareSubs ?? false,
                                        shareClient: log.shareClient ?? false,
                                        sharePrivate: log.sharePrivate ?? false,
                                        attachmentFiles: [],
                                        buildingId: log.building?.id || "",
                                        unitId: log.unit?.id || "",
                                        roomParticleId: log.roomParticle?.id || "",
                                        sowItemId: log.sowItem?.id || "",
                                        expenseVendor: log.expenseVendor || "",
                                        expenseAmount: log.expenseAmount != null ? String(log.expenseAmount) : "",
                                        expenseDate: log.expenseDate ? log.expenseDate.slice(0, 10) : "",
                                      },
                                      editing: false,
                                      saving: false,
                                      error: null,
                                    })}
                                    title="View daily log"
                                    style={{
                                      border: "1px solid #6b7280",
                                      background: "#6b7280",
                                      borderRadius: 4,
                                      cursor: "pointer",
                                      padding: "4px 8px",
                                      fontSize: 11,
                                      color: "#ffffff",
                                      fontWeight: 500,
                                    }}
                                  >
                                    👁
                                  </button>
                                  {/* Edit & Delete - PM+ only */}
                                  {isPmOrAbove && (
                                    <>
                                      <button
                                        type="button"
                                        onClick={() => openEditDailyLog(log)}
                                        title="Edit daily log"
                                        style={{
                                          border: "1px solid #2563eb",
                                          background: "#2563eb",
                                          borderRadius: 4,
                                          cursor: "pointer",
                                          padding: "4px 8px",
                                          fontSize: 11,
                                          color: "#ffffff",
                                          fontWeight: 500,
                                        }}
                                      >
                                        Edit
                                      </button>
                                      <button
                                        type="button"
                                        onClick={() => handleDeleteDailyLog(log.id, log.title)}
                                        title="Delete daily log"
                                        style={{
                                          border: "1px solid #dc2626",
                                          background: "#dc2626",
                                          borderRadius: 4,
                                          cursor: "pointer",
                                          padding: "4px 8px",
                                          fontSize: 11,
                                          color: "#ffffff",
                                          fontWeight: 500,
                                        }}
                                      >
                                        🗑
                                      </button>
                                    </>
                                  )}
                                </div>
                              </td>
                              {/* Date */}
                              <td
                                style={{
                                  padding: "4px 6px",
                                  borderTop: "1px solid #e5e7eb",
                                  whiteSpace: "nowrap",
                                }}
                              >
                                {log.logDate
                                  ? new Date(log.logDate).toLocaleDateString()
                                  : ""}
                              </td>
                              {/* Type */}
                              <td
                                style={{
                                  padding: "4px 6px",
                                  borderTop: "1px solid #e5e7eb",
                                }}
                              >
                                <span
                                  style={{
                                    display: "inline-block",
                                    padding: "1px 6px",
                                    borderRadius: 4,
                                    fontSize: 10,
                                    backgroundColor:
                                      log.type === "RECEIPT_EXPENSE"
                                        ? "#fef3c7"
                                        : log.type === "JSA"
                                        ? "#dbeafe"
                                        : log.type === "INCIDENT"
                                        ? "#fee2e2"
                                        : log.type === "QUALITY"
                                        ? "#d1fae5"
                                        : "#f3f4f6",
                                    color:
                                      log.type === "RECEIPT_EXPENSE"
                                        ? "#92400e"
                                        : log.type === "JSA"
                                        ? "#1e40af"
                                        : log.type === "INCIDENT"
                                        ? "#991b1b"
                                        : log.type === "QUALITY"
                                        ? "#065f46"
                                        : "#374151",
                                  }}
                                >
                                  {log.type === "RECEIPT_EXPENSE"
                                    ? "Receipt"
                                    : log.type === "JSA"
                                    ? "JSA"
                                    : log.type === "INCIDENT"
                                    ? "Incident"
                                    : log.type === "QUALITY"
                                    ? "Quality"
                                    : "PUDL"}
                                </span>
                              </td>
                              {/* Title */}
                              <td
                                style={{
                                  padding: "4px 6px",
                                  borderTop: "1px solid #e5e7eb",
                                  maxWidth: 180,
                                  overflow: "hidden",
                                  textOverflow: "ellipsis",
                                  whiteSpace: "nowrap",
                                }}
                              >
                                {log.title || "(Untitled)"}
                              </td>
                              {/* Work Performed */}
                              <td
                                style={{
                                  padding: "4px 6px",
                                  borderTop: "1px solid #e5e7eb",
                                  maxWidth: 200,
                                  whiteSpace: "nowrap",
                                  overflow: "hidden",
                                  textOverflow: "ellipsis",
                                }}
                              >
                                {log.workPerformed || ""}
                              </td>
                              {/* Status */}
                              <td
                                style={{
                                  padding: "4px 6px",
                                  borderTop: "1px solid #e5e7eb",
                                }}
                              >
                                <div style={{ display: "flex", alignItems: "center", gap: 4, flexWrap: "wrap" }}>
                                  <span
                                    style={{
                                      display: "inline-block",
                                      padding: "1px 6px",
                                      borderRadius: 999,
                                      fontSize: 10,
                                      backgroundColor:
                                        log.status === "APPROVED"
                                          ? "#dcfce7"
                                          : log.status === "REJECTED"
                                          ? "#fee2e2"
                                          : "#e5e7eb",
                                      color:
                                        log.status === "APPROVED"
                                          ? "#166534"
                                          : log.status === "REJECTED"
                                          ? "#991b1b"
                                          : "#374151",
                                    }}
                                  >
                                    {log.status || "SUBMITTED"}
                                  </span>
                                  {log.safetyIncidents && log.safetyIncidents.trim() !== "" && (
                                    <span
                                      style={{
                                        display: "inline-block",
                                        padding: "1px 6px",
                                        borderRadius: 4,
                                        fontSize: 9,
                                        fontWeight: 600,
                                        backgroundColor: "#fef2f2",
                                        color: "#b91c1c",
                                        border: "1px solid #fecaca",
                                      }}
                                      title={`Safety Note: ${log.safetyIncidents}`}
                                    >
                                      ⚠️ Safety Review
                                    </span>
                                  )}
                                </div>
                              </td>
                              {/* Attachment paperclip icon */}
                              <td
                                style={{
                                  padding: "4px 6px",
                                  borderTop: "1px solid #e5e7eb",
                                  textAlign: "center",
                                }}
                              >
                                {log.attachments && log.attachments.length > 0 && (
                                  <span
                                    role="button"
                                    tabIndex={0}
                                    onMouseDown={(e) => {
                                      e.stopPropagation();
                                      console.log("Paperclip MOUSEDOWN for log:", log.id);
                                      openAttachmentsViewer(log);
                                    }}
                                    onKeyDown={(e) => {
                                      if (e.key === "Enter" || e.key === " ") {
                                        openAttachmentsViewer(log);
                                      }
                                    }}
                                    title={`${log.attachments.length} attachment(s) - click to view`}
                                    style={{
                                      display: "inline-flex",
                                      alignItems: "center",
                                      border: "1px solid #2563eb",
                                      background: "#eff6ff",
                                      borderRadius: 4,
                                      cursor: "pointer",
                                      padding: "2px 6px",
                                      fontSize: 14,
                                      color: "#2563eb",
                                      userSelect: "none",
                                    }}
                                  >
                                    📎
                                    <span style={{ fontSize: 10, marginLeft: 2 }}>
                                      {log.attachments.length}
                                    </span>
                                  </span>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    </>
                  )}

                  {dailyLogs.length > 0 && (
                    <div style={{ marginTop: 8, fontSize: 12 }}>
                      <div style={{ marginBottom: 4, color: "#4b5563" }}>
                        Add photos to latest log ({" "}
                        {new Date(dailyLogs[0].logDate).toLocaleDateString()} –
                        {" "}
                        {dailyLogs[0].title || "Untitled"}
                        )
                      </div>
                      <input
                        type="file"
                        accept="image/*"
                        multiple
                        disabled={attachmentsUploading}
                        onChange={async e => {
                          const files = e.target.files;
                          if (!files || files.length === 0) return;
                          const latest = dailyLogs[0];
                          const token = localStorage.getItem("accessToken");
                          if (!token) {
                            alert("Missing access token; please log in again.");
                            return;
                          }
                          try {
                            setAttachmentsUploading(true);
                            const uploaded: DailyLogAttachmentDto[] = [];
                            for (const file of Array.from(files)) {
                              // Upload to GCS via shared helper
                              const link = await uploadImageFileToNexusUploads(file, "JOURNAL");
                              // Tell API to link this URL as a DailyLogAttachment
                              const resp = await fetch(
                                `${API_BASE}/daily-logs/${latest.id}/attachments/link`,
                                {
                                  method: "POST",
                                  headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                  },
                                  body: JSON.stringify({
                                    fileUrl: link.url,
                                    fileName: link.label,
                                  }),
                                },
                              );
                              if (resp.ok) {
                                const att: DailyLogAttachmentDto = await resp.json();
                                uploaded.push(att);
                              }
                            }
                            if (uploaded.length > 0) {
                              setDailyLogs(prev =>
                                prev.map(l =>
                                  l.id === latest.id
                                    ? {
                                        ...l,
                                        attachments: [...(l.attachments || []), ...uploaded],
                                      }
                                    : l,
                                ),
                              );
                            }
                          } finally {
                            setAttachmentsUploading(false);
                            e.target.value = "";
                          }
                        }}
                      />
                    </div>
                  )}
                </div>
              </div>

              {/* Field PETL scope (read-only for now, with Incorrect Qty entrypoint) */}
              <div
                style={{
                  borderRadius: 8,
                  border: "1px solid #e5e7eb",
                  background: "#ffffff",
                }}
              >
                <div
                  style={{
                    padding: "6px 10px",
                    borderBottom: "1px solid #e5e7eb",
                    fontSize: 13,
                    fontWeight: 600,
                    background: "#f3f4f6",
                  }}
                >
                  Field PETL scope
                </div>
                <div style={{ padding: 10, fontSize: 13 }}>
                  {/* Manual OCR trigger even for non-receipt logs if there are image attachments */}
                  {editDailyLog.log?.attachments && editDailyLog.log.attachments.length > 0 && editDailyLog.draft?.type !== "RECEIPT_EXPENSE" && (
                    <div style={{ marginBottom: 8, display: "flex", justifyContent: "flex-end" }}>
                      <button
                        type="button"
                        onClick={async () => {
                          const token = localStorage.getItem("accessToken");
                          if (!token || !editDailyLog.log) { alert("Missing access token"); return; }
                          try {
                            setEditDailyLog(prev => ({ ...prev, saving: true, error: null }));
                            const resp = await fetch(`${API_BASE}/daily-logs/${editDailyLog.log!.id}/attachments/ocr`, {
                              method: "POST",
                              headers: { Authorization: `Bearer ${token}` },
                            });
                            if (!resp.ok) alert("OCR trigger failed");
                          } finally {
                            setEditDailyLog(prev => ({ ...prev, saving: false }));
                          }
                        }}
                        style={{ padding: "4px 8px", borderRadius: 4, border: "1px solid #2563eb", background: "#eff6ff", color: "#1e40af", fontSize: 11 }}
                        title="Run OCR on image attachments"
                      >
                        Run OCR on attachments
                      </button>
                    </div>
                  )}

                  {fieldPetlOrgGroupCodes.length > 0 && (
                    <div style={{ marginBottom: 8 }}>
                      <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>
                        Org Group
                      </div>
                      <CheckboxMultiSelect
                        placeholder="All"
                        options={fieldPetlOrgGroupCodes.map(code => ({ value: code, label: code }))}
                        selectedValues={fieldPetlOrgGroupFilters}
                        onChangeSelectedValues={setFieldPetlOrgGroupFilters}
                        minWidth={160}
                        minListHeight={220}
                      />
                    </div>
                  )}

                  {fieldPetlLoading && (
                    <div style={{ color: "#6b7280" }}>Loading PETL scope…</div>
                  )}
                  {fieldPetlError && !fieldPetlLoading && (
                    <div style={{ color: "#b91c1c" }}>{fieldPetlError}</div>
                  )}
                  {!fieldPetlLoading && !fieldPetlError && fieldPetlItems.length === 0 && (
                    <div style={{ color: "#6b7280" }}>
                      No PETL scope rows found for this project.
                    </div>
                  )}
                  {!fieldPetlLoading && !fieldPetlError && fieldPetlItems.length > 0 && (
                    <div style={{ maxHeight: 260, overflowY: "auto" }}>
                      <table
                        style={{
                          width: "100%",
                          borderCollapse: "collapse",
                          fontSize: 12,
                        }}
                      >
                        <thead>
                          <tr style={{ backgroundColor: "#f9fafb" }}>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>#</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>Room</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>Task</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>
                              Qty (orig → current)
                            </th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>Incorrect?</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>Status</th>
                            <th style={{ textAlign: "left", padding: "4px 6px" }}>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {fieldPetlItems
                            .filter(it => {
                              if (fieldPetlOrgGroupFilterSet.size === 0) return true;
                              const code = String(it.orgGroupCode ?? "").trim();
                              return code && fieldPetlOrgGroupFilterSet.has(code);
                            })
                            .map((it) => {
                            const orig = it.originalQty ?? it.qty ?? null;
                            const curr = it.qty ?? null;
                            const hasField = typeof it.qtyFieldReported === "number";
                            let statusLabel = "OK";
                            if (it.qtyFlaggedIncorrect && it.qtyReviewStatus === "PENDING") {
                              statusLabel =
                                hasField && it.qtyFieldReported != null
                                  ? `Pending (${it.qtyFieldReported})`
                                  : "Pending";
                            } else if (it.qtyReviewStatus === "ACCEPTED") {
                              statusLabel = "Accepted";
                            } else if (it.qtyReviewStatus === "REJECTED") {
                              statusLabel = "Rejected";
                            }

                            return (
                              <tr key={it.sowItemId}>
                                <td
                                  style={{
                                    padding: "4px 6px",
                                    borderTop: "1px solid #e5e7eb",
                                  }}
                                >
                                  {it.lineNo}
                                </td>
                                <td
                                  style={{
                                    padding: "4px 6px",
                                    borderTop: "1px solid #e5e7eb",
                                  }}
                                >
                                  {it.roomName || "—"}
                                </td>
                                <td
                                  style={{
                                    padding: "4px 6px",
                                    borderTop: "1px solid #e5e7eb",
                                    maxWidth: 180,
                                    whiteSpace: "nowrap",
                                    overflow: "hidden",
                                    textOverflow: "ellipsis",
                                  }}
                                >
                                  {it.description || "—"}
                                </td>
                                <td
                                  style={{
                                    padding: "4px 6px",
                                    borderTop: "1px solid #e5e7eb",
                                  }}
                                >
                                  {orig != null ? orig : "—"}
                                  {" "}→{" "}
                                  {curr != null ? curr : "—"}
                                  {hasField && it.qtyFieldReported != null && (
                                    <span style={{ marginLeft: 4, color: "#b91c1c" }}>
                                      (field {it.qtyFieldReported})
                                    </span>
                                  )}
                                </td>
                                <td
                                  style={{
                                    padding: "4px 6px",
                                    borderTop: "1px solid #e5e7eb",
                                  }}
                                >
                                  <input
                                    type="checkbox"
                                    checked={it.qtyFlaggedIncorrect}
                                    onChange={() => openFieldPetlEdit(it)}
                                  />
                                </td>
                                <td
                                  style={{
                                    padding: "4px 6px",
                                    borderTop: "1px solid #e5e7eb",
                                  }}
                                >
                                  {statusLabel}
                                </td>
                                <td
                                  style={{
                                    padding: "4px 6px",
                                    borderTop: "1px solid #e5e7eb",
                                  }}
                                >
                                  <button
                                    type="button"
                                    onClick={() => openFieldPetlEdit(it)}
                                    style={{
                                      padding: "2px 6px",
                                      borderRadius: 4,
                                      border: "1px solid #0f172a",
                                      backgroundColor: "#0f172a",
                                      color: "#f9fafb",
                                      fontSize: 11,
                                      cursor: "pointer",
                                    }}
                                  >
                                    Verify / Edit
                                  </button>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* SCHEDULE tab content */}
      {activeTab === "SCHEDULE" && (
        <ScheduleSection
          projectId={project.id}
          petlEstimateVersionId={petlEstimateVersionId}
          roomToUnitLabel={roomToUnitLabel}
          unitGroups={unitGroups}
          mode="SCHEDULE"
          apiBase={API_BASE}
        />
      )}

      {/* PETL tab content */}
      {activeTab === "PETL" && (
        <div style={{ position: "relative" }}>
          {/* Toast notification for single-line saves */}
          {petlToast && (
            <div
              style={{
                position: "fixed",
                bottom: 24,
                right: 24,
                padding: "10px 16px",
                borderRadius: 8,
                background: "#065f46",
                color: "#ffffff",
                fontSize: 13,
                fontWeight: 500,
                boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
                zIndex: 9999,
                animation: "fadeIn 0.2s ease-out",
              }}
            >
              {petlToast}
            </div>
          )}

          {!petlTabMounted && (
            <div
              style={{
                padding: 12,
                borderRadius: 8,
                border: "1px solid #e5e7eb",
                background: "#ffffff",
                fontSize: 12,
                color: "#6b7280",
              }}
            >
              Opening PETL…
            </div>
          )}

          {petlTabMounted && (
            <>
              {/* Pending approvals (PM/owner/admin) */}
          {isPmOrAbove && (
            <div
              style={{
                marginBottom: 12,
                borderRadius: 8,
                border: "1px solid #e5e7eb",
                background: "#ffffff",
              }}
            >
              <div
                style={{
                  padding: "6px 10px",
                  borderBottom: "1px solid #e5e7eb",
                  fontSize: 13,
                  fontWeight: 600,
                  background: "#f3f4f6",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                }}
              >
                <span>Pending PETL % approvals</span>
                <button
                  type="button"
                  onClick={() => {
                    petlTransitionOverlayLabelRef.current = "Refreshing approvals…";
                    busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
                    startPetlTransition(() => setPendingPetlReloadTick(t => t + 1));
                  }}
                  disabled={pendingPetlLoading}
                  style={{
                    padding: "4px 8px",
                    borderRadius: 6,
                    border: "1px solid #d1d5db",
                    background: "#ffffff",
                    cursor: pendingPetlLoading ? "default" : "pointer",
                    fontSize: 12,
                    color: "#111827",
                  }}
                >
                  {pendingPetlLoading ? "Refreshing…" : "Refresh"}
                </button>
              </div>

              <div style={{ padding: 10, fontSize: 12 }}>
                {pendingPetlMessage && (
                  <div style={{ marginBottom: 6, color: "#4b5563" }}>{pendingPetlMessage}</div>
                )}

                {pendingPetlLoading && (
                  <div style={{ color: "#6b7280" }}>Loading pending approvals…</div>
                )}

                {pendingPetlError && !pendingPetlLoading && (
                  <div style={{ color: "#b91c1c" }}>{pendingPetlError}</div>
                )}

                {!pendingPetlLoading &&
                  !pendingPetlError &&
                  pendingPetlSessions &&
                  pendingPetlSessions.length === 0 && (
                    <div style={{ color: "#6b7280" }}>No pending percent updates.</div>
                  )}

                {!pendingPetlLoading &&
                  !pendingPetlError &&
                  pendingPetlSessions &&
                  pendingPetlSessions.length > 0 && (
                    <div style={{ maxHeight: 220, overflow: "auto" }}>
                      <table
                        style={{
                          width: "100%",
                          borderCollapse: "collapse",
                          fontSize: 12,
                        }}
                      >
                        <thead>
                          <tr style={{ backgroundColor: "#f9fafb" }}>
                            <th style={{ textAlign: "left", padding: "6px 8px" }}>Created</th>
                            <th style={{ textAlign: "left", padding: "6px 8px" }}>By</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}>Updates</th>
                            <th style={{ textAlign: "left", padding: "6px 8px" }}>Preview</th>
                            <th style={{ textAlign: "right", padding: "6px 8px" }}>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {pendingPetlSessions.map((s: any) => {
                            const created = s.createdAt ? new Date(s.createdAt).toLocaleString() : "—";
                            const createdBy = s.createdBy?.email ?? "(unknown)";
                            const updates = Array.isArray(s.updates) ? s.updates : [];
                            const preview = updates
                              .slice(0, 3)
                              .map((u: any) => `${u.oldPercent ?? 0}→${u.newPercent ?? 0}`)
                              .join(", ");

                            return (
                              <tr key={s.id}>
                                <td
                                  style={{
                                    padding: "6px 8px",
                                    borderTop: "1px solid #e5e7eb",
                                    whiteSpace: "nowrap",
                                  }}
                                >
                                  {created}
                                </td>
                                <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                  {createdBy}
                                </td>
                                <td
                                  style={{
                                    padding: "6px 8px",
                                    borderTop: "1px solid #e5e7eb",
                                    textAlign: "right",
                                    whiteSpace: "nowrap",
                                  }}
                                >
                                  {updates.length}
                                </td>
                                <td
                                  style={{
                                    padding: "6px 8px",
                                    borderTop: "1px solid #e5e7eb",
                                    color: "#4b5563",
                                    fontSize: 11,
                                  }}
                                >
                                  {preview}
                                  {updates.length > 3 ? " …" : ""}
                                </td>
                                <td
                                  style={{
                                    padding: "6px 8px",
                                    borderTop: "1px solid #e5e7eb",
                                    textAlign: "right",
                                    whiteSpace: "nowrap",
                                  }}
                                >
                                  <button
                                    type="button"
                                    onClick={async () => {
                                      const token = localStorage.getItem("accessToken");
                                      if (!token) {
                                        setPendingPetlMessage("Missing access token.");
                                        return;
                                      }
                                      setPendingPetlMessage(null);

                                      await busyOverlay.run("Approving…", async () => {
                                        try {
                                          const res = await fetch(
                                            `${API_BASE}/projects/${id}/petl/percent-updates/${s.id}/approve`,
                                            {
                                              method: "POST",
                                              headers: {
                                                "Content-Type": "application/json",
                                                Authorization: `Bearer ${token}`,
                                              },
                                              body: JSON.stringify({ reviewNote: null }),
                                            },
                                          );
                                          if (!res.ok) {
                                            const text = await res.text().catch(() => "");
                                            setPendingPetlMessage(
                                              `Approve failed (${res.status}) ${text}`,
                                            );
                                            return;
                                          }
                                          setPendingPetlMessage("Approved.");
                                          setPendingPetlReloadTick(t => t + 1);
                                          setPetlReloadTick(t => t + 1);
                                        } catch (err: any) {
                                          setPendingPetlMessage(err?.message ?? "Approve failed.");
                                        }
                                      });
                                    }}
                                    style={{
                                      padding: "2px 6px",
                                      borderRadius: 4,
                                      border: "1px solid #16a34a",
                                      backgroundColor: "#dcfce7",
                                      color: "#166534",
                                      fontSize: 11,
                                      cursor: "pointer",
                                      marginRight: 6,
                                    }}
                                  >
                                    Approve
                                  </button>
                                  <button
                                    type="button"
                                    onClick={async () => {
                                      const token = localStorage.getItem("accessToken");
                                      if (!token) {
                                        setPendingPetlMessage("Missing access token.");
                                        return;
                                      }
                                      setPendingPetlMessage(null);

                                      await busyOverlay.run("Rejecting…", async () => {
                                        try {
                                          const res = await fetch(
                                            `${API_BASE}/projects/${id}/petl/percent-updates/${s.id}/reject`,
                                            {
                                              method: "POST",
                                              headers: {
                                                "Content-Type": "application/json",
                                                Authorization: `Bearer ${token}`,
                                              },
                                              body: JSON.stringify({ reviewNote: null }),
                                            },
                                          );
                                          if (!res.ok) {
                                            const text = await res.text().catch(() => "");
                                            setPendingPetlMessage(
                                              `Reject failed (${res.status}) ${text}`,
                                            );
                                            return;
                                          }
                                          setPendingPetlMessage("Rejected.");
                                          setPendingPetlReloadTick(t => t + 1);
                                        } catch (err: any) {
                                          setPendingPetlMessage(err?.message ?? "Reject failed.");
                                        }
                                      });
                                    }}
                                    style={{
                                      padding: "2px 6px",
                                      borderRadius: 4,
                                      border: "1px solid #b91c1c",
                                      backgroundColor: "#fee2e2",
                                      color: "#991b1b",
                                      fontSize: 11,
                                      cursor: "pointer",
                                    }}
                                  >
                                    Reject
                                  </button>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
              </div>
            </div>
          )}

          {/* Project hierarchy: Job (property) → Buildings / Structures → Units → Rooms */}
          {hierarchy && (
            <div style={{ marginBottom: 12 }}>
              <button
                type="button"
                onClick={() => {
                  petlTransitionOverlayLabelRef.current = "Updating layout view…";
                  busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
                  startPetlTransition(() => setStructureOpen(o => !o));
                }}
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: 4,
                  fontSize: 14,
                  fontWeight: 600,
                  color: "#111827",
                  background: "none",
                  border: "none",
                  padding: 0,
                  cursor: "pointer",
                }}
              >
                <span>{structureOpen ? "▾" : "▸"}</span>
                <span>Job layout (Property → Buildings → Units → Rooms)</span>
              </button>

              {structureOpen && (
                <div style={{ fontSize: 12, color: "#4b5563", marginTop: 4 }}>
                  <div>
                    <strong>Job / Property:</strong> {hierarchy.project.name}
                  </div>
              {hierarchy.buildings.length > 0 && (
                <ul style={{ marginTop: 4, marginLeft: 16 }}>
                  {hierarchy.buildings.map((b: any) => (
                    <li key={b.id}>
                      <span>
                        <strong>Building / Structure:</strong> {b.code || ""} {b.name}
                      </span>
                      {b.units?.length > 0 && (
                        <ul style={{ marginTop: 2, marginLeft: 14 }}>
                          {b.units.map((u: any) => (
                            <li key={u.id}>
                              <span>
                                <strong>Unit (e.g. apartment / house):</strong> {u.label}
                                {typeof u.floor === "number" && ` (Floor ${u.floor})`}
                              </span>
                            {u.particles?.length > 0 && (
                              <ul style={{ marginTop: 2, marginLeft: 14 }}>
                                {u.particles.map((p: any) => (
                                  <li key={p.id}>
                                    Room / Space: {p.fullLabel || p.name}
                                  </li>
                                ))}
                              </ul>
                            )}
                          </li>
                        ))}
                      </ul>
                    )}
                    {b.particles?.length > 0 && (
                      <ul style={{ marginTop: 2, marginLeft: 14 }}>
                        {b.particles.map((p: any) => (
                          <li key={p.id}>
                            Room / Space in this building: {p.fullLabel || p.name}
                          </li>
                        ))}
                      </ul>
                    )}
                  </li>
                ))}
              </ul>
            )}
              {hierarchy.units.length > 0 && (
                <div style={{ marginTop: 4 }}>
                  <div><strong>Units directly under property (no building):</strong></div>
                  <ul style={{ marginTop: 2, marginLeft: 16 }}>
                    {hierarchy.units.map((u: any) => (
                      <li key={u.id}>
                        <span>
                          <strong>Unit:</strong> {u.label}
                          {typeof u.floor === "number" && ` (Floor ${u.floor})`}
                        </span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* PETL view toggle */}
      <div
        style={{
          display: "flex",
          flexWrap: "wrap",
          gap: 12,
          alignItems: "center",
          justifyContent: "space-between",
          marginTop: 8,
          marginBottom: 8,
        }}
      >
        <div style={{ display: "flex", flexWrap: "wrap", gap: 12, alignItems: "center" }}>
          <div style={{ fontSize: 12, color: "#4b5563" }}>View:</div>
          <div
            style={{
              display: "flex",
              border: "1px solid #d1d5db",
              borderRadius: 999,
              overflow: "hidden",
            }}
          >
            <button
              type="button"
              onClick={() => setPetlDisplayModePersisted("PROJECT_GROUPING")}
              style={{
                padding: "4px 10px",
                fontSize: 12,
                border: "none",
                cursor: "pointer",
                background:
                  petlDisplayMode === "PROJECT_GROUPING" ? "#0f172a" : "#ffffff",
                color:
                  petlDisplayMode === "PROJECT_GROUPING" ? "#f9fafb" : "#111827",
              }}
            >
              Project grouping
            </button>
            <button
              type="button"
              onClick={() => setPetlDisplayModePersisted("LINE_SEQUENCE")}
              style={{
                padding: "4px 10px",
                fontSize: 12,
                border: "none",
                cursor: "pointer",
                background:
                  petlDisplayMode === "LINE_SEQUENCE" ? "#0f172a" : "#ffffff",
                color:
                  petlDisplayMode === "LINE_SEQUENCE" ? "#f9fafb" : "#111827",
                borderLeft: "1px solid #d1d5db",
              }}
            >
              Line sequence
            </button>
            <button
              type="button"
              onClick={() => setPetlDisplayModePersisted("RECONCILIATION_ONLY")}
              style={{
                padding: "4px 10px",
                fontSize: 12,
                border: "none",
                cursor: "pointer",
                background:
                  petlDisplayMode === "RECONCILIATION_ONLY" ? "#0f172a" : "#ffffff",
                color:
                  petlDisplayMode === "RECONCILIATION_ONLY" ? "#f9fafb" : "#111827",
                borderLeft: "1px solid #d1d5db",
              }}
            >
              Recon only
            </button>
          </div>
        </div>

        <div style={{ display: "flex", alignItems: "center", gap: 10, flexWrap: "wrap" }}>
          <div
            style={{
              fontSize: 13,
              fontWeight: 600,
              color: "#2563eb",
              whiteSpace: "nowrap",
              overflow: "hidden",
              textOverflow: "ellipsis",
              maxWidth: 420,
            }}
          >
            Apply % complete to filtered items
          </div>

          <button
            type="button"
            onClick={() => setImportsModalOpen(true)}
            style={{
              padding: "5px 10px",
              borderRadius: 999,
              border: "1px solid #2563eb",
              background: "#eff6ff",
              color: "#1d4ed8",
              fontSize: 12,
              cursor: "pointer",
              whiteSpace: "nowrap",
            }}
          >
            Reconcile Imports
          </button>
        </div>
      </div>

      {/* Progress controls: filters + operation */}
      {petlItems.length > 0 && (
        <div
          style={{
            display: "flex",
            flexWrap: "wrap",
            gap: 8,
            marginBottom: 12,
            alignItems: "flex-end",
          }}
        >
          <div>
            <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Room</div>
            <CheckboxMultiSelect
              placeholder="All rooms"
              options={roomOptions}
              selectedValues={roomParticleIdFilters}
              onChangeSelectedValues={setRoomParticleIdFiltersTransition}
              minWidth={180}
              minListHeight={220}
            />
          </div>

          <div>
            <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Cat</div>
            <CheckboxMultiSelect
              placeholder="All"
              options={categoryOptions.map((cat) => ({ value: cat, label: cat }))}
              selectedValues={categoryCodeFilters}
              onChangeSelectedValues={setCategoryCodeFiltersTransition}
              minWidth={110}
              // Taller list for CAT so longer lists feel less cramped in reconciliation workflows.
              minListHeight={320}
            />
          </div>

          <div>
            <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Sel</div>
            <CheckboxMultiSelect
              placeholder="All"
              options={selectionOptions.map((sel) => ({ value: sel, label: sel }))}
              selectedValues={selectionCodeFilters}
              onChangeSelectedValues={setSelectionCodeFiltersTransition}
              minWidth={110}
              minListHeight={220}
            />
          </div>

          <div>
            <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Org Group</div>
            <CheckboxMultiSelect
              placeholder="All"
              options={petlOrgGroupCodes.map(code => ({ value: code, label: code }))}
              selectedValues={petlOrgGroupFilters}
              onChangeSelectedValues={setPetlOrgGroupFiltersTransition}
              minWidth={140}
              minListHeight={240}
            />
          </div>

          <div>
            <div style={{ fontSize: 11, color: "#4b5563", marginBottom: 2 }}>Notes</div>
            <div
              role="group"
              aria-label="Notes visibility"
              style={{
                display: "inline-flex",
                border: "1px solid #d1d5db",
                borderRadius: 999,
                overflow: "hidden",
              }}
            >
              <button
                type="button"
                onClick={() => startPetlTransition(() => setPetlHideNotes(true))}
                style={{
                  padding: "5px 10px",
                  fontSize: 12,
                  border: "none",
                  cursor: "pointer",
                  background: petlHideNotes ? "#0f172a" : "#ffffff",
                  color: petlHideNotes ? "#f9fafb" : "#111827",
                  transition: "background-color 120ms ease, color 120ms ease",
                }}
                title="Hide note badges and note-only reconciliation lines"
              >
                Off
              </button>
              <button
                type="button"
                onClick={() => startPetlTransition(() => setPetlHideNotes(false))}
                style={{
                  padding: "5px 10px",
                  fontSize: 12,
                  borderLeft: "1px solid #d1d5db",
                  borderTop: "none",
                  borderRight: "none",
                  borderBottom: "none",
                  cursor: "pointer",
                  background: !petlHideNotes ? "#0f172a" : "#ffffff",
                  color: !petlHideNotes ? "#f9fafb" : "#111827",
                  transition: "background-color 120ms ease, color 120ms ease",
                }}
                title="Show note badges and note-only reconciliation lines"
              >
                On
              </button>
            </div>
          </div>

          {isPmOrAbove && (
          <form
            onSubmit={async (e) => {
              e.preventDefault();
              setBulkMessage(null);

              const raw = operationPercent.trim();
              const isAcv = raw === "ACV";

              // Require a selection before applying
              if (!raw) {
                setBulkMessage("Please select a percentage value first.");
                return;
              }

              if (isAcv && operation !== "set") {
                setBulkMessage("ACV only can only be used with the 'Set to' operation.");
                return;
              }

              // Pending approvals currently track percent changes only.
              // Avoid letting non-PMs toggle ACV-only so we don't create a pending session
              // that cannot accurately represent the requested change.
              if (isAcv && !isPmOrAbove) {
                setBulkMessage("ACV only can only be applied by a PM/Owner/Admin.");
                return;
              }

              // Two-step confirmation: first click shows confirm, second click applies
              if (!bulkConfirmPending) {
                setBulkConfirmPending(true);
                return;
              }
              setBulkConfirmPending(false);

              let pct = 0;
              if (!isAcv) {
                pct = Number(raw);
                if (Number.isNaN(pct) || pct < 0 || pct > 100) {
                  setBulkMessage("Enter a percent between 0 and 100, or choose ACV only.");
                  return;
                }
              }

              const token = localStorage.getItem("accessToken");
              if (!token) {
                setBulkMessage("Missing access token.");
                return;
              }

              const filters: {
                roomParticleIds?: string[];
                categoryCodes?: string[];
                selectionCodes?: string[];
                orgGroupCodes?: string[];
              } = {};

              if (roomParticleIdFilters.length) {
                filters.roomParticleIds = roomParticleIdFilters;
              }
              if (categoryCodeFilters.length) {
                filters.categoryCodes = categoryCodeFilters;
              }
              if (selectionCodeFilters.length) {
                filters.selectionCodes = selectionCodeFilters;
              }
              if (petlOrgGroupFilters.length) {
                filters.orgGroupCodes = petlOrgGroupFilters;
              }

              // Show overlay early so the click feels responsive
              petlTransitionOverlayLabelRef.current = "Applying % update…";
              busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);

              try {
                setBulkSaving(true);

                // Yield to let the loading state paint before the network request
                await new Promise(resolve => requestAnimationFrame(resolve));

                console.log("[PETL bulk apply] Sending request:", { filters, operation, percent: pct, acvOnly: isAcv });
                const res = await fetch(`${API_BASE}/projects/${id}/petl/percentage-edits`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify({
                    filters,
                    operation,
                    percent: pct,
                    acvOnly: isAcv,
                  }),
                });
                const json = await res.json().catch(() => null);
                console.log("[PETL bulk apply] Response:", json);

                if (!res.ok) {
                  setBulkMessage(
                    `Bulk update failed (${res.status}). ${json ? JSON.stringify(json) : ""}`,
                  );
                  return;
                }

                if (json?.status === "pending") {
                  setBulkMessage(
                    `Submitted ${json?.pendingCount ?? 0} change(s) for approval (session ${json?.sessionId ?? "—"}).`,
                  );
                  setPendingPetlReloadTick(t => t + 1);
                  return;
                }

                // Optimistically update local items that match filters.
                // Wrap in a transition so React can yield to the main thread and
                // avoid blocking UI for 1+ seconds on large datasets (INP fix).
                startPetlTransition(() => {
                  setPetlItems(prev =>
                    prev.map(it => {
                      if (!matchesFilters(it)) return it;

                      // For ACV-only bulk set, flag as ACV but PRESERVE percent complete.
                      // ACV = carrier paid but client chose NOT to do the repair.
                      // We bill only O&P (20%), rebating 80% back to the insured.
                      if (isAcv && operation === "set") {
                        return { ...it, isAcvOnly: true };
                      }

                      const current = it.percentComplete ?? 0;
                      let next = current;
                      if (operation === "set") next = pct;
                      else if (operation === "increment") next = current + pct;
                      else if (operation === "decrement") next = current - pct;
                      next = Math.max(0, Math.min(100, next));
                      return { ...it, percentComplete: next, isAcvOnly: false };
                    }),
                  );
                });

                // Refresh PETL from server so the UI always reflects persisted values.
                // Also wrap in transition to avoid blocking.
                try {
                  const petlRes = await fetch(`${API_BASE}/projects/${id}/petl`, {
                    headers: { Authorization: `Bearer ${token}` },
                  });
                  if (petlRes.ok) {
                    const petl: any = await petlRes.json();
                    const items: PetlItem[] = Array.isArray(petl.items) ? petl.items : [];
                    startPetlTransition(() => {
                      setPetlItems(items);
                    });
                  }
                } catch {
                  // ignore
                }

                if (json?.status === "noop") {
                  setBulkMessage("No matching items found for the current filters.");
                  return;
                }

                // Refresh groups
                try {
                  setGroupLoading(true);
                  const groupsRes = await fetch(`${API_BASE}/projects/${id}/petl-groups`, {
                    headers: { Authorization: `Bearer ${token}` },
                  });
                  if (groupsRes.ok) {
                    const json: any = await groupsRes.json();
                    setGroups(Array.isArray(json.groups) ? json.groups : []);
                  }
                } finally {
                  setGroupLoading(false);
                }

                // Refresh the active invoice so Living Invoice reflects PETL changes
                if (activeInvoice?.id) {
                  try {
                    const invRes = await fetch(
                      `${API_BASE}/projects/${id}/invoices/${activeInvoice.id}`,
                      { headers: { Authorization: `Bearer ${token}` } },
                    );
                    if (invRes.ok) {
                      const invJson = await invRes.json();
                      setActiveInvoice(invJson);
                    }
                  } catch {
                    // non-fatal
                  }
                }
                // Also refresh the invoice list to update totals in the sidebar
                setProjectInvoices(null);

                showPetlToast(`Updated ${json?.updatedCount ?? 'filtered'} line items`);
                setBulkMessage("Updated selection.");
              } catch (err: any) {
                setBulkMessage(err.message ?? "Bulk update failed.");
              } finally {
                setBulkSaving(false);
              }
            }}
            style={{
              display: "flex",
              alignItems: "center",
              gap: 6,
              marginLeft: "auto",
            }}
          >
            <span
              style={{
                fontSize: 12,
                fontWeight: 600,
                color: "#2563eb",
                whiteSpace: "nowrap",
              }}
            >
              Operation
            </span>
            <select
              value={operation}
              onChange={e => {
                setOperation(e.target.value as any);
                setBulkConfirmPending(false);
              }}
              style={{
                padding: "4px 6px",
                borderRadius: 4,
                border: "1px solid #d1d5db",
                fontSize: 12,
              }}
            >
              <option value="set">Set to</option>
              <option value="increment">Increase by</option>
              <option value="decrement">Decrease by</option>
            </select>

            <select
              value={operationPercent}
              onChange={e => {
                setOperationPercent(e.target.value);
                setBulkConfirmPending(false);
              }}
              style={{
                padding: "4px 6px",
                borderRadius: 4,
                border: "1px solid #d1d5db",
                fontSize: 12,
              }}
            >
              <option value="">Select</option>
              <option value="0">0%</option>
              <option value="10">10%</option>
              <option value="20">20%</option>
              <option value="30">30%</option>
              <option value="40">40%</option>
              <option value="50">50%</option>
              <option value="60">60%</option>
              <option value="70">70%</option>
              <option value="80">80%</option>
              <option value="90">90%</option>
              <option value="100">100%</option>
              <option value="ACV">ACV only</option>
            </select>

            <button
              type="submit"
              disabled={bulkSaving || petlItems.length === 0 || !operationPercent}
              style={{
                padding: "6px 10px",
                borderRadius: 4,
                border: bulkConfirmPending ? "1px solid #dc2626" : "1px solid #0f172a",
                backgroundColor: bulkSaving || !operationPercent ? "#e5e7eb" : bulkConfirmPending ? "#dc2626" : "#0f172a",
                color: bulkSaving || !operationPercent ? "#4b5563" : "#f9fafb",
                fontSize: 12,
                cursor: bulkSaving || !operationPercent ? "default" : "pointer",
              }}
            >
              {bulkSaving ? "Applying…" : bulkConfirmPending ? "Confirm Apply?" : "Apply"}
            </button>
            {bulkConfirmPending && (
              <button
                type="button"
                onClick={() => setBulkConfirmPending(false)}
                style={{
                  padding: "6px 10px",
                  borderRadius: 4,
                  border: "1px solid #d1d5db",
                  backgroundColor: "#ffffff",
                  color: "#4b5563",
                  fontSize: 12,
                  cursor: "pointer",
                }}
              >
                Cancel
              </button>
            )}
          </form>
          )}

          {bulkMessage && (
            <div style={{ fontSize: 12, color: "#4b5563", marginTop: 6, width: "100%" }}>
              {bulkMessage}
            </div>
          )}
        </div>
      )}

      {/* Imports modal (rarely used; keep off initial render) */}
      {importsModalOpen && (
        <div
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 60,
            backgroundColor: "rgba(15, 23, 42, 0.35)",
            display: "flex",
            justifyContent: "center",
            alignItems: "flex-start",
            padding: "8vh 12px",
          }}
          onClick={closeImportsModal}
        >
          <div
            style={{
              width: 960,
              maxWidth: "96vw",
              backgroundColor: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 12px 32px rgba(15,23,42,0.18)",
              overflow: "hidden",
            }}
            onClick={e => e.stopPropagation()}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                padding: "10px 12px",
                borderBottom: "1px solid #e5e7eb",
                backgroundColor: "#f8fafc",
              }}
            >
              <div>
                <div style={{ fontSize: 14, fontWeight: 700 }}>Reconcile Imports</div>
                <div style={{ fontSize: 12, color: "#6b7280" }}>
                  Percent complete import and reconcile notes import.
                </div>
              </div>
              <button
                type="button"
                onClick={closeImportsModal}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  fontSize: 18,
                  lineHeight: 1,
                  padding: 6,
                }}
                aria-label="Close imports modal"
              >
                ×
              </button>
            </div>

            <div style={{ padding: 12 }}>
              {petlItems.length === 0 ? (
                <div style={{ fontSize: 12, color: "#4b5563" }}>
                  Imports are available after estimate items have been loaded for this project.
                </div>
              ) : (
                <div style={{ display: "flex", flexWrap: "wrap", gap: 12, alignItems: "flex-start" }}>
                  <div
                    style={{
                      flex: "1 1 420px",
                      minWidth: 360,
                      padding: 10,
                      borderRadius: 8,
                      border: "1px solid #e5e7eb",
                      background: "#f9fafb",
                    }}
                  >
                    <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>
                      Import % Complete (CSV)
                    </div>
                    <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 6 }}>
                      Uses line item number (#) and % Complete to update PETL line percentages.
                    </div>
                    <form
                      onSubmit={handlePetlPercentImport}
                      style={{ display: "flex", flexWrap: "wrap", gap: 8, alignItems: "center" }}
                    >
                      <input
                        type="file"
                        accept=".csv,text/csv"
                        onChange={e => setPetlPercentFile(e.target.files?.[0] ?? null)}
                        style={{ fontSize: 12 }}
                      />

                      <button
                        type="button"
                        onClick={downloadPetlPercentCsv}
                        disabled={petlItems.length === 0}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 4,
                          border: "1px solid #94a3b8",
                          backgroundColor: petlItems.length === 0 ? "#e5e7eb" : "#ffffff",
                          color: petlItems.length === 0 ? "#4b5563" : "#0f172a",
                          cursor: petlItems.length === 0 ? "default" : "pointer",
                          fontSize: 12,
                        }}
                      >
                        Download CSV
                      </button>

                      <button
                        type="submit"
                        disabled={petlPercentImporting || !petlPercentFile}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 4,
                          border: "1px solid #0f172a",
                          backgroundColor:
                            petlPercentImporting || !petlPercentFile ? "#e5e7eb" : "#0f172a",
                          color:
                            petlPercentImporting || !petlPercentFile ? "#4b5563" : "#f9fafb",
                          cursor:
                            petlPercentImporting || !petlPercentFile ? "default" : "pointer",
                          fontSize: 12,
                        }}
                      >
                        {petlPercentImporting ? "Uploading…" : "Queue percent import"}
                      </button>
                    </form>
                    {petlPercentImportError && (
                      <div style={{ fontSize: 12, color: "#b91c1c", marginTop: 4 }}>
                        {petlPercentImportError}
                      </div>
                    )}
                    {(petlPercentJob || petlPercentJobError) && (
                      <div
                        style={{
                          marginTop: 8,
                          padding: 8,
                          borderRadius: 6,
                          background: "#ffffff",
                          border: "1px solid #e5e7eb",
                          fontSize: 12,
                        }}
                      >
                        <div style={{ fontWeight: 600, marginBottom: 4 }}>Import job status</div>
                        {petlPercentJobError && (
                          <div style={{ color: "#b91c1c", marginBottom: 4 }}>
                            {petlPercentJobError}
                          </div>
                        )}
                        {petlPercentJob && (
                          <>
                            <div>
                              <strong>Status:</strong> {petlPercentJob.status ?? "UNKNOWN"}
                            </div>
                            <div>
                              <strong>Progress:</strong>{" "}
                              {typeof petlPercentJob.progress === "number"
                                ? `${petlPercentJob.progress}%`
                                : "—"}
                            </div>
                            {petlPercentJob.message && (
                              <div>
                                <strong>Message:</strong> {petlPercentJob.message}
                              </div>
                            )}

                            {petlPercentJob.status === "FAILED" && petlPercentJob.errorJson && (
                              <div style={{ marginTop: 6 }}>
                                <strong>Error:</strong>
                                <pre
                                  style={{
                                    marginTop: 4,
                                    padding: 6,
                                    background: "#fef2f2",
                                    borderRadius: 4,
                                    whiteSpace: "pre-wrap",
                                  }}
                                >
                                  {JSON.stringify(petlPercentJob.errorJson, null, 2)}
                                </pre>
                              </div>
                            )}

                            {petlPercentJob.resultJson && (
                              <div style={{ marginTop: 6 }}>
                                <strong>Result:</strong>
                                <pre
                                  style={{
                                    marginTop: 4,
                                    padding: 6,
                                    background: "#f8fafc",
                                    borderRadius: 4,
                                    whiteSpace: "pre-wrap",
                                  }}
                                >
                                  {JSON.stringify(petlPercentJob.resultJson, null, 2)}
                                </pre>
                              </div>
                            )}
                          </>
                        )}
                      </div>
                    )}
                  </div>

                  <div
                    style={{
                      flex: "1 1 420px",
                      minWidth: 360,
                      padding: 10,
                      borderRadius: 8,
                      border: "1px solid #e5e7eb",
                      background: "#f9fafb",
                    }}
                  >
                    <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>
                      Import Reconcile Notes (CSV)
                    </div>
                    <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 6 }}>
                      Attaches notes to PETL line items by line number (#).
                    </div>
                    <form
                      onSubmit={handlePetlReconcileNotesImport}
                      style={{ display: "flex", flexWrap: "wrap", gap: 8, alignItems: "center" }}
                    >
                      <input
                        type="file"
                        accept=".csv,text/csv"
                        onChange={e => {
                          setPetlReconcileNotesImportResult(null);
                          setPetlReconcileNotesFile(e.target.files?.[0] ?? null);
                        }}
                        style={{ fontSize: 12 }}
                      />
                      <button
                        type="submit"
                        disabled={petlReconcileNotesImporting || !petlReconcileNotesFile}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 4,
                          border: "1px solid #0f172a",
                          backgroundColor:
                            petlReconcileNotesImporting || !petlReconcileNotesFile
                              ? "#e5e7eb"
                              : "#0f172a",
                          color:
                            petlReconcileNotesImporting || !petlReconcileNotesFile
                              ? "#4b5563"
                              : "#f9fafb",
                          cursor:
                            petlReconcileNotesImporting || !petlReconcileNotesFile
                              ? "default"
                              : "pointer",
                          fontSize: 12,
                        }}
                      >
                        {petlReconcileNotesImporting ? "Importing…" : "Import notes"}
                      </button>
                    </form>
                    {petlReconcileNotesImportError && (
                      <div style={{ fontSize: 12, color: "#b91c1c", marginTop: 4 }}>
                        {petlReconcileNotesImportError}
                      </div>
                    )}
                    {petlReconcileNotesImportResult && (
                      <div
                        style={{
                          marginTop: 8,
                          padding: 8,
                          borderRadius: 6,
                          background: "#ffffff",
                          border: "1px solid #e5e7eb",
                          fontSize: 12,
                        }}
                      >
                        <div style={{ fontWeight: 600, marginBottom: 4 }}>Import result</div>
                        <pre
                          style={{
                            marginTop: 4,
                            padding: 6,
                            background: "#f8fafc",
                            borderRadius: 4,
                            whiteSpace: "pre-wrap",
                          }}
                        >
                          {JSON.stringify(petlReconcileNotesImportResult, null, 2)}
                        </pre>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Project grouping: Units → Rooms (expandable) */}

      {/* Attachments Gallery Modal - rendered via variable */}
      {attachmentsGalleryModal}

      {/* Field PETL edit modal */}
      {fieldPetlEdit && (
        <div
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 70,
            backgroundColor: "rgba(15, 23, 42, 0.4)",
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
          }}
          onClick={closeFieldPetlEdit}
        >
          <div
            style={{
              width: 520,
              maxWidth: "96vw",
              backgroundColor: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 16px 40px rgba(15,23,42,0.35)",
              padding: 14,
              fontSize: 13,
            }}
            onClick={e => e.stopPropagation()}
          >
            <div
              style={{
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                marginBottom: 8,
              }}
            >
              <div>
                <div style={{ fontSize: 14, fontWeight: 600 }}>Verify PETL line</div>
                <div style={{ fontSize: 12, color: "#6b7280" }}>
                  Line {fieldPetlEdit.item.lineNo}
                  {fieldPetlEdit.item.roomName ? ` · ${fieldPetlEdit.item.roomName}` : ""}
                </div>
              </div>
              <button
                type="button"
                onClick={closeFieldPetlEdit}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  fontSize: 18,
                  lineHeight: 1,
                  padding: 4,
                }}
                aria-label="Close"
              >
                 d
              </button>
            </div>

            <div style={{ marginBottom: 8 }}>
              <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 2 }}>Task</div>
              <div style={{ fontSize: 12, color: "#111827" }}>
                {fieldPetlEdit.item.description || "(No description)"}
              </div>
            </div>

            <div
              style={{
                display: "grid",
                gridTemplateColumns: "repeat(3, minmax(0, 1fr))",
                gap: 8,
                marginBottom: 8,
              }}
            >
              <div>
                <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 2 }}>Original qty</div>
                <div style={{ fontSize: 13 }}>
                  {fieldPetlEdit.item.originalQty ?? fieldPetlEdit.item.qty ?? "—"}
                </div>
              </div>
              <div>
                <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 2 }}>Current qty</div>
                <div style={{ fontSize: 13 }}>
                  {fieldPetlEdit.item.qty ?? "—"}
                </div>
              </div>
              <div>
                <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 2 }}>Field qty (pending)</div>
                <div style={{ fontSize: 13, color: "#b91c1c" }}>
                  {typeof fieldPetlEdit.item.qtyFieldReported === "number"
                    ? fieldPetlEdit.item.qtyFieldReported
                    : "—"}
                </div>
              </div>
            </div>

            <div style={{ marginBottom: 8 }}>
              <label style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 12 }}>
                <input
                  type="checkbox"
                  checked={fieldPetlEdit.incorrect}
                  onChange={e =>
                    setFieldPetlEdit(prev =>
                      prev ? { ...prev, incorrect: e.target.checked } : prev,
                    )
                  }
                />
                <span>Qty is incorrect</span>
              </label>
            </div>

            {fieldPetlEdit.incorrect && (
              <div style={{ marginBottom: 8 }}>
                <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                  Field-reported qty
                </label>
                <input
                  type="number"
                  value={fieldPetlEdit.fieldQty}
                  onChange={e =>
                    setFieldPetlEdit(prev =>
                      prev ? { ...prev, fieldQty: e.target.value } : prev,
                    )
                  }
                  style={{
                    width: "100%",
                    padding: "4px 6px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                  }}
                />
                <div style={{ marginTop: 4, fontSize: 11, color: "#6b7280" }}>
                  This value will be recorded as a discrepancy for PM review; it will
                  not immediately change the official quantity.
                </div>
              </div>
            )}

            <div style={{ marginBottom: 8 }}>
              <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                % complete (optional)
              </label>
              <input
                type="number"
                min={0}
                max={100}
                value={fieldPetlEdit.newPercent}
                onChange={e =>
                  setFieldPetlEdit(prev =>
                    prev ? { ...prev, newPercent: e.target.value } : prev,
                  )
                }
                placeholder="Leave blank to keep current %"
                style={{
                  width: "100%",
                  padding: "4px 6px",
                  borderRadius: 4,
                  border: "1px solid #d1d5db",
                  fontSize: 12,
                }}
              />
              <div style={{ marginTop: 4, fontSize: 11, color: "#6b7280" }}>
                Non‑PM users will queue a percent update for PM approval.
              </div>
            </div>

            <div style={{ marginBottom: 8 }}>
              <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>
                Note (optional)
              </label>
              <textarea
                rows={3}
                value={fieldPetlEdit.note}
                onChange={e =>
                  setFieldPetlEdit(prev =>
                    prev ? { ...prev, note: e.target.value } : prev,
                  )
                }
                style={{
                  width: "100%",
                  padding: "4px 6px",
                  borderRadius: 4,
                  border: "1px solid #d1d5db",
                  fontSize: 12,
                  resize: "vertical",
                }}
              />
            </div>

            {fieldPetlEdit.error && (
              <div style={{ marginBottom: 8, fontSize: 12, color: "#b91c1c" }}>
                {fieldPetlEdit.error}
              </div>
            )}

            <div
              style={{
                display: "flex",
                justifyContent: "flex-end",
                gap: 8,
                marginTop: 8,
              }}
            >
              <button
                type="button"
                onClick={closeFieldPetlEdit}
                disabled={fieldPetlEdit.saving}
                style={{
                  padding: "5px 10px",
                  borderRadius: 4,
                  border: "1px solid #d1d5db",
                  backgroundColor: "#ffffff",
                  fontSize: 12,
                  cursor: fieldPetlEdit.saving ? "default" : "pointer",
                }}
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={submitFieldPetlEdit}
                disabled={fieldPetlEdit.saving}
                style={{
                  padding: "5px 10px",
                  borderRadius: 4,
                  border: "1px solid #0f172a",
                  backgroundColor: fieldPetlEdit.saving ? "#e5e7eb" : "#0f172a",
                  color: fieldPetlEdit.saving ? "#4b5563" : "#f9fafb",
                  fontSize: 12,
                  cursor: fieldPetlEdit.saving ? "default" : "pointer",
                }}
              >
                {fieldPetlEdit.saving ? "Saving…" : "Commit"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Standalone Change Orders group - appears at top of PROJECT_GROUPING */}
      {petlDisplayMode === "PROJECT_GROUPING" && !groupLoading && (() => {
        const coItems = petlItems.filter(it => it.isStandaloneChangeOrder);
        if (coItems.length === 0) return null;
        const coTotal = coItems.reduce((sum, it) => sum + (it.rcvAmount ?? 0), 0);
        const coCompleted = coItems.reduce((sum, it) => sum + ((it.rcvAmount ?? 0) * (it.percentComplete ?? 0) / 100), 0);
        const coPct = coTotal > 0 ? (coCompleted / coTotal) * 100 : 0;
        const isCoExpanded = expandedUnits.has("__standalone_cos__");
        return (
          <div style={{ marginTop: 16, marginBottom: 16 }}>
            <h2 style={{ fontSize: 16, fontWeight: 600, marginBottom: 8, color: "#d97706" }}>Standalone Change Orders</h2>
            <div style={{ borderRadius: 8, backgroundColor: "#fffbeb", border: "1px solid #f59e0b" }}>
              <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                <thead>
                  <tr style={{ backgroundColor: "#fef3c7" }}>
                    <th style={{ textAlign: "left", padding: "8px 12px" }}>CO Line</th>
                    <th style={{ textAlign: "left", padding: "8px 12px" }}>Description</th>
                    <th style={{ textAlign: "right", padding: "8px 12px" }}>RCV</th>
                    <th style={{ textAlign: "right", padding: "8px 12px" }}>% Complete</th>
                    <th style={{ textAlign: "left", padding: "8px 12px" }}>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    style={{ cursor: "pointer", backgroundColor: "#fef3c7" }}
                    onClick={() => toggleUnitExpanded("__standalone_cos__")}
                  >
                    <td colSpan={2} style={{ padding: "6px 12px", fontWeight: 600 }}>
                      {isCoExpanded ? "▾" : "▸"} {coItems.length} Change Order{coItems.length !== 1 ? "s" : ""}
                    </td>
                    <td style={{ padding: "6px 12px", textAlign: "right", fontWeight: 600 }}>
                      {coTotal.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                    </td>
                    <td style={{ padding: "6px 12px", textAlign: "right", fontWeight: 600 }}>
                      {coPct.toFixed(1)}%
                    </td>
                    <td style={{ padding: "6px 12px" }} />
                  </tr>
                  {isCoExpanded && coItems
                    .sort((a, b) => {
                      const aSource = a.coSourceLineNo ?? 0;
                      const bSource = b.coSourceLineNo ?? 0;
                      if (aSource !== bSource) return aSource - bSource;
                      return (a.coSequenceNo ?? 0) - (b.coSequenceNo ?? 0);
                    })
                    .map((item) => {
                      const coLineLabel = item.coSourceLineNo != null && item.coSequenceNo != null
                        ? `${item.coSourceLineNo}-CO${item.coSequenceNo}`
                        : `CO-${item.lineNo}`;
                      const hasRecon = petlReconActivityIds.has(item.id);
                      const flagged = petlReconFlagIds.has(item.id);
                      return (
                        <tr key={item.id} style={{ backgroundColor: "#ffffff" }}>
                          <td style={{ padding: "6px 12px", borderTop: "1px solid #fcd34d", fontFamily: "monospace" }}>
                            {coLineLabel}
                          </td>
                          <td style={{ padding: "6px 12px", borderTop: "1px solid #fcd34d", maxWidth: 300, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                            {item.description || "(No description)"}
                          </td>
                          <td style={{ padding: "6px 12px", borderTop: "1px solid #fcd34d", textAlign: "right" }}>
                            {(item.rcvAmount ?? 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}
                          </td>
                          <td style={{ padding: "6px 12px", borderTop: "1px solid #fcd34d", textAlign: "right" }}>
                            {item.percentComplete ?? 0}%
                          </td>
                          <td style={{ padding: "6px 12px", borderTop: "1px solid #fcd34d" }}>
                            <div style={{ display: "flex", gap: 6 }}>
                              <button
                                type="button"
                                onClick={(e) => { e.stopPropagation(); togglePetlReconFlag(item.id); }}
                                style={{
                                  padding: "2px 6px", borderRadius: 999,
                                  border: flagged ? "1px solid #b45309" : "1px solid #d1d5db",
                                  background: flagged ? "#fffbeb" : "#ffffff",
                                  fontSize: 11, cursor: "pointer",
                                  color: flagged ? "#92400e" : "#374151",
                                }}
                              >
                                {flagged ? "Flagged" : "Flag"}
                              </button>
                              <button
                                type="button"
                                onClick={(e) => { e.stopPropagation(); void openPetlReconciliation(item.id); }}
                                style={{
                                  padding: "2px 6px", borderRadius: 999,
                                  border: hasRecon ? "1px solid #0284c7" : "1px solid #d1d5db",
                                  background: hasRecon ? "#e0f2fe" : "#ffffff",
                                  fontSize: 11, cursor: "pointer",
                                  color: hasRecon ? "#075985" : "#374151",
                                }}
                              >
                                Recon
                              </button>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                </tbody>
              </table>
            </div>
          </div>
        );
      })()}

      {petlDisplayMode === "PROJECT_GROUPING" && !groupLoading && unitGroups.length > 0 && (
        <div style={{ marginTop: 16 }}>
          <h2 style={{ fontSize: 16, fontWeight: 600, marginBottom: 8 }}>Units</h2>
          <div
            style={{
              borderRadius: 8,
              backgroundColor: "#ffffff",
              border: "1px solid #e5e7eb",
            }}
          >
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
              <thead>
                <tr style={{ backgroundColor: "#f9fafb" }}>
                  <th style={{ textAlign: "left", padding: "8px 12px" }}>Unit / Room</th>
                  <th style={{ textAlign: "right", padding: "8px 12px" }}>Tasks</th>
                  <th style={{ textAlign: "right", padding: "8px 12px" }}>Total</th>
                  <th style={{ textAlign: "right", padding: "8px 12px" }}>Completed</th>
                  <th style={{ textAlign: "right", padding: "8px 12px" }}>% Complete</th>
                </tr>
              </thead>
              <tbody>
                {unitGroups
                  .map((u) => {
                    const rooms =
                      roomParticleIdFilters.length > 0
                        ? (u.rooms ?? []).filter(
                            (r) => r.particleId && roomParticleIdFilterSet.has(r.particleId),
                          )
                        : (u.rooms ?? []);

                    if (rooms.length === 0) return null;

                    const tasks = rooms.reduce((sum, r) => sum + (r.itemsCount ?? 0), 0);
                    const total = rooms.reduce((sum, r) => sum + (r.totalAmount ?? 0), 0);
                    const completed = rooms.reduce((sum, r) => sum + (r.completedAmount ?? 0), 0);
                    const pct = total > 0 ? (completed / total) * 100 : 0;

                    const unitKey = u.unitId ?? "__no_unit__";
                    const isUnitExpanded = expandedUnits.has(unitKey);

                    return (
                      <Fragment key={unitKey}>
                        <tr>
                          <td
                            style={{
                              padding: "6px 12px",
                              borderTop: "1px solid #e5e7eb",
                              cursor: "pointer",
                              fontWeight: 600,
                            }}
                            onClick={() => toggleUnitExpanded(u.unitId)}
                          >
                            {isUnitExpanded ? "▾ " : "▸ "}
                            {u.unitLabel || "(No unit)"}
                            <span style={{ marginLeft: 8, fontWeight: 400, color: "#6b7280" }}>
                              ({rooms.length} room{rooms.length === 1 ? "" : "s"})
                            </span>
                          </td>
                          <td
                            style={{
                              padding: "6px 12px",
                              borderTop: "1px solid #e5e7eb",
                              textAlign: "right",
                              fontWeight: 600,
                            }}
                          >
                            {tasks}
                          </td>
                          <td
                            style={{
                              padding: "6px 12px",
                              borderTop: "1px solid #e5e7eb",
                              textAlign: "right",
                              fontWeight: 600,
                            }}
                          >
                            {total.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                          </td>
                          <td
                            style={{
                              padding: "6px 12px",
                              borderTop: "1px solid #e5e7eb",
                              textAlign: "right",
                              fontWeight: 600,
                            }}
                          >
                            {completed.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                          </td>
                          <td
                            style={{
                              padding: "6px 12px",
                              borderTop: "1px solid #e5e7eb",
                              textAlign: "right",
                              fontWeight: 600,
                            }}
                          >
                            {pct.toFixed(2)}%
                          </td>
                        </tr>

                        {isUnitExpanded &&
                          rooms.map((g) => {
                            const itemsForRoom = filteredItemsForRoom(g.particleId);
                            const isExpanded = g.particleId ? expandedRooms.has(g.particleId) : false;

                            return (
                              <Fragment key={g.particleId ?? String(g.id)}>
                                <tr>
                                  <td
                                    style={{
                                      padding: "6px 12px",
                                      paddingLeft: 28,
                                      borderTop: "1px solid #e5e7eb",
                                      cursor: g.particleId ? "pointer" : "default",
                                      color: g.particleId ? "#2563eb" : "inherit",
                                      textDecoration:
                                        g.particleId && isExpanded ? "underline" : "none",
                                    }}
                                    onClick={() => {
                                      if (!g.particleId) return;
                                      toggleRoomExpanded(g.particleId);
                                    }}
                                  >
                                    {isExpanded ? "▾ " : "▸ "}
                                    {g.roomName}
                                    {g.particleId && (
                                      <>
                                        <button
                                          type="button"
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            void openRoomComponentsPanel(g.particleId, g.roomName);
                                          }}
                                          style={{
                                            marginLeft: 8,
                                            padding: "2px 6px",
                                            borderRadius: 999,
                                            border: "1px solid #0f172a",
                                            background: "#ffffff",
                                            fontSize: 11,
                                            cursor: "pointer",
                                          }}
                                        >
                                          Components
                                        </button>
                                        <button
                                          type="button"
                                          onClick={(e) => {
                                            e.stopPropagation();

                                            const breadcrumb =
                                              (g.particleId &&
                                                roomBreadcrumbByParticleId.get(g.particleId)) ||
                                              g.roomName;

                                            setPudlContext({
                                              open: true,
                                              buildingId: null,
                                              unitId: u.unitId ?? null,
                                              roomParticleId: g.particleId,
                                              sowItemId: null,
                                              breadcrumb,
                                            });

                                            setNewDailyLog((prev) => ({
                                              ...prev,
                                              roomParticleId: g.particleId,
                                            }));

                                            setTab("DAILY_LOGS");
                                          }}
                                          style={{
                                            marginLeft: 6,
                                            padding: "2px 6px",
                                            borderRadius: 999,
                                            border: "1px solid #2563eb",
                                            background: "#eff6ff",
                                            fontSize: 11,
                                            cursor: "pointer",
                                            color: "#1d4ed8",
                                          }}
                                        >
                                          PUDL
                                        </button>
                                      </>
                                    )}
                                  </td>
                                  <td
                                    style={{
                                      padding: "6px 12px",
                                      borderTop: "1px solid #e5e7eb",
                                      textAlign: "right",
                                    }}
                                  >
                                    {g.itemsCount}
                                  </td>
                                  <td
                                    style={{
                                      padding: "6px 12px",
                                      borderTop: "1px solid #e5e7eb",
                                      textAlign: "right",
                                    }}
                                  >
                                    {g.totalAmount.toLocaleString(undefined, {
                                      maximumFractionDigits: 2,
                                    })}
                                  </td>
                                  <td
                                    style={{
                                      padding: "6px 12px",
                                      borderTop: "1px solid #e5e7eb",
                                      textAlign: "right",
                                    }}
                                  >
                                    {g.completedAmount.toLocaleString(undefined, {
                                      maximumFractionDigits: 2,
                                    })}
                                  </td>
                                  <td
                                    style={{
                                      padding: "6px 12px",
                                      borderTop: "1px solid #e5e7eb",
                                      textAlign: "right",
                                    }}
                                  >
                                    {g.percentComplete.toFixed(2)}%
                                  </td>
                                </tr>

                                {g.particleId && isExpanded && itemsForRoom.length > 0 && (
                                  <tr>
                                    <td
                                      colSpan={5}
                                      style={{
                                        padding: "0 12px 8px 12px",
                                        borderTop: "1px solid #e5e7eb",
                                        background: "#ffffff",
                                      }}
                                    >
                                      <table
                                        style={{
                                          width: "100%",
                                          borderCollapse: "collapse",
                                          marginTop: 6,
                                          fontSize: 11,
                                        }}
                                      >
                                        <thead>
                                          <tr style={{ backgroundColor: "#f8fafc" }}>
                                            <th style={{ textAlign: "left", padding: "4px 8px" }}>Line</th>
                                            <th style={{ textAlign: "left", padding: "4px 8px" }}>Task</th>
                                            <th style={{ textAlign: "right", padding: "4px 8px" }}>Qty</th>
                                            <th style={{ textAlign: "right", padding: "4px 8px" }}>Unit</th>
                                            <th style={{ textAlign: "right", padding: "4px 8px" }}>Total</th>
                                            <th style={{ textAlign: "right", padding: "4px 8px" }}>RCV</th>
                                            <th style={{ textAlign: "right", padding: "4px 8px" }}>%</th>
                                            <th style={{ textAlign: "left", padding: "4px 8px" }}>Cat</th>
                                            <th style={{ textAlign: "left", padding: "4px 8px" }}>Sel</th>
                                            <th style={{ textAlign: "left", padding: "4px 8px" }}>PUDL</th>
                                            <th style={{ textAlign: "left", padding: "4px 8px" }}>Recon</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {/* Items are pre-filtered in petlItemsByRoomParticleId memo */}
                                          {itemsForRoom.map((item: PetlItem) => {
                                              const flagged = isPetlReconFlagged(item.id);
                                              const hasRecon = hasReconciliationActivity(item.id);
                                              const bg = flagged
                                                ? "#fef3c7"
                                                : hasRecon
                                                  ? "#e0f2fe"
                                                  : "transparent";

                                              const displayLineNo =
                                                item.sourceLineNo && item.sourceLineNo > 0 ? item.sourceLineNo : item.lineNo;

                                              return (
                                                <tr key={item.id} style={{ backgroundColor: bg }}>
                                                  <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                                    {displayLineNo}
                                                  </td>
                                                  <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                                    {item.description}
                                                  </td>
                                                  <td
                                                    style={{
                                                      padding: "3px 8px",
                                                      borderTop: "1px solid #e5e7eb",
                                                      textAlign: "right",
                                                    }}
                                                  >
                                                    {item.qty ?? ""}
                                                  </td>
                                                  <td
                                                    style={{
                                                      padding: "3px 8px",
                                                      borderTop: "1px solid #e5e7eb",
                                                      textAlign: "right",
                                                    }}
                                                  >
                                                    {item.unit ?? ""}
                                                  </td>
                                                  <td
                                                    style={{
                                                      padding: "3px 8px",
                                                      borderTop: "1px solid #e5e7eb",
                                                      textAlign: "right",
                                                    }}
                                                  >
                                                    {(item.itemAmount ?? 0).toLocaleString(undefined, {
                                                      maximumFractionDigits: 2,
                                                    })}
                                                  </td>
                                                  <td
                                                    style={{
                                                      padding: "3px 8px",
                                                      borderTop: "1px solid #e5e7eb",
                                                      textAlign: "right",
                                                    }}
                                                  >
                                                    {(item.rcvAmount ?? 0).toLocaleString(undefined, {
                                                      maximumFractionDigits: 2,
                                                    })}
                                                  </td>
                                                  <td
                                                    style={{
                                                      padding: "3px 8px",
                                                      borderTop: "1px solid #e5e7eb",
                                                      textAlign: "right",
                                                    }}
                                                  >
                                                    <select
                                                      value={item.isAcvOnly ? "ACV" : String(item.percentComplete)}
                                                      onChange={async (e) => {
                                                        const value = e.target.value;
                                                        const isAcv = value === "ACV";
                                                        const percent = isAcv ? 0 : Number(value);
                                                        if (
                                                          !isAcv &&
                                                          (Number.isNaN(percent) || percent < 0 || percent > 100)
                                                        ) {
                                                          return;
                                                        }

                                                        const token = localStorage.getItem("accessToken");
                                                        if (!token) {
                                                          alert("Missing access token; please log in again.");
                                                          return;
                                                        }

                                                        try {
                                                          setPetlItems((prev) =>
                                                            prev.map((it) =>
                                                              it.id === item.id
                                                                ? {
                                                                    ...it,
                                                                    percentComplete: percent,
                                                                    isAcvOnly: isAcv,
                                                                  }
                                                                : it,
                                                            ),
                                                          );

                                                          const res = await fetch(
                                                            `${API_BASE}/projects/${id}/petl/${item.id}/percent`,
                                                            {
                                                              method: "POST",
                                                              headers: {
                                                                "Content-Type": "application/json",
                                                                Authorization: `Bearer ${token}`,
                                                              },
                                                              body: JSON.stringify({
                                                                newPercent: percent,
                                                                acvOnly: isAcv,
                                                              }),
                                                            },
                                                          );
                                                          if (!res.ok) {
                                                            console.error("Per-line update failed", res.status);
                                                          }

                                                          try {
                                                            setGroupLoading(true);
                                                            const groupsRes = await fetch(
                                                              `${API_BASE}/projects/${id}/petl-groups`,
                                                              {
                                                                headers: {
                                                                  Authorization: `Bearer ${token}`,
                                                                },
                                                              },
                                                            );
                                                            if (groupsRes.ok) {
                                                              const json: any = await groupsRes.json();
                                                              setGroups(Array.isArray(json.groups) ? json.groups : []);
                                                              setUnitGroups(
                                                                Array.isArray(json.unitGroups) ? json.unitGroups : [],
                                                              );
                                                            }
                                                          } catch {
                                                            // non-fatal
                                                          } finally {
                                                            setGroupLoading(false);
                                                          }
                                                        } catch (err) {
                                                          console.error(err);
                                                        }
                                                      }}
                                                      style={{
                                                        width: 70,
                                                        padding: "2px 4px",
                                                        borderRadius: 4,
                                                        border: "1px solid #d1d5db",
                                                        fontSize: 11,
                                                      }}
                                                    >
                                                      <option value="0">0%</option>
                                                      <option value="10">10%</option>
                                                      <option value="20">20%</option>
                                                      <option value="30">30%</option>
                                                      <option value="40">40%</option>
                                                      <option value="50">50%</option>
                                                      <option value="60">60%</option>
                                                      <option value="70">70%</option>
                                                      <option value="80">80%</option>
                                                      <option value="90">90%</option>
                                                      <option value="100">100%</option>
                                                      <option value="ACV">ACV only</option>
                                                    </select>
                                                  </td>
                                                  <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                                    {item.categoryCode ?? ""}
                                                  </td>
                                                  <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                                    {item.selectionCode ?? ""}
                                                  </td>
                                                  <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                                    <button
                                                      type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        const sowLabel = item.description || `Line ${displayLineNo}`;
                                                        const parts: string[] = [];
                                                        parts.push(g.roomName);
                                                        parts.push(`SOW: ${sowLabel}`);
                                                        const breadcrumb = parts.filter(Boolean).join(" · ");

                                                        setPudlContext({
                                                          open: true,
                                                          buildingId: null,
                                                          unitId: u.unitId ?? null,
                                                          roomParticleId: g.particleId ?? null,
                                                          sowItemId: item.id,
                                                          breadcrumb,
                                                        });

                                                        setNewDailyLog((prev) => ({
                                                          ...prev,
                                                          roomParticleId: g.particleId ?? prev.roomParticleId,
                                                          sowItemId: item.id,
                                                        }));

                                                        setTab("DAILY_LOGS");
                                                      }}
                                                      style={{
                                                        padding: "2px 6px",
                                                        borderRadius: 999,
                                                        border: "1px solid #2563eb",
                                                        background: "#eff6ff",
                                                        fontSize: 11,
                                                        cursor: "pointer",
                                                        color: "#1d4ed8",
                                                      }}
                                                    >
                                                      PUDL
                                                    </button>
                                                  </td>
                                                  <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                                    <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
                                                      <button
                                                        type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          const flagged2 = isPetlReconFlagged(item.id);
                                                          petlTransitionOverlayLabelRef.current = flagged2
                                                            ? "Removing flag…"
                                                            : "Flagging for review…";
                                                          busyOverlay.setMessage(
                                                            petlTransitionOverlayLabelRef.current,
                                                          );
                                                          startPetlTransition(() => togglePetlReconFlag(item.id));
                                                        }}
                                                        style={{
                                                          padding: "2px 6px",
                                                          borderRadius: 999,
                                                          border: flagged
                                                            ? "1px solid #b45309"
                                                            : "1px solid #d1d5db",
                                                          background: flagged ? "#fffbeb" : "#ffffff",
                                                          fontSize: 11,
                                                          cursor: "pointer",
                                                          color: flagged ? "#92400e" : "#374151",
                                                        }}
                                                      >
                                                        {flagged ? "Needs review" : "Flag"}
                                                      </button>
                                                      <button
                                                        type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          void openPetlReconciliation(item.id);
                                                        }}
                                                        style={{
                                                          padding: "2px 6px",
                                                          borderRadius: 999,
                                                          border: hasRecon
                                                            ? "1px solid #0284c7"
                                                            : "1px solid #d1d5db",
                                                          background: hasRecon ? "#e0f2fe" : "#ffffff",
                                                          fontSize: 11,
                                                          cursor: "pointer",
                                                          color: hasRecon ? "#075985" : "#374151",
                                                        }}
                                                      >
                                                        Recon
                                                      </button>
                                                    </div>
                                                  </td>
                                                </tr>
                                              );
                                            })}
                                        </tbody>
                                      </table>
                                    </td>
                                  </tr>
                                )}
                              </Fragment>
                            );
                          })}
                      </Fragment>
                    );
                  })}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Fallback: room-only grouping (older API) */}
      {petlDisplayMode === "PROJECT_GROUPING" && !groupLoading && unitGroups.length === 0 && groups.length > 0 && (
        <div style={{ marginTop: 16 }}>
          <h2 style={{ fontSize: 16, fontWeight: 600, marginBottom: 8 }}>Rooms / Zones</h2>
          <div
            style={{
              borderRadius: 8,
              backgroundColor: "#ffffff",
              border: "1px solid #e5e7eb",
            }}
          >
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
              <thead>
                <tr style={{ backgroundColor: "#f9fafb" }}>
                  <th style={{ textAlign: "left", padding: "8px 12px" }}>Room</th>
                  <th style={{ textAlign: "right", padding: "8px 12px" }}>Tasks</th>
                  <th style={{ textAlign: "right", padding: "8px 12px" }}>Total</th>
                  <th style={{ textAlign: "right", padding: "8px 12px" }}>Completed</th>
                  <th style={{ textAlign: "right", padding: "8px 12px" }}>% Complete</th>
                </tr>
              </thead>
              <tbody>
                {(roomParticleIdFilters.length
                  ? groups.filter((g) => g.particleId && roomParticleIdFilterSet.has(g.particleId))
                  : groups
                ).map((g) => {
                  const itemsForRoom = filteredItemsForRoom(g.particleId);
                  const isExpanded = g.particleId ? expandedRooms.has(g.particleId) : false;

                  return (
                    <Fragment key={g.particleId ?? String(g.id)}>
                      <tr>
                        <td
                          style={{
                            padding: "6px 12px",
                            borderTop: "1px solid #e5e7eb",
                            cursor: g.particleId ? "pointer" : "default",
                            color: g.particleId ? "#2563eb" : "inherit",
                            textDecoration:
                              g.particleId && isExpanded ? "underline" : "none",
                          }}
                          onClick={() => {
                            if (!g.particleId) return;
                            toggleRoomExpanded(g.particleId);
                          }}
                        >
                          {isExpanded ? "▾ " : "▸ "}
                          {g.roomName}
                        </td>
                        <td style={{ padding: "6px 12px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                          {g.itemsCount}
                        </td>
                        <td style={{ padding: "6px 12px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                          {g.totalAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                        </td>
                        <td style={{ padding: "6px 12px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                          {g.completedAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                        </td>
                        <td style={{ padding: "6px 12px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                          {g.percentComplete.toFixed(2)}%
                        </td>
                      </tr>

                      {g.particleId && isExpanded && itemsForRoom.length > 0 && (
                        <tr>
                          <td
                            colSpan={5}
                            style={{
                              padding: "0 12px 8px 12px",
                              borderTop: "1px solid #e5e7eb",
                              background: "#ffffff",
                            }}
                          >
                            <table
                              style={{
                                width: "100%",
                                borderCollapse: "collapse",
                                marginTop: 6,
                                fontSize: 11,
                              }}
                            >
                              <thead>
                                <tr style={{ backgroundColor: "#f8fafc" }}>
                                  <th style={{ textAlign: "left", padding: "4px 8px" }}>Line</th>
                                  <th style={{ textAlign: "left", padding: "4px 8px" }}>Task</th>
                                  <th style={{ textAlign: "right", padding: "4px 8px" }}>Qty</th>
                                  <th style={{ textAlign: "right", padding: "4px 8px" }}>Unit</th>
                                  <th style={{ textAlign: "right", padding: "4px 8px" }}>Total</th>
                                  <th style={{ textAlign: "right", padding: "4px 8px" }}>RCV</th>
                                  <th style={{ textAlign: "right", padding: "4px 8px" }}>%</th>
                                  <th style={{ textAlign: "left", padding: "4px 8px" }}>Cat</th>
                                  <th style={{ textAlign: "left", padding: "4px 8px" }}>Sel</th>
                                </tr>
                              </thead>
                              <tbody>
                                {/* Items are pre-filtered in petlItemsByRoomParticleId memo */}
                                {itemsForRoom.map((item: PetlItem) => (
                                    <tr key={item.id}>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                        {item.sourceLineNo && item.sourceLineNo > 0 ? item.sourceLineNo : item.lineNo}
                                      </td>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                        {item.description}
                                      </td>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                                        {item.qty ?? ""}
                                      </td>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                                        {item.unit ?? ""}
                                      </td>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                                        {(item.itemAmount ?? 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}
                                      </td>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                                        {(item.rcvAmount ?? 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}
                                      </td>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb", textAlign: "right" }}>
                                        {item.percentComplete}
                                      </td>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                        {item.categoryCode ?? ""}
                                      </td>
                                      <td style={{ padding: "3px 8px", borderTop: "1px solid #e5e7eb" }}>
                                        {item.selectionCode ?? ""}
                                      </td>
                                    </tr>
                                  ))}
                              </tbody>
                            </table>
                          </td>
                        </tr>
                      )}
                    </Fragment>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {petlLineSequenceTable}

      {/* Room components side drawer */}
      {roomComponentsPanel.open ? (
        <div
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 40,
            display: "flex",
            justifyContent: "flex-end",
            backgroundColor: "rgba(15,23,42,0.35)",
          }}
          onClick={() =>
            setRoomComponentsPanel(prev => ({
              ...prev,
              open: false,
            }))
          }
        >
          <div
            style={{
              position: "relative",
              top: 0,
              bottom: 0,
              width: 360,
              maxWidth: "80vw",
              backgroundColor: "#ffffff",
              borderLeft: "1px solid #e5e7eb",
              boxShadow: "-4px 0 12px rgba(15,23,42,0.12)",
              display: "flex",
              flexDirection: "column",
            }}
            onClick={e => e.stopPropagation()}
          >
            <div
              style={{
                padding: "10px 12px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 13,
                fontWeight: 600,
                backgroundColor: "#f3f4f6",
              }}
            >
              <div>
                Components in
                <br />
                <span style={{ fontWeight: 700 }}>{roomComponentsPanel.roomName}</span>
              </div>
              <button
                type="button"
                onClick={() =>
                  setRoomComponentsPanel(prev => ({
                    ...prev,
                    open: false,
                  }))
                }
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  fontSize: 18,
                  lineHeight: 1,
                }}
                aria-label="Close components panel"
              >
                ×
              </button>
            </div>

            <div style={{ padding: 10, fontSize: 12, flex: 1, overflow: "auto" }}>
              {roomComponentsPanel.loading && (
                <div style={{ color: "#6b7280" }}>Loading components…</div>
              )}
              {!roomComponentsPanel.loading && roomComponentsPanel.error && (
                <div style={{ color: "#b91c1c" }}>{roomComponentsPanel.error}</div>
              )}
              {!roomComponentsPanel.loading &&
                !roomComponentsPanel.error &&
                roomComponentsPanel.components.length === 0 && (
                  <div style={{ color: "#6b7280" }}>
                    No components found for this selection.
                  </div>
                )}
              {!roomComponentsPanel.loading &&
                !roomComponentsPanel.error &&
                roomComponentsPanel.components.length > 0 && (
                  <table
                    style={{
                      width: "100%",
                      borderCollapse: "collapse",
                      fontSize: 12,
                    }}
                  >
                    <thead>
                      <tr style={{ backgroundColor: "#f9fafb" }}>
                        <th style={{ textAlign: "left", padding: "4px 6px" }}>Code</th>
                        <th style={{ textAlign: "left", padding: "4px 6px" }}>Description</th>
                        <th style={{ textAlign: "right", padding: "4px 6px" }}>Qty</th>
                        <th style={{ textAlign: "right", padding: "4px 6px" }}>Unit</th>
                        <th style={{ textAlign: "right", padding: "4px 6px" }}>Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {roomComponentsPanel.components.map((c) => (
                        <tr key={c.code}>
                          <td
                            style={{
                              padding: "4px 6px",
                              borderTop: "1px solid #e5e7eb",
                            }}
                          >
                            {c.code}
                          </td>
                          <td
                            style={{
                              padding: "4px 6px",
                              borderTop: "1px solid #e5e7eb",
                            }}
                          >
                            {c.description ?? ""}
                          </td>
                          <td
                            style={{
                              padding: "4px 6px",
                              borderTop: "1px solid #e5e7eb",
                              textAlign: "right",
                            }}
                          >
                            {c.quantity.toLocaleString(undefined, {
                              maximumFractionDigits: 2,
                            })}
                          </td>
                          <td
                            style={{
                              padding: "4px 6px",
                              borderTop: "1px solid #e5e7eb",
                              textAlign: "right",
                            }}
                          >
                            {c.unit ?? ""}
                          </td>
                          <td
                            style={{
                              padding: "4px 6px",
                              borderTop: "1px solid #e5e7eb",
                              textAlign: "right",
                            }}
                          >
                            {c.total.toLocaleString(undefined, {
                              maximumFractionDigits: 2,
                            })}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
            </div>
          </div>
        </div>
      ) : null}

      {/* PETL reconciliation side drawer */}
      {petlReconPanel.open ? (
        <div
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 45,
            display: "flex",
            justifyContent: "center",
            backgroundColor: "rgba(15,23,42,0.35)",
          }}
          onClick={() => {
            setPetlReconPanel(prev => ({
              ...prev,
              open: false,
            }));
            reconPanelDraggable.reset();
          }}
        >
          <div
            style={{
              position: "relative",
              margin: "24px 0",
              width: "min(960px, 96vw)",
              maxWidth: "96vw",
              maxHeight: "70vh",
              backgroundColor: "#ffffff",
              borderRadius: 10,
              boxShadow: "0 20px 50px rgba(15,23,42,0.35)",
              display: "flex",
              flexDirection: "column",
              ...reconPanelDraggable.style,
            }}
            onClick={e => e.stopPropagation()}
          >
            <div
              {...reconPanelDraggable.handleProps}
              style={{
                padding: "10px 12px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 13,
                fontWeight: 600,
                backgroundColor: "#f3f4f6",
                borderRadius: "10px 10px 0 0",
                ...reconPanelDraggable.handleProps.style,
              }}
            >
              <div>
                PETL Reconciliation
                <div style={{ fontSize: 11, fontWeight: 400, color: "#6b7280" }}>
                  {petlReconPanel.data?.sowItem?.description || ""}
                </div>
              </div>
              <button
                type="button"
                onClick={() => {
                  setPetlReconPanel(prev => ({
                    ...prev,
                    open: false,
                  }));
                  reconPanelDraggable.reset();
                }}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  fontSize: 18,
                  lineHeight: 1,
                }}
                aria-label="Close reconciliation panel"
              >
                ×
              </button>
            </div>

            <div style={{ padding: 12, fontSize: 12, flex: 1, overflow: "auto" }}>
              {petlReconPanel.loading && (
                <div style={{ color: "#6b7280" }}>Loading reconciliation…</div>
              )}

              {!petlReconPanel.loading && petlReconPanel.error && (
                <div style={{ color: "#b91c1c" }}>{petlReconPanel.error}</div>
              )}

              {!petlReconPanel.loading && !petlReconPanel.error && petlReconPanel.data && (
                <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
                  <div>
                    <div style={{ fontWeight: 600, marginBottom: 6 }}>
                      RCV breakdown (baseline)
                    </div>
                    <div
                      style={{
                        border: "1px solid #e5e7eb",
                        borderRadius: 8,
                        padding: 10,
                        background: "#f9fafb",
                      }}
                    >
                      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6 }}>
                        <div>Qty: {petlReconPanel.data.rcvBreakdown?.qty ?? ""}</div>
                        <div>Unit cost: {petlReconPanel.data.rcvBreakdown?.unitCost ?? ""}</div>
                        <div>
                          Item: {petlReconPanel.data.rcvBreakdown?.itemAmount ?? 0}
                        </div>
                        <div>
                          Tax: {petlReconPanel.data.rcvBreakdown?.salesTaxAmount ?? 0}
                        </div>
                        <div>O&P/Other: {petlReconPanel.data.rcvBreakdown?.opAmount ?? 0}</div>
                        <div style={{ fontWeight: 600 }}>
                          RCV: {petlReconPanel.data.rcvBreakdown?.rcvAmount ?? 0}
                        </div>
                      </div>
                      {/* Xact cost components for activity-based calculations */}
                      {petlReconPanel.data.xactCostComponents && (
                        <div style={{ marginTop: 8, paddingTop: 8, borderTop: "1px solid #e5e7eb" }}>
                          <div style={{ fontSize: 11, fontWeight: 600, color: "#4338ca", marginBottom: 4 }}>
                            Xactimate Cost Components
                          </div>
                          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 4, fontSize: 11 }}>
                            <div>Wage: ${(petlReconPanel.data.xactCostComponents.workersWage ?? 0).toFixed(2)}</div>
                            <div>Burden: ${(petlReconPanel.data.xactCostComponents.laborBurden ?? 0).toFixed(2)}</div>
                            <div>Overhead: ${(petlReconPanel.data.xactCostComponents.laborOverhead ?? 0).toFixed(2)}</div>
                            <div>Material: ${(petlReconPanel.data.xactCostComponents.material ?? 0).toFixed(2)}</div>
                            <div>Equipment: ${(petlReconPanel.data.xactCostComponents.equipment ?? 0).toFixed(2)}</div>
                            {petlReconPanel.data.xactCostComponents.sourceActivity && (
                              <div style={{ color: "#6b7280" }}>Activity: {petlReconPanel.data.xactCostComponents.sourceActivity}</div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  <div>
                    <div style={{ fontWeight: 600, marginBottom: 6 }}>Note</div>
                    <textarea
                      value={reconNote}
                      onChange={e => setReconNote(e.target.value)}
                      placeholder="Add a journal note for this reconciliation action..."
                      style={{
                        width: "100%",
                        minHeight: 70,
                        padding: 8,
                        border: "1px solid #d1d5db",
                        borderRadius: 8,
                        fontSize: 12,
                      }}
                    />
                  </div>

                  <div>
                    <div style={{ fontWeight: 600, marginBottom: 6 }}>Tag</div>
                    <select
                      value={reconEntryTag}
                      onChange={e => setReconEntryTag(e.target.value as ReconEntryTag)}
                      style={{
                        padding: "6px 8px",
                        borderRadius: 8,
                        border: "1px solid #d1d5db",
                        fontSize: 12,
                        width: "100%",
                      }}
                    >
                      <option value="">—</option>
                      <option value="SUPPLEMENT">Supplement</option>
                      <option value="CHANGE_ORDER">Change order</option>
                      <option value="OTHER">Other</option>
                      <option value="WARRANTY">Warranty</option>
                    </select>
                    <div style={{ marginTop: 4, fontSize: 11, color: "#6b7280" }}>
                      Applied to new entries created below (you can edit tags later).
                    </div>
                  </div>

                  <div>
                    <div style={{ fontWeight: 600, marginBottom: 6 }}>Create credit</div>
                    <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginBottom: 8 }}>
                      {(
                        [
                          { key: "itemAmount", label: "Item" },
                          { key: "salesTaxAmount", label: "Tax" },
                          { key: "opAmount", label: "O&P/Other" },
                        ] as const
                      ).map(opt => (
                        <label key={opt.key} style={{ display: "flex", gap: 6, alignItems: "center" }}>
                          <input
                            type="checkbox"
                            checked={reconCreditComponents[opt.key]}
                            onChange={e =>
                              setReconCreditComponents(prev => ({
                                ...prev,
                                [opt.key]: e.target.checked,
                              }))
                            }
                          />
                          {opt.label}
                        </label>
                      ))}
                    </div>
                    <button
                      type="button"
                      onClick={submitReconCredit}
                      style={{
                        padding: "6px 10px",
                        borderRadius: 8,
                        border: "1px solid #0f172a",
                        background: "#0f172a",
                        color: "#f9fafb",
                        cursor: "pointer",
                        fontSize: 12,
                      }}
                    >
                      Create credit
                    </button>
                  </div>

                  <div>
                    <div style={{ fontWeight: 600, marginBottom: 6 }}>Placeholder / note-only</div>
                    <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                      <select
                        value={reconPlaceholderKind}
                        onChange={e => setReconPlaceholderKind(e.target.value)}
                        style={{
                          padding: "6px 8px",
                          borderRadius: 8,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                        }}
                      >
                        <option value="NOTE_ONLY">Note only</option>
                        <option value="CHANGE_ORDER_CLIENT_PAY">Change order (client pay)</option>
                        <option value="REIMBURSE_OWNER">Reimburse owner</option>
                      </select>
                      <button
                        type="button"
                        onClick={submitReconPlaceholder}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 8,
                          border: "1px solid #d1d5db",
                          background: "#ffffff",
                          cursor: "pointer",
                          fontSize: 12,
                        }}
                      >
                        Add placeholder
                      </button>
                    </div>
                  </div>

                  <div>
                    <div style={{ fontWeight: 600, marginBottom: 6 }}>Add from Cost Book</div>

                    <div style={{ display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
                      <button
                        type="button"
                        onClick={() => {
                          petlTransitionOverlayLabelRef.current = "Opening cost book…";
                          busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
                          startPetlTransition(() => setCostBookModalOpen(true));
                        }}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 8,
                          border: "1px solid #2563eb",
                          background: "#eff6ff",
                          cursor: "pointer",
                          fontSize: 12,
                          color: "#1d4ed8",
                        }}
                      >
                        Open Cost Book
                      </button>
                      <div style={{ flex: 1 }} />
                      <button
                        type="button"
                        onClick={() =>
                          setPetlReconPanel(prev => ({
                            ...prev,
                            open: false,
                          }))
                        }
                        style={{
                          padding: "6px 10px",
                          borderRadius: 8,
                          border: "1px solid #d1d5db",
                          background: "#ffffff",
                          cursor: "pointer",
                          fontSize: 12,
                        }}
                      >
                        Cancel
                      </button>
                      <button
                        type="button"
                        onClick={saveReconPanel}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 8,
                          border: "1px solid #0f172a",
                          background: "#0f172a",
                          color: "#f9fafb",
                          cursor: "pointer",
                          fontSize: 12,
                        }}
                      >
                        Save
                      </button>
                    </div>
                    <div style={{ fontSize: 11, color: "#6b7280", marginTop: 4 }}>
                      Reference line is shown in the header; search or filter as needed.
                    </div>
                  </div>

                  <div>
                    <div style={{ fontWeight: 600, marginBottom: 6 }}>Reconciliation entries</div>
                    <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 6 }}>
                      Tip: click a row to edit. To move a reconciliation line to a different PETL item,
                      Delete it here and recreate it under the correct line.
                    </div>
                    {(petlReconPanel.data.reconciliationCase?.entries || []).length === 0 ? (
                      <div style={{ color: "#6b7280" }}>No entries yet.</div>
                    ) : (
                      <div
                        style={{
                          border: "1px solid #e5e7eb",
                          borderRadius: 8,
                          overflow: "hidden",
                          maxHeight: 260,
                          overflowY: "auto",
                        }}
                      >
                        <table
                          style={{
                            width: "100%",
                            borderCollapse: "collapse",
                            minWidth: 600,
                          }}
                        >
                          <thead>
                            <tr style={{ background: "#f9fafb" }}>
                              <th style={{ textAlign: "left", padding: "6px 8px", width: 70 }}>Line</th>
                              <th style={{ textAlign: "left", padding: "6px 8px" }}>Kind</th>
                              <th style={{ textAlign: "left", padding: "6px 8px" }}>Tag</th>
                              <th style={{ textAlign: "left", padding: "6px 8px", width: 80 }}>Status</th>
                              <th style={{ textAlign: "right", padding: "6px 8px" }}>RCV</th>
                              <th style={{ textAlign: "right", padding: "6px 8px" }}>% complete</th>
                              <th style={{ textAlign: "left", padding: "6px 8px" }}>Note</th>
                              <th style={{ textAlign: "right", padding: "6px 8px" }}>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {reconEntries.map((e: any) => {
                              const pct = e.isPercentCompleteLocked ? 0 : (e.percentComplete ?? 0);
                              const seq = reconSeqById.get(String(e.id));
                              // Show CO line number format for standalone change orders
                              const lineLabel = e.isStandaloneChangeOrder && e.coSequenceNo != null
                                ? `${e.originLineNo ?? reconBaseLineNo ?? ""}-CO${e.coSequenceNo}`
                                : reconBaseLineNo != null && seq != null ? `${reconBaseLineNo}.${seq}` : "—";

                              const tagRaw = String(e?.tag ?? "").trim();
                              const tagLabel =
                                tagRaw === "SUPPLEMENT"
                                  ? "Supplement"
                                  : tagRaw === "CHANGE_ORDER"
                                    ? "Change order"
                                    : tagRaw === "OTHER"
                                      ? "Other"
                                      : tagRaw === "WARRANTY"
                                        ? "Warranty"
                                        : "";

                              const statusRaw = String(e?.status ?? "").trim().toUpperCase() || "PENDING";
                              const statusLabel =
                                statusRaw === "APPROVED"
                                  ? "Approved"
                                  : statusRaw === "REJECTED"
                                    ? "Rejected"
                                    : "Pending";
                              const statusColor =
                                statusRaw === "APPROVED"
                                  ? "#16a34a"
                                  : statusRaw === "REJECTED"
                                    ? "#b91c1c"
                                    : "#6b7280";

                              const canChangeStatus =
                                project &&
                                (project.userRole === "OWNER" ||
                                  project.userRole === "ADMIN" ||
                                  project.userRole === "PM");

                              const deleteEntry = async () => {
                                if (!project) return;
                                const token = localStorage.getItem("accessToken");
                                if (!token) {
                                  alert("Missing access token.");
                                  return;
                                }
                                if (
                                  !window.confirm(
                                    "Delete this reconciliation entry? Use Reject if you just want to keep a record without charging.",
                                  )
                                ) {
                                  return;
                                }
                                try {
                                  const res = await fetch(
                                    `${API_BASE}/projects/${project.id}/petl-reconciliation/entries/${e.id}`,
                                    {
                                      method: "DELETE",
                                      headers: {
                                        Authorization: `Bearer ${token}`,
                                      },
                                    },
                                  );
                                  if (!res.ok) {
                                    const text = await res.text().catch(() => "");
                                    alert(`Delete failed (${res.status}) ${text}`);
                                    return;
                                  }
                                  setPetlReloadTick((t) => t + 1);
                                  if (petlReconPanel.sowItemId) {
                                    void loadPetlReconciliation(petlReconPanel.sowItemId);
                                  }
                                  await loadActiveInvoice();
                                } catch (err: any) {
                                  alert(err?.message ?? "Failed to delete reconciliation entry.");
                                }
                              };

                              const changeStatus = async (nextStatus: "APPROVED" | "REJECTED") => {
                                if (!project) return;
                                const token = localStorage.getItem("accessToken");
                                if (!token) {
                                  alert("Missing access token.");
                                  return;
                                }
                                try {
                                  const res = await fetch(
                                    `${API_BASE}/projects/${project.id}/petl-reconciliation/entries/${e.id}`,
                                    {
                                      method: "PATCH",
                                      headers: {
                                        "Content-Type": "application/json",
                                        Authorization: `Bearer ${token}`,
                                      },
                                      body: JSON.stringify({ status: nextStatus }),
                                    },
                                  );
                                  if (!res.ok) {
                                    const text = await res.text().catch(() => "");
                                    alert(`Update failed (${res.status}) ${text}`);
                                    return;
                                  }
                                  // Refresh PETL + this reconciliation panel and invoice
                                  setPetlReloadTick((t) => t + 1);
                                  if (petlReconPanel.sowItemId) {
                                    void loadPetlReconciliation(petlReconPanel.sowItemId);
                                  }
                                  // Best effort: refresh active invoice from API
                                  await loadActiveInvoice();
                                } catch (err: any) {
                                  alert(err?.message ?? "Failed to update reconciliation status.");
                                }
                              };

                              return (
                                <tr
                                  key={e.id}
                                  onClick={() => openReconEntryEdit(e)}
                                  style={{ cursor: "pointer" }}
                                >
                                  <td
                                    style={{
                                      padding: "6px 8px",
                                      borderTop: "1px solid #e5e7eb",
                                      fontFamily:
                                        "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",
                                      color: "#4b5563",
                                      whiteSpace: "nowrap",
                                    }}
                                  >
                                    {lineLabel}
                                  </td>
                                  <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                    {e.kind}
                                  </td>
                                  <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                    {tagLabel ? (
                                      <span
                                        style={{
                                          display: "inline-flex",
                                          padding: "2px 8px",
                                          borderRadius: 999,
                                          border: "1px solid #d1d5db",
                                          background: "#ffffff",
                                          fontSize: 11,
                                          color: "#374151",
                                          whiteSpace: "nowrap",
                                        }}
                                      >
                                        {tagLabel}
                                      </span>
                                    ) : (
                                      <span style={{ color: "#9ca3af" }}>—</span>
                                    )}
                                  </td>
                                  <td
                                    style={{
                                      padding: "6px 8px",
                                      borderTop: "1px solid #e5e7eb",
                                      color: statusColor,
                                      whiteSpace: "nowrap",
                                    }}
                                  >
                                    {statusLabel}
                                  </td>
                                  <td
                                    style={{
                                      padding: "6px 8px",
                                      borderTop: "1px solid #e5e7eb",
                                      textAlign: "right",
                                    }}
                                  >
                                    {(e.rcvAmount ?? 0).toLocaleString(undefined, {
                                      maximumFractionDigits: 2,
                                    })}
                                  </td>
                                  <td
                                    style={{
                                      padding: "6px 8px",
                                      borderTop: "1px solid #e5e7eb",
                                      textAlign: "right",
                                    }}
                                  >
                                    {e.isPercentCompleteLocked ? (
                                      "—"
                                    ) : (
                                      <select
                                        value={String(pct)}
                                        onChange={(ev) => {
                                          const next = Number(ev.target.value);
                                          if (Number.isNaN(next)) return;
                                          void submitReconEntryPercent(e.id, next);
                                        }}
                                        style={{
                                          width: 70,
                                          padding: "2px 4px",
                                          borderRadius: 6,
                                          border: "1px solid #d1d5db",
                                          fontSize: 11,
                                        }}
                                      >
                                        <option value="0">0%</option>
                                        <option value="10">10%</option>
                                        <option value="20">20%</option>
                                        <option value="30">30%</option>
                                        <option value="40">40%</option>
                                        <option value="50">50%</option>
                                        <option value="60">60%</option>
                                        <option value="70">70%</option>
                                        <option value="80">80%</option>
                                        <option value="90">90%</option>
                                        <option value="100">100%</option>
                                      </select>
                                    )}
                                  </td>
                                  <td style={{ padding: "6px 8px", borderTop: "1px solid #e5e7eb" }}>
                                    {e.note ?? ""}
                                  </td>
                                  <td
                                    style={{
                                      padding: "6px 8px",
                                      borderTop: "1px solid #e5e7eb",
                                      textAlign: "left",
                                    }}
                                  >
                                    <div style={{ display: "flex", gap: 6, justifyContent: "flex-end" }}>
                                      <button
                                        type="button"
                                        onClick={(event) => {
                                          event.stopPropagation();
                                          openReconEntryEdit(e);
                                        }}
                                        style={{
                                          padding: "4px 8px",
                                          borderRadius: 6,
                                          border: "1px solid #d1d5db",
                                          background: "#ffffff",
                                          cursor: "pointer",
                                          fontSize: 11,
                                        }}
                                      >
                                        Edit
                                      </button>
                                      {canChangeStatus && (
                                        <>
                                          <button
                                            type="button"
                                            onClick={(event) => {
                                              event.stopPropagation();
                                              void changeStatus("APPROVED");
                                            }}
                                            style={{
                                              padding: "4px 8px",
                                              borderRadius: 6,
                                              border: "1px solid #16a34a",
                                              background: "#ecfdf3",
                                              color: "#166534",
                                              cursor: "pointer",
                                              fontSize: 11,
                                            }}
                                          >
                                            Approve
                                          </button>
                                          <button
                                            type="button"
                                            onClick={(event) => {
                                              event.stopPropagation();
                                              void changeStatus("REJECTED");
                                            }}
                                            style={{
                                              padding: "4px 8px",
                                              borderRadius: 6,
                                              border: "1px solid #b91c1c",
                                              background: "#fef2f2",
                                              color: "#b91c1c",
                                              cursor: "pointer",
                                              fontSize: 11,
                                            }}
                                          >
                                            Reject
                                          </button>
                                          <button
                                            type="button"
                                            onClick={(event) => {
                                              event.stopPropagation();
                                              void deleteEntry();
                                            }}
                                            style={{
                                              padding: "4px 8px",
                                              borderRadius: 6,
                                              border: "1px solid #6b7280",
                                              background: "#f9fafb",
                                              color: "#374151",
                                              cursor: "pointer",
                                              fontSize: 11,
                                            }}
                                          >
                                            Delete
                                          </button>
                                        </>
                                      )}
                                    </div>
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>

                  {/* Cross-version case history (Time Machine) */}
                  {(() => {
                    const history: any | null = petlReconPanel.data?.history ?? null;
                    if (!history || !Array.isArray(history.entries) || history.entries.length === 0) {
                      return null;
                    }

                    // Group entries by version for better display
                    const entriesWithNotes = history.entries.filter((e: any) => e.note);

                    return (
                      <div>
                        <div style={{ fontWeight: 600, marginBottom: 6 }}>Case history across estimate versions</div>
                        <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 6 }}>
                          Shows reconciliation entries across all versions, including notes from previous revisions.
                        </div>
                        <div
                          style={{
                            border: "1px solid #e5e7eb",
                            borderRadius: 8,
                            maxHeight: 320,
                            overflowY: "auto",
                            fontSize: 11,
                          }}
                        >
                          <table
                            style={{
                              width: "100%",
                              borderCollapse: "collapse",
                              minWidth: 700,
                            }}
                          >
                            <thead>
                              <tr style={{ background: "#f9fafb" }}>
                                <th style={{ textAlign: "left", padding: "6px 8px", width: 100 }}>Version</th>
                                <th style={{ textAlign: "left", padding: "6px 8px", width: 60 }}>Line</th>
                                <th style={{ textAlign: "left", padding: "6px 8px", width: 80 }}>Kind</th>
                                <th style={{ textAlign: "left", padding: "6px 8px", width: 80 }}>Tag</th>
                                <th style={{ textAlign: "left", padding: "6px 8px" }}>Note</th>
                                <th style={{ textAlign: "right", padding: "6px 8px", width: 90 }}>RCV</th>
                              </tr>
                            </thead>
                            <tbody>
                              {history.entries.map((e: any) => {
                                const originVer = e.origin?.estimateVersion ?? null;
                                const originVerLabel = originVer
                                  ? `v${originVer.sequenceNo ?? "?"}`
                                  : "—";
                                const originLine = e.originLineNo ?? e.origin?.lineNo ?? null;

                                const tagRaw = String(e.tag ?? "").trim();
                                const tagLabel =
                                  tagRaw === "SUPPLEMENT"
                                    ? "Supplement"
                                    : tagRaw === "CHANGE_ORDER"
                                      ? "Change order"
                                      : tagRaw === "OTHER"
                                        ? "Other"
                                        : tagRaw === "WARRANTY"
                                          ? "Warranty"
                                          : "—";

                                const hasNote = e.note && e.note.trim();

                                return (
                                  <tr
                                    key={e.id}
                                    style={{
                                      borderTop: "1px solid #e5e7eb",
                                      background: hasNote ? "#fffbeb" : undefined,
                                    }}
                                  >
                                    <td style={{ padding: "6px 8px", whiteSpace: "nowrap", color: "#6b7280" }}>
                                      {originVerLabel}
                                    </td>
                                    <td style={{ padding: "6px 8px", fontFamily: "monospace" }}>
                                      {originLine ?? "—"}
                                    </td>
                                    <td style={{ padding: "6px 8px" }}>{e.kind}</td>
                                    <td style={{ padding: "6px 8px" }}>{tagLabel}</td>
                                    <td
                                      style={{
                                        padding: "6px 8px",
                                        color: hasNote ? "#92400e" : "#9ca3af",
                                        fontStyle: hasNote ? "normal" : "italic",
                                      }}
                                    >
                                      {hasNote ? e.note : "(no note)"}
                                    </td>
                                    <td style={{ padding: "6px 8px", textAlign: "right" }}>
                                      {e.rcvAmount != null
                                        ? e.rcvAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })
                                        : "—"}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        {entriesWithNotes.length > 0 && (
                          <div
                            style={{
                              marginTop: 8,
                              padding: "8px 10px",
                              background: "#fffbeb",
                              border: "1px solid #fcd34d",
                              borderRadius: 6,
                              fontSize: 11,
                            }}
                          >
                            <div style={{ fontWeight: 600, color: "#92400e", marginBottom: 4 }}>
                              📝 Notes from previous versions ({entriesWithNotes.length})
                            </div>
                            {entriesWithNotes.map((e: any) => {
                              const originVer = e.origin?.estimateVersion ?? null;
                              const originVerLabel = originVer ? `v${originVer.sequenceNo ?? "?"}` : "";
                              const originLine = e.originLineNo ?? e.origin?.lineNo ?? null;
                              return (
                                <div key={e.id} style={{ marginBottom: 4, color: "#78350f" }}>
                                  <span style={{ color: "#6b7280" }}>
                                    {originVerLabel} line {originLine ?? "?"}:
                                  </span>{" "}
                                  {e.note}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </div>
              )}
            </div>
          </div>
        </div>
      ) : null}

      {reconEntryEdit && (
        <div
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 70,
            background: "rgba(15,23,42,0.45)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            padding: 12,
          }}
        >
          <div
            style={{
              width: 1100,
              maxWidth: "96vw",
              maxHeight: "85vh",
              overflow: "auto",
              background: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 20px 50px rgba(15,23,42,0.35)",
              ...reconEditDraggable.style,
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div
              {...reconEditDraggable.handleProps}
              style={{
                padding: "10px 12px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
                borderRadius: "10px 10px 0 0",
                ...reconEditDraggable.handleProps.style,
              }}
            >
              <div>
                Edit reconciliation entry
                <div style={{ fontSize: 11, fontWeight: 400, color: "#6b7280" }}>
                  {reconEntryEdit.entry?.kind ?? ""}
                </div>
              </div>
              <button
                type="button"
                onClick={closeReconEntryEdit}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  fontSize: 18,
                  lineHeight: 1,
                }}
                aria-label="Close reconciliation entry editor"
              >
                ×
              </button>
            </div>

            <div style={{ padding: 12, display: "flex", flexDirection: "column", gap: 10 }}>
              {/* Item Context - Location and Description for reference */}
              <div
                style={{
                  padding: 12,
                  borderRadius: 8,
                  border: "1px solid #e5e7eb",
                  background: "#f8fafc",
                  marginBottom: 4,
                }}
              >
                <div style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", marginBottom: 8, textTransform: "uppercase", letterSpacing: 0.5 }}>
                  Source Item Reference
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "auto 1fr", gap: "6px 12px", fontSize: 12 }}>
                  <div style={{ fontWeight: 600, color: "#374151" }}>Line:</div>
                  <div style={{ color: "#111827" }}>
                    {reconEntryEdit.entry?.isStandaloneChangeOrder && reconEntryEdit.entry?.originLineNo != null && reconEntryEdit.entry?.coSequenceNo != null
                      ? `${reconEntryEdit.entry.originLineNo}-CO${reconEntryEdit.entry.coSequenceNo}`
                      : petlReconPanel.data?.sowItem?.sourceLineNo || petlReconPanel.data?.sowItem?.lineNo || "—"}
                  </div>
                  <div style={{ fontWeight: 600, color: "#374151" }}>Location:</div>
                  <div style={{ color: "#111827" }}>
                    {petlReconPanel.data?.sowItem?.projectParticle?.fullLabel ||
                     petlReconPanel.data?.sowItem?.projectParticle?.name ||
                     "—"}
                  </div>
                  <div style={{ fontWeight: 600, color: "#374151" }}>Description:</div>
                  <div style={{ color: "#111827", lineHeight: 1.4 }}>
                    {petlReconPanel.data?.sowItem?.description || "—"}
                  </div>
                  {(petlReconPanel.data?.sowItem?.categoryCode || petlReconPanel.data?.sowItem?.selectionCode) && (
                    <>
                      <div style={{ fontWeight: 600, color: "#374151" }}>Cat/Sel:</div>
                      <div style={{ color: "#6b7280", fontFamily: "monospace", fontSize: 11 }}>
                        {petlReconPanel.data?.sowItem?.categoryCode || "—"} / {petlReconPanel.data?.sowItem?.selectionCode || "—"}
                      </div>
                    </>
                  )}
                </div>
              </div>

              {/* Move to Standalone Change Order option - shown at TOP for non-CO entries */}
              {isPmOrAbove && !reconEntryEdit.entry?.isStandaloneChangeOrder && (
                <div
                  style={{
                    marginBottom: 8,
                    padding: 12,
                    borderRadius: 8,
                    border: "1px solid #f59e0b",
                    background: "#fffbeb",
                  }}
                >
                  <div style={{ fontSize: 12, fontWeight: 600, color: "#92400e", marginBottom: 6 }}>
                    Move to Standalone Change Order?
                  </div>
                  <div style={{ fontSize: 11, color: "#78350f", marginBottom: 8 }}>
                    This will detach the entry from the original line item and create a new Change Order (CO)
                    in the same room. The note will travel with the entry. Use this for client-requested work
                    that is not part of the original loss scope.
                  </div>
                  <button
                    type="button"
                    disabled={reconEntryEdit.saving}
                    onClick={async () => {
                      if (!project || !reconEntryEdit) return;
                      const token = localStorage.getItem("accessToken");
                      if (!token) {
                        alert("Missing access token.");
                        return;
                      }
                      if (!window.confirm("Convert this entry to a standalone Change Order? You can undo this later if needed.")) {
                        return;
                      }
                      setReconEntryEdit((prev) => (prev ? { ...prev, saving: true } : prev));
                      try {
                        const res = await fetch(
                          `${API_BASE}/projects/${project.id}/petl-reconciliation/entries/${reconEntryEdit.entry.id}/convert-to-co`,
                          {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                              Authorization: `Bearer ${token}`,
                            },
                            body: JSON.stringify({
                              note: reconEntryEdit.draft.note || reconEntryEdit.entry?.note || null,
                              description: reconEntryEdit.draft.description || reconEntryEdit.entry?.description || null,
                              qty: parseFloat(reconEntryEdit.draft.qty) || reconEntryEdit.entry?.qty || 1,
                              unit: reconEntryEdit.draft.unit || reconEntryEdit.entry?.unit || null,
                            }),
                          },
                        );
                        if (!res.ok) {
                          const text = await res.text().catch(() => "");
                          alert(`Failed to convert to CO (${res.status}) ${text}`);
                          return;
                        }
                        const result = await res.json();
                        showPetlToast(`Converted to standalone CO: ${result.coLineNumber || "CO"}`);
                        closeReconEntryEdit();
                        setPetlReloadTick((t) => t + 1);
                        if (petlReconPanel.sowItemId) {
                          await loadPetlReconciliation(petlReconPanel.sowItemId);
                        }
                      } catch (err: any) {
                        alert(err?.message ?? "Failed to convert to Change Order.");
                      } finally {
                        setReconEntryEdit((prev) => (prev ? { ...prev, saving: false } : prev));
                      }
                    }}
                    style={{
                      padding: "6px 12px",
                      borderRadius: 8,
                      border: "1px solid #d97706",
                      background: "#fbbf24",
                      color: "#78350f",
                      cursor: reconEntryEdit.saving ? "default" : "pointer",
                      fontSize: 12,
                      fontWeight: 600,
                    }}
                  >
                    {reconEntryEdit.saving ? "Converting…" : "Move to Standalone CO"}
                  </button>
                </div>
              )}

              {/* Return to Original Line option - shown at TOP for CO entries */}
              {isPmOrAbove && reconEntryEdit.entry?.isStandaloneChangeOrder && (
                <div
                  style={{
                    marginBottom: 8,
                    padding: 12,
                    borderRadius: 8,
                    border: "1px solid #3b82f6",
                    background: "#eff6ff",
                  }}
                >
                  <div style={{ fontSize: 12, fontWeight: 600, color: "#1e40af", marginBottom: 6 }}>
                    This is a Standalone Change Order
                    <span style={{ marginLeft: 8, fontWeight: 400, color: "#6b7280" }}>
                      ({reconEntryEdit.entry.originLineNo ?? "?"}-CO{reconEntryEdit.entry.coSequenceNo ?? "?"})
                    </span>
                  </div>
                  <div style={{ fontSize: 11, color: "#1e3a8a", marginBottom: 8 }}>
                    This entry was converted from the original POL line item. You can return it to the original
                    line if this was done in error.
                  </div>
                  <button
                    type="button"
                    disabled={reconEntryEdit.saving}
                    onClick={async () => {
                      if (!project || !reconEntryEdit) return;
                      const token = localStorage.getItem("accessToken");
                      if (!token) {
                        alert("Missing access token.");
                        return;
                      }
                      if (!window.confirm("Return this entry to the original POL line item? It will no longer be a standalone Change Order.")) {
                        return;
                      }
                      setReconEntryEdit((prev) => (prev ? { ...prev, saving: true } : prev));
                      try {
                        const res = await fetch(
                          `${API_BASE}/projects/${project.id}/petl-reconciliation/entries/${reconEntryEdit.entry.id}/revert-from-co`,
                          {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                              Authorization: `Bearer ${token}`,
                            },
                            body: JSON.stringify({}),
                          },
                        );
                        if (!res.ok) {
                          const text = await res.text().catch(() => "");
                          alert(`Failed to revert from CO (${res.status}) ${text}`);
                          return;
                        }
                        showPetlToast("Returned to original POL line item");
                        closeReconEntryEdit();
                        setPetlReloadTick((t) => t + 1);
                        if (petlReconPanel.sowItemId) {
                          await loadPetlReconciliation(petlReconPanel.sowItemId);
                        }
                      } catch (err: any) {
                        alert(err?.message ?? "Failed to revert from Change Order.");
                      } finally {
                        setReconEntryEdit((prev) => (prev ? { ...prev, saving: false } : prev));
                      }
                    }}
                    style={{
                      padding: "6px 12px",
                      borderRadius: 8,
                      border: "1px solid #2563eb",
                      background: "#dbeafe",
                      color: "#1e40af",
                      cursor: reconEntryEdit.saving ? "default" : "pointer",
                      fontSize: 12,
                      fontWeight: 600,
                    }}
                  >
                    {reconEntryEdit.saving ? "Reverting…" : "Return to Original Line"}
                  </button>
                </div>
              )}

              <div style={{ marginBottom: 8 }}>
                <button
                  type="button"
                  onClick={() => setReconEditCostBookOpen(true)}
                  style={{
                    width: "100%",
                    padding: "10px 12px",
                    borderRadius: 10,
                    border: "1px solid #2563eb",
                    background: "#eff6ff",
                    cursor: "pointer",
                    fontSize: 13,
                    fontWeight: 700,
                    fontVariant: "small-caps",
                    letterSpacing: 0.5,
                    textAlign: "center",
                    color: "#1d4ed8",
                  }}
                >
                  Use Cost Book Fields
                </button>
              </div>

              {/* Kind Selector (Credit/Add/etc.) */}
              <div>
                <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>Type</div>
                <select
                  value={reconEntryEdit.draft.kind}
                  onChange={(e) => {
                    const v = e.target.value;
                    setReconEntryEdit((prev) =>
                      prev ? { ...prev, draft: { ...prev.draft, kind: v } } : prev,
                    );
                  }}
                  style={{
                    padding: "6px 8px",
                    borderRadius: 8,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                    width: "100%",
                  }}
                >
                  <option value="ADD">Add - Additional work (increases total)</option>
                  <option value="CREDIT">Credit - Client refund (reduces total)</option>
                  <option value="CHANGE_ORDER_CLIENT_PAY">Change Order - Client pays extra</option>
                  <option value="REIMBURSE_OWNER">Reimburse - Return to owner</option>
                  <option value="NOTE_ONLY">Note Only - No financial impact</option>
                </select>
                <div style={{ fontSize: 10, color: "#6b7280", marginTop: 2 }}>
                  {reconEntryEdit.draft.kind === "CREDIT" && "⚠️ Credit will reduce the line total (use for client refunds)"}
                  {reconEntryEdit.draft.kind === "ADD" && "✓ Will add to the line total"}
                  {reconEntryEdit.draft.kind === "CHANGE_ORDER_CLIENT_PAY" && "💰 Client pays this amount separately"}
                  {reconEntryEdit.draft.kind === "NOTE_ONLY" && "📝 No financial impact - documentation only"}
                  {!reconEntryEdit.draft.kind && "Select the entry type"}
                </div>
              </div>

              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>Status</div>
                  {(() => {
                    const rawStatus = String(reconEntryEdit.entry?.status ?? "")
                      .trim()
                      .toUpperCase();
                    const statusLabel =
                      rawStatus === "APPROVED"
                        ? "Approved"
                        : rawStatus === "REJECTED"
                          ? "Rejected"
                          : "Needs approval";
                    const statusColor =
                      rawStatus === "APPROVED"
                        ? "#059669"
                        : rawStatus === "REJECTED"
                          ? "#dc2626"
                          : "#d97706";
                    return (
                      <div
                        style={{
                          padding: "6px 8px",
                          borderRadius: 8,
                          border: "1px solid #d1d5db",
                          fontSize: 12,
                          background: "#f9fafb",
                          color: statusColor,
                          fontWeight: 600,
                        }}
                      >
                        {statusLabel}
                      </div>
                    );
                  })()}
                </div>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>% Complete</div>
                  <select
                    value={reconEntryEdit.draft.percentComplete}
                    onChange={(e) => {
                      const v = e.target.value;
                      setReconEntryEdit((prev) =>
                        prev ? { ...prev, draft: { ...prev.draft, percentComplete: v } } : prev,
                      );
                    }}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 8,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                      width: "100%",
                    }}
                  >
                    <option value="0">0%</option>
                    <option value="10">10%</option>
                    <option value="20">20%</option>
                    <option value="30">30%</option>
                    <option value="40">40%</option>
                    <option value="50">50%</option>
                    <option value="60">60%</option>
                    <option value="70">70%</option>
                    <option value="80">80%</option>
                    <option value="90">90%</option>
                    <option value="100">100%</option>
                  </select>
                  <div style={{ fontSize: 10, color: "#6b7280", marginTop: 2 }}>
                    Supplements &amp; COs default to 100% (paid in advance)
                  </div>
                </div>
              </div>

              {/* Transaction Type - Read-only display (set from workflow) */}
              <div>
                <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>Transaction Type</div>
                {(() => {
                  const tag = reconEntryEdit.draft.tag;
                  const isStandalone = reconEntryEdit.entry?.isStandaloneChangeOrder;
                  const tagLabel = tag === "SUPPLEMENT" 
                    ? "Supplement" 
                    : tag === "CHANGE_ORDER" 
                      ? isStandalone ? "Change Order (Standalone)" : "Change Order (Attached)"
                      : tag === "OTHER" 
                        ? "Other"
                        : tag === "WARRANTY"
                          ? "Warranty"
                          : "Not set";
                  const tagBg = tag === "SUPPLEMENT" 
                    ? "#eff6ff" 
                    : tag === "CHANGE_ORDER" 
                      ? "#f5f3ff"
                      : "#f9fafb";
                  const tagColor = tag === "SUPPLEMENT" 
                    ? "#1d4ed8" 
                    : tag === "CHANGE_ORDER" 
                      ? "#6d28d9"
                      : "#6b7280";
                  const tagIcon = tag === "SUPPLEMENT" 
                    ? "📊" 
                    : tag === "CHANGE_ORDER" 
                      ? "📝"
                      : "";
                  return (
                    <div
                      style={{
                        padding: "8px 10px",
                        borderRadius: 8,
                        border: "1px solid #e5e7eb",
                        fontSize: 12,
                        fontWeight: 600,
                        background: tagBg,
                        color: tagColor,
                      }}
                    >
                      {tagIcon} {tagLabel}
                    </div>
                  );
                })()}
                <div style={{ fontSize: 10, color: "#6b7280", marginTop: 4 }}>
                  {reconEntryEdit.draft.tag === "SUPPLEMENT" && "Carrier-visible • Attached to parent line"}
                  {reconEntryEdit.draft.tag === "CHANGE_ORDER" && "Client-only • Not visible to carrier"}
                  {!reconEntryEdit.draft.tag && "Transaction type set from reconciliation workflow"}
                </div>
              </div>

              {/* Activity Selector */}
              <div>
                <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>
                  Activity <span style={{ color: "#dc2626" }}>*</span>
                </div>
                <select
                  value={reconEntryEdit.draft.activity || ""}
                  onChange={(e) => {
                    const v = e.target.value;
                    setReconEntryEdit((prev) => {
                      if (!prev) return prev;
                      const newDraft = { ...prev.draft, activity: v };

                      // Auto-calculate item amount based on activity when cost components exist
                      const workersWage = parseReconNumber(newDraft.workersWage || "");
                      const laborBurden = parseReconNumber(newDraft.laborBurden || "");
                      const laborOverhead = parseReconNumber(newDraft.laborOverhead || "");
                      const materialCost = parseReconNumber(newDraft.materialCost || "");
                      const equipmentCost = parseReconNumber(newDraft.equipmentCost || "");

                      const hasComponents = workersWage || laborBurden || laborOverhead || materialCost || equipmentCost;

                      if (hasComponents && v) {
                        const laborTotal = workersWage + laborBurden + laborOverhead;
                        let derivedTotal = 0;

                        switch (v) {
                          case "REMOVE_AND_REPLACE":
                            derivedTotal = laborTotal + materialCost + equipmentCost;
                            break;
                          case "REMOVE":
                          case "DETACH_AND_RESET":
                            derivedTotal = laborTotal;
                            break;
                          case "REPLACE":
                          case "INSTALL_ONLY":
                            derivedTotal = laborTotal + equipmentCost;
                            break;
                          case "MATERIALS":
                            derivedTotal = materialCost;
                            break;
                          case "REPAIR":
                            derivedTotal = laborTotal + materialCost;
                            break;
                          default:
                            derivedTotal = laborTotal + materialCost + equipmentCost;
                        }

                        if (derivedTotal > 0) {
                          const qty = parseReconNumber(newDraft.qty || "") || 1;
                          newDraft.unitCost = String(derivedTotal / qty);
                          newDraft.itemAmount = String(derivedTotal);

                          // Auto-update RCV if not manually edited
                          if (!prev.rcvManuallyEdited) {
                            const tax = parseReconNumber(newDraft.salesTaxAmount || "");
                            const op = parseReconNumber(newDraft.opAmount || "");
                            newDraft.rcvAmount = String(derivedTotal + tax + op);
                          }
                        }
                      }

                      return { ...prev, draft: newDraft };
                    });
                  }}
                  style={{
                    padding: "6px 8px",
                    borderRadius: 8,
                    border: reconEntryEdit.draft.activity ? "1px solid #d1d5db" : "2px solid #dc2626",
                    fontSize: 12,
                    width: "100%",
                    backgroundColor: reconEntryEdit.draft.activity ? "#ffffff" : "#fef2f2",
                  }}
                >
                  <option value="">— Select activity (required) —</option>
                  <option value="REMOVE_AND_REPLACE">& R&R (Remove & Replace)</option>
                  <option value="REMOVE">- Remove</option>
                  <option value="REPLACE">+ Replace</option>
                  <option value="DETACH_AND_RESET">R D&R (Detach & Reset)</option>
                  <option value="MATERIALS">M Materials Only</option>
                  <option value="REPAIR">F Repair</option>
                  <option value="INSTALL_ONLY">I Install Only</option>
                </select>
                <div style={{ fontSize: 10, color: reconEntryEdit.draft.activity ? "#6b7280" : "#dc2626", marginTop: 2 }}>
                  {reconEntryEdit.draft.activity 
                    ? "Controls which cost components contribute to the line total"
                    : "⚠️ Activity is required to identify the scope of work"}
                </div>
              </div>

              {/* Xactimate-style Cost Breakdown Panel */}
              <div
                style={{
                  padding: 12,
                  borderRadius: 8,
                  border: "1px solid #c7d2fe",
                  background: "#eef2ff",
                }}
              >
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                  <div style={{ fontSize: 12, fontWeight: 600, color: "#4338ca" }}>
                    Xactimate Cost Breakdown
                  </div>
                  <button
                    type="button"
                    disabled={reconEntryEdit.saving}
                    onClick={async () => {
                      if (!project || !reconEntryEdit) return;
                      const token = localStorage.getItem("accessToken");
                      if (!token) return;

                      // Get CAT/SEL from entry or parent
                      const cat = reconEntryEdit.entry?.categoryCode ||
                        petlReconPanel.data?.sowItem?.categoryCode || null;
                      const sel = reconEntryEdit.entry?.selectionCode ||
                        petlReconPanel.data?.sowItem?.selectionCode || null;

                      if (!cat && !sel) {
                        alert("No CAT or SEL code available to lookup.");
                        return;
                      }

                      try {
                        const params = new URLSearchParams();
                        if (cat) params.set("cat", cat);
                        if (sel) params.set("sel", sel);

                        const res = await fetch(
                          `${API_BASE}/projects/${project.id}/cost-lookup/cat-sel?${params.toString()}`,
                          {
                            headers: { Authorization: `Bearer ${token}` },
                          },
                        );

                        if (!res.ok) {
                          alert("Failed to lookup cost data.");
                          return;
                        }

                        const data = await res.json();
                        if (!data.found || !data.suggested) {
                          alert(`No historical PETL data found for CAT=${cat ?? "*"} SEL=${sel ?? "*"}`);
                          return;
                        }

                        // Populate cost fields from lookup and recalculate
                        let calculationSummary = "";
                        setReconEntryEdit((prev) => {
                          if (!prev) return prev;
                          const newDraft = { ...prev.draft };

                          // Always populate the cost component fields from lookup
                          if (data.suggested.workersWage != null) {
                            newDraft.workersWage = String(data.suggested.workersWage);
                          }
                          if (data.suggested.laborBurden != null) {
                            newDraft.laborBurden = String(data.suggested.laborBurden);
                          }
                          if (data.suggested.laborOverhead != null) {
                            newDraft.laborOverhead = String(data.suggested.laborOverhead);
                          }
                          if (data.suggested.material != null) {
                            newDraft.materialCost = String(data.suggested.material);
                          }
                          if (data.suggested.equipment != null) {
                            newDraft.equipmentCost = String(data.suggested.equipment);
                          }

                          // Parse all cost components for calculation
                          const workersWage = parseReconNumber(newDraft.workersWage || "");
                          const laborBurden = parseReconNumber(newDraft.laborBurden || "");
                          const laborOverhead = parseReconNumber(newDraft.laborOverhead || "");
                          const materialCost = parseReconNumber(newDraft.materialCost || "");
                          const equipmentCost = parseReconNumber(newDraft.equipmentCost || "");
                          const laborTotal = workersWage + laborBurden + laborOverhead;

                          // Get the current activity from state
                          const activity = newDraft.activity;

                          // If no activity is selected, prompt user to select one
                          if (!activity) {
                            calculationSummary = `Cost components loaded. Select an Activity to calculate the line total. (Labor: $${laborTotal.toFixed(2)}, Material: $${materialCost.toFixed(2)}, Equipment: $${equipmentCost.toFixed(2)})`;
                            return { ...prev, draft: newDraft };
                          }

                          // Calculate based on activity
                          let derivedTotal = 0;
                          let formula = "";
                          switch (activity) {
                            case "REMOVE_AND_REPLACE":
                              derivedTotal = laborTotal + materialCost + equipmentCost;
                              formula = `Labor ($${laborTotal.toFixed(2)}) + Material ($${materialCost.toFixed(2)}) + Equipment ($${equipmentCost.toFixed(2)})`;
                              break;
                            case "REMOVE":
                            case "DETACH_AND_RESET":
                              derivedTotal = laborTotal;
                              formula = `Labor only ($${laborTotal.toFixed(2)})`;
                              break;
                            case "REPLACE":
                            case "INSTALL_ONLY":
                              derivedTotal = laborTotal + equipmentCost;
                              formula = `Labor ($${laborTotal.toFixed(2)}) + Equipment ($${equipmentCost.toFixed(2)}) [no material]`;
                              break;
                            case "MATERIALS":
                              derivedTotal = materialCost;
                              formula = `Material only ($${materialCost.toFixed(2)})`;
                              break;
                            case "REPAIR":
                              derivedTotal = laborTotal + materialCost;
                              formula = `Labor ($${laborTotal.toFixed(2)}) + Material ($${materialCost.toFixed(2)}) [no equipment]`;
                              break;
                            default:
                              derivedTotal = laborTotal + materialCost + equipmentCost;
                              formula = `Full R&R: Labor + Material + Equipment`;
                          }

                          const qty = parseReconNumber(newDraft.qty || "") || 1;

                          if (derivedTotal > 0) {
                            newDraft.unitCost = String((derivedTotal / qty).toFixed(2));
                            newDraft.itemAmount = String(derivedTotal.toFixed(2));

                            if (!prev.rcvManuallyEdited) {
                              const tax = parseReconNumber(newDraft.salesTaxAmount || "");
                              const op = parseReconNumber(newDraft.opAmount || "");
                              newDraft.rcvAmount = String((derivedTotal + tax + op).toFixed(2));
                            }
                          }

                          const activityLabel = {
                            "REMOVE_AND_REPLACE": "R&R",
                            "REMOVE": "Remove",
                            "REPLACE": "Replace",
                            "DETACH_AND_RESET": "D&R",
                            "MATERIALS": "Materials",
                            "REPAIR": "Repair",
                            "INSTALL_ONLY": "Install Only",
                          }[activity] || activity;

                          calculationSummary = `${activityLabel}: ${formula} = $${derivedTotal.toFixed(2)} (Qty ${qty} → Unit $${(derivedTotal / qty).toFixed(2)})`;

                          return { ...prev, draft: newDraft };
                        });

                        const sourceInfo = data.suggested.source?.projectName
                          ? ` (from ${data.suggested.source.projectName})`
                          : "";
                        // Show detailed calculation result
                        if (calculationSummary) {
                          showPetlToast(calculationSummary);
                        } else {
                          showPetlToast(`Loaded cost data from ${data.totalMatches} historical matches${sourceInfo}`);
                        }
                      } catch (err: any) {
                        alert(err?.message ?? "Failed to lookup cost data.");
                      }
                    }}
                    style={{
                      padding: "4px 8px",
                      borderRadius: 6,
                      border: "1px solid #6366f1",
                      background: "#ffffff",
                      color: "#4f46e5",
                      fontSize: 10,
                      fontWeight: 600,
                      cursor: reconEntryEdit.saving ? "default" : "pointer",
                    }}
                  >
                    Lookup from PETL History
                  </button>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8 }}>
                  <div>
                    <div style={{ fontSize: 11, fontWeight: 500, marginBottom: 2, color: "#4b5563" }}>Worker's Wage</div>
                    <input
                      value={reconEntryEdit.draft.workersWage || ""}
                      onChange={(e) => updateReconCostComponent("workersWage", e.target.value)}
                      placeholder="0.00"
                      style={{
                        padding: "5px 7px",
                        borderRadius: 6,
                        border: "1px solid #a5b4fc",
                        fontSize: 12,
                        width: "100%",
                        background: "#ffffff",
                      }}
                    />
                  </div>
                  <div>
                    <div style={{ fontSize: 11, fontWeight: 500, marginBottom: 2, color: "#4b5563" }}>Labor Burden</div>
                    <input
                      value={reconEntryEdit.draft.laborBurden || ""}
                      onChange={(e) => updateReconCostComponent("laborBurden", e.target.value)}
                      placeholder="0.00"
                      style={{
                        padding: "5px 7px",
                        borderRadius: 6,
                        border: "1px solid #a5b4fc",
                        fontSize: 12,
                        width: "100%",
                        background: "#ffffff",
                      }}
                    />
                  </div>
                  <div>
                    <div style={{ fontSize: 11, fontWeight: 500, marginBottom: 2, color: "#4b5563" }}>Labor Overhead</div>
                    <input
                      value={reconEntryEdit.draft.laborOverhead || ""}
                      onChange={(e) => updateReconCostComponent("laborOverhead", e.target.value)}
                      placeholder="0.00"
                      style={{
                        padding: "5px 7px",
                        borderRadius: 6,
                        border: "1px solid #a5b4fc",
                        fontSize: 12,
                        width: "100%",
                        background: "#ffffff",
                      }}
                    />
                  </div>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginTop: 8 }}>
                  <div>
                    <div style={{ fontSize: 11, fontWeight: 500, marginBottom: 2, color: "#4b5563" }}>Material</div>
                    <input
                      value={reconEntryEdit.draft.materialCost || ""}
                      onChange={(e) => updateReconCostComponent("materialCost", e.target.value)}
                      placeholder="0.00"
                      style={{
                        padding: "5px 7px",
                        borderRadius: 6,
                        border: "1px solid #a5b4fc",
                        fontSize: 12,
                        width: "100%",
                        background: "#ffffff",
                      }}
                    />
                  </div>
                  <div>
                    <div style={{ fontSize: 11, fontWeight: 500, marginBottom: 2, color: "#4b5563" }}>Equipment</div>
                    <input
                      value={reconEntryEdit.draft.equipmentCost || ""}
                      onChange={(e) => updateReconCostComponent("equipmentCost", e.target.value)}
                      placeholder="0.00"
                      style={{
                        padding: "5px 7px",
                        borderRadius: 6,
                        border: "1px solid #a5b4fc",
                        fontSize: 12,
                        width: "100%",
                        background: "#ffffff",
                      }}
                    />
                  </div>
                </div>
                {/* Activity-based calculation summary */}
                {reconEntryEdit.draft.activity && (() => {
                  const workersWage = parseReconNumber(reconEntryEdit.draft.workersWage || "");
                  const laborBurden = parseReconNumber(reconEntryEdit.draft.laborBurden || "");
                  const laborOverhead = parseReconNumber(reconEntryEdit.draft.laborOverhead || "");
                  const materialCost = parseReconNumber(reconEntryEdit.draft.materialCost || "");
                  const equipmentCost = parseReconNumber(reconEntryEdit.draft.equipmentCost || "");
                  const laborTotal = workersWage + laborBurden + laborOverhead;

                  let includedParts: string[] = [];
                  let derivedTotal = 0;

                  switch (reconEntryEdit.draft.activity) {
                    case "REMOVE_AND_REPLACE":
                      if (laborTotal) includedParts.push(`Labor $${laborTotal.toFixed(2)}`);
                      if (materialCost) includedParts.push(`Material $${materialCost.toFixed(2)}`);
                      if (equipmentCost) includedParts.push(`Equipment $${equipmentCost.toFixed(2)}`);
                      derivedTotal = laborTotal + materialCost + equipmentCost;
                      break;
                    case "REMOVE":
                    case "DETACH_AND_RESET":
                      if (laborTotal) includedParts.push(`Labor $${laborTotal.toFixed(2)}`);
                      derivedTotal = laborTotal;
                      break;
                    case "REPLACE":
                      if (laborTotal) includedParts.push(`Labor $${laborTotal.toFixed(2)}`);
                      if (equipmentCost) includedParts.push(`Equipment $${equipmentCost.toFixed(2)}`);
                      derivedTotal = laborTotal + equipmentCost;
                      break;
                    case "MATERIALS":
                      if (materialCost) includedParts.push(`Material $${materialCost.toFixed(2)}`);
                      derivedTotal = materialCost;
                      break;
                  }

                  if (includedParts.length === 0) return null;

                  return (
                    <div style={{ marginTop: 8, paddingTop: 8, borderTop: "1px solid #c7d2fe" }}>
                      <div style={{ fontSize: 11, color: "#4338ca", fontWeight: 500 }}>
                        {reconEntryEdit.draft.activity === "REMOVE_AND_REPLACE" && "R&R"}
                        {reconEntryEdit.draft.activity === "REMOVE" && "Remove"}
                        {reconEntryEdit.draft.activity === "REPLACE" && "Replace"}
                        {reconEntryEdit.draft.activity === "DETACH_AND_RESET" && "D&R"}
                        {reconEntryEdit.draft.activity === "MATERIALS" && "Materials"}
                        {" includes: "}
                        {includedParts.join(" + ")}
                        {" = "}
                        <span style={{ fontWeight: 700 }}>${derivedTotal.toFixed(2)}</span>
                      </div>
                    </div>
                  );
                })()}
              </div>

              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>Qty</div>
                  <input
                    value={reconEntryEdit.draft.qty}
                    onChange={(e) => updateReconFinancialField("qty", e.target.value)}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 8,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                      width: "100%",
                    }}
                  />
                </div>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>Unit</div>
                  <input
                    value={reconEntryEdit.draft.unit}
                    onChange={(e) => {
                      const v = e.target.value;
                      setReconEntryEdit((prev) =>
                        prev ? { ...prev, draft: { ...prev.draft, unit: v } } : prev,
                      );
                    }}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 8,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                      width: "100%",
                    }}
                  />
                </div>
              </div>

              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 2 }}>Unit cost</div>
                  <div style={{ fontSize: 10, color: "#6b7280", marginBottom: 4 }}>Price contractor pays for 1 unit</div>
                  <input
                    value={reconEntryEdit.draft.unitCost}
                    onChange={(e) => updateReconFinancialField("unitCost", e.target.value)}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 8,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                      width: "100%",
                    }}
                  />
                </div>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 2 }}>Item amount</div>
                  <div style={{ fontSize: 10, color: "#6b7280", marginBottom: 4 }}>Qty × Unit cost</div>
                  <input
                    value={reconEntryEdit.draft.itemAmount}
                    onChange={(e) => updateReconFinancialField("itemAmount", e.target.value)}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 8,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                      width: "100%",
                    }}
                  />
                </div>
              </div>

              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>Tax</div>
                  <input
                    value={reconEntryEdit.draft.salesTaxAmount}
                    onChange={(e) => updateReconFinancialField("salesTaxAmount", e.target.value)}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 8,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                      width: "100%",
                    }}
                  />
                </div>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>O&P / Other</div>
                  <input
                    value={reconEntryEdit.draft.opAmount}
                    onChange={(e) => updateReconFinancialField("opAmount", e.target.value)}
                    style={{
                      padding: "6px 8px",
                      borderRadius: 8,
                      border: "1px solid #d1d5db",
                      fontSize: 12,
                      width: "100%",
                    }}
                  />
                </div>
              </div>

              <div style={{ marginTop: 4, fontSize: 11, color: "#6b7280" }}>
                Tax and O&P are already reflected in the RCV amount. Only add additional cost items here
                under O&P / Other.
              </div>

              <div>
                <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 2 }}>
                  RCV
                  {!reconEntryEdit.rcvManuallyEdited && reconEntryEdit.draft.rcvAmount && (
                    <span style={{ fontWeight: 400, marginLeft: 6, color: "#6b7280", fontStyle: "italic" }}>
                      (calculated)
                    </span>
                  )}
                </div>
                <div style={{ fontSize: 10, color: "#6b7280", marginBottom: 4 }}>Item amount + Tax + O&P/Other</div>
                <input
                  value={reconEntryEdit.draft.rcvAmount}
                  onChange={(e) => {
                    const v = e.target.value;
                    // If user clears RCV, re-enable auto-calc; otherwise mark as manually edited
                    const nowManual = v.trim() !== "";
                    setReconEntryEdit((prev) =>
                      prev
                        ? {
                            ...prev,
                            draft: { ...prev.draft, rcvAmount: v },
                            rcvManuallyEdited: nowManual,
                          }
                        : prev,
                    );
                  }}
                  placeholder="(blank for note-only)"
                  style={{
                    padding: "6px 8px",
                    borderRadius: 8,
                    border: reconEntryEdit.rcvManuallyEdited ? "1px solid #d1d5db" : "1px solid #93c5fd",
                    fontSize: 12,
                    width: "100%",
                    backgroundColor: reconEntryEdit.rcvManuallyEdited ? "#ffffff" : "#eff6ff",
                  }}
                />
                <div style={{ marginTop: 4, fontSize: 11, color: "#6b7280" }}>
                  {reconEntryEdit.rcvManuallyEdited
                    ? "For CREDIT entries, keep this negative; for ADD entries, keep it positive."
                    : "Auto-calculated from Item + Tax + O\u0026P. Type a value to override."}
                </div>
                {!reconEntryEdit.draft.rcvAmount.trim() && (
                  <div
                    style={{
                      marginTop: 8,
                      padding: "8px 10px",
                      borderRadius: 6,
                      backgroundColor: "#fef3c7",
                      border: "1px solid #f59e0b",
                      fontSize: 11,
                      color: "#92400e",
                    }}
                  >
                    <strong>Missing RCV</strong> — Fill in Qty + Unit cost (or Item amount) to calculate RCV.
                    You can still save this entry as a draft.
                  </div>
                )}
              </div>

              <div>
                <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>Description</div>
                <input
                  value={reconEntryEdit.draft.description}
                  onChange={(e) => {
                    const v = e.target.value;
                    setReconEntryEdit((prev) =>
                      prev ? { ...prev, draft: { ...prev.draft, description: v } } : prev,
                    );
                  }}
                  style={{
                    padding: "6px 8px",
                    borderRadius: 8,
                    border: "1px solid #d1d5db",
                    fontSize: 12,
                    width: "100%",
                  }}
                />
              </div>

              <div>
                <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>Note</div>
                <textarea
                  value={reconEntryEdit.draft.note}
                  onChange={(e) => {
                    const v = e.target.value;
                    setReconEntryEdit((prev) =>
                      prev ? { ...prev, draft: { ...prev.draft, note: v } } : prev,
                    );
                  }}
                  style={{
                    width: "100%",
                    minHeight: 90,
                    padding: 8,
                    border: "1px solid #d1d5db",
                    borderRadius: 8,
                    fontSize: 12,
                  }}
                />
              </div>

              <div>
                <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 4 }}>
                  Verification attachments
                </div>
                <input
                  ref={reconFileUploadInputRef}
                  type="file"
                  style={{ display: "none" }}
                  onChange={async (e) => {
                    if (!project || !reconEntryEdit) return;
                    const files = e.target.files;
                    if (!files || files.length === 0) return;
                    const file = files[0];
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      alert("Missing access token; please log in again.");
                      e.target.value = "";
                      return;
                    }

                    try {
                      setReconAttachmentUploading(true);

                      // Step 1: get signed upload URL for this project file
                      const metaRes = await fetch(
                        `${API_BASE}/projects/${project.id}/files/upload-url`,
                        {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({
                            contentType: file.type || "application/octet-stream",
                            fileName: file.name || "attachment",
                          }),
                        },
                      );

                      if (!metaRes.ok) {
                        const text = await metaRes.text().catch(() => "");
                        alert(`Failed to prepare upload (${metaRes.status}) ${text}`);
                        return;
                      }

                      const meta: any = await metaRes.json().catch(() => ({}));
                      const uploadUrl = meta?.uploadUrl as string | undefined;
                      const fileUri = meta?.fileUri as string | undefined;
                      if (!uploadUrl || !fileUri) {
                        alert("Upload metadata was incomplete.");
                        return;
                      }

                      // Step 2: upload binary to storage
                      const putRes = await fetch(uploadUrl, {
                        method: "PUT",
                        headers: {
                          "Content-Type": file.type || "application/octet-stream",
                        },
                        body: file,
                      });

                      if (!putRes.ok) {
                        const text = await putRes.text().catch(() => "");
                        alert(`Failed to upload file (${putRes.status}) ${text}`);
                        return;
                      }

                      // Step 3: compute content hash and register as ProjectFile
                      const contentHash = await computeFileHash(file);
                      const registerRes = await fetch(
                        `${API_BASE}/projects/${project.id}/files`,
                        {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({
                            fileUri,
                            fileName: file.name || "attachment",
                            mimeType: file.type || undefined,
                            sizeBytes: typeof file.size === "number" ? file.size : undefined,
                            contentHash,
                          }),
                        },
                      );

                      if (!registerRes.ok) {
                        const text = await registerRes.text().catch(() => "");
                        alert(`Failed to register project file (${registerRes.status}) ${text}`);
                        return;
                      }

                      const projectFile: any = await registerRes.json();

                      // Step 4: attach to reconciliation entry
                      const entryId = reconEntryEdit.entry.id as string;
                      const attachRes = await fetch(
                        `${API_BASE}/projects/${project.id}/petl-reconciliation/entries/${entryId}/attachments`,
                        {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                          },
                          body: JSON.stringify({ projectFileId: projectFile.id }),
                        },
                      );

                      if (!attachRes.ok) {
                        const text = await attachRes.text().catch(() => "");
                        alert(`Failed to attach file (${attachRes.status}) ${text}`);
                        return;
                      }

                      const attachment: any = await attachRes.json();

                      // Update local editor state
                      setReconEntryEdit((prev) => {
                        if (!prev) return prev;
                        const existing = Array.isArray((prev.entry as any).attachments)
                          ? (prev.entry as any).attachments
                          : [];
                        return {
                          ...prev,
                          entry: {
                            ...prev.entry,
                            attachments: [...existing, attachment],
                          },
                        };
                      });

                      // Update attachments inside the reconciliation drawer state
                      setPetlReconPanel((prev) => {
                        if (!prev.data?.reconciliationCase) return prev;
                        const currentCase = prev.data.reconciliationCase;
                        const entries = (currentCase.entries || []).map((e: any) =>
                          e.id === entryId
                            ? {
                                ...e,
                                attachments: [
                                  ...(Array.isArray(e.attachments) ? e.attachments : []),
                                  attachment,
                                ],
                              }
                            : e,
                        );

                        return {
                          ...prev,
                          data: {
                            ...prev.data,
                            reconciliationCase: {
                              ...currentCase,
                              entries,
                            },
                          },
                        };
                      });
                    } catch (err: any) {
                      alert(err?.message ?? "Failed to upload attachment");
                    } finally {
                      setReconAttachmentUploading(false);
                      e.target.value = "";
                    }
                  }}
                />
                <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                  <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                    {(() => {
                      const all = Array.isArray((reconEntryEdit.entry as any).attachments)
                        ? (reconEntryEdit.entry as any).attachments
                        : [];
                      const images = all.filter((att: any) => {
                        const mime = String(att?.mimeType || "");
                        return mime.startsWith("image/");
                      });

                      if (all.length === 0) {
                        return (
                          <span style={{ fontSize: 11, color: "#9ca3af" }}>
                            No attachments yet.
                          </span>
                        );
                      }

                      return all.map((att: any, idx: number) => {
                        const url = String(att.fileUrl || "");
                        const name = String(att.fileName || "Attachment");
                        const mime = String(att.mimeType || "");
                        const isImage = mime.startsWith("image/");

                        if (!url) return null;

                        if (isImage) {
                          // Index among images only, for viewer navigation.
                          const imageIndex = images.findIndex((img: any) => img.id === att.id);
                          return (
                            <button
                              key={att.id}
                              type="button"
                              onClick={() => {
                                if (imageIndex >= 0) setReconPhotoViewerIndex(imageIndex);
                              }}
                              style={{
                                display: "inline-flex",
                                flexDirection: "column",
                                alignItems: "center",
                                textDecoration: "none",
                                border: "none",
                                background: "transparent",
                                padding: 0,
                                cursor: "pointer",
                              }}
                            >
                              <img
                                src={url}
                                alt={name}
                                style={{
                                  width: 56,
                                  height: 56,
                                  objectFit: "cover",
                                  borderRadius: 4,
                                  border: "1px solid #e5e7eb",
                                }}
                              />
                              <span
                                style={{
                                  marginTop: 2,
                                  maxWidth: 80,
                                  overflow: "hidden",
                                  textOverflow: "ellipsis",
                                  whiteSpace: "nowrap",
                                  fontSize: 10,
                                  color: "#4b5563",
                                }}
                              >
                                {name}
                              </span>
                            </button>
                          );
                        }

                        return (
                          <a
                            key={att.id}
                            href={url}
                            target="_blank"
                            rel="noopener noreferrer"
                            style={{
                              fontSize: 11,
                              color: "#2563eb",
                              textDecoration: "none",
                              padding: "2px 4px",
                            }}
                          >
                            {name}
                          </a>
                        );
                      });
                    })()}
                  </div>

                  <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                    <button
                      type="button"
                      onClick={() => setReconFilePickerOpen(true)}
                      disabled={reconAttachmentUploading}
                      style={{
                        alignSelf: "flex-start",
                        padding: "4px 8px",
                        borderRadius: 6,
                        border: "1px solid #d1d5db",
                        background: reconAttachmentUploading ? "#f3f4f6" : "#ffffff",
                        cursor: reconAttachmentUploading ? "default" : "pointer",
                        fontSize: 11,
                      }}
                    >
                      Attach from project Files
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        if (reconAttachmentUploading) return;
                        reconFileUploadInputRef.current?.click();
                      }}
                      disabled={reconAttachmentUploading}
                      style={{
                        alignSelf: "flex-start",
                        padding: "4px 8px",
                        borderRadius: 6,
                        border: "1px solid #d1d5db",
                        background: reconAttachmentUploading ? "#f3f4f6" : "#ffffff",
                        cursor: reconAttachmentUploading ? "default" : "pointer",
                        fontSize: 11,
                      }}
                    >
                      {reconAttachmentUploading ? "Uploading…" : "Upload from computer"}
                    </button>
                  </div>
                </div>
              </div>

              {reconEntryEdit.error && (
                <div style={{ fontSize: 12, color: "#b91c1c" }}>{reconEntryEdit.error}</div>
              )}

              <div style={{ display: "flex", gap: 8, justifyContent: "space-between" }}>
                <div>
                  {isPmOrAbove && (
                      <button
                        type="button"
                        onClick={deleteReconEntryFromEditor}
                        disabled={reconEntryEdit.saving}
                        style={{
                          padding: "6px 10px",
                          borderRadius: 8,
                          border: "1px solid #6b7280",
                          background: "#f9fafb",
                          color: "#374151",
                          cursor: reconEntryEdit.saving ? "default" : "pointer",
                          fontSize: 12,
                        }}
                      >
                        Delete entry
                      </button>
                    )}
                </div>
                <div style={{ display: "flex", gap: 8 }}>
                  <button
                    type="button"
                    onClick={closeReconEntryEdit}
                    disabled={reconEntryEdit.saving}
                    style={{
                      padding: "6px 10px",
                      borderRadius: 8,
                      border: "1px solid #d1d5db",
                      background: "#ffffff",
                      cursor: reconEntryEdit.saving ? "default" : "pointer",
                      fontSize: 12,
                    }}
                  >
                    Cancel
                  </button>
                  <button
                    type="button"
                    onClick={saveReconEntryEdit}
                    disabled={reconEntryEdit.saving}
                    style={{
                      padding: "6px 10px",
                      borderRadius: 8,
                      border: "1px solid #0f172a",
                      background:
                        reconEntryEdit.saving || !reconEntryEdit.draft.tag ? "#e5e7eb" : "#0f172a",
                      color:
                        reconEntryEdit.saving || !reconEntryEdit.draft.tag ? "#4b5563" : "#f9fafb",
                      cursor:
                        reconEntryEdit.saving || !reconEntryEdit.draft.tag ? "default" : "pointer",
                      fontSize: 12,
                    }}
                  >
                    {reconEntryEdit.saving ? "Saving…" : "Save"}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* PETL reconciliation cost book modal - rendered outside draggable panel to fix positioning */}
      {costBookModalOpen && petlReconPanel.data && (
        <CostBookPickerModal
          title="Cost Book"
          subtitle={(() => {
            const cat = String(petlReconPanel.data?.sowItem?.categoryCode ?? "").trim();
            const sel = String(petlReconPanel.data?.sowItem?.selectionCode ?? "").trim();
            const desc = String(petlReconPanel.data?.sowItem?.description ?? "").trim();
            const head = cat || sel ? `Baseline: ${cat}${sel ? `/${sel}` : ""}` : "Baseline";
            return desc ? `${head} — ${desc}` : head;
          })()}
          defaultQty={(() => {
            const q = petlReconPanel.data?.rcvBreakdown?.qty;
            return typeof q === "number" && Number.isFinite(q) && q > 0 ? q : 1;
          })()}
          confirmLabel={petlCostBookPickerBusy ? "Adding…" : "Add selected"}
          confirmDisabled={petlCostBookPickerBusy}
          onConfirm={async (selection) => {
            if (petlCostBookPickerBusy) return;
            if (selection.length === 0) {
              alert("Select a cost book line item first.");
              return;
            }
            if (selection.length > 1) {
              alert("For PETL reconciliation, please select exactly one line item.");
              return;
            }

            const first = selection[0];
            setPetlCostBookPickerBusy(true);
            try {
              const ok = await submitAddFromCostBook(first.item.id, first.qty);
              if (ok) {
                petlTransitionOverlayLabelRef.current = "Closing cost book…";
                busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
                startPetlTransition(() => setCostBookModalOpen(false));
              }
            } finally {
              setPetlCostBookPickerBusy(false);
            }
          }}
          onClose={() => {
            if (petlCostBookPickerBusy) return;
            petlTransitionOverlayLabelRef.current = "Closing cost book…";
            busyOverlay.setMessage(petlTransitionOverlayLabelRef.current);
            startPetlTransition(() => setCostBookModalOpen(false));
          }}
        />
      )}

      {reconEntryEdit && reconEditCostBookOpen && (
        <CostBookPickerModal
          title="Cost Book"
          autoFocusDescription
          subtitle={(() => {
            const cat = String(
              reconEntryEdit.entry?.categoryCode ?? petlReconPanel.data?.sowItem?.categoryCode ?? "",
            ).trim();
            const sel = String(
              reconEntryEdit.entry?.selectionCode ?? petlReconPanel.data?.sowItem?.selectionCode ?? "",
            ).trim();
            const desc = String(
              reconEntryEdit.entry?.description ?? petlReconPanel.data?.sowItem?.description ?? "",
            ).trim();
            const head = cat || sel ? `Baseline: ${cat}${sel ? `/${sel}` : ""}` : "Baseline";
            return desc ? `${head} — ${desc}` : head;
          })()}
          noteText={String(
            reconEntryEdit.draft.note ?? reconEntryEdit.entry?.note ?? "",
          ).trim()}
          defaultQty={1}
          confirmLabel="Use selected"
          onConfirm={async (selection) => {
            if (!selection || selection.length === 0) {
              alert("Select a cost book line item first.");
              return;
            }
            if (selection.length > 1) {
              alert("Please select exactly one cost book line item.");
              return;
            }

            const first = selection[0];
            const item = first.item;
            const qty = first.qty ?? 1;

            const unitPrice =
              typeof item.unitPrice === "number"
                ? item.unitPrice
                : typeof item.lastKnownUnitPrice === "number"
                  ? item.lastKnownUnitPrice
                  : null;

            setReconEntryEdit((prev) => {
              if (!prev) return prev;
              const nextDraft = { ...prev.draft };

              nextDraft.qty = String(qty);

              if (item.unit != null) {
                nextDraft.unit = String(item.unit ?? "").trim();
              }

              if (typeof unitPrice === "number") {
                nextDraft.unitCost = String(unitPrice);
                const qtyNum = Number(String(nextDraft.qty).replace(/,/g, ""));
                if (Number.isFinite(qtyNum) && qtyNum > 0) {
                  const itemAmount = qtyNum * unitPrice;
                  nextDraft.itemAmount = String(itemAmount);
                  
                  // Auto-calculate RCV (itemAmount + tax + op)
                  // Tax and O&P may already have values or be blank
                  const tax = parseReconNumber(nextDraft.salesTaxAmount);
                  const op = parseReconNumber(nextDraft.opAmount);
                  const rcv = itemAmount + tax + op;
                  nextDraft.rcvAmount = rcv > 0 ? String(rcv) : "";
                }
              }

              if (item.description != null) {
                nextDraft.description = String(item.description ?? "").trim();
              }

              // Keep rcvManuallyEdited false so further edits continue auto-calculating
              return { ...prev, draft: nextDraft, rcvManuallyEdited: false };
            });

            setReconEditCostBookOpen(false);
            
            // Focus the tag select so user builds muscle memory for tagging
            setTimeout(() => {
              reconTagSelectRef.current?.focus();
            }, 100);
          }}
          onClose={() => setReconEditCostBookOpen(false)}
        />
      )}

      {reconEntryEdit && reconFilePickerOpen && project && (
        <div
          style={{
            position: "fixed",
            top: 80,
            right: 40,
            zIndex: 80,
          }}
        >
          <ProjectFilePicker
            projectId={project.id}
            mode="new"
            onClose={() => setReconFilePickerOpen(false)}
            onSelect={async (file: ProjectFileSummary) => {
              const token = localStorage.getItem("accessToken");
              if (!token) {
                alert("Missing access token; please log in again.");
                return;
              }

              const entryId = reconEntryEdit.entry.id as string;

              try {
                const res = await fetch(
                  `${API_BASE}/projects/${project.id}/petl-reconciliation/entries/${entryId}/attachments`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({ projectFileId: file.id }),
                  },
                );

                if (!res.ok) {
                  const text = await res.text().catch(() => "");
                  alert(`Failed to attach file (${res.status}) ${text}`);
                  return;
                }

                const attachment: any = await res.json();

                // Update local editor state
                setReconEntryEdit((prev) => {
                  if (!prev) return prev;
                  const existing = Array.isArray((prev.entry as any).attachments)
                    ? (prev.entry as any).attachments
                    : [];
                  return {
                    ...prev,
                    entry: {
                      ...prev.entry,
                      attachments: [...existing, attachment],
                    },
                  };
                });

                // Update attachments inside the reconciliation drawer state
                setPetlReconPanel((prev) => {
                  if (!prev.data?.reconciliationCase) return prev;
                  const currentCase = prev.data.reconciliationCase;
                  const entries = (currentCase.entries || []).map((e: any) =>
                    e.id === entryId
                      ? {
                          ...e,
                          attachments: [
                            ...(Array.isArray(e.attachments) ? e.attachments : []),
                            attachment,
                          ],
                        }
                      : e,
                  );

                  return {
                    ...prev,
                    data: {
                      ...prev.data,
                      reconciliationCase: {
                        ...currentCase,
                        entries,
                      },
                    },
                  };
                });

                setReconFilePickerOpen(false);
              } catch (err: any) {
                alert(err?.message ?? "Failed to attach file");
              }
            }}
          />
        </div>
      )}

      {reconEntryEdit && reconPhotoViewerIndex !== null && (() => {
        const all = Array.isArray((reconEntryEdit.entry as any).attachments)
          ? (reconEntryEdit.entry as any).attachments
          : [];
        const images = all.filter((att: any) => {
          const mime = String(att?.mimeType || "");
          return mime.startsWith("image/");
        });

        if (images.length === 0 || reconPhotoViewerIndex == null) return null;

        const safeIndex = Math.min(Math.max(reconPhotoViewerIndex, 0), images.length - 1);
        const current = images[safeIndex];

        const goPrev = () => {
          setReconPhotoViewerIndex((prev) => {
            if (prev == null || images.length === 0) return prev;
            return (prev - 1 + images.length) % images.length;
          });
        };

        const goNext = () => {
          setReconPhotoViewerIndex((prev) => {
            if (prev == null || images.length === 0) return prev;
            return (prev + 1) % images.length;
          });
        };

        const close = () => setReconPhotoViewerIndex(null);

        const url = String(current?.fileUrl || "");
        const name = String(current?.fileName || "Attachment");

        if (!url) return null;

        return (
          <div
            style={{
              position: "fixed",
              inset: 0,
              zIndex: 90,
              background: "rgba(15,23,42,0.80)",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              padding: 16,
            }}
            onClick={close}
          >
            <div
              style={{
                position: "relative",
                maxWidth: "90vw",
                maxHeight: "90vh",
                background: "#020617",
                borderRadius: 10,
                padding: 12,
                boxShadow: "0 25px 60px rgba(0,0,0,0.65)",
              }}
              onClick={(e) => e.stopPropagation()}
            >
              <div
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  marginBottom: 8,
                  color: "#e5e7eb",
                  fontSize: 12,
                }}
              >
                <div style={{ display: "flex", flexDirection: "column" }}>
                  <span style={{ fontWeight: 600 }}>{name}</span>
                  <span style={{ fontSize: 11, color: "#9ca3af" }}>
                    Photo {safeIndex + 1} of {images.length}
                  </span>
                </div>
                <button
                  type="button"
                  onClick={close}
                  style={{
                    border: "none",
                    background: "transparent",
                    cursor: "pointer",
                    color: "#e5e7eb",
                    fontSize: 18,
                    lineHeight: 1,
                  }}
                  aria-label="Close photo viewer"
                >
                  ×
                </button>
              </div>

              <div
                style={{
                  position: "relative",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  maxWidth: "100%",
                  maxHeight: "calc(90vh - 80px)",
                  overflow: "hidden",
                  background: "#020617",
                }}
              >
                <img
                  src={url}
                  alt={name}
                  style={{
                    maxWidth: "100%",
                    maxHeight: "100%",
                    objectFit: "contain",
                    borderRadius: 6,
                    border: "1px solid #1f2937",
                  }}
                />

                {images.length > 1 && (
                  <>
                    <button
                      type="button"
                      onClick={goPrev}
                      style={{
                        position: "absolute",
                        left: 8,
                        top: "50%",
                        transform: "translateY(-50%)",
                        borderRadius: 999,
                        border: "1px solid #4b5563",
                        background: "rgba(15,23,42,0.85)",
                        color: "#e5e7eb",
                        padding: "4px 8px",
                        cursor: "pointer",
                        fontSize: 12,
                      }}
                    >
                      ‹ Prev
                    </button>
                    <button
                      type="button"
                      onClick={goNext}
                      style={{
                        position: "absolute",
                        right: 8,
                        top: "50%",
                        transform: "translateY(-50%)",
                        borderRadius: 999,
                        border: "1px solid #4b5563",
                        background: "rgba(15,23,42,0.85)",
                        color: "#e5e7eb",
                        padding: "4px 8px",
                        cursor: "pointer",
                        fontSize: 12,
                      }}
                    >
                      Next ›
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      })()}

            </>
          )}

        </div>
      )}

      {/* Reconciliation Workflow Modal */}
      {reconWorkflowModal?.open && (() => {
        const item = reconWorkflowModal.sowItem;
        const existingEntry = reconWorkflowModal.existingEntry;
        const isEditing = !!existingEntry;
        
        // When editing an existing entry, show the entry's data in the header
        // Otherwise show the parent line item's data
        const itemNote = String(item?.itemNote ?? "");
        const lineNo = item?.lineNo ?? "?";
        // Always keep parent line item description available for context
        const parentDesc = String(item?.description ?? "");
        const desc = isEditing 
          ? (String(existingEntry?.description ?? "") || String(existingEntry?.note ?? ""))
          : parentDesc;
        const qty = isEditing ? existingEntry?.qty : item?.qty;
        const unit = isEditing ? (existingEntry?.unit ?? "") : (item?.unit ?? "");
        const rcv = isEditing ? (existingEntry?.rcvAmount ?? 0) : (item?.rcvAmount ?? 0);
        const parentQty = item?.qty ?? null;
        const parentUnit = item?.unit ?? "";
        const parentRcv = item?.rcvAmount ?? 0;
        
        const step = reconWorkflowModal.step;
        const useNoteAsDescription = reconWorkflowUseNote;
        const setUseNoteAsDescription = setReconWorkflowUseNote;
        const closeModal = () => setReconWorkflowModal(null);
        
        const createReconEntry = async (params: {
          tag: 'SUPPLEMENT' | 'CHANGE_ORDER';
          kind: 'ADD' | 'CREDIT';
          isStandaloneChangeOrder: boolean;
          acvPercent?: number;
          useNoteAsDescription?: boolean;
        }) => {
          const token = localStorage.getItem("accessToken");
          if (!token) {
            alert("Missing access token; please log in again.");
            return;
          }
          
          try {
            // If editing an existing entry, update it and then open full edit panel
            if (isEditing) {
              await busyOverlay.run("Updating reconciliation entry...", async () => {
                const res = await fetch(
                  `${API_BASE}/projects/${id}/petl-reconciliation/entries/${existingEntry.id}`,
                  {
                    method: "PATCH",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                      tag: params.tag,
                      kind: params.kind,
                    }),
                  }
                );
                
                if (!res.ok) {
                  const text = await res.text().catch(() => "");
                  alert(`Failed to update entry (${res.status}) ${text}`);
                  return;
                }
                
                // Close workflow modal
                closeModal();
                
                // Refresh PETL to get latest data
                setPetlReloadTick(t => t + 1);
                
                // Wait a bit for state to update, then reload reconciliation data
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (petlReconPanel.sowItemId) {
                  await loadPetlReconciliation(petlReconPanel.sowItemId);
                }
                
                // Fetch the updated entry and open edit panel
                const entryRes = await fetch(
                  `${API_BASE}/projects/${id}/petl-reconciliation/entries/${existingEntry.id}`,
                  {
                    headers: { Authorization: `Bearer ${token}` },
                  }
                );
                
                if (entryRes.ok) {
                  const updatedEntry = await entryRes.json();
                  openReconEntryEdit(updatedEntry);
                } else {
                  // Fallback: use existing entry with updated fields
                  openReconEntryEdit({
                    ...existingEntry,
                    tag: params.tag,
                    kind: params.kind,
                  });
                }
              });
            } else {
              // Creating a new entry
              await busyOverlay.run("Creating reconciliation entry...", async () => {
                // Calculate ACV if applicable
                let rcvAmount = null;
                if (params.acvPercent && item?.rcvAmount) {
                  rcvAmount = -(item.rcvAmount * (params.acvPercent / 100));
                }
                
                // If user chose to use the note, put it in description field
                const description = params.useNoteAsDescription && itemNote ? itemNote : "";
                
                const res = await fetch(
                  `${API_BASE}/projects/${id}/petl/${reconWorkflowModal.sowItemId}/reconciliation/add-manual`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                      tag: params.tag,
                      kind: params.kind,
                      isStandaloneChangeOrder: params.isStandaloneChangeOrder,
                      rcvAmount,
                      description,
                      note: "",
                    }),
                  }
                );
                
                if (!res.ok) {
                  const text = await res.text().catch(() => "");
                  alert(`Failed to create entry (${res.status}) ${text}`);
                  return;
                }
                
                const result = await res.json();
                
                // Close workflow modal
                closeModal();
                
                // Refresh PETL
                setPetlReloadTick(t => t + 1);
                
                // Open entry in edit mode (API returns { entry, reconciliationCase })
                openReconEntryEdit(result.entry ?? result);
              });
            }
          } catch (err: any) {
            alert(err?.message ?? isEditing ? "Failed to update reconciliation entry" : "Failed to create reconciliation entry");
          }
        };
        
        return (
          <div
            style={{
              position: "fixed",
              inset: 0,
              zIndex: 70,
              background: "rgba(15,23,42,0.65)",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              padding: 20,
            }}
            onClick={closeModal}
          >
            <div
              style={{
                width: 600,
                maxWidth: "95vw",
                background: "#ffffff",
                borderRadius: 12,
                border: "1px solid #e5e7eb",
                boxShadow: "0 25px 60px rgba(15,23,42,0.45)",
              }}
              onClick={(e) => e.stopPropagation()}
            >
              <div
                style={{
                  padding: "14px 18px",
                  borderBottom: "1px solid #e5e7eb",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                  background: "#f8fafc",
                  borderTopLeftRadius: 12,
                  borderTopRightRadius: 12,
                }}
              >
                <div style={{ display: "flex", flexDirection: "column", gap: 2 }}>
                  <span style={{ fontSize: 14, fontWeight: 600, color: "#111827" }}>
                    Reconcile Line {lineNo}
                  </span>
                  <span style={{ fontSize: 11, color: "#6b7280" }}>
                    {desc}
                  </span>
                </div>
                <button
                  type="button"
                  onClick={closeModal}
                  style={{
                    border: "none",
                    background: "transparent",
                    cursor: "pointer",
                    fontSize: 20,
                    lineHeight: 1,
                    color: "#6b7280",
                  }}
                  aria-label="Close"
                >
                  ×
                </button>
              </div>
              
              <div style={{ padding: 20 }}>
                {step === 'selectSource' && (
                  <>
                    <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 16, color: "#374151" }}>
                      What would you like to reconcile?
                    </div>
                    
                    <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                      <button
                        type="button"
                        onClick={() => {
                          setUseNoteAsDescription(false);
                          setReconWorkflowModal(prev => prev ? { ...prev, step: 'initial' } : null);
                        }}
                        style={{
                          padding: 16,
                          borderRadius: 8,
                          border: "2px solid #2563eb",
                          background: "#eff6ff",
                          cursor: "pointer",
                          textAlign: "left",
                        }}
                      >
                        <div style={{ fontSize: 14, fontWeight: 600, color: "#1d4ed8", marginBottom: 4 }}>
                          📋 The Line Item
                        </div>
                        <div style={{ fontSize: 11, color: "#1e40af" }}>
                          {desc}
                        </div>
                        <div style={{ fontSize: 10, color: "#60a5fa", marginTop: 4 }}>
                          {qty} {unit} @ ${(rcv / (qty || 1)).toFixed(2)} = ${rcv.toFixed(2)}
                        </div>
                      </button>
                      
                      <button
                        type="button"
                        onClick={() => {
                          setUseNoteAsDescription(true);
                          setReconWorkflowModal(prev => prev ? { ...prev, step: 'initial' } : null);
                        }}
                        style={{
                          padding: 16,
                          borderRadius: 8,
                          border: "2px solid #f59e0b",
                          background: "#fef3c7",
                          cursor: "pointer",
                          textAlign: "left",
                        }}
                      >
                        <div style={{ fontSize: 14, fontWeight: 600, color: "#92400e", marginBottom: 4 }}>
                          📌 The Note
                        </div>
                        <div style={{ fontSize: 11, color: "#78350f", whiteSpace: "pre-wrap", maxHeight: 80, overflow: "auto" }}>
                          {itemNote}
                        </div>
                      </button>
                    </div>
                  </>
                )}
                
                {step === 'initial' && (
                  <>
                    {/* Always show parent line item context */}
                    <div
                      style={{
                        marginBottom: itemNote ? 12 : 20,
                        padding: 12,
                        borderRadius: 8,
                        background: "#f0f9ff",
                        border: "1px solid #bae6fd",
                      }}
                    >
                      <div style={{ fontSize: 11, fontWeight: 600, color: "#0369a1", marginBottom: 4 }}>
                        📋 Line {lineNo}: {parentDesc}
                      </div>
                      <div style={{ fontSize: 11, color: "#0c4a6e" }}>
                        {parentQty} {parentUnit} • RCV: ${parentRcv.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                      </div>
                    </div>
                    
                    {/* Show note if present */}
                    {itemNote && (
                      <div
                        style={{
                          marginBottom: 20,
                          padding: 12,
                          borderRadius: 8,
                          background: useNoteAsDescription ? "#fef3c7" : "#fefce8",
                          border: useNoteAsDescription ? "2px solid #f59e0b" : "1px solid #fde047",
                        }}
                      >
                        <div style={{ fontSize: 11, fontWeight: 600, color: "#92400e", marginBottom: 4 }}>
                          📌 Note {useNoteAsDescription ? "(selected for reconciliation)" : ""}
                        </div>
                        <div style={{ fontSize: 12, color: "#78350f", whiteSpace: "pre-wrap" }}>
                          {itemNote}
                        </div>
                      </div>
                    )}
                    
                    {/* SUPPLEMENTS Section */}
                    <div style={{ marginBottom: 20 }}>
                      <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 10, color: "#1d4ed8", display: "flex", alignItems: "center", gap: 6 }}>
                        📊 SUPPLEMENT
                        <span style={{ fontSize: 10, fontWeight: 400, color: "#6b7280" }}>Carrier-visible • Attached to line {lineNo}</span>
                      </div>
                      <div style={{ display: "flex", gap: 10 }}>
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'SUPPLEMENT', kind: 'ADD', isStandaloneChangeOrder: false, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 14,
                            borderRadius: 8,
                            border: "2px solid #2563eb",
                            background: "#eff6ff",
                            cursor: "pointer",
                            textAlign: "center",
                          }}
                        >
                          <div style={{ fontSize: 13, fontWeight: 600, color: "#1d4ed8" }}>
                            ➕ Supplement Charge
                          </div>
                          <div style={{ fontSize: 10, color: "#3b82f6", marginTop: 2 }}>
                            Add to carrier scope
                          </div>
                        </button>
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'SUPPLEMENT', kind: 'CREDIT', isStandaloneChangeOrder: false, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 14,
                            borderRadius: 8,
                            border: "2px solid #2563eb",
                            background: "#dbeafe",
                            cursor: "pointer",
                            textAlign: "center",
                          }}
                        >
                          <div style={{ fontSize: 13, fontWeight: 600, color: "#1e40af" }}>
                            ➖ Supplement Credit
                          </div>
                          <div style={{ fontSize: 10, color: "#3b82f6", marginTop: 2 }}>
                            Reduce carrier scope
                          </div>
                        </button>
                      </div>
                    </div>
                    
                    {/* CHANGE ORDERS Section */}
                    <div>
                      <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 10, color: "#7c3aed", display: "flex", alignItems: "center", gap: 6 }}>
                        📝 CHANGE ORDER
                        <span style={{ fontSize: 10, fontWeight: 400, color: "#6b7280" }}>Client transaction • Not visible to carrier</span>
                      </div>
                      <div style={{ display: "flex", gap: 10, marginBottom: 10 }}>
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'ADD', isStandaloneChangeOrder: false, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 14,
                            borderRadius: 8,
                            border: "2px solid #7c3aed",
                            background: "#f5f3ff",
                            cursor: "pointer",
                            textAlign: "center",
                          }}
                        >
                          <div style={{ fontSize: 13, fontWeight: 600, color: "#6d28d9" }}>
                            ➕ CO Charge
                          </div>
                          <div style={{ fontSize: 10, color: "#8b5cf6", marginTop: 2 }}>
                            Attached to {lineNo}
                          </div>
                        </button>
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'CREDIT', isStandaloneChangeOrder: false, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 14,
                            borderRadius: 8,
                            border: "2px solid #7c3aed",
                            background: "#ede9fe",
                            cursor: "pointer",
                            textAlign: "center",
                          }}
                        >
                          <div style={{ fontSize: 13, fontWeight: 600, color: "#5b21b6" }}>
                            ➖ CO Credit
                          </div>
                          <div style={{ fontSize: 10, color: "#8b5cf6", marginTop: 2 }}>
                            Attached to {lineNo}
                          </div>
                        </button>
                      </div>
                      
                      {/* Standalone COs - secondary row */}
                      <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 6, marginTop: 12 }}>
                        Or create a standalone CO (room-level, not attached to this line):
                      </div>
                      <div style={{ display: "flex", gap: 10 }}>
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'ADD', isStandaloneChangeOrder: true, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 10,
                            borderRadius: 6,
                            border: "1px solid #a78bfa",
                            background: "#faf5ff",
                            cursor: "pointer",
                            textAlign: "center",
                          }}
                        >
                          <div style={{ fontSize: 11, fontWeight: 500, color: "#7c3aed" }}>
                            🆕 Standalone Charge
                          </div>
                        </button>
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'CREDIT', isStandaloneChangeOrder: true, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 10,
                            borderRadius: 6,
                            border: "1px solid #a78bfa",
                            background: "#faf5ff",
                            cursor: "pointer",
                            textAlign: "center",
                          }}
                        >
                          <div style={{ fontSize: 11, fontWeight: 500, color: "#7c3aed" }}>
                            🆕 Standalone Credit
                          </div>
                        </button>
                      </div>
                    </div>
                  </>
                )}
                
                {step === 'changeOrder' && (
                  <>
                    <button
                      type="button"
                      onClick={() => setReconWorkflowModal(prev => prev ? { ...prev, step: 'initial' } : null)}
                      style={{
                        marginBottom: 16,
                        padding: "4px 8px",
                        borderRadius: 6,
                        border: "1px solid #d1d5db",
                        background: "#ffffff",
                        cursor: "pointer",
                        fontSize: 11,
                        color: "#6b7280",
                      }}
                    >
                      ← Back
                    </button>
                    
                    <div style={{ marginBottom: 16 }}>
                      <div style={{ fontSize: 14, fontWeight: 600, color: "#6d28d9", marginBottom: 4 }}>
                        Change Order
                      </div>
                      <div style={{ fontSize: 11, color: "#6b7280" }}>
                        Client transaction • Not visible to carrier
                      </div>
                    </div>
                    
                    <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 12, color: "#374151" }}>
                      Attachment & Transaction Type
                    </div>
                    
                    <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                      <div style={{ display: "flex", gap: 12 }}>
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'ADD', isStandaloneChangeOrder: false, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 14,
                            borderRadius: 8,
                            border: "2px solid #059669",
                            background: "#ecfdf5",
                            cursor: "pointer",
                          }}
                        >
                          <div style={{ fontSize: 13, fontWeight: 600, color: "#047857" }}>
                            ⚓ Attached Charge
                          </div>
                          <div style={{ fontSize: 10, color: "#065f46" }}>
                            {lineNo}-CO1
                          </div>
                        </button>
                        
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'CREDIT', isStandaloneChangeOrder: false, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 14,
                            borderRadius: 8,
                            border: "2px solid #dc2626",
                            background: "#fef2f2",
                            cursor: "pointer",
                          }}
                        >
                          <div style={{ fontSize: 13, fontWeight: 600, color: "#b91c1c" }}>
                            ⚓ Attached Credit
                          </div>
                          <div style={{ fontSize: 10, color: "#991b1b" }}>
                            {lineNo}-CO1
                          </div>
                        </button>
                      </div>
                      
                      <div style={{ display: "flex", gap: 12 }}>
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'ADD', isStandaloneChangeOrder: true, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 14,
                            borderRadius: 8,
                            border: "2px solid #059669",
                            background: "#f0fdf4",
                            cursor: "pointer",
                          }}
                        >
                          <div style={{ fontSize: 13, fontWeight: 600, color: "#047857" }}>
                            🆕 Standalone Charge
                          </div>
                          <div style={{ fontSize: 10, color: "#065f46" }}>
                            Room-level CO
                          </div>
                        </button>
                        
                        <button
                          type="button"
                          onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'CREDIT', isStandaloneChangeOrder: true, useNoteAsDescription })}
                          style={{
                            flex: 1,
                            padding: 14,
                            borderRadius: 8,
                            border: "2px solid #dc2626",
                            background: "#fef2f2",
                            cursor: "pointer",
                          }}
                        >
                          <div style={{ fontSize: 13, fontWeight: 600, color: "#b91c1c" }}>
                            🆕 Standalone Credit
                          </div>
                          <div style={{ fontSize: 10, color: "#991b1b" }}>
                            Room-level CO
                          </div>
                        </button>
                      </div>
                      
                      <button
                        type="button"
                        onClick={() => createReconEntry({ tag: 'CHANGE_ORDER', kind: 'CREDIT', isStandaloneChangeOrder: true, acvPercent: 80, useNoteAsDescription })}
                        style={{
                          padding: 14,
                          borderRadius: 8,
                          border: "2px solid #ea580c",
                          background: "#fff7ed",
                          cursor: "pointer",
                        }}
                      >
                        <div style={{ fontSize: 13, fontWeight: 600, color: "#c2410c" }}>
                          📊 ACV Credit (80%)
                        </div>
                        <div style={{ fontSize: 10, color: "#9a3412" }}>
                          Work not done • ${(rcv * 0.8).toFixed(2)} credit
                        </div>
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      })()}

      {/* PETL Diagnostics modal (opened from Edit Project) */}
      {petlDiagnosticsModalOpen && (
        <div
          style={{
            position: "fixed",
            inset: 0,
            zIndex: 60,
            background: "rgba(15,23,42,0.45)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            padding: 12,
          }}
          onClick={() => setPetlDiagnosticsModalOpen(false)}
        >
          <div
            style={{
              width: 720,
              maxWidth: "95vw",
              maxHeight: "90vh",
              overflow: "auto",
              background: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 20px 50px rgba(15,23,42,0.35)",
            }}
            onClick={e => e.stopPropagation()}
          >
            <div
              style={{
                padding: "10px 12px",
                borderBottom: "1px solid #e5e7eb",
                display: "flex",
                alignItems: "center",
                justifyContent: "space-between",
                fontSize: 13,
                fontWeight: 600,
                background: "#f3f4f6",
              }}
            >
              <span>PETL Diagnostics{petlLoadError ? " (error)" : ""}</span>
              <button
                type="button"
                onClick={() => setPetlDiagnosticsModalOpen(false)}
                style={{
                  border: "none",
                  background: "transparent",
                  cursor: "pointer",
                  fontSize: 18,
                  lineHeight: 1,
                }}
                aria-label="Close PETL diagnostics"
              >
                ×
              </button>
            </div>

            <div style={{ padding: 12 }}>
              <div
                style={{
                  padding: 10,
                  borderRadius: 8,
                  border: `1px solid ${petlLoadError ? "#b91c1c" : "#e5e7eb"}`,
                  background: petlLoadError ? "#fef2f2" : "#f8fafc",
                  fontSize: 12,
                }}
              >
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                  <div style={{ fontWeight: 600 }}>
                    PETL Diagnostics{petlLoadError ? " (error)" : ""}
                  </div>
                  <button
                    type="button"
                    onClick={() => setPetlShowDiagnostics((s) => !s)}
                    style={{
                      padding: "4px 8px",
                      borderRadius: 6,
                      border: "1px solid #d1d5db",
                      background: "#ffffff",
                      cursor: "pointer",
                      fontSize: 12,
                    }}
                  >
                    {petlShowDiagnostics ? "Hide" : "Show"}
                  </button>
                </div>

                {(petlShowDiagnostics || petlLoadError) ? (
                  <>
                    <div style={{ marginTop: 6, fontSize: 11, color: "#4b5563" }}>
                      <div>
                        <strong>API_BASE</strong>: {API_BASE}
                      </div>
                      <div>
                        <strong>Project</strong>: {id}
                      </div>
                      <div>
                        <strong>Local</strong>: petlItems={petlItems.length}, recon={petlReconciliationEntries.length}
                      </div>
                    </div>

                    {petlLoadError && (
                      <pre
                        style={{
                          marginTop: 8,
                          marginBottom: 0,
                          whiteSpace: "pre-wrap",
                          color: "#b91c1c",
                          fontSize: 11,
                        }}
                      >
                        {petlLoadError}
                      </pre>
                    )}

                    {petlShowDiagnostics && petlLastLoadDebug && (
                      <pre
                        style={{
                          marginTop: 8,
                          marginBottom: 0,
                          padding: 8,
                          borderRadius: 6,
                          background: "#ffffff",
                          border: "1px solid #e5e7eb",
                          whiteSpace: "pre-wrap",
                          fontSize: 11,
                          maxHeight: 380,
                          overflow: "auto",
                        }}
                      >
                        {JSON.stringify(petlLastLoadDebug, null, 2)}
                      </pre>
                    )}
                  </>
                ) : (
                  <div style={{ marginTop: 6, fontSize: 11, color: "#6b7280" }}>
                    Hidden (click Show)
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Edit Daily Log Modal - MOVED HERE at end of main return */}
      {editDailyLog.open && editDailyLog.draft && (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            zIndex: 99999,
            backgroundColor: "rgba(15, 23, 42, 0.6)",
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
          }}
          onClick={closeEditDailyLog}
        >
          <div
            style={{
              width: 700,
              maxWidth: "96vw",
              maxHeight: "90vh",
              overflowY: "auto",
              backgroundColor: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 16px 40px rgba(15,23,42,0.35)",
              padding: 16,
              fontSize: 13,
            }}
            onClick={e => e.stopPropagation()}
          >
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
              <div style={{ fontSize: 15, fontWeight: 600 }}>Edit Daily Log</div>
              <button type="button" onClick={closeEditDailyLog} style={{ border: "none", background: "transparent", cursor: "pointer", fontSize: 18, lineHeight: 1, padding: 4 }} aria-label="Close">×</button>
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
              <div>
                <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Type</label>
                <select
                  value={editDailyLog.draft.type}
                  onChange={async e => {
                    const newType = e.target.value as DailyLogType;
                    // Optimistically update UI
                    setEditDailyLog(prev => ({
                      ...prev,
                      draft: prev.draft ? { ...prev.draft, type: newType } : null,
                    }));
                    if (!editDailyLog.log) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) return;
                    try {
                      // For receipts, lock sharing defaults
                      const isReceipt = newType === "RECEIPT_EXPENSE";
                      const body: any = { type: newType };
                      if (isReceipt) {
                        body.shareInternal = false;
                        body.shareSubs = false;
                        body.shareClient = false;
                        body.sharePrivate = true;
                      }
                      const resp = await fetch(`${API_BASE}/daily-logs/${editDailyLog.log.id}`, {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                        body: JSON.stringify(body),
                      });
                      if (resp.ok) {
                        const updated = await resp.json();
                        // Sync UI state and list
                        setEditDailyLog(prev => ({
                          ...prev,
                          log: updated,
                          draft: prev.draft ? {
                            ...prev.draft,
                            type: updated.type,
                            shareInternal: updated.shareInternal,
                            shareSubs: updated.shareSubs,
                            shareClient: updated.shareClient,
                            sharePrivate: updated.sharePrivate,
                          } : null,
                        }));
                        setDailyLogs(prev => prev.map(l => l.id === updated.id ? updated : l));
                      }
                    } catch {}
                  }}
                  style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                >
                  <option value="PUDL">Daily Log (PUDL)</option>
                  <option value="RECEIPT_EXPENSE">Receipt / Expense</option>
                  <option value="JSA">Job Safety Assessment</option>
                  <option value="INCIDENT">Incident Report</option>
                  <option value="QUALITY">Quality Inspection</option>
                </select>
              </div>
              <div>
                <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Date</label>
                <input type="date" value={editDailyLog.draft.logDate} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, logDate: e.target.value } : null }))} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }} />
              </div>
            </div>

            <div style={{ marginBottom: 12 }}>
              <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 2 }}>
                <label style={{ fontSize: 12 }}>Subject / Title</label>
                {editDailyLog.draft.workPerformed.trim().length > 10 && !editDailyLog.draft.title.trim() && (
                  <button
                    type="button"
                    onClick={() => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, title: summarizeToTitle(prev.draft.workPerformed) } : null }))}
                    style={{
                      padding: "2px 6px",
                      borderRadius: 4,
                      border: "1px solid #d1d5db",
                      background: "#fefce8",
                      fontSize: 10,
                      cursor: "pointer",
                      display: "flex",
                      alignItems: "center",
                      gap: 3,
                    }}
                  >
                    ✨ Auto-generate
                  </button>
                )}
              </div>
              <input type="text" value={editDailyLog.draft.title} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, title: e.target.value } : null }))} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }} />
            </div>

            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Work Performed</label>
              <textarea value={editDailyLog.draft.workPerformed} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, workPerformed: e.target.value } : null }))} rows={3} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12, resize: "vertical" }} />
            </div>

            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Crew On Site</label>
              <textarea value={editDailyLog.draft.crewOnSite} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, crewOnSite: e.target.value } : null }))} rows={2} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12, resize: "vertical" }} />
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
              <div>
                <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Issues</label>
                <textarea value={editDailyLog.draft.issues} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, issues: e.target.value } : null }))} rows={2} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12, resize: "vertical" }} />
              </div>
              <div>
                <label style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 12, marginBottom: 2 }}>
                  Safety Note
                  {editDailyLog.draft.safetyIncidents && editDailyLog.draft.safetyIncidents.trim() !== "" && (
                    <span style={{ fontSize: 9, fontWeight: 600, padding: "2px 6px", borderRadius: 4, backgroundColor: "#fef2f2", color: "#b91c1c", border: "1px solid #fecaca" }}>⚠️ Safety Review</span>
                  )}
                </label>
                <textarea value={editDailyLog.draft.safetyIncidents} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, safetyIncidents: e.target.value } : null }))} rows={2} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: editDailyLog.draft.safetyIncidents && editDailyLog.draft.safetyIncidents.trim() !== "" ? "1px solid #fca5a5" : "1px solid #d1d5db", fontSize: 12, resize: "vertical", backgroundColor: editDailyLog.draft.safetyIncidents && editDailyLog.draft.safetyIncidents.trim() !== "" ? "#fef2f2" : "#ffffff" }} />
              </div>
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
              <div>
                <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Weather</label>
                <input type="text" value={editDailyLog.draft.weatherSummary} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, weatherSummary: e.target.value } : null }))} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }} />
              </div>
              <div>
                <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Person Onsite</label>
                <input type="text" value={editDailyLog.draft.personOnsite} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, personOnsite: e.target.value } : null }))} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }} />
              </div>
            </div>

            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 12, marginBottom: 2 }}>Confidential Notes (NO PRINT)</label>
              <textarea value={editDailyLog.draft.confidentialNotes} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, confidentialNotes: e.target.value } : null }))} rows={2} style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12, resize: "vertical" }} />
            </div>

            {/* Attachments Section */}
            <div style={{ marginBottom: 12, padding: 10, background: "#f8fafc", borderRadius: 6, border: "1px solid #e5e7eb" }}>
              <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 8, color: "#374151" }}>Attachments</div>
              
              {/* Existing attachments */}
              {editDailyLog.log?.attachments && editDailyLog.log.attachments.length > 0 && (
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(100px, 1fr))", gap: 8, marginBottom: 8 }}>
                  {editDailyLog.log.attachments.map(att => {
                    const url = att.fileUrl;
                    const name = att.fileName || "attachment";
                    const lower = (url || "").toLowerCase();
                    const isImage = lower.endsWith(".png") || lower.endsWith(".jpg") || lower.endsWith(".jpeg") || lower.endsWith(".gif") || lower.endsWith(".webp") || (att.mimeType || "").startsWith("image/");
                    return (
                      <div key={att.id} style={{ position: "relative", borderRadius: 4, border: "1px solid #e5e7eb", background: "#ffffff", overflow: "hidden" }}>
                        {/* Delete button */}
                        <button
                          type="button"
                          onClick={async e => {
                            e.preventDefault();
                            e.stopPropagation();
                            if (!confirm("Delete this attachment?")) return;
                            const token = localStorage.getItem("accessToken");
                            if (!token) { alert("Missing access token"); return; }
                            try {
                              const resp = await fetch(`${API_BASE}/daily-logs/${editDailyLog.log!.id}/attachments/${att.id}`, {
                                method: "DELETE",
                                headers: { Authorization: `Bearer ${token}` },
                              });
                              if (resp.ok) {
                                setEditDailyLog(prev => ({
                                  ...prev,
                                  log: prev.log ? { ...prev.log, attachments: (prev.log.attachments || []).filter(a => a.id !== att.id) } : null,
                                }));
                                setDailyLogs(prev => prev.map(l => l.id === editDailyLog.log?.id ? { ...l, attachments: (l.attachments || []).filter(a => a.id !== att.id) } : l));
                              } else {
                                alert("Failed to delete attachment");
                              }
                            } catch (err: any) {
                              alert(err?.message || "Delete failed");
                            }
                          }}
                          style={{
                            position: "absolute",
                            top: 2,
                            right: 2,
                            width: 20,
                            height: 20,
                            borderRadius: "50%",
                            border: "none",
                            background: "rgba(239, 68, 68, 0.9)",
                            color: "#ffffff",
                            fontSize: 12,
                            fontWeight: 700,
                            cursor: "pointer",
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "center",
                            lineHeight: 1,
                            zIndex: 10,
                          }}
                          title="Delete attachment"
                        >
                          ×
                        </button>
                        <a href={url} target="_blank" rel="noopener noreferrer" style={{ display: "block" }}>
                          {isImage ? (
                            <img src={url} alt={name} style={{ width: "100%", height: 70, objectFit: "cover" }} />
                          ) : (
                            <div style={{ width: "100%", height: 70, display: "flex", alignItems: "center", justifyContent: "center", backgroundColor: "#f3f4f6", fontSize: 24 }}>📄</div>
                          )}
                        </a>
                        <div style={{ padding: "4px 6px", fontSize: 10, color: "#6b7280", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{name}</div>
                      </div>
                    );
                  })}
                </div>
              )}
              
              {(!editDailyLog.log?.attachments || editDailyLog.log.attachments.length === 0) && (
                <div style={{ fontSize: 11, color: "#9ca3af", marginBottom: 8 }}>No attachments</div>
              )}
              
              {/* Drag and drop zone */}
              <div
                onDragOver={e => { e.preventDefault(); e.stopPropagation(); setEditLogDragOver(true); }}
                onDragLeave={e => { e.preventDefault(); e.stopPropagation(); setEditLogDragOver(false); }}
                onDrop={async e => {
                  e.preventDefault();
                  e.stopPropagation();
                  setEditLogDragOver(false);
                  const files = e.dataTransfer.files;
                  if (!files || files.length === 0 || !editDailyLog.log) return;
                  const token = localStorage.getItem("accessToken");
                  if (!token) {
                    alert("Missing access token; please log in again.");
                    return;
                  }
                  try {
                    setEditDailyLog(prev => ({ ...prev, saving: true }));
                    const uploaded: DailyLogAttachmentDto[] = [];
                    for (const file of Array.from(files)) {
                      if (!file.type.startsWith("image/")) continue;
                      const link = await uploadImageFileToNexusUploads(file, "JOURNAL");
                      const resp = await fetch(`${API_BASE}/daily-logs/${editDailyLog.log!.id}/attachments/link`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                        body: JSON.stringify({ fileUrl: link.url, fileName: link.label }),
                      });
                      if (resp.ok) {
                        const att: DailyLogAttachmentDto = await resp.json();
                        uploaded.push(att);
                      }
                    }
                    if (uploaded.length > 0) {
                      setEditDailyLog(prev => ({
                        ...prev,
                        log: prev.log ? { ...prev.log, attachments: [...(prev.log.attachments || []), ...uploaded] } : null,
                      }));
                      setDailyLogs(prev => prev.map(l => l.id === editDailyLog.log?.id ? { ...l, attachments: [...(l.attachments || []), ...uploaded] } : l));
                    }
                  } catch (err: any) {
                    alert(err?.message || "Upload failed.");
                  } finally {
                    setEditDailyLog(prev => ({ ...prev, saving: false }));
                  }
                }}
                style={{
                  marginTop: 8,
                  padding: 16,
                  border: editLogDragOver ? "2px dashed #2563eb" : "2px dashed #d1d5db",
                  borderRadius: 6,
                  backgroundColor: editLogDragOver ? "#eff6ff" : "#ffffff",
                  textAlign: "center",
                  cursor: "pointer",
                  transition: "all 0.15s ease",
                }}
                onClick={() => document.getElementById("edit-log-file-input")?.click()}
              >
                <div style={{ fontSize: 24, marginBottom: 4 }}>{editLogDragOver ? "📥" : "📷"}</div>
                <div style={{ fontSize: 12, color: editLogDragOver ? "#2563eb" : "#6b7280", fontWeight: 500 }}>
                  {editLogDragOver ? "Drop files here" : "Drag & drop photos here"}
                </div>
                <div style={{ fontSize: 11, color: "#9ca3af", marginTop: 2 }}>or click to browse</div>
                <input
                  id="edit-log-file-input"
                  type="file"
                  accept="image/*"
                  multiple
                  onChange={async e => {
                    const files = e.target.files;
                    if (!files || files.length === 0 || !editDailyLog.log) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      alert("Missing access token; please log in again.");
                      return;
                    }
                    try {
                      setEditDailyLog(prev => ({ ...prev, saving: true }));
                      const uploaded: DailyLogAttachmentDto[] = [];
                      for (const file of Array.from(files)) {
                        const link = await uploadImageFileToNexusUploads(file, "JOURNAL");
                        const resp = await fetch(`${API_BASE}/daily-logs/${editDailyLog.log!.id}/attachments/link`, {
                          method: "POST",
                          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                          body: JSON.stringify({ fileUrl: link.url, fileName: link.label }),
                        });
                        if (resp.ok) {
                          const att: DailyLogAttachmentDto = await resp.json();
                          uploaded.push(att);
                        }
                      }
                      if (uploaded.length > 0) {
                        setEditDailyLog(prev => ({
                          ...prev,
                          log: prev.log ? { ...prev.log, attachments: [...(prev.log.attachments || []), ...uploaded] } : null,
                        }));
                        setDailyLogs(prev => prev.map(l => l.id === editDailyLog.log?.id ? { ...l, attachments: [...(l.attachments || []), ...uploaded] } : l));
                      }
                    } catch (err: any) {
                      alert(err?.message || "Upload failed.");
                    } finally {
                      setEditDailyLog(prev => ({ ...prev, saving: false }));
                      e.target.value = "";
                    }
                  }}
                  style={{ display: "none" }}
                />
              </div>
              {editDailyLog.saving && (
                <div style={{ marginTop: 8, fontSize: 11, color: "#2563eb", textAlign: "center" }}>Uploading...</div>
              )}
            </div>

            {/* PETL Context Section - show if log has any PETL linkage */}
            {(editDailyLog.log?.building || editDailyLog.log?.unit || editDailyLog.log?.roomParticle || editDailyLog.log?.sowItem) && (
              <div style={{ marginBottom: 12, padding: 10, background: "#eff6ff", borderRadius: 6, border: "1px solid #bfdbfe" }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 6 }}>
                  <div style={{ fontSize: 12, fontWeight: 600, color: "#1e40af" }}>PETL Context</div>
                  {isPmOrAbove && editDailyLog.log?.sowItem && (
                    <button
                      type="button"
                      onClick={() => openPetlUpdateModal(editDailyLog.log!)}
                      style={{
                        padding: "4px 10px",
                        borderRadius: 4,
                        border: "1px solid #2563eb",
                        background: "#2563eb",
                        color: "#ffffff",
                        fontSize: 11,
                        fontWeight: 500,
                        cursor: "pointer",
                      }}
                    >
                      Update % Complete
                    </button>
                  )}
                </div>
                <div style={{ fontSize: 11, color: "#374151", display: "grid", gridTemplateColumns: "auto 1fr", gap: "4px 12px" }}>
                  {editDailyLog.log?.building && (
                    <>
                      <span style={{ fontWeight: 500 }}>Building:</span>
                      <span>{editDailyLog.log.building.name}{editDailyLog.log.building.code ? ` (${editDailyLog.log.building.code})` : ""}</span>
                    </>
                  )}
                  {editDailyLog.log?.unit && (
                    <>
                      <span style={{ fontWeight: 500 }}>Unit:</span>
                      <span>{editDailyLog.log.unit.label}{editDailyLog.log.unit.floor != null ? ` (Floor ${editDailyLog.log.unit.floor})` : ""}</span>
                    </>
                  )}
                  {editDailyLog.log?.roomParticle && (
                    <>
                      <span style={{ fontWeight: 500 }}>Room:</span>
                      <span>{editDailyLog.log.roomParticle.fullLabel || editDailyLog.log.roomParticle.name}</span>
                    </>
                  )}
                  {editDailyLog.log?.sowItem && (
                    <>
                      <span style={{ fontWeight: 500 }}>SOW Item:</span>
                      <span>{editDailyLog.log.sowItem.code ? `${editDailyLog.log.sowItem.code} - ` : ""}{editDailyLog.log.sowItem.description || "(No description)"}</span>
                    </>
                  )}
                </div>
              </div>
            )}

            {editDailyLog.draft.type === "RECEIPT_EXPENSE" && (
              <div style={{ marginBottom: 12, padding: 10, background: "#fef3c7", borderRadius: 6, border: "1px solid #fcd34d" }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 6 }}>
                  <div style={{ fontSize: 11, fontWeight: 600, color: "#92400e" }}>Receipt Details</div>
                  {editDailyLog.log?.attachments && editDailyLog.log.attachments.length > 0 && (
                    <button
                      type="button"
                      onClick={async () => {
                        const token = localStorage.getItem("accessToken");
                        if (!token) { alert("Missing access token"); return; }
                        try {
                          setEditDailyLog(prev => ({ ...prev, saving: true, error: null }));
                          const resp = await fetch(`${API_BASE}/daily-logs/${editDailyLog.log!.id}/attachments/ocr`, {
                            method: "POST",
                            headers: { Authorization: `Bearer ${token}` },
                          });
                          if (resp.ok) {
                            // Wait a moment for OCR to process, then reload the log
                            setTimeout(async () => {
                              const logResp = await fetch(`${API_BASE}/daily-logs/${editDailyLog.log!.id}`, {
                                headers: { Authorization: `Bearer ${token}` },
                              });
                              if (logResp.ok) {
                                const updatedLog = await logResp.json();
                                setEditDailyLog(prev => ({
                                  ...prev,
                                  log: updatedLog,
                                  draft: prev.draft ? {
                                    ...prev.draft,
                                    expenseVendor: updatedLog.expenseVendor || prev.draft.expenseVendor,
                                    expenseAmount: updatedLog.expenseAmount != null ? String(updatedLog.expenseAmount) : prev.draft.expenseAmount,
                                    expenseDate: updatedLog.expenseDate ? updatedLog.expenseDate.slice(0, 10) : prev.draft.expenseDate,
                                  } : null,
                                  saving: false,
                                }));
                                setDailyLogs(prev => prev.map(l => l.id === updatedLog.id ? { ...l, ...updatedLog } : l));
                              } else {
                                setEditDailyLog(prev => ({ ...prev, saving: false }));
                              }
                            }, 5000); // Wait 5 seconds for OCR to complete
                          } else {
                            const text = await resp.text().catch(() => "");
                            setEditDailyLog(prev => ({ ...prev, saving: false, error: `OCR failed: ${text}` }));
                          }
                        } catch (err: any) {
                          setEditDailyLog(prev => ({ ...prev, saving: false, error: err?.message || "OCR failed" }));
                        }
                      }}
                      disabled={editDailyLog.saving}
                      style={{
                        padding: "4px 10px",
                        borderRadius: 4,
                        border: "1px solid #d97706",
                        background: editDailyLog.saving ? "#fef3c7" : "#f59e0b",
                        color: editDailyLog.saving ? "#92400e" : "#ffffff",
                        fontSize: 10,
                        fontWeight: 600,
                        cursor: editDailyLog.saving ? "default" : "pointer",
                      }}
                    >
                      {editDailyLog.saving ? "🔄 Processing OCR..." : "🔍 Run OCR"}
                    </button>
                  )}
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr", gap: 8 }}>
                  <div>
                    <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>Vendor</label>
                    <input type="text" value={editDailyLog.draft.expenseVendor} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, expenseVendor: e.target.value } : null }))} style={{ width: "100%", padding: "4px 6px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }} />
                  </div>
                  <div>
                    <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>Amount</label>
                    <input type="number" step="0.01" value={editDailyLog.draft.expenseAmount} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, expenseAmount: e.target.value } : null }))} style={{ width: "100%", padding: "4px 6px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }} />
                  </div>
                  <div>
                    <label style={{ display: "block", fontSize: 11, marginBottom: 2 }}>Receipt Date</label>
                    <input type="date" value={editDailyLog.draft.expenseDate} onChange={e => setEditDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, expenseDate: e.target.value } : null }))} style={{ width: "100%", padding: "4px 6px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }} />
                  </div>
                </div>
              </div>
            )}

            {editDailyLog.error && <div style={{ marginBottom: 12, color: "#b91c1c", fontSize: 12 }}>{editDailyLog.error}</div>}

            <div style={{ display: "flex", justifyContent: "flex-end", gap: 8 }}>
              <button type="button" onClick={closeEditDailyLog} style={{ padding: "8px 14px", borderRadius: 6, border: "1px solid #d1d5db", background: "#ffffff", cursor: "pointer", fontSize: 12 }}>Cancel</button>
              <button type="button" onClick={handleUpdateDailyLog} disabled={editDailyLog.saving} style={{ padding: "8px 14px", borderRadius: 6, border: "1px solid #0f172a", background: editDailyLog.saving ? "#e5e7eb" : "#0f172a", color: editDailyLog.saving ? "#4b5563" : "#f9fafb", cursor: editDailyLog.saving ? "default" : "pointer", fontSize: 12 }}>{editDailyLog.saving ? "Saving…" : "Save Changes"}</button>
            </div>
          </div>
        </div>
      )}

      {/* View Daily Log Modal (with inline edit) */}
      {viewDailyLog.open && viewDailyLog.log && viewDailyLog.draft && (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            zIndex: 99999,
            backgroundColor: "rgba(15, 23, 42, 0.6)",
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
          }}
          onClick={() => setViewDailyLog({ open: false, log: null, draft: null, editing: false, saving: false, error: null })}
        >
          <div
            style={{
              width: 750,
              maxWidth: "96vw",
              maxHeight: "90vh",
              overflowY: "auto",
              backgroundColor: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 16px 40px rgba(15,23,42,0.35)",
              padding: 16,
              fontSize: 13,
            }}
            onClick={e => e.stopPropagation()}
          >
            {/* Header */}
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                <div style={{ fontSize: 15, fontWeight: 600 }}>Daily Log Details</div>
                {!viewDailyLog.editing && isPmOrAbove && (
                  <>
                    <button
                      type="button"
                      onClick={() => setViewDailyLog(prev => ({ ...prev, editing: true }))}
                      style={{
                        padding: "4px 10px",
                        borderRadius: 4,
                        border: "1px solid #2563eb",
                        background: "#2563eb",
                        color: "#ffffff",
                        fontSize: 11,
                        fontWeight: 500,
                        cursor: "pointer",
                      }}
                    >
                      ✏️ Edit
                    </button>
                    <button
                      type="button"
                      onClick={() => viewDailyLog.log && openReassignDailyLog(viewDailyLog.log)}
                      style={{
                        padding: "4px 10px",
                        borderRadius: 4,
                        border: "1px solid #6b7280",
                        background: "#6b7280",
                        color: "#ffffff",
                        fontSize: 11,
                        fontWeight: 500,
                        cursor: "pointer",
                      }}
                      title="Move this daily log to a different project"
                    >
                      📁 Move
                    </button>
                  </>
                )}
                {viewDailyLog.editing && (
                  <span style={{ fontSize: 11, padding: "2px 8px", borderRadius: 4, background: "#fef3c7", color: "#92400e", fontWeight: 500 }}>Editing Mode</span>
                )}
              </div>
              <button
                type="button"
                onClick={() => setViewDailyLog({ open: false, log: null, draft: null, editing: false, saving: false, error: null })}
                style={{ border: "none", background: "transparent", cursor: "pointer", fontSize: 18, lineHeight: 1, padding: 4 }}
                aria-label="Close"
              >
                ×
              </button>
            </div>

            {/* Type & Date Row */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, marginBottom: 12 }}>
              <div>
                <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Type</div>
                {viewDailyLog.editing ? (
                  <select
                    value={viewDailyLog.draft.type}
                    onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, type: e.target.value as any } : null }))}
                    style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                  >
                    <option value="PUDL">Daily Log (PUDL)</option>
                    <option value="RECEIPT_EXPENSE">Receipt / Expense</option>
                    <option value="JSA">Job Safety Assessment</option>
                    <option value="INCIDENT">Incident Report</option>
                    <option value="QUALITY">Quality Inspection</option>
                  </select>
                ) : (
                  <span
                    style={{
                      display: "inline-block",
                      padding: "2px 8px",
                      borderRadius: 4,
                      fontSize: 11,
                      backgroundColor:
                        viewDailyLog.log.type === "RECEIPT_EXPENSE" ? "#fef3c7"
                        : viewDailyLog.log.type === "JSA" ? "#dbeafe"
                        : viewDailyLog.log.type === "INCIDENT" ? "#fee2e2"
                        : viewDailyLog.log.type === "QUALITY" ? "#d1fae5"
                        : "#f3f4f6",
                      color:
                        viewDailyLog.log.type === "RECEIPT_EXPENSE" ? "#92400e"
                        : viewDailyLog.log.type === "JSA" ? "#1e40af"
                        : viewDailyLog.log.type === "INCIDENT" ? "#991b1b"
                        : viewDailyLog.log.type === "QUALITY" ? "#065f46"
                        : "#374151",
                    }}
                  >
                    {viewDailyLog.log.type === "RECEIPT_EXPENSE" ? "Receipt / Expense"
                      : viewDailyLog.log.type === "JSA" ? "Job Safety Assessment"
                      : viewDailyLog.log.type === "INCIDENT" ? "Incident Report"
                      : viewDailyLog.log.type === "QUALITY" ? "Quality Inspection"
                      : "Daily Log (PUDL)"}
                  </span>
                )}
              </div>
              <div>
                <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Date</div>
                {viewDailyLog.editing ? (
                  <input
                    type="date"
                    value={viewDailyLog.draft.logDate}
                    onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, logDate: e.target.value } : null }))}
                    style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                  />
                ) : (
                  <div style={{ fontSize: 13, fontWeight: 500, padding: "6px 0" }}>
                    {viewDailyLog.log.logDate ? new Date(viewDailyLog.log.logDate).toLocaleDateString() : "(no date)"}
                  </div>
                )}
              </div>
              <div>
                <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Manpower</div>
                {viewDailyLog.editing ? (
                  <input
                    type="number"
                    value={viewDailyLog.draft.manpowerOnsite}
                    onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, manpowerOnsite: e.target.value } : null }))}
                    placeholder="# workers"
                    style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                  />
                ) : (
                  <div style={{ fontSize: 13, fontWeight: 500, padding: "6px 0" }}>
                    {viewDailyLog.log.manpowerOnsite ?? "—"}
                  </div>
                )}
              </div>
            </div>

            {/* Title */}
            <div style={{ marginBottom: 12 }}>
              <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Title</div>
              {viewDailyLog.editing ? (
                <input
                  type="text"
                  value={viewDailyLog.draft.title}
                  onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, title: e.target.value } : null }))}
                  placeholder="Daily log title"
                  style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                />
              ) : (
                <div style={{ fontSize: 13, fontWeight: 500, padding: "6px 8px", background: "#f9fafb", borderRadius: 4, minHeight: 32 }}>
                  {viewDailyLog.log.title || "—"}
                </div>
              )}
            </div>

            {/* Receipt/Expense Details */}
            {(viewDailyLog.editing ? viewDailyLog.draft.type === "RECEIPT_EXPENSE" : viewDailyLog.log.type === "RECEIPT_EXPENSE") && (
              <div style={{ marginBottom: 12, padding: 10, background: "#fef3c7", borderRadius: 6, border: "1px solid #fcd34d" }}>
                <div style={{ fontSize: 11, fontWeight: 600, color: "#92400e", marginBottom: 6 }}>Receipt Details</div>
                <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr", gap: 8 }}>
                  <div>
                    <div style={{ fontSize: 10, color: "#92400e", marginBottom: 2 }}>Vendor</div>
                    {viewDailyLog.editing ? (
                      <input
                        type="text"
                        value={viewDailyLog.draft.expenseVendor}
                        onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, expenseVendor: e.target.value } : null }))}
                        style={{ width: "100%", padding: "4px 6px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                      />
                    ) : (
                      <div style={{ fontSize: 12, fontWeight: 500 }}>{viewDailyLog.log.expenseVendor || "—"}</div>
                    )}
                  </div>
                  <div>
                    <div style={{ fontSize: 10, color: "#92400e", marginBottom: 2 }}>Amount</div>
                    {viewDailyLog.editing ? (
                      <input
                        type="number"
                        step="0.01"
                        value={viewDailyLog.draft.expenseAmount}
                        onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, expenseAmount: e.target.value } : null }))}
                        style={{ width: "100%", padding: "4px 6px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                      />
                    ) : (
                      <div style={{ fontSize: 12, fontWeight: 500 }}>
                        {viewDailyLog.log.expenseAmount != null
                          ? `$${Number(viewDailyLog.log.expenseAmount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                          : "—"}
                      </div>
                    )}
                  </div>
                  <div>
                    <div style={{ fontSize: 10, color: "#92400e", marginBottom: 2 }}>Expense Date</div>
                    {viewDailyLog.editing ? (
                      <input
                        type="date"
                        value={viewDailyLog.draft.expenseDate}
                        onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, expenseDate: e.target.value } : null }))}
                        style={{ width: "100%", padding: "4px 6px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                      />
                    ) : (
                      <div style={{ fontSize: 12, fontWeight: 500 }}>
                        {viewDailyLog.log.expenseDate ? new Date(viewDailyLog.log.expenseDate).toLocaleDateString() : "—"}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* PETL Context (read-only display) */}
            {(viewDailyLog.log.building || viewDailyLog.log.unit || viewDailyLog.log.roomParticle || viewDailyLog.log.sowItem) && (
              <div style={{ marginBottom: 12, padding: 10, background: "#eff6ff", borderRadius: 6, border: "1px solid #bfdbfe" }}>
                <div style={{ fontSize: 11, fontWeight: 600, color: "#1e40af", marginBottom: 6 }}>PETL Context</div>
                <div style={{ fontSize: 11, color: "#374151", display: "grid", gridTemplateColumns: "auto 1fr", gap: "4px 12px" }}>
                  {viewDailyLog.log.building && (
                    <>
                      <span style={{ fontWeight: 500 }}>Building:</span>
                      <span>{viewDailyLog.log.building.name}{viewDailyLog.log.building.code ? ` (${viewDailyLog.log.building.code})` : ""}</span>
                    </>
                  )}
                  {viewDailyLog.log.unit && (
                    <>
                      <span style={{ fontWeight: 500 }}>Unit:</span>
                      <span>{viewDailyLog.log.unit.label}{viewDailyLog.log.unit.floor != null ? ` (Floor ${viewDailyLog.log.unit.floor})` : ""}</span>
                    </>
                  )}
                  {viewDailyLog.log.roomParticle && (
                    <>
                      <span style={{ fontWeight: 500 }}>Room:</span>
                      <span>{viewDailyLog.log.roomParticle.fullLabel || viewDailyLog.log.roomParticle.name}</span>
                    </>
                  )}
                  {viewDailyLog.log.sowItem && (
                    <>
                      <span style={{ fontWeight: 500 }}>SOW Item:</span>
                      <span>{viewDailyLog.log.sowItem.code ? `${viewDailyLog.log.sowItem.code} - ` : ""}{viewDailyLog.log.sowItem.description || "(No description)"}</span>
                    </>
                  )}
                </div>
              </div>
            )}

            {/* Work Performed */}
            <div style={{ marginBottom: 12 }}>
              <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Work Performed</div>
              {viewDailyLog.editing ? (
                <textarea
                  value={viewDailyLog.draft.workPerformed}
                  onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, workPerformed: e.target.value } : null }))}
                  rows={3}
                  style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12, resize: "vertical" }}
                />
              ) : (
                <div style={{ fontSize: 12, whiteSpace: "pre-wrap", padding: 8, background: "#f9fafb", borderRadius: 4, border: "1px solid #e5e7eb", minHeight: 48 }}>
                  {viewDailyLog.log.workPerformed || "—"}
                </div>
              )}
            </div>

            {/* Crew On Site */}
            <div style={{ marginBottom: 12 }}>
              <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Crew On Site</div>
              {viewDailyLog.editing ? (
                <textarea
                  value={viewDailyLog.draft.crewOnSite}
                  onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, crewOnSite: e.target.value } : null }))}
                  rows={2}
                  style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12, resize: "vertical" }}
                />
              ) : (
                <div style={{ fontSize: 12, whiteSpace: "pre-wrap", padding: 8, background: "#f9fafb", borderRadius: 4, border: "1px solid #e5e7eb", minHeight: 32 }}>
                  {viewDailyLog.log.crewOnSite || "—"}
                </div>
              )}
            </div>

            {/* Weather & Person On Site Row */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
              <div>
                <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Weather</div>
                {viewDailyLog.editing ? (
                  <input
                    type="text"
                    value={viewDailyLog.draft.weatherSummary}
                    onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, weatherSummary: e.target.value } : null }))}
                    style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                  />
                ) : (
                  <div style={{ fontSize: 12, padding: "6px 8px", background: "#f9fafb", borderRadius: 4, minHeight: 32 }}>
                    {viewDailyLog.log.weatherSummary || "—"}
                  </div>
                )}
              </div>
              <div>
                <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Person(s) On Site</div>
                {viewDailyLog.editing ? (
                  <input
                    type="text"
                    value={viewDailyLog.draft.personOnsite}
                    onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, personOnsite: e.target.value } : null }))}
                    style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12 }}
                  />
                ) : (
                  <div style={{ fontSize: 12, padding: "6px 8px", background: "#f9fafb", borderRadius: 4, minHeight: 32 }}>
                    {viewDailyLog.log.personOnsite || "—"}
                  </div>
                )}
              </div>
            </div>

            {/* Issues & Safety Row */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
              <div>
                <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Issues / Delays</div>
                {viewDailyLog.editing ? (
                  <textarea
                    value={viewDailyLog.draft.issues}
                    onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, issues: e.target.value } : null }))}
                    rows={2}
                    style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12, resize: "vertical" }}
                  />
                ) : (
                  <div style={{ fontSize: 12, whiteSpace: "pre-wrap", padding: 8, background: viewDailyLog.log.issues ? "#fef2f2" : "#f9fafb", borderRadius: 4, border: viewDailyLog.log.issues ? "1px solid #fecaca" : "1px solid #e5e7eb", minHeight: 48 }}>
                    {viewDailyLog.log.issues || "—"}
                  </div>
                )}
              </div>
              <div>
                <div style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 11, color: "#6b7280", marginBottom: 2 }}>
                  Safety Note
                  {(viewDailyLog.editing ? viewDailyLog.draft.safetyIncidents : viewDailyLog.log.safetyIncidents) && (
                    <span style={{ fontSize: 9, fontWeight: 600, padding: "2px 6px", borderRadius: 4, backgroundColor: "#fef2f2", color: "#b91c1c", border: "1px solid #fecaca" }}>⚠️ Safety</span>
                  )}
                </div>
                {viewDailyLog.editing ? (
                  <textarea
                    value={viewDailyLog.draft.safetyIncidents}
                    onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, safetyIncidents: e.target.value } : null }))}
                    rows={2}
                    style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: viewDailyLog.draft.safetyIncidents ? "1px solid #fca5a5" : "1px solid #d1d5db", fontSize: 12, resize: "vertical", backgroundColor: viewDailyLog.draft.safetyIncidents ? "#fef2f2" : "#ffffff" }}
                  />
                ) : (
                  <div style={{ fontSize: 12, whiteSpace: "pre-wrap", padding: 8, background: viewDailyLog.log.safetyIncidents ? "#fef2f2" : "#f9fafb", borderRadius: 4, border: viewDailyLog.log.safetyIncidents ? "1px solid #fecaca" : "1px solid #e5e7eb", minHeight: 48 }}>
                    {viewDailyLog.log.safetyIncidents || "—"}
                  </div>
                )}
              </div>
            </div>

            {/* Confidential Notes */}
            <div style={{ marginBottom: 12 }}>
              <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Confidential Notes (NO PRINT)</div>
              {viewDailyLog.editing ? (
                <textarea
                  value={viewDailyLog.draft.confidentialNotes}
                  onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, confidentialNotes: e.target.value } : null }))}
                  rows={2}
                  style={{ width: "100%", padding: "6px 8px", borderRadius: 4, border: "1px solid #d1d5db", fontSize: 12, resize: "vertical" }}
                />
              ) : (
                <div style={{ fontSize: 12, whiteSpace: "pre-wrap", padding: 8, background: viewDailyLog.log.confidentialNotes ? "#fefce8" : "#f9fafb", borderRadius: 4, border: viewDailyLog.log.confidentialNotes ? "1px solid #fde047" : "1px solid #e5e7eb", minHeight: 32 }}>
                  {viewDailyLog.log.confidentialNotes || "—"}
                </div>
              )}
            </div>

            {/* Sharing */}
            <div style={{ marginBottom: 12 }}>
              <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 4 }}>Sharing</div>
              {viewDailyLog.editing ? (
                <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
                  <label style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 12 }}>
                    <input type="checkbox" checked={viewDailyLog.draft.shareInternal} onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, shareInternal: e.target.checked } : null }))} />
                    Internal
                  </label>
                  <label style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 12 }}>
                    <input type="checkbox" checked={viewDailyLog.draft.shareSubs} onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, shareSubs: e.target.checked } : null }))} />
                    Subs
                  </label>
                  <label style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 12 }}>
                    <input type="checkbox" checked={viewDailyLog.draft.shareClient} onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, shareClient: e.target.checked } : null }))} />
                    Client
                  </label>
                  <label style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 12 }}>
                    <input type="checkbox" checked={viewDailyLog.draft.sharePrivate} onChange={e => setViewDailyLog(prev => ({ ...prev, draft: prev.draft ? { ...prev.draft, sharePrivate: e.target.checked } : null }))} />
                    Private
                  </label>
                </div>
              ) : (
                <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                  {viewDailyLog.log.shareInternal && (
                    <span style={{ fontSize: 10, padding: "2px 6px", borderRadius: 4, background: "#dbeafe", color: "#1e40af" }}>Internal</span>
                  )}
                  {viewDailyLog.log.shareSubs && (
                    <span style={{ fontSize: 10, padding: "2px 6px", borderRadius: 4, background: "#d1fae5", color: "#065f46" }}>Subs</span>
                  )}
                  {viewDailyLog.log.shareClient && (
                    <span style={{ fontSize: 10, padding: "2px 6px", borderRadius: 4, background: "#fef3c7", color: "#92400e" }}>Client</span>
                  )}
                  {viewDailyLog.log.sharePrivate && (
                    <span style={{ fontSize: 10, padding: "2px 6px", borderRadius: 4, background: "#f3f4f6", color: "#374151" }}>Private</span>
                  )}
                  {!viewDailyLog.log.shareInternal && !viewDailyLog.log.shareSubs && !viewDailyLog.log.shareClient && !viewDailyLog.log.sharePrivate && (
                    <span style={{ fontSize: 10, color: "#9ca3af" }}>No sharing configured</span>
                  )}
                </div>
              )}
            </div>

            {/* Attachments */}
            <div style={{ marginBottom: 12 }}>
              <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 6 }}>Attachments ({viewDailyLog.log.attachments?.length || 0})</div>
              {viewDailyLog.log.attachments && viewDailyLog.log.attachments.length > 0 ? (
                <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                  {viewDailyLog.log.attachments.map((att: any, idx: number) => {
                    const url = att.fileUrl || att.storageUrl || "";
                    const displayUrl = url.startsWith("gs://")
                      ? `https://storage.googleapis.com/${url.replace("gs://", "")}`
                      : url;
                    const isImage = att.mimeType?.startsWith("image/") || /\.(jpg|jpeg|png|gif|webp)$/i.test(att.fileName || "");
                    return (
                      <div key={att.id || idx} style={{ textAlign: "center", width: 80, position: "relative" }}>
                        {/* Delete button in edit mode */}
                        {viewDailyLog.editing && (
                          <button
                            type="button"
                            onClick={async e => {
                              e.preventDefault();
                              e.stopPropagation();
                              if (!confirm("Delete this attachment?")) return;
                              const token = localStorage.getItem("accessToken");
                              if (!token) { alert("Missing access token"); return; }
                              try {
                                const resp = await fetch(`${API_BASE}/daily-logs/${viewDailyLog.log!.id}/attachments/${att.id}`, {
                                  method: "DELETE",
                                  headers: { Authorization: `Bearer ${token}` },
                                });
                                if (resp.ok) {
                                  setViewDailyLog(prev => ({
                                    ...prev,
                                    log: prev.log ? { ...prev.log, attachments: (prev.log.attachments || []).filter((a: any) => a.id !== att.id) } : null,
                                  }));
                                  setDailyLogs(prev => prev.map(l => l.id === viewDailyLog.log?.id ? { ...l, attachments: (l.attachments || []).filter(a => a.id !== att.id) } : l));
                                } else {
                                  alert("Failed to delete attachment");
                                }
                              } catch (err: any) {
                                alert(err?.message || "Delete failed");
                              }
                            }}
                            style={{
                              position: "absolute",
                              top: -4,
                              right: 6,
                              width: 18,
                              height: 18,
                              borderRadius: "50%",
                              border: "none",
                              background: "rgba(239, 68, 68, 0.9)",
                              color: "#ffffff",
                              fontSize: 11,
                              fontWeight: 700,
                              cursor: "pointer",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                              lineHeight: 1,
                              zIndex: 10,
                            }}
                            title="Delete attachment"
                          >
                            ×
                          </button>
                        )}
                        {isImage ? (
                          <img
                            src={displayUrl}
                            alt={att.fileName || "attachment"}
                            style={{
                              width: 60,
                              height: 60,
                              objectFit: "cover",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              cursor: "pointer",
                            }}
                            onClick={() => window.open(displayUrl, "_blank")}
                          />
                        ) : (
                          <a
                            href={displayUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            style={{
                              display: "flex",
                              width: 60,
                              height: 60,
                              alignItems: "center",
                              justifyContent: "center",
                              background: "#f3f4f6",
                              borderRadius: 4,
                              border: "1px solid #d1d5db",
                              fontSize: 24,
                              textDecoration: "none",
                            }}
                          >
                            📄
                          </a>
                        )}
                        <div style={{ fontSize: 9, color: "#6b7280", marginTop: 2, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                          {att.fileName || "File"}
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <div style={{ fontSize: 12, color: "#9ca3af", padding: "8px", background: "#f9fafb", borderRadius: 4, border: "1px solid #e5e7eb" }}>No attachments</div>
              )}
              
              {/* Drag and drop zone - only in edit mode */}
              {viewDailyLog.editing && (
                <div
                  onDragOver={e => { e.preventDefault(); e.stopPropagation(); setViewLogDragOver(true); }}
                  onDragLeave={e => { e.preventDefault(); e.stopPropagation(); setViewLogDragOver(false); }}
                  onDrop={async e => {
                    e.preventDefault();
                    e.stopPropagation();
                    setViewLogDragOver(false);
                    const files = e.dataTransfer.files;
                    if (!files || files.length === 0 || !viewDailyLog.log) return;
                    const token = localStorage.getItem("accessToken");
                    if (!token) {
                      alert("Missing access token; please log in again.");
                      return;
                    }
                    try {
                      setViewDailyLog(prev => ({ ...prev, saving: true }));
                      const uploaded: DailyLogAttachmentDto[] = [];
                      for (const file of Array.from(files)) {
                        if (!file.type.startsWith("image/")) continue;
                        const link = await uploadImageFileToNexusUploads(file, "JOURNAL");
                        const resp = await fetch(`${API_BASE}/daily-logs/${viewDailyLog.log!.id}/attachments/link`, {
                          method: "POST",
                          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                          body: JSON.stringify({ fileUrl: link.url, fileName: link.label }),
                        });
                        if (resp.ok) {
                          const att: DailyLogAttachmentDto = await resp.json();
                          uploaded.push(att);
                        }
                      }
                      if (uploaded.length > 0) {
                        setViewDailyLog(prev => ({
                          ...prev,
                          log: prev.log ? { ...prev.log, attachments: [...(prev.log.attachments || []), ...uploaded] } : null,
                        }));
                        setDailyLogs(prev => prev.map(l => l.id === viewDailyLog.log?.id ? { ...l, attachments: [...(l.attachments || []), ...uploaded] } : l));
                      }
                    } catch (err: any) {
                      alert(err?.message || "Upload failed.");
                    } finally {
                      setViewDailyLog(prev => ({ ...prev, saving: false }));
                    }
                  }}
                  style={{
                    marginTop: 8,
                    padding: 12,
                    border: viewLogDragOver ? "2px dashed #2563eb" : "2px dashed #d1d5db",
                    borderRadius: 6,
                    backgroundColor: viewLogDragOver ? "#eff6ff" : "#ffffff",
                    textAlign: "center",
                    cursor: "pointer",
                    transition: "all 0.15s ease",
                  }}
                  onClick={() => document.getElementById("view-log-file-input")?.click()}
                >
                  <div style={{ fontSize: 20, marginBottom: 2 }}>{viewLogDragOver ? "📥" : "📷"}</div>
                  <div style={{ fontSize: 11, color: viewLogDragOver ? "#2563eb" : "#6b7280", fontWeight: 500 }}>
                    {viewLogDragOver ? "Drop files here" : "Drag & drop photos or click to browse"}
                  </div>
                  <input
                    id="view-log-file-input"
                    type="file"
                    accept="image/*"
                    multiple
                    onChange={async e => {
                      const files = e.target.files;
                      if (!files || files.length === 0 || !viewDailyLog.log) return;
                      const token = localStorage.getItem("accessToken");
                      if (!token) {
                        alert("Missing access token; please log in again.");
                        return;
                      }
                      try {
                        setViewDailyLog(prev => ({ ...prev, saving: true }));
                        const uploaded: DailyLogAttachmentDto[] = [];
                        for (const file of Array.from(files)) {
                          const link = await uploadImageFileToNexusUploads(file, "JOURNAL");
                          const resp = await fetch(`${API_BASE}/daily-logs/${viewDailyLog.log!.id}/attachments/link`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                            body: JSON.stringify({ fileUrl: link.url, fileName: link.label }),
                          });
                          if (resp.ok) {
                            const att: DailyLogAttachmentDto = await resp.json();
                            uploaded.push(att);
                          }
                        }
                        if (uploaded.length > 0) {
                          setViewDailyLog(prev => ({
                            ...prev,
                            log: prev.log ? { ...prev.log, attachments: [...(prev.log.attachments || []), ...uploaded] } : null,
                          }));
                          setDailyLogs(prev => prev.map(l => l.id === viewDailyLog.log?.id ? { ...l, attachments: [...(l.attachments || []), ...uploaded] } : l));
                        }
                      } catch (err: any) {
                        alert(err?.message || "Upload failed.");
                      } finally {
                        setViewDailyLog(prev => ({ ...prev, saving: false }));
                        e.target.value = "";
                      }
                    }}
                    style={{ display: "none" }}
                  />
                </div>
              )}
              {viewDailyLog.editing && viewDailyLog.saving && (
                <div style={{ marginTop: 6, fontSize: 11, color: "#2563eb", textAlign: "center" }}>Uploading...</div>
              )}
            </div>

            {/* Created Info */}
            <div style={{ fontSize: 10, color: "#9ca3af", borderTop: "1px solid #e5e7eb", paddingTop: 8, marginTop: 8 }}>
              {viewDailyLog.log.createdAt && (
                <span>Created: {new Date(viewDailyLog.log.createdAt).toLocaleString()}</span>
              )}
            </div>

            {/* Error */}
            {viewDailyLog.error && <div style={{ marginTop: 8, color: "#b91c1c", fontSize: 12 }}>{viewDailyLog.error}</div>}

            {/* Footer Buttons */}
            <div style={{ display: "flex", justifyContent: "flex-end", gap: 8, marginTop: 12 }}>
              {viewDailyLog.editing ? (
                <>
                  <button
                    type="button"
                    onClick={() => setViewDailyLog(prev => ({
                      ...prev,
                      editing: false,
                      draft: prev.log ? {
                        type: prev.log.type || "PUDL",
                        title: prev.log.title || "",
                        tags: "",
                        logDate: prev.log.logDate ? prev.log.logDate.slice(0, 10) : "",
                        workPerformed: prev.log.workPerformed || "",
                        crewOnSite: prev.log.crewOnSite || "",
                        issues: prev.log.issues || "",
                        safetyIncidents: prev.log.safetyIncidents || "",
                        weatherSummary: prev.log.weatherSummary || "",
                        personOnsite: prev.log.personOnsite || "",
                        manpowerOnsite: prev.log.manpowerOnsite != null ? String(prev.log.manpowerOnsite) : "",
                        confidentialNotes: prev.log.confidentialNotes || "",
                        shareInternal: prev.log.shareInternal ?? true,
                        shareSubs: prev.log.shareSubs ?? false,
                        shareClient: prev.log.shareClient ?? false,
                        sharePrivate: prev.log.sharePrivate ?? false,
                        attachmentFiles: [],
                        buildingId: prev.log.building?.id || "",
                        unitId: prev.log.unit?.id || "",
                        roomParticleId: prev.log.roomParticle?.id || "",
                        sowItemId: prev.log.sowItem?.id || "",
                        expenseVendor: prev.log.expenseVendor || "",
                        expenseAmount: prev.log.expenseAmount != null ? String(prev.log.expenseAmount) : "",
                        expenseDate: prev.log.expenseDate ? prev.log.expenseDate.slice(0, 10) : "",
                      } : null,
                      error: null,
                    }))}
                    style={{ padding: "8px 14px", borderRadius: 6, border: "1px solid #d1d5db", background: "#ffffff", cursor: "pointer", fontSize: 12 }}
                  >
                    Cancel
                  </button>
                  <button
                    type="button"
                    disabled={viewDailyLog.saving}
                    onClick={async () => {
                      const token = localStorage.getItem("accessToken");
                      if (!token || !viewDailyLog.log || !viewDailyLog.draft) return;
                      setViewDailyLog(prev => ({ ...prev, saving: true, error: null }));
                      try {
                        const payload: any = {
                          type: viewDailyLog.draft.type,
                          title: viewDailyLog.draft.title || null,
                          logDate: viewDailyLog.draft.logDate || null,
                          workPerformed: viewDailyLog.draft.workPerformed || null,
                          crewOnSite: viewDailyLog.draft.crewOnSite || null,
                          issues: viewDailyLog.draft.issues || null,
                          safetyIncidents: viewDailyLog.draft.safetyIncidents || null,
                          weatherSummary: viewDailyLog.draft.weatherSummary || null,
                          personOnsite: viewDailyLog.draft.personOnsite || null,
                          manpowerOnsite: viewDailyLog.draft.manpowerOnsite ? parseInt(viewDailyLog.draft.manpowerOnsite, 10) : null,
                          confidentialNotes: viewDailyLog.draft.confidentialNotes || null,
                          shareInternal: viewDailyLog.draft.shareInternal,
                          shareSubs: viewDailyLog.draft.shareSubs,
                          shareClient: viewDailyLog.draft.shareClient,
                          sharePrivate: viewDailyLog.draft.sharePrivate,
                        };
                        if (viewDailyLog.draft.type === "RECEIPT_EXPENSE") {
                          payload.expenseVendor = viewDailyLog.draft.expenseVendor || null;
                          payload.expenseAmount = viewDailyLog.draft.expenseAmount ? parseFloat(viewDailyLog.draft.expenseAmount) : null;
                          payload.expenseDate = viewDailyLog.draft.expenseDate || null;
                        }
                        const resp = await fetch(`${API_BASE}/daily-logs/${viewDailyLog.log.id}`, {
                          method: "PATCH",
                          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                          body: JSON.stringify(payload),
                        });
                        if (!resp.ok) {
                          const text = await resp.text().catch(() => "");
                          throw new Error(text || `Update failed (${resp.status})`);
                        }
                        const updated = await resp.json();
                        setDailyLogs(prev => prev.map(l => l.id === updated.id ? { ...l, ...updated } : l));
                        setViewDailyLog(prev => ({
                          ...prev,
                          log: { ...prev.log!, ...updated },
                          editing: false,
                          saving: false,
                          error: null,
                        }));
                      } catch (err: any) {
                        setViewDailyLog(prev => ({ ...prev, saving: false, error: err?.message || "Update failed" }));
                      }
                    }}
                    style={{
                      padding: "8px 14px",
                      borderRadius: 6,
                      border: "1px solid #0f172a",
                      background: viewDailyLog.saving ? "#e5e7eb" : "#0f172a",
                      color: viewDailyLog.saving ? "#4b5563" : "#ffffff",
                      cursor: viewDailyLog.saving ? "default" : "pointer",
                      fontSize: 12,
                    }}
                  >
                    {viewDailyLog.saving ? "Saving…" : "Save Changes"}
                  </button>
                </>
              ) : (
                <button
                  type="button"
                  onClick={() => setViewDailyLog({ open: false, log: null, draft: null, editing: false, saving: false, error: null })}
                  style={{
                    padding: "8px 14px",
                    borderRadius: 6,
                    border: "1px solid #0f172a",
                    background: "#0f172a",
                    color: "#ffffff",
                    cursor: "pointer",
                    fontSize: 12,
                  }}
                >
                  Close
                </button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Reassign Daily Log Modal */}
      {reassignDailyLog.open && (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            zIndex: 100000,
            backgroundColor: "rgba(15, 23, 42, 0.7)",
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
          }}
          onClick={() => setReassignDailyLog({ open: false, logId: null, logTitle: null, targetProjectId: "", availableProjects: [], loading: false, saving: false, error: null })}
        >
          <div
            style={{
              width: 450,
              maxWidth: "90vw",
              backgroundColor: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 16px 40px rgba(15,23,42,0.4)",
              padding: 16,
              fontSize: 13,
            }}
            onClick={e => e.stopPropagation()}
          >
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
              <div style={{ fontSize: 15, fontWeight: 600 }}>📁 Move Daily Log to Another Project</div>
              <button
                type="button"
                onClick={() => setReassignDailyLog({ open: false, logId: null, logTitle: null, targetProjectId: "", availableProjects: [], loading: false, saving: false, error: null })}
                style={{ border: "none", background: "transparent", cursor: "pointer", fontSize: 18, lineHeight: 1, padding: 4 }}
                aria-label="Close"
              >
                ×
              </button>
            </div>

            {reassignDailyLog.logTitle && (
              <div style={{ marginBottom: 12, padding: 8, background: "#f9fafb", borderRadius: 4, border: "1px solid #e5e7eb" }}>
                <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 2 }}>Daily Log</div>
                <div style={{ fontSize: 13, fontWeight: 500 }}>{reassignDailyLog.logTitle}</div>
              </div>
            )}

            {reassignDailyLog.loading ? (
              <div style={{ padding: 20, textAlign: "center", color: "#6b7280" }}>Loading projects...</div>
            ) : reassignDailyLog.availableProjects.length === 0 ? (
              <div style={{ padding: 20, textAlign: "center", color: "#6b7280" }}>No other projects available</div>
            ) : (
              <div style={{ marginBottom: 12 }}>
                <label style={{ display: "block", fontSize: 12, marginBottom: 4, fontWeight: 500 }}>Target Project</label>
                <select
                  value={reassignDailyLog.targetProjectId}
                  onChange={e => setReassignDailyLog(prev => ({ ...prev, targetProjectId: e.target.value }))}
                  style={{
                    width: "100%",
                    padding: "8px 12px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    fontSize: 13,
                  }}
                >
                  <option value="">Select a project...</option>
                  {reassignDailyLog.availableProjects.map(p => (
                    <option key={p.id} value={p.id}>{p.name}</option>
                  ))}
                </select>
              </div>
            )}

            <div style={{ marginBottom: 12, padding: 8, background: "#fef3c7", borderRadius: 4, border: "1px solid #fcd34d", fontSize: 11, color: "#92400e" }}>
              ⚠️ Moving will clear any PETL context (building, unit, room, SOW item) since they are project-specific. If this is a receipt, the linked bill will also move.
            </div>

            {reassignDailyLog.error && <div style={{ marginBottom: 12, color: "#b91c1c", fontSize: 12 }}>{reassignDailyLog.error}</div>}

            <div style={{ display: "flex", justifyContent: "flex-end", gap: 8 }}>
              <button
                type="button"
                onClick={() => setReassignDailyLog({ open: false, logId: null, logTitle: null, targetProjectId: "", availableProjects: [], loading: false, saving: false, error: null })}
                style={{ padding: "8px 14px", borderRadius: 6, border: "1px solid #d1d5db", background: "#ffffff", cursor: "pointer", fontSize: 12 }}
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={handleReassignDailyLog}
                disabled={reassignDailyLog.saving || !reassignDailyLog.targetProjectId}
                style={{
                  padding: "8px 14px",
                  borderRadius: 6,
                  border: "1px solid #0f172a",
                  background: reassignDailyLog.saving || !reassignDailyLog.targetProjectId ? "#e5e7eb" : "#0f172a",
                  color: reassignDailyLog.saving || !reassignDailyLog.targetProjectId ? "#4b5563" : "#ffffff",
                  cursor: reassignDailyLog.saving || !reassignDailyLog.targetProjectId ? "default" : "pointer",
                  fontSize: 12,
                  fontWeight: 500,
                }}
              >
                {reassignDailyLog.saving ? "Moving..." : "Move Daily Log"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* PETL Update Modal */}
      {petlUpdateModal.open && petlUpdateModal.log && (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            zIndex: 100000,
            backgroundColor: "rgba(15, 23, 42, 0.7)",
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
          }}
          onClick={closePetlUpdateModal}
        >
          <div
            style={{
              width: 400,
              maxWidth: "90vw",
              backgroundColor: "#ffffff",
              borderRadius: 10,
              border: "1px solid #e5e7eb",
              boxShadow: "0 16px 40px rgba(15,23,42,0.4)",
              padding: 16,
              fontSize: 13,
            }}
            onClick={e => e.stopPropagation()}
          >
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
              <div style={{ fontSize: 15, fontWeight: 600 }}>Update PETL % Complete</div>
              <button type="button" onClick={closePetlUpdateModal} style={{ border: "none", background: "transparent", cursor: "pointer", fontSize: 18, lineHeight: 1, padding: 4 }} aria-label="Close">×</button>
            </div>

            {/* PETL Context Display */}
            <div style={{ marginBottom: 12, padding: 10, background: "#f8fafc", borderRadius: 6, border: "1px solid #e5e7eb" }}>
              <div style={{ fontSize: 11, color: "#374151", display: "grid", gridTemplateColumns: "auto 1fr", gap: "4px 12px" }}>
                {petlUpdateModal.log.building && (
                  <>
                    <span style={{ fontWeight: 500 }}>Building:</span>
                    <span>{petlUpdateModal.log.building.name}</span>
                  </>
                )}
                {petlUpdateModal.log.unit && (
                  <>
                    <span style={{ fontWeight: 500 }}>Unit:</span>
                    <span>{petlUpdateModal.log.unit.label}</span>
                  </>
                )}
                {petlUpdateModal.log.roomParticle && (
                  <>
                    <span style={{ fontWeight: 500 }}>Room:</span>
                    <span>{petlUpdateModal.log.roomParticle.fullLabel || petlUpdateModal.log.roomParticle.name}</span>
                  </>
                )}
                {petlUpdateModal.log.sowItem && (
                  <>
                    <span style={{ fontWeight: 500 }}>SOW Item:</span>
                    <span>{petlUpdateModal.log.sowItem.code ? `${petlUpdateModal.log.sowItem.code} - ` : ""}{petlUpdateModal.log.sowItem.description || "(No description)"}</span>
                  </>
                )}
              </div>
            </div>

            {/* Percent Complete Input */}
            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 12, marginBottom: 4, fontWeight: 500 }}>% Complete</label>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <input
                  type="number"
                  min="0"
                  max="100"
                  step="1"
                  value={petlUpdateModal.percentComplete}
                  onChange={e => setPetlUpdateModal(prev => ({ ...prev, percentComplete: e.target.value }))}
                  style={{
                    width: 100,
                    padding: "8px 12px",
                    borderRadius: 4,
                    border: "1px solid #d1d5db",
                    fontSize: 14,
                    textAlign: "center",
                  }}
                  placeholder="0-100"
                />
                <span style={{ fontSize: 14, color: "#6b7280" }}>%</span>
              </div>
            </div>

            {petlUpdateModal.error && <div style={{ marginBottom: 12, color: "#b91c1c", fontSize: 12 }}>{petlUpdateModal.error}</div>}

            <div style={{ display: "flex", justifyContent: "flex-end", gap: 8 }}>
              <button type="button" onClick={closePetlUpdateModal} style={{ padding: "8px 14px", borderRadius: 6, border: "1px solid #d1d5db", background: "#ffffff", cursor: "pointer", fontSize: 12 }}>Cancel</button>
              <button
                type="button"
                onClick={handleSavePetlUpdate}
                disabled={petlUpdateModal.saving}
                style={{
                  padding: "8px 14px",
                  borderRadius: 6,
                  border: "1px solid #059669",
                  background: petlUpdateModal.saving ? "#e5e7eb" : "#059669",
                  color: petlUpdateModal.saving ? "#4b5563" : "#ffffff",
                  cursor: petlUpdateModal.saving ? "default" : "pointer",
                  fontSize: 12,
                  fontWeight: 500,
                }}
              >
                {petlUpdateModal.saving ? "Saving…" : "Save % Complete"}
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}
